var C=document.getElementById("canvas"),r=C.getContext("2d",{willReadFrequently:!0}),N0=document.createElement("canvas"),T0=document.createElement("img"),H0=N0.getContext("2d",{willReadFrequently:!0});class m0{key=0n;next=null;prev=null;unlink(){if(this.prev!=null){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class o extends m0{next2=null;prev2=null;unlink2(){if(this.prev2!==null){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class H extends o{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(E,L,m){this.pixels=E,this.width2d=L,this.height2d=m,this.setBounds(0,0,L,m)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(E,L,m,T){if(E<0)E=0;if(L<0)L=0;if(m>this.width2d)m=this.width2d;if(T>this.height2d)T=this.height2d;this.top=L,this.bottom=T,this.left=E,this.right=m,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let E=this.width2d*this.height2d;for(let L=0;L<E;L++)this.pixels[L]=0}static drawRect(E,L,m,T,N){this.drawHorizontalLine(E,L,N,m),this.drawHorizontalLine(E,L+T-1,N,m),this.drawVerticalLine(E,L,N,T),this.drawVerticalLine(E+m-1,L,N,T)}static drawHorizontalLine(E,L,m,T){if(L<this.top||L>=this.bottom)return;if(E<this.left)T-=this.left-E,E=this.left;if(E+T>this.right)T=this.right-E;let N=E+L*this.width2d;for(let G=0;G<T;G++)this.pixels[N+G]=m}static drawVerticalLine(E,L,m,T){if(E<this.left||E>=this.right)return;if(L<this.top)T-=this.top-L,L=this.top;if(L+T>this.bottom)T=this.bottom-L;let N=E+L*this.width2d;for(let G=0;G<T;G++)this.pixels[N+G*this.width2d]=m}static drawLine(E,L,m,T,N){let G=Math.abs(m-E),_=Math.abs(T-L),Q=E<m?1:-1,M=L<T?1:-1,$=G-_;while(!0){if(E>=this.left&&E<this.right&&L>=this.top&&L<this.bottom)this.pixels[E+L*this.width2d]=N;if(E===m&&L===T)break;let R=2*$;if(R>-_)$=$-_,E=E+Q;if(R<G)$=$+G,L=L+M}}static fillRect2d(E,L,m,T,N){if(E<this.left)m-=this.left-E,E=this.left;if(L<this.top)T-=this.top-L,L=this.top;if(E+m>this.right)m=this.right-E;if(L+T>this.bottom)T=this.bottom-L;let G=this.width2d-m,_=E+L*this.width2d;for(let Q=-T;Q<0;Q++){for(let M=-m;M<0;M++)this.pixels[_++]=N;_+=G}}static fillRectAlpha(E,L,m,T,N,G){if(E<this.left)m-=this.left-E,E=this.left;if(L<this.top)T-=this.top-L,L=this.top;if(E+m>this.right)m=this.right-E;if(L+T>this.bottom)T=this.bottom-L;let _=256-G,Q=(N>>16&255)*G,M=(N>>8&255)*G,$=(N&255)*G,R=this.width2d-m,J=E+L*this.width2d;for(let W=0;W<T;W++){for(let I=-m;I<0;I++){let q=(this.pixels[J]>>16&255)*_,n=(this.pixels[J]>>8&255)*_,Z=(this.pixels[J]&255)*_,j=(Q+q>>8<<16)+(M+n>>8<<8)+($+Z>>8);this.pixels[J++]=j}J+=R}}static fillCircle(E,L,m,T,N){let G=256-N,_=(T>>16&255)*N,Q=(T>>8&255)*N,M=(T&255)*N,$=L-m;if($<0)$=0;let R=L+m;if(R>=this.height2d)R=this.height2d-1;for(let J=$;J<=R;J++){let W=J-L,I=Math.sqrt(m*m-W*W)|0,q=E-I;if(q<0)q=0;let n=E+I;if(n>=this.width2d)n=this.width2d-1;let Z=q+J*this.width2d;for(let j=q;j<=n;j++){let K=(this.pixels[Z]>>16&255)*G,z=(this.pixels[Z]>>8&255)*G,V=(this.pixels[Z]&255)*G,b=(_+K>>8<<16)+(Q+z>>8<<8)+(M+V>>8);this.pixels[Z++]=b}}}static setPixel(E,L,m){if(E<this.left||E>=this.right||L<this.top||L>=this.bottom)return;this.pixels[E+L*this.width2d]=m}}class _0{sentinel=new m0;current=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}addTail(E){if(E.prev)E.unlink();if(E.prev=this.sentinel.prev,E.next=this.sentinel,E.prev)E.prev.next=E;E.next.prev=E}addHead(E){if(E.prev)E.unlink();if(E.prev=this.sentinel,E.next=this.sentinel.next,E.prev.next=E,E.next)E.next.prev=E}removeHead(){let E=this.sentinel.next;if(E===this.sentinel)return null;return E?.unlink(),E}head(){let E=this.sentinel.next;if(E===this.sentinel)return this.current=null,null;return this.current=E?.next||null,E}tail(){let E=this.sentinel.prev;if(E===this.sentinel)return this.current=null,null;return this.current=E?.prev||null,E}next(){let E=this.current;if(E===this.sentinel)return this.current=null,null;return this.current=E?.next||null,E}prev(){let E=this.current;if(E===this.sentinel)return this.current=null,null;return this.current=E?.prev||null,E}clear(){while(!0){let E=this.sentinel.next;if(E===this.sentinel)return;E?.unlink()}}}var Q0=async(E)=>new Promise((L)=>setTimeout(L,E)),q0=async(E)=>new Uint8Array(await(await fetch(E)).arrayBuffer());function j0(E){let L=0n;for(let m=0;m<E.length;m++)L=L<<8n|BigInt(E[m]);return L}function W0(E){let L=[];while(E>0n)L.unshift(Number(E&0xffn)),E>>=8n;if(L[0]&128)L.unshift(0);return new Uint8Array(L)}function k0(E,L,m){let T=1n;while(L>0n){if(L%2n===1n)T=T*E%m;E=E*E%m,L>>=1n}return T}class D extends o{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new _0;static cacheMid=new _0;static cacheMax=new _0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let E=0;E<32;E++)D.bitmask[E]=(1<<E)-1;D.bitmask[32]=4294967295;for(let E=0;E<256;E++){let L=E;for(let m=0;m<8;m++)if((L&1)===1)L=L>>>1^D.CRC32_POLYNOMIAL;else L>>>=1;D.crctable[E]=L}}static crc32(E){let L=4294967295;for(let m=0;m<E.length;m++)L=L>>>8^D.crctable[(L^E[m])&255];return~L}view;data;pos=0;bitPos=0;random=null;constructor(E){if(!E)throw new Error;super();if(E instanceof Int8Array)this.data=new Uint8Array(E);else this.data=E;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc(E){let L=null;if(E===0&&D.cacheMinCount>0)D.cacheMinCount--,L=D.cacheMin.removeHead();else if(E===1&&D.cacheMidCount>0)D.cacheMidCount--,L=D.cacheMid.removeHead();else if(E===2&&D.cacheMaxCount>0)D.cacheMaxCount--,L=D.cacheMax.removeHead();if(L)return L.pos=0,L;if(E===0)return new D(new Uint8Array(100));else if(E===1)return new D(new Uint8Array(5000));return new D(new Uint8Array(30000))}release(){if(this.pos=0,this.view.byteLength===100&&D.cacheMinCount<1000)D.cacheMin.addTail(this),D.cacheMinCount++;else if(this.view.byteLength===5000&&D.cacheMidCount<250)D.cacheMid.addTail(this),D.cacheMidCount++;else if(this.view.byteLength===30000&&D.cacheMaxCount<50)D.cacheMax.addTail(this),D.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let E=this.view.getUint16(this.pos);return this.pos+=2,E}g2b(){let E=this.view.getInt16(this.pos);return this.pos+=2,E}g3(){let E=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,E}g4(){let E=this.view.getInt32(this.pos);return this.pos+=4,E}g8(){let E=this.view.getBigInt64(this.pos);return this.pos+=8,E}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let E=this.view,L=E.byteLength,m="",T;while((T=E.getUint8(this.pos++))!==10&&this.pos<L)m+=String.fromCharCode(T);return m}gdata(E,L,m){m.set(this.data.subarray(this.pos,this.pos+E),L),this.pos+=E}p1isaac(E){this.view.setUint8(this.pos++,E+(this.random?.nextInt??0)&255)}p1(E){this.view.setUint8(this.pos++,E)}p2(E){this.view.setUint16(this.pos,E),this.pos+=2}ip2(E){this.view.setUint16(this.pos,E,!0),this.pos+=2}p3(E){this.view.setUint8(this.pos++,E>>16),this.view.setUint16(this.pos,E),this.pos+=2}p4(E){this.view.setInt32(this.pos,E),this.pos+=4}ip4(E){this.view.setInt32(this.pos,E,!0),this.pos+=4}p8(E){this.view.setBigInt64(this.pos,E),this.pos+=8}pjstr(E){let L=this.view,m=E.length;for(let T=0;T<m;T++)L.setUint8(this.pos++,E.charCodeAt(T));L.setUint8(this.pos++,10)}pdata(E,L,m){this.data.set(E.subarray(m,m+L),this.pos),this.pos+=L-m}psize1(E){this.view.setUint8(this.pos-E-1,E)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(E){let L=this.bitPos>>>3,m=8-(this.bitPos&7),T=0;this.bitPos+=E;for(;E>m;m=8)T+=(this.view.getUint8(L++)&D.bitmask[m])<<E-m,E-=m;if(E===m)T+=this.view.getUint8(L)&D.bitmask[m];else T+=this.view.getUint8(L)>>>m-E&D.bitmask[E];return T}rsaenc(E,L){let m=this.pos;this.pos=0;let T=new Uint8Array(m);this.gdata(m,0,T);let N=j0(T),G=k0(N,L,E),_=W0(G);this.pos=0,this.p1(_.length),this.pdata(_,_.length,0)}}class G0 extends o{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(E,L,m){super();this.pixels=new Int8Array(E*L),this.width2d=this.cropW=E,this.height2d=this.cropH=L,this.cropX=this.cropY=0,this.rgbPal=m}static fromArchive(E,L,m=0){let T=new D(E.read(L+".dat")),N=new D(E.read("index.dat"));N.pos=T.g2();let G=N.g2(),_=N.g2(),Q=N.g1(),M=new Int32Array(Q);for(let Z=1;Z<Q;Z++)if(M[Z]=N.g3(),M[Z]===0)M[Z]=1;for(let Z=0;Z<m;Z++)N.pos+=2,T.pos+=N.g2()*N.g2(),N.pos+=1;if(T.pos>T.length||N.pos>N.length)throw new Error;let $=N.g1(),R=N.g1(),J=N.g2(),W=N.g2(),I=new G0(J,W,M);I.cropX=$,I.cropY=R,I.cropW=G,I.cropH=_;let q=I.pixels,n=N.g1();if(n===0){let Z=I.width2d*I.height2d;for(let j=0;j<Z;j++)q[j]=T.g1b()}else if(n===1){let{width2d:Z,height2d:j}=I;for(let K=0;K<Z;K++)for(let z=0;z<j;z++)q[K+z*Z]=T.g1b()}return I}draw(E,L){E|=0,L|=0,E+=this.cropX,L+=this.cropY;let m=E+L*H.width2d,T=0,N=this.height2d,G=this.width2d,_=H.width2d-G,Q=0;if(L<H.top){let M=H.top-L;N-=M,L=H.top,T+=M*G,m+=M*H.width2d}if(L+N>H.bottom)N-=L+N-H.bottom;if(E<H.left){let M=H.left-E;G-=M,E=H.left,T+=M,m+=M,Q+=M,_+=M}if(E+G>H.right){let M=E+G-H.right;G-=M,Q+=M,_+=M}if(G>0&&N>0)this.copyImage(G,N,this.pixels,T,Q,H.pixels,m,_)}flipHorizontally(){let E=this.pixels,L=this.width2d,m=this.height2d;for(let T=0;T<m;T++){let N=L/2|0;for(let G=0;G<N;G++){let _=G+T*L,Q=L-G-1+T*L,M=E[_];E[_]=E[Q],E[Q]=M}}}flipVertically(){let E=this.pixels,L=this.width2d,m=this.height2d;for(let T=0;T<(m/2|0);T++)for(let N=0;N<L;N++){let G=N+T*L,_=N+(m-T-1)*L,Q=E[G];E[G]=E[_],E[_]=Q}}translate2d(E,L,m){for(let T=0;T<this.rgbPal.length;T++){let N=this.rgbPal[T]>>16&255;if(N+=E,N<0)N=0;else if(N>255)N=255;let G=this.rgbPal[T]>>8&255;if(G+=L,G<0)G=0;else if(G>255)G=255;let _=this.rgbPal[T]&255;if(_+=m,_<0)_=0;else if(_>255)_=255;this.rgbPal[T]=(N<<16)+(G<<8)+_}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let E=new Int8Array(this.cropW*this.cropH),L=0;for(let m=0;m<this.height2d;m++)for(let T=0;T<this.width2d;T++)E[(T+this.cropX>>1)+(m+this.cropY>>1)*this.cropW]=this.pixels[L++];this.pixels=E,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let E=new Int8Array(this.cropW*this.cropH),L=0;for(let m=0;m<this.height2d;m++)for(let T=0;T<this.width2d;T++)E[T+this.cropX+(m+this.cropY)*this.cropW]=this.pixels[L++];this.pixels=E,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(E,L,m,T,N,G,_,Q){let M=-(E>>2);E=-(E&3);for(let $=-L;$<0;$++){for(let R=M;R<0;R++){let J=m[T++];if(J===0)_++;else G[_++]=this.rgbPal[J&255];if(J=m[T++],J===0)_++;else G[_++]=this.rgbPal[J&255];if(J=m[T++],J===0)_++;else G[_++]=this.rgbPal[J&255];if(J=m[T++],J===0)_++;else G[_++]=this.rgbPal[J&255]}for(let R=E;R<0;R++){let J=m[T++];if(J===0)_++;else G[_++]=this.rgbPal[J&255]}_+=Q,T+=N}}clip(E,L,m,T){try{let N=this.width2d,G=this.height2d,_=0,Q=0,M=(N<<16)/m|0,$=(G<<16)/T|0,R=this.cropW,J=this.cropH,W=(R<<16)/m|0,I=(J<<16)/T|0;if(E=E+(this.cropX*m+R-1)/R|0,L=L+(this.cropY*T+J-1)/J|0,this.cropX*m%R!=0)_=(R-this.cropX*m%R<<16)/m|0;if(this.cropY*T%J!=0)Q=(J-this.cropY*T%J<<16)/T|0;m=m*(this.width2d-(_>>16))/R|0,T=T*(this.height2d-(Q>>16))/J|0;let q=E+L*H.width2d,n=H.width2d-m,Z;if(L<H.top)Z=H.top-L,T-=Z,L=0,q+=Z*H.width2d,Q+=I*Z;if(L+T>H.bottom)T-=L+T-H.bottom;if(E<H.left)Z=H.left-E,m-=Z,E=0,q+=Z,_+=W*Z,n+=Z;if(E+m>H.right)Z=E+m-H.right,m-=Z,n+=Z;this.plot_scale(H.pixels,this.pixels,this.rgbPal,_,Q,q,n,m,T,W,I,N)}catch(N){}}plot_scale(E,L,m,T,N,G,_,Q,M,$,R,J){try{let W=T;for(let I=-M;I<0;I++){let q=(N>>16)*J;for(let n=-Q;n<0;n++){let Z=L[(T>>16)+q];if(Z==0)G++;else E[G++]=m[Z&255];T+=$}N+=R,T=W,G+=_}}catch(W){}}}class L0 extends Array{constructor(E,L){super(E);for(let m=0;m<E;m++)this[m]=L}}class e extends Array{constructor(E,L,m){super(E);for(let T=0;T<E;T++){this[T]=new Array(L);for(let N=0;N<L;N++)this[T][N]=m}}}class R0 extends Array{constructor(E,L){super(E);for(let m=0;m<E;m++)this[m]=new Int32Array(L)}}class A extends H{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static hslPal=new Int32Array(65536);static textures=new L0(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new L0(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new L0(50,null);static opaque=!1;static textureTranslucent=new L0(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let E=1;E<512;E++)this.reciprocal15[E]=32768/E|0;for(let E=1;E<2048;E++)this.reciprocal16[E]=65536/E|0;for(let E=0;E<2048;E++)this.sin[E]=Math.sin(E*0.0030679615757712823)*65536|0,this.cos[E]=Math.cos(E*0.0030679615757712823)*65536|0}static init2D(){this.lineOffset=new Int32Array(H.height2d);for(let E=0;E<H.height2d;E++)this.lineOffset[E]=H.width2d*E;this.centerX=H.width2d/2|0,this.centerY=H.height2d/2|0}static init3D(E,L){this.lineOffset=new Int32Array(L);for(let m=0;m<L;m++)this.lineOffset[m]=E*m;this.centerX=E/2|0,this.centerY=L/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(E){this.textureCount=0;for(let L=0;L<50;L++)try{if(this.textures[L]=G0.fromArchive(E,L.toString()),this.lowMemory&&this.textures[L]?.cropW===128)this.textures[L]?.shrink();else this.textures[L]?.crop();this.textureCount++}catch(m){}}static getAverageTextureRGB(E){if(this.averageTextureRGB[E]!==0)return this.averageTextureRGB[E];let L=this.texPal[E];if(!L)return 0;let m=0,T=0,N=0,G=L.length;for(let Q=0;Q<G;Q++)m+=L[Q]>>16&255,T+=L[Q]>>8&255,N+=L[Q]&255;let _=((m/G|0)<<16)+((T/G|0)<<8)+(N/G|0);if(_=this.setGamma(_,1.4),_===0)_=1;return this.averageTextureRGB[E]=_,_}static setBrightness(E){let L=E+Math.random()*0.03-0.015,m=0;for(let T=0;T<512;T++){let N=(T/8|0)/64+0.0078125,G=(T&7)/8+0.0625;for(let _=0;_<128;_++){let Q=_/128,M=Q,$=Q,R=Q;if(G!==0){let n;if(Q<0.5)n=Q*(G+1);else n=Q+G-Q*G;let Z=Q*2-n,j=N+0.3333333333333333;if(j>1)j--;let K=N-0.3333333333333333;if(K<0)K++;if(j*6<1)M=Z+(n-Z)*6*j;else if(j*2<1)M=n;else if(j*3<2)M=Z+(n-Z)*(0.6666666666666666-j)*6;else M=Z;if(N*6<1)$=Z+(n-Z)*6*N;else if(N*2<1)$=n;else if(N*3<2)$=Z+(n-Z)*(0.6666666666666666-N)*6;else $=Z;if(K*6<1)R=Z+(n-Z)*6*K;else if(K*2<1)R=n;else if(K*3<2)R=Z+(n-Z)*(0.6666666666666666-K)*6;else R=Z}let J=M*256|0,W=$*256|0,I=R*256|0,q=(J<<16)+(W<<8)+I;this.hslPal[m++]=this.setGamma(q,L)}}for(let T=0;T<50;T++){let N=this.textures[T];if(!N)continue;let G=N.rgbPal;this.texPal[T]=new Int32Array(G.length);for(let _=0;_<G.length;_++){let Q=this.texPal[T];if(!Q)continue;Q[_]=this.setGamma(G[_],L)}}for(let T=0;T<50;T++)this.pushTexture(T)}static setGamma(E,L){let m=(E>>16)/256,T=(E>>8&255)/256,N=(E&255)/256,G=Math.pow(m,L),_=Math.pow(T,L),Q=Math.pow(N,L),M=G*256|0,$=_*256|0,R=Q*256|0;return(M<<16)+($<<8)+R}static initPool(E){if(this.texelPool)return;if(this.poolSize=E,this.lowMemory)this.texelPool=new R0(E,16384);else this.texelPool=new R0(E,65536);this.activeTexels.fill(null)}static fillGouraudTriangle(E,L,m,T,N,G,_,Q,M){let $=0,R=0;if(N!==T)$=(L-E<<16)/(N-T)|0,R=(Q-_<<15)/(N-T)|0;let J=0,W=0;if(G!==N)J=(m-L<<16)/(G-N)|0,W=(M-Q<<15)/(G-N)|0;let I=0,q=0;if(G!==T)I=(E-m<<16)/(T-G)|0,q=(_-M<<15)/(T-G)|0;if(T<=N&&T<=G){if(T<H.bottom){if(N>H.bottom)N=H.bottom;if(G>H.bottom)G=H.bottom;if(N<G){if(m=E<<=16,M=_<<=15,T<0)m-=I*T,E-=$*T,M-=q*T,_-=R*T,T=0;if(L<<=16,Q<<=15,N<0)L-=J*N,Q-=W*N,N=0;if(T!==N&&I<$||T===N&&I>J){G-=N,N-=T,T=A.lineOffset[T];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(m>>16,L>>16,M>>7,Q>>7,H.pixels,T,0),m+=I,L+=J,M+=q,Q+=W,T+=H.width2d}this.drawGouraudScanline(m>>16,E>>16,M>>7,_>>7,H.pixels,T,0),m+=I,E+=$,M+=q,_+=R,T+=H.width2d}}else{G-=N,N-=T,T=A.lineOffset[T];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(L>>16,m>>16,Q>>7,M>>7,H.pixels,T,0),m+=I,L+=J,M+=q,Q+=W,T+=H.width2d}this.drawGouraudScanline(E>>16,m>>16,_>>7,M>>7,H.pixels,T,0),m+=I,E+=$,M+=q,_+=R,T+=H.width2d}}}else{if(L=E<<=16,Q=_<<=15,T<0)L-=I*T,E-=$*T,Q-=q*T,_-=R*T,T=0;if(m<<=16,M<<=15,G<0)m-=J*G,M-=W*G,G=0;if(T!==G&&I<$||T===G&&J>$){N-=G,G-=T,T=A.lineOffset[T];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(m>>16,E>>16,M>>7,_>>7,H.pixels,T,0),m+=J,E+=$,M+=W,_+=R,T+=H.width2d}this.drawGouraudScanline(L>>16,E>>16,Q>>7,_>>7,H.pixels,T,0),L+=I,E+=$,Q+=q,_+=R,T+=H.width2d}}else{N-=G,G-=T,T=A.lineOffset[T];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(E>>16,m>>16,_>>7,M>>7,H.pixels,T,0),m+=J,E+=$,M+=W,_+=R,T+=H.width2d}this.drawGouraudScanline(E>>16,L>>16,_>>7,Q>>7,H.pixels,T,0),L+=I,E+=$,Q+=q,_+=R,T+=H.width2d}}}}}else if(N<=G){if(N<H.bottom){if(G>H.bottom)G=H.bottom;if(T>H.bottom)T=H.bottom;if(G<T){if(E=L<<=16,_=Q<<=15,N<0)E-=$*N,L-=J*N,_-=R*N,Q-=W*N,N=0;if(m<<=16,M<<=15,G<0)m-=I*G,M-=q*G,G=0;if(N!==G&&$<J||N===G&&$>I){T-=G,G-=N,N=A.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(T--,T<0)return;this.drawGouraudScanline(E>>16,m>>16,_>>7,M>>7,H.pixels,N,0),E+=$,m+=I,_+=R,M+=q,N+=H.width2d}this.drawGouraudScanline(E>>16,L>>16,_>>7,Q>>7,H.pixels,N,0),E+=$,L+=J,_+=R,Q+=W,N+=H.width2d}}else{T-=G,G-=N,N=A.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(T--,T<0)return;this.drawGouraudScanline(m>>16,E>>16,M>>7,_>>7,H.pixels,N,0),E+=$,m+=I,_+=R,M+=q,N+=H.width2d}this.drawGouraudScanline(L>>16,E>>16,Q>>7,_>>7,H.pixels,N,0),E+=$,L+=J,_+=R,Q+=W,N+=H.width2d}}}else{if(m=L<<=16,M=Q<<=15,N<0)m-=$*N,L-=J*N,M-=R*N,Q-=W*N,N=0;if(E<<=16,_<<=15,T<0)E-=I*T,_-=q*T,T=0;if(G-=T,T-=N,N=A.lineOffset[N],$<J)while(!0){if(T--,T<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(E>>16,L>>16,_>>7,Q>>7,H.pixels,N,0),E+=I,L+=J,_+=q,Q+=W,N+=H.width2d}this.drawGouraudScanline(m>>16,L>>16,M>>7,Q>>7,H.pixels,N,0),m+=$,L+=J,M+=R,Q+=W,N+=H.width2d}else while(!0){if(T--,T<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(L>>16,E>>16,Q>>7,_>>7,H.pixels,N,0),E+=I,L+=J,_+=q,Q+=W,N+=H.width2d}this.drawGouraudScanline(L>>16,m>>16,Q>>7,M>>7,H.pixels,N,0),m+=$,L+=J,M+=R,Q+=W,N+=H.width2d}}}}else if(G<H.bottom){if(T>H.bottom)T=H.bottom;if(N>H.bottom)N=H.bottom;if(T<N){if(L=m<<=16,Q=M<<=15,G<0)L-=J*G,m-=I*G,Q-=W*G,M-=q*G,G=0;if(E<<=16,_<<=15,T<0)E-=$*T,_-=R*T,T=0;if(N-=T,T-=G,G=A.lineOffset[G],J<I)while(!0){if(T--,T<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(L>>16,E>>16,Q>>7,_>>7,H.pixels,G,0),L+=J,E+=$,Q+=W,_+=R,G+=H.width2d}this.drawGouraudScanline(L>>16,m>>16,Q>>7,M>>7,H.pixels,G,0),L+=J,m+=I,Q+=W,M+=q,G+=H.width2d}else while(!0){if(T--,T<0)while(!0){if(N--,N<0)return;this.drawGouraudScanline(E>>16,L>>16,_>>7,Q>>7,H.pixels,G,0),L+=J,E+=$,Q+=W,_+=R,G+=H.width2d}this.drawGouraudScanline(m>>16,L>>16,M>>7,Q>>7,H.pixels,G,0),L+=J,m+=I,Q+=W,M+=q,G+=H.width2d}}else{if(E=m<<=16,_=M<<=15,G<0)E-=J*G,m-=I*G,_-=W*G,M-=q*G,G=0;if(L<<=16,Q<<=15,N<0)L-=$*N,Q-=R*N,N=0;if(T-=N,N-=G,G=A.lineOffset[G],J<I)while(!0){if(N--,N<0)while(!0){if(T--,T<0)return;this.drawGouraudScanline(L>>16,m>>16,Q>>7,M>>7,H.pixels,G,0),L+=$,m+=I,Q+=R,M+=q,G+=H.width2d}this.drawGouraudScanline(E>>16,m>>16,_>>7,M>>7,H.pixels,G,0),E+=J,m+=I,_+=W,M+=q,G+=H.width2d}else while(!0){if(N--,N<0)while(!0){if(T--,T<0)return;this.drawGouraudScanline(m>>16,L>>16,M>>7,Q>>7,H.pixels,G,0),L+=$,m+=I,Q+=R,M+=q,G+=H.width2d}this.drawGouraudScanline(m>>16,E>>16,M>>7,_>>7,H.pixels,G,0),E+=J,m+=I,_+=W,M+=q,G+=H.width2d}}}}static drawGouraudScanline(E,L,m,T,N,G,_){let Q;if(A.jagged){let M;if(A.clipX){if(L-E>3)M=(T-m)/(L-E)|0;else M=0;if(L>H.boundX)L=H.boundX;if(E<0)m-=E*M,E=0;if(E>=L)return;G+=E,_=L-E>>2,M<<=2}else if(E<L)if(G+=E,_=L-E>>2,_>0)M=(T-m)*A.reciprocal15[_]>>15;else M=0;else return;if(A.alpha===0)while(!0){if(_--,_<0){if(_=L-E&3,_>0){Q=A.hslPal[m>>8];do N[G++]=Q,_--;while(_>0);return}break}Q=A.hslPal[m>>8],m+=M,N[G++]=Q,N[G++]=Q,N[G++]=Q,N[G++]=Q}else{let $=A.alpha,R=256-A.alpha;while(!0){if(_--,_<0){if(_=L-E&3,_>0){Q=A.hslPal[m>>8],Q=((Q&16711935)*R>>8&16711935)+((Q&65280)*R>>8&65280);do N[G++]=Q+((N[G]&16711935)*$>>8&16711935)+((N[G]&65280)*$>>8&65280),_--;while(_>0)}break}Q=A.hslPal[m>>8],m+=M,Q=((Q&16711935)*R>>8&16711935)+((Q&65280)*R>>8&65280),N[G++]=Q+((N[G]&16711935)*$>>8&16711935)+((N[G]&65280)*$>>8&65280),N[G++]=Q+((N[G]&16711935)*$>>8&16711935)+((N[G]&65280)*$>>8&65280),N[G++]=Q+((N[G]&16711935)*$>>8&16711935)+((N[G]&65280)*$>>8&65280),N[G++]=Q+((N[G]&16711935)*$>>8&16711935)+((N[G]&65280)*$>>8&65280)}}}else if(E<L){let M=(T-m)/(L-E)|0;if(A.clipX){if(L>H.boundX)L=H.boundX;if(E<0)m-=E*M,E=0;if(E>=L)return}if(G+=E,_=L-E,A.alpha===0)do N[G++]=A.hslPal[m>>8],m+=M,_--;while(_>0);else{let $=A.alpha,R=256-A.alpha;do Q=A.hslPal[m>>8],m+=M,Q=((Q&16711935)*R>>8&16711935)+((Q&65280)*R>>8&65280),N[G++]=Q+((N[G]&16711935)*$>>8&16711935)+((N[G]&65280)*$>>8&65280),_--;while(_>0)}}}static fillTriangle(E,L,m,T,N,G,_){let Q=0;if(N!==T)Q=(L-E<<16)/(N-T)|0;let M=0;if(G!==N)M=(m-L<<16)/(G-N)|0;let $=0;if(G!==T)$=(E-m<<16)/(T-G)|0;if(T<=N&&T<=G){if(T<H.bottom){if(N>H.bottom)N=H.bottom;if(G>H.bottom)G=H.bottom;if(N<G){if(m=E<<=16,T<0)m-=$*T,E-=Q*T,T=0;if(L<<=16,N<0)L-=M*N,N=0;if(T!==N&&$<Q||T===N&&$>M){G-=N,N-=T,T=this.lineOffset[T];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawScanline(m>>16,L>>16,H.pixels,T,_),m+=$,L+=M,T+=H.width2d}this.drawScanline(m>>16,E>>16,H.pixels,T,_),m+=$,E+=Q,T+=H.width2d}}else{G-=N,N-=T,T=this.lineOffset[T];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawScanline(L>>16,m>>16,H.pixels,T,_),m+=$,L+=M,T+=H.width2d}this.drawScanline(E>>16,m>>16,H.pixels,T,_),m+=$,E+=Q,T+=H.width2d}}}else{if(L=E<<=16,T<0)L-=$*T,E-=Q*T,T=0;if(m<<=16,G<0)m-=M*G,G=0;if(T!==G&&$<Q||T===G&&M>Q){N-=G,G-=T,T=this.lineOffset[T];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawScanline(m>>16,E>>16,H.pixels,T,_),m+=M,E+=Q,T+=H.width2d}this.drawScanline(L>>16,E>>16,H.pixels,T,_),L+=$,E+=Q,T+=H.width2d}}else{N-=G,G-=T,T=this.lineOffset[T];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawScanline(E>>16,m>>16,H.pixels,T,_),m+=M,E+=Q,T+=H.width2d}this.drawScanline(E>>16,L>>16,H.pixels,T,_),L+=$,E+=Q,T+=H.width2d}}}}}else if(N<=G){if(N<H.bottom){if(G>H.bottom)G=H.bottom;if(T>H.bottom)T=H.bottom;if(G<T){if(E=L<<=16,N<0)E-=Q*N,L-=M*N,N=0;if(m<<=16,G<0)m-=$*G,G=0;if(N!==G&&Q<M||N===G&&Q>$){T-=G,G-=N,N=this.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(T--,T<0)return;this.drawScanline(E>>16,m>>16,H.pixels,N,_),E+=Q,m+=$,N+=H.width2d}this.drawScanline(E>>16,L>>16,H.pixels,N,_),E+=Q,L+=M,N+=H.width2d}}else{T-=G,G-=N,N=this.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(T--,T<0)return;this.drawScanline(m>>16,E>>16,H.pixels,N,_),E+=Q,m+=$,N+=H.width2d}this.drawScanline(L>>16,E>>16,H.pixels,N,_),E+=Q,L+=M,N+=H.width2d}}}else{if(m=L<<=16,N<0)m-=Q*N,L-=M*N,N=0;if(E<<=16,T<0)E-=$*T,T=0;if(Q<M){G-=T,T-=N,N=this.lineOffset[N];while(!0){if(T--,T<0)while(!0){if(G--,G<0)return;this.drawScanline(E>>16,L>>16,H.pixels,N,_),E+=$,L+=M,N+=H.width2d}this.drawScanline(m>>16,L>>16,H.pixels,N,_),m+=Q,L+=M,N+=H.width2d}}else{G-=T,T-=N,N=this.lineOffset[N];while(!0){if(T--,T<0)while(!0){if(G--,G<0)return;this.drawScanline(L>>16,E>>16,H.pixels,N,_),E+=$,L+=M,N+=H.width2d}this.drawScanline(L>>16,m>>16,H.pixels,N,_),m+=Q,L+=M,N+=H.width2d}}}}}else if(G<H.bottom){if(T>H.bottom)T=H.bottom;if(N>H.bottom)N=H.bottom;if(T<N){if(L=m<<=16,G<0)L-=M*G,m-=$*G,G=0;if(E<<=16,T<0)E-=Q*T,T=0;if(M<$){N-=T,T-=G,G=this.lineOffset[G];while(!0){if(T--,T<0)while(!0){if(N--,N<0)return;this.drawScanline(L>>16,E>>16,H.pixels,G,_),L+=M,E+=Q,G+=H.width2d}this.drawScanline(L>>16,m>>16,H.pixels,G,_),L+=M,m+=$,G+=H.width2d}}else{N-=T,T-=G,G=this.lineOffset[G];while(!0){if(T--,T<0)while(!0){if(N--,N<0)return;this.drawScanline(E>>16,L>>16,H.pixels,G,_),L+=M,E+=Q,G+=H.width2d}this.drawScanline(m>>16,L>>16,H.pixels,G,_),L+=M,m+=$,G+=H.width2d}}}else{if(E=m<<=16,G<0)E-=M*G,m-=$*G,G=0;if(L<<=16,N<0)L-=Q*N,N=0;if(M<$){T-=N,N-=G,G=this.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(T--,T<0)return;this.drawScanline(L>>16,m>>16,H.pixels,G,_),L+=Q,m+=$,G+=H.width2d}this.drawScanline(E>>16,m>>16,H.pixels,G,_),E+=M,m+=$,G+=H.width2d}}else{T-=N,N-=G,G=this.lineOffset[G];while(!0){if(N--,N<0)while(!0){if(T--,T<0)return;this.drawScanline(m>>16,L>>16,H.pixels,G,_),L+=Q,m+=$,G+=H.width2d}this.drawScanline(m>>16,E>>16,H.pixels,G,_),E+=M,m+=$,G+=H.width2d}}}}}static fillTexturedTriangle(E,L,m,T,N,G,_,Q,M,$,R,J,W,I,q,n,Z,j,K){let z=this.getTexels(K);this.opaque=!this.textureTranslucent[K];let V=$-W,b=R-q,v=J-Z,U=I-$,O=n-R,d=j-J,k=U*R-O*$<<14,u=O*J-d*R<<8,P=d*$-U*J<<5,X=V*R-b*$<<14,h=b*J-v*R<<8,w=v*$-V*J<<5,Y=b*U-V*O<<14,l=v*O-b*d<<8,S=V*d-v*U<<5,g=0,i=0;if(N!==T)g=(L-E<<16)/(N-T)|0,i=(Q-_<<16)/(N-T)|0;let p=0,c=0;if(G!==N)p=(m-L<<16)/(G-N)|0,c=(M-Q<<16)/(G-N)|0;let B=0,f=0;if(G!==T)B=(E-m<<16)/(T-G)|0,f=(_-M<<16)/(T-G)|0;if(T<=N&&T<=G){if(T<H.bottom){if(N>H.bottom)N=H.bottom;if(G>H.bottom)G=H.bottom;if(N<G){if(m=E<<=16,M=_<<=16,T<0)m-=B*T,E-=g*T,M-=f*T,_-=i*T,T=0;if(L<<=16,Q<<=16,N<0)L-=p*N,Q-=c*N,N=0;let s=T-this.centerY;if(k+=P*s,X+=w*s,Y+=S*s,k|=0,X|=0,Y|=0,T!==N&&B<g||T===N&&B>p){G-=N,N-=T,T=this.lineOffset[T];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(m>>16,L>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,M>>8,Q>>8),m+=B,L+=p,M+=f,Q+=c,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(m>>16,E>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,M>>8,_>>8),m+=B,E+=g,M+=f,_+=i,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}else{G-=N,N-=T,T=this.lineOffset[T];while(!0){if(N--,N<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(L>>16,m>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,Q>>8,M>>8),m+=B,L+=p,M+=f,Q+=c,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(E>>16,m>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,_>>8,M>>8),m+=B,E+=g,M+=f,_+=i,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}}else{if(L=E<<=16,Q=_<<=16,T<0)L-=B*T,E-=g*T,Q-=f*T,_-=i*T,T=0;if(m<<=16,M<<=16,G<0)m-=p*G,M-=c*G,G=0;let s=T-this.centerY;if(k+=P*s,X+=w*s,Y+=S*s,k|=0,X|=0,Y|=0,(T===G||B>=g)&&(T!==G||p<=g)){N-=G,G-=T,T=this.lineOffset[T];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(E>>16,m>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,_>>8,M>>8),m+=p,E+=g,M+=c,_+=i,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(E>>16,L>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,_>>8,Q>>8),L+=B,E+=g,Q+=f,_+=i,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}else{N-=G,G-=T,T=this.lineOffset[T];while(!0){if(G--,G<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(m>>16,E>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,M>>8,_>>8),m+=p,E+=g,M+=c,_+=i,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(L>>16,E>>16,H.pixels,T,z,0,0,k,X,Y,u,h,l,Q>>8,_>>8),L+=B,E+=g,Q+=f,_+=i,T+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}}}}else if(N<=G){if(N<H.bottom){if(G>H.bottom)G=H.bottom;if(T>H.bottom)T=H.bottom;if(G<T){if(E=L<<=16,_=Q<<=16,N<0)E-=g*N,L-=p*N,_-=i*N,Q-=c*N,N=0;if(m<<=16,M<<=16,G<0)m-=B*G,M-=f*G,G=0;let s=N-this.centerY;if(k+=P*s,X+=w*s,Y+=S*s,k|=0,X|=0,Y|=0,N!==G&&g<p||N===G&&g>B){T-=G,G-=N,N=this.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(T--,T<0)return;this.drawTexturedScanline(E>>16,m>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,_>>8,M>>8),E+=g,m+=B,_+=i,M+=f,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(E>>16,L>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,_>>8,Q>>8),E+=g,L+=p,_+=i,Q+=c,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}else{T-=G,G-=N,N=this.lineOffset[N];while(!0){if(G--,G<0)while(!0){if(T--,T<0)return;this.drawTexturedScanline(m>>16,E>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,M>>8,_>>8),E+=g,m+=B,_+=i,M+=f,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(L>>16,E>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,Q>>8,_>>8),E+=g,L+=p,_+=i,Q+=c,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}}else{if(m=L<<=16,M=Q<<=16,N<0)m-=g*N,L-=p*N,M-=i*N,Q-=c*N,N=0;if(E<<=16,_<<=16,T<0)E-=B*T,_-=f*T,T=0;let s=N-this.centerY;if(k+=P*s,X+=w*s,Y+=S*s,k|=0,X|=0,Y|=0,G-=T,T-=N,N=this.lineOffset[N],g<p)while(!0){if(T--,T<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(E>>16,L>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,_>>8,Q>>8),E+=B,L+=p,_+=f,Q+=c,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(m>>16,L>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,M>>8,Q>>8),m+=g,L+=p,M+=i,Q+=c,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}else while(!0){if(T--,T<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(L>>16,E>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,Q>>8,_>>8),E+=B,L+=p,_+=f,Q+=c,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(L>>16,m>>16,H.pixels,N,z,0,0,k,X,Y,u,h,l,Q>>8,M>>8),m+=g,L+=p,M+=i,Q+=c,N+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}}}else if(G<H.bottom){if(T>H.bottom)T=H.bottom;if(N>H.bottom)N=H.bottom;if(T<N){if(L=m<<=16,Q=M<<=16,G<0)L-=p*G,m-=B*G,Q-=c*G,M-=f*G,G=0;if(E<<=16,_<<=16,T<0)E-=g*T,_-=i*T,T=0;let s=G-this.centerY;if(k+=P*s,X+=w*s,Y+=S*s,k|=0,X|=0,Y|=0,N-=T,T-=G,G=this.lineOffset[G],p<B)while(!0){if(T--,T<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(L>>16,E>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,Q>>8,_>>8),L+=p,E+=g,Q+=c,_+=i,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(L>>16,m>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,Q>>8,M>>8),L+=p,m+=B,Q+=c,M+=f,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}else while(!0){if(T--,T<0)while(!0){if(N--,N<0)return;this.drawTexturedScanline(E>>16,L>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,_>>8,Q>>8),L+=p,E+=g,Q+=c,_+=i,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(m>>16,L>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,M>>8,Q>>8),L+=p,m+=B,Q+=c,M+=f,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}else{if(E=m<<=16,_=M<<=16,G<0)E-=p*G,m-=B*G,_-=c*G,M-=f*G,G=0;if(L<<=16,Q<<=16,N<0)L-=g*N,Q-=i*N,N=0;let s=G-this.centerY;if(k+=P*s,X+=w*s,Y+=S*s,k|=0,X|=0,Y|=0,T-=N,N-=G,G=this.lineOffset[G],p<B)while(!0){if(N--,N<0)while(!0){if(T--,T<0)return;this.drawTexturedScanline(L>>16,m>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,Q>>8,M>>8),L+=g,m+=B,Q+=i,M+=f,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(E>>16,m>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,_>>8,M>>8),E+=p,m+=B,_+=c,M+=f,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}else while(!0){if(N--,N<0)while(!0){if(T--,T<0)return;this.drawTexturedScanline(m>>16,L>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,M>>8,Q>>8),L+=g,m+=B,Q+=i,M+=f,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}this.drawTexturedScanline(m>>16,E>>16,H.pixels,G,z,0,0,k,X,Y,u,h,l,M>>8,_>>8),E+=p,m+=B,_+=c,M+=f,G+=H.width2d,k+=P,X+=w,Y+=S,k|=0,X|=0,Y|=0}}}}static drawTexturedScanline(E,L,m,T,N,G,_,Q,M,$,R,J,W,I,q){if(E>=L)return;let n,Z;if(this.clipX){if(n=(q-I)/(L-E)|0,L>H.boundX)L=H.boundX;if(E<0)I-=E*n,E=0;if(E>=L)return;Z=L-E>>3,n<<=12}else if(L-E>7)Z=L-E>>3,n=(q-I)*this.reciprocal15[Z]>>6;else Z=0,n=0;I<<=9,T+=E;let j,K,z,V,b,v,U;if(this.lowMemory&&N){if(j=0,K=0,V=E-this.centerX,Q=Q+(R>>3)*V,M=M+(J>>3)*V,$=$+(W>>3)*V,Q|=0,M|=0,$|=0,z=$>>12,z!==0){if(G=Q/z|0,_=M/z|0,G<0)G=0;else if(G>4032)G=4032}if(Q=Q+R,M=M+J,$=$+W,Q|=0,M|=0,$|=0,z=$>>12,z!==0){if(j=Q/z|0,K=M/z|0,j<7)j=7;else if(j>4032)j=4032}if(b=j-G>>3,v=K-_>>3,G+=I>>3&786432,U=I>>23,this.opaque){while(Z-- >0){if(m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v,m[T++]=N[(_&4032)+(G>>6)]>>>U,G=j,_=K,Q+=R,M+=J,$+=W,z=$>>12,z!==0){if(j=Q/z|0,K=M/z|0,j<7)j=7;else if(j>4032)j=4032}b=j-G>>3,v=K-_>>3,I+=n,G+=I>>3&786432,U=I>>23}Z=L-E&7;while(Z-- >0)m[T++]=N[(_&4032)+(G>>6)]>>>U,G+=b,_+=v}else{while(Z-- >0){let O;if((O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T=T+1,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;if(T=T+1,G=j,_=K,Q+=R,M+=J,$+=W,Q|=0,M|=0,$|=0,z=$>>12,z!==0){if(j=Q/z|0,K=M/z|0,j<7)j=7;else if(j>4032)j=4032}b=j-G>>3,v=K-_>>3,I+=n,G+=I>>3&786432,U=I>>23}Z=L-E&7;while(Z-- >0){let O;if((O=N[(_&4032)+(G>>6)]>>>U)!==0)m[T]=O;T++,G+=b,_+=v}}return}if(j=0,K=0,V=E-this.centerX,Q=Q+(R>>3)*V,M=M+(J>>3)*V,$=$+(W>>3)*V,Q|=0,M|=0,$|=0,z=$>>14,z!==0){if(G=Q/z|0,_=M/z|0,G<0)G=0;else if(G>16256)G=16256}if(Q=Q+R,M=M+J,$=$+W,Q|=0,M|=0,$|=0,z=$>>14,z!==0){if(j=Q/z|0,K=M/z|0,j<7)j=7;else if(j>16256)j=16256}if(b=j-G>>3,v=K-_>>3,G+=I&6291456,U=I>>23,this.opaque&&N){while(Z-- >0){if(m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v,m[T++]=N[(_&16256)+(G>>7)]>>>U,G=j,_=K,Q+=R,M+=J,$+=W,Q|=0,M|=0,$|=0,z=$>>14,z!==0){if(j=Q/z|0,K=M/z|0,j<7)j=7;else if(j>16256)j=16256}b=j-G>>3,v=K-_>>3,I+=n,G+=I&6291456,U=I>>23}Z=L-E&7;while(Z-- >0)m[T++]=N[(_&16256)+(G>>7)]>>>U,G+=b,_+=v;return}while(Z-- >0&&N){let O;if((O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T=T+1,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G+=b,_+=v,(O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;if(T++,G=j,_=K,Q+=R,M+=J,$+=W,Q|=0,M|=0,$|=0,z=$>>14,z!==0){if(j=Q/z|0,K=M/z|0,j<7)j=7;else if(j>16256)j=16256}b=j-G>>3,v=K-_>>3,I+=n,G+=I&6291456,U=I>>23}Z=L-E&7;while(Z-- >0&&N){let O;if((O=N[(_&16256)+(G>>7)]>>>U)!==0)m[T]=O;T++,G+=b,_+=v}}static drawScanline(E,L,m,T,N){if(this.clipX){if(L>H.boundX)L=H.boundX;if(E<0)E=0}if(E>=L)return;T+=E;let G=L-E>>2;if(this.alpha===0)while(!0){if(G--,G<0){G=L-E&3;while(!0){if(G--,G<0)return;m[T++]=N}}m[T++]=N,m[T++]=N,m[T++]=N,m[T++]=N}let _=this.alpha,Q=256-this.alpha;N=((N&16711935)*Q>>8&16711935)+((N&65280)*Q>>8&65280);while(!0){if(G--,G<0){G=L-E&3;while(!0){if(G--,G<0)return;m[T++]=N+((m[T]&16711935)*_>>8&16711935)+((m[T]&65280)*_>>8&65280)}}m[T++]=N+((m[T]&16711935)*_>>8&16711935)+((m[T]&65280)*_>>8&65280),m[T++]=N+((m[T]&16711935)*_>>8&16711935)+((m[T]&65280)*_>>8&65280),m[T++]=N+((m[T]&16711935)*_>>8&16711935)+((m[T]&65280)*_>>8&65280),m[T++]=N+((m[T]&16711935)*_>>8&16711935)+((m[T]&65280)*_>>8&65280)}}static pushTexture(E){if(this.activeTexels[E]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[E],this.activeTexels[E]=null}static getTexels(E){if(this.textureCycle[E]=this.cycle++,this.activeTexels[E])return this.activeTexels[E];let L;if(this.poolSize>0&&this.texelPool)L=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let N=0,G=-1;for(let _=0;_<this.textureCount;_++)if(this.activeTexels[_]&&(this.textureCycle[_]<N||G===-1))N=this.textureCycle[_],G=_;L=this.activeTexels[G],this.activeTexels[G]=null}this.activeTexels[E]=L;let m=this.textures[E],T=this.texPal[E];if(!L||!m||!T)return null;if(this.lowMemory){this.textureTranslucent[E]=!1;for(let N=0;N<4096;N++){let G=L[N]=T[m.pixels[N]]&16316671;if(G===0)this.textureTranslucent[E]=!0;L[N+4096]=G-(G>>>3)&16316671,L[N+8192]=G-(G>>>2)&16316671,L[N+12288]=G-(G>>>2)-(G>>>3)&16316671}}else{if(m.width2d===64)for(let N=0;N<128;N++)for(let G=0;G<128;G++)L[G+(N<<7|0)]=T[m.pixels[(G>>1)+(N>>1<<6|0)]];else for(let N=0;N<16384;N++)L[N]=T[m.pixels[N]];this.textureTranslucent[E]=!1;for(let N=0;N<16384;N++){L[N]&=16316671;let G=L[N];if(G===0)this.textureTranslucent[E]=!0;L[N+16384]=G-(G>>>3)&16316671,L[N+32768]=G-(G>>>2)&16316671,L[N+49152]=G-(G>>>2)-(G>>>3)&16316671}}return L}}class J0{image;width2d;height2d;ctx;paint;pixels;constructor(E,L,m=r){this.ctx=m,this.image=this.ctx.getImageData(0,0,E,L),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(E*L),this.width2d=E,this.height2d=L,this.bind()}clear(){this.pixels.fill(0)}bind(){H.bind(this.pixels,this.width2d,this.height2d)}draw(E,L){this.#E(),this.ctx.putImageData(this.image,E,L)}#E(){let E=this.pixels.length,L=this.pixels,m=this.paint;for(let T=0;T<E;T++){let N=L[T];m[T]=N>>16&255|(N>>8&255)<<8|(N&255)<<16|4278190080}}}var Z0=["F11","F12"],F=new Map;F.set("ArrowLeft",{code:37,ch:1});F.set("ArrowRight",{code:39,ch:2});F.set("ArrowUp",{code:38,ch:3});F.set("ArrowDown",{code:40,ch:4});F.set("Control",{code:17,ch:5});F.set("Shift",{code:16,ch:6});F.set("Alt",{code:18,ch:7});F.set("Backspace",{code:8,ch:8});F.set("Tab",{code:9,ch:9});F.set("Enter",{code:10,ch:10});F.set("Escape",{code:27,ch:27});F.set(" ",{code:32,ch:32});F.set("Delete",{code:127,ch:127});F.set("Home",{code:36,ch:1000});F.set("End",{code:35,ch:1001});F.set("PageUp",{code:33,ch:1002});F.set("PageDown",{code:34,ch:1003});F.set("F1",{code:112,ch:1008});F.set("F2",{code:113,ch:1009});F.set("F3",{code:114,ch:1010});F.set("F4",{code:115,ch:1011});F.set("F5",{code:116,ch:1012});F.set("F6",{code:117,ch:1013});F.set("F7",{code:118,ch:1014});F.set("F8",{code:119,ch:1015});F.set("F9",{code:120,ch:1016});F.set("F10",{code:121,ch:1017});F.set("F11",{code:122,ch:1018});F.set("F12",{code:123,ch:1019});F.set("CapsLock",{code:20,ch:65535});F.set("Meta",{code:524,ch:65535});F.set("Insert",{code:155,ch:65535});F.set("`",{code:192,ch:96});F.set("~",{code:192,ch:126});F.set("!",{code:49,ch:33});F.set("@",{code:50,ch:64});F.set("#",{code:51,ch:35});F.set("£",{code:51,ch:163});F.set("$",{code:52,ch:36});F.set("%",{code:53,ch:37});F.set("^",{code:54,ch:94});F.set("&",{code:55,ch:38});F.set("*",{code:56,ch:42});F.set("(",{code:57,ch:40});F.set(")",{code:48,ch:41});F.set("-",{code:45,ch:45});F.set("_",{code:45,ch:95});F.set("=",{code:61,ch:61});F.set("+",{code:61,ch:43});F.set("[",{code:91,ch:91});F.set("{",{code:91,ch:123});F.set("]",{code:93,ch:93});F.set("}",{code:93,ch:125});F.set("\\",{code:92,ch:92});F.set("|",{code:92,ch:124});F.set(";",{code:59,ch:59});F.set(":",{code:59,ch:58});F.set("'",{code:222,ch:39});F.set('"',{code:222,ch:34});F.set(",",{code:44,ch:44});F.set("<",{code:44,ch:60});F.set(".",{code:46,ch:46});F.set(">",{code:46,ch:62});F.set("/",{code:47,ch:47});F.set("?",{code:47,ch:63});F.set("0",{code:48,ch:48});F.set("1",{code:49,ch:49});F.set("2",{code:50,ch:50});F.set("3",{code:51,ch:51});F.set("4",{code:52,ch:52});F.set("5",{code:53,ch:53});F.set("6",{code:54,ch:54});F.set("7",{code:55,ch:55});F.set("8",{code:56,ch:56});F.set("9",{code:57,ch:57});F.set("a",{code:65,ch:97});F.set("b",{code:66,ch:98});F.set("c",{code:67,ch:99});F.set("d",{code:68,ch:100});F.set("e",{code:69,ch:101});F.set("f",{code:70,ch:102});F.set("g",{code:71,ch:103});F.set("h",{code:72,ch:104});F.set("i",{code:73,ch:105});F.set("j",{code:74,ch:106});F.set("k",{code:75,ch:107});F.set("l",{code:76,ch:108});F.set("m",{code:77,ch:109});F.set("n",{code:78,ch:110});F.set("o",{code:79,ch:111});F.set("p",{code:80,ch:112});F.set("q",{code:81,ch:113});F.set("r",{code:82,ch:114});F.set("s",{code:83,ch:115});F.set("t",{code:84,ch:116});F.set("u",{code:85,ch:117});F.set("v",{code:86,ch:118});F.set("w",{code:87,ch:119});F.set("x",{code:88,ch:120});F.set("y",{code:89,ch:121});F.set("z",{code:90,ch:122});F.set("A",{code:65,ch:65});F.set("B",{code:66,ch:66});F.set("C",{code:67,ch:67});F.set("D",{code:68,ch:68});F.set("E",{code:69,ch:69});F.set("F",{code:70,ch:70});F.set("G",{code:71,ch:71});F.set("H",{code:72,ch:72});F.set("I",{code:73,ch:73});F.set("J",{code:74,ch:74});F.set("K",{code:75,ch:75});F.set("L",{code:76,ch:76});F.set("M",{code:77,ch:77});F.set("N",{code:78,ch:78});F.set("O",{code:79,ch:79});F.set("P",{code:80,ch:80});F.set("Q",{code:81,ch:81});F.set("R",{code:82,ch:82});F.set("S",{code:83,ch:83});F.set("T",{code:84,ch:84});F.set("U",{code:85,ch:85});F.set("V",{code:86,ch:86});F.set("W",{code:87,ch:87});F.set("X",{code:88,ch:88});F.set("Y",{code:89,ch:89});F.set("Z",{code:90,ch:90});class a{static trackingActive=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=D.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.trackingActive=!0}static setDisabled(){this.trackingActive=!1,this.outBuffer=null}static flush(){let E=null;if(this.oldBuffer&&this.trackingActive)E=this.oldBuffer;return this.oldBuffer=null,E}static stop(){let E=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.trackingActive)E=this.outBuffer;return this.setDisabled(),E}static mousePressed(E,L,m){if(!(this.trackingActive&&E>=0&&E<789&&L>=0&&L<532))return;this.trackedCount++;let T=performance.now(),N=(T-this.lastTime)/10|0;if(N>250)N=250;if(this.lastTime=T,this.ensureCapacity(5),m===2)this.outBuffer?.p1(1);else this.outBuffer?.p1(2);this.outBuffer?.p1(N),this.outBuffer?.p3(E+(L<<10))}static mouseReleased(E){if(!this.trackingActive)return;this.trackedCount++;let L=performance.now(),m=(L-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=L,this.ensureCapacity(2),E===2)this.outBuffer?.p1(3);else this.outBuffer?.p1(4);this.outBuffer?.p1(m)}static mouseMoved(E,L){if(!(this.trackingActive&&E>=0&&E<789&&L>=0&&L<532))return;let m=performance.now();if(m-this.lastMoveTime>=50){this.lastMoveTime=m,this.trackedCount++;let T=(m-this.lastTime)/10|0;if(T>250)T=250;if(this.lastTime=m,E-this.lastX<8&&E-this.lastX>=-8&&L-this.lastY<8&&L-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer?.p1(5),this.outBuffer?.p1(T),this.outBuffer?.p1(E+(L-this.lastY+8<<4)+8-this.lastX);else if(E-this.lastX<128&&E-this.lastX>=-128&&L-this.lastY<128&&L-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer?.p1(6),this.outBuffer?.p1(T),this.outBuffer?.p1(E+128-this.lastX),this.outBuffer?.p1(L+128-this.lastY);else this.ensureCapacity(5),this.outBuffer?.p1(7),this.outBuffer?.p1(T),this.outBuffer?.p3(E+(L<<10));this.lastX=E,this.lastY=L}}static keyPressed(E){if(!this.trackingActive)return;this.trackedCount++;let L=performance.now(),m=(L-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=L,E===1000)E=11;else if(E===1001)E=12;else if(E===1002)E=14;else if(E===1003)E=15;else if(E>=1008)E-=992;this.ensureCapacity(3),this.outBuffer?.p1(8),this.outBuffer?.p1(m),this.outBuffer?.p1(E)}static keyReleased(E){if(!this.trackingActive)return;this.trackedCount++;let L=performance.now(),m=(L-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=L,E===1000)E=11;else if(E===1001)E=12;else if(E===1002)E=14;else if(E===1003)E=15;else if(E>=1008)E-=992;this.ensureCapacity(3),this.outBuffer?.p1(9),this.outBuffer?.p1(m),this.outBuffer?.p1(E)}static focusGained(){if(!this.trackingActive)return;this.trackedCount++;let E=performance.now(),L=(E-this.lastTime)/10|0;if(L>250)L=250;this.lastTime=E,this.ensureCapacity(2),this.outBuffer?.p1(10),this.outBuffer?.p1(L)}static focusLost(){if(!this.trackingActive)return;this.trackedCount++;let E=performance.now(),L=(E-this.lastTime)/10|0;if(L>250)L=250;this.lastTime=E,this.ensureCapacity(2),this.outBuffer?.p1(11),this.outBuffer?.p1(L)}static mouseEntered(){if(!this.trackingActive)return;this.trackedCount++;let E=performance.now(),L=(E-this.lastTime)/10|0;if(L>250)L=250;this.lastTime=E,this.ensureCapacity(2),this.outBuffer?.p1(12),this.outBuffer?.p1(L)}static mouseExited(){if(!this.trackingActive)return;this.trackedCount++;let E=performance.now(),L=(E-this.lastTime)/10|0;if(L>250)L=250;this.lastTime=E,this.ensureCapacity(2),this.outBuffer?.p1(13),this.outBuffer?.p1(L)}static ensureCapacity(E){if(!this.outBuffer)return;if(this.outBuffer.pos+E>=500){let L=this.outBuffer;this.outBuffer=D.alloc(1),this.oldBuffer=L}}}import{MobileKeyboard as x}from"./deps.js";class I0{slowestMS=0;averageMS=[];averageIndexMS=0;drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=!0;resizeToFit=!1;tfps=50;hasFocus=!0;ingame=!1;idleCycles=performance.now();mouseButton=0;mouseX=-1;mouseY=-1;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;async load(){}async update(){}async draw(){}async refresh(){}constructor(E=!1){if(C.tabIndex=-1,r.fillStyle="black",r.fillRect(0,0,C.width,C.height),this.resizeToFit=E,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(C.width,C.height)}get width(){return C.width}get height(){return C.height}resize(E,L){C.width=E,C.height=L,this.drawArea=new J0(E,L),A.init2D()}async run(){if(C.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),C.onfocus=this.onfocus.bind(this),C.onblur=this.onblur.bind(this),C.onmousedown=this.onmousedown.bind(this),C.onmouseup=this.onmouseup.bind(this),C.onmouseenter=this.onmouseenter.bind(this),C.onmouseleave=this.onmouseleave.bind(this),C.onmousemove=this.onmousemove.bind(this),C.onkeydown=this.onkeydown.bind(this),C.onkeyup=this.onkeyup.bind(this),this.isMobile)C.ontouchstart=this.ontouchstart.bind(this),C.ontouchend=this.ontouchend.bind(this),C.ontouchmove=this.ontouchmove.bind(this);C.oncontextmenu=(G)=>{G.preventDefault()},window.oncontextmenu=(G)=>{G.preventDefault()},await this.showProgress(0,"Loading..."),await this.load();for(let G=0;G<10;G++)this.otim[G]=performance.now();let E,L=0,m=256,T=1,N=0;while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let G=m,_=T;m=300,T=1,E=performance.now();let Q=this.otim[L];if(Q===0)m=G,T=_;else if(E>Q)m=this.deltime*2560/(E-Q)|0;if(m<25)m=25;else if(m>256)m=256,T=this.deltime-(E-Q)/10|0;if(this.otim[L]=E,L=(L+1)%10,T>1){for(let $=0;$<10;$++)if(this.otim[$]!==0)this.otim[$]+=T}if(T<this.mindel)T=this.mindel;await Q0(T);while(N<256)await this.update(),this.mouseClickButton=0,this.keyQueueReadPos=this.keyQueueWritePos,N+=m;if(N&=255,this.deltime>0)this.fps=m*1000/(this.deltime*256)|0;let M=performance.now();if(await this.draw(),this.isMobile)x.draw();if(this.frameTime[this.fpos]=(performance.now()-M)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let $=1000/this.tfps-(performance.now()-E);if($>0)await Q0($)}}if(this.state===-1)this.shutdown()}shutdown(){this.state=-2}setFramerate(E){this.deltime=1000/E|0}setTargetedFramerate(E){this.tfps=Math.max(Math.min(50,E|0),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4000/this.deltime|0}destroy(){this.state=-1}async showProgress(E,L){let m=this.width,T=this.height;if(this.redrawScreen)r.fillStyle="black",r.fillRect(0,0,m,T),this.redrawScreen=!1;let N=T/2-18;r.strokeStyle="rgb(140, 17, 17)",r.strokeRect((m/2|0)-152,N,304,34),r.fillStyle="rgb(140, 17, 17)",r.fillRect((m/2|0)-150,N+2,E*3,30),r.fillStyle="black",r.fillRect((m/2|0)-150+E*3,N+2,300-E*3,30),r.font="bold 13px helvetica, sans-serif",r.textAlign="center",r.fillStyle="white",r.fillText(L,m/2|0,N+22),await Q0(5)}pollKey(){let E=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)E=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return E}get ms(){let E=this.frameTime.length,L=0;for(let T=0;T<E;T++)L+=this.frameTime[T];let m=L/E*1000;if(m>this.slowestMS)this.slowestMS=m;return this.averageMS[this.averageIndexMS]=m,this.averageIndexMS=(this.averageIndexMS+1)%250,m}get msAvg(){return this.averageMS.reduce((E,L)=>E+L,0)/250}onkeydown(E){this.idleCycles=performance.now();let L=F.get(E.key);if(!L||E.code.length===0&&!E.isTrusted)return;let m=L.ch;if(E.ctrlKey){if(m>=65&&m<=93||m==95)m-=64;else if(m>=97&&m<=122)m-=96}if(m>0&&m<128)this.actionKey[m]=1;if(m>4)this.keyQueue[this.keyQueueWritePos]=m,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if(a.trackingActive)a.keyPressed(m);if(!Z0.includes(E.key))E.preventDefault()}onkeyup(E){this.idleCycles=performance.now();let L=F.get(E.key);if(!L||E.code.length===0&&!E.isTrusted)return;let m=L.ch;if(E.ctrlKey){if(m>=65&&m<=93||m==95)m-=64;else if(m>=97&&m<=122)m-=96}if(m>0&&m<128)this.actionKey[m]=0;if(a.trackingActive)a.keyReleased(m);if(!Z0.includes(E.key))E.preventDefault()}onmousedown(E){if(this.touching=!1,E.clientX>0||E.clientY>0)this.setMousePosition(E);if(this.idleCycles=performance.now(),this.mouseClickX=this.mouseX,this.mouseClickY=this.mouseY,this.isMobile&&!this.isCapacitor){if(this.insideMobileInputArea()&&!this.insideUsernameArea()&&!this.inPasswordArea()){this.mouseClickButton=0,this.mouseButton=0;return}if(E.timeStamp>=this.time+500)this.mouseClickButton=2,this.mouseButton=2;else this.mouseClickButton=1,this.mouseButton=1}else if(E.button===2)this.mouseClickButton=2,this.mouseButton=2;else if(E.button===0)this.mouseClickButton=1,this.mouseButton=1;if(x.isDisplayed()){if(x.captureMouseDown(this.mouseX,this.mouseY))this.mouseButton=0,this.mouseClickButton=0}if(a.trackingActive)a.mousePressed(this.mouseClickX,this.mouseClickY,E.button)}onmouseup(E){if(this.setMousePosition(E),this.idleCycles=performance.now(),this.mouseButton=0,a.trackingActive)a.mouseReleased(E.button);if(this.isMobile){if(this.insideMobileInputArea()&&!x.isDisplayed())x.show(this.mouseX,this.mouseY);else if(x.isDisplayed()){if(!x.captureMouseUp(this.mouseX,this.mouseY))x.hide(),this.refresh()}}}onmouseenter(E){if(this.setMousePosition(E),a.trackingActive)a.mouseEntered()}onmouseleave(E){if(this.setMousePosition(E),this.idleCycles=performance.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,a.trackingActive)a.mouseExited()}onmousemove(E){if(this.setMousePosition(E),this.idleCycles=performance.now(),this.isMobile&&this.touching){if(x.isDisplayed())x.notifyTouchMove(this.mouseX,this.mouseY)}if(a.trackingActive)a.mouseMoved(this.mouseX,this.mouseY)}onfocus(E){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),a.trackingActive)a.focusGained()}onblur(E){this.hasFocus=!1;for(let L=0;L<128;L++)this.actionKey[L]=0;if(a.trackingActive)a.focusLost()}ontouchstart(E){if(!this.isMobile)return;this.touching=!0;let L=E.changedTouches[0],m=L.clientX|0,T=L.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:m,clientY:T})),this.sx=this.nx=this.mx=L.screenX|0,this.sy=this.ny=this.my=L.screenY|0,this.time=E.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}ontouchend(E){if(!this.isMobile||!this.touching)return;let L=E.changedTouches[0],m=L.clientX|0,T=L.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:m,clientY:T})),this.nx=L.screenX|0,this.ny=L.screenY|0,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea()){this.touching=!1;return}else if(this.startedInTabArea&&!this.insideTabArea()){this.touching=!1;return}else if(this.insideMobileInputArea()){this.touching=!1;return}let G=E.timeStamp>=this.time+500,_=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(G&&!_)this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{clientX:m,clientY:T,button:2})),this.onmouseup(new MouseEvent("mouseup",{clientX:m,clientY:T,button:2}))}ontouchmove(E){if(!this.isMobile||!this.touching)return;if(E.touches.length>1)return;E.preventDefault();let L=E.changedTouches[0],m=L.clientX|0,T=L.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:m,clientY:T})),this.nx=L.screenX|0,this.ny=L.screenY|0,!x.isWithinCanvasKeyboard(this.mouseX,this.mouseY)){if(this.startedInViewport&&this.getViewportInterfaceId()===-1){if(this.mx-this.nx>0)this.rotate(2);else if(this.mx-this.nx<0)this.rotate(0);if(this.my-this.ny>0)this.rotate(3);else if(this.my-this.ny<0)this.rotate(1)}else if(this.startedInTabArea||this.getViewportInterfaceId()!==-1)this.onmousedown(new MouseEvent("mousedown",{clientX:m,clientY:T,button:1}))}this.mx=this.nx,this.my=this.ny}get isMobile(){if(["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some((L)=>navigator.userAgent.includes(L)))return!0;if(navigator){if(navigator.maxTouchPoints!==void 0&&navigator.maxTouchPoints>2&&navigator.standalone!==void 0)return!0}return!1}get isAndroid(){return["Android"].some((L)=>navigator.userAgent.includes(L))}get isCapacitor(){return["Capacitor"].some((L)=>navigator.userAgent.includes(L))}insideViewportArea(){return this.ingame&&this.mouseX>=8&&this.mouseX<=520&&this.mouseY>=11&&this.mouseY<=345}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=449&&this.mouseY<=482}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=383&&this.mouseY<=482}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let E=this.getViewportInterfaceId(),L=this.getReportAbuseInterfaceId();if(E===-1||L===-1)return!1;if(E!==L)return!1;let m=82,T=137,N=m+366,G=T+26;return this.mouseX>=m&&this.mouseX<=N&&this.mouseY>=T&&this.mouseY<=G}insideTabArea(){return this.ingame&&this.mouseX>=562&&this.mouseX<=752&&this.mouseY>=231&&this.mouseY<=492}insideUsernameArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=262&&this.mouseY<=279}inPasswordArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=279&&this.mouseY<=296}rotate(E){if(E===0)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}));else if(E===1)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}));else if(E===2)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}));else if(E===3)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))}isFullScreen(){return document.fullscreenElement!==null}setMousePosition(E){let L=this.width,m=this.height,T=C.getBoundingClientRect(),N={x:E.clientX-T.left,y:E.clientY-T.top};if(this.isFullScreen()){let G=L/m,Q=window.innerWidth/window.innerHeight>=G,M=0,$=0,R=0,J=0;if(Q)M=window.innerHeight*G,$=window.innerHeight,R=(window.innerWidth-M)/2;else M=window.innerWidth,$=window.innerWidth/G,J=(window.innerHeight-$)/2;let W=L/M,I=m/$;this.mouseX=(N.x-R)*W|0,this.mouseY=(N.y-J)*I|0}else{let G=C.width/T.width,_=C.height/T.height;this.mouseX=N.x*G|0,this.mouseY=N.y*_|0}if(this.mouseX<0)this.mouseX=0;if(this.mouseY<0)this.mouseY=0;if(this.mouseX>L)this.mouseX=L;if(this.mouseY>m)this.mouseY=m}}async function z0(E){if(E[0]!==255)E[0]=255;URL.revokeObjectURL(T0.src),T0.src=URL.createObjectURL(new Blob([E],{type:"image/jpeg"})),await new Promise((T)=>T0.onload=()=>T()),H0.clearRect(0,0,N0.width,N0.height);let L=T0.naturalWidth,m=T0.naturalHeight;return N0.width=L,N0.height=m,H0.drawImage(T0,0,0),H0.getImageData(0,0,L,m)}class E0 extends o{pixels;width2d;height2d;cropX;cropY;cropW;cropH;constructor(E,L){super();this.pixels=new Int32Array(E*L),this.width2d=this.cropW=E,this.height2d=this.cropH=L,this.cropX=this.cropY=0}static async fromJpeg(E,L){let m=E.read(L+".dat");if(!m)throw new Error;let T=await z0(m),N=new E0(T.width,T.height),G=new Uint32Array(T.data.buffer),_=N.pixels;for(let Q=0;Q<_.length;Q++){let M=G[Q];_[Q]=(M>>24&255)<<24|(M&255)<<16|(M>>8&255)<<8|M>>16&255}return N}static fromArchive(E,L,m=0){let T=new D(E.read(L+".dat")),N=new D(E.read("index.dat"));N.pos=T.g2();let G=N.g2(),_=N.g2(),Q=N.g1(),M=[],$=Q-1;for(let Z=0;Z<$;Z++)if(M[Z+1]=N.g3(),M[Z+1]===0)M[Z+1]=1;for(let Z=0;Z<m;Z++)N.pos+=2,T.pos+=N.g2()*N.g2(),N.pos+=1;if(T.pos>T.length||N.pos>N.length)throw new Error;let R=N.g1(),J=N.g1(),W=N.g2(),I=N.g2(),q=new E0(W,I);q.cropX=R,q.cropY=J,q.cropW=G,q.cropH=_;let n=N.g1();if(n===0){let Z=q.width2d*q.height2d;for(let j=0;j<Z;j++)q.pixels[j]=M[T.g1()]}else if(n===1){let Z=q.width2d;for(let j=0;j<Z;j++){let K=q.height2d;for(let z=0;z<K;z++)q.pixels[j+z*Z]=M[T.g1()]}}return q}bind(){H.bind(this.pixels,this.width2d,this.height2d)}draw(E,L){E|=0,L|=0,E+=this.cropX,L+=this.cropY;let m=E+L*H.width2d,T=0,N=this.height2d,G=this.width2d,_=H.width2d-G,Q=0;if(L<H.top){let M=H.top-L;N-=M,L=H.top,T+=M*G,m+=M*H.width2d}if(L+N>H.bottom)N-=L+N-H.bottom;if(E<H.left){let M=H.left-E;G-=M,E=H.left,T+=M,m+=M,Q+=M,_+=M}if(E+G>H.right){let M=E+G-H.right;G-=M,Q+=M,_+=M}if(G>0&&N>0)this.copyImageDraw(G,N,this.pixels,T,Q,H.pixels,m,_)}drawAlpha(E,L,m){L|=0,m|=0,L+=this.cropX,m+=this.cropY;let T=L+m*H.width2d,N=0,G=this.height2d,_=this.width2d,Q=H.width2d-_,M=0;if(m<H.top){let $=H.top-m;G-=$,m=H.top,N+=$*_,T+=$*H.width2d}if(m+G>H.bottom)G-=m+G-H.bottom;if(L<H.left){let $=H.left-L;_-=$,L=H.left,N+=$,T+=$,M+=$,Q+=$}if(L+_>H.right){let $=L+_-H.right;_-=$,M+=$,Q+=$}if(_>0&&G>0)this.copyPixelsAlpha(_,G,this.pixels,N,M,H.pixels,T,Q,E)}blitOpaque(E,L){E|=0,L|=0,E+=this.cropX,L+=this.cropY;let m=E+L*H.width2d,T=0,N=this.height2d,G=this.width2d,_=H.width2d-G,Q=0;if(L<H.top){let M=H.top-L;N-=M,L=H.top,T+=M*G,m+=M*H.width2d}if(L+N>H.bottom)N-=L+N-H.bottom;if(E<H.left){let M=H.left-E;G-=M,E=H.left,T+=M,m+=M,Q+=M,_+=M}if(E+G>H.right){let M=E+G-H.right;G-=M,Q+=M,_+=M}if(G>0&&N>0)this.copyImageBlitOpaque(G,N,this.pixels,T,Q,H.pixels,m,_)}flipHorizontally(){let E=this.pixels,L=this.width2d,m=this.height2d;for(let T=0;T<m;T++){let N=L/2|0;for(let G=0;G<N;G++){let _=G+T*L,Q=L-G-1+T*L,M=E[_];E[_]=E[Q],E[Q]=M}}}flipVertically(){let E=this.pixels,L=this.width2d,m=this.height2d;for(let T=0;T<(m/2|0);T++)for(let N=0;N<L;N++){let G=N+T*L,_=N+(m-T-1)*L,Q=E[G];E[G]=E[_],E[_]=Q}}translate2d(E,L,m){for(let T=0;T<this.pixels.length;T++){let N=this.pixels[T];if(N!==0){let G=N>>16&255;if(G+=E,G<1)G=1;else if(G>255)G=255;let _=N>>8&255;if(_+=L,_<1)_=1;else if(_>255)_=255;let Q=N&255;if(Q+=m,Q<1)Q=1;else if(Q>255)Q=255;this.pixels[T]=(G<<16)+(_<<8)+Q}}}crop(E,L,m,T){E|=0,L|=0,m|=0,T|=0;try{let N=this.width2d,G=0,_=0,Q=this.cropW,M=this.cropH,$=(Q<<16)/m|0,R=(M<<16)/T|0;if(E+=(this.cropX*m+Q-1)/Q|0,L+=(this.cropY*T+M-1)/M|0,this.cropX*m%Q!==0)G=(Q-this.cropX*m%Q<<16)/m|0;if(this.cropY*T%M!==0)_=(M-this.cropY*T%M<<16)/T|0;m=m*(this.width2d-(G>>16))/Q|0,T=T*(this.height2d-(_>>16))/M|0;let J=E+L*H.width2d,W=H.width2d-m;if(L<H.top){let I=H.top-L;T-=I,L=0,J+=I*H.width2d,_+=R*I}if(L+T>H.bottom)T-=L+T-H.bottom;if(E<H.left){let I=H.left-E;m-=I,E=0,J+=I,G+=$*I,W+=I}if(E+m>H.right){let I=E+m-H.right;m-=I,W+=I}this.scale(m,T,this.pixels,G,_,H.pixels,W,J,N,$,R)}catch(N){}}drawRotatedMasked(E,L,m,T,N,G,_,Q,M,$){E|=0,L|=0,m|=0,T|=0;try{let R=-m/2|0,J=-T/2|0,W=Math.sin(M/326.11)*65536|0,I=Math.cos(M/326.11)*65536|0,q=W*$>>8,n=I*$>>8,Z=(_<<16)+J*q+R*n,j=(Q<<16)+(J*n-R*q),K=E+L*H.width2d;for(let z=0;z<T;z++){let V=N[z],b=K+V,v=Z+n*V,U=j-q*V;for(let O=-G[z];O<0;O++)H.pixels[b++]=this.pixels[(v>>16)+(U>>16)*this.width2d],v+=n,U-=q;Z+=q,j+=n,K+=H.width2d}}catch(R){}}drawMasked(E,L,m){E|=0,L|=0,E+=this.cropX,L+=this.cropY;let T=E+L*H.width2d,N=0,G=this.height2d,_=this.width2d,Q=H.width2d-_,M=0;if(L<H.top){let $=H.top-L;G-=$,L=H.top,N+=$*_,T+=$*H.width2d}if(L+G>H.bottom)G-=L+G-H.bottom;if(E<H.left){let $=H.left-E;_-=$,E=H.left,N+=$,T+=$,M+=$,Q+=$}if(E+_>H.right){let $=E+_-H.right;_-=$,M+=$,Q+=$}if(_>0&&G>0)this.copyPixelsMasked(_,G,this.pixels,M,N,H.pixels,T,Q,m.pixels)}scale(E,L,m,T,N,G,_,Q,M,$,R){try{let J=T;for(let W=-L;W<0;W++){let I=(N>>16)*M;for(let q=-E;q<0;q++){let n=m[(T>>16)+I];if(n===0)Q++;else G[Q++]=n;T+=$}N+=R,T=J,Q+=_}}catch(J){}}copyImageBlitOpaque(E,L,m,T,N,G,_,Q){let M=-(E>>2);E=-(E&3);for(let $=-L;$<0;$++){for(let R=M;R<0;R++)G[_++]=m[T++],G[_++]=m[T++],G[_++]=m[T++],G[_++]=m[T++];for(let R=E;R<0;R++)G[_++]=m[T++];_+=Q,T+=N}}copyPixelsAlpha(E,L,m,T,N,G,_,Q,M){let $=256-M;for(let R=-L;R<0;R++){for(let J=-E;J<0;J++){let W=m[T++];if(W===0)_++;else{let I=G[_];G[_++]=((W&16711935)*M+(I&16711935)*$&4278255360)+((W&65280)*M+(I&65280)*$&16711680)>>8}}_+=Q,T+=N}}copyImageDraw(E,L,m,T,N,G,_,Q){let M=-(E>>2);E=-(E&3);for(let $=-L;$<0;$++){for(let R=M;R<0;R++){let J=m[T++];if(J===0)_++;else G[_++]=J;if(J=m[T++],J===0)_++;else G[_++]=J;if(J=m[T++],J===0)_++;else G[_++]=J;if(J=m[T++],J===0)_++;else G[_++]=J}for(let R=E;R<0;R++){let J=m[T++];if(J===0)_++;else G[_++]=J}_+=Q,T+=N}}copyPixelsMasked(E,L,m,T,N,G,_,Q,M){let $=-(E>>2);E=-(E&3);for(let R=-L;R<0;R++){for(let J=$;J<0;J++){let W=m[N++];if(W!==0&&M[_]===0)G[_++]=W;else _++;if(W=m[N++],W!==0&&M[_]===0)G[_++]=W;else _++;if(W=m[N++],W!==0&&M[_]===0)G[_++]=W;else _++;if(W=m[N++],W!==0&&M[_]===0)G[_++]=W;else _++}for(let J=E;J<0;J++){let W=m[N++];if(W!==0&&M[_]===0)G[_++]=W;else _++}_+=Q,N+=T}}}class F0{seed;constructor(E){this.seed=(E^0x5deece66dn)&(1n<<48n)-1n}setSeed(E){this.seed=(E^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(E){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-E}}class t extends o{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new F0(BigInt(Date.now()));height2d=0;static{let E=navigator.userAgent.includes("Capacitor");for(let L=0;L<256;L++){let m=t.CHARSET.indexOf(String.fromCharCode(L));if(E){if(m>=63)m--}if(m===-1)m=74;t.CHARCODESET[L]=m}}static fromArchive(E,L){let m=new D(E.read(L+".dat")),T=new D(E.read("index.dat"));T.pos=m.g2()+4;let N=T.g1();if(N>0)T.pos+=(N-1)*3;let G=new t;for(let _=0;_<94;_++){G.charOffsetX[_]=T.g1(),G.charOffsetY[_]=T.g1();let Q=G.charMaskWidth[_]=T.g2(),M=G.charMaskHeight[_]=T.g2(),$=T.g1(),R=Q*M;if(G.charMask[_]=new Int8Array(R),$===0)for(let J=0;J<Q*M;J++)G.charMask[_][J]=m.g1b();else if($===1)for(let J=0;J<Q;J++)for(let W=0;W<M;W++)G.charMask[_][J+W*Q]=m.g1b();if(M>G.height2d)G.height2d=M;G.charOffsetX[_]=1,G.charAdvance[_]=Q+2;{let J=0;for(let W=M/7|0;W<M;W++)J+=G.charMask[_][W*Q];if(J<=(M/7|0))G.charAdvance[_]--,G.charOffsetX[_]=0}{let J=0;for(let W=M/7|0;W<M;W++)J+=G.charMask[_][Q+W*Q-1];if(J<=(M/7|0))G.charAdvance[_]--}}G.charAdvance[94]=G.charAdvance[8];for(let _=0;_<256;_++)G.drawWidth[_]=G.charAdvance[t.CHARCODESET[_]];return G}drawString(E,L,m,T){if(!m)return;E|=0,L|=0;let N=m.length;L-=this.height2d;for(let G=0;G<N;G++){let _=t.CHARCODESET[m.charCodeAt(G)];if(_!==94)this.drawChar(this.charMask[_],E+this.charOffsetX[_],L+this.charOffsetY[_],this.charMaskWidth[_],this.charMaskHeight[_],T);E+=this.charAdvance[_]}}drawStringTaggable(E,L,m,T,N){E|=0,L|=0;let G=m.length;L-=this.height2d;for(let _=0;_<G;_++)if(m.charAt(_)==="@"&&_+4<G&&m.charAt(_+4)==="@")T=this.evaluateTag(m.substring(_+1,_+4)),_+=4;else{let Q=t.CHARCODESET[m.charCodeAt(_)];if(Q!==94){if(N)this.drawChar(this.charMask[Q],E+this.charOffsetX[Q]+1,L+this.charOffsetY[Q]+1,this.charMaskWidth[Q],this.charMaskHeight[Q],0);this.drawChar(this.charMask[Q],E+this.charOffsetX[Q],L+this.charOffsetY[Q],this.charMaskWidth[Q],this.charMaskHeight[Q],T)}E+=this.charAdvance[Q]}}stringWidth(E){if(!E)return 0;let L=E.length,m=0;for(let T=0;T<L;T++)if(E.charAt(T)==="@"&&T+4<L&&E.charAt(T+4)==="@")T+=4;else m+=this.drawWidth[E.charCodeAt(T)];return m}drawStringTaggableCenter(E,L,m,T,N){E|=0,L|=0,this.drawStringTaggable(E-(this.stringWidth(m)/2|0),L,m,T,N)}drawStringCenter(E,L,m,T){if(!m)return;E|=0,L|=0,this.drawString(E-(this.stringWidth(m)/2|0),L,m,T)}drawStringTooltip(E,L,m,T,N,G){E|=0,L|=0,this.random.setSeed(BigInt(G));let _=(this.random.nextInt()&31)+192,Q=L-this.height2d;for(let M=0;M<m.length;M++)if(m.charAt(M)==="@"&&M+4<m.length&&m.charAt(M+4)==="@")T=this.evaluateTag(m.substring(M+1,M+4)),M+=4;else{let $=t.CHARCODESET[m.charCodeAt(M)];if($!==94){if(N)this.drawCharAlpha(E+this.charOffsetX[$]+1,Q+this.charOffsetY[$]+1,this.charMaskWidth[$],this.charMaskHeight[$],0,192,this.charMask[$]);this.drawCharAlpha(E+this.charOffsetX[$],Q+this.charOffsetY[$],this.charMaskWidth[$],this.charMaskHeight[$],T,_,this.charMask[$])}if(E+=this.charAdvance[$],(this.random.nextInt()&3)===0)E++}}drawStringRight(E,L,m,T,N=!0){if(E|=0,L|=0,N)this.drawString(E-this.stringWidth(m)+1,L+1,m,0);this.drawString(E-this.stringWidth(m),L,m,T)}drawCenteredWave(E,L,m,T,N){if(!m)return;E|=0,L|=0,E-=this.stringWidth(m)/2|0;let G=L-this.height2d;for(let _=0;_<m.length;_++){let Q=t.CHARCODESET[m.charCodeAt(_)];if(Q!=94)this.drawChar(this.charMask[Q],E+this.charOffsetX[Q],G+this.charOffsetY[Q]+(Math.sin(_/2+N/5)*5|0),this.charMaskWidth[Q],this.charMaskHeight[Q],T);E+=this.charAdvance[Q]}}drawChar(E,L,m,T,N,G){L|=0,m|=0,T|=0,N|=0;let _=L+m*H.width2d,Q=H.width2d-T,M=0,$=0;if(m<H.top){let R=H.top-m;N-=R,m=H.top,$+=R*T,_+=R*H.width2d}if(m+N>=H.bottom)N-=m+N+1-H.bottom;if(L<H.left){let R=H.left-L;T-=R,L=H.left,$+=R,_+=R,M+=R,Q+=R}if(L+T>=H.right){let R=L+T+1-H.right;T-=R,M+=R,Q+=R}if(T>0&&N>0)this.drawMask(T,N,E,$,M,H.pixels,_,Q,G)}drawCharAlpha(E,L,m,T,N,G,_){E|=0,L|=0,m|=0,T|=0;let Q=E+L*H.width2d,M=H.width2d-m,$=0,R=0;if(L<H.top){let J=H.top-L;T-=J,L=H.top,R+=J*m,Q+=J*H.width2d}if(L+T>=H.bottom)T-=L+T+1-H.bottom;if(E<H.left){let J=H.left-E;m-=J,E=H.left,R+=J,Q+=J,$+=J,M+=J}if(E+m>=H.right){let J=E+m+1-H.right;m-=J,$+=J,M+=J}if(m>0&&T>0)this.drawMaskAlpha(m,T,H.pixels,Q,M,_,R,$,N,G)}drawMask(E,L,m,T,N,G,_,Q,M){E|=0,L|=0;let $=-(E>>2);E=-(E&3);for(let R=-L;R<0;R++){for(let J=$;J<0;J++){if(m[T++]===0)_++;else G[_++]=M;if(m[T++]===0)_++;else G[_++]=M;if(m[T++]===0)_++;else G[_++]=M;if(m[T++]===0)_++;else G[_++]=M}for(let J=E;J<0;J++)if(m[T++]===0)_++;else G[_++]=M;_+=Q,T+=N}}drawMaskAlpha(E,L,m,T,N,G,_,Q,M,$){E|=0,L|=0;let R=((M&16711935)*$&4278255360)+((M&65280)*$&16711680)>>8,J=256-$;for(let W=-L;W<0;W++){for(let I=-E;I<0;I++)if(G[_++]===0)T++;else{let q=m[T];m[T++]=(((q&16711935)*J&4278255360)+((q&65280)*J&16711680)>>8)+R}T+=N,_+=Q}}evaluateTag(E){if(E==="red")return 16711680;else if(E==="gre")return 65280;else if(E==="blu")return 255;else if(E==="yel")return 16776960;else if(E==="cya")return 65535;else if(E==="mag")return 16711935;else if(E==="whi")return 16777215;else if(E==="bla")return 0;else if(E==="lre")return 16748608;else if(E==="dre")return 8388608;else if(E==="dbl")return 128;else if(E==="or1")return 16756736;else if(E==="or2")return 16740352;else if(E==="or3")return 16723968;else if(E==="gr1")return 12648192;else if(E==="gr2")return 8453888;else if(E==="gr3")return 4259584;else return 0}split(E,L){if(E.length===0)return[E];let m=[];while(E.length>0){if(this.stringWidth(E)<=L&&E.indexOf("|")===-1){m.push(E);break}let N=E.length;for(let G=0;G<E.length;G++)if(E[G]===" "){if(this.stringWidth(E.substring(0,G))>L)break;N=G}else if(E[G]==="|"){N=G;break}m.push(E.substring(0,N)),E=E.substring(N+1)}return m}}class M0{db;constructor(E){E.onerror=this.onerror,E.onclose=this.onclose,this.db=E}static async openDatabase(){return await new Promise((E,L)=>{let m=indexedDB.open("lostcity",1);m.onsuccess=(T)=>{let N=T.target;E(N.result)},m.onupgradeneeded=(T)=>{T.target.result.createObjectStore("cache")},m.onerror=(T)=>{let N=T.target;L(N.result)}})}async cacheload(E){return await new Promise((L)=>{let N=this.db.transaction("cache","readonly").objectStore("cache").get(E);N.onsuccess=()=>{if(N.result)L(new Uint8Array(N.result));else L(void 0)},N.onerror=()=>{L(void 0)}})}async cachesave(E,L){if(L===null)return;return await new Promise((m,T)=>{let _=this.db.transaction("cache","readwrite").objectStore("cache").put(L,E);_.onsuccess=()=>{m()},_.onerror=()=>{m()}})}onclose=(E)=>{};onerror=(E)=>{}}import{BZip2 as b0}from"./deps.js";class $0{static genHash(E){let L=0;E=E.toUpperCase();for(let m=0;m<E.length;m++)L=L*61+E.charCodeAt(m)-32|0;return L}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(E){let L=new D(new Uint8Array(E)),m=L.g3(),T=L.g3();if(m===T)this.jagSrc=E,this.compressedWhole=!1;else this.jagSrc=b0.decompress(E.subarray(6),m,!0),L=new D(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=L.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let N=L.pos+this.fileCount*10;for(let G=0;G<this.fileCount;G++)this.fileHash.push(L.g4()),this.fileUnpackedSize.push(L.g3()),this.filePackedSize.push(L.g3()),this.fileOffset.push(N),N+=this.filePackedSize[G]}read(E){let L=$0.genHash(E),m=this.fileHash.indexOf(L);if(m===-1)return null;return this.readIndex(m)}readIndex(E){if(E<0||E>=this.fileCount)return null;if(this.fileUnpacked[E])return this.fileUnpacked[E];let L=this.fileOffset[E],m=L+this.filePackedSize[E],T=new Uint8Array(this.jagSrc.subarray(L,L+m));if(this.compressedWhole)return this.fileUnpacked[E]=T,T;else{let N=b0.decompress(T,this.fileUnpackedSize[E],!0);return this.fileUnpacked[E]=N,N}}}class y extends I0{static shouldDrawBorders=!1;static shouldDrawLabels=!0;static shouldDrawNpcs=!1;static shouldDrawItems=!1;startX=3200;startZ=3200;sizeX=1280;sizeZ=1344;originX=2240;originZ=2752;db=null;maxLabelCount=1000;labelCount=0;labelText=[];labelX=[];labelY=[];labelFont=[];floorcolUnderlay=[0];floorcolOverlay=[0];underlayTiles=[];overlayTiles=[];overlayInfo=[];locWalls=[];locMapscenes=[];locMapfunction=[];objTiles=[];npcTiles=[];imageMapscene=[];imageMapfunction=[];imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;b12=null;floormapColors=[];redraw=!0;redrawTimer=0;lastMouseClickX=-1;lastMouseClickY=-1;lastOffsetX=-1;lastOffsetZ=-1;shouldClearEmptyTiles=!1;keyX=5;keyY=13;keyWidth=140;keyHeight=470;showKey=!1;keyPage=0;lastKeyPage=0;currentKeyHover=-1;lastKeyHover=0;currentKey=0;flashTimer=0;visibleMapFunctionsX=new Int32Array(2000);visibleMapFunctionsY=new Int32Array(2000);visibleMapFunctions=new Int32Array(2000);activeMapFunctionX=new Int32Array(2000);activeMapFunctionZ=new Int32Array(2000);activeMapFunctions=new Int32Array(2000);activeMapFunctionCount=0;imageOverview=null;imageOverviewHeight=200;imageOverviewWidth=this.imageOverviewHeight*this.sizeX/this.sizeZ|0;overviewX=635-this.imageOverviewWidth-5;overviewY=503-this.imageOverviewHeight-20;showOverview=!1;colorInactiveBorderTL=8943445;colorInactive=7824964;colorInactiveBorderBR=6706483;colorActiveBorderTL=11141120;colorActive=10027008;colorActiveBorderBR=8912896;zoom=4;targetZoom=4;offsetX=this.startX-this.originX;offsetZ=this.originZ+this.sizeZ-this.startZ;activeTileX=-1;activeTileZ=-1;keyNames=["General Store","Sword Shop","Magic Shop","Axe Shop","Helmet Shop","Bank","Quest Start","Amulet Shop","Mining Site","Furnace","Anvil","Combat Training","Dungeon","Staff Shop","Platebody Shop","Platelegs Shop","Scimitar Shop","Archery Shop","Shield Shop","Altar","Herbalist","Jewelery","Gem Shop","Crafting Shop","Candle Shop","Fishing Shop","Fishing Spot","Clothes Shop","Apothecary","Silk Trader","Kebab Seller","Pub/Bar","Mace Shop","Tannery","Rare Trees","Spinning Wheel","Food Shop","Cookery Shop","???","Water Source","Cooking Range","Skirt Shop","Potters Wheel","Windmill","Mining Shop","Chainmail Shop","Silver Shop","Fur Trader","Spice Shop"];constructor(){super();this.run()}async load(){this.keyHeight=this.height-this.keyY-20,this.overviewX=this.width-this.imageOverviewWidth-5,this.overviewY=this.height-this.imageOverviewHeight-20,this.db=new M0(await M0.openDatabase());let E=await this.loadWorldmap();await this.showProgress(100,"Please wait... Rendering Map");let L=new D(E.read("labels.dat"));this.labelCount=L.g2();for(let $=0;$<this.labelCount;$++)this.labelText[$]=L.gjstr(),this.labelX[$]=L.g2(),this.labelY[$]=L.g2(),this.labelFont[$]=L.g1();let m=new D(E.read("floorcol.dat")),T=m.g2();for(let $=0;$<T;$++)this.floorcolUnderlay[$+1]=m.g4(),this.floorcolOverlay[$+1]=m.g4();let N=new D(E.read("underlay.dat"));this.underlayTiles=new e(this.sizeX,this.sizeZ,0),this.readUnderlayData(N);let G=new D(E.read("overlay.dat"));this.overlayTiles=new e(this.sizeX,this.sizeZ,0),this.overlayInfo=new e(this.sizeX,this.sizeZ,0),this.readOverlayData(G);let _=new D(E.read("loc.dat"));this.locWalls=new e(this.sizeX,this.sizeZ,0),this.locMapscenes=new e(this.sizeX,this.sizeZ,0),this.locMapfunction=new e(this.sizeX,this.sizeZ,0),this.readLocData(_);let Q=new D(E.read("obj.dat"));this.objTiles=new e(this.sizeX,this.sizeZ,!1),this.readObjData(Q);let M=new D(E.read("npc.dat"));this.npcTiles=new e(this.sizeX,this.sizeZ,!1),this.readNpcData(M);try{for(let $=0;$<50;$++)this.imageMapscene[$]=G0.fromArchive(E,"mapscene",$)}catch($){}try{for(let $=0;$<50;$++)this.imageMapfunction[$]=E0.fromArchive(E,"mapfunction",$)}catch($){}if(this.imageMapdot0=E0.fromArchive(E,"mapdots",0),this.imageMapdot1=E0.fromArchive(E,"mapdots",1),this.imageMapdot2=E0.fromArchive(E,"mapdots",2),this.imageMapdot3=E0.fromArchive(E,"mapdots",3),this.b12=t.fromArchive(E,"b12"),this.floormapColors=new e(this.sizeX,this.sizeZ,0),this.averageUnderlayColors(),this.shouldClearEmptyTiles)this.clearEmptyTiles();this.imageOverview=new E0(this.imageOverviewWidth,this.imageOverviewHeight),this.imageOverview.bind(),this.drawMap(0,0,this.sizeX,this.sizeZ,0,0,this.imageOverviewWidth,this.imageOverviewHeight),H.drawRect(0,0,this.imageOverviewWidth,this.imageOverviewHeight,0),H.drawRect(1,1,this.imageOverviewWidth-2,this.imageOverviewHeight-2,this.colorInactiveBorderTL),this.drawArea.bind()}async draw(){if(this.redraw){this.redraw=!1,this.redrawTimer=0,H.clear();let E=this.offsetX-(this.width/this.zoom|0),L=this.offsetZ-(this.height/this.zoom|0),m=this.offsetX+(this.width/this.zoom|0),T=this.offsetZ+(this.height/this.zoom|0);if(this.drawMap(E,L,m,T,0,0,this.width,this.height),this.showOverview){if(this.imageOverview?.blitOpaque(this.overviewX,this.overviewY),H.fillRectAlpha(this.overviewX+this.imageOverviewWidth*E/this.sizeX|0,this.overviewY+this.imageOverviewHeight*L/this.sizeZ|0,(m-E)*this.imageOverviewWidth/this.sizeX|0,(T-L)*this.imageOverviewHeight/this.sizeZ|0,16711680,128),H.drawRect(this.overviewX+this.imageOverviewWidth*E/this.sizeX|0,this.overviewY+this.imageOverviewHeight*L/this.sizeZ|0,(m-E)*this.imageOverviewWidth/this.sizeX|0,(T-L)*this.imageOverviewHeight/this.sizeZ|0,16711680),this.flashTimer>0&&this.flashTimer%10<5){for(let G=0;G<this.activeMapFunctionCount;G++)if(this.activeMapFunctions[G]==this.currentKey){let _=this.overviewX+this.imageOverviewWidth*this.activeMapFunctionX[G]/this.sizeX|0,Q=this.overviewY+this.imageOverviewHeight*this.activeMapFunctionZ[G]/this.sizeZ|0;H.fillCircle(_,Q,2,16776960,256)}}}if(this.showKey){this.drawString(this.keyX,this.keyY,this.keyWidth,18,10066329,7829367,5592405,"Prev page"),this.drawString(this.keyX,this.keyY+18,this.keyWidth,this.keyHeight-36,10066329,7829367,5592405,""),this.drawString(this.keyX,this.keyY+this.keyHeight-18,this.keyWidth,18,10066329,7829367,5592405,"Next page");let G=(this.keyHeight-20)/18,_=this.keyY+18+3;for(let Q=0;Q<G;Q++){if(Q+this.lastKeyPage<this.imageMapfunction.length&&Q+this.lastKeyPage<this.keyNames.length){if(this.keyNames[Q+this.lastKeyPage]==="???")continue;this.imageMapfunction[Q+this.lastKeyPage].draw(this.keyX+3,_),this.b12?.drawString(this.keyX+21,_+14,this.keyNames[Q+this.lastKeyPage],0);let M=16777215;if(this.currentKeyHover==Q+this.lastKeyPage)M=12298922;if(this.flashTimer>0&&this.flashTimer%10<5&&this.currentKey==Q+this.lastKeyPage)M=16776960;this.b12?.drawString(this.keyX+20,_+13,this.keyNames[Q+this.lastKeyPage],M)}_+=17}}this.drawString(this.overviewX,this.overviewY+this.imageOverviewHeight,this.imageOverviewWidth,18,this.colorInactiveBorderTL,this.colorInactive,this.colorInactiveBorderBR,"Overview"),this.drawString(this.keyX,this.keyY+this.keyHeight,this.keyWidth,18,this.colorInactiveBorderTL,this.colorInactive,this.colorInactiveBorderBR,"Key");let N=this.height-this.keyY-20+1;if(this.targetZoom==3)this.drawString(170,N,50,30,this.colorActiveBorderTL,this.colorActive,this.colorActiveBorderBR,"37%");else this.drawString(170,N,50,30,this.colorInactiveBorderTL,this.colorInactive,this.colorInactiveBorderBR,"37%");if(this.targetZoom==4)this.drawString(230,N,50,30,this.colorActiveBorderTL,this.colorActive,this.colorActiveBorderBR,"50%");else this.drawString(230,N,50,30,this.colorInactiveBorderTL,this.colorInactive,this.colorInactiveBorderBR,"50%");if(this.targetZoom==6)this.drawString(290,N,50,30,this.colorActiveBorderTL,this.colorActive,this.colorActiveBorderBR,"75%");else this.drawString(290,N,50,30,this.colorInactiveBorderTL,this.colorInactive,this.colorInactiveBorderBR,"75%");if(this.targetZoom==8)this.drawString(350,N,50,30,this.colorActiveBorderTL,this.colorActive,this.colorActiveBorderBR,"100%");else this.drawString(350,N,50,30,this.colorInactiveBorderTL,this.colorInactive,this.colorInactiveBorderBR,"100%")}if(this.redrawTimer--,this.redrawTimer<=0)this.drawArea?.draw(0,0),this.redrawTimer=50}async refresh(){this.redrawTimer=0}async update(){if(this.actionKey[1]==1)this.offsetX=this.offsetX-16/this.zoom|0,this.redraw=!0;if(this.actionKey[2]==1)this.offsetX=this.offsetX+16/this.zoom|0,this.redraw=!0;if(this.actionKey[3]==1)this.offsetZ=this.offsetZ-16/this.zoom|0,this.redraw=!0;if(this.actionKey[4]==1)this.offsetZ=this.offsetZ+16/this.zoom|0,this.redraw=!0;let E=1;do{if(E=this.pollKey(),E===-1)break;if(E==49)this.targetZoom=3,this.redraw=!0;else if(E==50)this.targetZoom=4,this.redraw=!0;else if(E==51)this.targetZoom=6,this.redraw=!0;else if(E==52)this.targetZoom=8,this.redraw=!0;else if(E==107||E==75)this.showKey=!this.showKey,this.redraw=!0;else if(E==111||E==79)this.showOverview=!this.showOverview,this.redraw=!0;else if(E==101||E==69);else if(E==110||E==78)y.shouldDrawNpcs=!y.shouldDrawNpcs,this.redraw=!0;else if(E==105||E==73)y.shouldDrawItems=!y.shouldDrawItems,this.redraw=!0;else if(E==108||E==76)y.shouldDrawLabels=!y.shouldDrawLabels,this.redraw=!0;else if(E==98||E==66)y.shouldDrawBorders=!y.shouldDrawBorders,this.redraw=!0}while(E>0);if(this.mouseClickButton==1){this.lastMouseClickX=this.mouseClickX,this.lastMouseClickY=this.mouseClickY,this.lastOffsetX=this.offsetX,this.lastOffsetZ=this.offsetZ;let G=this.height-this.keyY-20+1;if(this.mouseClickX>170&&this.mouseClickX<220&&this.mouseClickY>G)this.targetZoom=3,this.lastMouseClickX=-1;else if(this.mouseClickX>230&&this.mouseClickX<280&&this.mouseClickY>G)this.targetZoom=4,this.lastMouseClickX=-1;else if(this.mouseClickX>290&&this.mouseClickX<340&&this.mouseClickY>G)this.targetZoom=6,this.lastMouseClickX=-1;else if(this.mouseClickX>350&&this.mouseClickX<400&&this.mouseClickY>G)this.targetZoom=8,this.lastMouseClickX=-1;else if(this.mouseClickX>this.keyX&&this.mouseClickY>this.keyY+this.keyHeight&&this.mouseClickX<this.keyX+this.keyWidth)this.showKey=!this.showKey,this.lastMouseClickX=-1;else if(this.mouseClickX>this.overviewX&&this.mouseClickY>this.overviewY+this.imageOverviewHeight&&this.mouseClickX<this.overviewX+this.imageOverviewWidth)this.showOverview=!this.showOverview,this.lastMouseClickX=-1;if(this.showKey){if(this.mouseClickX>this.keyX&&this.mouseClickY>this.keyY&&this.mouseClickX<this.keyX+this.keyWidth&&this.mouseClickY<this.keyY+this.keyHeight)this.lastMouseClickX=-1;if(this.mouseClickX>this.keyX&&this.mouseClickY>this.keyY&&this.mouseClickX<this.keyX+this.keyWidth&&this.mouseClickY<this.keyY+18)this.keyPage=0;else if(this.mouseClickX>this.keyX&&this.mouseClickY>this.keyY+this.keyHeight-18&&this.mouseClickX<this.keyX+this.keyWidth&&this.mouseClickY<this.keyY+this.keyHeight)this.keyPage=25}this.redraw=!0}if(this.showKey){if(this.currentKeyHover=-1,this.mouseX>this.keyX&&this.mouseX<this.keyX+this.keyWidth){let G=(this.keyHeight-20)/18,_=this.keyY+21+5;for(let Q=0;Q<G;Q++)if(Q+this.lastKeyPage<this.keyNames.length&&this.keyNames[Q+this.lastKeyPage]!=="???"){if(this.mouseY>=_&&this.mouseY<_+17){if(this.currentKeyHover=Q+this.lastKeyPage,this.mouseClickButton==1)this.currentKey=Q+this.lastKeyPage,this.flashTimer=50}_+=17}}if(this.currentKeyHover!=this.lastKeyHover)this.lastKeyHover=this.currentKeyHover,this.redraw=!0}if((this.mouseButton==1||this.mouseClickButton==1)&&this.showOverview){let G=this.mouseClickX,_=this.mouseClickY;if(this.mouseButton==1)G=this.mouseX,_=this.mouseY;if(G>this.overviewX&&_>this.overviewY&&G<this.overviewX+this.imageOverviewWidth&&_<this.overviewY+this.imageOverviewHeight)this.offsetX=(G-this.overviewX)*this.sizeX/this.imageOverviewWidth|0,this.offsetZ=(_-this.overviewY)*this.sizeZ/this.imageOverviewHeight|0,this.lastMouseClickX=-1,this.redraw=!0}if(this.mouseButton==1&&this.lastMouseClickX!=-1)this.offsetX=this.lastOffsetX+((this.lastMouseClickX-this.mouseX)*2/this.targetZoom|0),this.offsetZ=this.lastOffsetZ+((this.lastMouseClickY-this.mouseY)*2/this.targetZoom|0),this.redraw=!0;if(this.zoom<this.targetZoom){if(this.redraw=!0,this.zoom+=this.zoom/30,this.zoom>this.targetZoom)this.zoom=this.targetZoom}if(this.zoom>this.targetZoom){if(this.redraw=!0,this.zoom-=this.zoom/30,this.zoom<this.targetZoom)this.zoom=this.targetZoom}if(this.lastKeyPage<this.keyPage)this.redraw=!0,this.lastKeyPage++;if(this.lastKeyPage>this.keyPage)this.redraw=!0,this.lastKeyPage--;if(this.flashTimer>0)this.redraw=!0,this.flashTimer--;let L=this.offsetX-(this.width/this.zoom|0),m=this.offsetZ-(this.height/this.zoom|0),T=this.offsetX+(this.width/this.zoom|0),N=this.offsetZ+(this.height/this.zoom|0);if(L<48)this.offsetX=(this.width/this.zoom|0)+48;if(m<48)this.offsetZ=(this.height/this.zoom|0)+48;if(T>this.sizeX-48)this.offsetX=this.sizeX-48-(this.width/this.zoom|0);if(N>this.sizeZ-48)this.offsetZ=this.sizeZ-48-(this.height/this.zoom|0)}async loadWorldmap(){let E=await this.db?.cacheload("worldmap.dat");if(E)return new $0(E);let L=5;while(!E){await this.showProgress(0,"Requesting map");try{E=await q0("/worldmap.jag")}catch(m){E=void 0;for(let T=L;T>0;T--)await this.showProgress(0,`Error loading - Will retry in ${T} secs.`),await Q0(1000);if(L*=2,L>60)L=60}}return await this.db?.cachesave("worldmap.dat",E),new $0(E)}drawString(E,L,m,T,N,G,_,Q){E=Math.trunc(E),L=Math.trunc(L),m=Math.trunc(m),T=Math.trunc(T),H.drawRect(E,L,m,T,0);let M=E+1,$=L+1,R=m-2,J=T-2;H.fillRect2d(M,$,R,J,G),H.drawHorizontalLine(M,$,N,R),H.drawVerticalLine(M,$,N,J),H.drawHorizontalLine(M,$+J-1,_,R),H.drawVerticalLine(M+R-1,$,_,J),this.b12?.drawStringCenter(M+R/2+1,$+J/2+1+4,Q,0),this.b12?.drawStringCenter(M+R/2,$+J/2+4,Q,16777215)}clearEmptyTiles(){for(let E=0;E<this.sizeX;E++)for(let L=0;L<this.sizeZ;L++)if(this.underlayTiles[E][L]==0&&this.overlayTiles[E][L]==0)this.floormapColors[E][L]=0}averageUnderlayColors(){let E=this.sizeX,L=this.sizeZ,m=new L0(L,0);for(let T=5;T<E-5;T++){for(let N=0;N<L;N++)m[N]+=this.floorcolUnderlay[this.underlayTiles[T+5][N]]-this.floorcolUnderlay[this.underlayTiles[T-5][N]];if(T>10&&T<E-10){let N=0,G=0,_=0;for(let Q=5;Q<L-5;Q++){let M=m[Q+5],$=m[Q-5];if(N+=(M>>20)-($>>20),G+=(M>>10&1023)-($>>10&1023),_+=(M&1023)-($&1023),_>0)this.floormapColors[T][Q]=this.convertHsl(N/8533,G/8533,_/8533)}}}}readUnderlayData(E){while(E.available>0){let L=E.g1()*64-this.originX,m=E.g1()*64-this.originZ;if(L>0&&m>0&&L+64<this.sizeX&&m+64<this.sizeZ)for(let T=0;T<64;T++){let N=this.sizeZ-m-1;for(let G=-64;G<0;G++)this.underlayTiles[L+T][N--]=E.g1()}else E.pos+=4096}}readOverlayData(E){while(E.available>0){let L=E.g1()*64-this.originX,m=E.g1()*64-this.originZ;if(L>0&&m>0&&L+64<this.sizeX&&m+64<this.sizeZ)for(let T=0;T<64;T++){let N=this.sizeZ-m-1;for(let G=-64;G<0;G++){let _=E.g1();if(_===0)this.overlayTiles[T+L][N--]=0;else this.overlayInfo[T+L][N]=E.g1(),this.overlayTiles[T+L][N--]=this.floorcolOverlay[_]}}else for(let T=-4096;T<0;T++)if(E.g1()!=0)E.g1()}}readLocData(E){while(E.available>0){let L=E.g1()*64-this.originX,m=E.g1()*64-this.originZ;if(L>0&&m>0&&L+64<this.sizeX&&m+64<this.sizeZ)for(let T=0;T<64;T++){let N=this.sizeZ-m-1;for(let G=-64;G<0;G++)while(!0){let _=E.g1();if(_===0){N--;break}if(_<29)this.locWalls[T+L][N]=_;else if(_<160)this.locMapscenes[T+L][N]=_-28;else this.locMapfunction[T+L][N]=_-159,this.activeMapFunctions[this.activeMapFunctionCount]=_-160,this.activeMapFunctionX[this.activeMapFunctionCount]=T+L,this.activeMapFunctionZ[this.activeMapFunctionCount]=N,this.activeMapFunctionCount++}}else for(let T=0;T<64;T++){let N=0;for(let G=-64;G<0;G++)do N=E.g1();while(N!=0)}}}readObjData(E){while(E.available>0){let L=E.g1()*64-this.originX,m=E.g1()*64-this.originZ;if(L>0&&m>0&&L+64<this.sizeX&&m+64<this.sizeZ)for(let T=0;T<64;T++){let N=this.sizeZ-m-1;for(let G=-64;G<0;G++)this.objTiles[T+L][N--]=E.g1()==1}else E.pos+=4096}}readNpcData(E){while(E.available>0){let L=E.g1()*64-this.originX,m=E.g1()*64-this.originZ;if(L>0&&m>0&&L+64<this.sizeX&&m+64<this.sizeZ)for(let T=0;T<64;T++){let N=this.sizeZ-m-1;for(let G=-64;G<0;G++)this.npcTiles[T+L][N--]=E.g1()==1}else E.pos+=4096}}convertHsl(E,L,m){let T=m,N=m,G=m;if(L!==0){let $;if(m<0.5)$=m*(L+1);else $=m+L-m*L;let R=m*2-$,J=E+0.3333333333333333;if(J>1)J--;let W=E-0.3333333333333333;if(W<0)W++;if(J*6<1)T=R+($-R)*6*J;else if(J*2<1)T=$;else if(J*3<2)T=R+($-R)*(0.6666666666666666-J)*6;else T=R;if(E*6<1)N=R+($-R)*6*E;else if(E*2<1)N=$;else if(E*3<2)N=R+($-R)*(0.6666666666666666-E)*6;else N=R;if(W*6<1)G=R+($-R)*6*W;else if(W*2<1)G=$;else if(W*3<2)G=R+($-R)*(0.6666666666666666-W)*6;else G=R}let _=T*256|0,Q=N*256|0,M=G*256|0;return(_<<16)+(Q<<8)+M}drawMap(E,L,m,T,N,G,_,Q){let M=m-E,$=T-L,R=(_-N<<16)/M|0,J=(Q-G<<16)/$|0;for(let I=0;I<M;I++){let q=R*I>>16,n=R*(I+1)>>16,Z=n-q;if(Z<=0)continue;q+=N,n+=N;for(let j=0;j<$;j++){let K=J*j>>16,z=J*(j+1)>>16,V=z-K;if(V<=0)continue;if(typeof this.overlayTiles[I+E]==="undefined")continue;K+=G,z+=G;let b=this.overlayTiles[I+E][j+L];if(b===0)H.fillRect2d(q,K,n-q,z-K,this.floormapColors[I+E][j+L]);else{let v=this.overlayInfo[I+E][j+L],U=v&252;if(U==0||Z<=1||V<=1)H.fillRect2d(q,K,Z,V,b);else this.drawSmoothEdges(H.pixels,K*H.width2d+q,this.floormapColors[I+E][j+L],b,Z,V,U>>2,v&3)}}}if(m-E>_-N)return;let W=0;for(let I=0;I<M;I++){let q=R*I>>16,n=R*(I+1)>>16,Z=n-q;if(Z<=0)continue;if(typeof this.locWalls[I+E]==="undefined")continue;q+=N,n+=N;for(let j=0;j<$;j++){let K=J*j>>16,z=J*(j+1)>>16,V=z-K;if(V<=0)continue;K+=G,z+=G;let b=this.locWalls[I+E][j+L]&255;if(b!=0){let O;if(Z==1)O=q;else O=n-1;let d;if(V==1)d=K;else d=z-1;let k=13421772;if(b>=5&&b<=8||b>=13&&b<=16||b>=21&&b<=24)k=13369344,b-=4;if(b==27||b==28)k=13369344,b-=2;if(b==1)H.drawVerticalLine(q,K,k,V);else if(b==2)H.drawHorizontalLine(q,K,k,Z);else if(b==3)H.drawVerticalLine(O,K,k,V);else if(b==4)H.drawHorizontalLine(q,d,k,Z);else if(b==9)H.drawVerticalLine(q,K,16777215,V),H.drawHorizontalLine(q,K,k,Z);else if(b==10)H.drawVerticalLine(O,K,16777215,V),H.drawHorizontalLine(q,K,k,Z);else if(b==11)H.drawVerticalLine(O,K,16777215,V),H.drawHorizontalLine(q,d,k,Z);else if(b==12)H.drawVerticalLine(q,K,16777215,V),H.drawHorizontalLine(q,d,k,Z);else if(b==17)H.drawHorizontalLine(q,K,k,1);else if(b==18)H.drawHorizontalLine(O,K,k,1);else if(b==19)H.drawHorizontalLine(O,d,k,1);else if(b==20)H.drawHorizontalLine(q,d,k,1);else if(b==25)for(let u=0;u<V;u++)H.drawHorizontalLine(q+u,d-u,k,1);else if(b==26)for(let u=0;u<V;u++)H.drawHorizontalLine(q+u,K+u,k,1)}let v=this.locMapscenes[I+E][j+L];if(v!=0)this.imageMapscene[v-1].clip(q-Z/2,K-V/2,Z*2,V*2);let U=this.locMapfunction[I+E][j+L];if(U!=0)this.visibleMapFunctions[W]=U-1,this.visibleMapFunctionsX[W]=q+Z/2,this.visibleMapFunctionsY[W]=K+V/2,W++}}for(let I=0;I<W;I++)this.imageMapfunction[this.visibleMapFunctions[I]].draw(this.visibleMapFunctionsX[I]-7,this.visibleMapFunctionsY[I]-7);if(y.shouldDrawItems)for(let I=0;I<M;I++){let q=R*I>>16,n=R*(I+1)>>16;if(n-q<=0)continue;if(typeof this.objTiles[I+E]==="undefined")continue;q+=N,n+=N;for(let j=0;j<$;j++){let K=J*j>>16,z=J*(j+1)>>16;if(z-K<=0)continue;if(K+=G,z+=G,this.objTiles[I+E][j+L])this.imageMapdot0?.draw(q,K)}}if(y.shouldDrawNpcs)for(let I=0;I<M;I++){let q=R*I>>16,n=R*(I+1)>>16;if(n-q<=0)continue;if(typeof this.npcTiles[I+E]==="undefined")continue;q+=N,n+=N;for(let j=0;j<$;j++){let K=J*j>>16,z=J*(j+1)>>16;if(z-K<=0)continue;if(K+=G,z+=G,this.npcTiles[I+E][j+L])this.imageMapdot1?.draw(q,K)}}if(this.flashTimer>0){for(let I=0;I<W;I++)if(this.visibleMapFunctions[I]==this.currentKey){if(this.imageMapfunction[this.visibleMapFunctions[I]].draw(this.visibleMapFunctionsX[I]-7,this.visibleMapFunctionsY[I]-7),this.flashTimer%10<5)H.fillCircle(this.visibleMapFunctionsX[I],this.visibleMapFunctionsY[I],15,16776960,128),H.fillCircle(this.visibleMapFunctionsX[I],this.visibleMapFunctionsY[I],7,16777215,256)}}if(this.zoom==this.targetZoom&&y.shouldDrawLabels)for(let I=0;I<this.labelCount;I++){let q=this.labelX[I],n=this.labelY[I];q-=this.originX,n=this.originZ+this.sizeZ-n;let Z=N+(_-N)*(q-E)/(m-E)|0,j=G+(Q-G)*(n-L)/(T-L)|0,K=this.labelFont[I],z=16777215,V=this.b12;if(K===2)z=16755200;if(V!==null){let b=this.labelText[I],v=1;for(let U=0;U<b.length;U++)if(b[U]==="/")v++;j-=V.height2d*(v-1)/2;while(!0){let U=b.indexOf("/");if(U===-1){V.drawStringCenter(Z+1,j+1,b,0),V.drawStringCenter(Z,j,b,z);break}let O=b.substring(0,U);V.drawStringCenter(Z+1,j+1,O,0),V.drawStringCenter(Z,j,O,z),j+=V.height2d,b=b.substring(U+1)}}}if(y.shouldDrawBorders)for(let I=this.originX/64;I<(this.originX+this.sizeX)/64;I++)for(let q=this.originZ/64;q<(this.originZ+this.sizeZ)/64;q++){let n=I*64,Z=q*64;n-=this.originX,Z=this.originZ+this.sizeZ-Z;let j=N+(_-N)*(n-E)/(m-E)|0,K=G+(Q-G)*(Z-64-L)/(T-L)|0,z=N+(_-N)*(n+64-E)/(m-E)|0,V=G+(Q-G)*(Z-L)/(T-L)|0;if(j>=_||K>=Q||z<=0||V<=0)continue;let b=16777215;if(this.activeTileX!==-1&&this.activeTileZ!==-1)b=16711680;if(H.drawRect(j,K,z-j,V-K,b),this.b12?.drawStringRight(z-5,V-5,I+"_"+q,b,!1),I==33&&q>=71&&q<=73)this.b12?.drawStringCenter((z+j)/2,(V+K)/2,"u_pass",16711680);else if(I>=32&&I<=34&&q>=70&&q<=74)this.b12?.drawStringCenter((z+j)/2,(V+K)/2,"u_pass",16776960)}}drawSmoothEdges(E,L,m,T,N,G,_,Q){let M=H.width2d-N;if(_==9)_=1,Q=Q+1&3;else if(_==10)_=1,Q=Q+3&3;else if(_==11)_=8,Q=Q+3&3;if(_==1){if(Q==0)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R<=$)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R<=$)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R>=$)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R>=$)E[L++]=T;else E[L++]=m;L+=M}}else if(_==2){if(Q==0)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R<=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R>=$<<1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=0;$<G;$++){for(let R=N-1;R>=0;R--)if(R<=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=G-1;$>=0;$--){for(let R=N-1;R>=0;R--)if(R>=$<<1)E[L++]=T;else E[L++]=m;L+=M}}else if(_==3){if(Q==0)for(let $=G-1;$>=0;$--){for(let R=N-1;R>=0;R--)if(R<=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R>=$<<1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R<=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=0;$<G;$++){for(let R=N-1;R>=0;R--)if(R>=$<<1)E[L++]=T;else E[L++]=m;L+=M}}else if(_==4){if(Q==0)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R>=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R<=$<<1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=0;$<G;$++){for(let R=N-1;R>=0;R--)if(R>=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=G-1;$>=0;$--){for(let R=N-1;R>=0;R--)if(R<=$<<1)E[L++]=T;else E[L++]=m;L+=M}}else if(_==5){if(Q==0)for(let $=G-1;$>=0;$--){for(let R=N-1;R>=0;R--)if(R>=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R<=$<<1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R>=$>>1)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=0;$<G;$++){for(let R=N-1;R>=0;R--)if(R<=$<<1)E[L++]=T;else E[L++]=m;L+=M}}else if(_==6){if(Q==0)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R<=N/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if($<=G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R>=N/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if($>=G/2)E[L++]=T;else E[L++]=m;L+=M}}else if(_==7){if(Q==0)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R<=$-G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R<=$-G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=G-1;$>=0;$--){for(let R=N-1;R>=0;R--)if(R<=$-G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=0;$<G;$++){for(let R=N-1;R>=0;R--)if(R<=$-G/2)E[L++]=T;else E[L++]=m;L+=M}}else if(_==8){if(Q==0)for(let $=0;$<G;$++){for(let R=0;R<N;R++)if(R>=$-G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==1)for(let $=G-1;$>=0;$--){for(let R=0;R<N;R++)if(R>=$-G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==2)for(let $=G-1;$>=0;$--){for(let R=N-1;R>=0;R--)if(R>=$-G/2)E[L++]=T;else E[L++]=m;L+=M}else if(Q==3)for(let $=0;$<G;$++){for(let R=N-1;R>=0;R--)if(R>=$-G/2)E[L++]=T;else E[L++]=m;L+=M}}}getTitleScreenState(){return-1}isChatBackInputOpen(){return!1}isShowSocialInput(){return!1}getChatInterfaceId(){return-1}getViewportInterfaceId(){return-1}getReportAbuseInterfaceId(){return-1}}export{y as MapView};

//# debugId=989BBF1789FCCFB064756E2164756E21
