var V5=Object.defineProperty;var f6=Object.getOwnPropertyNames;var C6=Object.getOwnPropertyDescriptor;var n6=Object.prototype.hasOwnProperty;var d5=new WeakMap;var I8=(_)=>{var R=d5.get(_),L;if(R)return R;R=V5({},"__esModule",{value:true});if(_&&typeof _==="object"||typeof _==="function")f6(_).map((G)=>!n6.call(R,G)&&V5(R,G,{get:()=>_[G],enumerable:!(L=C6(_,G))||L.enumerable}));d5.set(_,R);return R};var t5=(_,R)=>{for(var L in R)V5(_,L,{get:R[L],enumerable:true,configurable:true,set:(G)=>R[L]=()=>G})};var o5=(_,R)=>()=>(_&&(R=_(_=0)),R);var E8=((_)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(_,{get:(R,L)=>(typeof require!=="undefined"?require:R)[L]}):_)(function(_){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+_+'" is not supported')});var Z5={};t5(Z5,{win32:()=>Y5,toNamespacedPath:()=>G_,sep:()=>O_,resolve:()=>l6,relative:()=>L_,posix:()=>E1,parse:()=>J_,normalize:()=>e6,join:()=>R_,isAbsolute:()=>__,format:()=>$_,extname:()=>H_,dirname:()=>K_,delimiter:()=>q_,default:()=>o6,basename:()=>Q_});var s6,e5,p6,y6,r6,x6,i6=(_,R)=>()=>(R||_((R={exports:{}}).exports,R),R.exports),a6=(_,R,L,G)=>{if(R&&typeof R=="object"||typeof R=="function")for(let K of y6(R))!x6.call(_,K)&&K!==L&&e5(_,K,{get:()=>R[K],enumerable:!(G=p6(R,K))||G.enumerable});return _},c6=(_,R,L)=>(L=_!=null?s6(r6(_)):{},a6(R||!_||!_.__esModule?e5(L,"default",{value:_,enumerable:true}):L,_)),d6,_6,v0,t6,l5=function(_){return _},R6=function(){throw new Error("Not implemented")},E1,Y5,o6,l6,e6,__,R_,L_,G_,K_,Q_,H_,$_,J_,O_,q_;var u5=o5(()=>{s6=Object.create;e5=Object.defineProperty;p6=Object.getOwnPropertyDescriptor;y6=Object.getOwnPropertyNames;r6=Object.getPrototypeOf;x6=Object.prototype.hasOwnProperty;d6=i6((_,R)=>{function L(H){if(typeof H!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(H))}function G(H,$){for(var J="",O=0,q=-1,N=0,U,b=0;b<=H.length;++b){if(b<H.length)U=H.charCodeAt(b);else{if(U===47)break;U=47}if(U===47){if(!(q===b-1||N===1))if(q!==b-1&&N===2){if(J.length<2||O!==2||J.charCodeAt(J.length-1)!==46||J.charCodeAt(J.length-2)!==46){if(J.length>2){var I=J.lastIndexOf("/");if(I!==J.length-1){I===-1?(J="",O=0):(J=J.slice(0,I),O=J.length-1-J.lastIndexOf("/")),q=b,N=0;continue}}else if(J.length===2||J.length===1){J="",O=0,q=b,N=0;continue}}$&&(J.length>0?J+="/..":J="..",O=2)}else J.length>0?J+="/"+H.slice(q+1,b):J=H.slice(q+1,b),O=b-q-1;q=b,N=0}else U===46&&N!==-1?++N:N=-1}return J}function K(H,$){var J=$.dir||$.root,O=$.base||($.name||"")+($.ext||"");return J?J===$.root?J+O:J+H+O:O}var Q={resolve:function(){for(var H="",$=false,J,O=arguments.length-1;O>=-1&&!$;O--){var q;O>=0?q=arguments[O]:(J===undefined&&(J=process.cwd()),q=J),L(q),q.length!==0&&(H=q+"/"+H,$=q.charCodeAt(0)===47)}return H=G(H,!$),$?H.length>0?"/"+H:"/":H.length>0?H:"."},normalize:function(H){if(L(H),H.length===0)return".";var $=H.charCodeAt(0)===47,J=H.charCodeAt(H.length-1)===47;return H=G(H,!$),H.length===0&&!$&&(H="."),H.length>0&&J&&(H+="/"),$?"/"+H:H},isAbsolute:function(H){return L(H),H.length>0&&H.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var H,$=0;$<arguments.length;++$){var J=arguments[$];L(J),J.length>0&&(H===undefined?H=J:H+="/"+J)}return H===undefined?".":Q.normalize(H)},relative:function(H,$){if(L(H),L($),H===$||(H=Q.resolve(H),$=Q.resolve($),H===$))return"";for(var J=1;J<H.length&&H.charCodeAt(J)===47;++J);for(var O=H.length,q=O-J,N=1;N<$.length&&$.charCodeAt(N)===47;++N);for(var U=$.length,b=U-N,I=q<b?q:b,j=-1,F=0;F<=I;++F){if(F===I){if(b>I){if($.charCodeAt(N+F)===47)return $.slice(N+F+1);if(F===0)return $.slice(N+F)}else q>I&&(H.charCodeAt(J+F)===47?j=F:F===0&&(j=0));break}var T=H.charCodeAt(J+F),Y=$.charCodeAt(N+F);if(T!==Y)break;T===47&&(j=F)}var u="";for(F=J+j+1;F<=O;++F)(F===O||H.charCodeAt(F)===47)&&(u.length===0?u+="..":u+="/..");return u.length>0?u+$.slice(N+j):(N+=j,$.charCodeAt(N)===47&&++N,$.slice(N))},_makeLong:function(H){return H},dirname:function(H){if(L(H),H.length===0)return".";for(var $=H.charCodeAt(0),J=$===47,O=-1,q=true,N=H.length-1;N>=1;--N)if($=H.charCodeAt(N),$===47){if(!q){O=N;break}}else q=false;return O===-1?J?"/":".":J&&O===1?"//":H.slice(0,O)},basename:function(H,$){if($!==undefined&&typeof $!="string")throw new TypeError('"ext" argument must be a string');L(H);var J=0,O=-1,q=true,N;if($!==undefined&&$.length>0&&$.length<=H.length){if($.length===H.length&&$===H)return"";var U=$.length-1,b=-1;for(N=H.length-1;N>=0;--N){var I=H.charCodeAt(N);if(I===47){if(!q){J=N+1;break}}else b===-1&&(q=false,b=N+1),U>=0&&(I===$.charCodeAt(U)?--U===-1&&(O=N):(U=-1,O=b))}return J===O?O=b:O===-1&&(O=H.length),H.slice(J,O)}else{for(N=H.length-1;N>=0;--N)if(H.charCodeAt(N)===47){if(!q){J=N+1;break}}else O===-1&&(q=false,O=N+1);return O===-1?"":H.slice(J,O)}},extname:function(H){L(H);for(var $=-1,J=0,O=-1,q=true,N=0,U=H.length-1;U>=0;--U){var b=H.charCodeAt(U);if(b===47){if(!q){J=U+1;break}continue}O===-1&&(q=false,O=U+1),b===46?$===-1?$=U:N!==1&&(N=1):$!==-1&&(N=-1)}return $===-1||O===-1||N===0||N===1&&$===O-1&&$===J+1?"":H.slice($,O)},format:function(H){if(H===null||typeof H!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof H);return K("/",H)},parse:function(H){L(H);var $={root:"",dir:"",base:"",ext:"",name:""};if(H.length===0)return $;var J=H.charCodeAt(0),O=J===47,q;O?($.root="/",q=1):q=0;for(var N=-1,U=0,b=-1,I=true,j=H.length-1,F=0;j>=q;--j){if(J=H.charCodeAt(j),J===47){if(!I){U=j+1;break}continue}b===-1&&(I=false,b=j+1),J===46?N===-1?N=j:F!==1&&(F=1):N!==-1&&(F=-1)}return N===-1||b===-1||F===0||F===1&&N===b-1&&N===U+1?b!==-1&&(U===0&&O?$.base=$.name=H.slice(1,b):$.base=$.name=H.slice(U,b)):(U===0&&O?($.name=H.slice(1,N),$.base=H.slice(1,b)):($.name=H.slice(U,N),$.base=H.slice(U,b)),$.ext=H.slice(N,b)),U>0?$.dir=H.slice(0,U-1):O&&($.dir="/"),$},sep:"/",delimiter:":",win32:null,posix:null};Q.posix=Q;R.exports=Q});_6=c6(d6());v0=_6;t6=_6;v0.parse??=R6;t6.parse??=R6;E1={resolve:v0.resolve.bind(v0),normalize:v0.normalize.bind(v0),isAbsolute:v0.isAbsolute.bind(v0),join:v0.join.bind(v0),relative:v0.relative.bind(v0),toNamespacedPath:l5,dirname:v0.dirname.bind(v0),basename:v0.basename.bind(v0),extname:v0.extname.bind(v0),format:v0.format.bind(v0),parse:v0.parse.bind(v0),sep:"/",delimiter:":",win32:undefined,posix:undefined,_makeLong:l5};Y5={sep:"\\",delimiter:";",win32:undefined,...E1,posix:E1};E1.win32=Y5.win32=Y5;E1.posix=E1;o6=E1;({resolve:l6,normalize:e6,isAbsolute:__,join:R_,relative:L_,toNamespacedPath:G_,dirname:K_,basename:Q_,extname:H_,format:$_,parse:J_,sep:O_,delimiter:q_}=E1)});var h5={};t5(h5,{resolveObject:()=>O6,resolve:()=>J6,parse:()=>z1,format:()=>$6,default:()=>V_,Url:()=>e0,URLSearchParams:()=>Q6,URL:()=>A5});function B5(_){return typeof _=="string"}function H6(_){return typeof _=="object"&&_!==null}function F8(_){return _===null}function N_(_){return _==null}function e0(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function z1(_,R,L){if(_&&H6(_)&&_ instanceof e0)return _;var G=new e0;return G.parse(_,R,L),G}function $6(_){return B5(_)&&(_=z1(_)),_ instanceof e0?_.format():e0.prototype.format.call(_)}function J6(_,R){return z1(_,false,true).resolve(R)}function O6(_,R){return _?z1(_,false,true).resolveObject(R):R}var A5,Q6,b_,U_,I_,E_,F_,w5,L6,G6,T_=255,K6,j_,k_,X5,P1,W5,V_;var m5=o5(()=>{({URL:A5,URLSearchParams:Q6}=globalThis);b_=/^([a-z0-9.+-]+:)/i;U_=/:[0-9]*$/;I_=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/;E_=["<",">",'"',"`"," ","\r",`
`,"\t"];F_=["{","}","|","\\","^","`"].concat(E_);w5=["'"].concat(F_);L6=["%","/","?",";","#"].concat(w5);G6=["/","?","#"];K6=/^[+a-z0-9A-Z_-]{0,63}$/;j_=/^([+a-z0-9A-Z_-]{0,63})(.*)$/;k_={javascript:true,"javascript:":true};X5={javascript:true,"javascript:":true};P1={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true};W5={parse(_){var R=decodeURIComponent;return(_+"").replace(/\+/g," ").split("&").filter(Boolean).reduce(function(L,G,K){var Q=G.split("="),H=R(Q[0]||""),$=R(Q[1]||""),J=L[H];return L[H]=J===undefined?$:[].concat(J,$),L},{})},stringify(_){var R=encodeURIComponent;return Object.keys(_||{}).reduce(function(L,G){return[].concat(_[G]).forEach(function(K){L.push(R(G)+"="+R(K))}),L},[]).join("&").replace(/\s/g,"+")}};e0.prototype.parse=function(_,R,L){if(!B5(_))throw new TypeError("Parameter 'url' must be a string, not "+typeof _);var G=_.indexOf("?"),K=G!==-1&&G<_.indexOf("#")?"?":"#",Q=_.split(K),H=/\\/g;Q[0]=Q[0].replace(H,"/"),_=Q.join(K);var $=_;if($=$.trim(),!L&&_.split("#").length===1){var J=I_.exec($);if(J)return this.path=$,this.href=$,this.pathname=J[1],J[2]?(this.search=J[2],R?this.query=W5.parse(this.search.substr(1)):this.query=this.search.substr(1)):R&&(this.search="",this.query={}),this}var O=b_.exec($);if(O){O=O[0];var q=O.toLowerCase();this.protocol=q,$=$.substr(O.length)}if(L||O||$.match(/^\/\/[^@\/]+@[^@\/]+/)){var N=$.substr(0,2)==="//";N&&!(O&&X5[O])&&($=$.substr(2),this.slashes=true)}if(!X5[O]&&(N||O&&!P1[O])){for(var U=-1,b=0;b<G6.length;b++){var I=$.indexOf(G6[b]);I!==-1&&(U===-1||I<U)&&(U=I)}var j,F;U===-1?F=$.lastIndexOf("@"):F=$.lastIndexOf("@",U),F!==-1&&(j=$.slice(0,F),$=$.slice(F+1),this.auth=decodeURIComponent(j)),U=-1;for(var b=0;b<L6.length;b++){var I=$.indexOf(L6[b]);I!==-1&&(U===-1||I<U)&&(U=I)}U===-1&&(U=$.length),this.host=$.slice(0,U),$=$.slice(U),this.parseHost(),this.hostname=this.hostname||"";var T=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!T)for(var Y=this.hostname.split(/\./),b=0,u=Y.length;b<u;b++){var w=Y[b];if(!!w&&!w.match(K6)){for(var h="",v=0,n=w.length;v<n;v++)w.charCodeAt(v)>127?h+="x":h+=w[v];if(!h.match(K6)){var A=Y.slice(0,b),P=Y.slice(b+1),z=w.match(j_);z&&(A.push(z[1]),P.unshift(z[2])),P.length&&($="/"+P.join(".")+$),this.hostname=A.join(".");break}}}this.hostname.length>T_?this.hostname="":this.hostname=this.hostname.toLowerCase(),T||(this.hostname=new A5(`https://${this.hostname}`).hostname);var f=this.port?":"+this.port:"",m=this.hostname||"";this.host=m+f,this.href+=this.host,T&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),$[0]!=="/"&&($="/"+$))}if(!k_[q])for(var b=0,u=w5.length;b<u;b++){var M=w5[b];if($.indexOf(M)!==-1){var r=encodeURIComponent(M);r===M&&(r=escape(M)),$=$.split(M).join(r)}}var a=$.indexOf("#");a!==-1&&(this.hash=$.substr(a),$=$.slice(0,a));var C=$.indexOf("?");if(C!==-1?(this.search=$.substr(C),this.query=$.substr(C+1),R&&(this.query=W5.parse(this.query)),$=$.slice(0,C)):R&&(this.search="",this.query={}),$&&(this.pathname=$),P1[q]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var f=this.pathname||"",R0=this.search||"";this.path=f+R0}return this.href=this.format(),this};e0.prototype.format=function(){var _=this.auth||"";_&&(_=encodeURIComponent(_),_=_.replace(/%3A/i,":"),_+="@");var R=this.protocol||"",L=this.pathname||"",G=this.hash||"",K=false,Q="";this.host?K=_+this.host:this.hostname&&(K=_+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(K+=":"+this.port)),this.query&&H6(this.query)&&Object.keys(this.query).length&&(Q=W5.stringify(this.query));var H=this.search||Q&&"?"+Q||"";return R&&R.substr(-1)!==":"&&(R+=":"),this.slashes||(!R||P1[R])&&K!==false?(K="//"+(K||""),L&&L.charAt(0)!=="/"&&(L="/"+L)):K||(K=""),G&&G.charAt(0)!=="#"&&(G="#"+G),H&&H.charAt(0)!=="?"&&(H="?"+H),L=L.replace(/[?#]/g,function($){return encodeURIComponent($)}),H=H.replace("#","%23"),R+K+L+H+G};e0.prototype.resolve=function(_){return this.resolveObject(z1(_,false,true)).format()};e0.prototype.resolveObject=function(_){if(B5(_)){var R=new e0;R.parse(_,false,true),_=R}for(var L=new e0,G=Object.keys(this),K=0;K<G.length;K++){var Q=G[K];L[Q]=this[Q]}if(L.hash=_.hash,_.href==="")return L.href=L.format(),L;if(_.slashes&&!_.protocol){for(var H=Object.keys(_),$=0;$<H.length;$++){var J=H[$];J!=="protocol"&&(L[J]=_[J])}return P1[L.protocol]&&L.hostname&&!L.pathname&&(L.path=L.pathname="/"),L.href=L.format(),L}if(_.protocol&&_.protocol!==L.protocol){if(!P1[_.protocol]){for(var O=Object.keys(_),q=0;q<O.length;q++){var N=O[q];L[N]=_[N]}return L.href=L.format(),L}if(L.protocol=_.protocol,!_.host&&!X5[_.protocol]){for(var u=(_.pathname||"").split("/");u.length&&!(_.host=u.shift()););_.host||(_.host=""),_.hostname||(_.hostname=""),u[0]!==""&&u.unshift(""),u.length<2&&u.unshift(""),L.pathname=u.join("/")}else L.pathname=_.pathname;if(L.search=_.search,L.query=_.query,L.host=_.host||"",L.auth=_.auth,L.hostname=_.hostname||_.host,L.port=_.port,L.pathname||L.search){var U=L.pathname||"",b=L.search||"";L.path=U+b}return L.slashes=L.slashes||_.slashes,L.href=L.format(),L}var I=L.pathname&&L.pathname.charAt(0)==="/",j=_.host||_.pathname&&_.pathname.charAt(0)==="/",F=j||I||L.host&&_.pathname,T=F,Y=L.pathname&&L.pathname.split("/")||[],u=_.pathname&&_.pathname.split("/")||[],w=L.protocol&&!P1[L.protocol];if(w&&(L.hostname="",L.port=null,L.host&&(Y[0]===""?Y[0]=L.host:Y.unshift(L.host)),L.host="",_.protocol&&(_.hostname=null,_.port=null,_.host&&(u[0]===""?u[0]=_.host:u.unshift(_.host)),_.host=null),F=F&&(u[0]===""||Y[0]==="")),j)L.host=_.host||_.host===""?_.host:L.host,L.hostname=_.hostname||_.hostname===""?_.hostname:L.hostname,L.search=_.search,L.query=_.query,Y=u;else if(u.length)Y||(Y=[]),Y.pop(),Y=Y.concat(u),L.search=_.search,L.query=_.query;else if(!N_(_.search)){if(w){L.hostname=L.host=Y.shift();var h=L.host&&L.host.indexOf("@")>0?L.host.split("@"):false;h&&(L.auth=h.shift(),L.host=L.hostname=h.shift())}return L.search=_.search,L.query=_.query,(!F8(L.pathname)||!F8(L.search))&&(L.path=(L.pathname?L.pathname:"")+(L.search?L.search:"")),L.href=L.format(),L}if(!Y.length)return L.pathname=null,L.search?L.path="/"+L.search:L.path=null,L.href=L.format(),L;for(var v=Y.slice(-1)[0],n=(L.host||_.host||Y.length>1)&&(v==="."||v==="..")||v==="",A=0,P=Y.length;P>=0;P--)v=Y[P],v==="."?Y.splice(P,1):v===".."?(Y.splice(P,1),A++):A&&(Y.splice(P,1),A--);if(!F&&!T)for(;A--;A)Y.unshift("..");F&&Y[0]!==""&&(!Y[0]||Y[0].charAt(0)!=="/")&&Y.unshift(""),n&&Y.join("/").substr(-1)!=="/"&&Y.push("");var z=Y[0]===""||Y[0]&&Y[0].charAt(0)==="/";if(w){L.hostname=L.host=z?"":Y.length?Y.shift():"";var h=L.host&&L.host.indexOf("@")>0?L.host.split("@"):false;h&&(L.auth=h.shift(),L.host=L.hostname=h.shift())}return F=F||L.host&&Y.length,F&&!z&&Y.unshift(""),Y.length?L.pathname=Y.join("/"):(L.pathname=null,L.path=null),(!F8(L.pathname)||!F8(L.search))&&(L.path=(L.pathname?L.pathname:"")+(L.search?L.search:"")),L.auth=_.auth||L.auth,L.slashes=L.slashes||_.slashes,L.href=L.format(),L};e0.prototype.parseHost=function(){var _=this.host,R=U_.exec(_);R&&(R=R[0],R!==":"&&(this.port=R.substr(1)),_=_.substr(0,_.length-R.length)),_&&(this.hostname=_)};V_={parse:z1,resolve:J6,resolveObject:O6,format:$6,Url:e0,URL:A5,URLSearchParams:Q6}});var S5=(()=>{var _=import.meta.url;return async function(R={}){var L;var G=R;var K,Q;var H=new Promise((Z,D)=>{K=Z;Q=D});var $=typeof window=="object";var J=typeof WorkerGlobalScope!="undefined";var O=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";var q=!$&&!O&&!J;var N=Object.assign({},G);var U=[];var b="./this.program";var I=(Z,D)=>{throw D};var j="";function F(Z){if(G["locateFile"]){return G["locateFile"](Z,j)}return j+Z}var T,Y;if(O){if(typeof process=="undefined"||!process.release||process.release.name!=="node")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");var u=process.versions.node;var w=u.split(".").slice(0,3);w=w[0]*1e4+w[1]*100+w[2].split("-")[0]*1;var h=160000;if(w<160000){throw new Error("This emscripten-generated code requires node v16.0.0 (detected v"+u+")")}var v=(()=>({}));var n=(u5(),I8(Z5));if(!import.meta.url.startsWith("data:")){j=n.dirname((m5(),I8(h5)).fileURLToPath(import.meta.url))+"/"}Y=(Z)=>{Z=Q1(Z)?new URL(Z):Z;var D=v.readFileSync(Z);i(Buffer.isBuffer(D));return D};T=async(Z,D=true)=>{Z=Q1(Z)?new URL(Z):Z;var o=v.readFileSync(Z,D?undefined:"utf8");i(D?Buffer.isBuffer(o):typeof o=="string");return o};if(!G["thisProgram"]&&process.argv.length>1){b=process.argv[1].replace(/\\/g,"/")}U=process.argv.slice(2);I=(Z,D)=>{process.exitCode=Z;throw D}}else if(q){if(typeof process=="object"&&true||typeof window=="object"||typeof WorkerGlobalScope!="undefined")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)")}else if($||J){if(J){j=self.location.href}else if(typeof document!="undefined"&&document.currentScript){j=document.currentScript.src}if(_){j=_}if(j.startsWith("blob:")){j=""}else{j=j.substr(0,j.replace(/[?#].*/,"").lastIndexOf("/")+1)}if(!(typeof window=="object"||typeof WorkerGlobalScope!="undefined"))throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");{if(J){Y=(Z)=>{var D=new XMLHttpRequest;D.open("GET",Z,false);D.responseType="arraybuffer";D.send(null);return new Uint8Array(D.response)}}T=async(Z)=>{if(Q1(Z)){return new Promise((o,K0)=>{var O0=new XMLHttpRequest;O0.open("GET",Z,true);O0.responseType="arraybuffer";O0.onload=()=>{if(O0.status==200||O0.status==0&&O0.response){o(O0.response);return}K0(O0.status)};O0.onerror=K0;O0.send(null)})}var D=await fetch(Z,{credentials:"same-origin"});if(D.ok){return D.arrayBuffer()}throw new Error(D.status+" : "+D.url)}}}else{throw new Error("environment detection error")}var A=G["print"]||undefined;var P=G["printErr"]||undefined;Object.assign(G,N);N=null;E5();if(G["arguments"])U=G["arguments"];a0("arguments","arguments_");if(G["thisProgram"])b=G["thisProgram"];a0("thisProgram","thisProgram");i(typeof G["memoryInitializerPrefixURL"]=="undefined","Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead");i(typeof G["pthreadMainPrefixURL"]=="undefined","Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead");i(typeof G["cdInitializerPrefixURL"]=="undefined","Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead");i(typeof G["filePackagePrefixURL"]=="undefined","Module.filePackagePrefixURL option was removed, use Module.locateFile instead");i(typeof G["read"]=="undefined","Module.read option was removed");i(typeof G["readAsync"]=="undefined","Module.readAsync option was removed (modify readAsync in JS)");i(typeof G["readBinary"]=="undefined","Module.readBinary option was removed (modify readBinary in JS)");i(typeof G["setWindowTitle"]=="undefined","Module.setWindowTitle option was removed (modify emscripten_set_window_title in JS)");i(typeof G["TOTAL_MEMORY"]=="undefined","Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY");a0("asm","wasmExports");a0("readAsync","readAsync");a0("readBinary","readBinary");a0("setWindowTitle","setWindowTitle");var z="IDBFS is no longer included by default; build with -lidbfs.js";var f="PROXYFS is no longer included by default; build with -lproxyfs.js";var m="WORKERFS is no longer included by default; build with -lworkerfs.js";var M="FETCHFS is no longer included by default; build with -lfetchfs.js";var r="ICASEFS is no longer included by default; build with -licasefs.js";var a="JSFILEFS is no longer included by default; build with -ljsfilefs.js";var C="OPFS is no longer included by default; build with -lopfs.js";var R0="NODEFS is no longer included by default; build with -lnodefs.js";i(!q,"shell environment detected but not enabled at build time.  Add `shell` to `-sENVIRONMENT` to enable.");var e=G["wasmBinary"];a0("wasmBinary","wasmBinary");if(typeof WebAssembly!="object"){P("no native wasm support detected")}var L0;var J0=false;var Q0;function i(Z,D){if(!Z){m0("Assertion failed"+(D?": "+D:""))}}var k0,$0,F0,T0,L1,N1,P0,V1,Y1,g8,Z1;var u1=false;var f8="data:application/octet-stream;base64,";var f1=(Z)=>Z.startsWith(f8);var Q1=(Z)=>Z.startsWith("file://");function C8(){var Z=N8();i((Z&3)==0);if(Z==0){Z+=4}P0[Z>>2]=34821223;P0[Z+4>>2]=2310721022;P0[0>>2]=1668509029}function w1(){if(J0)return;var Z=N8();if(Z==0){Z+=4}var D=P0[Z>>2];var o=P0[Z+4>>2];if(D!=34821223||o!=2310721022){m0(`Stack overflow! Stack cookie has been overwritten at ${b1(Z)}, expected hex dwords 0x89BACDFE and 0x2135467, but received ${b1(o)} ${b1(D)}`)}if(P0[0>>2]!=1668509029){m0("Runtime error: The application has corrupted its heap memory area (address zero)!")}}(()=>{var Z=new Int16Array(1);var D=new Int8Array(Z.buffer);Z[0]=25459;if(D[0]!==115||D[1]!==99)throw"Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)"})();if(G["ENVIRONMENT"]){throw new Error("Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)")}function a0(Z,D,o=true){if(!Object.getOwnPropertyDescriptor(G,Z)){Object.defineProperty(G,Z,{configurable:true,get(){let K0=o?" (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)":"";m0(`\`Module.${Z}\` has been replaced by \`${D}\``+K0)}})}}function n8(Z){if(Object.getOwnPropertyDescriptor(G,Z)){m0(`\`Module.${Z}\` was supplied but \`${Z}\` not included in INCOMING_MODULE_JS_API`)}}function C1(Z){return Z==="FS_createPath"||Z==="FS_createDataFile"||Z==="FS_createPreloadedFile"||Z==="FS_unlink"||Z==="addRunDependency"||Z==="FS_createLazyFile"||Z==="FS_createDevice"||Z==="removeRunDependency"}function n1(Z,D){if(typeof globalThis!="undefined"&&!Object.getOwnPropertyDescriptor(globalThis,Z)){Object.defineProperty(globalThis,Z,{configurable:true,get(){D();return}})}}function s1(Z,D){n1(Z,()=>{C0(`\`${Z}\` is not longer defined by emscripten. ${D}`)})}s1("buffer","Please use HEAP8.buffer or wasmMemory.buffer");s1("asm","Please use wasmExports instead");function s8(Z){n1(Z,()=>{var D=`\`${Z}\` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line`;var o=Z;if(!o.startsWith("_")){o="$"+Z}D+=` (e.g. -sDEFAULT_LIBRARY_FUNCS_TO_INCLUDE='${o}')`;if(C1(Z)){D+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"}C0(D)});p1(Z)}function p1(Z){if(!Object.getOwnPropertyDescriptor(G,Z)){Object.defineProperty(G,Z,{configurable:true,get(){var D=`'${Z}' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the Emscripten FAQ)`;if(C1(Z)){D+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"}m0(D)}})}}function W6(...Z){}function y1(){var Z=L0.buffer;G["HEAP8"]=$0=new Int8Array(Z);G["HEAP16"]=T0=new Int16Array(Z);G["HEAPU8"]=F0=new Uint8Array(Z);G["HEAPU16"]=L1=new Uint16Array(Z);G["HEAP32"]=N1=new Int32Array(Z);G["HEAPU32"]=P0=new Uint32Array(Z);G["HEAPF32"]=V1=new Float32Array(Z);G["HEAPF64"]=Z1=new Float64Array(Z);G["HEAP64"]=Y1=new BigInt64Array(Z);G["HEAPU64"]=g8=new BigUint64Array(Z)}i(!G["STACK_SIZE"],"STACK_SIZE can no longer be set at runtime.  Use -sSTACK_SIZE at link time");i(typeof Int32Array!="undefined"&&typeof Float64Array!=="undefined"&&Int32Array.prototype.subarray!=null&&Int32Array.prototype.set!=null,"JS engine does not provide full typed array support");i(!G["wasmMemory"],"Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally");i(!G["INITIAL_MEMORY"],"Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically");var r1=[];var x1=[];var A6=[];var i1=[];function p8(){if(G["preRun"]){if(typeof G["preRun"]=="function")G["preRun"]=[G["preRun"]];while(G["preRun"].length){x8(G["preRun"].shift())}}X1(r1)}function y8(){i(!u1);u1=true;w1();X1(x1)}function r8(){w1();if(G["postRun"]){if(typeof G["postRun"]=="function")G["postRun"]=[G["postRun"]];while(G["postRun"].length){a8(G["postRun"].shift())}}X1(i1)}function x8(Z){r1.unshift(Z)}function i8(Z){x1.unshift(Z)}function B6(Z){}function a8(Z){i1.unshift(Z)}var c0=0;var H1=null;var o0={};var d0=null;function h6(Z){var D=Z;while(true){if(!o0[Z])return Z;Z=D+Math.random()}}function c8(Z){c0++;G["monitorRunDependencies"]?.(c0);if(Z){i(!o0[Z]);o0[Z]=1;if(d0===null&&typeof setInterval!="undefined"){d0=setInterval(()=>{if(J0){clearInterval(d0);d0=null;return}var D=false;for(var o in o0){if(!D){D=true;P("still waiting on run dependencies:")}P(`dependency: ${o}`)}if(D){P("(end of list)")}},1e4)}}else{P("warning: run dependency added without ID")}}function d8(Z){c0--;G["monitorRunDependencies"]?.(c0);if(Z){i(o0[Z]);delete o0[Z]}else{P("warning: run dependency removed without ID")}if(c0==0){if(d0!==null){clearInterval(d0);d0=null}if(H1){var D=H1;H1=null;D()}}}function m0(Z){G["onAbort"]?.(Z);Z="Aborted("+Z+")";P(Z);J0=true;var D=new WebAssembly.RuntimeError(Z);Q(D);throw D}var z0={error(){m0("Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM")},init(){z0.error()},createDataFile(){z0.error()},createPreloadedFile(){z0.error()},createLazyFile(){z0.error()},open(){z0.error()},mkdev(){z0.error()},registerDevice(){z0.error()},analyzePath(){z0.error()},ErrnoError(){z0.error()}};G["FS_createDataFile"]=z0.createDataFile;G["FS_createPreloadedFile"]=z0.createPreloadedFile;function M0(Z,D){return(...o)=>{i(u1,`native function \`${Z}\` called before runtime initialization`);var K0=r0[Z];i(K0,`exported native function \`${Z}\` not found`);i(o.length<=D,`native function \`${Z}\` called with ${o.length} args but expects ${D}`);return K0(...o)}}var $1;function t8(){if(G["locateFile"]){var Z="tinymidipcm.wasm";if(!f1(Z)){return F(Z)}return Z}return new URL("tinymidipcm.wasm",import.meta.url).href}function o8(Z){if(Z==$1&&e){return new Uint8Array(e)}if(Y){return Y(Z)}throw"both async and sync fetching of the wasm failed"}async function l8(Z){if(!e){try{var D=await T(Z);return new Uint8Array(D)}catch{}}return o8(Z)}async function e8(Z,D){try{var o=await l8(Z);var K0=await WebAssembly.instantiate(o,D);return K0}catch(O0){P(`failed to asynchronously prepare wasm: ${O0}`);if(Q1($1)){P(`warning: Loading from a file URI (${$1}) is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing`)}m0(O0)}}async function _5(Z,D,o){if(!Z&&typeof WebAssembly.instantiateStreaming=="function"&&!f1(D)&&!Q1(D)&&!O){try{var K0=fetch(D,{credentials:"same-origin"});var O0=await WebAssembly.instantiateStreaming(K0,o);return O0}catch(N0){P(`wasm streaming compile failed: ${N0}`);P("falling back to ArrayBuffer instantiation")}}return e8(D,o)}function R5(){return{env:S1,wasi_snapshot_preview1:S1}}async function L5(){function Z(j0,t0){r0=j0.exports;L0=r0["memory"];i(L0,"memory not found in wasm exports");y1();i8(r0["__wasm_call_ctors"]);d8("wasm-instantiate");return r0}c8("wasm-instantiate");var D=G;function o(j0){i(G===D,"the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?");D=null;return Z(j0["instance"])}var K0=R5();if(G["instantiateWasm"]){try{return G["instantiateWasm"](K0,Z)}catch(j0){P(`Module.instantiateWasm callback failed with error: ${j0}`);Q(j0)}}$1??=t8();try{var O0=await _5(e,$1,K0);var N0=o(O0);return N0}catch(j0){Q(j0);return Promise.reject(j0)}}class J8{name="ExitStatus";constructor(Z){this.message=`Program terminated with exit(${Z})`;this.status=Z}}var X1=(Z)=>{while(Z.length>0){Z.shift()(G)}};function G5(Z,D="i8"){if(D.endsWith("*"))D="*";switch(D){case"i1":return $0[Z];case"i8":return $0[Z];case"i16":return T0[Z>>1];case"i32":return N1[Z>>2];case"i64":return Y1[Z>>3];case"float":return V1[Z>>2];case"double":return Z1[Z>>3];case"*":return P0[Z>>2];default:m0(`invalid type for getValue: ${D}`)}}var v5=G["noExitRuntime"]||true;var b1=(Z)=>{i(typeof Z==="number");Z>>>=0;return"0x"+Z.toString(16).padStart(8,"0")};function K5(Z,D,o="i8"){if(o.endsWith("*"))o="*";switch(o){case"i1":$0[Z]=D;break;case"i8":$0[Z]=D;break;case"i16":T0[Z>>1]=D;break;case"i32":N1[Z>>2]=D;break;case"i64":Y1[Z>>3]=BigInt(D);break;case"float":V1[Z>>2]=D;break;case"double":Z1[Z>>3]=D;break;case"*":P0[Z>>2]=D;break;default:m0(`invalid type for setValue: ${o}`)}}var m6=(Z)=>i5(Z);var S6=()=>j5();var C0=(Z)=>{C0.shown||={};if(!C0.shown[Z]){C0.shown[Z]=1;if(O)Z="warning: "+Z;P(Z)}};var Q5=()=>m0("native code called abort()");var H5=()=>2147483648;var $5=(Z,D)=>{i(D,"alignment argument is required");return Math.ceil(Z/D)*D};var J5=(Z)=>{var D=L0.buffer;var o=(Z-D.byteLength+65535)/65536|0;try{L0.grow(o);y1();return 1}catch(K0){P(`growMemory: Attempted to grow heap from ${D.byteLength} bytes to ${Z} bytes, but got error: ${K0}`)}};var O5=(Z)=>{var D=F0.length;Z>>>=0;i(Z>D);var o=H5();if(Z>o){P(`Cannot enlarge memory, requested ${Z} bytes, but the limit is ${o} bytes!`);return false}for(var K0=1;K0<=4;K0*=2){var O0=D*(1+0.2/K0);O0=Math.min(O0,Z+100663296);var N0=Math.min(o,$5(Math.max(Z,O0),65536));var j0=J5(N0);if(j0){return true}}P(`Failed to grow the heap from ${D} bytes to ${N0} bytes, not enough memory!`);return false};var a1=typeof TextDecoder!="undefined"?new TextDecoder:undefined;var c1=(Z,D=0,o=NaN)=>{var K0=D+o;var O0=D;while(Z[O0]&&!(O0>=K0))++O0;if(O0-D>16&&Z.buffer&&a1){return a1.decode(Z.subarray(D,O0))}var N0="";while(D<O0){var j0=Z[D++];if(!(j0&128)){N0+=String.fromCharCode(j0);continue}var t0=Z[D++]&63;if((j0&224)==192){N0+=String.fromCharCode((j0&31)<<6|t0);continue}var U1=Z[D++]&63;if((j0&240)==224){j0=(j0&15)<<12|t0<<6|U1}else{if((j0&248)!=240)C0("Invalid UTF-8 leading byte "+b1(j0)+" encountered when deserializing a UTF-8 string in wasm memory to a JS string!");j0=(j0&7)<<18|t0<<12|U1<<6|Z[D++]&63}if(j0<65536){N0+=String.fromCharCode(j0)}else{var c5=j0-65536;N0+=String.fromCharCode(55296|c5>>10,56320|c5&1023)}}return N0};var q5=(Z,D)=>{i(typeof Z=="number",`UTF8ToString expects a number (got ${typeof Z})`);return Z?c1(F0,Z,D):""};var g5={varargs:undefined,getStr(Z){var D=q5(Z);return D}};var N5=(Z)=>{m0("fd_close called without SYSCALLS_REQUIRE_FILESYSTEM")};var O8=9007199254740992;var q8=-9007199254740992;var b5=(Z)=>Z<q8||Z>O8?NaN:Number(Z);function f5(Z,D,o,K0){D=b5(D);return 70}var d1=[null,[],[]];var t1=(Z,D)=>{var o=d1[Z];i(o);if(D===0||D===10){(Z===1?A:P)(c1(o));o.length=0}else{o.push(D)}};var U5=()=>{y5(0);if(d1[1].length)t1(1,10);if(d1[2].length)t1(2,10)};var I5=(Z,D,o,K0)=>{var O0=0;for(var N0=0;N0<o;N0++){var j0=P0[D>>2];var t0=P0[D+4>>2];D+=8;for(var U1=0;U1<t0;U1++){t1(Z,F0[j0+U1])}O0+=t0}P0[K0>>2]=O0;return 0};function E5(){n8("fetchSettings")}var S1={_abort_js:Q5,emscripten_resize_heap:O5,fd_close:N5,fd_seek:f5,fd_write:I5};var r0=await L5();var C5=M0("__wasm_call_ctors",0);var n5=G["_malloc"]=M0("malloc",1);var s5=G["_free"]=M0("free",1);var F5=G["_tsf_load_memory"]=M0("tsf_load_memory",2);var l0=G["_tsf_close"]=M0("tsf_close",1);var P6=G["_tsf_reset"]=M0("tsf_reset",1);var z6=G["_tsf_set_output"]=M0("tsf_set_output",4);var D6=G["_realloc"]=M0("realloc",2);var p5=G["_tsf_channel_set_bank_preset"]=M0("tsf_channel_set_bank_preset",4);var M6=G["_tml_load_memory"]=M0("tml_load_memory",2);var v6=G["_midi_render"]=M0("midi_render",7);var y5=M0("fflush",1);var r5=M0("strerror",1);var x5=r0["emscripten_stack_init"];var g6=r0["emscripten_stack_get_free"];var T5=r0["emscripten_stack_get_base"];var N8=r0["emscripten_stack_get_end"];var i5=r0["_emscripten_stack_restore"];var a5=r0["_emscripten_stack_alloc"];var j5=r0["emscripten_stack_get_current"];G["setValue"]=K5;G["getValue"]=G5;var k5=["writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","stackAlloc","getTempRet0","setTempRet0","zeroMemory","exitJS","strError","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","emscriptenLog","readEmAsmArgs","jstoi_q","getExecutableName","listenOnce","autoResumeAudioContext","getDynCaller","dynCall","handleException","keepRuntimeAlive","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","asmjsMangle","asyncLoad","mmapAlloc","HandleAllocator","getNativeTypeSize","STACK_SIZE","STACK_ALIGN","POINTER_SIZE","ASSERTIONS","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","generateFuncType","convertJsFunctionToWasm","getEmptyTableSlot","updateTableMap","getFunctionAddress","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","stringToUTF8Array","stringToUTF8","lengthBytesUTF8","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","stringToNewUTF8","stringToUTF8OnStack","writeArrayToMemory","registerKeyEventCallback","maybeCStringToJsString","findEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","jsStackTrace","getCallstack","convertPCtoSourceLocation","getEnvStrings","checkWasiClock","wasiRightsToMuslOFlags","wasiOFlagsToMuslOFlags","initRandomFill","randomFill","safeSetTimeout","setImmediateWrapped","safeRequestAnimationFrame","clearImmediateWrapped","registerPostMainLoop","registerPreMainLoop","getPromise","makePromise","idsToPromises","makePromiseCallback","ExceptionInfo","findMatchingCatch","Browser_asyncPrepareDataCounter","isLeapYear","ydayFromDate","arraySum","addDays","getSocketFromFD","getSocketAddress","FS_createPreloadedFile","FS_modeStringToFlags","FS_getMode","FS_stdin_getChar","FS_unlink","FS_createDataFile","FS_mkdirTree","_setNetworkCallback","heapObjectForWebGLType","toTypedArrayIndex","webgl_enable_ANGLE_instanced_arrays","webgl_enable_OES_vertex_array_object","webgl_enable_WEBGL_draw_buffers","webgl_enable_WEBGL_multi_draw","webgl_enable_EXT_polygon_offset_clamp","webgl_enable_EXT_clip_control","webgl_enable_WEBGL_polygon_mode","emscriptenWebGLGet","computeUnpackAlignedImageSize","colorChannelsInGlTextureFormat","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","__glGetActiveAttribOrUniform","writeGLArray","registerWebGlEventCallback","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate","writeStringToMemory","writeAsciiToMemory","setErrNo","demangle","stackTrace"];k5.forEach(s8);var b8=["run","addOnPreRun","addOnInit","addOnPreMain","addOnExit","addOnPostRun","addRunDependency","removeRunDependency","out","err","callMain","abort","wasmMemory","wasmExports","writeStackCookie","checkStackCookie","INT53_MAX","INT53_MIN","bigintToI53Checked","stackSave","stackRestore","ptrToString","getHeapMax","growMemory","ENV","ERRNO_CODES","DNS","Protocols","Sockets","timers","warnOnce","readEmAsmArgsArray","jstoi_s","alignMemory","wasmTable","noExitRuntime","freeTableIndexes","functionsInTableMap","PATH","PATH_FS","UTF8Decoder","UTF8ArrayToString","UTF8ToString","UTF16Decoder","JSEvents","specialHTMLTargets","findCanvasEventTarget","currentFullscreenStrategy","restoreOldWindowedStyle","UNWIND_CACHE","ExitStatus","flush_NO_FILESYSTEM","emSetImmediate","emClearImmediate_deps","emClearImmediate","promiseMap","uncaughtExceptionCount","exceptionLast","exceptionCaught","Browser","getPreloadedImageData__data","wget","MONTH_DAYS_REGULAR","MONTH_DAYS_LEAP","MONTH_DAYS_REGULAR_CUMULATIVE","MONTH_DAYS_LEAP_CUMULATIVE","SYSCALLS","preloadPlugins","FS_stdin_getChar_buffer","FS_createPath","FS_createDevice","FS_readFile","FS","FS_createLazyFile","MEMFS","TTY","PIPEFS","SOCKFS","tempFixedLengthArray","miniTempWebGLFloatBuffers","miniTempWebGLIntBuffers","GL","AL","GLUT","EGL","GLEW","IDBStore","SDL","SDL_gfx","allocateUTF8","allocateUTF8OnStack","print","printErr"];b8.forEach(p1);var U8;function o1(){x5();C8()}function l1(){if(c0>0){H1=l1;return}o1();p8();if(c0>0){H1=l1;return}function Z(){i(!U8);U8=true;G["calledRun"]=true;if(J0)return;y8();K(G);G["onRuntimeInitialized"]?.();i(!G["_main"],'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]');r8()}if(G["setStatus"]){G["setStatus"]("Running...");setTimeout(()=>{setTimeout(()=>G["setStatus"](""),1);Z()},1)}else{Z()}w1()}function W(){var Z=A;var D=P;var o=false;A=P=(K0)=>{o=true};try{U5()}catch(K0){}A=Z;P=D;if(o){C0("stdio streams had content in them that was not flushed. you should set EXIT_RUNTIME to 1 (see the Emscripten FAQ), or make sure to emit a newline when you printf etc.");C0("(this may also be due to not including full filesystem support - try building with -sFORCE_FILESYSTEM)")}}if(G["preInit"]){if(typeof G["preInit"]=="function")G["preInit"]=[G["preInit"]];while(G["preInit"].length>0){G["preInit"].pop()()}}l1();L=H;for(const Z of Object.keys(G)){if(!(Z in R)){Object.defineProperty(R,Z,{configurable:true,get(){m0(`Access to module property ('${Z}') is no longer possible via the module constructor argument; Instead, use the result of the module constructor.`)}})}}return L}})();(()=>{var _=S5;S5=function(R){if(new.target)throw new Error("loadTinyMidiPCM() should not be called with `new loadTinyMidiPCM()`");return _(R)}})();var q6=S5;var P5=["F11","F12"];var E0={Backspace:{code:8,ch:8},Enter:{code:10,ch:10},Shift:{code:16,ch:65535},Escape:{code:27,ch:27},Tab:{code:9,ch:9},CapsLock:{code:20,ch:65535}," ":{code:32,ch:32},Control:{code:17,ch:65535},Alt:{code:18,ch:65535},Meta:{code:524,ch:65535},ArrowLeft:{code:37,ch:65535},ArrowRight:{code:39,ch:65535},ArrowUp:{code:38,ch:65535},ArrowDown:{code:40,ch:65535},Insert:{code:155,ch:65535},Home:{code:36,ch:65535},PageUp:{code:33,ch:65535},Delete:{code:127,ch:127},End:{code:35,ch:65535},PageDown:{code:34,ch:65535},"`":{code:192,ch:96},"~":{code:192,ch:126},"!":{code:49,ch:33},"@":{code:50,ch:64},"#":{code:51,ch:35},$:{code:52,ch:36},"%":{code:53,ch:37},"^":{code:54,ch:94},"&":{code:55,ch:38},"*":{code:56,ch:42},"(":{code:57,ch:40},")":{code:48,ch:41},"-":{code:45,ch:45},_:{code:45,ch:95},"=":{code:61,ch:61},"+":{code:61,ch:43},"[":{code:91,ch:91},"{":{code:91,ch:123},"]":{code:93,ch:93},"}":{code:93,ch:125},"\\":{code:92,ch:92},"|":{code:92,ch:124},";":{code:59,ch:59},":":{code:59,ch:58},"'":{code:222,ch:39},'"':{code:222,ch:34},",":{code:44,ch:44},"<":{code:44,ch:60},".":{code:46,ch:46},">":{code:46,ch:62},"/":{code:47,ch:47},"?":{code:47,ch:63},F1:{code:112,ch:65535},F2:{code:113,ch:65535},F3:{code:114,ch:65535},F4:{code:115,ch:65535},F5:{code:116,ch:65535},F6:{code:117,ch:65535},F7:{code:118,ch:65535},F8:{code:119,ch:65535},F9:{code:120,ch:65535},F10:{code:121,ch:65535},F11:{code:122,ch:65535},F12:{code:123,ch:65535},"0":{code:48,ch:48},"1":{code:49,ch:49},"2":{code:50,ch:50},"3":{code:51,ch:51},"4":{code:52,ch:52},"5":{code:53,ch:53},"6":{code:54,ch:54},"7":{code:55,ch:55},"8":{code:56,ch:56},"9":{code:57,ch:57},a:{code:65,ch:97},b:{code:66,ch:98},c:{code:67,ch:99},d:{code:68,ch:100},e:{code:69,ch:101},f:{code:70,ch:102},g:{code:71,ch:103},h:{code:72,ch:104},i:{code:73,ch:105},j:{code:74,ch:106},k:{code:75,ch:107},l:{code:76,ch:108},m:{code:77,ch:109},n:{code:78,ch:110},o:{code:79,ch:111},p:{code:80,ch:112},q:{code:81,ch:113},r:{code:82,ch:114},s:{code:83,ch:115},t:{code:84,ch:116},u:{code:85,ch:117},v:{code:86,ch:118},w:{code:87,ch:119},x:{code:88,ch:120},y:{code:89,ch:121},z:{code:90,ch:122},A:{code:65,ch:65},B:{code:66,ch:66},C:{code:67,ch:67},D:{code:68,ch:68},E:{code:69,ch:69},F:{code:70,ch:70},G:{code:71,ch:71},H:{code:72,ch:72},I:{code:73,ch:73},J:{code:74,ch:74},K:{code:75,ch:75},L:{code:76,ch:76},M:{code:77,ch:77},N:{code:78,ch:78},O:{code:79,ch:79},P:{code:80,ch:80},Q:{code:81,ch:81},R:{code:82,ch:82},S:{code:83,ch:83},T:{code:84,ch:84},U:{code:85,ch:85},V:{code:86,ch:86},W:{code:87,ch:87},X:{code:88,ch:88},Y:{code:89,ch:89},Z:{code:90,ch:90}};class D0{key;next;prev;constructor(){this.key=0n;this.next=this;this.prev=this}unlink(){if(!this.prev||!this.next){return}this.prev.next=this.next;this.next.prev=this.prev;this.next=null;this.prev=null}}class x0 extends D0{next2;prev2;constructor(){super();this.next2=this;this.prev2=this}uncache(){if(!this.prev2||!this.next2){return}this.prev2.next2=this.next2;this.next2.prev2=this.prev2;this.next2=null;this.prev2=null}}class g0{sentinel;cursor=null;constructor(){const _=new D0;_.next=_;_.prev=_;this.sentinel=_}addTail(_){if(_.prev){_.unlink()}_.prev=this.sentinel.prev;_.next=this.sentinel;if(_.prev){_.prev.next=_}_.next.prev=_}addHead(_){if(_.prev){_.unlink()}_.prev=this.sentinel;_.next=this.sentinel.next;_.prev.next=_;if(_.next){_.next.prev=_}}removeHead(){const _=this.sentinel.next;if(_===this.sentinel){return null}_?.unlink();return _}head(){const _=this.sentinel.next;if(_===this.sentinel){this.cursor=null;return null}this.cursor=_?.next||null;return _}tail(){const _=this.sentinel.prev;if(_===this.sentinel){this.cursor=null;return null}this.cursor=_?.prev||null;return _}next(){const _=this.cursor;if(_===this.sentinel){this.cursor=null;return null}this.cursor=_?.next||null;return _}prev(){const _=this.cursor;if(_===this.sentinel){this.cursor=null;return null}this.cursor=_?.prev||null;return _}clear(){while(true){const _=this.sentinel.next;if(_===this.sentinel){return}_?.unlink()}}}var q1=async(_)=>new Promise((R)=>setTimeout(R,_));var T8=async(_)=>new Uint8Array(await(await fetch(_)).arrayBuffer());function z5(_,R,L,G,K){while(K--)L[G++]=_[R++]}function N6(_){let R=0n;for(let L=0;L<_.length;L++){R=R<<8n|BigInt(_[L])}return R}function b6(_){const R=[];while(_>0n){R.unshift(Number(_&0xffn));_>>=8n}if(R[0]&128){R.unshift(0)}return new Uint8Array(R)}function U6(_,R,L){let G=1n;while(R>0n){if(R%2n===1n){G=G*_%L}_=_*_%L;R>>=1n}return G}class p extends x0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new g0;static cacheMid=new g0;static cacheMax=new g0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let _=0;_<32;_++){p.bitmask[_]=(1<<_)-1}p.bitmask[32]=4294967295;for(let _=0;_<256;_++){let R=_;for(let L=0;L<8;L++){if((R&1)===1){R=R>>>1^p.CRC32_POLYNOMIAL}else{R>>>=1}}p.crctable[_]=R}}static crc32=(_)=>{let R=4294967295;for(let L=0;L<_.length;L++){R=R>>>8^p.crctable[(R^_[L])&255]}return~R};view;data;pos=0;bitPos=0;random=null;constructor(_){if(!_){throw new Error("Input src packet array was null!")}super();if(_ instanceof Int8Array){this.data=new Uint8Array(_)}else{this.data=_}this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc=(_)=>{let R=null;if(_===0&&p.cacheMinCount>0){p.cacheMinCount--;R=p.cacheMin.removeHead()}else if(_===1&&p.cacheMidCount>0){p.cacheMidCount--;R=p.cacheMid.removeHead()}else if(_===2&&p.cacheMaxCount>0){p.cacheMaxCount--;R=p.cacheMax.removeHead()}if(R){R.pos=0;return R}if(_===0){return new p(new Uint8Array(100))}else if(_===1){return new p(new Uint8Array(5000))}return new p(new Uint8Array(30000))};release(){this.pos=0;if(this.view.byteLength===100&&p.cacheMinCount<1000){p.cacheMin.addTail(this);p.cacheMinCount++}else if(this.view.byteLength===5000&&p.cacheMidCount<250){p.cacheMid.addTail(this);p.cacheMidCount++}else if(this.view.byteLength===30000&&p.cacheMaxCount<50){p.cacheMax.addTail(this);p.cacheMaxCount++}}get g1(){return this.view.getUint8(this.pos++)}get g1b(){return this.view.getInt8(this.pos++)}get g2(){const _=this.view.getUint16(this.pos);this.pos+=2;return _}get g2b(){const _=this.view.getInt16(this.pos);this.pos+=2;return _}get g3(){const _=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);this.pos+=2;return _}get g4(){const _=this.view.getInt32(this.pos);this.pos+=4;return _}get g8(){const _=this.view.getBigInt64(this.pos);this.pos+=8;return _}get gsmart(){return this.view.getUint8(this.pos)<128?this.g1-64:this.g2-49152}get gsmarts(){return this.view.getUint8(this.pos)<128?this.g1:this.g2-32768}get gjstr(){const _=this.view;const R=_.byteLength;let L="";let G;while((G=_.getUint8(this.pos++))!==10&&this.pos<R){L+=String.fromCharCode(G)}return L}gdata(_,R,L){L.set(this.data.subarray(this.pos,this.pos+_),R);this.pos+=_}p1isaac(_){this.view.setUint8(this.pos++,_+(this.random?.nextInt??0)&255)}p1(_){this.view.setUint8(this.pos++,_)}p2(_){this.view.setUint16(this.pos,_);this.pos+=2}ip2(_){this.view.setUint16(this.pos,_,true);this.pos+=2}p3(_){this.view.setUint8(this.pos++,_>>16);this.view.setUint16(this.pos,_);this.pos+=2}p4(_){this.view.setInt32(this.pos,_);this.pos+=4}ip4(_){this.view.setInt32(this.pos,_,true);this.pos+=4}p8(_){this.view.setBigInt64(this.pos,_);this.pos+=8}pjstr(_){const R=this.view;const L=_.length;for(let G=0;G<L;G++){R.setUint8(this.pos++,_.charCodeAt(G))}R.setUint8(this.pos++,10)}pdata(_,R,L){this.data.set(_.subarray(L,L+R),this.pos);this.pos+=R-L}psize1(_){this.view.setUint8(this.pos-_-1,_)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(_){let R=this.bitPos>>>3;let L=8-(this.bitPos&7);let G=0;this.bitPos+=_;for(;_>L;L=8){G+=(this.view.getUint8(R++)&p.bitmask[L])<<_-L;_-=L}if(_===L){G+=this.view.getUint8(R)&p.bitmask[L]}else{G+=this.view.getUint8(R)>>>L-_&p.bitmask[_]}return G}rsaenc(_,R){const L=this.pos;this.pos=0;const G=new Uint8Array(L);this.gdata(L,0,G);const K=N6(G);const Q=U6(K,R,_);const H=b6(Q);this.pos=0;this.p1(H.length);this.pdata(H,H.length,0)}}class S0{static enabled=false;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled=()=>{this.outBuffer=p.alloc(1);this.oldBuffer=null;this.lastTime=performance.now();this.enabled=true};static setDisabled=()=>{this.enabled=false;this.outBuffer=null};static flush=()=>{let _=null;if(this.oldBuffer&&this.enabled){_=this.oldBuffer}this.oldBuffer=null;return _};static stop=()=>{let _=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.enabled){_=this.outBuffer}this.setDisabled();return _};static mousePressed=(_,R,L)=>{if(!(this.enabled&&_>=0&&_<789&&R>=0&&R<532)){return}this.trackedCount++;const G=performance.now();let K=(G-this.lastTime)/10|0;if(K>250){K=250}this.lastTime=G;this.ensureCapacity(5);if(L===1){this.outBuffer?.p1(1)}else{this.outBuffer?.p1(2)}this.outBuffer?.p1(K);this.outBuffer?.p3(_+(R<<10))};static mouseReleased=(_)=>{if(!this.enabled){return}this.trackedCount++;const R=performance.now();let L=(R-this.lastTime)/10|0;if(L>250){L=250}this.lastTime=R;this.ensureCapacity(2);if(_===1){this.outBuffer?.p1(3)}else{this.outBuffer?.p1(4)}this.outBuffer?.p1(L)};static mouseMoved=(_,R)=>{if(!(this.enabled&&_>=0&&_<789&&R>=0&&R<532)){return}const L=performance.now();if(L-this.lastMoveTime>=50){this.lastMoveTime=L;this.trackedCount++;let G=(L-this.lastTime)/10|0;if(G>250){G=250}this.lastTime=L;if(_-this.lastX<8&&_-this.lastX>=-8&&R-this.lastY<8&&R-this.lastY>=-8){this.ensureCapacity(3);this.outBuffer?.p1(5);this.outBuffer?.p1(G);this.outBuffer?.p1(_+(R-this.lastY+8<<4)+8-this.lastX)}else if(_-this.lastX<128&&_-this.lastX>=-128&&R-this.lastY<128&&R-this.lastY>=-128){this.ensureCapacity(4);this.outBuffer?.p1(6);this.outBuffer?.p1(G);this.outBuffer?.p1(_+128-this.lastX);this.outBuffer?.p1(R+128-this.lastY)}else{this.ensureCapacity(5);this.outBuffer?.p1(7);this.outBuffer?.p1(G);this.outBuffer?.p3(_+(R<<10))}this.lastX=_;this.lastY=R}};static keyPressed=(_)=>{if(!this.enabled){return}this.trackedCount++;const R=performance.now();let L=(R-this.lastTime)/10|0;if(L>250){L=250}this.lastTime=R;if(_===1000){_=11}else if(_===1001){_=12}else if(_===1002){_=14}else if(_===1003){_=15}else if(_>=1008){_-=992}this.ensureCapacity(3);this.outBuffer?.p1(8);this.outBuffer?.p1(L);this.outBuffer?.p1(_)};static keyReleased=(_)=>{if(!this.enabled){return}this.trackedCount++;const R=performance.now();let L=(R-this.lastTime)/10|0;if(L>250){L=250}this.lastTime=R;if(_===1000){_=11}else if(_===1001){_=12}else if(_===1002){_=14}else if(_===1003){_=15}else if(_>=1008){_-=992}this.ensureCapacity(3);this.outBuffer?.p1(9);this.outBuffer?.p1(L);this.outBuffer?.p1(_)};static focusGained=()=>{if(!this.enabled){return}this.trackedCount++;const _=performance.now();let R=(_-this.lastTime)/10|0;if(R>250){R=250}this.lastTime=_;this.ensureCapacity(2);this.outBuffer?.p1(10);this.outBuffer?.p1(R)};static focusLost=()=>{if(!this.enabled){return}this.trackedCount++;const _=performance.now();let R=(_-this.lastTime)/10|0;if(R>250){R=250}this.lastTime=_;this.ensureCapacity(2);this.outBuffer?.p1(11);this.outBuffer?.p1(R)};static mouseEntered=()=>{if(!this.enabled){return}this.trackedCount++;const _=performance.now();let R=(_-this.lastTime)/10|0;if(R>250){R=250}this.lastTime=_;this.ensureCapacity(2);this.outBuffer?.p1(12);this.outBuffer?.p1(R)};static mouseExited=()=>{if(!this.enabled){return}this.trackedCount++;const _=performance.now();let R=(_-this.lastTime)/10|0;if(R>250){R=250}this.lastTime=_;this.ensureCapacity(2);this.outBuffer?.p1(13);this.outBuffer?.p1(R)};static ensureCapacity=(_)=>{if(!this.outBuffer){return}if(this.outBuffer.pos+_>=500){const R=this.outBuffer;this.outBuffer=p.alloc(1);this.oldBuffer=R}}}var u0=document.getElementById("canvas");var q0=u0.getContext("2d",{willReadFrequently:true});var D1=document.createElement("canvas");var W1=document.createElement("img");var j8=D1.getContext("2d",{willReadFrequently:true});class k extends x0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind=(_,R,L)=>{this.pixels=_;this.width2d=R;this.height2d=L;this.setBounds(0,0,R,L)};static resetBounds=()=>{this.left=0;this.top=0;this.right=this.width2d;this.bottom=this.height2d;this.boundX=this.right-1;this.centerX2d=this.right/2|0};static setBounds=(_,R,L,G)=>{if(_<0){_=0}if(R<0){R=0}if(L>this.width2d){L=this.width2d}if(G>this.height2d){G=this.height2d}this.top=R;this.bottom=G;this.left=_;this.right=L;this.boundX=this.right-1;this.centerX2d=this.right/2|0;this.centerY2d=this.bottom/2|0};static clear=()=>{const _=this.width2d*this.height2d;for(let R=0;R<_;R++){this.pixels[R]=0}};static drawRect=(_,R,L,G,K)=>{this.drawHorizontalLine(_,R,K,L);this.drawHorizontalLine(_,R+G-1,K,L);this.drawVerticalLine(_,R,K,G);this.drawVerticalLine(_+L-1,R,K,G)};static drawHorizontalLine=(_,R,L,G)=>{if(R<this.top||R>=this.bottom){return}if(_<this.left){G-=this.left-_;_=this.left}if(_+G>this.right){G=this.right-_}const K=_+R*this.width2d;for(let Q=0;Q<G;Q++){this.pixels[K+Q]=L}};static drawVerticalLine=(_,R,L,G)=>{if(_<this.left||_>=this.right){return}if(R<this.top){G-=this.top-R;R=this.top}if(R+G>this.bottom){G=this.bottom-R}const K=_+R*this.width2d;for(let Q=0;Q<G;Q++){this.pixels[K+Q*this.width2d]=L}};static drawLine=(_,R,L,G,K)=>{const Q=Math.abs(L-_);const H=Math.abs(G-R);const $=_<L?1:-1;const J=R<G?1:-1;let O=Q-H;while(true){if(_>=this.left&&_<this.right&&R>=this.top&&R<this.bottom){this.pixels[_+R*this.width2d]=K}if(_===L&&R===G){break}const q=2*O;if(q>-H){O=O-H;_=_+$}if(q<Q){O=O+Q;R=R+J}}};static fillRect=(_,R,L,G,K)=>{if(_<this.left){L-=this.left-_;_=this.left}if(R<this.top){G-=this.top-R;R=this.top}if(_+L>this.right){L=this.right-_}if(R+G>this.bottom){G=this.bottom-R}const Q=this.width2d-L;let H=_+R*this.width2d;for(let $=-G;$<0;$++){for(let J=-L;J<0;J++){this.pixels[H++]=K}H+=Q}};static fillRectAlpha(_,R,L,G,K,Q){if(_<this.left){L-=this.left-_;_=this.left}if(R<this.top){G-=this.top-R;R=this.top}if(_+L>this.right){L=this.right-_}if(R+G>this.bottom){G=this.bottom-R}const H=256-Q;const $=(K>>16&255)*Q;const J=(K>>8&255)*Q;const O=(K&255)*Q;const q=this.width2d-L;let N=_+R*this.width2d;for(let U=0;U<G;U++){for(let b=-L;b<0;b++){const I=(this.pixels[N]>>16&255)*H;const j=(this.pixels[N]>>8&255)*H;const F=(this.pixels[N]&255)*H;const T=($+I>>8<<16)+(J+j>>8<<8)+(O+F>>8);this.pixels[N++]=T}N+=q}}static fillCircle(_,R,L,G,K){const Q=256-K;const H=(G>>16&255)*K;const $=(G>>8&255)*K;const J=(G&255)*K;let O=R-L;if(O<0){O=0}let q=R+L;if(q>=this.height2d){q=this.height2d-1}for(let N=O;N<=q;N++){const U=N-R;const b=Math.sqrt(L*L-U*U)|0;let I=_-b;if(I<0){I=0}let j=_+b;if(j>=this.width2d){j=this.width2d-1}let F=I+N*this.width2d;for(let T=I;T<=j;T++){const Y=(this.pixels[F]>>16&255)*Q;const u=(this.pixels[F]>>8&255)*Q;const w=(this.pixels[F]&255)*Q;const h=(H+Y>>8<<16)+($+u>>8<<8)+(J+w>>8);this.pixels[F++]=h}}}static setPixel=(_,R,L)=>{if(_<this.left||_>=this.right||R<this.top||R>=this.bottom){return}this.pixels[_+R*this.width2d]=L}}class B0 extends x0{pixels;width;height;cropX;cropY;cropW;cropH;palette;constructor(_,R,L){super();this.pixels=new Int8Array(_*R);this.width=this.cropW=_;this.height=this.cropH=R;this.cropX=this.cropY=0;this.palette=L}static fromArchive=(_,R,L=0)=>{const G=new p(_.read(R+".dat"));const K=new p(_.read("index.dat"));K.pos=G.g2;const Q=K.g2;const H=K.g2;const $=K.g1;const J=new Int32Array($);for(let F=1;F<$;F++){J[F]=K.g3;if(J[F]===0){J[F]=1}}for(let F=0;F<L;F++){K.pos+=2;G.pos+=K.g2*K.g2;K.pos+=1}if(G.pos>G.length||K.pos>K.length){throw new Error}const O=K.g1;const q=K.g1;const N=K.g2;const U=K.g2;const b=new B0(N,U,J);b.cropX=O;b.cropY=q;b.cropW=Q;b.cropH=H;const I=b.pixels;const j=K.g1;if(j===0){const F=b.width*b.height;for(let T=0;T<F;T++){I[T]=G.g1b}}else if(j===1){const F=b.width;const T=b.height;for(let Y=0;Y<F;Y++){for(let u=0;u<T;u++){I[Y+u*F]=G.g1b}}}return b};draw(_,R){_|=0;R|=0;_+=this.cropX;R+=this.cropY;let L=_+R*k.width2d;let G=0;let K=this.height;let Q=this.width;let H=k.width2d-Q;let $=0;if(R<k.top){const J=k.top-R;K-=J;R=k.top;G+=J*Q;L+=J*k.width2d}if(R+K>k.bottom){K-=R+K-k.bottom}if(_<k.left){const J=k.left-_;Q-=J;_=k.left;G+=J;L+=J;$+=J;H+=J}if(_+Q>k.right){const J=_+Q-k.right;Q-=J;$+=J;H+=J}if(Q>0&&K>0){this.copyImage(Q,K,this.pixels,G,$,k.pixels,L,H)}}flipHorizontally(){const _=this.pixels;const R=this.width;const L=this.height;for(let G=0;G<L;G++){const K=R/2|0;for(let Q=0;Q<K;Q++){const H=Q+G*R;const $=R-Q-1+G*R;const J=_[H];_[H]=_[$];_[$]=J}}}flipVertically(){const _=this.pixels;const R=this.width;const L=this.height;for(let G=0;G<(L/2|0);G++){for(let K=0;K<R;K++){const Q=K+G*R;const H=K+(L-G-1)*R;const $=_[Q];_[Q]=_[H];_[H]=$}}}translate(_,R,L){for(let G=0;G<this.palette.length;G++){let K=this.palette[G]>>16&255;K+=_;if(K<0){K=0}else if(K>255){K=255}let Q=this.palette[G]>>8&255;Q+=R;if(Q<0){Q=0}else if(Q>255){Q=255}let H=this.palette[G]&255;H+=L;if(H<0){H=0}else if(H>255){H=255}this.palette[G]=(K<<16)+(Q<<8)+H}}shrink(){this.cropW|=0;this.cropH|=0;this.cropW/=2;this.cropH/=2;this.cropW|=0;this.cropH|=0;const _=new Int8Array(this.cropW*this.cropH);let R=0;for(let L=0;L<this.height;L++){for(let G=0;G<this.width;G++){_[(G+this.cropX>>1)+(L+this.cropY>>1)*this.cropW]=this.pixels[R++]}}this.pixels=_;this.width=this.cropW;this.height=this.cropH;this.cropX=0;this.cropY=0}crop(){if(this.width===this.cropW&&this.height===this.cropH){return}const _=new Int8Array(this.cropW*this.cropH);let R=0;for(let L=0;L<this.height;L++){for(let G=0;G<this.width;G++){_[G+this.cropX+(L+this.cropY)*this.cropW]=this.pixels[R++]}}this.pixels=_;this.width=this.cropW;this.height=this.cropH;this.cropX=0;this.cropY=0}copyImage(_,R,L,G,K,Q,H,$){const J=-(_>>2);_=-(_&3);for(let O=-R;O<0;O++){for(let q=J;q<0;q++){let N=L[G++];if(N===0){H++}else{Q[H++]=this.palette[N&255]}N=L[G++];if(N===0){H++}else{Q[H++]=this.palette[N&255]}N=L[G++];if(N===0){H++}else{Q[H++]=this.palette[N&255]}N=L[G++];if(N===0){H++}else{Q[H++]=this.palette[N&255]}}for(let q=_;q<0;q++){const N=L[G++];if(N===0){H++}else{Q[H++]=this.palette[N&255]}}H+=$;G+=K}}clip(_,R,L,G){try{const K=this.width;const Q=this.height;let H=0;let $=0;const J=(K<<16)/L|0;const O=(Q<<16)/G|0;const q=this.cropW;const N=this.cropH;const U=(q<<16)/L|0;const b=(N<<16)/G|0;_=_+(this.cropX*L+q-1)/q|0;R=R+(this.cropY*G+N-1)/N|0;if(this.cropX*L%q!=0){H=(q-this.cropX*L%q<<16)/L|0}if(this.cropY*G%N!=0){$=(N-this.cropY*G%N<<16)/G|0}L=L*(this.width-(H>>16))/q|0;G=G*(this.height-($>>16))/N|0;let I=_+R*k.width2d;let j=k.width2d-L;let F;if(R<k.top){F=k.top-R;G-=F;R=0;I+=F*k.width2d;$+=b*F}if(R+G>k.bottom){G-=R+G-k.bottom}if(_<k.left){F=k.left-_;L-=F;_=0;I+=F;H+=U*F;j+=F}if(_+L>k.right){F=_+L-k.right;L-=F;j+=F}this.plot_scale(k.pixels,this.pixels,this.palette,H,$,I,j,L,G,U,b,K)}catch(K){}}plot_scale(_,R,L,G,K,Q,H,$,J,O,q,N){try{const U=G;for(let b=-J;b<0;b++){const I=(K>>16)*N;for(let j=-$;j<0;j++){const F=R[(G>>16)+I];if(F==0){Q++}else{_[Q++]=L[F&255]}G+=O}K+=q;G=U;Q+=H}}catch(U){}}}class l extends Array{constructor(_,R){super(_);for(let L=0;L<_;L++){this[L]=R}}}class D5 extends Array{constructor(_,R,L){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let K=0;K<R;K++){this[G][K]=L}}}}class e1 extends Array{constructor(_,R,L,G){super(_);for(let K=0;K<_;K++){this[K]=new Array(R);for(let Q=0;Q<R;Q++){this[K][Q]=new Array(L);for(let H=0;H<L;H++){this[K][Q][H]=G}}}}}class k8 extends Array{constructor(_,R,L,G,K){super(_);for(let Q=0;Q<_;Q++){this[Q]=new Array(R);for(let H=0;H<R;H++){this[Q][H]=new Array(L);for(let $=0;$<L;$++){this[Q][H][$]=new Array(G);for(let J=0;J<G;J++){this[Q][H][$][J]=K}}}}}}class I1 extends Array{constructor(_,R,L){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let K=0;K<R;K++){this[G][K]=new Uint8Array(L)}}}}class J1 extends Array{constructor(_,R){super(_);for(let L=0;L<_;L++){this[L]=new Int32Array(R)}}}class A1 extends Array{constructor(_,R,L){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let K=0;K<R;K++){this[G][K]=new Int32Array(L)}}}}class B extends k{static lowMemory=false;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static palette=new Int32Array(65536);static textures=new l(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=true;static clipX=false;static alpha=0;static texelPool=null;static activeTexels=new l(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texturePalette=new l(50,null);static opaque=false;static textureTranslucent=new l(50,false);static averageTextureRGB=new Int32Array(50);static{for(let _=1;_<512;_++){this.reciprocal15[_]=32768/_|0}for(let _=1;_<2048;_++){this.reciprocal16[_]=65536/_|0}for(let _=0;_<2048;_++){this.sin[_]=Math.sin(_*0.0030679615757712823)*65536|0;this.cos[_]=Math.cos(_*0.0030679615757712823)*65536|0}}static init2D=()=>{this.lineOffset=new Int32Array(k.height2d);for(let _=0;_<k.height2d;_++){this.lineOffset[_]=k.width2d*_}this.centerX=k.width2d/2|0;this.centerY=k.height2d/2|0};static init3D=(_,R)=>{this.lineOffset=new Int32Array(R);for(let L=0;L<R;L++){this.lineOffset[L]=_*L}this.centerX=_/2|0;this.centerY=R/2|0};static clearTexels=()=>{this.texelPool=null;this.activeTexels.fill(null)};static unpackTextures=(_)=>{this.textureCount=0;for(let R=0;R<50;R++){try{this.textures[R]=B0.fromArchive(_,R.toString());if(this.lowMemory&&this.textures[R]?.cropW===128){this.textures[R]?.shrink()}else{this.textures[R]?.crop()}this.textureCount++}catch(L){}}};static getAverageTextureRGB=(_)=>{if(this.averageTextureRGB[_]!==0){return this.averageTextureRGB[_]}const R=this.texturePalette[_];if(!R){return 0}let L=0;let G=0;let K=0;const Q=R.length;for(let $=0;$<Q;$++){L+=R[$]>>16&255;G+=R[$]>>8&255;K+=R[$]&255}let H=((L/Q|0)<<16)+((G/Q|0)<<8)+(K/Q|0);H=this.setGamma(H,1.4);if(H===0){H=1}this.averageTextureRGB[_]=H;return H};static setBrightness=(_)=>{const R=_+Math.random()*0.03-0.015;let L=0;for(let G=0;G<512;G++){const K=(G/8|0)/64+0.0078125;const Q=(G&7)/8+0.0625;for(let H=0;H<128;H++){const $=H/128;let J=$;let O=$;let q=$;if(Q!==0){let j;if($<0.5){j=$*(Q+1)}else{j=$+Q-$*Q}const F=$*2-j;let T=K+0.3333333333333333;if(T>1){T--}let Y=K-0.3333333333333333;if(Y<0){Y++}if(T*6<1){J=F+(j-F)*6*T}else if(T*2<1){J=j}else if(T*3<2){J=F+(j-F)*(0.6666666666666666-T)*6}else{J=F}if(K*6<1){O=F+(j-F)*6*K}else if(K*2<1){O=j}else if(K*3<2){O=F+(j-F)*(0.6666666666666666-K)*6}else{O=F}if(Y*6<1){q=F+(j-F)*6*Y}else if(Y*2<1){q=j}else if(Y*3<2){q=F+(j-F)*(0.6666666666666666-Y)*6}else{q=F}}const N=J*256|0;const U=O*256|0;const b=q*256|0;const I=(N<<16)+(U<<8)+b;this.palette[L++]=this.setGamma(I,R)}}for(let G=0;G<50;G++){const K=this.textures[G];if(!K){continue}const Q=K.palette;this.texturePalette[G]=new Int32Array(Q.length);for(let H=0;H<Q.length;H++){const $=this.texturePalette[G];if(!$){continue}$[H]=this.setGamma(Q[H],R)}}for(let G=0;G<50;G++){this.pushTexture(G)}};static setGamma=(_,R)=>{const L=(_>>16)/256;const G=(_>>8&255)/256;const K=(_&255)/256;const Q=Math.pow(L,R);const H=Math.pow(G,R);const $=Math.pow(K,R);const J=Q*256|0;const O=H*256|0;const q=$*256|0;return(J<<16)+(O<<8)+q};static initPool=(_)=>{if(this.texelPool){return}this.poolSize=_;if(this.lowMemory){this.texelPool=new J1(_,16384)}else{this.texelPool=new J1(_,65536)}this.activeTexels.fill(null)};static fillGouraudTriangle=(_,R,L,G,K,Q,H,$,J)=>{let O=0;let q=0;if(K!==G){O=(R-_<<16)/(K-G)|0;q=($-H<<15)/(K-G)|0}let N=0;let U=0;if(Q!==K){N=(L-R<<16)/(Q-K)|0;U=(J-$<<15)/(Q-K)|0}let b=0;let I=0;if(Q!==G){b=(_-L<<16)/(G-Q)|0;I=(H-J<<15)/(G-Q)|0}if(G<=K&&G<=Q){if(G<k.bottom){if(K>k.bottom){K=k.bottom}if(Q>k.bottom){Q=k.bottom}if(K<Q){L=_<<=16;J=H<<=15;if(G<0){L-=b*G;_-=O*G;J-=I*G;H-=q*G;G=0}R<<=16;$<<=15;if(K<0){R-=N*K;$-=U*K;K=0}if(G!==K&&b<O||G===K&&b>N){Q-=K;K-=G;G=B.lineOffset[G];while(true){K--;if(K<0){while(true){Q--;if(Q<0){return}this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,k.pixels,G,0);L+=b;R+=N;J+=I;$+=U;G+=k.width2d}}this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,k.pixels,G,0);L+=b;_+=O;J+=I;H+=q;G+=k.width2d}}else{Q-=K;K-=G;G=B.lineOffset[G];while(true){K--;if(K<0){while(true){Q--;if(Q<0){return}this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,k.pixels,G,0);L+=b;R+=N;J+=I;$+=U;G+=k.width2d}}this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,k.pixels,G,0);L+=b;_+=O;J+=I;H+=q;G+=k.width2d}}}else{R=_<<=16;$=H<<=15;if(G<0){R-=b*G;_-=O*G;$-=I*G;H-=q*G;G=0}L<<=16;J<<=15;if(Q<0){L-=N*Q;J-=U*Q;Q=0}if(G!==Q&&b<O||G===Q&&N>O){K-=Q;Q-=G;G=B.lineOffset[G];while(true){Q--;if(Q<0){while(true){K--;if(K<0){return}this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,k.pixels,G,0);L+=N;_+=O;J+=U;H+=q;G+=k.width2d}}this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,k.pixels,G,0);R+=b;_+=O;$+=I;H+=q;G+=k.width2d}}else{K-=Q;Q-=G;G=B.lineOffset[G];while(true){Q--;if(Q<0){while(true){K--;if(K<0){return}this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,k.pixels,G,0);L+=N;_+=O;J+=U;H+=q;G+=k.width2d}}this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,k.pixels,G,0);R+=b;_+=O;$+=I;H+=q;G+=k.width2d}}}}}else if(K<=Q){if(K<k.bottom){if(Q>k.bottom){Q=k.bottom}if(G>k.bottom){G=k.bottom}if(Q<G){_=R<<=16;H=$<<=15;if(K<0){_-=O*K;R-=N*K;H-=q*K;$-=U*K;K=0}L<<=16;J<<=15;if(Q<0){L-=b*Q;J-=I*Q;Q=0}if(K!==Q&&O<N||K===Q&&O>b){G-=Q;Q-=K;K=B.lineOffset[K];while(true){Q--;if(Q<0){while(true){G--;if(G<0){return}this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,k.pixels,K,0);_+=O;L+=b;H+=q;J+=I;K+=k.width2d}}this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,k.pixels,K,0);_+=O;R+=N;H+=q;$+=U;K+=k.width2d}}else{G-=Q;Q-=K;K=B.lineOffset[K];while(true){Q--;if(Q<0){while(true){G--;if(G<0){return}this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,k.pixels,K,0);_+=O;L+=b;H+=q;J+=I;K+=k.width2d}}this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,k.pixels,K,0);_+=O;R+=N;H+=q;$+=U;K+=k.width2d}}}else{L=R<<=16;J=$<<=15;if(K<0){L-=O*K;R-=N*K;J-=q*K;$-=U*K;K=0}_<<=16;H<<=15;if(G<0){_-=b*G;H-=I*G;G=0}Q-=G;G-=K;K=B.lineOffset[K];if(O<N){while(true){G--;if(G<0){while(true){Q--;if(Q<0){return}this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,k.pixels,K,0);_+=b;R+=N;H+=I;$+=U;K+=k.width2d}}this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,k.pixels,K,0);L+=O;R+=N;J+=q;$+=U;K+=k.width2d}}else{while(true){G--;if(G<0){while(true){Q--;if(Q<0){return}this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,k.pixels,K,0);_+=b;R+=N;H+=I;$+=U;K+=k.width2d}}this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,k.pixels,K,0);L+=O;R+=N;J+=q;$+=U;K+=k.width2d}}}}}else if(Q<k.bottom){if(G>k.bottom){G=k.bottom}if(K>k.bottom){K=k.bottom}if(G<K){R=L<<=16;$=J<<=15;if(Q<0){R-=N*Q;L-=b*Q;$-=U*Q;J-=I*Q;Q=0}_<<=16;H<<=15;if(G<0){_-=O*G;H-=q*G;G=0}K-=G;G-=Q;Q=B.lineOffset[Q];if(N<b){while(true){G--;if(G<0){while(true){K--;if(K<0){return}this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,k.pixels,Q,0);R+=N;_+=O;$+=U;H+=q;Q+=k.width2d}}this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,k.pixels,Q,0);R+=N;L+=b;$+=U;J+=I;Q+=k.width2d}}else{while(true){G--;if(G<0){while(true){K--;if(K<0){return}this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,k.pixels,Q,0);R+=N;_+=O;$+=U;H+=q;Q+=k.width2d}}this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,k.pixels,Q,0);R+=N;L+=b;$+=U;J+=I;Q+=k.width2d}}}else{_=L<<=16;H=J<<=15;if(Q<0){_-=N*Q;L-=b*Q;H-=U*Q;J-=I*Q;Q=0}R<<=16;$<<=15;if(K<0){R-=O*K;$-=q*K;K=0}G-=K;K-=Q;Q=B.lineOffset[Q];if(N<b){while(true){K--;if(K<0){while(true){G--;if(G<0){return}this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,k.pixels,Q,0);R+=O;L+=b;$+=q;J+=I;Q+=k.width2d}}this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,k.pixels,Q,0);_+=N;L+=b;H+=U;J+=I;Q+=k.width2d}}else{while(true){K--;if(K<0){while(true){G--;if(G<0){return}this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,k.pixels,Q,0);R+=O;L+=b;$+=q;J+=I;Q+=k.width2d}}this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,k.pixels,Q,0);_+=N;L+=b;H+=U;J+=I;Q+=k.width2d}}}}};static drawGouraudScanline=(_,R,L,G,K,Q,H)=>{let $;if(B.jagged){let J;if(B.clipX){if(R-_>3){J=(G-L)/(R-_)|0}else{J=0}if(R>k.boundX){R=k.boundX}if(_<0){L-=_*J;_=0}if(_>=R){return}Q+=_;H=R-_>>2;J<<=2}else if(_<R){Q+=_;H=R-_>>2;if(H>0){J=(G-L)*B.reciprocal15[H]>>15}else{J=0}}else{return}if(B.alpha===0){while(true){H--;if(H<0){H=R-_&3;if(H>0){$=B.palette[L>>8];do{K[Q++]=$;H--}while(H>0);return}break}$=B.palette[L>>8];L+=J;K[Q++]=$;K[Q++]=$;K[Q++]=$;K[Q++]=$}}else{const O=B.alpha;const q=256-B.alpha;while(true){H--;if(H<0){H=R-_&3;if(H>0){$=B.palette[L>>8];$=(($&16711935)*q>>8&16711935)+(($&65280)*q>>8&65280);do{K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280);H--}while(H>0)}break}$=B.palette[L>>8];L+=J;$=(($&16711935)*q>>8&16711935)+(($&65280)*q>>8&65280);K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280);K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280);K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280);K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280)}}}else if(_<R){const J=(G-L)/(R-_)|0;if(B.clipX){if(R>k.boundX){R=k.boundX}if(_<0){L-=_*J;_=0}if(_>=R){return}}Q+=_;H=R-_;if(B.alpha===0){do{K[Q++]=B.palette[L>>8];L+=J;H--}while(H>0)}else{const O=B.alpha;const q=256-B.alpha;do{$=B.palette[L>>8];L+=J;$=(($&16711935)*q>>8&16711935)+(($&65280)*q>>8&65280);K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280);H--}while(H>0)}}};static fillTriangle=(_,R,L,G,K,Q,H)=>{let $=0;if(K!==G){$=(R-_<<16)/(K-G)|0}let J=0;if(Q!==K){J=(L-R<<16)/(Q-K)|0}let O=0;if(Q!==G){O=(_-L<<16)/(G-Q)|0}if(G<=K&&G<=Q){if(G<k.bottom){if(K>k.bottom){K=k.bottom}if(Q>k.bottom){Q=k.bottom}if(K<Q){L=_<<=16;if(G<0){L-=O*G;_-=$*G;G=0}R<<=16;if(K<0){R-=J*K;K=0}if(G!==K&&O<$||G===K&&O>J){Q-=K;K-=G;G=this.lineOffset[G];while(true){K--;if(K<0){while(true){Q--;if(Q<0){return}this.drawScanline(L>>16,R>>16,k.pixels,G,H);L+=O;R+=J;G+=k.width2d}}this.drawScanline(L>>16,_>>16,k.pixels,G,H);L+=O;_+=$;G+=k.width2d}}else{Q-=K;K-=G;G=this.lineOffset[G];while(true){K--;if(K<0){while(true){Q--;if(Q<0){return}this.drawScanline(R>>16,L>>16,k.pixels,G,H);L+=O;R+=J;G+=k.width2d}}this.drawScanline(_>>16,L>>16,k.pixels,G,H);L+=O;_+=$;G+=k.width2d}}}else{R=_<<=16;if(G<0){R-=O*G;_-=$*G;G=0}L<<=16;if(Q<0){L-=J*Q;Q=0}if(G!==Q&&O<$||G===Q&&J>$){K-=Q;Q-=G;G=this.lineOffset[G];while(true){Q--;if(Q<0){while(true){K--;if(K<0){return}this.drawScanline(L>>16,_>>16,k.pixels,G,H);L+=J;_+=$;G+=k.width2d}}this.drawScanline(R>>16,_>>16,k.pixels,G,H);R+=O;_+=$;G+=k.width2d}}else{K-=Q;Q-=G;G=this.lineOffset[G];while(true){Q--;if(Q<0){while(true){K--;if(K<0){return}this.drawScanline(_>>16,L>>16,k.pixels,G,H);L+=J;_+=$;G+=k.width2d}}this.drawScanline(_>>16,R>>16,k.pixels,G,H);R+=O;_+=$;G+=k.width2d}}}}}else if(K<=Q){if(K<k.bottom){if(Q>k.bottom){Q=k.bottom}if(G>k.bottom){G=k.bottom}if(Q<G){_=R<<=16;if(K<0){_-=$*K;R-=J*K;K=0}L<<=16;if(Q<0){L-=O*Q;Q=0}if(K!==Q&&$<J||K===Q&&$>O){G-=Q;Q-=K;K=this.lineOffset[K];while(true){Q--;if(Q<0){while(true){G--;if(G<0){return}this.drawScanline(_>>16,L>>16,k.pixels,K,H);_+=$;L+=O;K+=k.width2d}}this.drawScanline(_>>16,R>>16,k.pixels,K,H);_+=$;R+=J;K+=k.width2d}}else{G-=Q;Q-=K;K=this.lineOffset[K];while(true){Q--;if(Q<0){while(true){G--;if(G<0){return}this.drawScanline(L>>16,_>>16,k.pixels,K,H);_+=$;L+=O;K+=k.width2d}}this.drawScanline(R>>16,_>>16,k.pixels,K,H);_+=$;R+=J;K+=k.width2d}}}else{L=R<<=16;if(K<0){L-=$*K;R-=J*K;K=0}_<<=16;if(G<0){_-=O*G;G=0}if($<J){Q-=G;G-=K;K=this.lineOffset[K];while(true){G--;if(G<0){while(true){Q--;if(Q<0){return}this.drawScanline(_>>16,R>>16,k.pixels,K,H);_+=O;R+=J;K+=k.width2d}}this.drawScanline(L>>16,R>>16,k.pixels,K,H);L+=$;R+=J;K+=k.width2d}}else{Q-=G;G-=K;K=this.lineOffset[K];while(true){G--;if(G<0){while(true){Q--;if(Q<0){return}this.drawScanline(R>>16,_>>16,k.pixels,K,H);_+=O;R+=J;K+=k.width2d}}this.drawScanline(R>>16,L>>16,k.pixels,K,H);L+=$;R+=J;K+=k.width2d}}}}}else if(Q<k.bottom){if(G>k.bottom){G=k.bottom}if(K>k.bottom){K=k.bottom}if(G<K){R=L<<=16;if(Q<0){R-=J*Q;L-=O*Q;Q=0}_<<=16;if(G<0){_-=$*G;G=0}if(J<O){K-=G;G-=Q;Q=this.lineOffset[Q];while(true){G--;if(G<0){while(true){K--;if(K<0){return}this.drawScanline(R>>16,_>>16,k.pixels,Q,H);R+=J;_+=$;Q+=k.width2d}}this.drawScanline(R>>16,L>>16,k.pixels,Q,H);R+=J;L+=O;Q+=k.width2d}}else{K-=G;G-=Q;Q=this.lineOffset[Q];while(true){G--;if(G<0){while(true){K--;if(K<0){return}this.drawScanline(_>>16,R>>16,k.pixels,Q,H);R+=J;_+=$;Q+=k.width2d}}this.drawScanline(L>>16,R>>16,k.pixels,Q,H);R+=J;L+=O;Q+=k.width2d}}}else{_=L<<=16;if(Q<0){_-=J*Q;L-=O*Q;Q=0}R<<=16;if(K<0){R-=$*K;K=0}if(J<O){G-=K;K-=Q;Q=this.lineOffset[Q];while(true){K--;if(K<0){while(true){G--;if(G<0){return}this.drawScanline(R>>16,L>>16,k.pixels,Q,H);R+=$;L+=O;Q+=k.width2d}}this.drawScanline(_>>16,L>>16,k.pixels,Q,H);_+=J;L+=O;Q+=k.width2d}}else{G-=K;K-=Q;Q=this.lineOffset[Q];while(true){K--;if(K<0){while(true){G--;if(G<0){return}this.drawScanline(L>>16,R>>16,k.pixels,Q,H);R+=$;L+=O;Q+=k.width2d}}this.drawScanline(L>>16,_>>16,k.pixels,Q,H);_+=J;L+=O;Q+=k.width2d}}}}};static fillTexturedTriangle=(_,R,L,G,K,Q,H,$,J,O,q,N,U,b,I,j,F,T,Y)=>{const u=this.getTexels(Y);this.opaque=!this.textureTranslucent[Y];const w=O-U;const h=q-I;const v=N-F;const n=b-O;const A=j-q;const P=T-N;let z=n*q-A*O<<14;const f=A*N-P*q<<8;const m=P*O-n*N<<5;let M=w*q-h*O<<14;const r=h*N-v*q<<8;const a=v*O-w*N<<5;let C=h*n-w*A<<14;const R0=v*A-h*P<<8;const e=w*P-v*n<<5;let L0=0;let J0=0;if(K!==G){L0=(R-_<<16)/(K-G)|0;J0=($-H<<16)/(K-G)|0}let Q0=0;let i=0;if(Q!==K){Q0=(L-R<<16)/(Q-K)|0;i=(J-$<<16)/(Q-K)|0}let k0=0;let $0=0;if(Q!==G){k0=(_-L<<16)/(G-Q)|0;$0=(H-J<<16)/(G-Q)|0}if(G<=K&&G<=Q){if(G<k.bottom){if(K>k.bottom){K=k.bottom}if(Q>k.bottom){Q=k.bottom}if(K<Q){L=_<<=16;J=H<<=16;if(G<0){L-=k0*G;_-=L0*G;J-=$0*G;H-=J0*G;G=0}R<<=16;$<<=16;if(K<0){R-=Q0*K;$-=i*K;K=0}const F0=G-this.centerY;z+=m*F0;M+=a*F0;C+=e*F0;z|=0;M|=0;C|=0;if(G!==K&&k0<L0||G===K&&k0>Q0){Q-=K;K-=G;G=this.lineOffset[G];while(true){K--;if(K<0){while(true){Q--;if(Q<0){return}this.drawTexturedScanline(L>>16,R>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,J>>8,$>>8);L+=k0;R+=Q0;J+=$0;$+=i;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(L>>16,_>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,J>>8,H>>8);L+=k0;_+=L0;J+=$0;H+=J0;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}else{Q-=K;K-=G;G=this.lineOffset[G];while(true){K--;if(K<0){while(true){Q--;if(Q<0){return}this.drawTexturedScanline(R>>16,L>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,$>>8,J>>8);L+=k0;R+=Q0;J+=$0;$+=i;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(_>>16,L>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,H>>8,J>>8);L+=k0;_+=L0;J+=$0;H+=J0;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}}else{R=_<<=16;$=H<<=16;if(G<0){R-=k0*G;_-=L0*G;$-=$0*G;H-=J0*G;G=0}L<<=16;J<<=16;if(Q<0){L-=Q0*Q;J-=i*Q;Q=0}const F0=G-this.centerY;z+=m*F0;M+=a*F0;C+=e*F0;z|=0;M|=0;C|=0;if((G===Q||k0>=L0)&&(G!==Q||Q0<=L0)){K-=Q;Q-=G;G=this.lineOffset[G];while(true){Q--;if(Q<0){while(true){K--;if(K<0){return}this.drawTexturedScanline(_>>16,L>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,H>>8,J>>8);L+=Q0;_+=L0;J+=i;H+=J0;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(_>>16,R>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,H>>8,$>>8);R+=k0;_+=L0;$+=$0;H+=J0;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}else{K-=Q;Q-=G;G=this.lineOffset[G];while(true){Q--;if(Q<0){while(true){K--;if(K<0){return}this.drawTexturedScanline(L>>16,_>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,J>>8,H>>8);L+=Q0;_+=L0;J+=i;H+=J0;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(R>>16,_>>16,k.pixels,G,u,0,0,z,M,C,f,r,R0,$>>8,H>>8);R+=k0;_+=L0;$+=$0;H+=J0;G+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}}}}else if(K<=Q){if(K<k.bottom){if(Q>k.bottom){Q=k.bottom}if(G>k.bottom){G=k.bottom}if(Q<G){_=R<<=16;H=$<<=16;if(K<0){_-=L0*K;R-=Q0*K;H-=J0*K;$-=i*K;K=0}L<<=16;J<<=16;if(Q<0){L-=k0*Q;J-=$0*Q;Q=0}const F0=K-this.centerY;z+=m*F0;M+=a*F0;C+=e*F0;z|=0;M|=0;C|=0;if(K!==Q&&L0<Q0||K===Q&&L0>k0){G-=Q;Q-=K;K=this.lineOffset[K];while(true){Q--;if(Q<0){while(true){G--;if(G<0){return}this.drawTexturedScanline(_>>16,L>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,H>>8,J>>8);_+=L0;L+=k0;H+=J0;J+=$0;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(_>>16,R>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,H>>8,$>>8);_+=L0;R+=Q0;H+=J0;$+=i;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}else{G-=Q;Q-=K;K=this.lineOffset[K];while(true){Q--;if(Q<0){while(true){G--;if(G<0){return}this.drawTexturedScanline(L>>16,_>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,J>>8,H>>8);_+=L0;L+=k0;H+=J0;J+=$0;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(R>>16,_>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,$>>8,H>>8);_+=L0;R+=Q0;H+=J0;$+=i;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}}else{L=R<<=16;J=$<<=16;if(K<0){L-=L0*K;R-=Q0*K;J-=J0*K;$-=i*K;K=0}_<<=16;H<<=16;if(G<0){_-=k0*G;H-=$0*G;G=0}const F0=K-this.centerY;z+=m*F0;M+=a*F0;C+=e*F0;z|=0;M|=0;C|=0;Q-=G;G-=K;K=this.lineOffset[K];if(L0<Q0){while(true){G--;if(G<0){while(true){Q--;if(Q<0){return}this.drawTexturedScanline(_>>16,R>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,H>>8,$>>8);_+=k0;R+=Q0;H+=$0;$+=i;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(L>>16,R>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,J>>8,$>>8);L+=L0;R+=Q0;J+=J0;$+=i;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}else{while(true){G--;if(G<0){while(true){Q--;if(Q<0){return}this.drawTexturedScanline(R>>16,_>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,$>>8,H>>8);_+=k0;R+=Q0;H+=$0;$+=i;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(R>>16,L>>16,k.pixels,K,u,0,0,z,M,C,f,r,R0,$>>8,J>>8);L+=L0;R+=Q0;J+=J0;$+=i;K+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}}}}else if(Q<k.bottom){if(G>k.bottom){G=k.bottom}if(K>k.bottom){K=k.bottom}if(G<K){R=L<<=16;$=J<<=16;if(Q<0){R-=Q0*Q;L-=k0*Q;$-=i*Q;J-=$0*Q;Q=0}_<<=16;H<<=16;if(G<0){_-=L0*G;H-=J0*G;G=0}const F0=Q-this.centerY;z+=m*F0;M+=a*F0;C+=e*F0;z|=0;M|=0;C|=0;K-=G;G-=Q;Q=this.lineOffset[Q];if(Q0<k0){while(true){G--;if(G<0){while(true){K--;if(K<0){return}this.drawTexturedScanline(R>>16,_>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,$>>8,H>>8);R+=Q0;_+=L0;$+=i;H+=J0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(R>>16,L>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,$>>8,J>>8);R+=Q0;L+=k0;$+=i;J+=$0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}else{while(true){G--;if(G<0){while(true){K--;if(K<0){return}this.drawTexturedScanline(_>>16,R>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,H>>8,$>>8);R+=Q0;_+=L0;$+=i;H+=J0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(L>>16,R>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,J>>8,$>>8);R+=Q0;L+=k0;$+=i;J+=$0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}}else{_=L<<=16;H=J<<=16;if(Q<0){_-=Q0*Q;L-=k0*Q;H-=i*Q;J-=$0*Q;Q=0}R<<=16;$<<=16;if(K<0){R-=L0*K;$-=J0*K;K=0}const F0=Q-this.centerY;z+=m*F0;M+=a*F0;C+=e*F0;z|=0;M|=0;C|=0;G-=K;K-=Q;Q=this.lineOffset[Q];if(Q0<k0){while(true){K--;if(K<0){while(true){G--;if(G<0){return}this.drawTexturedScanline(R>>16,L>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,$>>8,J>>8);R+=L0;L+=k0;$+=J0;J+=$0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(_>>16,L>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,H>>8,J>>8);_+=Q0;L+=k0;H+=i;J+=$0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}else{while(true){K--;if(K<0){while(true){G--;if(G<0){return}this.drawTexturedScanline(L>>16,R>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,J>>8,$>>8);R+=L0;L+=k0;$+=J0;J+=$0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}this.drawTexturedScanline(L>>16,_>>16,k.pixels,Q,u,0,0,z,M,C,f,r,R0,J>>8,H>>8);_+=Q0;L+=k0;H+=i;J+=$0;Q+=k.width2d;z+=m;M+=a;C+=e;z|=0;M|=0;C|=0}}}}};static drawTexturedScanline=(_,R,L,G,K,Q,H,$,J,O,q,N,U,b,I)=>{if(_>=R){return}let j;let F;if(this.clipX){j=(I-b)/(R-_)|0;if(R>k.boundX){R=k.boundX}if(_<0){b-=_*j;_=0}if(_>=R){return}F=R-_>>3;j<<=12}else{if(R-_>7){F=R-_>>3;j=(I-b)*this.reciprocal15[F]>>6}else{F=0;j=0}}b<<=9;G+=_;let T;let Y;let u;let w;let h;let v;let n;if(this.lowMemory&&K){T=0;Y=0;w=_-this.centerX;$=$+(q>>3)*w;J=J+(N>>3)*w;O=O+(U>>3)*w;$|=0;J|=0;O|=0;u=O>>12;if(u!==0){Q=$/u|0;H=J/u|0;if(Q<0){Q=0}else if(Q>4032){Q=4032}}$=$+q;J=J+N;O=O+U;$|=0;J|=0;O|=0;u=O>>12;if(u!==0){T=$/u|0;Y=J/u|0;if(T<7){T=7}else if(T>4032){T=4032}}h=T-Q>>3;v=Y-H>>3;Q+=b>>3&786432;n=b>>23;if(this.opaque){while(F-- >0){L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v;L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q=T;H=Y;$+=q;J+=N;O+=U;u=O>>12;if(u!==0){T=$/u|0;Y=J/u|0;if(T<7){T=7}else if(T>4032){T=4032}}h=T-Q>>3;v=Y-H>>3;b+=j;Q+=b>>3&786432;n=b>>23}F=R-_&7;while(F-- >0){L[G++]=K[(H&4032)+(Q>>6)]>>>n;Q+=h;H+=v}}else{while(F-- >0){let A;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G=G+1;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G=G+1;Q=T;H=Y;$+=q;J+=N;O+=U;$|=0;J|=0;O|=0;u=O>>12;if(u!==0){T=$/u|0;Y=J/u|0;if(T<7){T=7}else if(T>4032){T=4032}}h=T-Q>>3;v=Y-H>>3;b+=j;Q+=b>>3&786432;n=b>>23}F=R-_&7;while(F-- >0){let A;if((A=K[(H&4032)+(Q>>6)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v}}return}T=0;Y=0;w=_-this.centerX;$=$+(q>>3)*w;J=J+(N>>3)*w;O=O+(U>>3)*w;$|=0;J|=0;O|=0;u=O>>14;if(u!==0){Q=$/u|0;H=J/u|0;if(Q<0){Q=0}else if(Q>16256){Q=16256}}$=$+q;J=J+N;O=O+U;$|=0;J|=0;O|=0;u=O>>14;if(u!==0){T=$/u|0;Y=J/u|0;if(T<7){T=7}else if(T>16256){T=16256}}h=T-Q>>3;v=Y-H>>3;Q+=b&6291456;n=b>>23;if(this.opaque&&K){while(F-- >0){L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v;L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q=T;H=Y;$+=q;J+=N;O+=U;$|=0;J|=0;O|=0;u=O>>14;if(u!==0){T=$/u|0;Y=J/u|0;if(T<7){T=7}else if(T>16256){T=16256}}h=T-Q>>3;v=Y-H>>3;b+=j;Q+=b&6291456;n=b>>23}F=R-_&7;while(F-- >0){L[G++]=K[(H&16256)+(Q>>7)]>>>n;Q+=h;H+=v}return}while(F-- >0&&K){let A;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G=G+1;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q=T;H=Y;$+=q;J+=N;O+=U;$|=0;J|=0;O|=0;u=O>>14;if(u!==0){T=$/u|0;Y=J/u|0;if(T<7){T=7}else if(T>16256){T=16256}}h=T-Q>>3;v=Y-H>>3;b+=j;Q+=b&6291456;n=b>>23}F=R-_&7;while(F-- >0&&K){let A;if((A=K[(H&16256)+(Q>>7)]>>>n)!==0){L[G]=A}G++;Q+=h;H+=v}};static drawScanline=(_,R,L,G,K)=>{if(this.clipX){if(R>k.boundX){R=k.boundX}if(_<0){_=0}}if(_>=R){return}G+=_;let Q=R-_>>2;if(this.alpha===0){while(true){Q--;if(Q<0){Q=R-_&3;while(true){Q--;if(Q<0){return}L[G++]=K}}L[G++]=K;L[G++]=K;L[G++]=K;L[G++]=K}}const H=this.alpha;const $=256-this.alpha;K=((K&16711935)*$>>8&16711935)+((K&65280)*$>>8&65280);while(true){Q--;if(Q<0){Q=R-_&3;while(true){Q--;if(Q<0){return}L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280)}}L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280);L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280);L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280);L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280)}};static pushTexture=(_)=>{if(this.activeTexels[_]&&this.texelPool){this.texelPool[this.poolSize++]=this.activeTexels[_];this.activeTexels[_]=null}};static getTexels=(_)=>{this.textureCycle[_]=this.cycle++;if(this.activeTexels[_]){return this.activeTexels[_]}let R;if(this.poolSize>0&&this.texelPool){R=this.texelPool[--this.poolSize];this.texelPool[this.poolSize]=null}else{let K=0;let Q=-1;for(let H=0;H<this.textureCount;H++){if(this.activeTexels[H]&&(this.textureCycle[H]<K||Q===-1)){K=this.textureCycle[H];Q=H}}R=this.activeTexels[Q];this.activeTexels[Q]=null}this.activeTexels[_]=R;const L=this.textures[_];const G=this.texturePalette[_];if(!R||!L||!G){return null}if(this.lowMemory){this.textureTranslucent[_]=false;for(let K=0;K<4096;K++){const Q=R[K]=G[L.pixels[K]]&16316671;if(Q===0){this.textureTranslucent[_]=true}R[K+4096]=Q-(Q>>>3)&16316671;R[K+8192]=Q-(Q>>>2)&16316671;R[K+12288]=Q-(Q>>>2)-(Q>>>3)&16316671}}else{if(L.width===64){for(let K=0;K<128;K++){for(let Q=0;Q<128;Q++){R[Q+(K<<7|0)]=G[L.pixels[(Q>>1)+(K>>1<<6|0)]]}}}else{for(let K=0;K<16384;K++){R[K]=G[L.pixels[K]]}}this.textureTranslucent[_]=false;for(let K=0;K<16384;K++){R[K]&=16316671;const Q=R[K];if(Q===0){this.textureTranslucent[_]=true}R[K+16384]=Q-(Q>>>3)&16316671;R[K+32768]=Q-(Q>>>2)&16316671;R[K+49152]=Q-(Q>>>2)-(Q>>>3)&16316671}}return R}}class w0{image;width;height;ctx;paint;pixels;constructor(_,R,L=q0){this.ctx=L;this.image=this.ctx.getImageData(0,0,_,R);this.paint=new Uint32Array(this.image.data.buffer);this.pixels=new Int32Array(_*R);this.width=_;this.height=R;this.bind()}clear(){this.pixels.fill(0)}bind(){k.bind(this.pixels,this.width,this.height)}draw(_,R){this.#_();this.ctx.putImageData(this.image,_,R)}#_(){const _=this.pixels.length;const R=this.pixels;const L=this.paint;for(let G=0;G<_;G++){const K=R[G];L[G]=K>>16&255|(K>>8&255)<<8|(K&255)<<16|4278190080}}}class V8{slowestMS=0;averageMS=[];averageIndexMS=0;drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=true;resizeToFit=false;tfps=50;hasFocus=true;ingame=false;idleCycles=Date.now();mouseButton=0;mouseX=0;mouseY=0;mouseClickButton=0;mouseClickX=0;mouseClickY=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;input=null;touching=false;startedInViewport=false;startedInTabArea=false;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;constructor(_=false){u0.tabIndex=-1;q0.fillStyle="black";q0.fillRect(0,0,u0.width,u0.height);this.resizeToFit=_;if(this.resizeToFit){this.resize(window.innerWidth,window.innerHeight)}else{this.resize(u0.width,u0.height)}}get width(){return u0.width}get height(){return u0.height}resize=(_,R)=>{u0.width=_;u0.height=R;this.drawArea=new w0(_,R);B.init2D()};async run(){u0.addEventListener("resize",()=>{if(this.resizeToFit){this.resize(window.innerWidth,window.innerHeight)}},false);u0.onmousedown=this.onmousedown;u0.onmouseup=this.onmouseup;u0.onmouseenter=this.onmouseenter;u0.onmouseleave=this.onmouseleave;u0.onmousemove=this.onmousemove;u0.onfocus=this.onfocus;u0.onblur=this.onblur;if(this.isMobile){u0.ontouchstart=this.ontouchstart;u0.ontouchend=this.ontouchend;u0.ontouchmove=this.ontouchmove}else{u0.onkeydown=this.onkeydown;u0.onkeyup=this.onkeyup}u0.oncontextmenu=(Q)=>{Q.preventDefault()};window.oncontextmenu=(Q)=>{Q.preventDefault()};await this.showProgress(0,"Loading...");await this.load();for(let Q=0;Q<10;Q++){this.otim[Q]=performance.now()}let _;let R=0;let L=256;let G=1;let K=0;while(this.state>=0){if(this.state>0){this.state--;if(this.state===0){this.shutdown();return}}const Q=L;const H=G;L=300;G=1;_=performance.now();const $=this.otim[R];if($===0){L=Q;G=H}else if(_>$){L=this.deltime*2560/(_-$)|0}if(L<25){L=25}else if(L>256){L=256;G=this.deltime-(_-$)/10|0}this.otim[R]=_;R=(R+1)%10;if(G>1){for(let O=0;O<10;O++){if(this.otim[O]!==0){this.otim[O]+=G}}}if(G<this.mindel){G=this.mindel}await q1(G);while(K<256){await this.update();this.mouseClickButton=0;this.keyQueueReadPos=this.keyQueueWritePos;K+=L}K&=255;if(this.deltime>0){this.fps=L*1000/(this.deltime*256)|0}const J=performance.now();if(this.redrawScreen){this.refresh()}await this.draw();this.frameTime[this.fpos]=(performance.now()-J)/1000;this.fpos=(this.fpos+1)%this.frameTime.length;if(this.tfps<50){const O=1000/this.tfps-(performance.now()-_);if(O>0){await q1(O)}}}if(this.state===-1){this.shutdown()}}shutdown=()=>{this.state=-2};setFramerate=(_)=>{this.deltime=1000/_|0};setTargetedFramerate=(_)=>{this.tfps=Math.max(Math.min(50,_|0),0)};start=()=>{if(this.state>=0){this.state=0}};stop=()=>{if(this.state>=0){this.state=4000/this.deltime|0}};destroy=()=>{this.state=-1};async load(){}async update(){}async draw(){}async refresh(){}async showProgress(_,R){const L=this.width;const G=this.height;if(this.redrawScreen){q0.fillStyle="black";q0.fillRect(0,0,L,G);this.redrawScreen=false}const K=G/2-18;q0.fillStyle="rgb(140, 17, 17)";q0.rect((L/2|0)-152,K,304,34);q0.fillRect((L/2|0)-150,K+2,_*3,30);q0.fillStyle="black";q0.fillRect((L/2|0)-150+_*3,K+2,300-_*3,30);q0.font="bold 13px helvetica, sans-serif";q0.textAlign="center";q0.fillStyle="white";q0.fillText(R,L/2|0,K+22);await q1(5)}pollKey=()=>{let _=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos){_=this.keyQueue[this.keyQueueReadPos];this.keyQueueReadPos=this.keyQueueReadPos+1&127}return _};get ms(){const _=this.frameTime.length;let R=0;for(let G=0;G<_;G++){R+=this.frameTime[G]}const L=R/_*1000;if(L>this.slowestMS){this.slowestMS=L}this.averageMS[this.averageIndexMS]=L;this.averageIndexMS=(this.averageIndexMS+1)%250;return L}get msAvg(){return this.averageMS.reduce((_,R)=>_+R,0)/250}onkeydown=(_)=>{const R=_.key;this.idleCycles=Date.now();const L=E0[R];if(!L||_.code.length===0&&!_.isTrusted){return}const G=L.code;let K=L.ch;if(_.ctrlKey){if(K>=65&&K<=93||K==95){K-=65-1}else if(K>=97&&K<=122){K-=97-1}}if(K<30){K=0}if(G===E0["ArrowLeft"].code){K=1}else if(G===E0["ArrowRight"].code){K=2}else if(G===E0["ArrowUp"].code){K=3}else if(G===E0["ArrowDown"].code){K=4}else if(G===E0["Control"].code){K=5}else if(G===E0["Shift"].code){K=6}else if(G===E0["Alt"].code){K=7}else if(G===E0["Backspace"].code){K=8}else if(G===E0["Delete"].code){K=8}else if(G===E0["Tab"].code){K=9}else if(G===E0["Enter"].code){K=10}else if(G>=E0["F1"].code&&G<=E0["F12"].code){K=G+1008-E0["F1"].code}else if(G===E0["Home"].code){K=1000}else if(G===E0["End"].code){K=1001}else if(G===E0["PageUp"].code){K=1002}else if(G===E0["PageDown"].code){K=1003}if(K>0&&K<128){this.actionKey[K]=1}if(K>4){this.keyQueue[this.keyQueueWritePos]=K;this.keyQueueWritePos=this.keyQueueWritePos+1&127}if(S0.enabled){S0.keyPressed(K)}if(!P5.includes(R)){_.preventDefault()}};onkeyup=(_)=>{const R=_.key;this.idleCycles=Date.now();const L=E0[R];if(!L||_.code.length===0&&!_.isTrusted){return}const G=L.code;let K=L.ch;if(K<30){K=0}if(G===E0["ArrowLeft"].code){K=1}else if(G===E0["ArrowRight"].code){K=2}else if(G===E0["ArrowUp"].code){K=3}else if(G===E0["ArrowDown"].code){K=4}else if(G===E0["Control"].code){K=5}else if(G===E0["Shift"].code){K=6}else if(G===E0["Alt"].code){K=7}else if(G===E0["Backspace"].code){K=8}else if(G===E0["Delete"].code){K=8}else if(G===E0["Tab"].code){K=9}else if(G===E0["Enter"].code){K=10}else if(G>=E0["F1"].code&&G<=E0["F12"].code){K=G+1008-E0["F1"].code}else if(G===E0["Home"].code){K=1000}else if(G===E0["End"].code){K=1001}else if(G===E0["PageUp"].code){K=1002}else if(G===E0["PageDown"].code){K=1003}if(K>0&&K<128){this.actionKey[K]=0}if(S0.enabled){S0.keyReleased(K)}if(!P5.includes(R)){_.preventDefault()}};onmousedown=(_)=>{this.touching=false;if(_.clientX>0||_.clientY>0)this.setMousePosition(_);this.idleCycles=Date.now();this.mouseClickX=this.mouseX;this.mouseClickY=this.mouseY;if(this.isMobile&&!this.isCapacitor){if(this.insideChatInputArea()||this.insideUsernameArea()||this.inPasswordArea()){this.mouseClickButton=1;this.mouseButton=1;return}const R=_.timeStamp;if(R>=this.time+500){this.mouseClickButton=2;this.mouseButton=2}else{this.mouseClickButton=1;this.mouseButton=1}}else{if(_.button===2){this.mouseClickButton=2;this.mouseButton=2}else{this.mouseClickButton=1;this.mouseButton=1}}if(S0.enabled){S0.mousePressed(this.mouseClickX,this.mouseClickY,_.buttons)}};onmouseup=(_)=>{this.setMousePosition(_);this.idleCycles=Date.now();this.mouseButton=0;if(S0.enabled){S0.mouseReleased(_.buttons)}};onmouseenter=(_)=>{this.setMousePosition(_);if(S0.enabled){S0.mouseEntered()}};onmouseleave=(_)=>{this.setMousePosition(_);this.idleCycles=Date.now();this.mouseX=-1;this.mouseY=-1;this.mouseButton=0;this.mouseClickX=-1;this.mouseClickY=-1;if(S0.enabled){S0.mouseExited()}};onmousemove=(_)=>{this.setMousePosition(_);this.idleCycles=Date.now();if(S0.enabled){S0.mouseMoved(this.mouseX,this.mouseY)}};onfocus=(_)=>{this.hasFocus=true;this.redrawScreen=true;this.refresh();if(S0.enabled){S0.focusGained()}};onblur=(_)=>{this.hasFocus=false;for(let R=0;R<128;R++){this.actionKey[R]=0}if(S0.enabled){S0.focusLost()}};ontouchstart=(_)=>{if(!this.isMobile){return}if(this.input!==null){this.input.parentNode?.removeChild(this.input);this.input=null}this.touching=true;const R=_.changedTouches[0];const L=R.clientX|0;const G=R.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:L,clientY:G}));this.sx=this.nx=this.mx=R.screenX|0;this.sy=this.ny=this.my=R.screenY|0;this.time=_.timeStamp;this.startedInViewport=this.insideViewportArea();this.startedInTabArea=this.insideTabArea()};ontouchend=(_)=>{if(!this.isMobile||!this.touching){return}const R=_.changedTouches[0];const L=R.clientX|0;const G=R.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:L,clientY:G}));this.nx=R.screenX|0;this.ny=R.screenY|0;this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"}));this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"}));this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"}));this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"}));if(this.startedInViewport&&!this.insideViewportArea()){this.touching=false;return}else if(this.startedInTabArea&&!this.insideTabArea()){this.touching=false;return}else if(this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()){if(this.input!==null){if(this.input.parentNode?.contains(this.input)){this.input.parentNode?.removeChild(this.input)}this.input=null}const $=document.createElement("input");if(this.insideUsernameArea()){$.setAttribute("id","username");$.setAttribute("placeholder","Username")}else if(this.inPasswordArea()){$.setAttribute("id","password");$.setAttribute("placeholder","Password")}else if(this.insideChatInputArea()){$.setAttribute("id","chatinput");$.setAttribute("placeholder","Chatinput")}else if(this.insideChatPopupArea()){$.setAttribute("id","chatpopup");$.setAttribute("placeholder","Chatpopup")}if(this.isAndroid){$.setAttribute("type","password")}else{$.setAttribute("type",this.inPasswordArea()?"password":"text")}$.setAttribute("autofocus","autofocus");$.setAttribute("spellcheck","false");$.setAttribute("autocomplete","off");$.setAttribute("style",`position: fixed; left: ${L}px; top: ${G}px; width: 1px; height: 1px; opacity: 0;`);document.body.appendChild($);$.focus();$.click();if(this.isAndroid){$.oninput=(J)=>{if(!(J instanceof InputEvent)){return}const O=J;const q=O.data;if(q===null){return}if(O.inputType!=="insertText"){return}this.onkeydown(new KeyboardEvent("keydown",{key:q,code:q}))}}$.onkeydown=(J)=>{if(this.isAndroid){if(J.key==="Enter"||J.key==="Backspace"){this.onkeydown(new KeyboardEvent("keydown",{key:J.key,code:J.key}))}return}this.onkeydown(new KeyboardEvent("keydown",{key:J.key,code:J.key}))};$.onkeyup=(J)=>{if(this.isAndroid){if(J.key==="Enter"||J.key==="Backspace"){this.onkeyup(new KeyboardEvent("keyup",{key:J.key,code:J.key}))}return}this.onkeyup(new KeyboardEvent("keyup",{key:J.key,code:J.key}))};$.onfocus=(J)=>{this.input?.parentNode?.removeChild(this.input);this.input=null;this.onfocus(J)};this.input=$;this.touching=false;return}const K=_.timeStamp;const Q=K>=this.time+500;const H=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(Q&&!H){this.touching=true;this.onmousedown(new MouseEvent("mousedown",{buttons:2}))}else{this.mouseButton=0;this.touching=false}};ontouchmove=(_)=>{if(!this.isMobile||!this.touching){return}const R=_.changedTouches[0];const L=R.clientX|0;const G=R.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:L,clientY:G}));this.nx=R.screenX|0;this.ny=R.screenY|0;if(this.startedInViewport&&this.getViewportInterfaceId()===-1){if(this.mx-this.nx>0){this.rotate(2)}else if(this.mx-this.nx<0){this.rotate(0)}if(this.my-this.ny>0){this.rotate(3)}else if(this.my-this.ny<0){this.rotate(1)}}else if(this.startedInTabArea||this.getViewportInterfaceId()!==-1){this.onmousedown(new MouseEvent("mousedown",{buttons:1}))}this.mx=this.nx;this.my=this.ny};get isMobile(){const _=["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"];return _.some((R)=>navigator.userAgent.includes(R))}get isAndroid(){const _=["Android"];return _.some((R)=>navigator.userAgent.includes(R))}get isCapacitor(){const _=["Capacitor"];return _.some((R)=>navigator.userAgent.includes(R))}insideViewportArea=()=>{const _=8;const R=11;const L=_+512;const G=R+334;return this.ingame&&this.mouseX>=_&&this.mouseX<=L&&this.mouseY>=R&&this.mouseY<=G};insideChatInputArea=()=>{const _=11;const R=449;const L=_+495;const G=R+33;return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=_&&this.mouseX<=L&&this.mouseY>=R&&this.mouseY<=G};insideChatPopupArea=()=>{const _=11;const R=383;const L=_+495;const G=R+99;return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=_&&this.mouseX<=L&&this.mouseY>=R&&this.mouseY<=G};insideTabArea=()=>{const _=562;const R=231;const L=_+190;const G=R+261;return this.ingame&&this.mouseX>=_&&this.mouseX<=L&&this.mouseY>=R&&this.mouseY<=G};insideUsernameArea=()=>{const _=301;const R=262;const L=_+261;const G=R+17;return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=_&&this.mouseX<=L&&this.mouseY>=R&&this.mouseY<=G};inPasswordArea=()=>{const _=301;const R=279;const L=_+261;const G=R+17;return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=_&&this.mouseX<=L&&this.mouseY>=R&&this.mouseY<=G};rotate=(_)=>{if(_===0){this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"}));this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}))}else if(_===1){this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"}));this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}))}else if(_===2){this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"}));this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}))}else if(_===3){this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"}));this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))}};isFullScreen=()=>{return document.fullscreenElement!==null};setMousePosition=(_)=>{const R=789;const L=532;if(this.isFullScreen()){const G=_.target;const K=G.getBoundingClientRect();const Q=window.innerHeight/u0.height;const H=(window.innerWidth-u0.width*Q)/2;this.mouseX=this.mapCoord(_.clientX-K.left-H,0,u0.width*Q,0,R)|0;this.mouseY=this.mapCoord(_.clientY-K.top,0,u0.height*Q,0,L)|0}else{const G=u0.getBoundingClientRect();const K=u0.width/G.width;const Q=u0.height/G.height;this.mouseX=(_.clientX-G.left)*K|0;this.mouseY=(_.clientY-G.top)*Q|0}if(this.mouseX<0){this.mouseX=0}if(this.mouseY<0){this.mouseY=0}if(this.mouseX>R){this.mouseX=R}if(this.mouseY>L){this.mouseY=L}};mapCoord=(_,R,L,G,K)=>{return(_-R)*(K-G)/(L-R)+G}}class n0{id;debugname=null;constructor(_){this.id=_}decodeType(_){while(true){const R=_.g1;if(R===0){break}this.decode(R,_)}return this}}class W0 extends n0{static count=0;static instances=[];static unpack=(_)=>{const R=new p(_.read("flo.dat"));this.count=R.g2;for(let L=0;L<this.count;L++){this.instances[L]=new W0(L).decodeType(R)}};static hsl24to16=(_,R,L)=>{if(L>179){R=R/2|0}if(L>192){R=R/2|0}if(L>217){R=R/2|0}if(L>243){R=R/2|0}return((_/4|0)<<10)+((R/32|0)<<7)+(L/2|0)};static mulHSL=(_,R)=>{if(_===-1){return 12345678}R=R*(_&127)/128|0;if(R<2){R=2}else if(R>126){R=126}return(_&65408)+R};static adjustLightness=(_,R)=>{if(_===-2){return 12345678}if(_===-1){if(R<0){R=0}else if(R>127){R=127}return 127-R}else{R=R*(_&127)/128|0;if(R<2){R=2}else if(R>126){R=126}return(_&65408)+R}};rgb=0;texture=-1;opcode3=false;occlude=true;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;decode(_,R){if(_===1){this.rgb=R.g3;this.setColor(this.rgb)}else if(_===2){this.texture=R.g1}else if(_===3){this.opcode3=true}else if(_===5){this.occlude=false}else if(_===6){this.debugname=R.gjstr}else{}}setColor(_){const R=(_>>16&255)/256;const L=(_>>8&255)/256;const G=(_&255)/256;let K=R;if(L<R){K=L}if(G<K){K=G}let Q=R;if(L>R){Q=L}if(G>Q){Q=G}let H=0;let $=0;const J=(K+Q)/2;if(K!==Q){if(J<0.5){$=(Q-K)/(Q+K)}if(J>=0.5){$=(Q-K)/(2-Q-K)}if(R===Q){H=(L-G)/(Q-K)}else if(L===Q){H=(G-R)/(Q-K)+2}else if(G===Q){H=(R-L)/(Q-K)+4}}H/=6;this.hue=H*256|0;this.saturation=$*256|0;this.lightness=J*256|0;if(this.saturation<0){this.saturation=0}else if(this.saturation>255){this.saturation=255}if(this.lightness<0){this.lightness=0}else if(this.lightness>255){this.lightness=255}if(J>0.5){this.luminance=(1-J)*$*512|0}else{this.luminance=J*$*512|0}if(this.luminance<1){this.luminance=1}this.chroma=H*this.luminance|0;let O=this.hue+(Math.random()*16|0)-8;if(O<0){O=0}else if(O>255){O=255}let q=this.saturation+(Math.random()*48|0)-24;if(q<0){q=0}else if(q>255){q=255}let N=this.lightness+(Math.random()*48|0)-24;if(N<0){N=0}else if(N>255){N=255}this.hsl=W0.hsl24to16(O,q,N)}}class B1{static instances=[];static unpack=(_)=>{const R=new p(_.read("base_head.dat"));const L=new p(_.read("base_type.dat"));const G=new p(_.read("base_label.dat"));const K=R.g2;R.pos+=2;for(let Q=0;Q<K;Q++){const H=R.g2;const $=R.g1;const J=new Uint8Array($);const O=new l($,null);for(let q=0;q<$;q++){J[q]=L.g1;const N=G.g1;const U=new Uint8Array(N);for(let b=0;b<N;b++){U[b]=G.g1}O[q]=U}this.instances[H]=new B1;this.instances[H].length=$;this.instances[H].types=J;this.instances[H].labels=O}};length=0;types=null;labels=null}class G1{static instances=[];static unpack=(_)=>{const R=new p(_.read("frame_head.dat"));const L=new p(_.read("frame_tran1.dat"));const G=new p(_.read("frame_tran2.dat"));const K=new p(_.read("frame_del.dat"));const Q=R.g2;R.pos+=2;const H=new Int32Array(500);const $=new Int32Array(500);const J=new Int32Array(500);const O=new Int32Array(500);for(let q=0;q<Q;q++){const N=R.g2;const U=this.instances[N]=new G1;U.delay=K.g1;const b=R.g2;const I=B1.instances[b];U.base=I;const j=R.g1;let F=-1;let T=0;for(let Y=0;Y<j;Y++){if(!I.types){throw new Error("SeqBase not loaded!!!")}const u=L.g1;if(u>0){if(I.types[Y]!==0){for(let h=Y-1;h>F;h--){if(I.types[h]===0){H[T]=h;$[T]=0;J[T]=0;O[T]=0;T++;break}}}H[T]=Y;let w=0;if(I.types[H[T]]===3){w=128}if((u&1)===0){$[T]=w}else{$[T]=G.gsmart}if((u&2)===0){J[T]=w}else{J[T]=G.gsmart}if((u&4)===0){O[T]=w}else{O[T]=G.gsmart}F=Y;T++}}U.length=T;U.bases=new Int32Array(T);U.x=new Int32Array(T);U.y=new Int32Array(T);U.z=new Int32Array(T);for(let Y=0;Y<T;Y++){U.bases[Y]=H[Y];U.x[Y]=$[Y];U.y[Y]=J[Y];U.z[Y]=O[Y]}}};delay=0;base=null;length=0;bases=null;x=null;y=null;z=null}class G0 extends n0{static count=0;static instances=[];static unpack=(_)=>{const R=new p(_.read("seq.dat"));this.count=R.g2;for(let L=0;L<this.count;L++){const G=new G0(L).decodeType(R);if(G.frameCount===0){G.frameCount=1;G.frames=new Int16Array(1);G.frames[0]=-1;G.iframes=new Int16Array(1);G.iframes[0]=-1;G.delay=new Int16Array(1);G.delay[0]=-1}this.instances[L]=G}};frameCount=0;frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=false;priority=5;righthand=-1;lefthand=-1;replaycount=99;duration=0;decode(_,R){if(_===1){this.frameCount=R.g1;this.frames=new Int16Array(this.frameCount);this.iframes=new Int16Array(this.frameCount);this.delay=new Int16Array(this.frameCount);for(let L=0;L<this.frameCount;L++){this.frames[L]=R.g2;this.iframes[L]=R.g2;if(this.iframes[L]===65535){this.iframes[L]=-1}this.delay[L]=R.g2;if(this.delay[L]===0){this.delay[L]=G1.instances[this.frames[L]].delay}if(this.delay[L]===0){this.delay[L]=1}this.duration+=this.delay[L]}}else if(_===2){this.replayoff=R.g2}else if(_===3){const L=R.g1;this.walkmerge=new Int32Array(L+1);for(let G=0;G<L;G++){this.walkmerge[G]=R.g1}this.walkmerge[L]=9999999}else if(_===4){this.stretches=true}else if(_===5){this.priority=R.g1}else if(_===6){this.righthand=R.g2}else if(_===7){this.lefthand=R.g2}else if(_===8){this.replaycount=R.g1}else{}}}class Y8{bucketCount;buckets;constructor(_){this.buckets=[];this.bucketCount=_;for(let R=0;R<_;R++){this.buckets[R]=new D0}}get(_){const R=this.buckets[Number(_&BigInt(this.bucketCount-1))];const L=R.next;if(!L){return null}for(let G=R.next;G!==R;G=G.next){if(!G){continue}if(G.key===_){return G}}return null}put(_,R){if(R.prev){R.unlink()}const L=this.buckets[Number(_&BigInt(this.bucketCount-1))];R.prev=L.prev;R.next=L;if(R.prev){R.prev.next=R}R.next.prev=R;R.key=_}}class Z8{head;constructor(){this.head=new x0}push(_){if(_.prev2){_.uncache()}_.prev2=this.head.prev2;_.next2=this.head;if(_.prev2){_.prev2.next2=_}_.next2.prev2=_}pop(){const _=this.head.next2;if(_===this.head){return null}else{_?.uncache();return _}}}class s0{capacity;hashtable;history;available;constructor(_){this.capacity=_;this.available=_;this.hashtable=new Y8(1024);this.history=new Z8}get(_){const R=this.hashtable.get(_);if(R){this.history.push(R)}return R}put(_,R){if(this.available===0){const L=this.history.pop();L?.unlink();L?.uncache()}else{this.available--}this.hashtable.put(_,R);this.history.push(R)}clear(){const _=this.history.pop();if(!_){this.available=this.capacity;return}_.unlink();_.uncache()}}class b0{static WALL=0;static WALL_DECOR=1;static GROUND=2;static GROUND_DECOR=3}class y{static WALL_STRAIGHT=new y(0,b0.WALL);static WALL_DIAGONAL_CORNER=new y(1,b0.WALL);static WALL_L=new y(2,b0.WALL);static WALL_SQUARE_CORNER=new y(3,b0.WALL);static WALLDECOR_STRAIGHT_NOOFFSET=new y(4,b0.WALL_DECOR);static WALLDECOR_STRAIGHT_OFFSET=new y(5,b0.WALL_DECOR);static WALLDECOR_DIAGONAL_OFFSET=new y(6,b0.WALL_DECOR);static WALLDECOR_DIAGONAL_NOOFFSET=new y(7,b0.WALL_DECOR);static WALLDECOR_DIAGONAL_BOTH=new y(8,b0.WALL_DECOR);static WALL_DIAGONAL=new y(9,b0.GROUND);static CENTREPIECE_STRAIGHT=new y(10,b0.GROUND);static CENTREPIECE_DIAGONAL=new y(11,b0.GROUND);static ROOF_STRAIGHT=new y(12,b0.GROUND);static ROOF_DIAGONAL_WITH_ROOFEDGE=new y(13,b0.GROUND);static ROOF_DIAGONAL=new y(14,b0.GROUND);static ROOF_L_CONCAVE=new y(15,b0.GROUND);static ROOF_L_CONVEX=new y(16,b0.GROUND);static ROOF_FLAT=new y(17,b0.GROUND);static ROOFEDGE_STRAIGHT=new y(18,b0.GROUND);static ROOFEDGE_DIAGONAL_CORNER=new y(19,b0.GROUND);static ROOFEDGE_L=new y(20,b0.GROUND);static ROOFEDGE_SQUARE_CORNER=new y(21,b0.GROUND);static GROUND_DECOR=new y(22,b0.GROUND_DECOR);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(_){const R=this.values();for(let L=0;L<R.length;L++){const G=R[L];if(G.id===_){return G}}throw Error("shape not found")}id;layer;constructor(_,R){this.id=_;this.layer=R}}class x{static WEST=0;static NORTH=1;static EAST=2;static SOUTH=3}class u8{vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColorsOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1;data=null}class w8{x=0;y=0;z=0;w=0}class E extends x0{static metadata=null;static head=null;static face1=null;static face2=null;static face3=null;static face4=null;static face5=null;static point1=null;static point2=null;static point3=null;static point4=null;static point5=null;static vertex1=null;static vertex2=null;static axis=null;static faceClippedX=new l(4096,false);static faceNearClipped=new l(4096,false);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new J1(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new J1(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColor=new Int32Array(10);static baseX=0;static baseY=0;static baseZ=0;static checkHover=false;static mouseX=0;static mouseY=0;static pickedCount=0;static pickedBitsets=new Int32Array(1000);static checkHoverFace=false;static unpack(_){try{E.head=new p(_.read("ob_head.dat"));E.face1=new p(_.read("ob_face1.dat"));E.face2=new p(_.read("ob_face2.dat"));E.face3=new p(_.read("ob_face3.dat"));E.face4=new p(_.read("ob_face4.dat"));E.face5=new p(_.read("ob_face5.dat"));E.point1=new p(_.read("ob_point1.dat"));E.point2=new p(_.read("ob_point2.dat"));E.point3=new p(_.read("ob_point3.dat"));E.point4=new p(_.read("ob_point4.dat"));E.point5=new p(_.read("ob_point5.dat"));E.vertex1=new p(_.read("ob_vertex1.dat"));E.vertex2=new p(_.read("ob_vertex2.dat"));E.axis=new p(_.read("ob_axis.dat"));E.head.pos=0;E.point1.pos=0;E.point2.pos=0;E.point3.pos=0;E.point4.pos=0;E.vertex1.pos=0;E.vertex2.pos=0;const R=E.head.g2;E.metadata=new l(R+100,null);let L=0;let G=0;let K=0;let Q=0;let H=0;let $=0;let J=0;for(let O=0;O<R;O++){const q=E.head.g2;const N=new u8;N.vertexCount=E.head.g2;N.faceCount=E.head.g2;N.texturedFaceCount=E.head.g1;N.vertexFlagsOffset=E.point1.pos;N.vertexXOffset=E.point2.pos;N.vertexYOffset=E.point3.pos;N.vertexZOffset=E.point4.pos;N.faceVerticesOffset=E.vertex1.pos;N.faceOrientationsOffset=E.vertex2.pos;const U=E.head.g1;const b=E.head.g1;const I=E.head.g1;const j=E.head.g1;const F=E.head.g1;for(let T=0;T<N.vertexCount;T++){const Y=E.point1.g1;if((Y&1)!==0){E.point2.gsmart}if((Y&2)!==0){E.point3.gsmart}if((Y&4)!==0){E.point4.gsmart}}for(let T=0;T<N.faceCount;T++){const Y=E.vertex2.g1;if(Y===1){E.vertex1.gsmart;E.vertex1.gsmart}E.vertex1.gsmart}N.faceColorsOffset=K;K+=N.faceCount*2;if(U===1){N.faceInfosOffset=Q;Q+=N.faceCount}if(b===255){N.facePrioritiesOffset=H;H+=N.faceCount}else{N.facePrioritiesOffset=-b-1}if(I===1){N.faceAlphasOffset=$;$+=N.faceCount}if(j===1){N.faceLabelsOffset=J;J+=N.faceCount}if(F===1){N.vertexLabelsOffset=G;G+=N.vertexCount}N.faceTextureAxisOffset=L;L+=N.texturedFaceCount;E.metadata[q]=N}}catch(R){}}static unpack317(_,R){if(E.metadata===null){E.metadata=[]}if(_===null){const I=new u8;I.vertexCount=0;I.faceCount=0;I.texturedFaceCount=0;E.metadata[R]=I;return}const L=new p(_);L.pos=L.length-18;const G=new u8;G.data=_;G.vertexCount=L.g2;G.faceCount=L.g2;G.texturedFaceCount=L.g1;E.metadata[R]=G;const K=L.g1;const Q=L.g1;const H=L.g1;const $=L.g1;const J=L.g1;const O=L.g2;const q=L.g2;const N=L.g2;const U=L.g2;let b=0;G.vertexFlagsOffset=b;b+=G.vertexCount;G.faceOrientationsOffset=b;b+=G.faceCount;G.facePrioritiesOffset=b;if(Q===255){b+=G.faceCount}else{G.facePrioritiesOffset=-Q-1}G.faceLabelsOffset=b;if($===1){b+=G.faceCount}else{G.faceLabelsOffset=-1}G.faceInfosOffset=b;if(K===1){b+=G.faceCount}else{G.faceInfosOffset=-1}G.vertexLabelsOffset=b;if(J===1){b+=G.vertexCount}else{G.vertexLabelsOffset=-1}G.faceAlphasOffset=b;if(H===1){b+=G.faceCount}else{G.faceAlphasOffset=-1}G.faceVerticesOffset=b;b+=U;G.faceColorsOffset=b;b+=G.faceCount*2;G.faceTextureAxisOffset=b;b+=G.texturedFaceCount*6;G.vertexXOffset=b;b+=O;G.vertexYOffset=b;b+=q;G.vertexZOffset=b;b+=N}static mulColorLightness(_,R,L){if((L&2)===2){if(R<0){R=0}else if(R>127){R=127}return 127-R}R=R*(_&127)>>7;if(R<2){R=2}else if(R>126){R=126}return(_&65408)+R}static modelCopyFaces=(_,R,L)=>{const G=_.vertexCount;const K=_.faceCount;const Q=_.texturedFaceCount;let H;if(R){H=new Int32Array(G);for(let b=0;b<G;b++){H[b]=_.vertexY[b]}}else{H=_.vertexY}let $;let J;let O;let q;let N=null;let U=null;if(L){$=new Int32Array(K);J=new Int32Array(K);O=new Int32Array(K);for(let b=0;b<K;b++){if(_.faceColorA){$[b]=_.faceColorA[b]}if(_.faceColorB){J[b]=_.faceColorB[b]}if(_.faceColorC){O[b]=_.faceColorC[b]}}q=new Int32Array(K);if(!_.faceInfo){for(let b=0;b<K;b++){q[b]=0}}else{for(let b=0;b<K;b++){q[b]=_.faceInfo[b]}}N=new l(G,null);for(let b=0;b<G;b++){const I=N[b]=new w8;if(_.vertexNormal){const j=_.vertexNormal[b];if(j){I.x=j.x;I.y=j.y;I.z=j.z;I.w=j.w}}}U=_.vertexNormalOriginal}else{$=_.faceColorA;J=_.faceColorB;O=_.faceColorC;q=_.faceInfo}return new E({vertexCount:G,vertexX:_.vertexX,vertexY:H,vertexZ:_.vertexZ,faceCount:K,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:$,faceColorB:J,faceColorC:O,faceInfo:q,facePriority:_.facePriority,faceAlpha:_.faceAlpha,faceColor:_.faceColor,priority:_.priority,texturedFaceCount:Q,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,minX:_.minX,maxX:_.maxX,minZ:_.minZ,maxZ:_.maxZ,radius:_.radius,minY:_.minY,maxY:_.maxY,maxDepth:_.maxDepth,minDepth:_.minDepth,vertexNormal:N,vertexNormalOriginal:U})};static modelShareColored=(_,R,L,G)=>{const K=_.vertexCount;const Q=_.faceCount;const H=_.texturedFaceCount;let $;let J;let O;if(G){$=_.vertexX;J=_.vertexY;O=_.vertexZ}else{$=new Int32Array(K);J=new Int32Array(K);O=new Int32Array(K);for(let U=0;U<K;U++){$[U]=_.vertexX[U];J[U]=_.vertexY[U];O[U]=_.vertexZ[U]}}let q;if(R){q=_.faceColor}else{q=new Int32Array(Q);for(let U=0;U<Q;U++){if(_.faceColor){q[U]=_.faceColor[U]}}}let N;if(L){N=_.faceAlpha}else{N=new Int32Array(Q);if(!_.faceAlpha){for(let U=0;U<Q;U++){N[U]=0}}else{for(let U=0;U<Q;U++){N[U]=_.faceAlpha[U]}}}return new E({vertexCount:K,vertexX:$,vertexY:J,vertexZ:O,faceCount:Q,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:N,faceColor:q,priority:_.priority,texturedFaceCount:H,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,vertexLabel:_.vertexLabel,faceLabel:_.faceLabel})};static modelShareAlpha=(_,R)=>{const L=_.vertexCount;const G=_.faceCount;const K=_.texturedFaceCount;const Q=new Int32Array(L);const H=new Int32Array(L);const $=new Int32Array(L);for(let O=0;O<L;O++){Q[O]=_.vertexX[O];H[O]=_.vertexY[O];$[O]=_.vertexZ[O]}let J;if(R){J=_.faceAlpha}else{J=new Int32Array(G);if(!_.faceAlpha){for(let O=0;O<G;O++){J[O]=0}}else{for(let O=0;O<G;O++){J[O]=_.faceAlpha[O]}}}return new E({vertexCount:L,vertexX:Q,vertexY:H,vertexZ:$,faceCount:G,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:_.faceColorA,faceColorB:_.faceColorB,faceColorC:_.faceColorC,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:J,faceColor:_.faceColor,priority:_.priority,texturedFaceCount:K,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,labelVertices:_.labelVertices,labelFaces:_.labelFaces})};static modelFromModelsBounds=(_,R)=>{let L=false;let G=false;let K=false;let Q=false;let H=0;let $=0;let J=0;let O=-1;for(let f=0;f<R;f++){const m=_[f];if(m){H+=m.vertexCount;$+=m.faceCount;J+=m.texturedFaceCount;L||=m.faceInfo!==null;if(!m.facePriority){if(O===-1){O=m.priority}if(O!==m.priority){G=true}}else{G=true}K||=m.faceAlpha!==null;Q||=m.faceColor!==null}}const q=new Int32Array(H);const N=new Int32Array(H);const U=new Int32Array(H);const b=new Int32Array($);const I=new Int32Array($);const j=new Int32Array($);const F=new Int32Array($);const T=new Int32Array($);const Y=new Int32Array($);const u=new Int32Array(J);const w=new Int32Array(J);const h=new Int32Array(J);let v=null;if(L){v=new Int32Array($)}let n=null;if(G){n=new Int32Array($)}let A=null;if(K){A=new Int32Array($)}let P=null;if(Q){P=new Int32Array($)}H=0;$=0;J=0;for(let f=0;f<R;f++){const m=_[f];if(m){const M=H;for(let r=0;r<m.vertexCount;r++){q[H]=m.vertexX[r];N[H]=m.vertexY[r];U[H]=m.vertexZ[r];H++}for(let r=0;r<m.faceCount;r++){b[$]=m.faceVertexA[r]+M;I[$]=m.faceVertexB[r]+M;j[$]=m.faceVertexC[r]+M;if(m.faceColorA){F[$]=m.faceColorA[r]}if(m.faceColorB){T[$]=m.faceColorB[r]}if(m.faceColorC){Y[$]=m.faceColorC[r]}if(L){if(!m.faceInfo){if(v){v[$]=0}}else{if(v){v[$]=m.faceInfo[r]}}}if(G){if(!m.facePriority){if(n){n[$]=m.priority}}else{if(n){n[$]=m.facePriority[r]}}}if(K){if(!m.faceAlpha){if(A){A[$]=0}}else{if(A){A[$]=m.faceAlpha[r]}}}if(Q&&m.faceColor){if(P){P[$]=m.faceColor[r]}}$++}for(let r=0;r<m.texturedFaceCount;r++){u[J]=m.texturedVertexA[r]+M;w[J]=m.texturedVertexB[r]+M;h[J]=m.texturedVertexC[r]+M;J++}}}const z=new E({vertexCount:H,vertexX:q,vertexY:N,vertexZ:U,faceCount:$,faceVertexA:b,faceVertexB:I,faceVertexC:j,faceColorA:F,faceColorB:T,faceColorC:Y,faceInfo:v,facePriority:n,faceAlpha:A,faceColor:P,priority:O,texturedFaceCount:J,texturedVertexA:u,texturedVertexB:w,texturedVertexC:h});z.calculateBoundsCylinder();return z};static modelFromModels=(_,R)=>{let L=false;let G=false;let K=false;let Q=false;let H=0;let $=0;let J=0;let O=-1;for(let z=0;z<R;z++){const f=_[z];if(f){H+=f.vertexCount;$+=f.faceCount;J+=f.texturedFaceCount;L||=f.faceInfo!==null;if(!f.facePriority){if(O===-1){O=f.priority}if(O!==f.priority){G=true}}else{G=true}K||=f.faceAlpha!==null;Q||=f.faceLabel!==null}}const q=new Int32Array(H);const N=new Int32Array(H);const U=new Int32Array(H);const b=new Int32Array(H);const I=new Int32Array($);const j=new Int32Array($);const F=new Int32Array($);const T=new Int32Array(J);const Y=new Int32Array(J);const u=new Int32Array(J);let w=null;if(L){w=new Int32Array($)}let h=null;if(G){h=new Int32Array($)}let v=null;if(K){v=new Int32Array($)}let n=null;if(Q){n=new Int32Array($)}const A=new Int32Array($);H=0;$=0;J=0;const P=(z,f,m,M,r,a,C)=>{let R0=-1;const e=z.vertexX[f];const L0=z.vertexY[f];const J0=z.vertexZ[f];for(let Q0=0;Q0<C;Q0++){if(e===m[Q0]&&L0===M[Q0]&&J0===r[Q0]){R0=Q0;break}}if(R0===-1){m[C]=e;M[C]=L0;r[C]=J0;if(a&&z.vertexLabel){a[C]=z.vertexLabel[f]}R0=C++}return{vertex:R0,vertexCount:C}};for(let z=0;z<R;z++){const f=_[z];if(f){for(let m=0;m<f.faceCount;m++){if(L){if(!f.faceInfo){if(w){w[$]=0}}else{if(w){w[$]=f.faceInfo[m]}}}if(G){if(!f.facePriority){if(h){h[$]=f.priority}}else{if(h){h[$]=f.facePriority[m]}}}if(K){if(!f.faceAlpha){if(v){v[$]=0}}else{if(v){v[$]=f.faceAlpha[m]}}}if(Q&&f.faceLabel){if(n){n[$]=f.faceLabel[m]}}if(f.faceColor){A[$]=f.faceColor[m]}const M=P(f,f.faceVertexA[m],q,N,U,b,H);H=M.vertexCount;const r=P(f,f.faceVertexB[m],q,N,U,b,H);H=r.vertexCount;const a=P(f,f.faceVertexC[m],q,N,U,b,H);H=a.vertexCount;I[$]=M.vertex;j[$]=r.vertex;F[$]=a.vertex;$++}for(let m=0;m<f.texturedFaceCount;m++){const M=P(f,f.texturedVertexA[m],q,N,U,b,H);H=M.vertexCount;const r=P(f,f.texturedVertexB[m],q,N,U,b,H);H=r.vertexCount;const a=P(f,f.texturedVertexC[m],q,N,U,b,H);H=a.vertexCount;T[J]=M.vertex;Y[J]=r.vertex;u[J]=a.vertex;J++}}}return new E({vertexCount:H,vertexX:q,vertexY:N,vertexZ:U,faceCount:$,faceVertexA:I,faceVertexB:j,faceVertexC:F,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:w,facePriority:h,faceAlpha:v,faceColor:A,priority:O,texturedFaceCount:J,texturedVertexA:T,texturedVertexB:Y,texturedVertexC:u,vertexLabel:b,faceLabel:n})};static model=(_)=>{if(!E.metadata){throw new Error("cant loading model metadata!!!!!")}const R=E.metadata[_];if(!R){throw new Error("cant loading model metadata!!!!!")}if(!E.head||!E.face1||!E.face2||!E.face3||!E.face4||!E.face5||!E.point1||!E.point2||!E.point3||!E.point4||!E.point5||!E.vertex1||!E.vertex2||!E.axis){throw new Error("cant loading model!!!!!")}const L=R.vertexCount;const G=R.faceCount;const K=R.texturedFaceCount;const Q=new Int32Array(L);const H=new Int32Array(L);const $=new Int32Array(L);const J=new Int32Array(G);const O=new Int32Array(G);const q=new Int32Array(G);const N=new Int32Array(K);const U=new Int32Array(K);const b=new Int32Array(K);let I=null;if(R.vertexLabelsOffset>=0){I=new Int32Array(L)}let j=null;if(R.faceInfosOffset>=0){j=new Int32Array(G)}let F=null;let T=0;if(R.facePrioritiesOffset>=0){F=new Int32Array(G)}else{T=-R.facePrioritiesOffset-1}let Y=null;if(R.faceAlphasOffset>=0){Y=new Int32Array(G)}let u=null;if(R.faceLabelsOffset>=0){u=new Int32Array(G)}const w=new Int32Array(G);E.point1.pos=R.vertexFlagsOffset;E.point2.pos=R.vertexXOffset;E.point3.pos=R.vertexYOffset;E.point4.pos=R.vertexZOffset;E.point5.pos=R.vertexLabelsOffset;let h=0;let v=0;let n=0;let A;let P;let z;for(let m=0;m<L;m++){const M=E.point1.g1;A=0;if((M&1)!==0){A=E.point2.gsmart}P=0;if((M&2)!==0){P=E.point3.gsmart}z=0;if((M&4)!==0){z=E.point4.gsmart}Q[m]=h+A;H[m]=v+P;$[m]=n+z;h=Q[m];v=H[m];n=$[m];if(I){I[m]=E.point5.g1}}E.face1.pos=R.faceColorsOffset;E.face2.pos=R.faceInfosOffset;E.face3.pos=R.facePrioritiesOffset;E.face4.pos=R.faceAlphasOffset;E.face5.pos=R.faceLabelsOffset;for(let m=0;m<G;m++){w[m]=E.face1.g2;if(j){j[m]=E.face2.g1}if(F){F[m]=E.face3.g1}if(Y){Y[m]=E.face4.g1}if(u){u[m]=E.face5.g1}}E.vertex1.pos=R.faceVerticesOffset;E.vertex2.pos=R.faceOrientationsOffset;A=0;P=0;z=0;let f=0;for(let m=0;m<G;m++){const M=E.vertex2.g1;if(M===1){A=E.vertex1.gsmart+f;f=A;P=E.vertex1.gsmart+f;f=P;z=E.vertex1.gsmart+f;f=z}else if(M===2){P=z;z=E.vertex1.gsmart+f;f=z}else if(M===3){A=z;z=E.vertex1.gsmart+f;f=z}else if(M===4){const r=A;A=P;P=r;z=E.vertex1.gsmart+f;f=z}J[m]=A;O[m]=P;q[m]=z}E.axis.pos=R.faceTextureAxisOffset*6;for(let m=0;m<K;m++){N[m]=E.axis.g2;U[m]=E.axis.g2;b[m]=E.axis.g2}return new E({vertexCount:L,vertexX:Q,vertexY:H,vertexZ:$,faceCount:G,faceVertexA:J,faceVertexB:O,faceVertexC:q,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:j,facePriority:F,faceAlpha:Y,faceColor:w,priority:T,texturedFaceCount:K,texturedVertexA:N,texturedVertexB:U,texturedVertexC:b,vertexLabel:I,faceLabel:u})};static model317=(_,R)=>{if(!E.metadata||!E.metadata[R]){throw new Error("No model metadata")}const L=E.metadata[R];L.data=_;if(!L.data.length){throw new Error("No model data")}const G=L.vertexCount;const K=L.faceCount;const Q=L.texturedFaceCount;const H=new Int32Array(G);const $=new Int32Array(G);const J=new Int32Array(G);const O=new Int32Array(K);const q=new Int32Array(K);const N=new Int32Array(K);const U=new Int32Array(Q);const b=new Int32Array(Q);const I=new Int32Array(Q);let j=null;if(L.vertexLabelsOffset>=0){j=new Int32Array(G)}let F=null;if(L.faceInfosOffset>=0){F=new Int32Array(K)}let T=null;let Y=0;if(L.facePrioritiesOffset>=0){T=new Int32Array(K)}else{Y=-L.facePrioritiesOffset-1}let u=null;if(L.faceAlphasOffset>=0){u=new Int32Array(K)}let w=null;if(L.faceLabelsOffset>=0){w=new Int32Array(K)}const h=new Int32Array(K);const v=new p(L.data);v.pos=L.vertexFlagsOffset;const n=new p(L.data);n.pos=L.vertexXOffset;const A=new p(L.data);A.pos=L.vertexYOffset;const P=new p(L.data);P.pos=L.vertexZOffset;const z=new p(L.data);z.pos=L.vertexLabelsOffset;let f=0;let m=0;let M=0;let r;let a;let C;for(let T0=0;T0<G;T0++){const L1=v.g1;r=0;if((L1&1)!==0){r=n.gsmart}a=0;if((L1&2)!==0){a=A.gsmart}C=0;if((L1&4)!==0){C=P.gsmart}H[T0]=f+r;$[T0]=m+a;J[T0]=M+C;f=H[T0];m=$[T0];M=J[T0];if(j){j[T0]=z.g1}}const R0=new p(L.data);R0.pos=L.faceColorsOffset;const e=new p(L.data);e.pos=L.faceInfosOffset;const L0=new p(L.data);L0.pos=L.facePrioritiesOffset;const J0=new p(L.data);J0.pos=L.faceAlphasOffset;const Q0=new p(L.data);Q0.pos=L.faceLabelsOffset;for(let T0=0;T0<K;T0++){h[T0]=R0.g2;if(F){F[T0]=e.g1}if(T){T[T0]=L0.g1}if(u){u[T0]=J0.g1}if(w){w[T0]=Q0.g1}}const i=new p(L.data);i.pos=L.faceVerticesOffset;const k0=new p(L.data);k0.pos=L.faceOrientationsOffset;r=0;a=0;C=0;let $0=0;for(let T0=0;T0<K;T0++){const L1=k0.g1;if(L1===1){r=i.gsmart+$0;$0=r;a=i.gsmart+$0;$0=a;C=i.gsmart+$0;$0=C}else if(L1===2){a=C;C=i.gsmart+$0;$0=C}else if(L1===3){r=C;C=i.gsmart+$0;$0=C}else if(L1===4){const N1=r;r=a;a=N1;C=i.gsmart+$0;$0=C}O[T0]=r;q[T0]=a;N[T0]=C}const F0=new p(L.data);F0.pos=L.faceTextureAxisOffset;for(let T0=0;T0<Q;T0++){U[T0]=F0.g2;b[T0]=F0.g2;I[T0]=F0.g2}return new E({vertexCount:G,vertexX:H,vertexY:$,vertexZ:J,faceCount:K,faceVertexA:O,faceVertexB:q,faceVertexC:N,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:F,facePriority:T,faceAlpha:u,faceColor:h,priority:Y,texturedFaceCount:Q,texturedVertexA:U,texturedVertexB:b,texturedVertexC:I,vertexLabel:j,faceLabel:w})};vertexCount;vertexX;vertexY;vertexZ;faceCount;faceVertexA;faceVertexB;faceVertexC;faceColorA;faceColorB;faceColorC;faceInfo;facePriority;faceAlpha;faceColor;priority;texturedFaceCount;texturedVertexA;texturedVertexB;texturedVertexC;minX;maxX;minZ;maxZ;radius;minY;maxY;maxDepth;minDepth;vertexLabel;faceLabel;labelVertices;labelFaces;vertexNormal;vertexNormalOriginal;objRaise=0;pickable=false;pickedFace=-1;pickedFaceDepth=-1;constructor(_){super();this.vertexCount=_.vertexCount;this.vertexX=_.vertexX;this.vertexY=_.vertexY;this.vertexZ=_.vertexZ;this.faceCount=_.faceCount;this.faceVertexA=_.faceVertexA;this.faceVertexB=_.faceVertexB;this.faceVertexC=_.faceVertexC;this.faceColorA=_.faceColorA;this.faceColorB=_.faceColorB;this.faceColorC=_.faceColorC;this.faceInfo=_.faceInfo;this.facePriority=_.facePriority;this.faceAlpha=_.faceAlpha;this.faceColor=_.faceColor;this.priority=_.priority;this.texturedFaceCount=_.texturedFaceCount;this.texturedVertexA=_.texturedVertexA;this.texturedVertexB=_.texturedVertexB;this.texturedVertexC=_.texturedVertexC;this.minX=_.minX??0;this.maxX=_.maxX??0;this.minZ=_.minZ??0;this.maxZ=_.maxZ??0;this.radius=_.radius??0;this.minY=_.minY??0;this.maxY=_.maxY??0;this.maxDepth=_.maxDepth??0;this.minDepth=_.minDepth??0;this.vertexLabel=_.vertexLabel??null;this.faceLabel=_.faceLabel??null;this.labelVertices=_.labelVertices??null;this.labelFaces=_.labelFaces??null;this.vertexNormal=_.vertexNormal??null;this.vertexNormalOriginal=_.vertexNormalOriginal??null}calculateBoundsCylinder(){this.maxY=0;this.radius=0;this.minY=0;for(let _=0;_<this.vertexCount;_++){const R=this.vertexX[_];const L=this.vertexY[_];const G=this.vertexZ[_];if(-L>this.maxY){this.maxY=-L}if(L>this.minY){this.minY=L}const K=R*R+G*G;if(K>this.radius){this.radius=K}}this.radius=Math.sqrt(this.radius)+0.99|0;this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0;this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0)}calculateBoundsY(){this.maxY=0;this.minY=0;for(let _=0;_<this.vertexCount;_++){const R=this.vertexY[_];if(-R>this.maxY){this.maxY=-R}if(R>this.minY){this.minY=R}}this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0;this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0)}createLabelReferences(){if(this.vertexLabel){const _=new Int32Array(256);let R=0;for(let G=0;G<this.vertexCount;G++){const K=this.vertexLabel[G];_[K]++;if(K>R){R=K}}this.labelVertices=new l(R+1,null);for(let G=0;G<=R;G++){this.labelVertices[G]=new Int32Array(_[G]);_[G]=0}let L=0;while(L<this.vertexCount){const G=this.vertexLabel[L];const K=this.labelVertices[G];if(!K){continue}K[_[G]++]=L++}this.vertexLabel=null}if(this.faceLabel){const _=new Int32Array(256);let R=0;for(let G=0;G<this.faceCount;G++){const K=this.faceLabel[G];_[K]++;if(K>R){R=K}}this.labelFaces=new l(R+1,null);for(let G=0;G<=R;G++){this.labelFaces[G]=new Int32Array(_[G]);_[G]=0}let L=0;while(L<this.faceCount){const G=this.faceLabel[L];const K=this.labelFaces[G];if(!K){continue}K[_[G]++]=L++}this.faceLabel=null}}applyTransforms(_,R,L){if(_===-1){return}if(!L||R===-1){this.applyTransform(_)}else{const G=G1.instances[_];const K=G1.instances[R];const Q=G.base;E.baseX=0;E.baseY=0;E.baseZ=0;let H=0;let $=L[H++];for(let J=0;J<G.length;J++){if(!G.bases){continue}const O=G.bases[J];while(O>$){$=L[H++]}if(Q&&Q.types&&G.x&&G.y&&G.z&&Q.labels&&(O!==$||Q.types[O]===0)){this.applyTransform2(G.x[J],G.y[J],G.z[J],Q.labels[O],Q.types[O])}}E.baseX=0;E.baseY=0;E.baseZ=0;H=0;$=L[H++];for(let J=0;J<K.length;J++){if(!K.bases){continue}const O=K.bases[J];while(O>$){$=L[H++]}if(Q&&Q.types&&K.x&&K.y&&K.z&&Q.labels&&(O===$||Q.types[O]===0)){this.applyTransform2(K.x[J],K.y[J],K.z[J],Q.labels[O],Q.types[O])}}}}applyTransform(_){if(!this.labelVertices||_===-1||!G1.instances[_]){return}const R=G1.instances[_];const L=R.base;E.baseX=0;E.baseY=0;E.baseZ=0;for(let G=0;G<R.length;G++){if(!R.bases||!R.x||!R.y||!R.z||!L||!L.labels||!L.types){continue}const K=R.bases[G];this.applyTransform2(R.x[G],R.y[G],R.z[G],L.labels[K],L.types[K])}}rotateY90(){for(let _=0;_<this.vertexCount;_++){const R=this.vertexX[_];this.vertexX[_]=this.vertexZ[_];this.vertexZ[_]=-R}}rotateX(_){const R=B.sin[_];const L=B.cos[_];for(let G=0;G<this.vertexCount;G++){const K=this.vertexY[G]*L-this.vertexZ[G]*R>>16;this.vertexZ[G]=this.vertexY[G]*R+this.vertexZ[G]*L>>16;this.vertexY[G]=K}}translate(_,R,L){for(let G=0;G<this.vertexCount;G++){this.vertexX[G]+=R;this.vertexY[G]+=_;this.vertexZ[G]+=L}}recolor(_,R){if(!this.faceColor){return}for(let L=0;L<this.faceCount;L++){if(this.faceColor[L]===_){this.faceColor[L]=R}}}rotateY180(){for(let _=0;_<this.vertexCount;_++){this.vertexZ[_]=-this.vertexZ[_]}for(let _=0;_<this.faceCount;_++){const R=this.faceVertexA[_];this.faceVertexA[_]=this.faceVertexC[_];this.faceVertexC[_]=R}}scale(_,R,L){for(let G=0;G<this.vertexCount;G++){this.vertexX[G]=this.vertexX[G]*_/128|0;this.vertexY[G]=this.vertexY[G]*R/128|0;this.vertexZ[G]=this.vertexZ[G]*L/128|0}}calculateNormals(_,R,L,G,K,Q){const H=Math.sqrt(L*L+G*G+K*K)|0;const $=R*H>>8;if(!this.faceColorA||!this.faceColorB||!this.faceColorC){this.faceColorA=new Int32Array(this.faceCount);this.faceColorB=new Int32Array(this.faceCount);this.faceColorC=new Int32Array(this.faceCount)}if(!this.vertexNormal){this.vertexNormal=new l(this.vertexCount,null);for(let J=0;J<this.vertexCount;J++){this.vertexNormal[J]=new w8}}for(let J=0;J<this.faceCount;J++){const O=this.faceVertexA[J];const q=this.faceVertexB[J];const N=this.faceVertexC[J];const U=this.vertexX[q]-this.vertexX[O];const b=this.vertexY[q]-this.vertexY[O];const I=this.vertexZ[q]-this.vertexZ[O];const j=this.vertexX[N]-this.vertexX[O];const F=this.vertexY[N]-this.vertexY[O];const T=this.vertexZ[N]-this.vertexZ[O];let Y=b*T-F*I;let u=I*j-T*U;let w=U*F-j*b;while(Y>8192||u>8192||w>8192||Y<-8192||u<-8192||w<-8192){Y>>=1;u>>=1;w>>=1}let h=Math.sqrt(Y*Y+u*u+w*w)|0;if(h<=0){h=1}Y=Y*256/h|0;u=u*256/h|0;w=w*256/h|0;if(!this.faceInfo||(this.faceInfo[J]&1)===0){let v=this.vertexNormal[O];if(v){v.x+=Y;v.y+=u;v.z+=w;v.w++}v=this.vertexNormal[q];if(v){v.x+=Y;v.y+=u;v.z+=w;v.w++}v=this.vertexNormal[N];if(v){v.x+=Y;v.y+=u;v.z+=w;v.w++}}else{const v=_+((L*Y+G*u+K*w)/($+($/2|0))|0);if(this.faceColor){this.faceColorA[J]=E.mulColorLightness(this.faceColor[J],v,this.faceInfo[J])}}}if(Q){this.applyLighting(_,$,L,G,K)}else{this.vertexNormalOriginal=new l(this.vertexCount,null);for(let J=0;J<this.vertexCount;J++){const O=this.vertexNormal[J];const q=new w8;if(O){q.x=O.x;q.y=O.y;q.z=O.z;q.w=O.w}this.vertexNormalOriginal[J]=q}}if(Q){this.calculateBoundsCylinder()}else{this.calculateBoundsAABB()}}applyLighting(_,R,L,G,K){for(let Q=0;Q<this.faceCount;Q++){const H=this.faceVertexA[Q];const $=this.faceVertexB[Q];const J=this.faceVertexC[Q];if(!this.faceInfo&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){const O=this.faceColor[Q];const q=this.vertexNormal[H];if(q){this.faceColorA[Q]=E.mulColorLightness(O,_+((L*q.x+G*q.y+K*q.z)/(R*q.w)|0),0)}const N=this.vertexNormal[$];if(N){this.faceColorB[Q]=E.mulColorLightness(O,_+((L*N.x+G*N.y+K*N.z)/(R*N.w)|0),0)}const U=this.vertexNormal[J];if(U){this.faceColorC[Q]=E.mulColorLightness(O,_+((L*U.x+G*U.y+K*U.z)/(R*U.w)|0),0)}}else if(this.faceInfo&&(this.faceInfo[Q]&1)===0&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){const O=this.faceColor[Q];const q=this.faceInfo[Q];const N=this.vertexNormal[H];if(N){this.faceColorA[Q]=E.mulColorLightness(O,_+((L*N.x+G*N.y+K*N.z)/(R*N.w)|0),q)}const U=this.vertexNormal[$];if(U){this.faceColorB[Q]=E.mulColorLightness(O,_+((L*U.x+G*U.y+K*U.z)/(R*U.w)|0),q)}const b=this.vertexNormal[J];if(b){this.faceColorC[Q]=E.mulColorLightness(O,_+((L*b.x+G*b.y+K*b.z)/(R*b.w)|0),q)}}}this.vertexNormal=null;this.vertexNormalOriginal=null;this.vertexLabel=null;this.faceLabel=null;if(this.faceInfo){for(let Q=0;Q<this.faceCount;Q++){if((this.faceInfo[Q]&2)===2){return}}}this.faceColor=null}drawSimple(_,R,L,G,K,Q,H){const $=B.sin[_];const J=B.cos[_];const O=B.sin[R];const q=B.cos[R];const N=B.sin[L];const U=B.cos[L];const b=B.sin[G];const I=B.cos[G];const j=Q*b+H*I>>16;for(let F=0;F<this.vertexCount;F++){let T=this.vertexX[F];let Y=this.vertexY[F];let u=this.vertexZ[F];let w;if(L!==0){w=Y*N+T*U>>16;Y=Y*U-T*N>>16;T=w}if(_!==0){w=Y*J-u*$>>16;u=Y*$+u*J>>16;Y=w}if(R!==0){w=u*O+T*q>>16;u=u*q-T*O>>16;T=w}T+=K;Y+=Q;u+=H;w=Y*I-u*b>>16;u=Y*b+u*I>>16;Y=w;if(E.vertexScreenX&&E.vertexScreenY&&E.vertexScreenZ){E.vertexScreenZ[F]=u-j;E.vertexScreenX[F]=B.centerX+((T<<9)/u|0);E.vertexScreenY[F]=B.centerY+((Y<<9)/u|0)}if(this.texturedFaceCount>0&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){E.vertexViewSpaceX[F]=T;E.vertexViewSpaceY[F]=Y;E.vertexViewSpaceZ[F]=u}}try{this.draw2(false,false,0)}catch(F){}}draw(_,R,L,G,K,Q,H,$,J){const O=$*K-Q*G>>16;const q=H*R+O*L>>16;const N=this.radius*L>>16;const U=q+N;if(U<=50||q>=3500){return}const b=$*G+Q*K>>16;let I=b-this.radius<<9;if((I/U|0)>=k.centerX2d){return}let j=b+this.radius<<9;if((j/U|0)<=-k.centerX2d){return}const F=H*L-O*R>>16;const T=this.radius*R>>16;let Y=F+T<<9;if((Y/U|0)<=-k.centerY2d){return}const u=T+(this.maxY*L>>16);let w=F-u<<9;if((w/U|0)>=k.centerY2d){return}const h=N+(this.maxY*R>>16);let v=q-h<=50;let n=false;if(J>0&&E.checkHover){let m=q-N;if(m<=50){m=50}if(b>0){I=I/U|0;j=j/m|0}else{j=j/U|0;I=I/m|0}if(F>0){w=w/U|0;Y=Y/m|0}else{Y=Y/U|0;w=w/m|0}const M=E.mouseX-B.centerX;const r=E.mouseY-B.centerY;if(M>I&&M<j&&r>w&&r<Y){if(this.pickable){E.pickedBitsets[E.pickedCount++]=J}else{n=true}}}const A=B.centerX;const P=B.centerY;let z=0;let f=0;if(_!==0){z=B.sin[_];f=B.cos[_]}for(let m=0;m<this.vertexCount;m++){let M=this.vertexX[m];let r=this.vertexY[m];let a=this.vertexZ[m];let C;if(_!==0){C=a*z+M*f>>16;a=a*f-M*z>>16;M=C}M+=Q;r+=H;a+=$;C=a*G+M*K>>16;a=a*K-M*G>>16;M=C;C=r*L-a*R>>16;a=r*R+a*L>>16;r=C;if(E.vertexScreenZ){E.vertexScreenZ[m]=a-q}if(a>=50&&E.vertexScreenX&&E.vertexScreenY){E.vertexScreenX[m]=A+((M<<9)/a|0);E.vertexScreenY[m]=P+((r<<9)/a|0)}else if(E.vertexScreenX){E.vertexScreenX[m]=-5000;v=true}if((v||this.texturedFaceCount>0)&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){E.vertexViewSpaceX[m]=M;E.vertexViewSpaceY[m]=r;E.vertexViewSpaceZ[m]=a}}try{this.draw2(v,n,J)}catch(m){}}draw2(_,R,L,G=false){if(E.checkHoverFace){this.pickedFace=-1;this.pickedFaceDepth=-1}for(let $=0;$<this.maxDepth;$++){if(E.tmpDepthFaceCount){E.tmpDepthFaceCount[$]=0}}for(let $=0;$<this.faceCount;$++){if(this.faceInfo&&this.faceInfo[$]===-1){continue}if(E.vertexScreenX&&E.vertexScreenY&&E.vertexScreenZ&&E.tmpDepthFaces&&E.tmpDepthFaceCount){const J=this.faceVertexA[$];const O=this.faceVertexB[$];const q=this.faceVertexC[$];const N=E.vertexScreenX[J];const U=E.vertexScreenX[O];const b=E.vertexScreenX[q];const I=E.vertexScreenY[J];const j=E.vertexScreenY[O];const F=E.vertexScreenY[q];const T=E.vertexScreenZ[J];const Y=E.vertexScreenZ[O];const u=E.vertexScreenZ[q];if(_&&(N===-5000||U===-5000||b===-5000)){if(E.faceNearClipped){E.faceNearClipped[$]=true}if(E.tmpDepthFaces&&E.tmpDepthFaceCount){const w=((T+Y+u)/3|0)+this.minDepth;E.tmpDepthFaces[w][E.tmpDepthFaceCount[w]++]=$}}else{if(R&&this.pointWithinTriangle(E.mouseX,E.mouseY,I,j,F,N,U,b)){E.pickedBitsets[E.pickedCount++]=L;R=false}const w=N-U;const h=I-j;const v=b-U;const n=F-j;if(w*n-h*v<=0){continue}if(E.faceNearClipped){E.faceNearClipped[$]=false}if(E.faceClippedX){E.faceClippedX[$]=N<0||U<0||b<0||N>k.boundX||U>k.boundX||b>k.boundX}if(E.tmpDepthFaces&&E.tmpDepthFaceCount){const A=((T+Y+u)/3|0)+this.minDepth;E.tmpDepthFaces[A][E.tmpDepthFaceCount[A]++]=$;if(E.checkHoverFace&&this.pointWithinTriangle(E.mouseX,E.mouseY,I,j,F,N,U,b)&&this.pickedFaceDepth<A){this.pickedFace=$;this.pickedFaceDepth=A}}}}}if(!this.facePriority&&E.tmpDepthFaceCount){for(let $=this.maxDepth-1;$>=0;$--){const J=E.tmpDepthFaceCount[$];if(J<=0){continue}if(E.tmpDepthFaces){const O=E.tmpDepthFaces[$];for(let q=0;q<J;q++){this.drawFace(O[q],G)}}}return}for(let $=0;$<12;$++){if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum){E.tmpPriorityFaceCount[$]=0;E.tmpPriorityDepthSum[$]=0}}if(E.tmpDepthFaceCount){for(let $=this.maxDepth-1;$>=0;$--){const J=E.tmpDepthFaceCount[$];if(J>0&&E.tmpDepthFaces){const O=E.tmpDepthFaces[$];for(let q=0;q<J;q++){if(this.facePriority&&E.tmpPriorityFaceCount&&E.tmpPriorityFaces){const N=O[q];const U=this.facePriority[N];const b=E.tmpPriorityFaceCount[U]++;E.tmpPriorityFaces[U][b]=N;if(U<10&&E.tmpPriorityDepthSum){E.tmpPriorityDepthSum[U]+=$}else if(U===10&&E.tmpPriority10FaceDepth){E.tmpPriority10FaceDepth[b]=$}else if(E.tmpPriority11FaceDepth){E.tmpPriority11FaceDepth[b]=$}}}}}}let K=0;if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum&&(E.tmpPriorityFaceCount[1]>0||E.tmpPriorityFaceCount[2]>0)){K=(E.tmpPriorityDepthSum[1]+E.tmpPriorityDepthSum[2])/(E.tmpPriorityFaceCount[1]+E.tmpPriorityFaceCount[2])|0}let Q=0;if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum&&(E.tmpPriorityFaceCount[3]>0||E.tmpPriorityFaceCount[4]>0)){Q=(E.tmpPriorityDepthSum[3]+E.tmpPriorityDepthSum[4])/(E.tmpPriorityFaceCount[3]+E.tmpPriorityFaceCount[4])|0}let H=0;if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum&&(E.tmpPriorityFaceCount[6]>0||E.tmpPriorityFaceCount[8]>0)){H=(E.tmpPriorityDepthSum[6]+E.tmpPriorityDepthSum[8])/(E.tmpPriorityFaceCount[6]+E.tmpPriorityFaceCount[8])|0}if(E.tmpPriorityFaceCount&&E.tmpPriorityFaces){let $=0;let J=E.tmpPriorityFaceCount[10];let O=E.tmpPriorityFaces[10];let q=E.tmpPriority10FaceDepth;if($===J){$=0;J=E.tmpPriorityFaceCount[11];O=E.tmpPriorityFaces[11];q=E.tmpPriority11FaceDepth}let N;if($<J&&q){N=q[$]}else{N=-1000}for(let U=0;U<10;U++){while(U===0&&N>K){try{this.drawFace(O[$++],G);if($===J&&O!==E.tmpPriorityFaces[11]){$=0;J=E.tmpPriorityFaceCount[11];O=E.tmpPriorityFaces[11];q=E.tmpPriority11FaceDepth}if($<J&&q){N=q[$]}else{N=-1000}}catch(j){}}while(U===3&&N>Q){try{this.drawFace(O[$++],G);if($===J&&O!==E.tmpPriorityFaces[11]){$=0;J=E.tmpPriorityFaceCount[11];O=E.tmpPriorityFaces[11];q=E.tmpPriority11FaceDepth}if($<J&&q){N=q[$]}else{N=-1000}}catch(j){}}while(U===5&&N>H){try{this.drawFace(O[$++],G);if($===J&&O!==E.tmpPriorityFaces[11]){$=0;J=E.tmpPriorityFaceCount[11];O=E.tmpPriorityFaces[11];q=E.tmpPriority11FaceDepth}if($<J&&q){N=q[$]}else{N=-1000}}catch(j){}}const b=E.tmpPriorityFaceCount[U];const I=E.tmpPriorityFaces[U];for(let j=0;j<b;j++){this.drawFace(I[j],G)}}while(N!==-1000){try{this.drawFace(O[$++],G);if($===J&&O!==E.tmpPriorityFaces[11]){$=0;O=E.tmpPriorityFaces[11];J=E.tmpPriorityFaceCount[11];q=E.tmpPriority11FaceDepth}if($<J&&q){N=q[$]}else{N=-1000}}catch(U){}}}}drawFace(_,R=false){if(E.faceNearClipped&&E.faceNearClipped[_]){this.drawNearClippedFace(_,R);return}const L=this.faceVertexA[_];const G=this.faceVertexB[_];const K=this.faceVertexC[_];if(E.faceClippedX){B.clipX=E.faceClippedX[_]}if(!this.faceAlpha){B.alpha=0}else{B.alpha=this.faceAlpha[_]}let Q;if(!this.faceInfo){Q=0}else{Q=this.faceInfo[_]&3}if(R&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC){B.drawLine(E.vertexScreenX[L],E.vertexScreenY[L],E.vertexScreenX[G],E.vertexScreenY[G],B.palette[this.faceColorA[_]]);B.drawLine(E.vertexScreenX[G],E.vertexScreenY[G],E.vertexScreenX[K],E.vertexScreenY[K],B.palette[this.faceColorB[_]]);B.drawLine(E.vertexScreenX[K],E.vertexScreenY[K],E.vertexScreenX[L],E.vertexScreenY[L],B.palette[this.faceColorC[_]])}else if(Q===0&&this.faceColorA&&this.faceColorB&&this.faceColorC&&E.vertexScreenX&&E.vertexScreenY){B.fillGouraudTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],this.faceColorA[_],this.faceColorB[_],this.faceColorC[_])}else if(Q===1&&this.faceColorA&&E.vertexScreenX&&E.vertexScreenY){B.fillTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],B.palette[this.faceColorA[_]])}else if(Q===2&&this.faceInfo&&this.faceColor&&this.faceColorA&&this.faceColorB&&this.faceColorC&&E.vertexScreenX&&E.vertexScreenY&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){const H=this.faceInfo[_]>>2;const $=this.texturedVertexA[H];const J=this.texturedVertexB[H];const O=this.texturedVertexC[H];B.fillTexturedTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],this.faceColorA[_],this.faceColorB[_],this.faceColorC[_],E.vertexViewSpaceX[$],E.vertexViewSpaceY[$],E.vertexViewSpaceZ[$],E.vertexViewSpaceX[J],E.vertexViewSpaceX[O],E.vertexViewSpaceY[J],E.vertexViewSpaceY[O],E.vertexViewSpaceZ[J],E.vertexViewSpaceZ[O],this.faceColor[_])}else if(Q===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&E.vertexScreenX&&E.vertexScreenY&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){const H=this.faceInfo[_]>>2;const $=this.texturedVertexA[H];const J=this.texturedVertexB[H];const O=this.texturedVertexC[H];B.fillTexturedTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[$],E.vertexViewSpaceY[$],E.vertexViewSpaceZ[$],E.vertexViewSpaceX[J],E.vertexViewSpaceX[O],E.vertexViewSpaceY[J],E.vertexViewSpaceY[O],E.vertexViewSpaceZ[J],E.vertexViewSpaceZ[O],this.faceColor[_])}}drawNearClippedFace(_,R=false){let L=0;if(E.vertexViewSpaceZ){const O=B.centerX;const q=B.centerY;const N=this.faceVertexA[_];const U=this.faceVertexB[_];const b=this.faceVertexC[_];const I=E.vertexViewSpaceZ[N];const j=E.vertexViewSpaceZ[U];const F=E.vertexViewSpaceZ[b];if(I>=50&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorA){E.clippedX[L]=E.vertexScreenX[N];E.clippedY[L]=E.vertexScreenY[N];E.clippedColor[L++]=this.faceColorA[_]}else if(E.vertexViewSpaceX&&E.vertexViewSpaceY&&this.faceColorA){const T=E.vertexViewSpaceX[N];const Y=E.vertexViewSpaceY[N];const u=this.faceColorA[_];if(F>=50&&this.faceColorC){const w=(50-I)*B.reciprocal16[F-I];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[b]-T)*w>>16)<<9)/50|0);E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[b]-Y)*w>>16)<<9)/50|0);E.clippedColor[L++]=u+((this.faceColorC[_]-u)*w>>16)}if(j>=50&&this.faceColorB){const w=(50-I)*B.reciprocal16[j-I];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[U]-T)*w>>16)<<9)/50|0);E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[U]-Y)*w>>16)<<9)/50|0);E.clippedColor[L++]=u+((this.faceColorB[_]-u)*w>>16)}}if(j>=50&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorB){E.clippedX[L]=E.vertexScreenX[U];E.clippedY[L]=E.vertexScreenY[U];E.clippedColor[L++]=this.faceColorB[_]}else if(E.vertexViewSpaceX&&E.vertexViewSpaceY&&this.faceColorB){const T=E.vertexViewSpaceX[U];const Y=E.vertexViewSpaceY[U];const u=this.faceColorB[_];if(I>=50&&this.faceColorA){const w=(50-j)*B.reciprocal16[I-j];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[N]-T)*w>>16)<<9)/50|0);E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[N]-Y)*w>>16)<<9)/50|0);E.clippedColor[L++]=u+((this.faceColorA[_]-u)*w>>16)}if(F>=50&&this.faceColorC){const w=(50-j)*B.reciprocal16[F-j];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[b]-T)*w>>16)<<9)/50|0);E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[b]-Y)*w>>16)<<9)/50|0);E.clippedColor[L++]=u+((this.faceColorC[_]-u)*w>>16)}}if(F>=50&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorC){E.clippedX[L]=E.vertexScreenX[b];E.clippedY[L]=E.vertexScreenY[b];E.clippedColor[L++]=this.faceColorC[_]}else if(E.vertexViewSpaceX&&E.vertexViewSpaceY&&this.faceColorC){const T=E.vertexViewSpaceX[b];const Y=E.vertexViewSpaceY[b];const u=this.faceColorC[_];if(j>=50&&this.faceColorB){const w=(50-F)*B.reciprocal16[j-F];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[U]-T)*w>>16)<<9)/50|0);E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[U]-Y)*w>>16)<<9)/50|0);E.clippedColor[L++]=u+((this.faceColorB[_]-u)*w>>16)}if(I>=50&&this.faceColorA){const w=(50-F)*B.reciprocal16[I-F];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[N]-T)*w>>16)<<9)/50|0);E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[N]-Y)*w>>16)<<9)/50|0);E.clippedColor[L++]=u+((this.faceColorA[_]-u)*w>>16)}}}const G=E.clippedX[0];const K=E.clippedX[1];const Q=E.clippedX[2];const H=E.clippedY[0];const $=E.clippedY[1];const J=E.clippedY[2];if((G-K)*(J-$)-(H-$)*(Q-K)<=0){return}B.clipX=false;if(L===3){if(G<0||K<0||Q<0||G>k.boundX||K>k.boundX||Q>k.boundX){B.clipX=true}let O;if(!this.faceInfo){O=0}else{O=this.faceInfo[_]&3}if(R){B.drawLine(G,K,H,$,E.clippedColor[0]);B.drawLine(K,Q,$,J,E.clippedColor[1]);B.drawLine(Q,G,J,H,E.clippedColor[2])}else if(O===0){B.fillGouraudTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2])}else if(O===1&&this.faceColorA){B.fillTriangle(G,K,Q,H,$,J,B.palette[this.faceColorA[_]])}else if(O===2&&this.faceInfo&&this.faceColor&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){const q=this.faceInfo[_]>>2;const N=this.texturedVertexA[q];const U=this.texturedVertexB[q];const b=this.texturedVertexC[q];B.fillTexturedTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2],E.vertexViewSpaceX[N],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[N],E.vertexViewSpaceX[U],E.vertexViewSpaceX[b],E.vertexViewSpaceY[U],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[b],this.faceColor[_])}else if(O===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){const q=this.faceInfo[_]>>2;const N=this.texturedVertexA[q];const U=this.texturedVertexB[q];const b=this.texturedVertexC[q];B.fillTexturedTriangle(G,K,Q,H,$,J,this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[N],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[N],E.vertexViewSpaceX[U],E.vertexViewSpaceX[b],E.vertexViewSpaceY[U],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[b],this.faceColor[_])}}else if(L===4){if(G<0||K<0||Q<0||G>k.boundX||K>k.boundX||Q>k.boundX||E.clippedX[3]<0||E.clippedX[3]>k.boundX){B.clipX=true}let O;if(!this.faceInfo){O=0}else{O=this.faceInfo[_]&3}if(R){B.drawLine(G,K,H,$,E.clippedColor[0]);B.drawLine(K,Q,$,J,E.clippedColor[1]);B.drawLine(Q,E.clippedX[3],J,E.clippedY[3],E.clippedColor[2]);B.drawLine(E.clippedX[3],G,E.clippedY[3],H,E.clippedColor[3])}else if(O===0){B.fillGouraudTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2]);B.fillGouraudTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],E.clippedColor[0],E.clippedColor[2],E.clippedColor[3])}else if(O===1){if(this.faceColorA){const q=B.palette[this.faceColorA[_]];B.fillTriangle(G,K,Q,H,$,J,q);B.fillTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],q)}}else if(O===2&&this.faceInfo&&this.faceColor&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){const q=this.faceInfo[_]>>2;const N=this.texturedVertexA[q];const U=this.texturedVertexB[q];const b=this.texturedVertexC[q];B.fillTexturedTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2],E.vertexViewSpaceX[N],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[N],E.vertexViewSpaceX[U],E.vertexViewSpaceX[b],E.vertexViewSpaceY[U],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[b],this.faceColor[_]);B.fillTexturedTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],E.clippedColor[0],E.clippedColor[2],E.clippedColor[3],E.vertexViewSpaceX[N],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[N],E.vertexViewSpaceX[U],E.vertexViewSpaceX[b],E.vertexViewSpaceY[U],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[b],this.faceColor[_])}else if(O===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){const q=this.faceInfo[_]>>2;const N=this.texturedVertexA[q];const U=this.texturedVertexB[q];const b=this.texturedVertexC[q];B.fillTexturedTriangle(G,K,Q,H,$,J,this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[N],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[N],E.vertexViewSpaceX[U],E.vertexViewSpaceX[b],E.vertexViewSpaceY[U],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[b],this.faceColor[_]);B.fillTexturedTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[N],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[N],E.vertexViewSpaceX[U],E.vertexViewSpaceX[b],E.vertexViewSpaceY[U],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[b],this.faceColor[_])}}}applyTransform2(_,R,L,G,K){if(!G){return}const Q=G.length;if(K===0){let H=0;E.baseX=0;E.baseY=0;E.baseZ=0;for(let $=0;$<Q;$++){if(!this.labelVertices){continue}const J=G[$];if(J<this.labelVertices.length){const O=this.labelVertices[J];if(O){for(let q=0;q<O.length;q++){const N=O[q];E.baseX+=this.vertexX[N];E.baseY+=this.vertexY[N];E.baseZ+=this.vertexZ[N];H++}}}}if(H>0){E.baseX=(E.baseX/H|0)+_;E.baseY=(E.baseY/H|0)+R;E.baseZ=(E.baseZ/H|0)+L}else{E.baseX=_;E.baseY=R;E.baseZ=L}}else if(K===1){for(let H=0;H<Q;H++){const $=G[H];if(!this.labelVertices||$>=this.labelVertices.length){continue}const J=this.labelVertices[$];if(J){for(let O=0;O<J.length;O++){const q=J[O];this.vertexX[q]+=_;this.vertexY[q]+=R;this.vertexZ[q]+=L}}}}else if(K===2){for(let H=0;H<Q;H++){const $=G[H];if(!this.labelVertices||$>=this.labelVertices.length){continue}const J=this.labelVertices[$];if(J){for(let O=0;O<J.length;O++){const q=J[O];this.vertexX[q]-=E.baseX;this.vertexY[q]-=E.baseY;this.vertexZ[q]-=E.baseZ;const N=(_&255)*8;const U=(R&255)*8;const b=(L&255)*8;let I;let j;if(b!==0){I=B.sin[b];j=B.cos[b];const F=this.vertexY[q]*I+this.vertexX[q]*j>>16;this.vertexY[q]=this.vertexY[q]*j-this.vertexX[q]*I>>16;this.vertexX[q]=F}if(N!==0){I=B.sin[N];j=B.cos[N];const F=this.vertexY[q]*j-this.vertexZ[q]*I>>16;this.vertexZ[q]=this.vertexY[q]*I+this.vertexZ[q]*j>>16;this.vertexY[q]=F}if(U!==0){I=B.sin[U];j=B.cos[U];const F=this.vertexZ[q]*I+this.vertexX[q]*j>>16;this.vertexZ[q]=this.vertexZ[q]*j-this.vertexX[q]*I>>16;this.vertexX[q]=F}this.vertexX[q]+=E.baseX;this.vertexY[q]+=E.baseY;this.vertexZ[q]+=E.baseZ}}}}else if(K===3){for(let H=0;H<Q;H++){const $=G[H];if(!this.labelVertices||$>=this.labelVertices.length){continue}const J=this.labelVertices[$];if(J){for(let O=0;O<J.length;O++){const q=J[O];this.vertexX[q]-=E.baseX;this.vertexY[q]-=E.baseY;this.vertexZ[q]-=E.baseZ;this.vertexX[q]=this.vertexX[q]*_/128|0;this.vertexY[q]=this.vertexY[q]*R/128|0;this.vertexZ[q]=this.vertexZ[q]*L/128|0;this.vertexX[q]+=E.baseX;this.vertexY[q]+=E.baseY;this.vertexZ[q]+=E.baseZ}}}}else if(K===5&&this.labelFaces&&this.faceAlpha){for(let H=0;H<Q;H++){const $=G[H];if($>=this.labelFaces.length){continue}const J=this.labelFaces[$];if(J){for(let O=0;O<J.length;O++){const q=J[O];this.faceAlpha[q]+=_*8;if(this.faceAlpha[q]<0){this.faceAlpha[q]=0}if(this.faceAlpha[q]>255){this.faceAlpha[q]=255}}}}}}calculateBoundsAABB(){this.maxY=0;this.radius=0;this.minY=0;this.minX=999999;this.maxX=-999999;this.maxZ=-99999;this.minZ=99999;for(let _=0;_<this.vertexCount;_++){const R=this.vertexX[_];const L=this.vertexY[_];const G=this.vertexZ[_];if(R<this.minX){this.minX=R}if(R>this.maxX){this.maxX=R}if(G<this.minZ){this.minZ=G}if(G>this.maxZ){this.maxZ=G}if(-L>this.maxY){this.maxY=-L}if(L>this.minY){this.minY=L}const K=R*R+G*G;if(K>this.radius){this.radius=K}}this.radius=Math.sqrt(this.radius)|0;this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0;this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0)}pointWithinTriangle(_,R,L,G,K,Q,H,$){if(R<L&&R<G&&R<K){return false}else if(R>L&&R>G&&R>K){return false}else if(_<Q&&_<H&&_<$){return false}else{return _<=Q||_<=H||_<=$}}drawFaceOutline(_){if(!E.vertexScreenX||!E.vertexScreenY||!this.faceColorA||!this.faceColorB||!this.faceColorC){return}const R=this.faceVertexA[_];const L=this.faceVertexB[_];const G=this.faceVertexC[_];B.drawLine(E.vertexScreenX[R],E.vertexScreenY[R],E.vertexScreenX[L],E.vertexScreenY[L],B.palette[1000]);B.drawLine(E.vertexScreenX[L],E.vertexScreenY[L],E.vertexScreenX[G],E.vertexScreenY[G],B.palette[1000]);B.drawLine(E.vertexScreenX[G],E.vertexScreenY[G],E.vertexScreenX[R],E.vertexScreenY[R],B.palette[1000])}}class h0 extends n0{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCacheStatic=new s0(500);static modelCacheDynamic=new s0(30);static unpack=(_)=>{this.dat=new p(_.read("loc.dat"));const R=new p(_.read("loc.idx"));this.count=R.g2;this.offsets=new Int32Array(this.count);let L=2;for(let G=0;G<this.count;G++){this.offsets[G]=L;L+=R.g2}this.cache=new l(10,null);for(let G=0;G<10;G++){this.cache[G]=new h0(-1)}};static get=(_)=>{if(!this.cache||!this.offsets||!this.dat){throw new Error("LocType not loaded!!!")}for(let L=0;L<10;L++){const G=this.cache[L];if(!G){continue}if(G.id===_){return G}}this.cachePos=(this.cachePos+1)%10;const R=this.cache[this.cachePos];this.dat.pos=this.offsets[_];R.id=_;R.reset();R.decodeType(this.dat);if(!R.shapes){R.shapes=new Int32Array(1)}if(R.active2===-1&&R.shapes){R.active=R.shapes.length>0&&R.shapes[0]===y.CENTREPIECE_STRAIGHT.id;if(R.op){R.active=true}}return R};models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=true;blockrange=true;active=false;active2=-1;hillskew=false;sharelight=false;occlude=false;anim=-1;disposeAlpha=false;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=false;shadow=true;resizex=128;resizey=128;resizez=128;forceapproach=0;offsetx=0;offsety=0;offsetz=0;forcedecor=false;decode(_,R){if(_===1){const L=R.g1;this.models=new Int32Array(L);this.shapes=new Int32Array(L);for(let G=0;G<L;G++){this.models[G]=R.g2;this.shapes[G]=R.g1}}else if(_===2){this.name=R.gjstr}else if(_===3){this.desc=R.gjstr}else if(_===14){this.width=R.g1}else if(_===15){this.length=R.g1}else if(_===17){this.blockwalk=false}else if(_===18){this.blockrange=false}else if(_===19){this.active2=R.g1;if(this.active2===1){this.active=true}}else if(_===21){this.hillskew=true}else if(_===22){this.sharelight=true}else if(_===23){this.occlude=true}else if(_===24){this.anim=R.g2;if(this.anim===65535){this.anim=-1}}else if(_===25){this.disposeAlpha=true}else if(_===28){this.wallwidth=R.g1}else if(_===29){this.ambient=R.g1b}else if(_===39){this.contrast=R.g1b}else if(_>=30&&_<39){if(!this.op){this.op=new l(5,null)}this.op[_-30]=R.gjstr;if(this.op[_-30]?.toLowerCase()==="hidden"){this.op[_-30]=null}}else if(_===40){const L=R.g1;this.recol_s=new Uint16Array(L);this.recol_d=new Uint16Array(L);for(let G=0;G<L;G++){this.recol_s[G]=R.g2;this.recol_d[G]=R.g2}}else if(_===60){this.mapfunction=R.g2}else if(_===62){this.mirror=true}else if(_===64){this.shadow=false}else if(_===65){this.resizex=R.g2}else if(_===66){this.resizey=R.g2}else if(_===67){this.resizez=R.g2}else if(_===68){this.mapscene=R.g2}else if(_===69){this.forceapproach=R.g1}else if(_===70){this.offsetx=R.g2b}else if(_===71){this.offsety=R.g2b}else if(_===72){this.offsetz=R.g2b}else if(_===73){this.forcedecor=true}}getModel(_,R,L,G,K,Q,H){if(!this.shapes){return null}let $=-1;for(let F=0;F<this.shapes.length;F++){if(this.shapes[F]===_){$=F;break}}if($===-1){return null}const J=BigInt(BigInt(this.id)<<6n)+BigInt(BigInt($)<<3n)+BigInt(R)+BigInt(BigInt(H)+1n<<32n);let O=h0.modelCacheDynamic?.get(J);if(O){if(this.hillskew||this.sharelight){O=E.modelCopyFaces(O,this.hillskew,this.sharelight)}if(this.hillskew){const F=(L+G+K+Q)/4|0;for(let T=0;T<O.vertexCount;T++){const Y=O.vertexX[T];const u=O.vertexZ[T];const w=L+((G-L)*(Y+64)/128|0);const h=Q+((K-Q)*(Y+64)/128|0);const v=w+((h-w)*(u+64)/128|0);O.vertexY[T]+=v-F}O.calculateBoundsY()}return O}if(!this.models){return null}if($>=this.models.length){return null}let q=this.models[$];if(q===-1){return null}const N=this.mirror!==R>3;if(N){q+=65536}let U=h0.modelCacheStatic?.get(BigInt(q));if(!U){U=E.model(q&65535);if(N){U.rotateY180()}h0.modelCacheStatic?.put(BigInt(q),U)}const b=this.resizex!==128||this.resizey!==128||this.resizez!==128;const I=this.offsetx!==0||this.offsety!==0||this.offsetz!==0;let j=E.modelShareColored(U,!this.recol_s,!this.disposeAlpha,R===x.WEST&&H===-1&&!b&&!I);if(H!==-1){j.createLabelReferences();j.applyTransform(H);j.labelFaces=null;j.labelVertices=null}while(R-- >0){j.rotateY90()}if(this.recol_s&&this.recol_d){for(let F=0;F<this.recol_s.length;F++){j.recolor(this.recol_s[F],this.recol_d[F])}}if(b){j.scale(this.resizex,this.resizey,this.resizez)}if(I){j.translate(this.offsety,this.offsetx,this.offsetz)}j.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight);if(this.blockwalk){j.objRaise=j.maxY}h0.modelCacheDynamic?.put(J,j);if(this.hillskew||this.sharelight){j=E.modelCopyFaces(j,this.hillskew,this.sharelight)}if(this.hillskew){const F=(L+G+K+Q)/4|0;for(let T=0;T<j.vertexCount;T++){const Y=j.vertexX[T];const u=j.vertexZ[T];const w=L+((G-L)*(Y+64)/128|0);const h=Q+((K-Q)*(Y+64)/128|0);const v=w+((h-w)*(u+64)/128|0);j.vertexY[T]+=v-F}j.calculateBoundsY()}return j}reset(){this.models=null;this.shapes=null;this.name=null;this.desc=null;this.recol_s=null;this.recol_d=null;this.width=1;this.length=1;this.blockwalk=true;this.blockrange=true;this.active=false;this.active2=-1;this.hillskew=false;this.sharelight=false;this.occlude=false;this.anim=-1;this.wallwidth=16;this.ambient=0;this.contrast=0;this.op=null;this.disposeAlpha=false;this.mapfunction=-1;this.mapscene=-1;this.mirror=false;this.shadow=true;this.resizex=128;this.resizey=128;this.resizez=128;this.forceapproach=0;this.offsetx=0;this.offsety=0;this.offsetz=0;this.forcedecor=false}}class X{static RED=16711680;static GREEN=65280;static BLUE=255;static YELLOW=16776960;static CYAN=65535;static MAGENTA=16711935;static WHITE=16777215;static BLACK=0;static LIGHTRED=16748608;static DARKRED=8388608;static DARKBLUE=128;static ORANGE1=16756736;static ORANGE2=16740352;static ORANGE3=16723968;static GREEN1=12648192;static GREEN2=8453888;static GREEN3=4259584;static PROGRESS_RED=9179409;static OPTIONS_MENU=6116423;static SCROLLBAR_TRACK=2301979;static SCROLLBAR_GRIP_FOREGROUND=5063219;static SCROLLBAR_GRIP_HIGHLIGHT=7759444;static SCROLLBAR_GRIP_LOWLIGHT=3353893;static TRADE_MESSAGE=8388736;static DUEL_MESSAGE=13350793;static CHAT_COLORS=Int32Array.of(X.YELLOW,X.RED,X.GREEN,X.CYAN,X.MAGENTA,X.WHITE);static HAIR_DARK_BROWN=6798;static HAIR_WHITE=107;static HAIR_LIGHT_GREY=10283;static HAIR_DARK_GREY=16;static HAIR_APRICOT=4797;static HAIR_STRAW=7744;static HAIR_LIGHT_BROWN=5799;static HAIR_BROWN=4634;static HAIR_TURQUOISE=33697;static HAIR_GREEN=22433;static HAIR_GINGER=2983;static HAIR_MAGENTA=54193;static BODY_KHAKI=8741;static BODY_CHARCOAL=12;static BODY_CRIMSON=64030;static BODY_NAVY=43162;static BODY_STRAW=7735;static BODY_WHITE=8404;static BODY_RED=1701;static BODY_BLUE=38430;static BODY_GREEN=24094;static BODY_YELLOW=10153;static BODY_PURPLE=56621;static BODY_ORANGE=4783;static BODY_ROSE=1341;static BODY_LIME=16578;static BODY_CYAN=35003;static BODY_EMERALD=25239;static BODY_RECOLOR_KHAKI=9104;static BODY_RECOLOR_CHARCOAL=10275;static BODY_RECOLOR_CRIMSON=7595;static BODY_RECOLOR_NAVY=3610;static BODY_RECOLOR_STRAW=7975;static BODY_RECOLOR_WHITE=8526;static BODY_RECOLOR_RED=918;static BODY_RECOLOR_BLUE=38802;static BODY_RECOLOR_GREEN=24466;static BODY_RECOLOR_YELLOW=10145;static BODY_RECOLOR_PURPLE=58654;static BODY_RECOLOR_ORANGE=5027;static BODY_RECOLOR_ROSE=1457;static BODY_RECOLOR_LIME=16565;static BODY_RECOLOR_CYAN=34991;static BODY_RECOLOR_EMERALD=25486;static FEET_BROWN=4626;static FEET_KHAKI=11146;static FEET_ASHEN=6439;static FEET_DARK=12;static FEET_TERRACOTTA=4758;static FEET_GREY=10270;static SKIN=4574;static SKIN_DARKER=4550;static SKIN_DARKER_DARKER=4537;static SKIN_DARKER_DARKER_DARKER=5681;static SKIN_DARKER_DARKER_DARKER_DARKER=5673;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER=5790;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER=6806;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER=8076}var I6=async(_)=>{if(_[0]!==255){_[0]=255}URL.revokeObjectURL(W1.src);W1.src=URL.createObjectURL(new Blob([_],{type:"image/jpeg"}));await new Promise((G)=>W1.onload=()=>G());j8.clearRect(0,0,D1.width,D1.height);const R=W1.naturalWidth;const L=W1.naturalHeight;D1.width=R;D1.height=L;j8.drawImage(W1,0,0);return j8.getImageData(0,0,R,L)};class V0 extends x0{pixels;width;height;cropX;cropY;cropW;cropH;constructor(_,R){super();this.pixels=new Int32Array(_*R);this.width=this.cropW=_;this.height=this.cropH=R;this.cropX=this.cropY=0}static fromJpeg=async(_,R)=>{const L=_.read(R+".dat");if(!L){throw new Error(`${R} jpeg not found!`)}const G=await I6(L);const K=new V0(G.width,G.height);const Q=new Uint32Array(G.data.buffer);const H=K.pixels;for(let $=0;$<H.length;$++){const J=Q[$];H[$]=(J>>24&255)<<24|(J&255)<<16|(J>>8&255)<<8|J>>16&255}return K};static fromArchive=(_,R,L=0)=>{const G=new p(_.read(R+".dat"));const K=new p(_.read("index.dat"));K.pos=G.g2;const Q=K.g2;const H=K.g2;const $=K.g1;const J=[];const O=$-1;for(let F=0;F<O;F++){J[F+1]=K.g3;if(J[F+1]===0){J[F+1]=1}}for(let F=0;F<L;F++){K.pos+=2;G.pos+=K.g2*K.g2;K.pos+=1}if(G.pos>G.length||K.pos>K.length){throw new Error}const q=K.g1;const N=K.g1;const U=K.g2;const b=K.g2;const I=new V0(U,b);I.cropX=q;I.cropY=N;I.cropW=Q;I.cropH=H;const j=K.g1;if(j===0){const F=I.width*I.height;for(let T=0;T<F;T++){I.pixels[T]=J[G.g1]}}else if(j===1){const F=I.width;for(let T=0;T<F;T++){const Y=I.height;for(let u=0;u<Y;u++){I.pixels[T+u*F]=J[G.g1]}}}return I};bind(){k.bind(this.pixels,this.width,this.height)}draw(_,R){_|=0;R|=0;_+=this.cropX;R+=this.cropY;let L=_+R*k.width2d;let G=0;let K=this.height;let Q=this.width;let H=k.width2d-Q;let $=0;if(R<k.top){const J=k.top-R;K-=J;R=k.top;G+=J*Q;L+=J*k.width2d}if(R+K>k.bottom){K-=R+K-k.bottom}if(_<k.left){const J=k.left-_;Q-=J;_=k.left;G+=J;L+=J;$+=J;H+=J}if(_+Q>k.right){const J=_+Q-k.right;Q-=J;$+=J;H+=J}if(Q>0&&K>0){this.copyImageDraw(Q,K,this.pixels,G,$,k.pixels,L,H)}}drawAlpha(_,R,L){R|=0;L|=0;R+=this.cropX;L+=this.cropY;let G=R+L*k.width2d;let K=0;let Q=this.height;let H=this.width;let $=k.width2d-H;let J=0;if(L<k.top){const O=k.top-L;Q-=O;L=k.top;K+=O*H;G+=O*k.width2d}if(L+Q>k.bottom){Q-=L+Q-k.bottom}if(R<k.left){const O=k.left-R;H-=O;R=k.left;K+=O;G+=O;J+=O;$+=O}if(R+H>k.right){const O=R+H-k.right;H-=O;J+=O;$+=O}if(H>0&&Q>0){this.copyPixelsAlpha(H,Q,this.pixels,K,J,k.pixels,G,$,_)}}blitOpaque(_,R){_|=0;R|=0;_+=this.cropX;R+=this.cropY;let L=_+R*k.width2d;let G=0;let K=this.height;let Q=this.width;let H=k.width2d-Q;let $=0;if(R<k.top){const J=k.top-R;K-=J;R=k.top;G+=J*Q;L+=J*k.width2d}if(R+K>k.bottom){K-=R+K-k.bottom}if(_<k.left){const J=k.left-_;Q-=J;_=k.left;G+=J;L+=J;$+=J;H+=J}if(_+Q>k.right){const J=_+Q-k.right;Q-=J;$+=J;H+=J}if(Q>0&&K>0){this.copyImageBlitOpaque(Q,K,this.pixels,G,$,k.pixels,L,H)}}flipHorizontally(){const _=this.pixels;const R=this.width;const L=this.height;for(let G=0;G<L;G++){const K=R/2|0;for(let Q=0;Q<K;Q++){const H=Q+G*R;const $=R-Q-1+G*R;const J=_[H];_[H]=_[$];_[$]=J}}}flipVertically(){const _=this.pixels;const R=this.width;const L=this.height;for(let G=0;G<(L/2|0);G++){for(let K=0;K<R;K++){const Q=K+G*R;const H=K+(L-G-1)*R;const $=_[Q];_[Q]=_[H];_[H]=$}}}translate(_,R,L){for(let G=0;G<this.pixels.length;G++){const K=this.pixels[G];if(K!==0){let Q=K>>16&255;Q+=_;if(Q<1){Q=1}else if(Q>255){Q=255}let H=K>>8&255;H+=R;if(H<1){H=1}else if(H>255){H=255}let $=K&255;$+=L;if($<1){$=1}else if($>255){$=255}this.pixels[G]=(Q<<16)+(H<<8)+$}}}crop(_,R,L,G){_|=0;R|=0;L|=0;G|=0;try{const K=this.width;let Q=0;let H=0;const $=this.cropW;const J=this.cropH;const O=($<<16)/L|0;const q=(J<<16)/G|0;_+=(this.cropX*L+$-1)/$|0;R+=(this.cropY*G+J-1)/J|0;if(this.cropX*L%$!==0){Q=($-this.cropX*L%$<<16)/L|0}if(this.cropY*G%J!==0){H=(J-this.cropY*G%J<<16)/G|0}L=L*(this.width-(Q>>16))/$|0;G=G*(this.height-(H>>16))/J|0;let N=_+R*k.width2d;let U=k.width2d-L;if(R<k.top){const b=k.top-R;G-=b;R=0;N+=b*k.width2d;H+=q*b}if(R+G>k.bottom){G-=R+G-k.bottom}if(_<k.left){const b=k.left-_;L-=b;_=0;N+=b;Q+=O*b;U+=b}if(_+L>k.right){const b=_+L-k.right;L-=b;U+=b}this.scale(L,G,this.pixels,Q,H,k.pixels,U,N,K,O,q)}catch(K){}}drawRotatedMasked(_,R,L,G,K,Q,H,$,J,O){_|=0;R|=0;L|=0;G|=0;try{const q=-L/2|0;const N=-G/2|0;const U=Math.sin(J/326.11)*65536|0;const b=Math.cos(J/326.11)*65536|0;const I=U*O>>8;const j=b*O>>8;let F=(H<<16)+N*I+q*j;let T=($<<16)+(N*j-q*I);let Y=_+R*k.width2d;for(let u=0;u<G;u++){const w=K[u];let h=Y+w;let v=F+j*w;let n=T-I*w;for(let A=-Q[u];A<0;A++){k.pixels[h++]=this.pixels[(v>>16)+(n>>16)*this.width];v+=j;n-=I}F+=I;T+=j;Y+=k.width2d}}catch(q){}}drawMasked(_,R,L){_|=0;R|=0;_+=this.cropX;R+=this.cropY;let G=_+R*k.width2d;let K=0;let Q=this.height;let H=this.width;let $=k.width2d-H;let J=0;if(R<k.top){const O=k.top-R;Q-=O;R=k.top;K+=O*H;G+=O*k.width2d}if(R+Q>k.bottom){Q-=R+Q-k.bottom}if(_<k.left){const O=k.left-_;H-=O;_=k.left;K+=O;G+=O;J+=O;$+=O}if(_+H>k.right){const O=_+H-k.right;H-=O;J+=O;$+=O}if(H>0&&Q>0){this.copyPixelsMasked(H,Q,this.pixels,J,K,k.pixels,G,$,L.pixels)}}scale(_,R,L,G,K,Q,H,$,J,O,q){try{const N=G;for(let U=-R;U<0;U++){const b=(K>>16)*J;for(let I=-_;I<0;I++){const j=L[(G>>16)+b];if(j===0){$++}else{Q[$++]=j}G+=O}K+=q;G=N;$+=H}}catch(N){}}copyImageBlitOpaque(_,R,L,G,K,Q,H,$){const J=-(_>>2);_=-(_&3);for(let O=-R;O<0;O++){for(let q=J;q<0;q++){Q[H++]=L[G++];Q[H++]=L[G++];Q[H++]=L[G++];Q[H++]=L[G++]}for(let q=_;q<0;q++){Q[H++]=L[G++]}H+=$;G+=K}}copyPixelsAlpha(_,R,L,G,K,Q,H,$,J){const O=256-J;for(let q=-R;q<0;q++){for(let N=-_;N<0;N++){const U=L[G++];if(U===0){H++}else{const b=Q[H];Q[H++]=((U&16711935)*J+(b&16711935)*O&4278255360)+((U&65280)*J+(b&65280)*O&16711680)>>8}}H+=$;G+=K}}copyImageDraw(_,R,L,G,K,Q,H,$){const J=-(_>>2);_=-(_&3);for(let O=-R;O<0;O++){for(let q=J;q<0;q++){let N=L[G++];if(N===0){H++}else{Q[H++]=N}N=L[G++];if(N===0){H++}else{Q[H++]=N}N=L[G++];if(N===0){H++}else{Q[H++]=N}N=L[G++];if(N===0){H++}else{Q[H++]=N}}for(let q=_;q<0;q++){const N=L[G++];if(N===0){H++}else{Q[H++]=N}}H+=$;G+=K}}copyPixelsMasked(_,R,L,G,K,Q,H,$,J){const O=-(_>>2);_=-(_&3);for(let q=-R;q<0;q++){for(let N=O;N<0;N++){let U=L[K++];if(U!==0&&J[H]===0){Q[H++]=U}else{H++}U=L[K++];if(U!==0&&J[H]===0){Q[H++]=U}else{H++}U=L[K++];if(U!==0&&J[H]===0){Q[H++]=U}else{H++}U=L[K++];if(U!==0&&J[H]===0){Q[H++]=U}else{H++}}for(let N=_;N<0;N++){const U=L[K++];if(U!==0&&J[H]===0){Q[H++]=U}else{H++}}H+=$;K+=G}}}class Y0 extends n0{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static membersWorld=true;static modelCache=new s0(50);static iconCache=new s0(200);static unpack=(_,R)=>{this.membersWorld=R;this.dat=new p(_.read("obj.dat"));const L=new p(_.read("obj.idx"));this.count=L.g2;this.offsets=new Int32Array(this.count);let G=2;for(let K=0;K<this.count;K++){this.offsets[K]=G;G+=L.g2}this.cache=new l(10,null);for(let K=0;K<10;K++){this.cache[K]=new Y0(-1)}};static get=(_)=>{if(!this.cache||!this.offsets||!this.dat){throw new Error("ObjType not loaded!!!")}for(let L=0;L<10;L++){const G=this.cache[L];if(!G){continue}if(G.id===_){return G}}this.cachePos=(this.cachePos+1)%10;const R=this.cache[this.cachePos];this.dat.pos=this.offsets[_];R.id=_;R.reset();R.decodeType(this.dat);if(R.certtemplate!==-1){R.toCertificate()}if(!this.membersWorld&&R.members){R.name="Members Object";R.desc="Login to a members' server to use this object.";R.op=null;R.iop=null}return R};static getIcon=(_,R)=>{if(Y0.iconCache){let T=Y0.iconCache.get(BigInt(_));if(T&&T.cropH!==R&&T.cropH!==-1){T.unlink();T=null}if(T){return T}}let L=Y0.get(_);if(!L.countobj){R=-1}if(L.countobj&&L.countco&&R>1){let T=-1;for(let Y=0;Y<10;Y++){if(R>=L.countco[Y]&&L.countco[Y]!==0){T=L.countobj[Y]}}if(T!==-1){L=Y0.get(T)}}const G=new V0(32,32);const K=B.centerX;const Q=B.centerY;const H=B.lineOffset;const $=k.pixels;const J=k.width2d;const O=k.height2d;const q=k.left;const N=k.right;const U=k.top;const b=k.bottom;B.jagged=false;k.bind(G.pixels,32,32);k.fillRect(0,0,32,32,X.BLACK);B.init2D();const I=L.getInterfaceModel(1);const j=B.sin[L.xan2d]*L.zoom2d>>16;const F=B.cos[L.xan2d]*L.zoom2d>>16;I.drawSimple(0,L.yan2d,L.zan2d,L.xan2d,L.xof2d,j+(I.maxY/2|0)+L.yof2d,F+L.yof2d);for(let T=31;T>=0;T--){for(let Y=31;Y>=0;Y--){if(G.pixels[T+Y*32]!==0){continue}if(T>0&&G.pixels[T+Y*32-1]>1){G.pixels[T+Y*32]=1}else if(Y>0&&G.pixels[T+(Y-1)*32]>1){G.pixels[T+Y*32]=1}else if(T<31&&G.pixels[T+Y*32+1]>1){G.pixels[T+Y*32]=1}else if(Y<31&&G.pixels[T+(Y+1)*32]>1){G.pixels[T+Y*32]=1}}}for(let T=31;T>=0;T--){for(let Y=31;Y>=0;Y--){if(G.pixels[T+Y*32]===0&&T>0&&Y>0&&G.pixels[T+(Y-1)*32-1]>0){G.pixels[T+Y*32]=3153952}}}if(L.certtemplate!==-1){const T=this.getIcon(L.certlink,10);const Y=T.cropW;const u=T.cropH;T.cropW=32;T.cropH=32;T.crop(5,5,22,22);T.cropW=Y;T.cropH=u}Y0.iconCache?.put(BigInt(_),G);k.bind($,J,O);k.setBounds(q,U,N,b);B.centerX=K;B.centerY=Q;B.lineOffset=H;B.jagged=true;if(L.stackable){G.cropW=33}else{G.cropW=32}G.cropH=R;return G};model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=false;code10=-1;stackable=false;cost=1;members=false;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;decode(_,R){if(_===1){this.model=R.g2}else if(_===2){this.name=R.gjstr}else if(_===3){this.desc=R.gjstr}else if(_===4){this.zoom2d=R.g2}else if(_===5){this.xan2d=R.g2}else if(_===6){this.yan2d=R.g2}else if(_===7){this.xof2d=R.g2b;if(this.xof2d>32767){this.xof2d-=65536}}else if(_===8){this.yof2d=R.g2b;if(this.yof2d>32767){this.yof2d-=65536}}else if(_===9){this.code9=true}else if(_===10){this.code10=R.g2}else if(_===11){this.stackable=true}else if(_===12){this.cost=R.g4}else if(_===16){this.members=true}else if(_===23){this.manwear=R.g2;this.manwearOffsetY=R.g1b}else if(_===24){this.manwear2=R.g2}else if(_===25){this.womanwear=R.g2;this.womanwearOffsetY=R.g1b}else if(_===26){this.womanwear2=R.g2}else if(_>=30&&_<35){if(!this.op){this.op=new l(5,null)}this.op[_-30]=R.gjstr;if(this.op[_-30]?.toLowerCase()==="hidden"){this.op[_-30]=null}}else if(_>=35&&_<40){if(!this.iop){this.iop=new l(5,null)}this.iop[_-35]=R.gjstr}else if(_===40){const L=R.g1;this.recol_s=new Uint16Array(L);this.recol_d=new Uint16Array(L);for(let G=0;G<L;G++){this.recol_s[G]=R.g2;this.recol_d[G]=R.g2}}else if(_===78){this.manwear3=R.g2}else if(_===79){this.womanwear3=R.g2}else if(_===90){this.manhead=R.g2}else if(_===91){this.womanhead=R.g2}else if(_===92){this.manhead2=R.g2}else if(_===93){this.womanhead2=R.g2}else if(_===95){this.zan2d=R.g2}else if(_===97){this.certlink=R.g2}else if(_===98){this.certtemplate=R.g2}else if(_>=100&&_<110){if(!this.countobj||!this.countco){this.countobj=new Uint16Array(10);this.countco=new Uint16Array(10)}this.countobj[_-100]=R.g2;this.countco[_-100]=R.g2}}getWornModel(_){let R=this.manwear;if(_===1){R=this.womanwear}if(R===-1){return null}let L=this.manwear2;let G=this.manwear3;if(_===1){L=this.womanwear2;G=this.womanwear3}let K=E.model(R);if(L!==-1){const Q=E.model(L);if(G===-1){const H=[K,Q];K=E.modelFromModels(H,2)}else{const H=E.model(G);const $=[K,Q,H];K=E.modelFromModels($,3)}}if(_===0&&this.manwearOffsetY!==0){K.translate(this.manwearOffsetY,0,0)}if(_===1&&this.womanwearOffsetY!==0){K.translate(this.womanwearOffsetY,0,0)}if(this.recol_s&&this.recol_d){for(let Q=0;Q<this.recol_s.length;Q++){K.recolor(this.recol_s[Q],this.recol_d[Q])}}return K}getHeadModel(_){let R=this.manhead;if(_===1){R=this.womanhead}if(R===-1){return null}let L=this.manhead2;if(_===1){L=this.womanhead2}let G=E.model(R);if(L!==-1){const K=E.model(L);const Q=[G,K];G=E.modelFromModels(Q,2)}if(this.recol_s&&this.recol_d){for(let K=0;K<this.recol_s.length;K++){G.recolor(this.recol_s[K],this.recol_d[K])}}return G}getInterfaceModel(_){if(this.countobj&&this.countco&&_>1){let L=-1;for(let G=0;G<10;G++){if(_>=this.countco[G]&&this.countco[G]!==0){L=this.countobj[G]}}if(L!==-1){return Y0.get(L).getInterfaceModel(1)}}if(Y0.modelCache){const L=Y0.modelCache.get(BigInt(this.id));if(L){return L}}const R=E.model(this.model);if(this.recol_s&&this.recol_d){for(let L=0;L<this.recol_s.length;L++){R.recolor(this.recol_s[L],this.recol_d[L])}}R.calculateNormals(64,768,-50,-10,-50,true);R.pickable=true;Y0.modelCache?.put(BigInt(this.id),R);return R}toCertificate(){const _=Y0.get(this.certtemplate);this.model=_.model;this.zoom2d=_.zoom2d;this.xan2d=_.xan2d;this.yan2d=_.yan2d;this.zan2d=_.zan2d;this.xof2d=_.xof2d;this.yof2d=_.yof2d;this.recol_s=_.recol_s;this.recol_d=_.recol_d;const R=Y0.get(this.certlink);this.name=R.name;this.members=R.members;this.cost=R.cost;let L="a";const G=(R.name||"").toLowerCase().charAt(0);if(G==="a"||G==="e"||G==="i"||G==="o"||G==="u"){L="an"}this.desc=`Swap this note at any bank for ${L} ${R.name}.`;this.stackable=true}reset(){this.model=0;this.name=null;this.desc=null;this.recol_s=null;this.recol_d=null;this.zoom2d=2000;this.xan2d=0;this.yan2d=0;this.zan2d=0;this.xof2d=0;this.yof2d=0;this.code9=false;this.code10=-1;this.stackable=false;this.cost=1;this.members=false;this.op=null;this.iop=null;this.manwear=-1;this.manwear2=-1;this.manwearOffsetY=0;this.womanwear=-1;this.womanwear2=-1;this.womanwearOffsetY=0;this.manwear3=-1;this.womanwear3=-1;this.manhead=-1;this.manhead2=-1;this.womanhead=-1;this.womanhead2=-1;this.countobj=null;this.countco=null;this.certlink=-1;this.certtemplate=-1}}class _1 extends n0{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCache=new s0(30);static unpack=(_)=>{this.dat=new p(_.read("npc.dat"));const R=new p(_.read("npc.idx"));this.count=R.g2;this.offsets=new Int32Array(this.count);let L=2;for(let G=0;G<this.count;G++){this.offsets[G]=L;L+=R.g2}this.cache=new l(20,null);for(let G=0;G<20;G++){this.cache[G]=new _1(-1)}};static get=(_)=>{if(!this.cache||!this.offsets||!this.dat){throw new Error("NpcType not loaded!!!")}for(let L=0;L<20;L++){const G=this.cache[L];if(!G){continue}if(G.id===_){return G}}this.cachePos=(this.cachePos+1)%20;const R=this.cache[this.cachePos]=new _1(_);this.dat.pos=this.offsets[_];R.decodeType(this.dat);return R};name=null;desc=null;size=1;models=null;heads=null;disposeAlpha=false;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=true;vislevel=-1;resizeh=128;resizev=128;decode(_,R){if(_===1){const L=R.g1;this.models=new Uint16Array(L);for(let G=0;G<L;G++){this.models[G]=R.g2}}else if(_===2){this.name=R.gjstr}else if(_===3){this.desc=R.gjstr}else if(_===12){this.size=R.g1b}else if(_===13){this.readyanim=R.g2}else if(_===14){this.walkanim=R.g2}else if(_===16){this.disposeAlpha=true}else if(_===17){this.walkanim=R.g2;this.walkanim_b=R.g2;this.walkanim_r=R.g2;this.walkanim_l=R.g2}else if(_>=30&&_<40){if(!this.op){this.op=new l(5,null)}this.op[_-30]=R.gjstr;if(this.op[_-30]?.toLowerCase()==="hidden"){this.op[_-30]=null}}else if(_===40){const L=R.g1;this.recol_s=new Uint16Array(L);this.recol_d=new Uint16Array(L);for(let G=0;G<L;G++){this.recol_s[G]=R.g2;this.recol_d[G]=R.g2}}else if(_===60){const L=R.g1;this.heads=new Uint16Array(L);for(let G=0;G<L;G++){this.heads[G]=R.g2}}else if(_===90){this.resizex=R.g2}else if(_===91){this.resizey=R.g2}else if(_===92){this.resizez=R.g2}else if(_===93){this.minimap=false}else if(_===95){this.vislevel=R.g2}else if(_===97){this.resizeh=R.g2}else if(_===98){this.resizev=R.g2}}getSequencedModel(_,R,L){let G=null;let K=null;if(_1.modelCache){K=_1.modelCache.get(BigInt(this.id));if(!K&&this.models){const Q=new l(this.models.length,null);for(let H=0;H<this.models.length;H++){Q[H]=E.model(this.models[H])}if(Q.length===1){K=Q[0]}else{K=E.modelFromModels(Q,Q.length)}if(this.recol_s&&this.recol_d){for(let H=0;H<this.recol_s.length;H++){K?.recolor(this.recol_s[H],this.recol_d[H])}}K?.createLabelReferences();K?.calculateNormals(64,850,-30,-50,-30,true);if(K){_1.modelCache.put(BigInt(this.id),K)}}}if(K){G=E.modelShareAlpha(K,!this.disposeAlpha);if(_!==-1&&R!==-1){G.applyTransforms(_,R,L)}else if(_!==-1){G.applyTransform(_)}if(this.resizeh!==128||this.resizev!==128){G.scale(this.resizeh,this.resizev,this.resizeh)}G.calculateBoundsCylinder();G.labelFaces=null;G.labelVertices=null;if(this.size===1){G.pickable=true}return G}return null}getHeadModel(){if(!this.heads){return null}const _=new l(this.heads.length,null);for(let L=0;L<this.heads.length;L++){_[L]=E.model(this.heads[L])}let R;if(_.length===1){R=_[0]}else{R=E.modelFromModels(_,_.length)}if(this.recol_s&&this.recol_d){for(let L=0;L<this.recol_s.length;L++){R?.recolor(this.recol_s[L],this.recol_d[L])}}return R}}class i0 extends n0{static count=0;static instances=[];static unpack=(_)=>{const R=new p(_.read("idk.dat"));this.count=R.g2;for(let L=0;L<this.count;L++){this.instances[L]=new i0(L).decodeType(R)}};type=-1;models=null;heads=new Int32Array(5).fill(-1);recol_s=new Int32Array(6);recol_d=new Int32Array(6);disable=false;decode(_,R){if(_===1){this.type=R.g1}else if(_===2){const L=R.g1;this.models=new Int32Array(L);for(let G=0;G<L;G++){this.models[G]=R.g2}}else if(_===3){this.disable=true}else if(_>=40&&_<50){this.recol_s[_-40]=R.g2}else if(_>=50&&_<60){this.recol_d[_-50]=R.g2}else if(_>=60&&_<70){this.heads[_-60]=R.g2}else{}}getModel(){if(!this.models){return null}const _=new l(this.models.length,null);for(let L=0;L<this.models.length;L++){_[L]=E.model(this.models[L])}let R;if(_.length===1){R=_[0]}else{R=E.modelFromModels(_,_.length)}for(let L=0;L<6&&this.recol_s[L]!==0;L++){R?.recolor(this.recol_s[L],this.recol_d[L])}return R}getHeadModel(){let _=0;const R=new l(5,null);for(let G=0;G<5;G++){if(this.heads[G]!==-1){R[_++]=E.model(this.heads[G])}}const L=E.modelFromModels(R,_);for(let G=0;G<6&&this.recol_s[G]!==0;G++){L.recolor(this.recol_s[G],this.recol_d[G])}return L}}class p0 extends n0{static count=0;static instances=[];static modelCache=new s0(30);static unpack=(_)=>{const R=new p(_.read("spotanim.dat"));this.count=R.g2;for(let L=0;L<this.count;L++){this.instances[L]=new p0(L).decodeType(R)}};model=0;anim=-1;seq=null;disposeAlpha=false;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(_,R){if(_===1){this.model=R.g2}else if(_===2){this.anim=R.g2;if(G0.instances){this.seq=G0.instances[this.anim]}}else if(_===3){this.disposeAlpha=true}else if(_===4){this.resizeh=R.g2}else if(_===5){this.resizev=R.g2}else if(_===6){this.orientation=R.g2}else if(_===7){this.ambient=R.g1}else if(_===8){this.contrast=R.g1}else if(_>=40&&_<50){this.recol_s[_-40]=R.g2}else if(_>=50&&_<60){this.recol_d[_-50]=R.g2}else{}}getModel(){let _=p0.modelCache?.get(BigInt(this.id));if(_){return _}_=E.model(this.model);for(let R=0;R<6;R++){if(this.recol_s[0]!==0){_.recolor(this.recol_s[R],this.recol_d[R])}}p0.modelCache?.put(BigInt(this.id),_);return _}}class F1 extends n0{static count=0;static instances=[];static code3=[];static code3Count=0;static unpack=(_)=>{const R=new p(_.read("varp.dat"));this.count=R.g2;for(let L=0;L<this.count;L++){this.instances[L]=new F1(L).decodeType(R)}};scope=0;type=0;code3=false;protect=true;clientcode=0;code7=0;transmit=false;code8=false;decode(_,R){if(_===1){this.scope=R.g1}else if(_===2){this.type=R.g1}else if(_===3){this.code3=true;F1.code3[F1.code3Count++]=this.id}else if(_===4){this.protect=false}else if(_===5){this.clientcode=R.g2}else if(_===6){this.transmit=true}else if(_===7){this.code7=R.g4}else if(_===8){this.code8=true}else if(_===10){this.debugname=R.gjstr}else{}}}class I0{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37=(_)=>{_=_.trim();let R=0n;for(let L=0;L<_.length&&L<12;L++){const G=_.charCodeAt(L);R*=37n;if(G>=65&&G<=90){R+=BigInt(G+1-65)}else if(G>=97&&G<=122){R+=BigInt(G+1-97)}else if(G>=48&&G<=57){R+=BigInt(G+27-48)}}return R};static fromBase37=(_)=>{if(_<0n||_>=6582952005840035281n){return"invalid_name"}if(_%37n===0n){return"invalid_name"}let R=0;const L=Array(12);while(_!==0n){const G=_;_/=37n;L[11-R++]=this.BASE37_LOOKUP[Number(G-_*37n)]}return L.slice(12-R).join("")};static toSentenceCase=(_)=>{const R=[..._.toLowerCase()];let L=true;for(let G=0;G<R.length;G++){const K=R[G];if(L&&K>="a"&&K<="z"){R[G]=K.toUpperCase();L=false}if(K==="."||K==="!"){L=true}}return R.join("")};static toAsterisks=(_)=>{let R="";for(let L=0;L<_.length;L++){R=R+"*"}return R};static formatIPv4=(_)=>{return(_>>24&255)+"."+(_>>16&255)+"."+(_>>8&255)+"."+(_&255)};static formatName=(_)=>{if(_.length===0){return _}const R=[..._];for(let L=0;L<R.length;L++){if(R[L]==="_"){R[L]=" ";if(L+1<R.length&&R[L+1]>="a"&&R[L+1]<="z"){R[L+1]=String.fromCharCode(R[L+1].charCodeAt(0)+65-97)}}}if(R[0]>="a"&&R[0]<="z"){R[0]=String.fromCharCode(R[0].charCodeAt(0)+65-97)}return R.join("")};static hashCode=(_)=>{const R=_.toUpperCase();let L=0n;for(let G=0;G<R.length;G++){L=L*61n+BigInt(R.charCodeAt(G))-32n;L=L+(L>>56n)&0xffffffffffffffn}return L}}class g{static instances=[];static imageCache=null;static modelCache=null;static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INV=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_GRAPHIC=5;static TYPE_MODEL=6;static TYPE_INV_TEXT=7;static BUTTON_OK=1;static BUTTON_TARGET=2;static BUTTON_CLOSE=3;static BUTTON_TOGGLE=4;static BUTTON_SELECT=5;static BUTTON_CONTINUE=6;static CC_FRIENDS_START=1;static CC_FRIENDS_END=100;static CC_FRIENDS_UPDATE_START=101;static CC_FRIENDS_UPDATE_END=200;static CC_ADD_FRIEND=201;static CC_DEL_FRIEND=202;static CC_FRIENDS_SIZE=203;static CC_LOGOUT=205;static CC_CHANGE_HEAD_L=300;static CC_CHANGE_HEAD_R=301;static CC_CHANGE_JAW_L=302;static CC_CHANGE_JAW_R=303;static CC_CHANGE_TORSO_L=304;static CC_CHANGE_TORSO_R=305;static CC_CHANGE_ARMS_L=306;static CC_CHANGE_ARMS_R=307;static CC_CHANGE_HANDS_L=308;static CC_CHANGE_HANDS_R=309;static CC_CHANGE_LEGS_L=310;static CC_CHANGE_LEGS_R=311;static CC_CHANGE_FEET_L=312;static CC_CHANGE_FEET_R=313;static CC_RECOLOUR_HAIR_L=314;static CC_RECOLOUR_HAIR_R=315;static CC_RECOLOUR_TORSO_L=316;static CC_RECOLOUR_TORSO_R=317;static CC_RECOLOUR_LEGS_L=318;static CC_RECOLOUR_LEGS_R=319;static CC_RECOLOUR_FEET_L=320;static CC_RECOLOUR_FEET_R=321;static CC_RECOLOUR_SKIN_L=322;static CC_RECOLOUR_SKIN_R=323;static CC_SWITCH_TO_MALE=324;static CC_SWITCH_TO_FEMALE=325;static CC_ACCEPT_DESIGN=326;static CC_DESIGN_PREVIEW=327;static CC_IGNORES_START=401;static CC_IGNORES_END=500;static CC_ADD_IGNORE=501;static CC_DEL_IGNORE=502;static CC_IGNORES_SIZE=503;static CC_REPORT_INPUT=600;static CC_REPORT_RULE1=601;static CC_REPORT_RULE2=602;static CC_REPORT_RULE3=603;static CC_REPORT_RULE4=604;static CC_REPORT_RULE5=605;static CC_REPORT_RULE6=606;static CC_REPORT_RULE7=607;static CC_REPORT_RULE8=608;static CC_REPORT_RULE9=609;static CC_REPORT_RULE10=610;static CC_REPORT_RULE11=611;static CC_REPORT_RULE12=612;static CC_MOD_MUTE=613;static CC_LAST_LOGIN_INFO=650;static CC_UNREAD_MESSAGES=651;static CC_RECOVERY1=652;static CC_RECOVERY2=653;static CC_RECOVERY3=654;static CC_LAST_LOGIN_INFO2=655;static unpack=(_,R,L)=>{this.imageCache=new s0(50000);this.modelCache=new s0(50000);const G=new p(_.read("data"));let K=-1;G.pos+=2;while(G.pos<G.length){let Q=G.g2;if(Q===65535){K=G.g2;Q=G.g2}const H=this.instances[Q]=new g;H.id=Q;H.layer=K;H.type=G.g1;H.buttonType=G.g1;H.clientCode=G.g2;H.width=G.g2;H.height=G.g2;H.overLayer=G.g1;if(H.overLayer===0){H.overLayer=-1}else{H.overLayer=(H.overLayer-1<<8)+G.g1}const $=G.g1;if($>0){H.scriptComparator=new Uint8Array($);H.scriptOperand=new Uint16Array($);for(let O=0;O<$;O++){H.scriptComparator[O]=G.g1;H.scriptOperand[O]=G.g2}}const J=G.g1;if(J>0){H.scripts=new l(J,null);for(let O=0;O<J;O++){const q=G.g2;const N=new Uint16Array(q);H.scripts[O]=N;for(let U=0;U<q;U++){N[U]=G.g2}}}if(H.type===g.TYPE_LAYER){H.scroll=G.g2;H.hide=G.g1===1;const O=G.g1;H.childId=new Array(O);H.childX=new Array(O);H.childY=new Array(O);for(let q=0;q<O;q++){H.childId[q]=G.g2;H.childX[q]=G.g2b;H.childY[q]=G.g2b}}if(H.type===g.TYPE_UNUSED){G.pos+=3}if(H.type===g.TYPE_INV){H.invSlotObjId=new Int32Array(H.width*H.height);H.invSlotObjCount=new Int32Array(H.width*H.height);H.draggable=G.g1===1;H.interactable=G.g1===1;H.usable=G.g1===1;H.marginX=G.g1;H.marginY=G.g1;H.invSlotOffsetX=new Int16Array(20);H.invSlotOffsetY=new Int16Array(20);H.invSlotSprite=new l(20,null);for(let O=0;O<20;O++){if(G.g1===1){H.invSlotOffsetX[O]=G.g2b;H.invSlotOffsetY[O]=G.g2b;const q=G.gjstr;if(q.length>0){const N=q.lastIndexOf(",");H.invSlotSprite[O]=this.getImage(R,q.substring(0,N),parseInt(q.substring(N+1),10))}}}H.iops=new l(5,null);for(let O=0;O<5;O++){const q=G.gjstr;H.iops[O]=q;if(q.length===0){H.iops[O]=null}}}if(H.type===g.TYPE_RECT){H.fill=G.g1===1}if(H.type===g.TYPE_TEXT||H.type===g.TYPE_UNUSED){H.center=G.g1===1;const O=G.g1;if(L){H.font=L[O]}H.shadowed=G.g1===1}if(H.type===g.TYPE_TEXT){H.text=G.gjstr;H.activeText=G.gjstr}if(H.type===g.TYPE_UNUSED||H.type===g.TYPE_RECT||H.type===g.TYPE_TEXT){H.colour=G.g4}if(H.type===g.TYPE_RECT||H.type===g.TYPE_TEXT){H.activeColour=G.g4;H.overColour=G.g4}if(H.type===g.TYPE_GRAPHIC){const O=G.gjstr;if(O.length>0){const N=O.lastIndexOf(",");H.graphic=this.getImage(R,O.substring(0,N),parseInt(O.substring(N+1),10))}const q=G.gjstr;if(q.length>0){const N=q.lastIndexOf(",");H.activeGraphic=this.getImage(R,q.substring(0,N),parseInt(q.substring(N+1),10))}}if(H.type===g.TYPE_MODEL){const O=G.g1;if(O!==0){H.model=this.getModel((O-1<<8)+G.g1)}const q=G.g1;if(q!==0){H.activeModel=this.getModel((q-1<<8)+G.g1)}H.anim=G.g1;if(H.anim===0){H.anim=-1}else{H.anim=(H.anim-1<<8)+G.g1}H.activeAnim=G.g1;if(H.activeAnim===0){H.activeAnim=-1}else{H.activeAnim=(H.activeAnim-1<<8)+G.g1}H.zoom=G.g2;H.xan=G.g2;H.yan=G.g2}if(H.type===g.TYPE_INV_TEXT){H.invSlotObjId=new Int32Array(H.width*H.height);H.invSlotObjCount=new Int32Array(H.width*H.height);H.center=G.g1===1;const O=G.g1;if(L){H.font=L[O]}H.shadowed=G.g1===1;H.colour=G.g4;H.marginX=G.g2b;H.marginY=G.g2b;H.interactable=G.g1===1;H.iops=new l(5,null);for(let q=0;q<5;q++){const N=G.gjstr;H.iops[q]=N;if(N.length===0){H.iops[q]=null}}}if(H.buttonType===g.BUTTON_TARGET||H.type===g.TYPE_INV){H.actionVerb=G.gjstr;H.action=G.gjstr;H.actionTarget=G.g2}if(H.buttonType===g.BUTTON_OK||H.buttonType===g.BUTTON_TOGGLE||H.buttonType===g.BUTTON_SELECT||H.buttonType===g.BUTTON_CONTINUE){H.option=G.gjstr;if(H.option.length===0){if(H.buttonType===g.BUTTON_OK){H.option="Ok"}else if(H.buttonType===g.BUTTON_TOGGLE){H.option="Select"}else if(H.buttonType===g.BUTTON_SELECT){H.option="Select"}else if(H.buttonType===g.BUTTON_CONTINUE){H.option="Continue"}}}}this.imageCache=null;this.modelCache=null};static getImage=(_,R,L)=>{const G=I0.hashCode(R)<<8n|BigInt(L);if(this.imageCache){const Q=this.imageCache.get(G);if(Q){return Q}}let K;try{K=V0.fromArchive(_,R,L);this.imageCache?.put(G,K)}catch(Q){return null}return K};static getModel=(_)=>{if(this.modelCache){const L=this.modelCache.get(BigInt(_));if(L){return L}}const R=E.model(_);this.modelCache?.put(BigInt(_),R);return R};id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=false;draggable=false;interactable=false;usable=false;marginX=0;marginY=0;invSlotOffsetX=null;invSlotOffsetY=null;invSlotSprite=null;iops=null;fill=false;center=false;font=null;shadowed=false;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=null;activeModel=null;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null;x=0;y=0;scrollPosition=0;invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;getModel(_,R,L){let G=this.model;if(L){G=this.activeModel}if(!G){return null}if(_===-1&&R===-1&&!G.faceColor){return G}const K=E.modelShareColored(G,true,true,false);if(_!==-1||R!==-1){K.createLabelReferences()}if(_!==-1){K.applyTransform(_)}if(R!==-1){K.applyTransform(R)}K.calculateNormals(64,768,-50,-10,-50,true);return K}getAbsoluteX(){if(this.layer===this.id){return this.x}let _=g.instances[this.layer];if(!_.childId||!_.childX||!_.childY){return this.x}let R=_.childId.indexOf(this.id);if(R===-1){return this.x}let L=_.childX[R];while(_.layer!==_.id){const G=g.instances[_.layer];if(G.childId&&G.childX&&G.childY){R=G.childId.indexOf(_.id);if(R!==-1){L+=G.childX[R]}}_=G}return L}getAbsoluteY(){if(this.layer===this.id){return this.y}let _=g.instances[this.layer];if(!_.childId||!_.childX||!_.childY){return this.y}let R=_.childId.indexOf(this.id);if(R===-1){return this.y}let L=_.childY[R];while(_.layer!==_.id){const G=g.instances[_.layer];if(G.childId&&G.childX&&G.childY){R=G.childId.indexOf(_.id);if(R!==-1){L+=G.childY[R]}}_=G}return L}outline(_){const R=this.getAbsoluteX();const L=this.getAbsoluteY();k.drawRect(R,L,this.width,this.height,_)}move(_,R){if(this.layer===this.id){return}this.x=0;this.y=0;const L=g.instances[this.layer];if(L.childId&&L.childX&&L.childY){const G=L.childId.indexOf(this.id);if(G!==-1){L.childX[G]=_;L.childY[G]=R}}}delete(){if(this.layer===this.id){return}const _=g.instances[this.layer];if(_.childId&&_.childX&&_.childY){const R=_.childId.indexOf(this.id);if(R!==-1){_.childId.splice(R,1);_.childX.splice(R,1);_.childY.splice(R,1)}}}}class S{static OPEN=0;static WALL_NORTH_WEST=1;static WALL_NORTH=2;static WALL_NORTH_EAST=4;static WALL_EAST=8;static WALL_SOUTH_EAST=S.WALL_NORTH_WEST<<4;static WALL_SOUTH=S.WALL_NORTH<<4;static WALL_SOUTH_WEST=S.WALL_NORTH_EAST<<4;static WALL_WEST=S.WALL_EAST<<4;static LOC=256;static WALL_NORTH_WEST_PROJ_BLOCKER=512;static WALL_NORTH_PROJ_BLOCKER=1024;static WALL_NORTH_EAST_PROJ_BLOCKER=2048;static WALL_EAST_PROJ_BLOCKER=4096;static WALL_SOUTH_EAST_PROJ_BLOCKER=S.WALL_NORTH_WEST_PROJ_BLOCKER<<4;static WALL_SOUTH_PROJ_BLOCKER=S.WALL_NORTH_PROJ_BLOCKER<<4;static WALL_SOUTH_WEST_PROJ_BLOCKER=S.WALL_NORTH_EAST_PROJ_BLOCKER<<4;static WALL_WEST_PROJ_BLOCKER=S.WALL_EAST_PROJ_BLOCKER<<4;static LOC_PROJ_BLOCKER=S.LOC<<9;static ANTIMACRO=524288;static FLOOR=2097152;static FLOOR_BLOCKED=S.FLOOR|S.ANTIMACRO;static WALK_BLOCKED=S.LOC|S.FLOOR_BLOCKED;static BLOCK_SOUTH=S.WALL_NORTH|S.WALK_BLOCKED;static BLOCK_WEST=S.WALL_EAST|S.WALK_BLOCKED;static BLOCK_SOUTH_WEST=S.WALL_NORTH|S.WALL_NORTH_EAST|S.BLOCK_WEST;static BLOCK_NORTH=S.WALL_SOUTH|S.WALK_BLOCKED;static BLOCK_NORTH_WEST=S.WALL_EAST|S.WALL_SOUTH_EAST|S.BLOCK_NORTH;static BLOCK_EAST=S.WALL_WEST|S.WALK_BLOCKED;static BLOCK_SOUTH_EAST=S.WALL_NORTH_WEST|S.WALL_NORTH|S.BLOCK_EAST;static BLOCK_NORTH_EAST=S.WALL_SOUTH|S.WALL_SOUTH_WEST|S.BLOCK_EAST;static BOUNDS=16777215}class K1{static NORTH=1;static EAST=2;static SOUTH=4;static WEST=8}class s{static LEVELS=4;static SIZE=104;static index=(_,R)=>_*s.SIZE+R;offsetX;offsetZ;sizeX;sizeZ;flags;constructor(){this.offsetX=0;this.offsetZ=0;this.sizeX=s.SIZE;this.sizeZ=s.SIZE;this.flags=new Int32Array(this.sizeX*this.sizeZ);this.reset()}reset=()=>{for(let _=0;_<this.sizeX;_++){for(let R=0;R<this.sizeZ;R++){const L=s.index(_,R);if(_===0||R===0||_===this.sizeX-1||R===this.sizeZ-1){this.flags[L]=S.BOUNDS}else{this.flags[L]=S.OPEN}}}};addFloor=(_,R)=>{this.flags[s.index(_-this.offsetX,R-this.offsetZ)]|=S.FLOOR};removeFloor=(_,R)=>{this.flags[s.index(_-this.offsetX,R-this.offsetZ)]&=~S.FLOOR};addLoc=(_,R,L,G,K,Q)=>{let H=S.LOC;if(Q){H|=S.LOC_PROJ_BLOCKER}const $=_-this.offsetX;const J=R-this.offsetZ;if(K===x.NORTH||K===x.SOUTH){const O=L;L=G;G=O}for(let O=$;O<$+L;O++){if(!(O>=0&&O<this.sizeX)){continue}for(let q=J;q<J+G;q++){if(!(q>=0&&q<this.sizeZ)){continue}this.add(O,q,H)}}};removeLoc=(_,R,L,G,K,Q)=>{let H=S.LOC;if(Q){H|=S.LOC_PROJ_BLOCKER}const $=_-this.offsetX;const J=R-this.offsetZ;if(K===x.NORTH||K===x.SOUTH){const O=L;L=G;G=O}for(let O=$;O<$+L;O++){if(!(O>=0&&O<this.sizeX)){continue}for(let q=J;q<J+G;q++){if(!(q>=0&&q<this.sizeZ)){continue}this.remove(O,q,H)}}};addWall=(_,R,L,G,K)=>{const Q=_-this.offsetX;const H=R-this.offsetZ;const $=K?S.WALL_WEST_PROJ_BLOCKER:S.WALL_WEST;const J=K?S.WALL_EAST_PROJ_BLOCKER:S.WALL_EAST;const O=K?S.WALL_NORTH_PROJ_BLOCKER:S.WALL_NORTH;const q=K?S.WALL_SOUTH_PROJ_BLOCKER:S.WALL_SOUTH;const N=K?S.WALL_NORTH_WEST_PROJ_BLOCKER:S.WALL_NORTH_WEST;const U=K?S.WALL_SOUTH_EAST_PROJ_BLOCKER:S.WALL_SOUTH_EAST;const b=K?S.WALL_NORTH_EAST_PROJ_BLOCKER:S.WALL_NORTH_EAST;const I=K?S.WALL_SOUTH_WEST_PROJ_BLOCKER:S.WALL_SOUTH_WEST;if(L===y.WALL_STRAIGHT.id){if(G===x.WEST){this.add(Q,H,$);this.add(Q-1,H,J)}else if(G===x.NORTH){this.add(Q,H,O);this.add(Q,H+1,q)}else if(G===x.EAST){this.add(Q,H,J);this.add(Q+1,H,$)}else if(G===x.SOUTH){this.add(Q,H,q);this.add(Q,H-1,O)}}else if(L===y.WALL_DIAGONAL_CORNER.id||L===y.WALL_SQUARE_CORNER.id){if(G===x.WEST){this.add(Q,H,N);this.add(Q-1,H+1,U)}else if(G===x.NORTH){this.add(Q,H,b);this.add(Q+1,H+1,I)}else if(G===x.EAST){this.add(Q,H,U);this.add(Q+1,H-1,N)}else if(G===x.SOUTH){this.add(Q,H,I);this.add(Q-1,H-1,b)}}else if(L===y.WALL_L.id){if(G===x.WEST){this.add(Q,H,O|$);this.add(Q-1,H,J);this.add(Q,H+1,q)}else if(G===x.NORTH){this.add(Q,H,O|J);this.add(Q,H+1,q);this.add(Q+1,H,$)}else if(G===x.EAST){this.add(Q,H,q|J);this.add(Q+1,H,$);this.add(Q,H-1,O)}else if(G===x.SOUTH){this.add(Q,H,q|$);this.add(Q,H-1,O);this.add(Q-1,H,J)}}if(K){this.addWall(_,R,L,G,false)}};removeWall=(_,R,L,G,K)=>{const Q=_-this.offsetX;const H=R-this.offsetZ;const $=K?S.WALL_WEST_PROJ_BLOCKER:S.WALL_WEST;const J=K?S.WALL_EAST_PROJ_BLOCKER:S.WALL_EAST;const O=K?S.WALL_NORTH_PROJ_BLOCKER:S.WALL_NORTH;const q=K?S.WALL_SOUTH_PROJ_BLOCKER:S.WALL_SOUTH;const N=K?S.WALL_NORTH_WEST_PROJ_BLOCKER:S.WALL_NORTH_WEST;const U=K?S.WALL_SOUTH_EAST_PROJ_BLOCKER:S.WALL_SOUTH_EAST;const b=K?S.WALL_NORTH_EAST_PROJ_BLOCKER:S.WALL_NORTH_EAST;const I=K?S.WALL_SOUTH_WEST_PROJ_BLOCKER:S.WALL_SOUTH_WEST;if(L===y.WALL_STRAIGHT.id){if(G===x.WEST){this.remove(Q,H,$);this.remove(Q-1,H,J)}else if(G===x.NORTH){this.remove(Q,H,O);this.remove(Q,H+1,q)}else if(G===x.EAST){this.remove(Q,H,J);this.remove(Q+1,H,$)}else if(G===x.SOUTH){this.remove(Q,H,q);this.remove(Q,H-1,O)}}else if(L===y.WALL_DIAGONAL_CORNER.id||L===y.WALL_SQUARE_CORNER.id){if(G===x.WEST){this.remove(Q,H,N);this.remove(Q-1,H+1,U)}else if(G===x.NORTH){this.remove(Q,H,b);this.remove(Q+1,H+1,I)}else if(G===x.EAST){this.remove(Q,H,U);this.remove(Q+1,H-1,N)}else if(G===x.SOUTH){this.remove(Q,H,I);this.remove(Q-1,H-1,b)}}else if(L===y.WALL_L.id){if(G===x.WEST){this.remove(Q,H,O|$);this.remove(Q-1,H,J);this.remove(Q,H+1,q)}else if(G===x.NORTH){this.remove(Q,H,O|J);this.remove(Q,H+1,q);this.remove(Q+1,H,$)}else if(G===x.EAST){this.remove(Q,H,q|J);this.remove(Q+1,H,$);this.remove(Q,H-1,O)}else if(G===x.SOUTH){this.remove(Q,H,q|$);this.remove(Q,H-1,O);this.remove(Q-1,H,J)}}if(K){this.removeWall(_,R,L,G,false)}};reachedWall=(_,R,L,G,K,Q)=>{if(_===L&&R===G){return true}const H=_-this.offsetX;const $=R-this.offsetZ;const J=L-this.offsetX;const O=G-this.offsetZ;const q=s.index(H,$);if(K===y.WALL_STRAIGHT.id){if(Q===x.WEST){if(H===J-1&&$===O){return true}else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN){return true}}else if(Q===x.NORTH){if(H===J&&$===O+1){return true}else if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN){return true}else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN){return true}}else if(Q===x.EAST){if(H===J+1&&$===O){return true}else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN){return true}}else if(Q===x.SOUTH){if(H===J&&$===O-1){return true}else if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN){return true}else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN){return true}}}else if(K===y.WALL_L.id){if(Q===x.WEST){if(H===J-1&&$===O){return true}else if(H===J&&$===O+1){return true}else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN){return true}}else if(Q===x.NORTH){if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN){return true}else if(H===J&&$===O+1){return true}else if(H===J+1&&$===O){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN){return true}}else if(Q===x.EAST){if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN){return true}else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN){return true}else if(H===J+1&&$===O){return true}else if(H===J&&$===O-1){return true}}else if(Q===x.SOUTH){if(H===J-1&&$===O){return true}else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN){return true}else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN){return true}else if(H===J&&$===O-1){return true}}}else if(K===y.WALL_DIAGONAL.id){if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN){return true}else if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN){return true}else if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN){return true}}return false};reachedWallDecoration=(_,R,L,G,K,Q)=>{if(_===L&&R===G){return true}const H=_-this.offsetX;const $=R-this.offsetZ;const J=L-this.offsetX;const O=G-this.offsetZ;const q=s.index(H,$);if(K===y.WALLDECOR_DIAGONAL_OFFSET.id||K===y.WALLDECOR_DIAGONAL_NOOFFSET.id){if(K===y.WALLDECOR_DIAGONAL_NOOFFSET.id){Q=Q+2&3}if(Q===x.WEST){if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN){return true}}else if(Q===x.NORTH){if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN){return true}}else if(Q===x.EAST){if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN){return true}else if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN){return true}}else if(Q===x.SOUTH){if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN){return true}else if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN){return true}}}else if(K===y.WALLDECOR_DIAGONAL_BOTH.id){if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN){return true}else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN){return true}else if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN){return true}else if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN){return true}}return false};reachedLoc=(_,R,L,G,K,Q,H)=>{const $=L+K-1;const J=G+Q-1;const O=s.index(_-this.offsetX,R-this.offsetZ);if(_>=L&&_<=$&&R>=G&&R<=J){return true}else if(_===L-1&&R>=G&&R<=J&&(this.flags[O]&S.WALL_EAST)===S.OPEN&&(H&K1.WEST)===S.OPEN){return true}else if(_===$+1&&R>=G&&R<=J&&(this.flags[O]&S.WALL_WEST)===S.OPEN&&(H&K1.EAST)===S.OPEN){return true}else if(R===G-1&&_>=L&&_<=$&&(this.flags[O]&S.WALL_NORTH)===S.OPEN&&(H&K1.SOUTH)===S.OPEN){return true}else if(R===J+1&&_>=L&&_<=$&&(this.flags[O]&S.WALL_SOUTH)===S.OPEN&&(H&K1.NORTH)===S.OPEN){return true}return false};add=(_,R,L)=>{this.flags[s.index(_,R)]|=L};remove=(_,R,L)=>{this.flags[s.index(_,R)]&=S.BOUNDS-L}}class X8{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(_,R,L,G,K,Q,H,$,J,O,q){this.minTileX=_;this.maxTileX=R;this.minTileZ=L;this.maxTileZ=G;this.type=K;this.minX=Q;this.maxX=H;this.minZ=$;this.maxZ=J;this.minY=O;this.maxY=q}}class W8{y;x;z;model;bitset;info;constructor(_,R,L,G,K,Q){this.y=_;this.x=R;this.z=L;this.model=G;this.bitset=K;this.info=Q}}class A8{level;y;x;z;model;entity;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;bitset;info;distance=0;cycle=0;constructor(_,R,L,G,K,Q,H,$,J,O,q,N,U){this.level=_;this.y=R;this.x=L;this.z=G;this.model=K;this.entity=Q;this.yaw=H;this.minSceneTileX=$;this.maxSceneTileX=J;this.minSceneTileZ=O;this.maxSceneTileZ=q;this.bitset=N;this.info=U}}class B8{y;x;z;topObj;middleObj;bottomObj;bitset;offset;constructor(_,R,L,G,K,Q,H,$){this.y=_;this.x=R;this.z=L;this.topObj=G;this.middleObj=K;this.bottomObj=Q;this.bitset=H;this.offset=$}}class R1 extends D0{level;x;z;occludeLevel;locs;locSpan;underlay=null;overlay=null;wall=null;wallDecoration=null;groundDecoration=null;objStack=null;bridge=null;locCount=0;locSpans=0;drawLevel=0;visible=false;update=false;containsLocs=false;checkLocSpans=0;blockLocSpans=0;inverseBlockLocSpans=0;backWallTypes=0;constructor(_,R,L){super();this.occludeLevel=this.level=_;this.x=R;this.z=L;this.locs=new l(5,null);this.locSpan=new Int32Array(5)}}class _0{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;angle;backgroundRgb;foregroundRgb;constructor(_,R,L,G,K,Q,H,$,J,O,q,N,U,b,I,j,F,T,Y){this.flat=!(F!==G||F!==b||F!==$);this.shape=R;this.angle=Q;this.backgroundRgb=U;this.foregroundRgb=J;const u=_0.SHAPE_POINTS[R];const w=u.length;this.vertexX=new Int32Array(w);this.vertexY=new Int32Array(w);this.vertexZ=new Int32Array(w);const h=new Int32Array(w);const v=new Int32Array(w);const n=_*_0.FULL_SQUARE;const A=T*_0.FULL_SQUARE;for(let m=0;m<w;m++){let M=u[m];if((M&1)===0&&M<=8){M=(M-Q-Q-1&7)+1}if(M>8&&M<=12){M=(M-Q-9&3)+9}if(M>12&&M<=16){M=(M-Q-13&3)+13}let r;let a;let C;let R0;let e;if(M===1){r=n;a=A;C=F;R0=H;e=O}else if(M===2){r=n+_0.HALF_SQUARE;a=A;C=F+G>>1;R0=H+Y>>1;e=O+L>>1}else if(M===3){r=n+_0.FULL_SQUARE;a=A;C=G;R0=Y;e=L}else if(M===4){r=n+_0.FULL_SQUARE;a=A+_0.HALF_SQUARE;C=G+b>>1;R0=Y+K>>1;e=L+I>>1}else if(M===5){r=n+_0.FULL_SQUARE;a=A+_0.FULL_SQUARE;C=b;R0=K;e=I}else if(M===6){r=n+_0.HALF_SQUARE;a=A+_0.FULL_SQUARE;C=b+$>>1;R0=K+j>>1;e=I+N>>1}else if(M===7){r=n;a=A+_0.FULL_SQUARE;C=$;R0=j;e=N}else if(M===8){r=n;a=A+_0.HALF_SQUARE;C=$+F>>1;R0=j+H>>1;e=N+O>>1}else if(M===9){r=n+_0.HALF_SQUARE;a=A+_0.CORNER_SMALL;C=F+G>>1;R0=H+Y>>1;e=O+L>>1}else if(M===10){r=n+_0.CORNER_BIG;a=A+_0.HALF_SQUARE;C=G+b>>1;R0=Y+K>>1;e=L+I>>1}else if(M===11){r=n+_0.HALF_SQUARE;a=A+_0.CORNER_BIG;C=b+$>>1;R0=K+j>>1;e=I+N>>1}else if(M===12){r=n+_0.CORNER_SMALL;a=A+_0.HALF_SQUARE;C=$+F>>1;R0=j+H>>1;e=N+O>>1}else if(M===13){r=n+_0.CORNER_SMALL;a=A+_0.CORNER_SMALL;C=F;R0=H;e=O}else if(M===14){r=n+_0.CORNER_BIG;a=A+_0.CORNER_SMALL;C=G;R0=Y;e=L}else if(M===15){r=n+_0.CORNER_BIG;a=A+_0.CORNER_BIG;C=b;R0=K;e=I}else{r=n+_0.CORNER_SMALL;a=A+_0.CORNER_BIG;C=$;R0=j;e=N}this.vertexX[m]=r;this.vertexY[m]=C;this.vertexZ[m]=a;h[m]=R0;v[m]=e}const P=_0.SHAPE_PATHS[R];const z=P.length/4|0;this.triangleVertexA=new Int32Array(z);this.triangleVertexB=new Int32Array(z);this.triangleVertexC=new Int32Array(z);this.triangleColorA=new Int32Array(z);this.triangleColorB=new Int32Array(z);this.triangleColorC=new Int32Array(z);if(q!==-1){this.triangleTextureIds=new Int32Array(z)}else{this.triangleTextureIds=null}let f=0;for(let m=0;m<z;m++){const M=P[f];let r=P[f+1];let a=P[f+2];let C=P[f+3];f+=4;if(r<4){r=r-Q&3}if(a<4){a=a-Q&3}if(C<4){C=C-Q&3}this.triangleVertexA[m]=r;this.triangleVertexB[m]=a;this.triangleVertexC[m]=C;if(M===0){this.triangleColorA[m]=h[r];this.triangleColorB[m]=h[a];this.triangleColorC[m]=h[C];if(this.triangleTextureIds){this.triangleTextureIds[m]=-1}}else{this.triangleColorA[m]=v[r];this.triangleColorB[m]=v[a];this.triangleColorC[m]=v[C];if(this.triangleTextureIds){this.triangleTextureIds[m]=q}}}}}class T1{static PLAIN=0;static DIAGONAL=1;static LEFT_SEMI_DIAGONAL_SMALL=2;static RIGHT_SEMI_DIAGONAL_SMALL=3;static LEFT_SEMI_DIAGONAL_BIG=4;static RIGHT_SEMI_DIAGONAL_BIG=5;static HALF_SQUARE=6;static CORNER_SMALL=7;static CORNER_BIG=8;static FAN_SMALL=9;static FAN_BIG=10;static TRAPEZIUM=11}class _8{southwestColor;southeastColor;northeastColor;northwestColor;textureId;color;flat;constructor(_,R,L,G,K,Q,H){this.southwestColor=_;this.southeastColor=R;this.northeastColor=L;this.northwestColor=G;this.textureId=K;this.color=Q;this.flat=H}}class h8{y;x;z;typeA;typeB;modelA;modelB;bitset;info;constructor(_,R,L,G,K,Q,H,$,J){this.y=_;this.x=R;this.z=L;this.typeA=G;this.typeB=K;this.modelA=Q;this.modelB=H;this.bitset=$;this.info=J}}class m8{y;x;z;type;angle;model;bitset;info;constructor(_,R,L,G,K,Q,H,$){this.y=_;this.x=R;this.z=L;this.type=G;this.angle=K;this.model=Q;this.bitset=H;this.info=$}}class V{static visibilityMatrix=new k8(8,32,51,51,false);static locBuffer=new l(100,null);static levelOccluderCount=new Int32Array(s.LEVELS);static levelOccluders=new D5(s.LEVELS,500,null);static activeOccluders=new l(500,null);static drawTileQueue=new g0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=false;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS=Int8Array.of(0,0,2,0,0,2,1,1,0);static WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS=Int8Array.of(2,0,0,2,0,0,0,4,4);static WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS=Int8Array.of(0,4,4,8,0,0,8,0,0);static WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=true;static init=(_,R,L,G,K)=>{this.viewportLeft=0;this.viewportTop=0;this.viewportRight=_;this.viewportBottom=R;this.viewportCenterX=_/2|0;this.viewportCenterY=R/2|0;const Q=new k8(9,32,53,53,false);for(let H=128;H<=384;H+=32){for(let $=0;$<2048;$+=64){this.sinEyePitch=B.sin[H];this.cosEyePitch=B.cos[H];this.sinEyeYaw=B.sin[$];this.cosEyeYaw=B.cos[$];const J=(H-128)/32|0;const O=$/64|0;for(let q=-26;q<=26;q++){for(let N=-26;N<=26;N++){const U=q*128;const b=N*128;let I=false;for(let j=-L;j<=G;j+=128){if(this.testPoint(U,b,K[J]+j)){I=true;break}}Q[J][O][q+25+1][N+25+1]=I}}}}for(let H=0;H<8;H++){for(let $=0;$<32;$++){for(let J=-25;J<25;J++){for(let O=-25;O<25;O++){let q=false;_:for(let N=-1;N<=1;N++){for(let U=-1;U<=1;U++){if(Q[H][$][J+N+25+1][O+U+25+1]){q=true;break _}if(Q[H][($+1)%31][J+N+25+1][O+U+25+1]){q=true;break _}if(Q[H+1][$][J+N+25+1][O+U+25+1]){q=true;break _}if(Q[H+1][($+1)%31][J+N+25+1][O+U+25+1]){q=true;break _}}}this.visibilityMatrix[H][$][J+25][O+25]=q}}}}};static addOccluder=(_,R,L,G,K,Q,H,$)=>{V.levelOccluders[_][V.levelOccluderCount[_]++]=new X8(L/128|0,Q/128|0,K/128|0,$/128|0,R,L,Q,K,$,G,H)};static testPoint=(_,R,L)=>{const G=R*this.sinEyeYaw+_*this.cosEyeYaw>>16;const K=R*this.cosEyeYaw-_*this.sinEyeYaw>>16;const Q=L*this.sinEyePitch+K*this.cosEyePitch>>16;const H=L*this.cosEyePitch-K*this.sinEyePitch>>16;if(Q<50||Q>3500){return false}const $=this.viewportCenterX+((G<<9)/Q|0);const J=this.viewportCenterY+((H<<9)/Q|0);return $>=this.viewportLeft&&$<=this.viewportRight&&J>=this.viewportTop&&J<=this.viewportBottom};maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(_,R,L,G){this.maxLevel=L;this.maxTileX=G;this.maxTileZ=R;this.levelTiles=new e1(L,G,R,null);this.levelTileOcclusionCycles=new A1(L,G+1,R+1);this.levelHeightmaps=_;this.temporaryLocs=new l(5000,null);this.mergeIndexA=new Int32Array(1e4);this.mergeIndexB=new Int32Array(1e4);this.reset()}reset=()=>{for(let _=0;_<this.maxLevel;_++){for(let R=0;R<this.maxTileX;R++){for(let L=0;L<this.maxTileZ;L++){this.levelTiles[_][R][L]=null}}}for(let _=0;_<s.LEVELS;_++){for(let R=0;R<V.levelOccluderCount[_];R++){V.levelOccluders[_][R]=null}V.levelOccluderCount[_]=0}for(let _=0;_<this.temporaryLocCount;_++){this.temporaryLocs[_]=null}this.temporaryLocCount=0;V.locBuffer.fill(null)};setMinLevel=(_)=>{this.minLevel=_;for(let R=0;R<this.maxTileX;R++){for(let L=0;L<this.maxTileZ;L++){this.levelTiles[_][R][L]=new R1(_,R,L)}}};setBridge=(_,R)=>{const L=this.levelTiles[0][_][R];for(let K=0;K<3;K++){this.levelTiles[K][_][R]=this.levelTiles[K+1][_][R];const Q=this.levelTiles[K][_][R];if(Q){Q.level--}}if(!this.levelTiles[0][_][R]){this.levelTiles[0][_][R]=new R1(0,_,R)}const G=this.levelTiles[0][_][R];if(G){G.bridge=L}this.levelTiles[3][_][R]=null};setDrawLevel=(_,R,L,G)=>{const K=this.levelTiles[_][R][L];if(!K){return}K.drawLevel=G};setTile=(_,R,L,G,K,Q,H,$,J,O,q,N,U,b,I,j,F,T,Y,u)=>{if(G===T1.PLAIN){for(let h=_;h>=0;h--){if(!this.levelTiles[h][R][L]){this.levelTiles[h][R][L]=new R1(h,R,L)}}const w=this.levelTiles[_][R][L];if(w){w.underlay=new _8(q,N,U,b,-1,Y,false)}}else if(G===T1.DIAGONAL){for(let h=_;h>=0;h--){if(!this.levelTiles[h][R][L]){this.levelTiles[h][R][L]=new R1(h,R,L)}}const w=this.levelTiles[_][R][L];if(w){w.underlay=new _8(I,j,F,T,Q,u,H===$&&H===J&&H===O)}}else{for(let h=_;h>=0;h--){if(!this.levelTiles[h][R][L]){this.levelTiles[h][R][L]=new R1(h,R,L)}}const w=this.levelTiles[_][R][L];if(w){w.overlay=new _0(R,G,j,$,U,K,q,O,u,I,Q,T,Y,J,F,b,H,L,N)}}};addGroundDecoration=(_,R,L,G,K,Q,H)=>{if(!this.levelTiles[R][L][G]){this.levelTiles[R][L][G]=new R1(R,L,G)}const $=this.levelTiles[R][L][G];if($){$.groundDecoration=new W8(K,L*128+64,G*128+64,_,Q,H)}};removeGroundDecoration=(_,R,L)=>{const G=this.levelTiles[_][R][L];if(!G){return}G.groundDecoration=null};addObjStack=(_,R,L,G,K,Q,H,$)=>{let J=0;const O=this.levelTiles[G][_][R];if(O){for(let N=0;N<O.locCount;N++){const U=O.locs[N];if(!U||!U.model){continue}const b=U.model.objRaise;if(b>J){J=b}}}else{this.levelTiles[G][_][R]=new R1(G,_,R)}const q=this.levelTiles[G][_][R];if(q){q.objStack=new B8(L,_*128+64,R*128+64,Q,H,$,K,J)}};removeObjStack=(_,R,L)=>{const G=this.levelTiles[_][R][L];if(!G){return}G.objStack=null};addWall=(_,R,L,G,K,Q,H,$,J,O)=>{if(!H&&!$){return}for(let N=_;N>=0;N--){if(!this.levelTiles[N][R][L]){this.levelTiles[N][R][L]=new R1(N,R,L)}}const q=this.levelTiles[_][R][L];if(q){q.wall=new h8(G,R*128+64,L*128+64,K,Q,H,$,J,O)}};removeWall=(_,R,L,G)=>{const K=this.levelTiles[_][R][L];if(G===1&&K){K.wall=null}};setWallDecoration=(_,R,L,G,K,Q,H,$,J,O,q)=>{if(!$){return}for(let U=_;U>=0;U--){if(!this.levelTiles[U][R][L]){this.levelTiles[U][R][L]=new R1(U,R,L)}}const N=this.levelTiles[_][R][L];if(N){N.wallDecoration=new m8(G,R*128+K+64,L*128+Q+64,q,O,$,H,J)}};removeWallDecoration=(_,R,L)=>{const G=this.levelTiles[_][R][L];if(!G){return}G.wallDecoration=null};setWallDecorationOffset=(_,R,L,G)=>{const K=this.levelTiles[_][R][L];if(!K){return}const Q=K.wallDecoration;if(!Q){return}const H=R*128+64;const $=L*128+64;Q.x=H+((Q.x-H)*G/16|0);Q.z=$+((Q.z-$)*G/16|0)};setWallDecorationModel=(_,R,L,G)=>{if(!G){return}const K=this.levelTiles[_][R][L];if(!K){return}const Q=K.wallDecoration;if(!Q){return}Q.model=G};setGroundDecorationModel=(_,R,L,G)=>{if(!G){return}const K=this.levelTiles[_][R][L];if(!K){return}const Q=K.groundDecoration;if(!Q){return}Q.model=G};setWallModel=(_,R,L,G)=>{if(!G){return}const K=this.levelTiles[_][R][L];if(!K){return}const Q=K.wall;if(!Q){return}Q.modelA=G};setWallModels=(_,R,L,G,K)=>{if(!G){return}const Q=this.levelTiles[L][_][R];if(!Q){return}const H=Q.wall;if(!H){return}H.modelA=G;H.modelB=K};addLoc=(_,R,L,G,K,Q,H,$,J,O,q)=>{if(!K&&!Q){return true}const N=R*128+J*64;const U=L*128+O*64;return this.addLoc2(N,U,G,_,R,L,J,O,K,Q,H,$,q,false)};addTemporary=(_,R,L,G,K,Q,H,$,J,O)=>{if(!K&&!Q){return true}let q=R-J;let N=G-J;let U=R+J;let b=G+J;if(O){if($>640&&$<1408){b+=128}if($>1152&&$<1920){U+=128}if($>1664||$<384){N-=128}if($>128&&$<896){q-=128}}q=q/128|0;N=N/128|0;U=U/128|0;b=b/128|0;return this.addLoc2(R,G,L,_,q,N,U+1-q,b-N+1,K,Q,H,0,$,true)};addTemporary2=(_,R,L,G,K,Q,H,$,J,O,q,N)=>{return!J&&!O||this.addLoc2(R,G,L,_,K,Q,H+1-K,$-Q+1,J,O,q,0,N,true)};removeLoc=(_,R,L)=>{const G=this.levelTiles[_][R][L];if(!G){return}for(let K=0;K<G.locCount;K++){const Q=G.locs[K];if(Q&&(Q.bitset>>29&3)===2&&Q.minSceneTileX===R&&Q.minSceneTileZ===L){this.removeLoc2(Q);return}}};setLocModel=(_,R,L,G)=>{if(!G){return}const K=this.levelTiles[_][R][L];if(!K){return}for(let Q=0;Q<K.locCount;Q++){const H=K.locs[Q];if(H&&(H.bitset>>29&3)===2){H.model=G;return}}};clearTemporaryLocs=()=>{for(let _=0;_<this.temporaryLocCount;_++){const R=this.temporaryLocs[_];if(R){this.removeLoc2(R)}this.temporaryLocs[_]=null}this.temporaryLocCount=0};getWallBitset=(_,R,L)=>{const G=this.levelTiles[_][R][L];return!G||!G.wall?0:G.wall.bitset};getWallDecorationBitset=(_,R,L)=>{const G=this.levelTiles[_][L][R];return!G||!G.wallDecoration?0:G.wallDecoration.bitset};getLocBitset=(_,R,L)=>{const G=this.levelTiles[_][R][L];if(!G){return 0}for(let K=0;K<G.locCount;K++){const Q=G.locs[K];if(Q&&(Q.bitset>>29&3)===2&&Q.minSceneTileX===R&&Q.minSceneTileZ===L){return Q.bitset}}return 0};getGroundDecorationBitset=(_,R,L)=>{const G=this.levelTiles[_][R][L];return!G||!G.groundDecoration?0:G.groundDecoration.bitset};getInfo=(_,R,L,G)=>{const K=this.levelTiles[_][R][L];if(!K){return-1}else if(K.wall&&K.wall.bitset===G){return K.wall.info&255}else if(K.wallDecoration&&K.wallDecoration.bitset===G){return K.wallDecoration.info&255}else if(K.groundDecoration&&K.groundDecoration.bitset===G){return K.groundDecoration.info&255}else{for(let Q=0;Q<K.locCount;Q++){const H=K.locs[Q];if(H&&H.bitset===G){return H.info&255}}return-1}};buildModels=(_,R,L,G,K)=>{const Q=Math.sqrt(L*L+G*G+K*K)|0;const H=R*Q>>8;for(let $=0;$<this.maxLevel;$++){for(let J=0;J<this.maxTileX;J++){for(let O=0;O<this.maxTileZ;O++){const q=this.levelTiles[$][J][O];if(!q){continue}const N=q.wall;if(N&&N.modelA&&N.modelA.vertexNormal){this.mergeLocNormals($,J,O,1,1,N.modelA);if(N.modelB&&N.modelB.vertexNormal){this.mergeLocNormals($,J,O,1,1,N.modelB);this.mergeNormals(N.modelA,N.modelB,0,0,0,false);N.modelB.applyLighting(_,H,L,G,K)}N.modelA.applyLighting(_,H,L,G,K)}for(let b=0;b<q.locCount;b++){const I=q.locs[b];if(I&&I.model&&I.model.vertexNormal){this.mergeLocNormals($,J,O,I.maxSceneTileX+1-I.minSceneTileX,I.maxSceneTileZ-I.minSceneTileZ+1,I.model);I.model.applyLighting(_,H,L,G,K)}}const U=q.groundDecoration;if(U&&U.model&&U.model.vertexNormal){this.mergeGroundDecorationNormals($,J,O,U.model);U.model.applyLighting(_,H,L,G,K)}}}}};mergeGroundDecorationNormals=(_,R,L,G)=>{if(R<this.maxTileX){const K=this.levelTiles[_][R+1][L];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal){this.mergeNormals(G,K.groundDecoration.model,128,0,0,true)}}if(L<this.maxTileX){const K=this.levelTiles[_][R][L+1];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal){this.mergeNormals(G,K.groundDecoration.model,0,0,128,true)}}if(R<this.maxTileX&&L<this.maxTileZ){const K=this.levelTiles[_][R+1][L+1];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal){this.mergeNormals(G,K.groundDecoration.model,128,0,128,true)}}if(R<this.maxTileX&&L>0){const K=this.levelTiles[_][R+1][L-1];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal){this.mergeNormals(G,K.groundDecoration.model,128,0,-128,true)}}};mergeLocNormals=(_,R,L,G,K,Q)=>{let H=true;let $=R;const J=R+G;const O=L-1;const q=L+K;for(let N=_;N<=_+1;N++){if(N===this.maxLevel){continue}for(let U=$;U<=J;U++){if(U<0||U>=this.maxTileX){continue}for(let b=O;b<=q;b++){if(b<0||b>=this.maxTileZ||H&&U<J&&b<q&&(b>=L||U===R)){continue}const I=this.levelTiles[N][U][b];if(!I){continue}const j=(U-R)*128+(1-G)*64;const F=(b-L)*128+(1-K)*64;const T=((this.levelHeightmaps[N][U][b]+this.levelHeightmaps[N][U+1][b]+this.levelHeightmaps[N][U][b+1]+this.levelHeightmaps[N][U+1][b+1])/4|0)-((this.levelHeightmaps[_][R][L]+this.levelHeightmaps[_][R+1][L]+this.levelHeightmaps[_][R][L+1]+this.levelHeightmaps[_][R+1][L+1])/4|0);const Y=I.wall;if(Y&&Y.modelA&&Y.modelA.vertexNormal){this.mergeNormals(Q,Y.modelA,j,T,F,H)}if(Y&&Y.modelB&&Y.modelB.vertexNormal){this.mergeNormals(Q,Y.modelB,j,T,F,H)}for(let u=0;u<I.locCount;u++){const w=I.locs[u];if(!w||!w.model||!w.model.vertexNormal){continue}const h=w.maxSceneTileX+1-w.minSceneTileX;const v=w.maxSceneTileZ+1-w.minSceneTileZ;this.mergeNormals(Q,w.model,(w.minSceneTileX-R)*128+(h-G)*64,T,(w.minSceneTileZ-L)*128+(v-K)*64,H)}}}$--;H=false}};mergeNormals=(_,R,L,G,K,Q)=>{this.tmpMergeIndex++;let H=0;const $=R.vertexX;const J=R.vertexCount;if(_.vertexNormal&&_.vertexNormalOriginal){for(let O=0;O<_.vertexCount;O++){const q=_.vertexNormal[O];const N=_.vertexNormalOriginal[O];if(N&&N.w!==0){const U=_.vertexY[O]-G;if(U>R.minY){continue}const b=_.vertexX[O]-L;if(b<R.minX||b>R.maxX){continue}const I=_.vertexZ[O]-K;if(I<R.minZ||I>R.maxZ){continue}if(R.vertexNormal&&R.vertexNormalOriginal){for(let j=0;j<J;j++){const F=R.vertexNormal[j];const T=R.vertexNormalOriginal[j];if(b!==$[j]||I!==R.vertexZ[j]||U!==R.vertexY[j]||T&&T.w===0){continue}if(q&&F&&T){q.x+=T.x;q.y+=T.y;q.z+=T.z;q.w+=T.w;F.x+=N.x;F.y+=N.y;F.z+=N.z;F.w+=N.w;H++}this.mergeIndexA[O]=this.tmpMergeIndex;this.mergeIndexB[j]=this.tmpMergeIndex}}}}}if(H<3||!Q){return}if(_.faceInfo){for(let O=0;O<_.faceCount;O++){if(this.mergeIndexA[_.faceVertexA[O]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexB[O]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexC[O]]===this.tmpMergeIndex){_.faceInfo[O]=-1}}}if(R.faceInfo){for(let O=0;O<R.faceCount;O++){if(this.mergeIndexB[R.faceVertexA[O]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexB[O]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexC[O]]===this.tmpMergeIndex){R.faceInfo[O]=-1}}}};drawMinimapTile=(_,R,L,G,K,Q)=>{const H=this.levelTiles[_][R][L];if(!H){return}const $=H.underlay;if($){const F=$.color;if(F!==0){for(let T=0;T<4;T++){G[K]=F;G[K+1]=F;G[K+2]=F;G[K+3]=F;K+=Q}}return}const J=H.overlay;if(!J){return}const O=J.shape;const q=J.angle;const N=J.backgroundRgb;const U=J.foregroundRgb;const b=V.MINIMAP_TILE_MASK[O];const I=V.MINIMAP_TILE_ROTATION_MAP[q];let j=0;if(N!==0){for(let F=0;F<4;F++){G[K]=b[I[j++]]===0?N:U;G[K+1]=b[I[j++]]===0?N:U;G[K+2]=b[I[j++]]===0?N:U;G[K+3]=b[I[j++]]===0?N:U;K+=Q}return}for(let F=0;F<4;F++){if(b[I[j++]]!==0){G[K]=U}if(b[I[j++]]!==0){G[K+1]=U}if(b[I[j++]]!==0){G[K+2]=U}if(b[I[j++]]!==0){G[K+3]=U}K+=Q}};click=(_,R)=>{V.takingInput=true;V.mouseX=_;V.mouseY=R;V.clickTileX=-1;V.clickTileZ=-1};draw=(_,R,L,G,K,Q,H)=>{if(_<0){_=0}else if(_>=this.maxTileX*128){_=this.maxTileX*128-1}if(L<0){L=0}else if(L>=this.maxTileZ*128){L=this.maxTileZ*128-1}V.cycle++;V.sinEyePitch=B.sin[Q];V.cosEyePitch=B.cos[Q];V.sinEyeYaw=B.sin[K];V.cosEyeYaw=B.cos[K];V.visibilityMap=V.visibilityMatrix[(Q-128)/32|0][K/64|0];V.eyeX=_;V.eyeY=R;V.eyeZ=L;V.eyeTileX=_/128|0;V.eyeTileZ=L/128|0;V.topLevel=G;V.minDrawTileX=V.eyeTileX-25;if(V.minDrawTileX<0){V.minDrawTileX=0}V.minDrawTileZ=V.eyeTileZ-25;if(V.minDrawTileZ<0){V.minDrawTileZ=0}V.maxDrawTileX=V.eyeTileX+25;if(V.maxDrawTileX>this.maxTileX){V.maxDrawTileX=this.maxTileX}V.maxDrawTileZ=V.eyeTileZ+25;if(V.maxDrawTileZ>this.maxTileZ){V.maxDrawTileZ=this.maxTileZ}this.updateActiveOccluders();V.tilesRemaining=0;for(let $=this.minLevel;$<this.maxLevel;$++){const J=this.levelTiles[$];for(let O=V.minDrawTileX;O<V.maxDrawTileX;O++){for(let q=V.minDrawTileZ;q<V.maxDrawTileZ;q++){const N=J[O][q];if(!N){continue}if(N.drawLevel<=G&&(V.visibilityMap[O+25-V.eyeTileX][q+25-V.eyeTileZ]||this.levelHeightmaps[$][O][q]-R>=2000)){N.visible=true;N.update=true;N.containsLocs=N.locCount>0;V.tilesRemaining++}else{N.visible=false;N.update=false;N.checkLocSpans=0}}}}for(let $=this.minLevel;$<this.maxLevel;$++){const J=this.levelTiles[$];for(let O=-25;O<=0;O++){const q=V.eyeTileX+O;const N=V.eyeTileX-O;if(q<V.minDrawTileX&&N>=V.maxDrawTileX){continue}for(let U=-25;U<=0;U++){const b=V.eyeTileZ+U;const I=V.eyeTileZ-U;let j;if(q>=V.minDrawTileX){if(b>=V.minDrawTileZ){j=J[q][b];if(j&&j.visible){this.drawTile(j,true,H)}}if(I<V.maxDrawTileZ){j=J[q][I];if(j&&j.visible){this.drawTile(j,true,H)}}}if(N<V.maxDrawTileX){if(b>=V.minDrawTileZ){j=J[N][b];if(j&&j.visible){this.drawTile(j,true,H)}}if(I<V.maxDrawTileZ){j=J[N][I];if(j&&j.visible){this.drawTile(j,true,H)}}}if(V.tilesRemaining===0){V.takingInput=false;return}}}}for(let $=this.minLevel;$<this.maxLevel;$++){const J=this.levelTiles[$];for(let O=-25;O<=0;O++){const q=V.eyeTileX+O;const N=V.eyeTileX-O;if(q<V.minDrawTileX&&N>=V.maxDrawTileX){continue}for(let U=-25;U<=0;U++){const b=V.eyeTileZ+U;const I=V.eyeTileZ-U;let j;if(q>=V.minDrawTileX){if(b>=V.minDrawTileZ){j=J[q][b];if(j&&j.visible){this.drawTile(j,false,H)}}if(I<V.maxDrawTileZ){j=J[q][I];if(j&&j.visible){this.drawTile(j,false,H)}}}if(N<V.maxDrawTileX){if(b>=V.minDrawTileZ){j=J[N][b];if(j&&j.visible){this.drawTile(j,false,H)}}if(I<V.maxDrawTileZ){j=J[N][I];if(j&&j.visible){this.drawTile(j,false,H)}}}if(V.tilesRemaining===0){V.takingInput=false;return}}}}};addLoc2=(_,R,L,G,K,Q,H,$,J,O,q,N,U,b)=>{if(!J&&!O){return false}for(let j=K;j<K+H;j++){for(let F=Q;F<Q+$;F++){if(j<0||F<0||j>=this.maxTileX||F>=this.maxTileZ){return false}const T=this.levelTiles[G][j][F];if(T&&T.locCount>=5){return false}}}const I=new A8(G,L,_,R,J,O,U,K,K+H-1,Q,Q+$-1,q,N);for(let j=K;j<K+H;j++){for(let F=Q;F<Q+$;F++){let T=0;if(j>K){T|=1}if(j<K+H-1){T+=4}if(F>Q){T+=8}if(F<Q+$-1){T+=2}for(let u=G;u>=0;u--){if(!this.levelTiles[u][j][F]){this.levelTiles[u][j][F]=new R1(u,j,F)}}const Y=this.levelTiles[G][j][F];if(Y){Y.locs[Y.locCount]=I;Y.locSpan[Y.locCount]=T;Y.locSpans|=T;Y.locCount++}}}if(b){this.temporaryLocs[this.temporaryLocCount++]=I}return true};removeLoc2=(_)=>{for(let R=_.minSceneTileX;R<=_.maxSceneTileX;R++){for(let L=_.minSceneTileZ;L<=_.maxSceneTileZ;L++){const G=this.levelTiles[_.level][R][L];if(!G){continue}for(let K=0;K<G.locCount;K++){if(G.locs[K]===_){G.locCount--;for(let Q=K;Q<G.locCount;Q++){G.locs[Q]=G.locs[Q+1];G.locSpan[Q]=G.locSpan[Q+1]}G.locs[G.locCount]=null;break}}G.locSpans=0;for(let K=0;K<G.locCount;K++){G.locSpans|=G.locSpan[K]}}}};updateActiveOccluders=()=>{const _=V.levelOccluderCount[V.topLevel];const R=V.levelOccluders[V.topLevel];V.activeOccluderCount=0;for(let L=0;L<_;L++){const G=R[L];if(!G){continue}let K;let Q;let H;let $;if(G.type===1){K=G.minTileX+25-V.eyeTileX;if(K>=0&&K<=50){Q=G.minTileZ+25-V.eyeTileZ;if(Q<0){Q=0}H=G.maxTileZ+25-V.eyeTileZ;if(H>50){H=50}let J=false;while(Q<=H){if(V.visibilityMap&&V.visibilityMap[K][Q++]){J=true;break}}if(J){$=V.eyeX-G.minX;if($>32){G.mode=1}else{if($>=-32){continue}G.mode=2;$=-$}G.minDeltaZ=(G.minZ-V.eyeZ<<8)/$|0;G.maxDeltaZ=(G.maxZ-V.eyeZ<<8)/$|0;G.minDeltaY=(G.minY-V.eyeY<<8)/$|0;G.maxDeltaY=(G.maxY-V.eyeY<<8)/$|0;V.activeOccluders[V.activeOccluderCount++]=G}}}else if(G.type===2){K=G.minTileZ+25-V.eyeTileZ;if(K>=0&&K<=50){Q=G.minTileX+25-V.eyeTileX;if(Q<0){Q=0}H=G.maxTileX+25-V.eyeTileX;if(H>50){H=50}let J=false;while(Q<=H){if(V.visibilityMap&&V.visibilityMap[Q++][K]){J=true;break}}if(J){$=V.eyeZ-G.minZ;if($>32){G.mode=3}else{if($>=-32){continue}G.mode=4;$=-$}G.minDeltaX=(G.minX-V.eyeX<<8)/$|0;G.maxDeltaX=(G.maxX-V.eyeX<<8)/$|0;G.minDeltaY=(G.minY-V.eyeY<<8)/$|0;G.maxDeltaY=(G.maxY-V.eyeY<<8)/$|0;V.activeOccluders[V.activeOccluderCount++]=G}}}else if(G.type===4){K=G.minY-V.eyeY;if(K>128){Q=G.minTileZ+25-V.eyeTileZ;if(Q<0){Q=0}H=G.maxTileZ+25-V.eyeTileZ;if(H>50){H=50}if(Q<=H){let J=G.minTileX+25-V.eyeTileX;if(J<0){J=0}$=G.maxTileX+25-V.eyeTileX;if($>50){$=50}let O=false;_:for(let q=J;q<=$;q++){for(let N=Q;N<=H;N++){if(V.visibilityMap&&V.visibilityMap[q][N]){O=true;break _}}}if(O){G.mode=5;G.minDeltaX=(G.minX-V.eyeX<<8)/K|0;G.maxDeltaX=(G.maxX-V.eyeX<<8)/K|0;G.minDeltaZ=(G.minZ-V.eyeZ<<8)/K|0;G.maxDeltaZ=(G.maxZ-V.eyeZ<<8)/K|0;V.activeOccluders[V.activeOccluderCount++]=G}}}}}};drawTile=(_,R,L)=>{V.drawTileQueue.addTail(_);while(true){let G;do{G=V.drawTileQueue.removeHead();if(!G){return}}while(!G.update);const K=G.x;const Q=G.z;const H=G.level;const $=G.occludeLevel;const J=this.levelTiles[H];if(G.visible){if(R){if(H>0){const F=this.levelTiles[H-1][K][Q];if(F&&F.update){continue}}if(K<=V.eyeTileX&&K>V.minDrawTileX){const F=J[K-1][Q];if(F&&F.update&&(F.visible||(G.locSpans&1)===0)){continue}}if(K>=V.eyeTileX&&K<V.maxDrawTileX-1){const F=J[K+1][Q];if(F&&F.update&&(F.visible||(G.locSpans&4)===0)){continue}}if(Q<=V.eyeTileZ&&Q>V.minDrawTileZ){const F=J[K][Q-1];if(F&&F.update&&(F.visible||(G.locSpans&8)===0)){continue}}if(Q>=V.eyeTileZ&&Q<V.maxDrawTileZ-1){const F=J[K][Q+1];if(F&&F.update&&(F.visible||(G.locSpans&2)===0)){continue}}}else{R=true}G.visible=false;if(G.bridge){const F=G.bridge;if(!F.underlay){if(F.overlay&&!this.tileVisible(0,K,Q)){this.drawTileOverlay(K,Q,F.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}}else if(!this.tileVisible(0,K,Q)){this.drawTileUnderlay(F.underlay,0,K,Q,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}const T=F.wall;if(T){T.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset)}for(let Y=0;Y<F.locCount;Y++){const u=F.locs[Y];if(u){let w=u.model;if(!w){w=u.entity?.draw(L)??null}w?.draw(u.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,u.x-V.eyeX,u.y-V.eyeY,u.z-V.eyeZ,u.bitset)}}}let q=false;if(!G.underlay){if(G.overlay&&!this.tileVisible($,K,Q)){q=true;this.drawTileOverlay(K,Q,G.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}}else if(!this.tileVisible($,K,Q)){q=true;this.drawTileUnderlay(G.underlay,$,K,Q,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}let N=0;let U=0;const b=G.wall;const I=G.wallDecoration;if(b||I){if(V.eyeTileX===K){N+=1}else if(V.eyeTileX<K){N+=2}if(V.eyeTileZ===Q){N+=3}else if(V.eyeTileZ>Q){N+=6}U=V.FRONT_WALL_TYPES[N];G.backWallTypes=V.BACK_WALL_TYPES[N]}if(b){if((b.typeA&V.DIRECTION_ALLOW_WALL_CORNER_TYPE[N])===0){G.checkLocSpans=0}else if(b.typeA===16){G.checkLocSpans=3;G.blockLocSpans=V.WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS[N];G.inverseBlockLocSpans=3-G.blockLocSpans}else if(b.typeA===32){G.checkLocSpans=6;G.blockLocSpans=V.WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS[N];G.inverseBlockLocSpans=6-G.blockLocSpans}else if(b.typeA===64){G.checkLocSpans=12;G.blockLocSpans=V.WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS[N];G.inverseBlockLocSpans=12-G.blockLocSpans}else{G.checkLocSpans=9;G.blockLocSpans=V.WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS[N];G.inverseBlockLocSpans=9-G.blockLocSpans}if((b.typeA&U)!==0&&!this.wallVisible($,K,Q,b.typeA)){b.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY,b.z-V.eyeZ,b.bitset)}if((b.typeB&U)!==0&&!this.wallVisible($,K,Q,b.typeB)){b.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY,b.z-V.eyeZ,b.bitset)}}if(I&&!this.visible($,K,Q,I.model.maxY)){if((I.type&U)!==0){I.model.draw(I.angle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,I.x-V.eyeX,I.y-V.eyeY,I.z-V.eyeZ,I.bitset)}else if((I.type&768)!==0){const F=I.x-V.eyeX;const T=I.y-V.eyeY;const Y=I.z-V.eyeZ;const u=I.angle;let w;if(u===x.NORTH||u===x.EAST){w=-F}else{w=F}let h;if(u===x.EAST||u===x.SOUTH){h=-Y}else{h=Y}if((I.type&256)!==0&&h<w){const v=F+V.WALL_DECORATION_INSET_X[u];const n=Y+V.WALL_DECORATION_INSET_Z[u];I.model.draw(u*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,v,T,n,I.bitset)}if((I.type&512)!==0&&h>w){const v=F+V.WALL_DECORATION_OUTSET_X[u];const n=Y+V.WALL_DECORATION_OUTSET_Z[u];I.model.draw(u*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,v,T,n,I.bitset)}}}if(q){const F=G.groundDecoration;if(F){F.model?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.bitset)}const T=G.objStack;if(T&&T.offset===0){if(T.bottomObj){T.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset)}if(T.middleObj){T.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset)}if(T.topObj){T.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset)}}}const j=G.locSpans;if(j!==0){if(K<V.eyeTileX&&(j&4)!==0){const F=J[K+1][Q];if(F&&F.update){V.drawTileQueue.addTail(F)}}if(Q<V.eyeTileZ&&(j&2)!==0){const F=J[K][Q+1];if(F&&F.update){V.drawTileQueue.addTail(F)}}if(K>V.eyeTileX&&(j&1)!==0){const F=J[K-1][Q];if(F&&F.update){V.drawTileQueue.addTail(F)}}if(Q>V.eyeTileZ&&(j&8)!==0){const F=J[K][Q-1];if(F&&F.update){V.drawTileQueue.addTail(F)}}}}if(G.checkLocSpans!==0){let q=true;for(let N=0;N<G.locCount;N++){const U=G.locs[N];if(!U){continue}if(U.cycle!==V.cycle&&(G.locSpan[N]&G.checkLocSpans)===G.blockLocSpans){q=false;break}}if(q){const N=G.wall;if(N&&!this.wallVisible($,K,Q,N.typeA)){N.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,N.x-V.eyeX,N.y-V.eyeY,N.z-V.eyeZ,N.bitset)}G.checkLocSpans=0}}if(G.containsLocs){const q=G.locCount;G.containsLocs=false;let N=0;_:for(let U=0;U<q;U++){const b=G.locs[U];if(!b||b.cycle===V.cycle){continue}for(let Y=b.minSceneTileX;Y<=b.maxSceneTileX;Y++){for(let u=b.minSceneTileZ;u<=b.maxSceneTileZ;u++){const w=J[Y][u];if(!w){continue}if(!w.visible){if(w.checkLocSpans===0){continue}let h=0;if(Y>b.minSceneTileX){h+=1}if(Y<b.maxSceneTileX){h+=4}if(u>b.minSceneTileZ){h+=8}if(u<b.maxSceneTileZ){h+=2}if((h&w.checkLocSpans)!==G.inverseBlockLocSpans){continue}}G.containsLocs=true;continue _}}V.locBuffer[N++]=b;let I=V.eyeTileX-b.minSceneTileX;const j=b.maxSceneTileX-V.eyeTileX;if(j>I){I=j}const F=V.eyeTileZ-b.minSceneTileZ;const T=b.maxSceneTileZ-V.eyeTileZ;if(T>F){b.distance=I+T}else{b.distance=I+F}}while(true){let U=-50;let b=-1;for(let j=0;j<N;j++){const F=V.locBuffer[j];if(!F){continue}if(F.cycle!==V.cycle){if(F.distance>U){U=F.distance;b=j}}}if(b===-1){break}const I=V.locBuffer[b];if(I){I.cycle=V.cycle;let j=I.model;if(!j){j=I.entity?.draw(L)??null}if(j&&!this.locVisible($,I.minSceneTileX,I.maxSceneTileX,I.minSceneTileZ,I.maxSceneTileZ,j.maxY)){j.draw(I.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,I.x-V.eyeX,I.y-V.eyeY,I.z-V.eyeZ,I.bitset)}for(let F=I.minSceneTileX;F<=I.maxSceneTileX;F++){for(let T=I.minSceneTileZ;T<=I.maxSceneTileZ;T++){const Y=J[F][T];if(!Y){continue}if(Y.checkLocSpans!==0){V.drawTileQueue.addTail(Y)}else if((F!==K||T!==Q)&&Y.update){V.drawTileQueue.addTail(Y)}}}}}if(G.containsLocs){continue}}if(!G.update||G.checkLocSpans!==0){continue}if(K<=V.eyeTileX&&K>V.minDrawTileX){const q=J[K-1][Q];if(q&&q.update){continue}}if(K>=V.eyeTileX&&K<V.maxDrawTileX-1){const q=J[K+1][Q];if(q&&q.update){continue}}if(Q<=V.eyeTileZ&&Q>V.minDrawTileZ){const q=J[K][Q-1];if(q&&q.update){continue}}if(Q>=V.eyeTileZ&&Q<V.maxDrawTileZ-1){const q=J[K][Q+1];if(q&&q.update){continue}}G.update=false;V.tilesRemaining--;const O=G.objStack;if(O&&O.offset!==0){if(O.bottomObj){O.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY-O.offset,O.z-V.eyeZ,O.bitset)}if(O.middleObj){O.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY-O.offset,O.z-V.eyeZ,O.bitset)}if(O.topObj){O.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY-O.offset,O.z-V.eyeZ,O.bitset)}}if(G.backWallTypes!==0){const q=G.wallDecoration;if(q&&!this.visible($,K,Q,q.model.maxY)){if((q.type&G.backWallTypes)!==0){q.model.draw(q.angle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,q.x-V.eyeX,q.y-V.eyeY,q.z-V.eyeZ,q.bitset)}else if((q.type&768)!==0){const U=q.x-V.eyeX;const b=q.y-V.eyeY;const I=q.z-V.eyeZ;const j=q.angle;let F;if(j===x.NORTH||j===x.EAST){F=-U}else{F=U}let T;if(j===x.EAST||j===x.SOUTH){T=-I}else{T=I}if((q.type&256)!==0&&T>=F){const Y=U+V.WALL_DECORATION_INSET_X[j];const u=I+V.WALL_DECORATION_INSET_Z[j];q.model.draw(j*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Y,b,u,q.bitset)}if((q.type&512)!==0&&T<=F){const Y=U+V.WALL_DECORATION_OUTSET_X[j];const u=I+V.WALL_DECORATION_OUTSET_Z[j];q.model.draw(j*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Y,b,u,q.bitset)}}}const N=G.wall;if(N){if((N.typeB&G.backWallTypes)!==0&&!this.wallVisible($,K,Q,N.typeB)){N.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,N.x-V.eyeX,N.y-V.eyeY,N.z-V.eyeZ,N.bitset)}if((N.typeA&G.backWallTypes)!==0&&!this.wallVisible($,K,Q,N.typeA)){N.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,N.x-V.eyeX,N.y-V.eyeY,N.z-V.eyeZ,N.bitset)}}}if(H<this.maxLevel-1){const q=this.levelTiles[H+1][K][Q];if(q&&q.update){V.drawTileQueue.addTail(q)}}if(K<V.eyeTileX){const q=J[K+1][Q];if(q&&q.update){V.drawTileQueue.addTail(q)}}if(Q<V.eyeTileZ){const q=J[K][Q+1];if(q&&q.update){V.drawTileQueue.addTail(q)}}if(K>V.eyeTileX){const q=J[K-1][Q];if(q&&q.update){V.drawTileQueue.addTail(q)}}if(Q>V.eyeTileZ){const q=J[K][Q-1];if(q&&q.update){V.drawTileQueue.addTail(q)}}}};drawTileUnderlay=(_,R,L,G,K,Q,H,$)=>{let J;let O=J=(L<<7)-V.eyeX;let q;let N=q=(G<<7)-V.eyeZ;let U;let b=U=O+128;let I;let j=I=N+128;let F=this.levelHeightmaps[R][L][G]-V.eyeY;let T=this.levelHeightmaps[R][L+1][G]-V.eyeY;let Y=this.levelHeightmaps[R][L+1][G+1]-V.eyeY;let u=this.levelHeightmaps[R][L][G+1]-V.eyeY;let w=N*H+O*$>>16;N=N*$-O*H>>16;O=w;w=F*Q-N*K>>16;N=F*K+N*Q>>16;F=w;if(N<50){return}w=q*H+b*$>>16;q=q*$-b*H>>16;b=w;w=T*Q-q*K>>16;q=T*K+q*Q>>16;T=w;if(q<50){return}w=j*H+U*$>>16;j=j*$-U*H>>16;U=w;w=Y*Q-j*K>>16;j=Y*K+j*Q>>16;Y=w;if(j<50){return}w=I*H+J*$>>16;I=I*$-J*H>>16;J=w;w=u*Q-I*K>>16;I=u*K+I*Q>>16;u=w;if(I<50){return}const h=B.centerX+((O<<9)/N|0);const v=B.centerY+((F<<9)/N|0);const n=B.centerX+((b<<9)/q|0);const A=B.centerY+((T<<9)/q|0);const P=B.centerX+((U<<9)/j|0);const z=B.centerY+((Y<<9)/j|0);const f=B.centerX+((J<<9)/I|0);const m=B.centerY+((u<<9)/I|0);B.alpha=0;if((P-f)*(A-m)-(z-m)*(n-f)>0){B.clipX=P<0||f<0||n<0||P>k.boundX||f>k.boundX||n>k.boundX;if(V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,z,m,A,P,f,n)){V.clickTileX=L;V.clickTileZ=G}if(_.textureId===-1){if(_.northeastColor!==12345678){B.fillGouraudTriangle(P,f,n,z,m,A,_.northeastColor,_.northwestColor,_.southeastColor)}}else if(V.lowMemory){const M=V.TEXTURE_HSL[_.textureId];B.fillGouraudTriangle(P,f,n,z,m,A,this.mulLightness(M,_.northeastColor),this.mulLightness(M,_.northwestColor),this.mulLightness(M,_.southeastColor))}else if(_.flat){B.fillTexturedTriangle(P,f,n,z,m,A,_.northeastColor,_.northwestColor,_.southeastColor,O,F,N,b,J,T,u,q,I,_.textureId)}else{B.fillTexturedTriangle(P,f,n,z,m,A,_.northeastColor,_.northwestColor,_.southeastColor,U,Y,j,J,b,u,T,I,q,_.textureId)}}if((h-n)*(m-A)-(v-A)*(f-n)<=0){return}B.clipX=h<0||n<0||f<0||h>k.boundX||n>k.boundX||f>k.boundX;if(V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,v,A,m,h,n,f)){V.clickTileX=L;V.clickTileZ=G}if(_.textureId!==-1){if(!V.lowMemory){B.fillTexturedTriangle(h,n,f,v,A,m,_.southwestColor,_.southeastColor,_.northwestColor,O,F,N,b,J,T,u,q,I,_.textureId);return}const M=V.TEXTURE_HSL[_.textureId];B.fillGouraudTriangle(h,n,f,v,A,m,this.mulLightness(M,_.southwestColor),this.mulLightness(M,_.southeastColor),this.mulLightness(M,_.northwestColor))}else if(_.southwestColor!==12345678){B.fillGouraudTriangle(h,n,f,v,A,m,_.southwestColor,_.southeastColor,_.northwestColor)}};drawTileOverlay=(_,R,L,G,K,Q,H)=>{let $=L.vertexX.length;for(let J=0;J<$;J++){let O=L.vertexX[J]-V.eyeX;let q=L.vertexY[J]-V.eyeY;let N=L.vertexZ[J]-V.eyeZ;let U=N*Q+O*H>>16;N=N*H-O*Q>>16;O=U;U=q*K-N*G>>16;N=q*G+N*K>>16;q=U;if(N<50){return}if(L.triangleTextureIds){_0.tmpViewspaceX[J]=O;_0.tmpViewspaceY[J]=q;_0.tmpViewspaceZ[J]=N}_0.tmpScreenX[J]=B.centerX+((O<<9)/N|0);_0.tmpScreenY[J]=B.centerY+((q<<9)/N|0)}B.alpha=0;$=L.triangleVertexA.length;for(let J=0;J<$;J++){const O=L.triangleVertexA[J];const q=L.triangleVertexB[J];const N=L.triangleVertexC[J];const U=_0.tmpScreenX[O];const b=_0.tmpScreenX[q];const I=_0.tmpScreenX[N];const j=_0.tmpScreenY[O];const F=_0.tmpScreenY[q];const T=_0.tmpScreenY[N];if((U-b)*(T-F)-(j-F)*(I-b)>0){B.clipX=U<0||b<0||I<0||U>k.boundX||b>k.boundX||I>k.boundX;if(V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,j,F,T,U,b,I)){V.clickTileX=_;V.clickTileZ=R}if(!L.triangleTextureIds||L.triangleTextureIds[J]===-1){if(L.triangleColorA[J]!==12345678){B.fillGouraudTriangle(U,b,I,j,F,T,L.triangleColorA[J],L.triangleColorB[J],L.triangleColorC[J])}}else if(V.lowMemory){const Y=V.TEXTURE_HSL[L.triangleTextureIds[J]];B.fillGouraudTriangle(U,b,I,j,F,T,this.mulLightness(Y,L.triangleColorA[J]),this.mulLightness(Y,L.triangleColorB[J]),this.mulLightness(Y,L.triangleColorC[J]))}else if(L.flat){B.fillTexturedTriangle(U,b,I,j,F,T,L.triangleColorA[J],L.triangleColorB[J],L.triangleColorC[J],_0.tmpViewspaceX[0],_0.tmpViewspaceY[0],_0.tmpViewspaceZ[0],_0.tmpViewspaceX[1],_0.tmpViewspaceX[3],_0.tmpViewspaceY[1],_0.tmpViewspaceY[3],_0.tmpViewspaceZ[1],_0.tmpViewspaceZ[3],L.triangleTextureIds[J])}else{B.fillTexturedTriangle(U,b,I,j,F,T,L.triangleColorA[J],L.triangleColorB[J],L.triangleColorC[J],_0.tmpViewspaceX[O],_0.tmpViewspaceY[O],_0.tmpViewspaceZ[O],_0.tmpViewspaceX[q],_0.tmpViewspaceX[N],_0.tmpViewspaceY[q],_0.tmpViewspaceY[N],_0.tmpViewspaceZ[q],_0.tmpViewspaceZ[N],L.triangleTextureIds[J])}}}};tileVisible=(_,R,L)=>{const G=this.levelTileOcclusionCycles[_][R][L];if(G===-V.cycle){return false}else if(G===V.cycle){return true}else{const K=R<<7;const Q=L<<7;if(this.occluded(K+1,this.levelHeightmaps[_][R][L],Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L],Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L+1],Q+128-1)&&this.occluded(K+1,this.levelHeightmaps[_][R][L+1],Q+128-1)){this.levelTileOcclusionCycles[_][R][L]=V.cycle;return true}else{this.levelTileOcclusionCycles[_][R][L]=-V.cycle;return false}}};wallVisible=(_,R,L,G)=>{if(!this.tileVisible(_,R,L)){return false}const K=R<<7;const Q=L<<7;const H=this.levelHeightmaps[_][R][L]-1;const $=H-120;const J=H-230;const O=H-238;if(G<16){if(G===1){if(K>V.eyeX){if(!this.occluded(K,H,Q)){return false}if(!this.occluded(K,H,Q+128)){return false}}if(_>0){if(!this.occluded(K,$,Q)){return false}if(!this.occluded(K,$,Q+128)){return false}}if(!this.occluded(K,J,Q)){return false}return this.occluded(K,J,Q+128)}if(G===2){if(Q<V.eyeZ){if(!this.occluded(K,H,Q+128)){return false}if(!this.occluded(K+128,H,Q+128)){return false}}if(_>0){if(!this.occluded(K,$,Q+128)){return false}if(!this.occluded(K+128,$,Q+128)){return false}}if(!this.occluded(K,J,Q+128)){return false}return this.occluded(K+128,J,Q+128)}if(G===4){if(K<V.eyeX){if(!this.occluded(K+128,H,Q)){return false}if(!this.occluded(K+128,H,Q+128)){return false}}if(_>0){if(!this.occluded(K+128,$,Q)){return false}if(!this.occluded(K+128,$,Q+128)){return false}}if(!this.occluded(K+128,J,Q)){return false}return this.occluded(K+128,J,Q+128)}if(G===8){if(Q>V.eyeZ){if(!this.occluded(K,H,Q)){return false}if(!this.occluded(K+128,H,Q)){return false}}if(_>0){if(!this.occluded(K,$,Q)){return false}if(!this.occluded(K+128,$,Q)){return false}}if(!this.occluded(K,J,Q)){return false}return this.occluded(K+128,J,Q)}}if(!this.occluded(K+64,O,Q+64)){return false}else if(G===16){return this.occluded(K,J,Q+128)}else if(G===32){return this.occluded(K+128,J,Q+128)}else if(G===64){return this.occluded(K+128,J,Q)}else if(G===128){return this.occluded(K,J,Q)}return true};visible=(_,R,L,G)=>{if(this.tileVisible(_,R,L)){const K=R<<7;const Q=L<<7;return this.occluded(K+1,this.levelHeightmaps[_][R][L]-G,Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L]-G,Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L+1]-G,Q+128-1)&&this.occluded(K+1,this.levelHeightmaps[_][R][L+1]-G,Q+128-1)}return false};locVisible=(_,R,L,G,K,Q)=>{let H;let $;if(R!==L||G!==K){for(H=R;H<=L;H++){for($=G;$<=K;$++){if(this.levelTileOcclusionCycles[_][H][$]===-V.cycle){return false}}}$=(R<<7)+1;const J=(G<<7)+2;const O=this.levelHeightmaps[_][R][G]-Q;if(!this.occluded($,O,J)){return false}const q=(L<<7)-1;if(!this.occluded(q,O,J)){return false}const N=(K<<7)-1;if(!this.occluded($,O,N)){return false}else return this.occluded(q,O,N)}else if(this.tileVisible(_,R,G)){H=R<<7;$=G<<7;return this.occluded(H+1,this.levelHeightmaps[_][R][G]-Q,$+1)&&this.occluded(H+128-1,this.levelHeightmaps[_][R+1][G]-Q,$+1)&&this.occluded(H+128-1,this.levelHeightmaps[_][R+1][G+1]-Q,$+128-1)&&this.occluded(H+1,this.levelHeightmaps[_][R][G+1]-Q,$+128-1)}return false};occluded=(_,R,L)=>{for(let G=0;G<V.activeOccluderCount;G++){const K=V.activeOccluders[G];if(!K){continue}if(K.mode===1){const Q=K.minX-_;if(Q>0){const H=K.minZ+(K.minDeltaZ*Q>>8);const $=K.maxZ+(K.maxDeltaZ*Q>>8);const J=K.minY+(K.minDeltaY*Q>>8);const O=K.maxY+(K.maxDeltaY*Q>>8);if(L>=H&&L<=$&&R>=J&&R<=O){return true}}}else if(K.mode===2){const Q=_-K.minX;if(Q>0){const H=K.minZ+(K.minDeltaZ*Q>>8);const $=K.maxZ+(K.maxDeltaZ*Q>>8);const J=K.minY+(K.minDeltaY*Q>>8);const O=K.maxY+(K.maxDeltaY*Q>>8);if(L>=H&&L<=$&&R>=J&&R<=O){return true}}}else if(K.mode===3){const Q=K.minZ-L;if(Q>0){const H=K.minX+(K.minDeltaX*Q>>8);const $=K.maxX+(K.maxDeltaX*Q>>8);const J=K.minY+(K.minDeltaY*Q>>8);const O=K.maxY+(K.maxDeltaY*Q>>8);if(_>=H&&_<=$&&R>=J&&R<=O){return true}}}else if(K.mode===4){const Q=L-K.minZ;if(Q>0){const H=K.minX+(K.minDeltaX*Q>>8);const $=K.maxX+(K.maxDeltaX*Q>>8);const J=K.minY+(K.minDeltaY*Q>>8);const O=K.maxY+(K.maxDeltaY*Q>>8);if(_>=H&&_<=$&&R>=J&&R<=O){return true}}}else if(K.mode===5){const Q=R-K.minY;if(Q>0){const H=K.minX+(K.minDeltaX*Q>>8);const $=K.maxX+(K.maxDeltaX*Q>>8);const J=K.minZ+(K.minDeltaZ*Q>>8);const O=K.maxZ+(K.maxDeltaZ*Q>>8);if(_>=H&&_<=$&&L>=J&&L<=O){return true}}}}return false};pointInsideTriangle=(_,R,L,G,K,Q,H,$)=>{if(R<L&&R<G&&R<K){return false}else if(R>L&&R>G&&R>K){return false}else if(_<Q&&_<H&&_<$){return false}else if(_>Q&&_>H&&_>$){return false}const J=(R-L)*(H-Q)-(_-Q)*(G-L);const O=(R-K)*(Q-$)-(_-$)*(L-K);const q=(R-G)*($-H)-(_-H)*(K-G);return J*q>0&&q*O>0};mulLightness=(_,R)=>{const L=127-R;R=L*(_&127)/160|0;if(R<2){R=2}else if(R>126){R=126}return(_&65408)+R}}class X0 extends D0{heightmapSW;heightmapSE;heightmapNE;heightmapNW;index;seq;seqFrame;seqCycle;constructor(_,R,L,G,K,Q,H){super();this.heightmapSW=R;this.heightmapSE=L;this.heightmapNE=G;this.heightmapNW=K;this.index=_;this.seq=Q;if(H&&Q.replayoff!==-1&&this.seq.delay){this.seqFrame=Math.random()*this.seq.frameCount|0;this.seqCycle=Math.random()*this.seq.delay[this.seqFrame]|0}else{this.seqFrame=-1;this.seqCycle=0}}}class H0{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=true;static levelBuilt=0;static fullbright=false;static perlin=(_,R)=>{let L=this.perlinScale(_+45365,R+91923,4)+(this.perlinScale(_+10294,R+37821,2)-128>>1)+(this.perlinScale(_,R,1)-128>>2)-128;L=(L*0.3|0)+35;if(L<10){L=10}else if(L>60){L=60}return L};static perlinScale=(_,R,L)=>{const G=_/L|0;const K=_&L-1;const Q=R/L|0;const H=R&L-1;const $=this.smoothNoise(G,Q);const J=this.smoothNoise(G+1,Q);const O=this.smoothNoise(G,Q+1);const q=this.smoothNoise(G+1,Q+1);const N=this.interpolate($,J,K,L);const U=this.interpolate(O,q,K,L);return this.interpolate(N,U,H,L)};static interpolate=(_,R,L,G)=>{const K=65536-B.cos[L*1024/G|0]>>1;return(_*(65536-K)>>16)+(R*K>>16)};static smoothNoise=(_,R)=>{const L=this.noise(_-1,R-1)+this.noise(_+1,R-1)+this.noise(_-1,R+1)+this.noise(_+1,R+1);const G=this.noise(_-1,R)+this.noise(_+1,R)+this.noise(_,R-1)+this.noise(_,R+1);const K=this.noise(_,R);return(L/16|0)+(G/8|0)+(K/4|0)};static noise=(_,R)=>{const L=_+R*57;const G=BigInt(L<<13^L);return Number((G*(G*G*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255};static addLoc=(_,R,L,G,K,Q,H,$,J,O,q)=>{const N=K[q][R][L];const U=K[q][R+1][L];const b=K[q][R+1][L+1];const I=K[q][R][L+1];const j=N+U+b+I>>2;const F=h0.get($);let T=R+(L<<7)+($<<14)+1073741824|0;if(!F.active){T+=-2147483648}T|=0;const Y=((O<<6)+J|0)<<24>>24;if(J===y.GROUND_DECOR.id){G?.addGroundDecoration(F.getModel(y.GROUND_DECOR.id,O,N,U,b,I,-1),_,R,L,j,T,Y);if(F.blockwalk&&F.active){H?.addFloor(R,L)}if(F.anim!==-1){Q.addTail(new X0($,_,3,R,L,G0.instances[F.anim],true))}}else if(J===y.CENTREPIECE_STRAIGHT.id||J===y.CENTREPIECE_DIAGONAL.id){const u=F.getModel(y.CENTREPIECE_STRAIGHT.id,O,N,U,b,I,-1);if(u){let w=0;if(J===y.CENTREPIECE_DIAGONAL.id){w+=256}let h;let v;if(O===x.NORTH||O===x.SOUTH){h=F.length;v=F.width}else{h=F.width;v=F.length}G?.addLoc(_,R,L,j,u,null,T,Y,h,v,w)}if(F.blockwalk){H?.addLoc(R,L,F.width,F.length,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,2,R,L,G0.instances[F.anim],true))}}else if(J>=y.ROOF_STRAIGHT.id){G?.addLoc(_,R,L,j,F.getModel(J,O,N,U,b,I,-1),null,T,Y,1,1,0);if(F.blockwalk){H?.addLoc(R,L,F.width,F.length,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,2,R,L,G0.instances[F.anim],true))}}else if(J===y.WALL_STRAIGHT.id){G?.addWall(_,R,L,j,H0.ROTATION_WALL_TYPE[O],0,F.getModel(y.WALL_STRAIGHT.id,O,N,U,b,I,-1),null,T,Y);if(F.blockwalk){H?.addWall(R,L,J,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,0,R,L,G0.instances[F.anim],true))}}else if(J===y.WALL_DIAGONAL_CORNER.id){G?.addWall(_,R,L,j,H0.ROTATION_WALL_CORNER_TYPE[O],0,F.getModel(y.WALL_DIAGONAL_CORNER.id,O,N,U,b,I,-1),null,T,Y);if(F.blockwalk){H?.addWall(R,L,J,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,0,R,L,G0.instances[F.anim],true))}}else if(J===y.WALL_L.id){const u=O+1&3;G?.addWall(_,R,L,j,H0.ROTATION_WALL_TYPE[O],H0.ROTATION_WALL_TYPE[u],F.getModel(y.WALL_L.id,O+4,N,U,b,I,-1),F.getModel(y.WALL_L.id,u,N,U,b,I,-1),T,Y);if(F.blockwalk){H?.addWall(R,L,J,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,0,R,L,G0.instances[F.anim],true))}}else if(J===y.WALL_SQUARE_CORNER.id){G?.addWall(_,R,L,j,H0.ROTATION_WALL_CORNER_TYPE[O],0,F.getModel(y.WALL_SQUARE_CORNER.id,O,N,U,b,I,-1),null,T,Y);if(F.blockwalk){H?.addWall(R,L,J,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,0,R,L,G0.instances[F.anim],true))}}else if(J===y.WALL_DIAGONAL.id){G?.addLoc(_,R,L,j,F.getModel(J,O,N,U,b,I,-1),null,T,Y,1,1,0);if(F.blockwalk){H?.addLoc(R,L,F.width,F.length,O,F.blockrange)}if(F.anim!==-1){Q.addTail(new X0($,_,2,R,L,G0.instances[F.anim],true))}}else if(J===y.WALLDECOR_STRAIGHT_NOOFFSET.id){G?.setWallDecoration(_,R,L,j,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,N,U,b,I,-1),Y,O*512,H0.ROTATION_WALL_TYPE[O]);if(F.anim!==-1){Q.addTail(new X0($,_,1,R,L,G0.instances[F.anim],true))}}else if(J===y.WALLDECOR_STRAIGHT_OFFSET.id){let u=16;if(G){const w=G.getWallBitset(_,R,L);if(w>0){u=h0.get(w>>14&32767).wallwidth}}G?.setWallDecoration(_,R,L,j,H0.WALL_DECORATION_ROTATION_FORWARD_X[O]*u,H0.WALL_DECORATION_ROTATION_FORWARD_Z[O]*u,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,N,U,b,I,-1),Y,O*512,H0.ROTATION_WALL_TYPE[O]);if(F.anim!==-1){Q.addTail(new X0($,_,1,R,L,G0.instances[F.anim],true))}}else if(J===y.WALLDECOR_DIAGONAL_OFFSET.id){G?.setWallDecoration(_,R,L,j,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,N,U,b,I,-1),Y,O,256);if(F.anim!==-1){Q.addTail(new X0($,_,1,R,L,G0.instances[F.anim],true))}}else if(J===y.WALLDECOR_DIAGONAL_NOOFFSET.id){G?.setWallDecoration(_,R,L,j,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,N,U,b,I,-1),Y,O,512);if(F.anim!==-1){Q.addTail(new X0($,_,1,R,L,G0.instances[F.anim],true))}}else if(J===y.WALLDECOR_DIAGONAL_BOTH.id){G?.setWallDecoration(_,R,L,j,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,N,U,b,I,-1),Y,O,768);if(F.anim!==-1){Q.addTail(new X0($,_,1,R,L,G0.instances[F.anim],true))}}};maxTileX;maxTileZ;levelHeightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;levelShademap;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;levelOccludemap;constructor(_,R,L,G){this.maxTileX=_;this.maxTileZ=R;this.levelHeightmap=L;this.levelTileFlags=G;this.levelTileUnderlayIds=new I1(s.LEVELS,_,R);this.levelTileOverlayIds=new I1(s.LEVELS,_,R);this.levelTileOverlayShape=new I1(s.LEVELS,_,R);this.levelTileOverlayRotation=new I1(s.LEVELS,_,R);this.levelOccludemap=new A1(s.LEVELS,_+1,R+1);this.levelShademap=new I1(s.LEVELS,_+1,R+1);this.levelLightmap=new J1(_+1,R+1);this.blendChroma=new Int32Array(R);this.blendSaturation=new Int32Array(R);this.blendLightness=new Int32Array(R);this.blendLuminance=new Int32Array(R);this.blendMagnitude=new Int32Array(R)}build=(_,R)=>{for(let L=0;L<s.LEVELS;L++){for(let G=0;G<s.SIZE;G++){for(let K=0;K<s.SIZE;K++){if((this.levelTileFlags[L][G][K]&1)===1){let Q=L;if((this.levelTileFlags[1][G][K]&2)===2){Q--}if(Q>=0){R[Q]?.addFloor(G,K)}}}}}H0.randomHueOffset+=(Math.random()*5|0)-2;if(H0.randomHueOffset<-8){H0.randomHueOffset=-8}else if(H0.randomHueOffset>8){H0.randomHueOffset=8}H0.randomLightnessOffset+=(Math.random()*5|0)-2;if(H0.randomLightnessOffset<-16){H0.randomLightnessOffset=-16}else if(H0.randomLightnessOffset>16){H0.randomLightnessOffset=16}for(let L=0;L<s.LEVELS;L++){const G=this.levelShademap[L];const K=96;const Q=768;const H=-50;const $=-10;const J=-50;const O=Math.sqrt(H*H+$*$+J*J)|0;const q=Q*O>>8;for(let N=1;N<this.maxTileZ-1;N++){for(let U=1;U<this.maxTileX-1;U++){const b=this.levelHeightmap[L][U+1][N]-this.levelHeightmap[L][U-1][N];const I=this.levelHeightmap[L][U][N+1]-this.levelHeightmap[L][U][N-1];const j=Math.sqrt(b*b+I*I+65536)|0;const F=(b<<8)/j|0;const T=65536/j|0;const Y=(I<<8)/j|0;const u=K+((H*F+$*T+J*Y)/q|0);const w=(G[U-1][N]>>2)+(G[U+1][N]>>3)+(G[U][N-1]>>2)+(G[U][N+1]>>3)+(G[U][N]>>1);this.levelLightmap[U][N]=u-w}}for(let N=0;N<this.maxTileZ;N++){this.blendChroma[N]=0;this.blendSaturation[N]=0;this.blendLightness[N]=0;this.blendLuminance[N]=0;this.blendMagnitude[N]=0}for(let N=-5;N<this.maxTileX+5;N++){for(let U=0;U<this.maxTileZ;U++){const b=N+5;let I;if(b>=0&&b<this.maxTileX){const F=this.levelTileUnderlayIds[L][b][U]&255;if(F>0){const T=W0.instances[F-1];this.blendChroma[U]+=T.chroma;this.blendSaturation[U]+=T.saturation;this.blendLightness[U]+=T.lightness;this.blendLuminance[U]+=T.luminance;I=this.blendMagnitude[U]++}}const j=N-5;if(j>=0&&j<this.maxTileX){const F=this.levelTileUnderlayIds[L][j][U]&255;if(F>0){const T=W0.instances[F-1];this.blendChroma[U]-=T.chroma;this.blendSaturation[U]-=T.saturation;this.blendLightness[U]-=T.lightness;this.blendLuminance[U]-=T.luminance;I=this.blendMagnitude[U]--}}}if(N>=1&&N<this.maxTileX-1){let U=0;let b=0;let I=0;let j=0;let F=0;for(let T=-5;T<this.maxTileZ+5;T++){const Y=T+5;if(Y>=0&&Y<this.maxTileZ){U+=this.blendChroma[Y];b+=this.blendSaturation[Y];I+=this.blendLightness[Y];j+=this.blendLuminance[Y];F+=this.blendMagnitude[Y]}const u=T-5;if(u>=0&&u<this.maxTileZ){U-=this.blendChroma[u];b-=this.blendSaturation[u];I-=this.blendLightness[u];j-=this.blendLuminance[u];F-=this.blendMagnitude[u]}if(T>=1&&T<this.maxTileZ-1&&(!H0.lowMemory||(this.levelTileFlags[L][N][T]&16)===0&&this.getDrawLevel(L,N,T)===H0.levelBuilt)){const w=this.levelTileUnderlayIds[L][N][T]&255;const h=this.levelTileOverlayIds[L][N][T]&255;if(w>0||h>0){const v=this.levelHeightmap[L][N][T];const n=this.levelHeightmap[L][N+1][T];const A=this.levelHeightmap[L][N+1][T+1];const P=this.levelHeightmap[L][N][T+1];const z=this.levelLightmap[N][T];const f=this.levelLightmap[N+1][T];const m=this.levelLightmap[N+1][T+1];const M=this.levelLightmap[N][T+1];let r=-1;let a=-1;if(w>0){const R0=U*256/j|0;const e=b/F|0;let L0=I/F|0;r=W0.hsl24to16(R0,e,L0);const J0=R0+H0.randomHueOffset&255;L0+=H0.randomLightnessOffset;if(L0<0){L0=0}else if(L0>255){L0=255}a=W0.hsl24to16(J0,e,L0)}if(L>0){let R0=w!==0||this.levelTileOverlayShape[L][N][T]===T1.PLAIN;if(h>0&&!W0.instances[h-1].occlude){R0=false}if(R0&&v===n&&v===A&&v===P){this.levelOccludemap[L][N][T]|=2340}}let C=0;if(r!==-1){C=B.palette[W0.mulHSL(a,96)]}if(h===0){_?.setTile(L,N,T,T1.PLAIN,x.WEST,-1,v,n,A,P,W0.mulHSL(r,z),W0.mulHSL(r,f),W0.mulHSL(r,m),W0.mulHSL(r,M),X.BLACK,X.BLACK,X.BLACK,X.BLACK,C,X.BLACK)}else{const R0=this.levelTileOverlayShape[L][N][T]+1;const e=this.levelTileOverlayRotation[L][N][T];const L0=W0.instances[h-1];let J0=L0.texture;let Q0;let i;if(J0>=0){i=B.getAverageTextureRGB(J0);Q0=-1}else if(L0.rgb===X.MAGENTA){i=0;Q0=-2;J0=-1}else{Q0=W0.hsl24to16(L0.hue,L0.saturation,L0.lightness);i=B.palette[W0.adjustLightness(L0.hsl,96)]}_?.setTile(L,N,T,R0,e,J0,v,n,A,P,W0.mulHSL(r,z),W0.mulHSL(r,f),W0.mulHSL(r,m),W0.mulHSL(r,M),W0.adjustLightness(Q0,z),W0.adjustLightness(Q0,f),W0.adjustLightness(Q0,m),W0.adjustLightness(Q0,M),C,i)}}}}}}for(let N=1;N<this.maxTileZ-1;N++){for(let U=1;U<this.maxTileX-1;U++){_?.setDrawLevel(L,U,N,this.getDrawLevel(L,U,N))}}}if(!H0.fullbright){_?.buildModels(64,768,-50,-10,-50)}for(let L=0;L<this.maxTileX;L++){for(let G=0;G<this.maxTileZ;G++){if((this.levelTileFlags[1][L][G]&2)===2){_?.setBridge(L,G)}}}if(!H0.fullbright){let L=1;let G=2;let K=4;for(let Q=0;Q<s.LEVELS;Q++){if(Q>0){L<<=3;G<<=3;K<<=3}for(let H=0;H<=Q;H++){for(let $=0;$<=this.maxTileZ;$++){for(let J=0;J<=this.maxTileX;J++){if((this.levelOccludemap[H][J][$]&L)!==0){let O=$;let q=$;let N=H;let U=H;while(O>0&&(this.levelOccludemap[H][J][O-1]&L)!==0){O--}while(q<this.maxTileZ&&(this.levelOccludemap[H][J][q+1]&L)!==0){q++}_:while(N>0){for(let I=O;I<=q;I++){if((this.levelOccludemap[N-1][J][I]&L)===0){break _}}N--}_:while(U<Q){for(let I=O;I<=q;I++){if((this.levelOccludemap[U+1][J][I]&L)===0){break _}}U++}const b=(U+1-N)*(q+1-O);if(b>=8){const I=this.levelHeightmap[U][J][O]-240;const j=this.levelHeightmap[N][J][O];V.addOccluder(Q,1,J*128,I,O*128,J*128,j,q*128+128);for(let F=N;F<=U;F++){for(let T=O;T<=q;T++){this.levelOccludemap[F][J][T]&=~L}}}}if((this.levelOccludemap[H][J][$]&G)!==0){let O=J;let q=J;let N=H;let U=H;while(O>0&&(this.levelOccludemap[H][O-1][$]&G)!==0){O--}while(q<this.maxTileX&&(this.levelOccludemap[H][q+1][$]&G)!==0){q++}_:while(N>0){for(let I=O;I<=q;I++){if((this.levelOccludemap[N-1][I][$]&G)===0){break _}}N--}_:while(U<Q){for(let I=O;I<=q;I++){if((this.levelOccludemap[U+1][I][$]&G)===0){break _}}U++}const b=(U+1-N)*(q+1-O);if(b>=8){const I=this.levelHeightmap[U][O][$]-240;const j=this.levelHeightmap[N][O][$];V.addOccluder(Q,2,O*128,I,$*128,q*128+128,j,$*128);for(let F=N;F<=U;F++){for(let T=O;T<=q;T++){this.levelOccludemap[F][T][$]&=~G}}}}if((this.levelOccludemap[H][J][$]&K)!==0){let O=J;let q=J;let N=$;let U=$;while(N>0&&(this.levelOccludemap[H][J][N-1]&K)!==0){N--}while(U<this.maxTileZ&&(this.levelOccludemap[H][J][U+1]&K)!==0){U++}_:while(O>0){for(let b=N;b<=U;b++){if((this.levelOccludemap[H][O-1][b]&K)===0){break _}}O--}_:while(q<this.maxTileX){for(let b=N;b<=U;b++){if((this.levelOccludemap[H][q+1][b]&K)===0){break _}}q++}if((q+1-O)*(U+1-N)>=4){const b=this.levelHeightmap[H][O][N];V.addOccluder(Q,4,O*128,b,N*128,q*128+128,b,U*128+128);for(let I=O;I<=q;I++){for(let j=N;j<=U;j++){this.levelOccludemap[H][I][j]&=~K}}}}}}}}}};clearLandscape=(_,R,L,G)=>{let K=0;for(let Q=0;Q<W0.count;Q++){if(W0.instances[Q].debugname?.toLowerCase()==="water"){K=Q+1<<24>>24;break}}for(let Q=_;Q<_+L;Q++){for(let H=R;H<R+G;H++){if(H>=0&&H<this.maxTileX&&Q>=0&&Q<this.maxTileZ){this.levelTileOverlayIds[0][H][Q]=K;for(let $=0;$<s.LEVELS;$++){this.levelHeightmap[$][H][Q]=0;this.levelTileFlags[$][H][Q]=0}}}}};readLandscape=(_,R,L,G,K)=>{const Q=new p(K);for(let H=0;H<s.LEVELS;H++){for(let $=0;$<64;$++){for(let J=0;J<64;J++){const O=$+L;const q=J+G;let N;if(O>=0&&O<s.SIZE&&q>=0&&q<s.SIZE){this.levelTileFlags[H][O][q]=0;while(true){N=Q.g1;if(N===0){if(H===0){this.levelHeightmap[0][O][q]=-H0.perlin(O+_+932731,q+556238+R)*8}else{this.levelHeightmap[H][O][q]=this.levelHeightmap[H-1][O][q]-240}break}if(N===1){let U=Q.g1;if(U===1){U=0}if(H===0){this.levelHeightmap[0][O][q]=-U*8}else{this.levelHeightmap[H][O][q]=this.levelHeightmap[H-1][O][q]-U*8}break}if(N<=49){this.levelTileOverlayIds[H][O][q]=Q.g1b;this.levelTileOverlayShape[H][O][q]=((N-2)/4|0)<<24>>24;this.levelTileOverlayRotation[H][O][q]=(N-2&3)<<24>>24}else if(N<=81){this.levelTileFlags[H][O][q]=N-49<<24>>24}else{this.levelTileUnderlayIds[H][O][q]=N-81<<24>>24}}}else{while(true){N=Q.g1;if(N===0){break}if(N===1){Q.g1;break}if(N<=49){Q.g1}}}}}}};readLocs=(_,R,L,G,K,Q)=>{const H=new p(G);let $=-1;while(true){const J=H.gsmarts;if(J===0){return}$+=J;let O=0;while(true){const q=H.gsmarts;if(q===0){break}O+=q-1;const N=O&63;const U=O>>6&63;const b=O>>12;const I=H.g1;const j=I>>2;const F=I&3;const T=U+K;const Y=N+Q;if(T>0&&Y>0&&T<s.SIZE-1&&Y<s.SIZE-1){let u=b;if((this.levelTileFlags[1][T][Y]&2)===2){u=b-1}let w=null;if(u>=0){w=L[u]}this.addLoc(b,T,Y,_,R,w,$,j,F)}}}};addLoc=(_,R,L,G,K,Q,H,$,J)=>{if(H0.lowMemory){if((this.levelTileFlags[_][R][L]&16)!==0){return}if(this.getDrawLevel(_,R,L)!==H0.levelBuilt){return}}const O=this.levelHeightmap[_][R][L];const q=this.levelHeightmap[_][R+1][L];const N=this.levelHeightmap[_][R+1][L+1];const U=this.levelHeightmap[_][R][L+1];const b=O+q+N+U>>2;const I=h0.get(H);let j=R+(L<<7)+(H<<14)+1073741824|0;if(!I.active){j+=-2147483648}j|=0;const F=((J<<6)+$|0)<<24>>24;if($===y.GROUND_DECOR.id){if(!H0.lowMemory||I.active||I.forcedecor){G?.addGroundDecoration(I.getModel(y.GROUND_DECOR.id,J,O,q,N,U,-1),_,R,L,b,j,F);if(I.blockwalk&&I.active){Q?.addFloor(R,L)}if(I.anim!==-1){K.addTail(new X0(H,_,3,R,L,G0.instances[I.anim],true))}}}else if($===y.CENTREPIECE_STRAIGHT.id||$===y.CENTREPIECE_DIAGONAL.id){const T=I.getModel(y.CENTREPIECE_STRAIGHT.id,J,O,q,N,U,-1);if(T){let Y=0;if($===y.CENTREPIECE_DIAGONAL.id){Y+=256}let u;let w;if(J===x.NORTH||J===x.SOUTH){u=I.length;w=I.width}else{u=I.width;w=I.length}if(G?.addLoc(_,R,L,b,T,null,j,F,u,w,Y)&&I.shadow){for(let h=0;h<=u;h++){for(let v=0;v<=w;v++){let n=T.radius/4|0;if(n>30){n=30}if(n>this.levelShademap[_][R+h][L+v]){this.levelShademap[_][R+h][L+v]=n<<24>>24}}}}}if(I.blockwalk){Q?.addLoc(R,L,I.width,I.length,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,2,R,L,G0.instances[I.anim],true))}}else if($>=y.ROOF_STRAIGHT.id){G?.addLoc(_,R,L,b,I.getModel($,J,O,q,N,U,-1),null,j,F,1,1,0);if($>=y.ROOF_STRAIGHT.id&&$<=y.ROOF_FLAT.id&&$!==y.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&_>0){this.levelOccludemap[_][R][L]|=2340}if(I.blockwalk){Q?.addLoc(R,L,I.width,I.length,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,2,R,L,G0.instances[I.anim],true))}}else if($===y.WALL_STRAIGHT.id){G?.addWall(_,R,L,b,H0.ROTATION_WALL_TYPE[J],0,I.getModel(y.WALL_STRAIGHT.id,J,O,q,N,U,-1),null,j,F);if(J===x.WEST){if(I.shadow){this.levelShademap[_][R][L]=50;this.levelShademap[_][R][L+1]=50}if(I.occlude){this.levelOccludemap[_][R][L]|=585}}else if(J===x.NORTH){if(I.shadow){this.levelShademap[_][R][L+1]=50;this.levelShademap[_][R+1][L+1]=50}if(I.occlude){this.levelOccludemap[_][R][L+1]|=1170}}else if(J===x.EAST){if(I.shadow){this.levelShademap[_][R+1][L]=50;this.levelShademap[_][R+1][L+1]=50}if(I.occlude){this.levelOccludemap[_][R+1][L]|=585}}else if(J===x.SOUTH){if(I.shadow){this.levelShademap[_][R][L]=50;this.levelShademap[_][R+1][L]=50}if(I.occlude){this.levelOccludemap[_][R][L]|=1170}}if(I.blockwalk){Q?.addWall(R,L,$,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,0,R,L,G0.instances[I.anim],true))}if(I.wallwidth!==16){G?.setWallDecorationOffset(_,R,L,I.wallwidth)}}else if($===y.WALL_DIAGONAL_CORNER.id){G?.addWall(_,R,L,b,H0.ROTATION_WALL_CORNER_TYPE[J],0,I.getModel(y.WALL_DIAGONAL_CORNER.id,J,O,q,N,U,-1),null,j,F);if(I.shadow){if(J===x.WEST){this.levelShademap[_][R][L+1]=50}else if(J===x.NORTH){this.levelShademap[_][R+1][L+1]=50}else if(J===x.EAST){this.levelShademap[_][R+1][L]=50}else if(J===x.SOUTH){this.levelShademap[_][R][L]=50}}if(I.blockwalk){Q?.addWall(R,L,$,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,0,R,L,G0.instances[I.anim],true))}}else if($===y.WALL_L.id){const T=J+1&3;G?.addWall(_,R,L,b,H0.ROTATION_WALL_TYPE[J],H0.ROTATION_WALL_TYPE[T],I.getModel(y.WALL_L.id,J+4,O,q,N,U,-1),I.getModel(y.WALL_L.id,T,O,q,N,U,-1),j,F);if(I.occlude){if(J===x.WEST){this.levelOccludemap[_][R][L]|=265;this.levelOccludemap[_][R][L+1]|=1170}else if(J===x.NORTH){this.levelOccludemap[_][R][L+1]|=1170;this.levelOccludemap[_][R+1][L]|=585}else if(J===x.EAST){this.levelOccludemap[_][R+1][L]|=585;this.levelOccludemap[_][R][L]|=1170}else if(J===x.SOUTH){this.levelOccludemap[_][R][L]|=1170;this.levelOccludemap[_][R][L]|=585}}if(I.blockwalk){Q?.addWall(R,L,$,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,0,R,L,G0.instances[I.anim],true))}if(I.wallwidth!==16){G?.setWallDecorationOffset(_,R,L,I.wallwidth)}}else if($===y.WALL_SQUARE_CORNER.id){G?.addWall(_,R,L,b,H0.ROTATION_WALL_CORNER_TYPE[J],0,I.getModel(y.WALL_SQUARE_CORNER.id,J,O,q,N,U,-1),null,j,F);if(I.shadow){if(J===x.WEST){this.levelShademap[_][R][L+1]=50}else if(J===x.NORTH){this.levelShademap[_][R+1][L+1]=50}else if(J===x.EAST){this.levelShademap[_][R+1][L]=50}else if(J===x.SOUTH){this.levelShademap[_][R][L]=50}}if(I.blockwalk){Q?.addWall(R,L,$,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,0,R,L,G0.instances[I.anim],true))}}else if($===y.WALL_DIAGONAL.id){G?.addLoc(_,R,L,b,I.getModel($,J,O,q,N,U,-1),null,j,F,1,1,0);if(I.blockwalk){Q?.addLoc(R,L,I.width,I.length,J,I.blockrange)}if(I.anim!==-1){K.addTail(new X0(H,_,2,R,L,G0.instances[I.anim],true))}}else if($===y.WALLDECOR_STRAIGHT_NOOFFSET.id){G?.setWallDecoration(_,R,L,b,0,0,j,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,N,U,-1),F,J*512,H0.ROTATION_WALL_TYPE[J]);if(I.anim!==-1){K.addTail(new X0(H,_,1,R,L,G0.instances[I.anim],true))}}else if($===y.WALLDECOR_STRAIGHT_OFFSET.id){let T=16;if(G){const Y=G.getWallBitset(_,R,L);if(Y>0){T=h0.get(Y>>14&32767).wallwidth}}G?.setWallDecoration(_,R,L,b,H0.WALL_DECORATION_ROTATION_FORWARD_X[J]*T,H0.WALL_DECORATION_ROTATION_FORWARD_Z[J]*T,j,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,N,U,-1),F,J*512,H0.ROTATION_WALL_TYPE[J]);if(I.anim!==-1){K.addTail(new X0(H,_,1,R,L,G0.instances[I.anim],true))}}else if($===y.WALLDECOR_DIAGONAL_OFFSET.id){G?.setWallDecoration(_,R,L,b,0,0,j,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,N,U,-1),F,J,256);if(I.anim!==-1){K.addTail(new X0(H,_,1,R,L,G0.instances[I.anim],true))}}else if($===y.WALLDECOR_DIAGONAL_NOOFFSET.id){G?.setWallDecoration(_,R,L,b,0,0,j,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,N,U,-1),F,J,512);if(I.anim!==-1){K.addTail(new X0(H,_,1,R,L,G0.instances[I.anim],true))}}else if($===y.WALLDECOR_DIAGONAL_BOTH.id){G?.setWallDecoration(_,R,L,b,0,0,j,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,N,U,-1),F,J,768);if(I.anim!==-1){K.addTail(new X0(H,_,1,R,L,G0.instances[I.anim],true))}}};getDrawLevel=(_,R,L)=>{if((this.levelTileFlags[_][R][L]&8)===0){return _<=0||(this.levelTileFlags[1][R][L]&2)===0?_:_-1}return 0}}class j1 extends D0{}class M1 extends j1{x=0;z=0;yaw=0;seqStretches=false;size=1;seqStandId=-1;seqTurnId=-1;seqWalkId=-1;seqTurnAroundId=-1;seqTurnLeftId=-1;seqTurnRightId=-1;seqRunId=-1;chat=null;chatTimer=100;chatColor=0;chatStyle=0;damage=0;damageType=0;combatCycle=-1000;health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimOffset=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;pathLength=0;pathTileX=new Int32Array(10);pathTileZ=new Int32Array(10);pathRunning=new l(10,false);seqTrigger=0;lastMask=-1;lastMaskCycle=-1;lastFaceX=-1;lastFaceZ=-1;move(_,R,L){if(this.primarySeqId!==-1&&G0.instances[this.primarySeqId].priority<=1){this.primarySeqId=-1}if(!_){const G=R-this.pathTileX[0];const K=L-this.pathTileZ[0];if(G>=-8&&G<=8&&K>=-8&&K<=8){if(this.pathLength<9){this.pathLength++}for(let Q=this.pathLength;Q>0;Q--){this.pathTileX[Q]=this.pathTileX[Q-1];this.pathTileZ[Q]=this.pathTileZ[Q-1];this.pathRunning[Q]=this.pathRunning[Q-1]}this.pathTileX[0]=R;this.pathTileZ[0]=L;this.pathRunning[0]=false;return}}this.pathLength=0;this.seqTrigger=0;this.pathTileX[0]=R;this.pathTileZ[0]=L;this.x=this.pathTileX[0]*128+this.size*64;this.z=this.pathTileZ[0]*128+this.size*64}step(_,R){let L=this.pathTileX[0];let G=this.pathTileZ[0];if(R===0){L--;G++}else if(R===1){G++}else if(R===2){L++;G++}else if(R===3){L--}else if(R===4){L++}else if(R===5){L--;G--}else if(R===6){G--}else if(R===7){L++;G--}if(this.primarySeqId!==-1&&G0.instances[this.primarySeqId].priority<=1){this.primarySeqId=-1}if(this.pathLength<9){this.pathLength++}for(let K=this.pathLength;K>0;K--){this.pathTileX[K]=this.pathTileX[K-1];this.pathTileZ[K]=this.pathTileZ[K-1];this.pathRunning[K]=this.pathRunning[K-1]}this.pathTileX[0]=L;this.pathTileZ[0]=G;this.pathRunning[0]=_}}class f0 extends M1{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;type=null;draw(_){if(!this.type){return null}if(this.spotanimId===-1||this.spotanimFrame===-1){return this.getSequencedModel()}const R=this.getSequencedModel();if(!R){return null}const L=p0.instances[this.spotanimId];const G=E.modelShareColored(L.getModel(),true,!L.disposeAlpha,false);G.translate(-this.spotanimOffset,0,0);G.createLabelReferences();if(L.seq&&L.seq.frames){G.applyTransform(L.seq.frames[this.spotanimFrame])}G.labelFaces=null;G.labelVertices=null;if(L.resizeh!==128||L.resizev!==128){G.scale(L.resizeh,L.resizev,L.resizeh)}G.calculateNormals(64+L.ambient,850+L.contrast,-30,-50,-30,true);const K=[R,G];const Q=E.modelFromModelsBounds(K,2);if(this.type.size===1){Q.pickable=true}return Q}isVisible(){return this.type!==null}getSequencedModel(){if(!this.type){return null}if(this.primarySeqId>=0&&this.primarySeqDelay===0){const L=G0.instances[this.primarySeqId].frames;if(L){const G=L[this.primarySeqFrame];let K=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){const Q=G0.instances[this.secondarySeqId].frames;if(Q){K=Q[this.secondarySeqFrame]}}return this.type.getSequencedModel(G,K,G0.instances[this.primarySeqId].walkmerge)}}let _=-1;if(this.secondarySeqId>=0){const L=G0.instances[this.secondarySeqId].frames;if(L){_=L[this.secondarySeqFrame]}}const R=this.type.getSequencedModel(_,-1,null);if(!R){return null}this.height=R.maxY;return R}}class U0 extends M1{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static TORSO_RECOLORS=[X.BODY_RECOLOR_KHAKI,X.BODY_RECOLOR_CHARCOAL,X.BODY_RECOLOR_CRIMSON,X.BODY_RECOLOR_NAVY,X.BODY_RECOLOR_STRAW,X.BODY_RECOLOR_WHITE,X.BODY_RECOLOR_RED,X.BODY_RECOLOR_BLUE,X.BODY_RECOLOR_GREEN,X.BODY_RECOLOR_YELLOW,X.BODY_RECOLOR_PURPLE,X.BODY_RECOLOR_ORANGE,X.BODY_RECOLOR_ROSE,X.BODY_RECOLOR_LIME,X.BODY_RECOLOR_CYAN,X.BODY_RECOLOR_EMERALD];static DESIGN_IDK_COLORS=[[X.HAIR_DARK_BROWN,X.HAIR_WHITE,X.HAIR_LIGHT_GREY,X.HAIR_DARK_GREY,X.HAIR_APRICOT,X.HAIR_STRAW,X.HAIR_LIGHT_BROWN,X.HAIR_BROWN,X.HAIR_TURQUOISE,X.HAIR_GREEN,X.HAIR_GINGER,X.HAIR_MAGENTA],[X.BODY_KHAKI,X.BODY_CHARCOAL,X.BODY_CRIMSON,X.BODY_NAVY,X.BODY_STRAW,X.BODY_WHITE,X.BODY_RED,X.BODY_BLUE,X.BODY_GREEN,X.BODY_YELLOW,X.BODY_PURPLE,X.BODY_ORANGE,X.BODY_ROSE,X.BODY_LIME,X.BODY_CYAN,X.BODY_EMERALD],[X.BODY_EMERALD-1,X.BODY_KHAKI+1,X.BODY_CHARCOAL,X.BODY_CRIMSON,X.BODY_NAVY,X.BODY_STRAW,X.BODY_WHITE,X.BODY_RED,X.BODY_BLUE,X.BODY_GREEN,X.BODY_YELLOW,X.BODY_PURPLE,X.BODY_ORANGE,X.BODY_ROSE,X.BODY_LIME,X.BODY_CYAN],[X.FEET_BROWN,X.FEET_KHAKI,X.FEET_ASHEN,X.FEET_DARK,X.FEET_TERRACOTTA,X.FEET_GREY],[X.SKIN_DARKER,X.SKIN_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER,X.SKIN]];static modelCache=new s0(200);name=null;visible=false;gender=0;headicons=0;appearances=new Uint16Array(12);colors=new Uint16Array(5);combatLevel=0;appearanceHashcode=0n;y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;lowMemory=false;draw(_){if(!this.visible){return null}let R=this.getSequencedModel();this.height=R.maxY;R.pickable=true;if(this.lowMemory){return R}if(this.spotanimId!==-1&&this.spotanimFrame!==-1){const L=p0.instances[this.spotanimId];const G=E.modelShareColored(L.getModel(),true,!L.disposeAlpha,false);G.translate(-this.spotanimOffset,0,0);G.createLabelReferences();if(L.seq&&L.seq.frames){G.applyTransform(L.seq.frames[this.spotanimFrame])}G.labelFaces=null;G.labelVertices=null;if(L.resizeh!==128||L.resizev!==128){G.scale(L.resizeh,L.resizev,L.resizeh)}G.calculateNormals(L.ambient+64,L.contrast+850,-30,-50,-30,true);const K=[R,G];R=E.modelFromModelsBounds(K,2)}if(this.locModel){if(_>=this.locStopCycle){this.locModel=null}if(_>=this.locStartCycle&&_<this.locStopCycle){const L=this.locModel;if(L){L.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z);if(this.dstYaw===512){L.rotateY90();L.rotateY90();L.rotateY90()}else if(this.dstYaw===1024){L.rotateY90();L.rotateY90()}else if(this.dstYaw===1536){L.rotateY90()}const G=[R,L];R=E.modelFromModelsBounds(G,2);if(this.dstYaw===512){L.rotateY90()}else if(this.dstYaw===1024){L.rotateY90();L.rotateY90()}else if(this.dstYaw===1536){L.rotateY90();L.rotateY90();L.rotateY90()}L.translate(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}}R.pickable=true;return R}isVisible(){return this.visible}read(_){_.pos=0;this.gender=_.g1;this.headicons=_.g1;for(let R=0;R<12;R++){const L=_.g1;if(L===0){this.appearances[R]=0}else{this.appearances[R]=(L<<8)+_.g1}}for(let R=0;R<5;R++){let L=_.g1;if(L<0||L>=U0.DESIGN_IDK_COLORS[R].length){L=0}this.colors[R]=L}this.seqStandId=_.g2;if(this.seqStandId===65535){this.seqStandId=-1}this.seqTurnId=_.g2;if(this.seqTurnId===65535){this.seqTurnId=-1}this.seqWalkId=_.g2;if(this.seqWalkId===65535){this.seqWalkId=-1}this.seqTurnAroundId=_.g2;if(this.seqTurnAroundId===65535){this.seqTurnAroundId=-1}this.seqTurnLeftId=_.g2;if(this.seqTurnLeftId===65535){this.seqTurnLeftId=-1}this.seqTurnRightId=_.g2;if(this.seqTurnRightId===65535){this.seqTurnRightId=-1}this.seqRunId=_.g2;if(this.seqRunId===65535){this.seqRunId=-1}this.name=I0.formatName(I0.fromBase37(_.g8));this.combatLevel=_.g1;this.visible=true;this.appearanceHashcode=0n;for(let R=0;R<12;R++){this.appearanceHashcode<<=0x4n;if(this.appearances[R]>=256){this.appearanceHashcode+=BigInt(this.appearances[R])-256n}}if(this.appearances[0]>=256){this.appearanceHashcode+=BigInt(this.appearances[0])-256n>>4n}if(this.appearances[1]>=256){this.appearanceHashcode+=BigInt(this.appearances[1])-256n>>8n}for(let R=0;R<5;R++){this.appearanceHashcode<<=0x3n;this.appearanceHashcode+=BigInt(this.colors[R])}this.appearanceHashcode<<=0x1n;this.appearanceHashcode+=BigInt(this.gender)}getHeadModel(){if(!this.visible){return null}const _=new l(12,null);let R=0;for(let G=0;G<12;G++){const K=this.appearances[G];if(K>=256&&K<512){_[R++]=i0.instances[K-256].getHeadModel()}if(K>=512){const Q=Y0.get(K-512).getHeadModel(this.gender);if(Q){_[R++]=Q}}}const L=E.modelFromModels(_,R);for(let G=0;G<5;G++){if(this.colors[G]===0){continue}L.recolor(U0.DESIGN_IDK_COLORS[G][0],U0.DESIGN_IDK_COLORS[G][this.colors[G]]);if(G===1){L.recolor(U0.TORSO_RECOLORS[0],U0.TORSO_RECOLORS[this.colors[G]])}}return L}getSequencedModel(){let _=this.appearanceHashcode;let R=-1;let L=-1;let G=-1;let K=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){const $=G0.instances[this.primarySeqId];if($.frames){R=$.frames[this.primarySeqFrame]}if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){const J=G0.instances[this.secondarySeqId].frames;if(J){L=J[this.secondarySeqFrame]}}if($.righthand>=0){G=$.righthand;_+=BigInt(G-this.appearances[5])<<8n}if($.lefthand>=0){K=$.lefthand;_+=BigInt(K-this.appearances[3])<<16n}}else if(this.secondarySeqId>=0){const $=G0.instances[this.secondarySeqId].frames;if($){R=$[this.secondarySeqFrame]}}let Q=U0.modelCache?.get(_);if(!Q){const $=new l(12,null);let J=0;for(let O=0;O<12;O++){let q=this.appearances[O];if(K>=0&&O===3){q=K}if(G>=0&&O===5){q=G}if(q>=256&&q<512){const N=i0.instances[q-256].getModel();if(N){$[J++]=N}}if(q>=512){const N=Y0.get(q-512);const U=N.getWornModel(this.gender);if(U){$[J++]=U}}}Q=E.modelFromModels($,J);for(let O=0;O<5;O++){if(this.colors[O]===0){continue}Q.recolor(U0.DESIGN_IDK_COLORS[O][0],U0.DESIGN_IDK_COLORS[O][this.colors[O]]);if(O===1){Q.recolor(U0.TORSO_RECOLORS[0],U0.TORSO_RECOLORS[this.colors[O]])}}Q.createLabelReferences();Q.calculateNormals(64,850,-30,-50,-30,true);U0.modelCache?.put(_,Q)}if(this.lowMemory){return Q}const H=E.modelShareAlpha(Q,true);if(R!==-1&&L!==-1){H.applyTransforms(R,L,G0.instances[this.primarySeqId].walkmerge)}else if(R!==-1){H.applyTransform(R)}H.calculateBoundsCylinder();H.labelFaces=null;H.labelVertices=null;return H}}class R8 extends D0{plane;layer;x;z;locIndex;angle;shape;lastCycle;constructor(_,R,L,G,K,Q,H,$){super();this.plane=_;this.layer=R;this.x=L;this.z=G;this.locIndex=K;this.angle=Q;this.shape=H;this.lastCycle=$}}class S8 extends D0{plane;layer;x;z;locIndex;angle;shape;lastLocIndex;lastAngle;lastShape;constructor(_,R,L,G,K,Q,H,$,J,O){super();this.plane=_;this.layer=R;this.x=L;this.z=G;this.locIndex=K;this.angle=Q;this.shape=H;this.lastLocIndex=$;this.lastAngle=J;this.lastShape=O}}class L8 extends D0{index;count;constructor(_,R){super();this.index=_;this.count=R}}class P8 extends j1{spotanim;level;srcX;srcZ;srcY;offsetY;startCycle;lastCycle;peakPitch;arc;target;mobile=false;x=0;z=0;y=0;velocityX=0;velocityZ=0;velocity=0;velocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(_,R,L,G,K,Q,H,$,J,O,q){super();this.spotanim=p0.instances[_];this.level=R;this.srcX=L;this.srcZ=K;this.srcY=G;this.startCycle=Q;this.lastCycle=H;this.peakPitch=$;this.arc=J;this.target=O;this.offsetY=q}updateVelocity(_,R,L,G){if(!this.mobile){const Q=_-this.srcX;const H=L-this.srcZ;const $=Math.sqrt(Q*Q+H*H);this.x=this.srcX+Q*this.arc/$;this.z=this.srcZ+H*this.arc/$;this.y=this.srcY}const K=this.lastCycle+1-G;this.velocityX=(_-this.x)/K;this.velocityZ=(L-this.z)/K;this.velocity=Math.sqrt(this.velocityX*this.velocityX+this.velocityZ*this.velocityZ);if(!this.mobile){this.velocityY=-this.velocity*Math.tan(this.peakPitch*0.02454369)}this.accelerationY=(R-this.y-this.velocityY*K)*2/(K*K)}update(_){this.mobile=true;this.x+=this.velocityX*_;this.z+=this.velocityZ*_;this.y+=this.velocityY*_+this.accelerationY*0.5*_*_;this.velocityY+=this.accelerationY*_;this.yaw=(Math.atan2(this.velocityX,this.velocityZ)*325.949+1024|0)&2047;this.pitch=(Math.atan2(this.velocityY,this.velocity)*325.949|0)&2047;if(!this.spotanim.seq||!this.spotanim.seq.delay){return}this.seqCycle+=_;while(this.seqCycle>this.spotanim.seq.delay[this.seqFrame]){this.seqCycle-=this.spotanim.seq.delay[this.seqFrame]+1;this.seqFrame++;if(this.seqFrame>=this.spotanim.seq.frameCount){this.seqFrame=0}}}draw(){const _=this.spotanim.getModel();const R=E.modelShareColored(_,true,!this.spotanim.disposeAlpha,false);if(this.spotanim.seq&&this.spotanim.seq.frames){R.createLabelReferences();R.applyTransform(this.spotanim.seq.frames[this.seqFrame]);R.labelFaces=null;R.labelVertices=null}if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128){R.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh)}R.rotateX(this.pitch);R.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,true);return R}}class z8 extends j1{type;level;x;z;y;startCycle;seqComplete=false;seqFrame=0;seqCycle=0;constructor(_,R,L,G,K,Q,H){super();this.type=p0.instances[_];this.level=R;this.x=L;this.z=G;this.y=K;this.startCycle=Q+H}update(_){if(!this.type.seq||!this.type.seq.delay){return}for(this.seqCycle+=_;this.seqCycle>this.type.seq.delay[this.seqFrame];){this.seqCycle-=this.type.seq.delay[this.seqFrame]+1;this.seqFrame++;if(this.seqFrame>=this.type.seq.frameCount){this.seqFrame=0;this.seqComplete=true}}}draw(){const _=this.type.getModel();const R=E.modelShareColored(_,true,!this.type.disposeAlpha,false);if(!this.seqComplete&&this.type.seq&&this.type.seq.frames){R.createLabelReferences();R.applyTransform(this.type.seq.frames[this.seqFrame]);R.labelFaces=null;R.labelVertices=null}if(this.type.resizeh!==128||this.type.resizev!==128){R.scale(this.type.resizeh,this.type.resizev,this.type.resizeh)}if(this.type.orientation!==0){if(this.type.orientation===90){R.rotateY90()}else if(this.type.orientation===180){R.rotateY90();R.rotateY90()}else if(this.type.orientation===270){R.rotateY90();R.rotateY90();R.rotateY90()}}R.calculateNormals(64+this.type.ambient,850+this.type.contrast,-30,-50,-30,true);return R}}class E6{constructor(_={}){this.wasmModule=undefined;this.soundfontBufferPtr=0;this.soundfontPtr=0;this.midiBufferPtr=0;this.renderInterval=_.renderInterval||100;this.sampleRate=_.sampleRate||44100;this.channels=_.channels||2;this.gain=_.gain||0;if(!_.bufferSize){this.setBufferDuration(1)}else{this.bufferSize=_.bufferSize}this.onPCMData=_.onPCMData||(()=>{});this.onRenderEnd=_.onRenderEnd||(()=>{});this.renderTimer=undefined;this.test=0}async init(){if(this.wasmModule){return}this.wasmModule=await q6();this.pcmBufferPtr=this.wasmModule._malloc(this.bufferSize);this.msecsPtr=this.wasmModule._malloc(8)}setBufferDuration(_){this.bufferSize=4*this.sampleRate*this.channels*_}ensureInitialized(){if(!this.wasmModule){throw new Error(`${this.constructor.name} not initalized. call .init()`)}}setSoundfont(_){this.ensureInitialized();const{_malloc:R,_free:L,_tsf_load_memory:G,_tsf_set_output:K}=this.wasmModule;L(this.soundfontBufferPtr);this.soundfontBufferPtr=R(_.length);this.wasmModule.HEAPU8.set(_,this.soundfontBufferPtr);this.soundfontPtr=G(this.soundfontBufferPtr,_.length);K(this.soundfontPtr,this.channels===2?0:2,this.sampleRate,this.gain)}getPCMBuffer(){this.ensureInitialized();const _=new Uint8Array(this.bufferSize);_.set(this.wasmModule.HEAPU8.subarray(this.pcmBufferPtr,this.pcmBufferPtr+this.bufferSize));return _}getMIDIMessagePtr(_){const{_malloc:R,_free:L,_tml_load_memory:G}=this.wasmModule;L(this.midiBufferPtr);this.midiBufferPtr=R(_.length);this.wasmModule.HEAPU8.set(_,this.midiBufferPtr);return G(this.midiBufferPtr,_.length)}renderMIDIMessage(_){const{_midi_render:R}=this.wasmModule;return R(this.soundfontPtr,_,this.channels,this.sampleRate,this.pcmBufferPtr,this.bufferSize,this.msecsPtr)}render(_){this.ensureInitialized();if(!this.soundfontPtr){throw new Error("no soundfont buffer set. call .setSoundfont")}window.clearTimeout(this.renderTimer);const{setValue:R,getValue:L,_tsf_reset:G,_tsf_channel_set_bank_preset:K}=this.wasmModule;R(this.msecsPtr,0,"double");G(this.soundfontPtr);K(this.soundfontPtr,9,128,0);let Q=this.getMIDIMessagePtr(_);const H=function(){Q=this.renderMIDIMessage(Q);const $=this.getPCMBuffer();this.onPCMData($);if(Q){this.renderTimer=setTimeout(H,this.renderInterval)}else{this.onRenderEnd(L(this.msecsPtr,"double"))}}.bind(this);this.renderTimer=setTimeout(()=>{H()},16)}}var F6=E6;(function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;if(window.AudioContext){window.audioContext=new window.AudioContext}var _=function(R){if(window.audioContext){var L=window.audioContext.createBuffer(1,1,22050);var G=window.audioContext.createBufferSource();G.buffer=L;G.connect(window.audioContext.destination);if(G.start){G.start(0)}else if(G.play){G.play(0)}else if(G.noteOn){G.noteOn(0)}}document.removeEventListener("touchstart",_);document.removeEventListener("touchend",_);document.removeEventListener("click",_)};document.addEventListener("touchstart",_);document.addEventListener("touchend",_);document.addEventListener("click",_)})();(async()=>{const _=2;const R=44100;const L=250;const G=30;const K=2;let Q=new Float32Array;let H=window.audioContext.createGain();H.gain.setValueAtTime(0.1,window.audioContext.currentTime);H.connect(window.audioContext.destination);let $=window.audioContext.currentTime;let J=[];const O=new F6({renderInterval:G,onPCMData:(T)=>{let Y=new Float32Array(T.buffer);let u=new Float32Array(Q.length+Y.length);u.set(Q,0);u.set(Y,Q.length);Q=u},onRenderEnd:(T)=>{},bufferSize:1024*100});await O.init();const q=await fetch(new URL("SCC1_Florestan.sf2",import.meta.url));const N=new Uint8Array(await q.arrayBuffer());O.setSoundfont(N);function U(){if(!window.audioContext||!Q.length){return}let T=window.audioContext.createBufferSource();const Y=Q.length/_;const u=window.audioContext.createBuffer(_,Y,R);for(let w=0;w<_;w++){const h=u.getChannelData(w);let v=w;for(let n=0;n<Y;n++){h[n]=Q[v];v+=_}}if($<window.audioContext.currentTime){$=window.audioContext.currentTime}T.buffer=u;T.connect(H);T.start($);J.push(T);$+=u.duration;Q=new Float32Array}let b;function I(T){const Y=window.audioContext.currentTime;H.gain.cancelScheduledValues(Y);H.gain.setTargetAtTime(0,Y,0.5);setTimeout(T,K*1000)}function j(){if(b){clearInterval(b)}Q=new Float32Array;if(J.length){let T=H.gain.value;H.gain.setValueAtTime(0,window.audioContext.currentTime);J.forEach((Y)=>{Y.stop(window.audioContext.currentTime)});J=[];H.gain.setValueAtTime(T,window.audioContext.currentTime)}}function F(T,Y){if(T!==-1){window._tinyMidiVolume(T)}$=window.audioContext.currentTime;b=setInterval(U,L);O.render(Y)}window._tinyMidiStop=async(T)=>{if(T){I(()=>{j()})}else{j()}};window._tinyMidiVolume=(T=1)=>{H.gain.setValueAtTime(T,window.audioContext.currentTime)};window._tinyMidiPlay=async(T,Y,u)=>{if(!T){return}await window._tinyMidiStop(u);if(u){setTimeout(()=>{F(Y,T)},K*1000)}else{F(Y,T)}}})();var G8;async function T6(_,R){v1(R);try{const L=await window.audioContext.decodeAudioData(Uint8Array.from(_).buffer);let G=window.audioContext.createBufferSource();G.buffer=L;G.connect(G8);G.start()}catch(L){}}function v1(_){if(!G8){G8=window.audioContext.createGain();G8.connect(window.audioContext.destination)}G8.gain.value=_/256}function j6(_,R,L){if(window._tinyMidiPlay){window._tinyMidiPlay(_,R/256,L)}}function K8(_){if(window._tinyMidiVolume){window._tinyMidiVolume(_/256)}}function D8(_){if(window._tinyMidiStop){window._tinyMidiStop(_)}}class M8{seed;constructor(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}setSeed(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(_){this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n;return Number(this.seed)>>>48-_}}class y0 extends x0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];static{const _=navigator.userAgent.includes("Capacitor");for(let R=0;R<256;R++){let L=y0.CHARSET.indexOf(String.fromCharCode(R));if(_){if(L>=63){L--}}if(L===-1){L=74}y0.CHARCODESET[R]=L}}charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new M8(BigInt(Date.now()));height=0;static fromArchive=(_,R)=>{const L=new p(_.read(R+".dat"));const G=new p(_.read("index.dat"));G.pos=L.g2+4;const K=G.g1;if(K>0){G.pos+=(K-1)*3}const Q=new y0;for(let H=0;H<94;H++){Q.charOffsetX[H]=G.g1;Q.charOffsetY[H]=G.g1;const $=Q.charMaskWidth[H]=G.g2;const J=Q.charMaskHeight[H]=G.g2;const O=G.g1;const q=$*J;Q.charMask[H]=new Int8Array(q);if(O===0){for(let N=0;N<$*J;N++){Q.charMask[H][N]=L.g1b}}else if(O===1){for(let N=0;N<$;N++){for(let U=0;U<J;U++){Q.charMask[H][N+U*$]=L.g1b}}}if(J>Q.height){Q.height=J}Q.charOffsetX[H]=1;Q.charAdvance[H]=$+2;{let N=0;for(let U=J/7|0;U<J;U++){N+=Q.charMask[H][U*$]}if(N<=(J/7|0)){Q.charAdvance[H]--;Q.charOffsetX[H]=0}}{let N=0;for(let U=J/7|0;U<J;U++){N+=Q.charMask[H][$+U*$-1]}if(N<=(J/7|0)){Q.charAdvance[H]--}}}Q.charAdvance[94]=Q.charAdvance[8];for(let H=0;H<256;H++){Q.drawWidth[H]=Q.charAdvance[y0.CHARCODESET[H]]}return Q};drawString(_,R,L,G){if(!L){return}_|=0;R|=0;const K=L.length;R-=this.height;for(let Q=0;Q<K;Q++){const H=y0.CHARCODESET[L.charCodeAt(Q)];if(H!==94){this.drawChar(this.charMask[H],_+this.charOffsetX[H],R+this.charOffsetY[H],this.charMaskWidth[H],this.charMaskHeight[H],G)}_+=this.charAdvance[H]}}drawStringTaggable(_,R,L,G,K){_|=0;R|=0;const Q=L.length;R-=this.height;for(let H=0;H<Q;H++){if(L.charAt(H)==="@"&&H+4<Q&&L.charAt(H+4)==="@"){G=this.evaluateTag(L.substring(H+1,H+4));H+=4}else{const $=y0.CHARCODESET[L.charCodeAt(H)];if($!==94){if(K){this.drawChar(this.charMask[$],_+this.charOffsetX[$]+1,R+this.charOffsetY[$]+1,this.charMaskWidth[$],this.charMaskHeight[$],X.BLACK)}this.drawChar(this.charMask[$],_+this.charOffsetX[$],R+this.charOffsetY[$],this.charMaskWidth[$],this.charMaskHeight[$],G)}_+=this.charAdvance[$]}}}stringWidth(_){if(!_){return 0}const R=_.length;let L=0;for(let G=0;G<R;G++){if(_.charAt(G)==="@"&&G+4<R&&_.charAt(G+4)==="@"){G+=4}else{L+=this.drawWidth[_.charCodeAt(G)]}}return L}drawStringTaggableCenter(_,R,L,G,K){_|=0;R|=0;this.drawStringTaggable(_-this.stringWidth(L)/2,R,L,G,K)}drawStringCenter(_,R,L,G){if(!L){return}_|=0;R|=0;this.drawString(_-this.stringWidth(L)/2,R,L,G)}drawStringTooltip(_,R,L,G,K,Q){_|=0;R|=0;this.random.setSeed(BigInt(Q));const H=(this.random.nextInt()&31)+192;const $=R-this.height;for(let J=0;J<L.length;J++){if(L.charAt(J)==="@"&&J+4<L.length&&L.charAt(J+4)==="@"){G=this.evaluateTag(L.substring(J+1,J+4));J+=4}else{const O=y0.CHARCODESET[L.charCodeAt(J)];if(O!==94){if(K){this.drawCharAlpha(_+this.charOffsetX[O]+1,$+this.charOffsetY[O]+1,this.charMaskWidth[O],this.charMaskHeight[O],X.BLACK,192,this.charMask[O])}this.drawCharAlpha(_+this.charOffsetX[O],$+this.charOffsetY[O],this.charMaskWidth[O],this.charMaskHeight[O],G,H,this.charMask[O])}_+=this.charAdvance[O];if((this.random.nextInt()&3)===0){_++}}}}drawStringRight(_,R,L,G,K=true){_|=0;R|=0;if(K){this.drawString(_-this.stringWidth(L)+1,R+1,L,X.BLACK)}this.drawString(_-this.stringWidth(L),R,L,G)}drawCenteredWave(_,R,L,G,K){if(!L){return}_|=0;R|=0;_-=this.stringWidth(L)/2|0;const Q=R-this.height;for(let H=0;H<L.length;H++){const $=y0.CHARCODESET[L.charCodeAt(H)];if($!=94){this.drawChar(this.charMask[$],_+this.charOffsetX[$],Q+this.charOffsetY[$]+(Math.sin(H/2+K/5)*5|0),this.charMaskWidth[$],this.charMaskHeight[$],G)}_+=this.charAdvance[$]}}drawChar(_,R,L,G,K,Q){R|=0;L|=0;G|=0;K|=0;let H=R+L*k.width2d;let $=k.width2d-G;let J=0;let O=0;if(L<k.top){const q=k.top-L;K-=q;L=k.top;O+=q*G;H+=q*k.width2d}if(L+K>=k.bottom){K-=L+K+1-k.bottom}if(R<k.left){const q=k.left-R;G-=q;R=k.left;O+=q;H+=q;J+=q;$+=q}if(R+G>=k.right){const q=R+G+1-k.right;G-=q;J+=q;$+=q}if(G>0&&K>0){this.drawMask(G,K,_,O,J,k.pixels,H,$,Q)}}drawCharAlpha(_,R,L,G,K,Q,H){_|=0;R|=0;L|=0;G|=0;let $=_+R*k.width2d;let J=k.width2d-L;let O=0;let q=0;if(R<k.top){const N=k.top-R;G-=N;R=k.top;q+=N*L;$+=N*k.width2d}if(R+G>=k.bottom){G-=R+G+1-k.bottom}if(_<k.left){const N=k.left-_;L-=N;_=k.left;q+=N;$+=N;O+=N;J+=N}if(_+L>=k.right){const N=_+L+1-k.right;L-=N;O+=N;J+=N}if(L>0&&G>0){this.drawMaskAlpha(L,G,k.pixels,$,J,H,q,O,K,Q)}}drawMask(_,R,L,G,K,Q,H,$,J){_|=0;R|=0;const O=-(_>>2);_=-(_&3);for(let q=-R;q<0;q++){for(let N=O;N<0;N++){if(L[G++]===0){H++}else{Q[H++]=J}if(L[G++]===0){H++}else{Q[H++]=J}if(L[G++]===0){H++}else{Q[H++]=J}if(L[G++]===0){H++}else{Q[H++]=J}}for(let N=_;N<0;N++){if(L[G++]===0){H++}else{Q[H++]=J}}H+=$;G+=K}}drawMaskAlpha(_,R,L,G,K,Q,H,$,J,O){_|=0;R|=0;const q=((J&16711935)*O&4278255360)+((J&65280)*O&16711680)>>8;const N=256-O;for(let U=-R;U<0;U++){for(let b=-_;b<0;b++){if(Q[H++]===0){G++}else{const I=L[G];L[G++]=(((I&16711935)*N&4278255360)+((I&65280)*N&16711680)>>8)+q}}G+=K;H+=$}}evaluateTag(_){if(_==="red"){return X.RED}else if(_==="gre"){return X.GREEN}else if(_==="blu"){return X.BLUE}else if(_==="yel"){return X.YELLOW}else if(_==="cya"){return X.CYAN}else if(_==="mag"){return X.MAGENTA}else if(_==="whi"){return X.WHITE}else if(_==="bla"){return X.BLACK}else if(_==="lre"){return X.LIGHTRED}else if(_==="dre"){return X.DARKRED}else if(_==="dbl"){return X.DARKBLUE}else if(_==="or1"){return X.ORANGE1}else if(_==="or2"){return X.ORANGE2}else if(_==="or3"){return X.ORANGE3}else if(_==="gr1"){return X.GREEN1}else if(_==="gr2"){return X.GREEN2}else if(_==="gr3"){return X.GREEN3}else{return X.BLACK}}split(_,R){if(_.length===0){return[_]}const L=[];while(_.length>0){const G=this.stringWidth(_);if(G<=R&&_.indexOf("|")===-1){L.push(_);break}let K=_.length;for(let Q=0;Q<_.length;Q++){if(_[Q]===" "){const H=this.stringWidth(_.substring(0,Q));if(H>R){break}K=Q}else if(_[Q]==="|"){K=Q;break}}L.push(_.substring(0,K));_=_.substring(K+1)}return L}}var M5=(()=>{var _=import.meta.url;return async function(R={}){var L;var G=R;var K,Q;var H=new Promise((W,Z)=>{K=W;Q=Z});var $=typeof window=="object";var J=typeof WorkerGlobalScope!="undefined";var O=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";var q=!$&&!O&&!J;var N=Object.assign({},G);var U=[];var b="./this.program";var I=(W,Z)=>{throw Z};var j="";function F(W){if(G["locateFile"]){return G["locateFile"](W,j)}return j+W}var T,Y;if(O){if(typeof process=="undefined"||!process.release||process.release.name!=="node")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");var u=process.versions.node;var w=u.split(".").slice(0,3);w=w[0]*1e4+w[1]*100+w[2].split("-")[0]*1;var h=160000;if(w<160000){throw new Error("This emscripten-generated code requires node v16.0.0 (detected v"+u+")")}var v=(()=>({}));var n=(u5(),I8(Z5));if(!import.meta.url.startsWith("data:")){j=n.dirname((m5(),I8(h5)).fileURLToPath(import.meta.url))+"/"}Y=(W)=>{W=Q1(W)?new URL(W):W;var Z=v.readFileSync(W);i(Buffer.isBuffer(Z));return Z};T=async(W,Z=true)=>{W=Q1(W)?new URL(W):W;var D=v.readFileSync(W,Z?undefined:"utf8");i(Z?Buffer.isBuffer(D):typeof D=="string");return D};if(!G["thisProgram"]&&process.argv.length>1){b=process.argv[1].replace(/\\/g,"/")}U=process.argv.slice(2);I=(W,Z)=>{process.exitCode=W;throw Z}}else if(q){if(typeof process=="object"&&true||typeof window=="object"||typeof WorkerGlobalScope!="undefined")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)")}else if($||J){if(J){j=self.location.href}else if(typeof document!="undefined"&&document.currentScript){j=document.currentScript.src}if(_){j=_}if(j.startsWith("blob:")){j=""}else{j=j.substr(0,j.replace(/[?#].*/,"").lastIndexOf("/")+1)}if(!(typeof window=="object"||typeof WorkerGlobalScope!="undefined"))throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");{if(J){Y=(W)=>{var Z=new XMLHttpRequest;Z.open("GET",W,false);Z.responseType="arraybuffer";Z.send(null);return new Uint8Array(Z.response)}}T=async(W)=>{if(Q1(W)){return new Promise((D,o)=>{var K0=new XMLHttpRequest;K0.open("GET",W,true);K0.responseType="arraybuffer";K0.onload=()=>{if(K0.status==200||K0.status==0&&K0.response){D(K0.response);return}o(K0.status)};K0.onerror=o;K0.send(null)})}var Z=await fetch(W,{credentials:"same-origin"});if(Z.ok){return Z.arrayBuffer()}throw new Error(Z.status+" : "+Z.url)}}}else{throw new Error("environment detection error")}var A=G["print"]||undefined;var P=G["printErr"]||undefined;Object.assign(G,N);N=null;s5();if(G["arguments"])U=G["arguments"];a0("arguments","arguments_");if(G["thisProgram"])b=G["thisProgram"];a0("thisProgram","thisProgram");i(typeof G["memoryInitializerPrefixURL"]=="undefined","Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead");i(typeof G["pthreadMainPrefixURL"]=="undefined","Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead");i(typeof G["cdInitializerPrefixURL"]=="undefined","Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead");i(typeof G["filePackagePrefixURL"]=="undefined","Module.filePackagePrefixURL option was removed, use Module.locateFile instead");i(typeof G["read"]=="undefined","Module.read option was removed");i(typeof G["readAsync"]=="undefined","Module.readAsync option was removed (modify readAsync in JS)");i(typeof G["readBinary"]=="undefined","Module.readBinary option was removed (modify readBinary in JS)");i(typeof G["setWindowTitle"]=="undefined","Module.setWindowTitle option was removed (modify emscripten_set_window_title in JS)");i(typeof G["TOTAL_MEMORY"]=="undefined","Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY");a0("asm","wasmExports");a0("readAsync","readAsync");a0("readBinary","readBinary");a0("setWindowTitle","setWindowTitle");var z="IDBFS is no longer included by default; build with -lidbfs.js";var f="PROXYFS is no longer included by default; build with -lproxyfs.js";var m="WORKERFS is no longer included by default; build with -lworkerfs.js";var M="FETCHFS is no longer included by default; build with -lfetchfs.js";var r="ICASEFS is no longer included by default; build with -licasefs.js";var a="JSFILEFS is no longer included by default; build with -ljsfilefs.js";var C="OPFS is no longer included by default; build with -lopfs.js";var R0="NODEFS is no longer included by default; build with -lnodefs.js";i(!q,"shell environment detected but not enabled at build time.  Add `shell` to `-sENVIRONMENT` to enable.");var e=G["wasmBinary"];a0("wasmBinary","wasmBinary");if(typeof WebAssembly!="object"){P("no native wasm support detected")}var L0;var J0=false;var Q0;function i(W,Z){if(!W){m0("Assertion failed"+(Z?": "+Z:""))}}var k0,$0,F0,T0,L1,N1,P0,V1,Y1,g8,Z1;var u1=false;var f8="data:application/octet-stream;base64,";var f1=(W)=>W.startsWith(f8);var Q1=(W)=>W.startsWith("file://");function C8(){var W=T5();i((W&3)==0);if(W==0){W+=4}P0[W>>2]=34821223;P0[W+4>>2]=2310721022;P0[0>>2]=1668509029}function w1(){if(J0)return;var W=T5();if(W==0){W+=4}var Z=P0[W>>2];var D=P0[W+4>>2];if(Z!=34821223||D!=2310721022){m0(`Stack overflow! Stack cookie has been overwritten at ${b1(W)}, expected hex dwords 0x89BACDFE and 0x2135467, but received ${b1(D)} ${b1(Z)}`)}if(P0[0>>2]!=1668509029){m0("Runtime error: The application has corrupted its heap memory area (address zero)!")}}(()=>{var W=new Int16Array(1);var Z=new Int8Array(W.buffer);W[0]=25459;if(Z[0]!==115||Z[1]!==99)throw"Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)"})();if(G["ENVIRONMENT"]){throw new Error("Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)")}function a0(W,Z,D=true){if(!Object.getOwnPropertyDescriptor(G,W)){Object.defineProperty(G,W,{configurable:true,get(){let o=D?" (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)":"";m0(`\`Module.${W}\` has been replaced by \`${Z}\``+o)}})}}function n8(W){if(Object.getOwnPropertyDescriptor(G,W)){m0(`\`Module.${W}\` was supplied but \`${W}\` not included in INCOMING_MODULE_JS_API`)}}function C1(W){return W==="FS_createPath"||W==="FS_createDataFile"||W==="FS_createPreloadedFile"||W==="FS_unlink"||W==="addRunDependency"||W==="FS_createLazyFile"||W==="FS_createDevice"||W==="removeRunDependency"}function n1(W,Z){if(typeof globalThis!="undefined"&&!Object.getOwnPropertyDescriptor(globalThis,W)){Object.defineProperty(globalThis,W,{configurable:true,get(){Z();return}})}}function s1(W,Z){n1(W,()=>{C0(`\`${W}\` is not longer defined by emscripten. ${Z}`)})}s1("buffer","Please use HEAP8.buffer or wasmMemory.buffer");s1("asm","Please use wasmExports instead");function s8(W){n1(W,()=>{var Z=`\`${W}\` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line`;var D=W;if(!D.startsWith("_")){D="$"+W}Z+=` (e.g. -sDEFAULT_LIBRARY_FUNCS_TO_INCLUDE='${D}')`;if(C1(W)){Z+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"}C0(Z)});p1(W)}function p1(W){if(!Object.getOwnPropertyDescriptor(G,W)){Object.defineProperty(G,W,{configurable:true,get(){var Z=`'${W}' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the Emscripten FAQ)`;if(C1(W)){Z+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"}m0(Z)}})}}function W6(...W){}function y1(){var W=L0.buffer;G["HEAP8"]=$0=new Int8Array(W);G["HEAP16"]=T0=new Int16Array(W);G["HEAPU8"]=F0=new Uint8Array(W);G["HEAPU16"]=L1=new Uint16Array(W);G["HEAP32"]=N1=new Int32Array(W);G["HEAPU32"]=P0=new Uint32Array(W);G["HEAPF32"]=V1=new Float32Array(W);G["HEAPF64"]=Z1=new Float64Array(W);G["HEAP64"]=Y1=new BigInt64Array(W);G["HEAPU64"]=g8=new BigUint64Array(W)}i(!G["STACK_SIZE"],"STACK_SIZE can no longer be set at runtime.  Use -sSTACK_SIZE at link time");i(typeof Int32Array!="undefined"&&typeof Float64Array!=="undefined"&&Int32Array.prototype.subarray!=null&&Int32Array.prototype.set!=null,"JS engine does not provide full typed array support");i(!G["wasmMemory"],"Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally");i(!G["INITIAL_MEMORY"],"Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically");var r1=[];var x1=[];var A6=[];var i1=[];function p8(){if(G["preRun"]){if(typeof G["preRun"]=="function")G["preRun"]=[G["preRun"]];while(G["preRun"].length){x8(G["preRun"].shift())}}X1(r1)}function y8(){i(!u1);u1=true;w1();X1(x1)}function r8(){w1();if(G["postRun"]){if(typeof G["postRun"]=="function")G["postRun"]=[G["postRun"]];while(G["postRun"].length){a8(G["postRun"].shift())}}X1(i1)}function x8(W){r1.unshift(W)}function i8(W){x1.unshift(W)}function B6(W){}function a8(W){i1.unshift(W)}var c0=0;var H1=null;var o0={};var d0=null;function h6(W){var Z=W;while(true){if(!o0[W])return W;W=Z+Math.random()}}function c8(W){c0++;G["monitorRunDependencies"]?.(c0);if(W){i(!o0[W]);o0[W]=1;if(d0===null&&typeof setInterval!="undefined"){d0=setInterval(()=>{if(J0){clearInterval(d0);d0=null;return}var Z=false;for(var D in o0){if(!Z){Z=true;P("still waiting on run dependencies:")}P(`dependency: ${D}`)}if(Z){P("(end of list)")}},1e4)}}else{P("warning: run dependency added without ID")}}function d8(W){c0--;G["monitorRunDependencies"]?.(c0);if(W){i(o0[W]);delete o0[W]}else{P("warning: run dependency removed without ID")}if(c0==0){if(d0!==null){clearInterval(d0);d0=null}if(H1){var Z=H1;H1=null;Z()}}}function m0(W){G["onAbort"]?.(W);W="Aborted("+W+")";P(W);J0=true;var Z=new WebAssembly.RuntimeError(W);Q(Z);throw Z}var z0={error(){m0("Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM")},init(){z0.error()},createDataFile(){z0.error()},createPreloadedFile(){z0.error()},createLazyFile(){z0.error()},open(){z0.error()},mkdev(){z0.error()},registerDevice(){z0.error()},analyzePath(){z0.error()},ErrnoError(){z0.error()}};G["FS_createDataFile"]=z0.createDataFile;G["FS_createPreloadedFile"]=z0.createPreloadedFile;function M0(W,Z){return(...D)=>{i(u1,`native function \`${W}\` called before runtime initialization`);var o=l0[W];i(o,`exported native function \`${W}\` not found`);i(D.length<=Z,`native function \`${W}\` called with ${D.length} args but expects ${Z}`);return o(...D)}}var $1;function t8(){if(G["locateFile"]){var W="bzip2.wasm";if(!f1(W)){return F(W)}return W}return new URL("bzip2.wasm",import.meta.url).href}function o8(W){if(W==$1&&e){return new Uint8Array(e)}if(Y){return Y(W)}throw"both async and sync fetching of the wasm failed"}async function l8(W){if(!e){try{var Z=await T(W);return new Uint8Array(Z)}catch{}}return o8(W)}async function e8(W,Z){try{var D=await l8(W);var o=await WebAssembly.instantiate(D,Z);return o}catch(K0){P(`failed to asynchronously prepare wasm: ${K0}`);if(Q1($1)){P(`warning: Loading from a file URI (${$1}) is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing`)}m0(K0)}}async function _5(W,Z,D){if(!W&&typeof WebAssembly.instantiateStreaming=="function"&&!f1(Z)&&!Q1(Z)&&!O){try{var o=fetch(Z,{credentials:"same-origin"});var K0=await WebAssembly.instantiateStreaming(o,D);return K0}catch(O0){P(`wasm streaming compile failed: ${O0}`);P("falling back to ArrayBuffer instantiation")}}return e8(Z,D)}function R5(){return{env:F5,wasi_snapshot_preview1:F5}}async function L5(){function W(N0,j0){l0=N0.exports;L0=l0["memory"];i(L0,"memory not found in wasm exports");y1();i8(l0["__wasm_call_ctors"]);d8("wasm-instantiate");return l0}c8("wasm-instantiate");var Z=G;function D(N0){i(G===Z,"the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?");Z=null;return W(N0["instance"])}var o=R5();if(G["instantiateWasm"]){try{return G["instantiateWasm"](o,W)}catch(N0){P(`Module.instantiateWasm callback failed with error: ${N0}`);Q(N0)}}$1??=t8();try{var K0=await _5(e,$1,o);var O0=D(K0);return O0}catch(N0){Q(N0);return Promise.reject(N0)}}class J8{name="ExitStatus";constructor(W){this.message=`Program terminated with exit(${W})`;this.status=W}}var X1=(W)=>{while(W.length>0){W.shift()(G)}};function G5(W,Z="i8"){if(Z.endsWith("*"))Z="*";switch(Z){case"i1":return $0[W];case"i8":return $0[W];case"i16":return T0[W>>1];case"i32":return N1[W>>2];case"i64":return Y1[W>>3];case"float":return V1[W>>2];case"double":return Z1[W>>3];case"*":return P0[W>>2];default:m0(`invalid type for getValue: ${Z}`)}}var v5=G["noExitRuntime"]||true;var b1=(W)=>{i(typeof W==="number");W>>>=0;return"0x"+W.toString(16).padStart(8,"0")};function K5(W,Z,D="i8"){if(D.endsWith("*"))D="*";switch(D){case"i1":$0[W]=Z;break;case"i8":$0[W]=Z;break;case"i16":T0[W>>1]=Z;break;case"i32":N1[W>>2]=Z;break;case"i64":Y1[W>>3]=BigInt(Z);break;case"float":V1[W>>2]=Z;break;case"double":Z1[W>>3]=Z;break;case"*":P0[W>>2]=Z;break;default:m0(`invalid type for setValue: ${D}`)}}var m6=(W)=>N8(W);var S6=()=>a5();var C0=(W)=>{C0.shown||={};if(!C0.shown[W]){C0.shown[W]=1;if(O)W="warning: "+W;P(W)}};var Q5=()=>m0("native code called abort()");var H5=()=>2147483648;var $5=(W,Z)=>{i(Z,"alignment argument is required");return Math.ceil(W/Z)*Z};var J5=(W)=>{var Z=L0.buffer;var D=(W-Z.byteLength+65535)/65536|0;try{L0.grow(D);y1();return 1}catch(o){P(`growMemory: Attempted to grow heap from ${Z.byteLength} bytes to ${W} bytes, but got error: ${o}`)}};var O5=(W)=>{var Z=F0.length;W>>>=0;i(W>Z);var D=H5();if(W>D){P(`Cannot enlarge memory, requested ${W} bytes, but the limit is ${D} bytes!`);return false}for(var o=1;o<=4;o*=2){var K0=Z*(1+0.2/o);K0=Math.min(K0,W+100663296);var O0=Math.min(D,$5(Math.max(W,K0),65536));var N0=J5(O0);if(N0){return true}}P(`Failed to grow the heap from ${Z} bytes to ${O0} bytes, not enough memory!`);return false};var a1=0;var c1=()=>v5||a1>0;var q5=(W)=>{Q0=W;if(!c1()){G["onExit"]?.(W);J0=true}I(W,new J8(W))};var g5=(W,Z)=>{Q0=W;l1();if(c1()&&!Z){var D=`program exited (with status: ${W}), but keepRuntimeAlive() is set (counter=${a1}) due to an async operation, so halting execution but not exiting the runtime or preventing further async execution (you can use emscripten_force_exit, if you want to force a true shutdown)`;Q(D);P(D)}q5(W)};var N5=g5;var O8=typeof TextDecoder!="undefined"?new TextDecoder:undefined;var q8=(W,Z=0,D=NaN)=>{var o=Z+D;var K0=Z;while(W[K0]&&!(K0>=o))++K0;if(K0-Z>16&&W.buffer&&O8){return O8.decode(W.subarray(Z,K0))}var O0="";while(Z<K0){var N0=W[Z++];if(!(N0&128)){O0+=String.fromCharCode(N0);continue}var j0=W[Z++]&63;if((N0&224)==192){O0+=String.fromCharCode((N0&31)<<6|j0);continue}var t0=W[Z++]&63;if((N0&240)==224){N0=(N0&15)<<12|j0<<6|t0}else{if((N0&248)!=240)C0("Invalid UTF-8 leading byte "+b1(N0)+" encountered when deserializing a UTF-8 string in wasm memory to a JS string!");N0=(N0&7)<<18|j0<<12|t0<<6|W[Z++]&63}if(N0<65536){O0+=String.fromCharCode(N0)}else{var U1=N0-65536;O0+=String.fromCharCode(55296|U1>>10,56320|U1&1023)}}return O0};var b5=(W,Z)=>{i(typeof W=="number",`UTF8ToString expects a number (got ${typeof W})`);return W?q8(F0,W,Z):""};var f5={varargs:undefined,getStr(W){var Z=b5(W);return Z}};var d1=(W)=>{m0("fd_close called without SYSCALLS_REQUIRE_FILESYSTEM")};var t1=9007199254740992;var U5=-9007199254740992;var I5=(W)=>W<U5||W>t1?NaN:Number(W);function E5(W,Z,D,o){Z=I5(Z);return 70}var S1=[null,[],[]];var r0=(W,Z)=>{var D=S1[W];i(D);if(Z===0||Z===10){(W===1?A:P)(q8(D));D.length=0}else{D.push(Z)}};var C5=()=>{p5(0);if(S1[1].length)r0(1,10);if(S1[2].length)r0(2,10)};var n5=(W,Z,D,o)=>{var K0=0;for(var O0=0;O0<D;O0++){var N0=P0[Z>>2];var j0=P0[Z+4>>2];Z+=8;for(var t0=0;t0<j0;t0++){r0(W,F0[N0+t0])}K0+=j0}P0[o>>2]=K0;return 0};function s5(){n8("fetchSettings")}var F5={_abort_js:Q5,emscripten_resize_heap:O5,exit:N5,fd_close:d1,fd_seek:E5,fd_write:n5};var l0=await L5();var P6=M0("__wasm_call_ctors",0);var z6=G["_malloc"]=M0("malloc",1);var D6=G["_free"]=M0("free",1);var p5=M0("fflush",1);var M6=G["_BZ2_bzBuffToBuffCompress"]=M0("BZ2_bzBuffToBuffCompress",7);var v6=G["_BZ2_bzBuffToBuffDecompress"]=M0("BZ2_bzBuffToBuffDecompress",6);var y5=M0("strerror",1);var r5=l0["emscripten_stack_init"];var x5=l0["emscripten_stack_get_free"];var g6=l0["emscripten_stack_get_base"];var T5=l0["emscripten_stack_get_end"];var N8=l0["_emscripten_stack_restore"];var i5=l0["_emscripten_stack_alloc"];var a5=l0["emscripten_stack_get_current"];G["setValue"]=K5;G["getValue"]=G5;var j5=["writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","stackAlloc","getTempRet0","setTempRet0","zeroMemory","strError","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","emscriptenLog","readEmAsmArgs","jstoi_q","getExecutableName","listenOnce","autoResumeAudioContext","getDynCaller","dynCall","handleException","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","asmjsMangle","asyncLoad","mmapAlloc","HandleAllocator","getNativeTypeSize","STACK_SIZE","STACK_ALIGN","POINTER_SIZE","ASSERTIONS","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","generateFuncType","convertJsFunctionToWasm","getEmptyTableSlot","updateTableMap","getFunctionAddress","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","stringToUTF8Array","stringToUTF8","lengthBytesUTF8","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","stringToNewUTF8","stringToUTF8OnStack","writeArrayToMemory","registerKeyEventCallback","maybeCStringToJsString","findEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","jsStackTrace","getCallstack","convertPCtoSourceLocation","getEnvStrings","checkWasiClock","wasiRightsToMuslOFlags","wasiOFlagsToMuslOFlags","initRandomFill","randomFill","safeSetTimeout","setImmediateWrapped","safeRequestAnimationFrame","clearImmediateWrapped","registerPostMainLoop","registerPreMainLoop","getPromise","makePromise","idsToPromises","makePromiseCallback","ExceptionInfo","findMatchingCatch","Browser_asyncPrepareDataCounter","isLeapYear","ydayFromDate","arraySum","addDays","getSocketFromFD","getSocketAddress","FS_createPreloadedFile","FS_modeStringToFlags","FS_getMode","FS_stdin_getChar","FS_unlink","FS_createDataFile","FS_mkdirTree","_setNetworkCallback","heapObjectForWebGLType","toTypedArrayIndex","webgl_enable_ANGLE_instanced_arrays","webgl_enable_OES_vertex_array_object","webgl_enable_WEBGL_draw_buffers","webgl_enable_WEBGL_multi_draw","webgl_enable_EXT_polygon_offset_clamp","webgl_enable_EXT_clip_control","webgl_enable_WEBGL_polygon_mode","emscriptenWebGLGet","computeUnpackAlignedImageSize","colorChannelsInGlTextureFormat","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","__glGetActiveAttribOrUniform","writeGLArray","registerWebGlEventCallback","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate","writeStringToMemory","writeAsciiToMemory","setErrNo","demangle","stackTrace"];j5.forEach(s8);var k5=["run","addOnPreRun","addOnInit","addOnPreMain","addOnExit","addOnPostRun","addRunDependency","removeRunDependency","out","err","callMain","abort","wasmMemory","wasmExports","writeStackCookie","checkStackCookie","INT53_MAX","INT53_MIN","bigintToI53Checked","stackSave","stackRestore","ptrToString","exitJS","getHeapMax","growMemory","ENV","ERRNO_CODES","DNS","Protocols","Sockets","timers","warnOnce","readEmAsmArgsArray","jstoi_s","keepRuntimeAlive","alignMemory","wasmTable","noExitRuntime","freeTableIndexes","functionsInTableMap","PATH","PATH_FS","UTF8Decoder","UTF8ArrayToString","UTF8ToString","UTF16Decoder","JSEvents","specialHTMLTargets","findCanvasEventTarget","currentFullscreenStrategy","restoreOldWindowedStyle","UNWIND_CACHE","ExitStatus","flush_NO_FILESYSTEM","emSetImmediate","emClearImmediate_deps","emClearImmediate","promiseMap","uncaughtExceptionCount","exceptionLast","exceptionCaught","Browser","getPreloadedImageData__data","wget","MONTH_DAYS_REGULAR","MONTH_DAYS_LEAP","MONTH_DAYS_REGULAR_CUMULATIVE","MONTH_DAYS_LEAP_CUMULATIVE","SYSCALLS","preloadPlugins","FS_stdin_getChar_buffer","FS_createPath","FS_createDevice","FS_readFile","FS","FS_createLazyFile","MEMFS","TTY","PIPEFS","SOCKFS","tempFixedLengthArray","miniTempWebGLFloatBuffers","miniTempWebGLIntBuffers","GL","AL","GLUT","EGL","GLEW","IDBStore","SDL","SDL_gfx","allocateUTF8","allocateUTF8OnStack","print","printErr"];k5.forEach(p1);var b8;function U8(){r5();C8()}function o1(){if(c0>0){H1=o1;return}U8();p8();if(c0>0){H1=o1;return}function W(){i(!b8);b8=true;G["calledRun"]=true;if(J0)return;y8();K(G);G["onRuntimeInitialized"]?.();i(!G["_main"],'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]');r8()}if(G["setStatus"]){G["setStatus"]("Running...");setTimeout(()=>{setTimeout(()=>G["setStatus"](""),1);W()},1)}else{W()}w1()}function l1(){var W=A;var Z=P;var D=false;A=P=(o)=>{D=true};try{C5()}catch(o){}A=W;P=Z;if(D){C0("stdio streams had content in them that was not flushed. you should set EXIT_RUNTIME to 1 (see the Emscripten FAQ), or make sure to emit a newline when you printf etc.");C0("(this may also be due to not including full filesystem support - try building with -sFORCE_FILESYSTEM)")}}if(G["preInit"]){if(typeof G["preInit"]=="function")G["preInit"]=[G["preInit"]];while(G["preInit"].length>0){G["preInit"].pop()()}}o1();L=H;for(const W of Object.keys(G)){if(!(W in R)){Object.defineProperty(R,W,{configurable:true,get(){m0(`Access to module property ('${W}') is no longer possible via the module constructor argument; Instead, use the result of the module constructor.`)}})}}return L}})();(()=>{var _=M5;M5=function(R){if(new.target)throw new Error("loadBZip2WASM() should not be called with `new loadBZip2WASM()`");return _(R)}})();var k6=M5;var Y_={"-2":"BZ_PARAM_ERROR: incorrect parameters","-3":"BZ_MEM_ERROR: couldn't allocate enough memory","-4":"BZ_DATA_ERROR: data integrity error when decompressing","-5":"BZ_DATA_ERROR_MAGIC: compressed data has incorrect header","-7":"BZ_UNEXPECTED_EOF: compressed data ends too early","-8":"BZ_OUTBUFF_FULL: destination buffer is full"};class V6{constructor(){this.wasmModule=undefined}async init(){if(this.wasmModule){return}this.wasmModule=await k6()}ensureInitialized(){if(!this.wasmModule){throw new Error(`${this.constructor.name} not initalized. call .init()`)}}handleError(_,R,L){if(_===0){return}this.wasmModule._free(R);this.wasmModule._free(L);const G=Y_[_];if(G){throw new Error(G)}throw new Error(`error code: ${_}`)}createWASMBuffers(_,R){const{_malloc:L,setValue:G,HEAPU8:K}=this.wasmModule;const Q=L(_.length);K.set(_,Q);const H=L(R);const $=L(R);G($,R,"i32");return{sourcePtr:Q,destPtr:H,destLengthPtr:$}}createBuffer(_,R){const{_free:L,getValue:G,HEAPU8:K}=this.wasmModule;const Q=G(R,"i32");const H=new Uint8Array(Q);H.set(K.subarray(_,_+Q));L(_);L(R);return H}decompress(_,R,L=false,G=false){if(G){R=_[0]<<24|_[1]<<16|_[2]<<8|_[3];_[0]=66;_[1]=90;_[2]=104;_[3]=49;L=false}if(L){const J=new Uint8Array(_.length+4);J[0]=66;J[1]=90;J[2]=104;J[3]=49;J.set(_,4);_=J}this.ensureInitialized();const{sourcePtr:K,destPtr:Q,destLengthPtr:H}=this.createWASMBuffers(_,R);const $=this.wasmModule._BZ2_bzBuffToBuffDecompress(Q,H,K,_.length,0,0);this.wasmModule._free(K);this.handleError($,Q,H);return this.createBuffer(Q,H)}compress(_,R=false,L=false,G=1,K=0){this.ensureInitialized();if(!K){K=_.length}if(K<128){K=128}if(G<=0||G>9){throw new RangeError("blockSize should be between 1-9")}const{sourcePtr:Q,destPtr:H,destLengthPtr:$}=this.createWASMBuffers(_,K);const J=this.wasmModule._BZ2_bzBuffToBuffCompress(H,$,Q,_.length,G,0,30);this.wasmModule._free(Q);this.handleError(J,H,$);const O=this.createBuffer(H,$);if(R){O[0]=_.length>>24&255;O[1]=_.length>>16&255;O[2]=_.length>>8&255;O[3]=_.length&255}if(L){return O.subarray(4)}return O}}var Y6=V6;var Z6=new Y6;await Z6.init();var h1=Z6;class Q8{socket;wsin;wsout;closed=false;ioerror=false;static openSocket=async(_)=>{return await new Promise((R,L)=>{const G=_.host.startsWith("https");const K=G?"wss":"ws";const Q=_.host.substring(_.host.indexOf("//")+2);const H=G?_.port+2:_.port+1;const $=new WebSocket(`${K}://${Q}:${H}`,"binary");$.addEventListener("open",()=>{R($)});$.addEventListener("error",()=>{L($)})})};constructor(_){_.onclose=this.onclose;_.onerror=this.onerror;this.wsin=new X6(_,5000);this.wsout=new u6(_,5000);this.socket=_}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(_,R){this.wsout.write(_,R)}async read(){return this.closed?0:this.wsin.fastByte()??await this.wsin.slowByte()}async readBytes(_,R,L){if(this.closed){return}while(L>0){const G=this.wsin.fastBytes(_,R,L)??await this.wsin.slowBytes(_,R,L);if(G.length<=0){throw new Error("EOF")}R+=G.length;L-=G.length}}close(){this.closed=true;this.socket.close();this.wsin.close();this.wsout.close()}onclose=(_)=>{if(this.closed){return}this.close()};onerror=(_)=>{if(this.closed){return}this.ioerror=true;this.close()}}class u6{socket;limit;closed=false;ioerror=false;constructor(_,R){this.socket=_;this.limit=R}write(_,R){if(this.closed){return}if(this.ioerror){this.ioerror=false;throw new Error("Error in writer thread")}if(R>this.limit||_.length>this.limit){throw new Error("buffer overflow")}try{this.socket.send(_.subarray(0,R))}catch(L){this.ioerror=true}}close(){this.closed=true}}class w6 extends D0{bytes;position;constructor(_){super();this.bytes=_;this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class X6{limit;queue=new g0;event=null;callback=null;total=0;closed=false;constructor(_,R){this.limit=R;_.binaryType="arraybuffer";_.onmessage=this.onmessage}get available(){return this.total}onmessage=(_)=>{if(this.closed){throw new Error("WebSocketReader is closed!")}const R=new w6(new Uint8Array(_.data));if(this.event){this.queue.addTail(R)}else{this.event=R}this.total+=R.len;if(!this.callback){return}this.callback(this.event);this.callback=null;if(this.total>this.limit){throw new Error("buffer overflow")}};readFastByte(){if(this.event&&this.event.available>0){return this.event.read}return null}async readSlowByte(_){this.event=this.queue.removeHead();while(this.total<_){await Promise.race([new Promise((R)=>this.callback=R),q1(2000).then(()=>{if(this.closed){throw new Error("WebSocketReader closed while reading.")}})])}return this.event?this.event.read:this.readSlowByte(_)}fastBytes(_,R,L){if(this.closed){throw new Error("WebSocketReader is closed!")}if(!(this.event&&this.event.available>=L)){return null}while(L>0){const G=this.readFastByte();if(G===null){throw new Error("EOF - tried to read a fast byte when there was not enough immediate bytes.")}_[R++]=G;this.total--;L--}return _}async slowBytes(_,R,L){if(this.closed){throw new Error("WebSocketReader is closed!")}while(L>0){_[R++]=this.readFastByte()??await this.readSlowByte(L);this.total--;L--}return _}fastByte(){if(this.closed){throw new Error("WebSocketReader is closed!")}const _=this.readFastByte();if(_===null){return null}this.total--;return _}async slowByte(){if(this.closed){throw new Error("WebSocketReader is closed!")}const _=await this.readSlowByte(1);this.total--;return _}close(){this.closed=true;this.callback=null;this.total=0;this.event=null;this.queue.clear()}}class c{static REBUILD_GETMAPS=150;static NO_TIMEOUT=108;static IDLE_TIMER=70;static EVENT_TRACKING=81;static EVENT_CAMERA_POSITION=189;static ANTICHEAT_OPLOGIC1=7;static ANTICHEAT_OPLOGIC2=88;static ANTICHEAT_OPLOGIC3=30;static ANTICHEAT_OPLOGIC4=176;static ANTICHEAT_OPLOGIC5=220;static ANTICHEAT_OPLOGIC6=66;static ANTICHEAT_OPLOGIC7=17;static ANTICHEAT_OPLOGIC8=2;static ANTICHEAT_OPLOGIC9=238;static ANTICHEAT_CYCLELOGIC1=233;static ANTICHEAT_CYCLELOGIC2=146;static ANTICHEAT_CYCLELOGIC3=215;static ANTICHEAT_CYCLELOGIC4=236;static ANTICHEAT_CYCLELOGIC5=85;static ANTICHEAT_CYCLELOGIC6=219;static OPOBJ1=140;static OPOBJ2=40;static OPOBJ3=200;static OPOBJ4=178;static OPOBJ5=247;static OPOBJT=138;static OPOBJU=239;static OPNPC1=194;static OPNPC2=8;static OPNPC3=27;static OPNPC4=113;static OPNPC5=100;static OPNPCT=134;static OPNPCU=202;static OPLOC1=245;static OPLOC2=172;static OPLOC3=96;static OPLOC4=97;static OPLOC5=116;static OPLOCT=9;static OPLOCU=75;static OPPLAYER1=164;static OPPLAYER2=53;static OPPLAYER3=185;static OPPLAYER4=206;static OPPLAYERT=177;static OPPLAYERU=248;static OPHELD1=195;static OPHELD2=71;static OPHELD3=133;static OPHELD4=157;static OPHELD5=211;static OPHELDT=48;static OPHELDU=130;static INV_BUTTON1=31;static INV_BUTTON2=59;static INV_BUTTON3=212;static INV_BUTTON4=38;static INV_BUTTON5=6;static IF_BUTTON=155;static RESUME_PAUSEBUTTON=235;static CLOSE_MODAL=231;static RESUME_P_COUNTDIALOG=237;static TUTORIAL_CLICKSIDE=175;static MOVE_OPCLICK=93;static BUG_REPORT=190;static MOVE_MINIMAPCLICK=165;static INV_BUTTOND=159;static IGNORELIST_DEL=171;static IGNORELIST_ADD=79;static IF_PLAYERDESIGN=52;static CHAT_SETMODE=244;static MESSAGE_PRIVATE=148;static FRIENDLIST_DEL=11;static FRIENDLIST_ADD=118;static CLIENT_CHEAT=4;static MESSAGE_PUBLIC=158;static MOVE_GAMECLICK=181}class H8{db;constructor(_){_.onerror=this.onerror;_.onclose=this.onclose;this.db=_}static openDatabase=async()=>{return await new Promise((_,R)=>{const L=indexedDB.open("lostcity",1);L.onsuccess=(G)=>{const K=G.target;_(K.result)};L.onupgradeneeded=(G)=>{const K=G.target;K.result.createObjectStore("cache")};L.onerror=(G)=>{const K=G.target;R(K.result)}})};async cacheload(_){return await new Promise((R)=>{const L=this.db.transaction("cache","readonly");const G=L.objectStore("cache");const K=G.get(_);K.onsuccess=()=>{R(K.result)};K.onerror=(Q)=>{R(undefined)}})}async cachesave(_,R){return await new Promise((L,G)=>{const K=this.db.transaction("cache","readwrite");const Q=K.objectStore("cache");const H=Q.put(R,_);H.onsuccess=()=>{L()};H.onerror=($)=>{G()}})}onclose=(_)=>{};onerror=(_)=>{};genHash=(_)=>{const R=_.trim();let L=0;for(let G=0;G<R.length&&G<12;G++){const K=R.charAt(G);L*=37;if(K>="A"&&K<="Z"){L+=K.charCodeAt(0)+1-65}else if(K>="a"&&K<="z"){L+=K.charCodeAt(0)+1-97}else if(K>="0"&&K<="9"){L+=K.charCodeAt(0)+27-48}}return L}}class $8{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(_){for(let R=0;R<_.length;R++){this.rsl[R]=_[R]}this.init()}get nextInt(){if(this.count--===0){this.isaac();this.count=255}return this.rsl[this.count]}init(){let _=2654435769,R=2654435769,L=2654435769,G=2654435769,K=2654435769,Q=2654435769,H=2654435769,$=2654435769;for(let J=0;J<4;J++){_^=R<<11;G+=_;R+=L;R^=L>>>2;K+=R;L+=G;L^=G<<8;Q+=L;G+=K;G^=K>>>16;H+=G;K+=Q;K^=Q<<10;$+=K;Q+=H;Q^=H>>>4;_+=Q;H+=$;H^=$<<8;R+=H;$+=_;$^=_>>>9;L+=$;_+=R}for(let J=0;J<256;J+=8){_+=this.rsl[J];R+=this.rsl[J+1];L+=this.rsl[J+2];G+=this.rsl[J+3];K+=this.rsl[J+4];Q+=this.rsl[J+5];H+=this.rsl[J+6];$+=this.rsl[J+7];_^=R<<11;G+=_;R+=L;R^=L>>>2;K+=R;L+=G;L^=G<<8;Q+=L;G+=K;G^=K>>>16;H+=G;K+=Q;K^=Q<<10;$+=K;Q+=H;Q^=H>>>4;_+=Q;H+=$;H^=$<<8;R+=H;$+=_;$^=_>>>9;L+=$;_+=R;this.mem[J]=_;this.mem[J+1]=R;this.mem[J+2]=L;this.mem[J+3]=G;this.mem[J+4]=K;this.mem[J+5]=Q;this.mem[J+6]=H;this.mem[J+7]=$}for(let J=0;J<256;J+=8){_+=this.mem[J];R+=this.mem[J+1];L+=this.mem[J+2];G+=this.mem[J+3];K+=this.mem[J+4];Q+=this.mem[J+5];H+=this.mem[J+6];$+=this.mem[J+7];_^=R<<11;G+=_;R+=L;R^=L>>>2;K+=R;L+=G;L^=G<<8;Q+=L;G+=K;G^=K>>>16;H+=G;K+=Q;K^=Q<<10;$+=K;Q+=H;Q^=H>>>4;_+=Q;H+=$;H^=$<<8;R+=H;$+=_;$^=_>>>9;L+=$;_+=R;this.mem[J]=_;this.mem[J+1]=R;this.mem[J+2]=L;this.mem[J+3]=G;this.mem[J+4]=K;this.mem[J+5]=Q;this.mem[J+6]=H;this.mem[J+7]=$}this.isaac();this.count=256}isaac(){this.c++;this.b+=this.c;for(let _=0;_<256;_++){const R=this.mem[_];const L=_&3;if(L===0){this.a^=this.a<<13}else if(L===1){this.a^=this.a>>>6}else if(L===2){this.a^=this.a<<2}else if(L===3){this.a^=this.a>>>16}this.a+=this.mem[_+128&255];let G;this.mem[_]=G=this.mem[R>>>2&255]+this.a+this.b;this.rsl[_]=this.b=this.mem[G>>>8>>>2&255]+R}}}class g1{static genHash=(_)=>{let R=0;_=_.toUpperCase();for(let L=0;L<_.length;L++){R=R*61+_.charCodeAt(L)-32|0}return R};buffer;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(_){let R=new p(new Uint8Array(_));const L=R.g3;const G=R.g3;if(L===G){this.buffer=_;this.compressedWhole=false}else{this.buffer=h1.decompress(_.subarray(6),L,true);R=new p(new Uint8Array(this.buffer));this.compressedWhole=true}this.fileCount=R.g2;this.fileHash=[];this.fileUnpackedSize=[];this.filePackedSize=[];this.fileOffset=[];let K=R.pos+this.fileCount*10;for(let Q=0;Q<this.fileCount;Q++){this.fileHash.push(R.g4);this.fileUnpackedSize.push(R.g3);this.filePackedSize.push(R.g3);this.fileOffset.push(K);K+=this.filePackedSize[Q]}}read(_){const R=g1.genHash(_);const L=this.fileHash.indexOf(R);if(L===-1){return null}return this.readIndex(L)}readIndex(_){if(_<0||_>=this.fileCount){return null}if(this.fileUnpacked[_]){return this.fileUnpacked[_]}const R=this.fileOffset[_];const L=R+this.filePackedSize[_];const G=Uint8Array.from(this.buffer.subarray(R,R+L));if(this.compressedWhole){this.fileUnpacked[_]=G;return G}else{const K=h1.decompress(G,this.fileUnpackedSize[_],true);this.fileUnpacked[_]=K;return K}}}class v8{static CLIENTPROT_SCRAMBLED=[95,218,67,50,253,222,194,60,101,128,8,251,92,111,24,33,223,66,232,59,227,113,153,105,126,98,167,102,177,238,62,190,147,23,150,151,156,144,193,155,81,0,198,22,137,210,179,16,168,170,32,181,248,141,58,87,208,106,180,191,221,241,40,176,196,154,65,145,230,78,30,161,188,41,14,129,18,199,47,247,225,34,51,10,159,75,12,56,61,31,39,91,46,242,134,5,122,123,209,228,104,195,21,3,11,44,107,172,6,186,110,215,205,103,27,185,124,77,252,117,86,115,127,207,52,79,43,97,219,116,169,7,118,162,108,36,20,233,88,135,80,19,42,237,57,152,71,9,250,17,4,119,234,130,26,200,189,163,254,245,197,171,220,235,140,244,184,94,211,231,99,246,121,212,112,204,63,148,83,178,1,255,131,13,183,142,236,45,55,35,243,136,37,85,100,160,38,224,146,174,82,48,109,132,125,90,143,138,240,173,165,164,192,175,29,74,28,114,213,73,64,206,76,139,96,2,229,15,93,25,239,202,49,70,214,201,72,203,68,89,69,157,216,217,249,120,226,84,149,187,54,53,158,166,182,133,0];static SERVERPROT_SIZES=[0,-2,4,6,-1,0,0,2,0,0,0,0,5,4,2,2,0,0,0,0,2,-2,2,14,0,6,3,0,4,0,0,0,3,0,0,0,0,0,0,0,0,-1,4,2,6,0,6,0,0,3,7,0,0,0,-1,0,0,0,0,4,0,0,0,0,0,0,0,0,1,15,0,0,0,0,6,0,2,0,0,0,2,0,0,0,1,0,0,4,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,-2,0,0,2,0,0,0,2,9,0,0,0,0,0,4,0,0,0,3,7,9,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,3,2,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,-2,2,0,0,0,0,0,6,0,0,0,2,0,2,0,0,0,-2,0,0,4,0,0,0,0,6,0,0,-2,-2,0,0,0,0,0,0,-2,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0]}class t{static IF_OPENCHATMODAL=14;static IF_OPENMAINSIDEMODAL=28;static IF_CLOSE=129;static IF_OPENSIDEOVERLAY=167;static IF_OPENMAINMODAL=168;static IF_OPENSIDEMODAL=195;static IF_SETCOLOUR=2;static IF_SETHIDE=26;static IF_SETOBJECT=46;static IF_SHOWSIDE=84;static IF_SETMODEL=87;static IF_SETRECOL=103;static IF_SETANIM=146;static IF_SETPLAYERHEAD=197;static IF_SETTEXT=201;static IF_SETNPCHEAD=204;static IF_SETPOSITION=209;static TUTORIAL_FLASHSIDE=126;static TUTORIAL_OPENCHAT=185;static UPDATE_INV_STOP_TRANSMIT=15;static UPDATE_INV_FULL=98;static UPDATE_INV_PARTIAL=213;static CAM_LOOKAT=74;static CAM_SHAKE=13;static CAM_MOVETO=3;static CAM_RESET=239;static NPC_INFO=1;static PLAYER_INFO=184;static FINISH_TRACKING=133;static ENABLE_TRACKING=226;static MESSAGE_GAME=4;static UPDATE_IGNORELIST=21;static CHAT_FILTER_SETTINGS=32;static MESSAGE_PRIVATE=41;static UPDATE_FRIENDLIST=152;static UNSET_MAP_FLAG=19;static UPDATE_RUNWEIGHT=22;static HINT_ARROW=25;static UPDATE_REBOOT_TIMER=43;static UPDATE_STAT=44;static UPDATE_RUNENERGY=68;static RESET_ANIMS=136;static UPDATE_UID192=139;static LAST_LOGIN_INFO=140;static LOGOUT=142;static P_COUNTDIALOG=243;static SET_MULTIWAY=254;static DATA_LOC_DONE=20;static DATA_LAND_DONE=80;static DATA_LAND=132;static DATA_LOC=220;static REBUILD_NORMAL=237;static VARP_SMALL=150;static VARP_LARGE=175;static RESET_CLIENT_VARCACHE=193;static SYNTH_SOUND=12;static MIDI_SONG=54;static MIDI_JINGLE=212;static UPDATE_ZONE_PARTIAL_FOLLOWS=7;static UPDATE_ZONE_FULL_FOLLOWS=135;static UPDATE_ZONE_PARTIAL_ENCLOSED=162;static LOC_MERGE=23;static LOC_ANIM=42;static OBJ_DEL=49;static OBJ_REVEAL=50;static LOC_ADD_CHANGE=59;static MAP_PROJANIM=69;static LOC_DEL=76;static OBJ_COUNT=151;static MAP_ANIM=191;static OBJ_ADD=223}class k1{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((_)=>_.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((_)=>_.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((_)=>_.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack=(_)=>{const R=new p(_.read("fragmentsenc.txt"));const L=new p(_.read("badenc.txt"));const G=new p(_.read("domainenc.txt"));const K=new p(_.read("tldlist.txt"));this.read(L,G,R,K)};static filter=(_)=>{const R=[..._];this.format(R);const L=R.join("").trim();const G=L.toLowerCase();const K=[...G];this.filterTlds(K);this.filterBadWords(K);this.filterDomains(K);this.filterFragments(K);for(let Q=0;Q<this.whitelist.length;Q++){let H=-1;while((H=G.indexOf(this.whitelist[Q],H+1))!==-1){const $=[...this.whitelist[Q]];for(let J=0;J<$.length;J++){K[J+H]=$[J]}}}this.replaceUppercases(K,[...L]);this.formatUppercases(K);return K.join("").trim()};static read=(_,R,L,G)=>{this.readBadWords(_);this.readDomains(R);this.readFragments(L);this.readTld(G)};static readTld=(_)=>{const R=_.g4;for(let L=0;L<R;L++){this.tldTypes[L]=_.g1;this.tlds[L]=new Uint16Array(_.g1).map(()=>_.g1)}};static readBadWords=(_)=>{const R=_.g4;for(let L=0;L<R;L++){this.bads[L]=new Uint16Array(_.g1).map(()=>_.g1);const G=new Array(_.g1).fill([]).map(()=>[_.g1b,_.g1b]);if(G.length>0){this.badCombinations[L]=G}}};static readDomains=(_)=>{const R=_.g4;for(let L=0;L<R;L++){this.domains[L]=new Uint16Array(_.g1).map(()=>_.g1)}};static readFragments=(_)=>{const R=_.g4;for(let L=0;L<R;L++){this.fragments[L]=_.g2}};static filterTlds=(_)=>{const R=[..._];const L=[..._];this.filterBadCombinations(null,R,this.PERIOD);this.filterBadCombinations(null,L,this.SLASH);for(let G=0;G<this.tlds.length;G++){this.filterTld(L,this.tldTypes[G],_,this.tlds[G],R)}};static filterBadWords=(_)=>{for(let R=0;R<2;R++){for(let L=this.bads.length-1;L>=0;L--){this.filterBadCombinations(this.badCombinations[L],_,this.bads[L])}}};static filterDomains=(_)=>{const R=[..._];const L=[..._];this.filterBadCombinations(null,R,this.AMPERSAT);this.filterBadCombinations(null,L,this.PERIOD);for(let G=this.domains.length-1;G>=0;G--){this.filterDomain(L,R,this.domains[G],_)}};static filterFragments=(_)=>{for(let R=0;R<_.length;){const L=this.indexOfNumber(_,R);if(L===-1){return}let G=false;for(let H=R;H>=0&&H<L&&!G;H++){if(!this.isSymbol(_[H])&&!this.isNotLowercaseAlpha(_[H])){G=true}}let K=0;if(G){K=0}if(K===0){K=1;R=L}let Q=0;for(let H=L;H<_.length&&H<R;H++){Q=Q*10+_[H].charCodeAt(0)-48}if(Q<=255&&R-L<=8){K++}else{K=0}if(K===4){this.maskChars(L,R,_);K=0}R=this.indexOfNonNumber(R,_)}};static isBadFragment=(_)=>{if(this.isNumericalChars(_)){return true}const R=this.getInteger(_);const L=this.fragments;const G=L.length;if(R===L[0]||R===L[G-1]){return true}let K=0;let Q=G-1;while(K<=Q){const H=(K+Q)/2|0;if(R===L[H]){return true}else if(R<L[H]){Q=H-1}else{K=H+1}}return false};static getInteger=(_)=>{if(_.length>6){return 0}let R=0;for(let L=0;L<_.length;L++){const G=_[_.length-L-1];if(this.isLowercaseAlpha(G)){R=R*38+G.charCodeAt(0)+1-97}else if(G==="'"){R=R*38+27}else if(this.isNumerical(G)){R=R*38+G.charCodeAt(0)+28-48}else if(G!=="\x00"){return 0}}return R};static indexOfNumber=(_,R)=>{for(let L=R;L<_.length&&L>=0;L++){if(this.isNumerical(_[L])){return L}}return-1};static indexOfNonNumber=(_,R)=>{for(let L=_;L<R.length&&L>=0;L++){if(!this.isNumerical(R[L])){return L}}return R.length};static getEmulatedDomainCharLen=(_,R,L)=>{if(R===L){return 1}else if(R==="o"&&L==="0"){return 1}else if(R==="o"&&L==="("&&_===")"){return 2}else if(R==="c"&&(L==="("||L==="<"||L==="[")){return 1}else if(R==="e"&&L==="€"){return 1}else if(R==="s"&&L==="$"){return 1}else if(R==="l"&&L==="i"){return 1}return 0};static filterDomain=(_,R,L,G)=>{const K=L.length;const Q=G.length;for(let H=0;H<=Q-K;H++){const{matched:$,currentIndex:J}=this.findMatchingDomain(H,L,G);if(!$){continue}const O=this.prefixSymbolStatus(H,G,3,R,["@"]);const q=this.suffixSymbolStatus(J-1,G,3,_,[".",","]);const N=O>2||q>2;if(!N){continue}this.maskChars(H,J,G)}};static findMatchingDomain=(_,R,L)=>{const G=R.length;let K=_;let Q=0;while(K<L.length&&Q<G){const H=L[K];const $=K+1<L.length?L[K+1]:"\x00";const J=this.getEmulatedDomainCharLen($,String.fromCharCode(R[Q]),H);if(J>0){K+=J;Q++}else{if(Q===0)break;const O=this.getEmulatedDomainCharLen($,String.fromCharCode(R[Q-1]),H);if(O>0){K+=O;if(Q===1)_++}else{if(Q>=G||!this.isSymbol(H))break;K++}}}return{matched:Q>=G,currentIndex:K}};static filterBadCombinations=(_,R,L)=>{if(L.length>R.length){return}for(let G=0;G<=R.length-L.length;G++){let K=G;const{currentIndex:Q,badIndex:H,hasSymbol:$,hasNumber:J,hasDigit:O}=this.processBadCharacters(R,L,K);K=Q;let q=R[K];let N=K+1<R.length?R[K+1]:"\x00";if(!(H>=L.length&&(!J||!O))){continue}let U=true;let b;if($){let F=false;let T=false;if(G-1<0||this.isSymbol(R[G-1])&&R[G-1]!=="'"){F=true}if(K>=R.length||this.isSymbol(R[K])&&R[K]!=="'"){T=true}if(!F||!T){let Y=false;b=G-2;if(F){b=G}while(!Y&&b<K){if(b>=0&&(!this.isSymbol(R[b])||R[b]==="'")){const u=[];let w;for(w=0;w<3&&b+w<R.length&&(!this.isSymbol(R[b+w])||R[b+w]==="'");w++){u[w]=R[b+w]}let h=true;if(w===0){h=false}if(w<3&&b-1>=0&&(!this.isSymbol(R[b-1])||R[b-1]==="'")){h=false}if(h&&!this.isBadFragment(u)){Y=true}}b++}if(!Y){U=false}}}else{q=" ";if(G-1>=0){q=R[G-1]}N=" ";if(K<R.length){N=R[K]}const F=this.getIndex(q);const T=this.getIndex(N);if(_&&this.comboMatches(F,_,T)){U=false}}if(!U){continue}let I=0;let j=0;for(let F=G;F<K;F++){if(this.isNumerical(R[F])){I++}else if(this.isAlpha(R[F])){j++}}if(I<=j){this.maskChars(G,K,R)}}};static processBadCharacters=(_,R,L)=>{let G=L;let K=0;let Q=0;let H=false;let $=false;let J=false;for(;G<_.length&&!($&&J);){if(G>=_.length||$&&J){break}const O=_[G];const q=G+1<_.length?_[G+1]:"\x00";let N;if(K<R.length&&(N=this.getEmulatedBadCharLen(q,String.fromCharCode(R[K]),O))>0){if(N===1&&this.isNumerical(O)){$=true}if(N===2&&(this.isNumerical(O)||this.isNumerical(q))){$=true}G+=N;K++}else{if(K===0){break}let U;if((U=this.getEmulatedBadCharLen(q,String.fromCharCode(R[K-1]),O))>0){G+=U}else{if(K>=R.length||!this.isNotLowercaseAlpha(O)){break}if(this.isSymbol(O)&&O!=="'"){H=true}if(this.isNumerical(O)){J=true}G++;Q++;if((Q*100/(G-L)|0)>90){break}}}}return{currentIndex:G,badIndex:K,hasSymbol:H,hasNumber:$,hasDigit:J}};static getEmulatedBadCharLen=(_,R,L)=>{if(R===L){return 1}if(R>="a"&&R<="m"){if(R==="a"){if(L!=="4"&&L!=="@"&&L!=="^"){if(L==="/"&&_==="\\"){return 2}return 0}return 1}if(R==="b"){if(L!=="6"&&L!=="8"){if(L==="1"&&_==="3"){return 2}return 0}return 1}if(R==="c"){if(L!=="("&&L!=="<"&&L!=="{"&&L!=="["){return 0}return 1}if(R==="d"){if(L==="["&&_===")"){return 2}return 0}if(R==="e"){if(L!=="3"&&L!=="€"){return 0}return 1}if(R==="f"){if(L==="p"&&_==="h"){return 2}if(L==="£"){return 1}return 0}if(R==="g"){if(L!=="9"&&L!=="6"){return 0}return 1}if(R==="h"){if(L==="#"){return 1}return 0}if(R==="i"){if(L!=="y"&&L!=="l"&&L!=="j"&&L!=="1"&&L!=="!"&&L!==":"&&L!==";"&&L!=="|"){return 0}return 1}if(R==="j"){return 0}if(R==="k"){return 0}if(R==="l"){if(L!=="1"&&L!=="|"&&L!=="i"){return 0}return 1}if(R==="m"){return 0}}if(R>="n"&&R<="z"){if(R==="n"){return 0}if(R==="o"){if(L!=="0"&&L!=="*"){if((L!=="("||_!==")")&&(L!=="["||_!=="]")&&(L!=="{"||_!=="}")&&(L!=="<"||_!==">")){return 0}return 2}return 1}if(R==="p"){return 0}if(R==="q"){return 0}if(R==="r"){return 0}if(R==="s"){if(L!=="5"&&L!=="z"&&L!=="$"&&L!=="2"){return 0}return 1}if(R==="t"){if(L!=="7"&&L!=="+"){return 0}return 1}if(R==="u"){if(L==="v"){return 1}if((L!=="\\"||_!=="/")&&(L!=="\\"||_!=="|")&&(L!=="|"||_!=="/")){return 0}return 2}if(R==="v"){if((L!=="\\"||_!=="/")&&(L!=="\\"||_!=="|")&&(L!=="|"||_!=="/")){return 0}return 2}if(R==="w"){if(L==="v"&&_==="v"){return 2}return 0}if(R==="x"){if((L!==")"||_!=="(")&&(L!=="}"||_!=="{")&&(L!=="]"||_!=="[")&&(L!==">"||_!=="<")){return 0}return 2}if(R==="y"){return 0}if(R==="z"){return 0}}if(R>="0"&&R<="9"){if(R==="0"){if(L==="o"||L==="O"){return 1}else if((L!=="("||_!==")")&&(L!=="{"||_!=="}")&&(L!=="["||_!=="]")){return 0}else{return 2}}else if(R==="1"){return L==="l"?1:0}else{return 0}}else if(R===","){return L==="."?1:0}else if(R==="."){return L===","?1:0}else if(R==="!"){return L==="i"?1:0}return 0};static comboMatches=(_,R,L)=>{let G=0;let K=R.length-1;while(G<=K){const Q=(G+K)/2|0;if(R[Q][0]===_&&R[Q][1]===L){return true}else if(_<R[Q][0]||_===R[Q][0]&&L<R[Q][1]){K=Q-1}else{G=Q+1}}return false};static getIndex=(_)=>{if(this.isLowercaseAlpha(_)){return _.charCodeAt(0)+1-97}else if(_==="'"){return 28}else if(this.isNumerical(_)){return _.charCodeAt(0)+29-48}return 27};static filterTld=(_,R,L,G,K)=>{if(G.length>L.length){return}for(let Q=0;Q<=L.length-G.length;Q++){const{currentIndex:H,tldIndex:$}=this.processTlds(L,G,Q);if($<G.length){continue}let J=false;const O=this.prefixSymbolStatus(Q,L,3,K,[",","."]);const q=this.suffixSymbolStatus(H-1,L,5,_,["\\","/"]);if(R===1&&O>0&&q>0){J=true}if(R===2&&(O>2&&q>0||O>0&&q>2)){J=true}if(R===3&&O>0&&q>2){J=true}if(!J){continue}let N=Q;let U=H-1;let b=false;let I;if(O>2){if(O===4){b=false;for(I=Q-1;I>=0;I--){if(b){if(K[I]!=="*"){break}N=I}else if(K[I]==="*"){N=I;b=true}}}b=false;for(I=N-1;I>=0;I--){if(b){if(this.isSymbol(L[I])){break}N=I}else if(!this.isSymbol(L[I])){b=true;N=I}}}if(q>2){if(q===4){b=false;for(I=U+1;I<L.length;I++){if(b){if(_[I]!=="*"){break}U=I}else if(_[I]==="*"){U=I;b=true}}}b=false;for(I=U+1;I<L.length;I++){if(b){if(this.isSymbol(L[I])){break}U=I}else if(!this.isSymbol(L[I])){b=true;U=I}}}this.maskChars(N,U+1,L)}};static processTlds=(_,R,L)=>{let G=0;while(L<_.length&&G<R.length){const K=_[L];const Q=L+1<_.length?_[L+1]:"\x00";let H;if((H=this.getEmulatedDomainCharLen(Q,String.fromCharCode(R[G]),K))>0){L+=H;G++}else{if(G===0){break}let $;if(($=this.getEmulatedDomainCharLen(Q,String.fromCharCode(R[G-1]),K))>0){L+=$}else{if(!this.isSymbol(K)){break}L++}}}return{currentIndex:L,tldIndex:G}};static isSymbol=(_)=>!this.isAlpha(_)&&!this.isNumerical(_);static isNotLowercaseAlpha=(_)=>this.isLowercaseAlpha(_)?_==="v"||_==="x"||_==="j"||_==="q"||_==="z":true;static isAlpha=(_)=>this.isLowercaseAlpha(_)||this.isUppercaseAlpha(_);static isNumerical=(_)=>_>="0"&&_<="9";static isLowercaseAlpha=(_)=>_>="a"&&_<="z";static isUppercaseAlpha=(_)=>_>="A"&&_<="Z";static isNumericalChars=(_)=>{for(let R=0;R<_.length;R++){if(!this.isNumerical(_[R])&&_[R]!=="\x00"){return false}}return true};static maskChars=(_,R,L)=>{for(let G=_;G<R;G++){L[G]="*"}};static maskedCountBackwards=(_,R)=>{let L=0;for(let G=R-1;G>=0&&this.isSymbol(_[G]);G--){if(_[G]==="*"){L++}}return L};static maskedCountForwards=(_,R)=>{let L=0;for(let G=R+1;G<_.length&&this.isSymbol(_[G]);G++){if(_[G]==="*"){L++}}return L};static maskedCharsStatus=(_,R,L,G,K)=>{const Q=K?this.maskedCountBackwards(R,L):this.maskedCountForwards(R,L);if(Q>=G){return 4}else if(this.isSymbol(K?_[L-1]:_[L+1])){return 1}return 0};static prefixSymbolStatus=(_,R,L,G,K)=>{if(_===0){return 2}for(let Q=_-1;Q>=0&&this.isSymbol(R[Q]);Q--){if(K.includes(R[Q])){return 3}}return this.maskedCharsStatus(R,G,_,L,true)};static suffixSymbolStatus=(_,R,L,G,K)=>{if(_+1===R.length){return 2}for(let Q=_+1;Q<R.length&&this.isSymbol(R[Q]);Q++){if(K.includes(R[Q])){return 3}}return this.maskedCharsStatus(R,G,_,L,false)};static format=(_)=>{let R=0;for(let L=0;L<_.length;L++){if(this.isCharacterAllowed(_[L])){_[R]=_[L]}else{_[R]=" "}if(R===0||_[R]!==" "||_[R-1]!==" "){R++}}for(let L=R;L<_.length;L++){_[L]=" "}};static isCharacterAllowed=(_)=>_>=" "&&_<=""||_===" "||_===`
`||_==="\t"||_==="£"||_==="€";static replaceUppercases=(_,R)=>{for(let L=0;L<R.length;L++){if(_[L]!=="*"&&this.isUppercaseAlpha(R[L])){_[L]=R[L]}}};static formatUppercases=(_)=>{let R=true;for(let L=0;L<_.length;L++){const G=_[L];if(!this.isAlpha(G)){R=true}else if(R){if(this.isLowercaseAlpha(G)){R=false}}else if(this.isUppercaseAlpha(G)){_[L]=String.fromCharCode(G.charCodeAt(0)+97-65)}}}}class m1{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack=(_,R)=>{let L=0;let G=-1;let K;for(let H=0;H<R&&L<100;H++){const $=_.g1;K=$>>4&15;if(G!==-1){this.charBuffer[L++]=this.TABLE[(G<<4)+K-195];G=-1}else if(K<13){this.charBuffer[L++]=this.TABLE[K]}else{G=K}K=$&15;if(G!==-1){this.charBuffer[L++]=this.TABLE[(G<<4)+K-195];G=-1}else if(K<13){this.charBuffer[L++]=this.TABLE[K]}else{G=K}}let Q=true;for(let H=0;H<L;H++){const $=this.charBuffer[H];if(Q&&$>="a"&&$<="z"){this.charBuffer[H]=$.toUpperCase();Q=false}if($==="."||$==="!"){Q=true}}return this.charBuffer.slice(0,L).join("")};static pack=(_,R)=>{if(R.length>80){R=R.substring(0,80)}R=R.toLowerCase();let L=-1;for(let G=0;G<R.length;G++){const K=R.charAt(G);let Q=0;for(let H=0;H<this.TABLE.length;H++){if(K===this.TABLE[H]){Q=H;break}}if(Q>12){Q+=195}if(L===-1){if(Q<13){L=Q}else{_.p1(Q)}}else if(Q<13){_.p1((L<<4)+Q);L=-1}else{_.p1((L<<4)+(Q>>4));L=Q&15}}if(L!==-1){_.p1(L<<4)}}}class O1{start=0;end=0;form=0;length=0;shapeDelta=null;shapePeak=null;threshold=0;position=0;delta=0;amplitude=0;ticks=0;read(_){this.form=_.g1;this.start=_.g4;this.end=_.g4;this.length=_.g1;this.shapeDelta=new Int32Array(this.length);this.shapePeak=new Int32Array(this.length);for(let R=0;R<this.length;R++){this.shapeDelta[R]=_.g2;this.shapePeak[R]=_.g2}}reset(){this.threshold=0;this.position=0;this.delta=0;this.amplitude=0;this.ticks=0}evaluate(_){if(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta){this.amplitude=this.shapePeak[this.position++]<<15;if(this.position>=this.length){this.position=this.length-1}this.threshold=this.shapeDelta[this.position]/65536*_|0;if(this.threshold>this.ticks){this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0}}this.amplitude+=this.delta;this.ticks++;return this.amplitude-this.delta>>15}}class A0{static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);start=0;length=500;reverbVolume=100;reverbDelay=0;static init=()=>{this.noise=new Int32Array(32768);for(let _=0;_<32768;_++){if(Math.random()>0.5){this.noise[_]=1}else{this.noise[_]=-1}}this.sin=new Int32Array(32768);for(let _=0;_<32768;_++){this.sin[_]=Math.sin(_/5215.1903)*16384|0}this.buffer=new Int32Array(220500)};generate(_,R){for(let O=0;O<_;O++){A0.buffer[O]=0}if(R<10){return A0.buffer}const L=_/R|0;this.frequencyBase?.reset();this.amplitudeBase?.reset();let G=0;let K=0;let Q=0;if(this.frequencyModRate&&this.frequencyModRange){this.frequencyModRate.reset();this.frequencyModRange.reset();G=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/L|0;K=this.frequencyModRate.start*32.768/L|0}let H=0;let $=0;let J=0;if(this.amplitudeModRate&&this.amplitudeModRange){this.amplitudeModRate.reset();this.amplitudeModRange.reset();H=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/L|0;$=this.amplitudeModRate.start*32.768/L|0}for(let O=0;O<5;O++){if(this.frequencyBase&&this.harmonicVolume[O]!==0){A0.tmpPhases[O]=0;A0.tmpDelays[O]=this.harmonicDelay[O]*L;A0.tmpVolumes[O]=(this.harmonicVolume[O]<<14)/100|0;A0.tmpSemitones[O]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[O])/L|0;A0.tmpStarts[O]=this.frequencyBase.start*32.768/L|0}}if(this.frequencyBase&&this.amplitudeBase){for(let O=0;O<_;O++){let q=this.frequencyBase.evaluate(_);let N=this.amplitudeBase.evaluate(_);if(this.frequencyModRate&&this.frequencyModRange){const U=this.frequencyModRate.evaluate(_);const b=this.frequencyModRange.evaluate(_);q+=this.generate2(b,Q,this.frequencyModRate.form)>>1;Q+=(U*G>>16)+K}if(this.amplitudeModRate&&this.amplitudeModRange){const U=this.amplitudeModRate.evaluate(_);const b=this.amplitudeModRange.evaluate(_);N=N*((this.generate2(b,J,this.amplitudeModRate.form)>>1)+32768)>>15;J+=(U*H>>16)+$}for(let U=0;U<5;U++){if(this.harmonicVolume[U]!==0){const b=O+A0.tmpDelays[U];if(b<_){A0.buffer[b]+=this.generate2(N*A0.tmpVolumes[U]>>15,A0.tmpPhases[U],this.frequencyBase.form);A0.tmpPhases[U]+=(q*A0.tmpSemitones[U]>>16)+A0.tmpStarts[U]}}}}}if(this.release&&this.attack){this.release.reset();this.attack.reset();let O=0;let q=true;for(let N=0;N<_;N++){const U=this.release.evaluate(_);const b=this.attack.evaluate(_);let I;if(q){I=this.release.start+((this.release.end-this.release.start)*U>>8)}else{I=this.release.start+((this.release.end-this.release.start)*b>>8)}O+=256;if(O>=I){O=0;q=!q}if(q){A0.buffer[N]=0}}}if(this.reverbDelay>0&&this.reverbVolume>0){const O=this.reverbDelay*L;for(let q=O;q<_;q++){A0.buffer[q]+=A0.buffer[q-O]*this.reverbVolume/100|0;A0.buffer[q]|=0}}for(let O=0;O<_;O++){if(A0.buffer[O]<-32768){A0.buffer[O]=-32768}if(A0.buffer[O]>32767){A0.buffer[O]=32767}}return A0.buffer}generate2(_,R,L){if(L===1){return(R&32767)<16384?_:-_}else if(L===2){return A0.sin[R&32767]*_>>14}else if(L===3){return((R&32767)*_>>14)-_}else if(L===4){return A0.noise[(R/2607|0)&32767]*_}else{return 0}}read(_){this.frequencyBase=new O1;this.frequencyBase.read(_);this.amplitudeBase=new O1;this.amplitudeBase.read(_);if(_.g1!==0){_.pos--;this.frequencyModRate=new O1;this.frequencyModRate.read(_);this.frequencyModRange=new O1;this.frequencyModRange.read(_)}if(_.g1!==0){_.pos--;this.amplitudeModRate=new O1;this.amplitudeModRate.read(_);this.amplitudeModRange=new O1;this.amplitudeModRange.read(_)}if(_.g1!==0){_.pos--;this.release=new O1;this.release.read(_);this.attack=new O1;this.attack.read(_)}for(let R=0;R<10;R++){const L=_.gsmarts;if(L===0){break}this.harmonicVolume[R]=L;this.harmonicSemitone[R]=_.gsmart;this.harmonicDelay[R]=_.gsmarts}this.reverbDelay=_.gsmarts;this.reverbVolume=_.gsmarts;this.length=_.g2;this.start=_.g2}}class Z0{static delays=new Int32Array(1000);static waveBytes=null;static waveBuffer=null;static tracks=new l(1000,null);tones=new l(10,null);loopBegin=0;loopEnd=0;static unpack=(_)=>{const R=new p(_.read("sounds.dat"));this.waveBytes=new Uint8Array(441000);this.waveBuffer=new p(this.waveBytes);A0.init();while(true){const L=R.g2;if(L===65535){break}const G=new Z0;G.read(R);this.tracks[L]=G;this.delays[L]=G.trim()}};static generate=(_,R)=>{if(!this.tracks[_]){return null}const L=this.tracks[_];return L?.getWave(R)??null};read(_){for(let R=0;R<10;R++){if(_.g1!==0){_.pos--;this.tones[R]=new A0;this.tones[R]?.read(_)}}this.loopBegin=_.g2;this.loopEnd=_.g2}trim(){let _=9999999;for(let R=0;R<10;R++){if(this.tones[R]&&(this.tones[R].start/20|0)<_){_=this.tones[R].start/20|0}}if(this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<_){_=this.loopBegin/20|0}if(_===9999999||_===0){return 0}for(let R=0;R<10;R++){if(this.tones[R]){this.tones[R].start-=_*20}}if(this.loopBegin<this.loopEnd){this.loopBegin-=_*20;this.loopEnd-=_*20}return _}getWave(_){const R=this.generate(_);Z0.waveBuffer.pos=0;Z0.waveBuffer?.p4(1380533830);Z0.waveBuffer?.ip4(R+36);Z0.waveBuffer?.p4(1463899717);Z0.waveBuffer?.p4(1718449184);Z0.waveBuffer?.ip4(16);Z0.waveBuffer?.ip2(1);Z0.waveBuffer?.ip2(1);Z0.waveBuffer?.ip4(22050);Z0.waveBuffer?.ip4(22050);Z0.waveBuffer?.ip2(1);Z0.waveBuffer?.ip2(8);Z0.waveBuffer?.p4(1684108385);Z0.waveBuffer?.ip4(R);Z0.waveBuffer.pos+=R;return Z0.waveBuffer}generate(_){let R=0;for(let H=0;H<10;H++){if(this.tones[H]&&this.tones[H].length+this.tones[H].start>R){R=this.tones[H].length+this.tones[H].start}}if(R===0){return 0}let L=R*22050/1000|0;let G=this.loopBegin*22050/1000|0;let K=this.loopEnd*22050/1000|0;if(G<0||K<0||K>L||G>=K){_=0}let Q=L+(K-G)*(_-1);for(let H=44;H<Q+44;H++){if(Z0.waveBytes){Z0.waveBytes[H]=-128}}for(let H=0;H<10;H++){if(this.tones[H]){const $=this.tones[H].length*22050/1000|0;const J=this.tones[H].start*22050/1000|0;const O=this.tones[H].generate($,this.tones[H].length);for(let q=0;q<$;q++){if(Z0.waveBytes){Z0.waveBytes[q+J+44]+=O[q]>>8<<24>>24}}}}if(_>1){G+=44;K+=44;L+=44;Q+=44;const H=Q-L;for(let $=L-1;$>=K;$--){if(Z0.waveBytes){Z0.waveBytes[$+H]=Z0.waveBytes[$]}}for(let $=1;$<_;$++){const J=(K-G)*$;for(let O=G;O<K;O++){if(Z0.waveBytes){Z0.waveBytes[O+J]=Z0.waveBytes[O]}}}Q-=44}return Q}}class d extends V8{static clientversion=225;static nodeId=10;static portOffset=0;static members=true;static lowMemory=false;static serverAddress="";static httpAddress="";static exponent=58778699976184461502525193738213253649000149147835990136706041084440742975821n;static modulus=7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789n;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;static setHighMemory=()=>{V.lowMemory=false;B.lowMemory=false;d.lowMemory=false;H0.lowMemory=false};static setLowMemory=()=>{V.lowMemory=true;B.lowMemory=true;d.lowMemory=true;H0.lowMemory=true};MAX_PLAYER_COUNT=2048;LOCAL_PLAYER_INDEX=2047;alreadyStarted=false;errorStarted=false;errorLoading=false;errorHost=false;db=null;loopCycle=0;archiveChecksums=[];stream=null;in=p.alloc(1);out=p.alloc(1);loginout=p.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;packetType=0;packetSize=0;lastPacketType0=0;lastPacketType1=0;lastPacketType2=0;titleArchive=null;redrawTitleBackground=true;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=false;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBacktop2=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new l(13,null);imageMinimap=null;imageCompass=null;imageMapscene=new l(50,null);imageMapfunction=new l(50,null);imageHitmarks=new l(20,null);imageHeadicons=new l(20,null);imageMapflag=null;imageCrosses=new l(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new l(1000,null);redrawSidebar=false;redrawChatback=false;redrawSideicons=false;redrawPrivacySettings=false;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=false;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new g;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];publicChatSetting=0;privateChatSetting=0;tradeChatSetting=0;scrollGrabbed=false;scrollInputPadding=0;showSocialInput=false;socialMessage="";socialInput="";socialAction=0;chatbackInput="";chatbackInputOpen=false;stickyChatInterfaceId=-1;messageText=new l(100,null);messageSender=new l(100,null);messageType=new Int32Array(100);messageIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=false;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=false;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;mouseButtonsOption=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=false;reportAbuseInterfaceID=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=false;cameraOffsetCycle=0;cameraAnticheatOffsetX=0;cameraAnticheatOffsetZ=0;cameraAnticheatAngle=0;cameraOffsetXModifier=2;cameraOffsetZModifier=2;cameraOffsetYawModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new l(5,false);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;minimapOffsetCycle=0;minimapAnticheatAngle=0;minimapZoom=0;minimapZoomModifier=1;minimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLocData=null;sceneMapIndex=null;mapLastBaseX=0;mapLastBaseZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new l(s.LEVELS,null);currentLevel=0;cameraMovedWrite=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new J1(s.SIZE,s.SIZE);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new l(this.MAX_PLAYER_COUNT,null);playerCount=0;playerIds=new Int32Array(this.MAX_PLAYER_COUNT);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(this.MAX_PLAYER_COUNT);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new l(this.MAX_PLAYER_COUNT,null);npcs=new l(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new g0;spotanims=new g0;locList=new g0;temporaryLocs=new g0;levelObjStacks=new e1(s.LEVELS,s.SIZE,s.SIZE,null);spawnedLocations=new g0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(s.SIZE*s.SIZE);bfsCost=new Int32Array(s.SIZE*s.SIZE);tryMoveNearest=0;localPlayer=null;energy=0;inMultizone=0;localPid=-1;weightCarried=0;heartbeatTimer=0;wildernessLevel=0;worldLocationState=0;rights=false;designGenderMale=true;updateDesignModel=false;designIdentikits=new Int32Array(7);designColors=new Int32Array(5);friendCount=0;chatCount=0;static MAX_CHATS=50;chatX=new Int32Array(d.MAX_CHATS);chatY=new Int32Array(d.MAX_CHATS);chatHeight=new Int32Array(d.MAX_CHATS);chatWidth=new Int32Array(d.MAX_CHATS);chatColors=new Int32Array(d.MAX_CHATS);chatStyles=new Int32Array(d.MAX_CHATS);chatTimers=new Int32Array(d.MAX_CHATS);chats=new l(d.MAX_CHATS,null);friendName=new l(100,null);friendName37=new BigInt64Array(100);friendWorld=new Int32Array(100);socialName37=null;waveCount=0;waveEnabled=true;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=192;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=true;currentMidi=null;midiCrc=0;midiSize=0;midiVolume=192;userTileMarkers=new l(16,null);userTileMarkerIndex=0;lastTickFlag=false;constructor(_,R,L,G){super();if(typeof _!=="undefined"){d.nodeId=_;const K=new URL(window.location.href);d.serverAddress=`${K.protocol}//${K.hostname}`;d.httpAddress=`${K.protocol}//${K.hostname}:${K.port}`}if(typeof R!=="undefined"){d.portOffset=R}if(typeof G!=="undefined"){d.members=G}if(typeof L!=="undefined"){if(L){d.setLowMemory()}else{d.setHighMemory()}}this.run()}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}unloadTitle=()=>{this.flameActive=false;if(this.flamesInterval){clearInterval(this.flamesInterval);this.flamesInterval=null}this.imageTitlebox=null;this.imageTitlebutton=null;this.imageRunes=[];this.flameGradient=null;this.flameGradient0=null;this.flameGradient1=null;this.flameGradient2=null;this.flameBuffer0=null;this.flameBuffer1=null;this.flameBuffer3=null;this.flameBuffer2=null;this.imageFlamesLeft=null;this.imageFlamesRight=null};loadArchive=async(_,R,L,G)=>{let K=5;let Q=await this.db?.cacheload(_);if(Q&&p.crc32(Q)!==L){Q=undefined}if(Q){return new g1(Q)}while(!Q){await this.showProgress(G,`Requesting ${R}`);try{Q=await T8(`${d.httpAddress}/${_}${L}`)}catch(H){Q=undefined;for(let $=K;$>0;$--){await this.showProgress(G,`Error loading - Will retry in ${$} secs.`);await q1(1000)}K*=2;if(K>60){K=60}}}await this.db?.cachesave(_,Q);return new g1(Q)};setMidi=async(_,R,L,G)=>{let K=await this.db?.cacheload(_+".mid");if(K&&R!==12345678&&p.crc32(K)!==R){K=undefined}if(!K){try{K=await T8(`${d.httpAddress}/${_}_${R}.mid`);if(L!==K.length){K=K.slice(0,L)}}catch(Q){}}if(!K){return}try{await this.db?.cachesave(_+".mid",K);const Q=new p(Uint8Array.from(K)).g4;const H=h1.decompress(K,Q,true,true);j6(H,this.midiVolume,G)}catch(Q){}};drawError=()=>{q0.fillStyle="black";q0.fillRect(0,0,this.width,this.height);this.setFramerate(1);if(this.errorLoading){this.flameActive=false;q0.font="bold 16px helvetica, sans-serif";q0.textAlign="left";q0.fillStyle="yellow";let _=35;q0.fillText("Sorry, an error has occured whilst loading RuneScape",30,_);_+=50;q0.fillStyle="white";q0.fillText("To fix this try the following (in order):",30,_);_+=50;q0.font="bold 12px helvetica, sans-serif";q0.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_);_+=30;q0.fillText("2: Try clearing your web-browsers cache from tools->internet options",30,_);_+=30;q0.fillText("3: Try using a different game-world",30,_);_+=30;q0.fillText("4: Try rebooting your computer",30,_);_+=30;q0.fillText("5: Try selecting a different version of Java from the play-game menu",30,_)}if(this.errorHost){this.flameActive=false;q0.font="bold 20px helvetica, sans-serif";q0.textAlign="left";q0.fillStyle="white";q0.fillText("Error - unable to load game!",50,50);q0.fillText("To play RuneScape make sure you play from",50,100);q0.fillText("https://2004scape.org",50,150)}if(this.errorStarted){this.flameActive=false;q0.font="bold 13px helvetica, sans-serif";q0.textAlign="left";q0.fillStyle="yellow";let _=35;q0.fillText("Error a copy of RuneScape already appears to be loaded",30,_);_+=50;q0.fillStyle="white";q0.fillText("To fix this try the following (in order):",30,_);_+=50;q0.font="bold 12px helvetica, sans-serif";q0.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_);_+=30;q0.fillText("2: Try rebooting your computer, and reloading",30,_)}};executeInterfaceScript=(_)=>{if(!_.scriptComparator){return false}for(let R=0;R<_.scriptComparator.length;R++){const L=this.executeClientscript1(_,R);if(!_.scriptOperand){return false}const G=_.scriptOperand[R];if(_.scriptComparator[R]===2){if(L>=G){return false}}else if(_.scriptComparator[R]===3){if(L<=G){return false}}else if(_.scriptComparator[R]===4){if(L===G){return false}}else if(L!==G){return false}}return true};drawScrollbar=(_,R,L,G,K)=>{this.imageScrollbar0?.draw(_,R);this.imageScrollbar1?.draw(_,R+K-16);k.fillRect(_,R+16,16,K-32,X.SCROLLBAR_TRACK);let Q=(K-32)*K/G|0;if(Q<8){Q=8}const H=(K-Q-32)*L/(G-K)|0;k.fillRect(_,R+H+16,16,Q,X.SCROLLBAR_GRIP_FOREGROUND);k.drawVerticalLine(_,R+H+16,X.SCROLLBAR_GRIP_HIGHLIGHT,Q);k.drawVerticalLine(_+1,R+H+16,X.SCROLLBAR_GRIP_HIGHLIGHT,Q);k.drawHorizontalLine(_,R+H+16,X.SCROLLBAR_GRIP_HIGHLIGHT,16);k.drawHorizontalLine(_,R+H+17,X.SCROLLBAR_GRIP_HIGHLIGHT,16);k.drawVerticalLine(_+15,R+H+16,X.SCROLLBAR_GRIP_LOWLIGHT,Q);k.drawVerticalLine(_+14,R+H+17,X.SCROLLBAR_GRIP_LOWLIGHT,Q-1);k.drawHorizontalLine(_,R+H+Q+15,X.SCROLLBAR_GRIP_LOWLIGHT,16);k.drawHorizontalLine(_+1,R+H+Q+14,X.SCROLLBAR_GRIP_LOWLIGHT,15)};updateInterfaceAnimation=(_,R)=>{let L=false;const G=g.instances[_];if(!G.childId){return false}for(let K=0;K<G.childId.length&&G.childId[K]!==-1;K++){const Q=g.instances[G.childId[K]];if(Q.type===1){L||=this.updateInterfaceAnimation(Q.id,R)}if(Q.type===6&&(Q.anim!==-1||Q.activeAnim!==-1)){const H=this.executeInterfaceScript(Q);let $;if(H){$=Q.activeAnim}else{$=Q.anim}if($!==-1){const J=G0.instances[$];Q.seqCycle+=R;if(J.delay){while(Q.seqCycle>J.delay[Q.seqFrame]){Q.seqCycle-=J.delay[Q.seqFrame]+1;Q.seqFrame++;if(Q.seqFrame>=J.frameCount){Q.seqFrame-=J.replayoff;if(Q.seqFrame<0||Q.seqFrame>=J.frameCount){Q.seqFrame=0}}L=true}}}}}return L};drawInterface=(_,R,L,G,K=false)=>{if(_.type!==0||!_.childId||_.hide&&this.viewportHoveredInterfaceIndex!==_.id&&this.sidebarHoveredInterfaceIndex!==_.id&&this.chatHoveredInterfaceIndex!==_.id){return}const Q=k.left;const H=k.top;const $=k.right;const J=k.bottom;k.setBounds(R,L,R+_.width,L+_.height);const O=_.childId.length;for(let q=0;q<O;q++){if(!_.childX||!_.childY){continue}let N=_.childX[q]+R;let U=_.childY[q]+L-G;const b=g.instances[_.childId[q]];N+=b.x;U+=b.y;if(K){k.drawRect(N,U,b.width,b.height,X.WHITE)}if(b.clientCode>0){this.updateInterfaceContent(b)}if(b.type===g.TYPE_LAYER){if(b.scrollPosition>b.scroll-b.height){b.scrollPosition=b.scroll-b.height}if(b.scrollPosition<0){b.scrollPosition=0}this.drawInterface(b,N,U,b.scrollPosition,K);if(b.scroll>b.height){this.drawScrollbar(N+b.width,U,b.scrollPosition,b.scroll,b.height)}}else if(b.type===g.TYPE_INV){let I=0;for(let j=0;j<b.height;j++){for(let F=0;F<b.width;F++){if(!b.invSlotOffsetX||!b.invSlotOffsetY||!b.invSlotObjId||!b.invSlotObjCount){continue}let T=N+F*(b.marginX+32);let Y=U+j*(b.marginY+32);if(I<20){T+=b.invSlotOffsetX[I];Y+=b.invSlotOffsetY[I]}if(b.invSlotObjId[I]>0){let u=0;let w=0;const h=b.invSlotObjId[I]-1;if(T>=-32&&T<=512&&Y>=-32&&Y<=334||this.objDragArea!==0&&this.objDragSlot===I){const v=Y0.getIcon(h,b.invSlotObjCount[I]);if(this.objDragArea!==0&&this.objDragSlot===I&&this.objDragInterfaceId===b.id){u=this.mouseX-this.objGrabX;w=this.mouseY-this.objGrabY;if(u<5&&u>-5){u=0}if(w<5&&w>-5){w=0}if(this.objDragCycles<5){u=0;w=0}v.drawAlpha(128,T+u,Y+w)}else if(this.selectedArea!==0&&this.selectedItem===I&&this.selectedInterface===b.id){v.drawAlpha(128,T,Y)}else{v.draw(T,Y)}if(v.cropW===33||b.invSlotObjCount[I]!==1){const n=b.invSlotObjCount[I];this.fontPlain11?.drawString(T+u+1,Y+10+w,this.formatObjCount(n),X.BLACK);this.fontPlain11?.drawString(T+u,Y+9+w,this.formatObjCount(n),X.YELLOW)}}}else if(b.invSlotSprite&&I<20){const u=b.invSlotSprite[I];u?.draw(T,Y)}I++}}}else if(b.type===g.TYPE_RECT){if(b.fill){k.fillRect(N,U,b.width,b.height,b.colour)}else{k.drawRect(N,U,b.width,b.height,b.colour)}}else if(b.type===g.TYPE_TEXT){const I=b.font;let j=b.colour;let F=b.text;if((this.chatHoveredInterfaceIndex===b.id||this.sidebarHoveredInterfaceIndex===b.id||this.viewportHoveredInterfaceIndex===b.id)&&b.overColour!==0){j=b.overColour}if(this.executeInterfaceScript(b)){j=b.activeColour;if(b.activeText&&b.activeText.length>0){F=b.activeText}}if(b.buttonType===g.BUTTON_CONTINUE&&this.pressedContinueOption){F="Please wait...";j=b.colour}if(!I||!F){continue}for(let T=U+I.height;F.length>0;T+=I.height){if(F.indexOf("%")!==-1){do{const w=F.indexOf("%1");if(w===-1){break}F=F.substring(0,w)+this.getIntString(this.executeClientscript1(b,0))+F.substring(w+2)}while(true);do{const w=F.indexOf("%2");if(w===-1){break}F=F.substring(0,w)+this.getIntString(this.executeClientscript1(b,1))+F.substring(w+2)}while(true);do{const w=F.indexOf("%3");if(w===-1){break}F=F.substring(0,w)+this.getIntString(this.executeClientscript1(b,2))+F.substring(w+2)}while(true);do{const w=F.indexOf("%4");if(w===-1){break}F=F.substring(0,w)+this.getIntString(this.executeClientscript1(b,3))+F.substring(w+2)}while(true);do{const w=F.indexOf("%5");if(w===-1){break}F=F.substring(0,w)+this.getIntString(this.executeClientscript1(b,4))+F.substring(w+2)}while(true)}const Y=F.indexOf("\\n");let u;if(Y!==-1){u=F.substring(0,Y);F=F.substring(Y+2)}else{u=F;F=""}if(b.center){I.drawStringTaggableCenter(N+(b.width/2|0),T,u,j,b.shadowed)}else{I.drawStringTaggable(N,T,u,j,b.shadowed)}}}else if(b.type===g.TYPE_GRAPHIC){let I;if(this.executeInterfaceScript(b)){I=b.activeGraphic}else{I=b.graphic}I?.draw(N,U)}else if(b.type===g.TYPE_MODEL){const I=B.centerX;const j=B.centerY;B.centerX=N+(b.width/2|0);B.centerY=U+(b.height/2|0);const F=B.sin[b.xan]*b.zoom>>16;const T=B.cos[b.xan]*b.zoom>>16;const Y=this.executeInterfaceScript(b);let u;if(Y){u=b.activeAnim}else{u=b.anim}let w=null;if(u===-1){w=b.getModel(-1,-1,Y)}else{const h=G0.instances[u];if(h.frames&&h.iframes){w=b.getModel(h.frames[b.seqFrame],h.iframes[b.seqFrame],Y)}}if(w){w.drawSimple(0,b.yan,0,b.xan,0,F,T)}B.centerX=I;B.centerY=j}else if(b.type===g.TYPE_INV_TEXT){const I=b.font;if(!I||!b.invSlotObjId||!b.invSlotObjCount){continue}let j=0;for(let F=0;F<b.height;F++){for(let T=0;T<b.width;T++){if(b.invSlotObjId[j]>0){const Y=Y0.get(b.invSlotObjId[j]-1);let u=Y.name;if(Y.stackable||b.invSlotObjCount[j]!==1){u=u+" x"+this.formatObjCountTagged(b.invSlotObjCount[j])}if(!u){continue}const w=N+T*(b.marginX+115);const h=U+F*(b.marginY+12);if(b.center){I.drawStringTaggableCenter(w+(b.width/2|0),h,u,b.colour,b.shadowed)}else{I.drawStringTaggable(w,h,u,b.colour,b.shadowed)}}j++}}}}k.setBounds(Q,H,$,J)};updateInterfaceContent=(_)=>{let R=_.clientCode;if(R>=g.CC_FRIENDS_START&&R<=g.CC_FRIENDS_END){R--;if(R>=this.friendCount){_.text="";_.buttonType=0}else{_.text=this.friendName[R];_.buttonType=1}}else if(R>=g.CC_FRIENDS_UPDATE_START&&R<=g.CC_FRIENDS_UPDATE_END){R-=g.CC_FRIENDS_UPDATE_START;if(R>=this.friendCount){_.text="";_.buttonType=0}else{if(this.friendWorld[R]===0){_.text="@red@Offline"}else if(this.friendWorld[R]===d.nodeId){_.text="@gre@World-"+(this.friendWorld[R]-9)}else{_.text="@yel@World-"+(this.friendWorld[R]-9)}_.buttonType=1}}else if(R===g.CC_FRIENDS_SIZE){_.scroll=this.friendCount*15+20;if(_.scroll<=_.height){_.scroll=_.height+1}}else if(R>=g.CC_IGNORES_START&&R<=g.CC_IGNORES_END){R-=g.CC_IGNORES_START;if(R>=this.ignoreCount){_.text="";_.buttonType=0}else{_.text=I0.formatName(I0.fromBase37(this.ignoreName37[R]));_.buttonType=1}}else if(R===g.CC_IGNORES_SIZE){_.scroll=this.ignoreCount*15+20;if(_.scroll<=_.height){_.scroll=_.height+1}}else if(R===g.CC_DESIGN_PREVIEW){_.xan=150;_.yan=(Math.sin(this.loopCycle/40)*256|0)&2047;if(this.updateDesignModel){this.updateDesignModel=false;const L=new l(7,null);let G=0;for(let Q=0;Q<7;Q++){const H=this.designIdentikits[Q];if(H>=0){L[G++]=i0.instances[H].getModel()}}const K=E.modelFromModels(L,G);for(let Q=0;Q<5;Q++){if(this.designColors[Q]!==0){K.recolor(U0.DESIGN_IDK_COLORS[Q][0],U0.DESIGN_IDK_COLORS[Q][this.designColors[Q]]);if(Q===1){K.recolor(U0.TORSO_RECOLORS[0],U0.TORSO_RECOLORS[this.designColors[Q]])}}}if(this.localPlayer){const Q=G0.instances[this.localPlayer.seqStandId].frames;if(Q){K.createLabelReferences();K.applyTransform(Q[0]);K.calculateNormals(64,850,-30,-50,-30,true);_.model=K}}}}else if(R===g.CC_SWITCH_TO_MALE){if(!this.genderButtonImage0){this.genderButtonImage0=_.graphic;this.genderButtonImage1=_.activeGraphic}if(this.designGenderMale){_.graphic=this.genderButtonImage1}else{_.graphic=this.genderButtonImage0}}else if(R===g.CC_SWITCH_TO_FEMALE){if(!this.genderButtonImage0){this.genderButtonImage0=_.graphic;this.genderButtonImage1=_.activeGraphic}if(this.designGenderMale){_.graphic=this.genderButtonImage0}else{_.graphic=this.genderButtonImage1}}else if(R===g.CC_REPORT_INPUT){_.text=this.reportAbuseInput;if(this.loopCycle%20<10){_.text=_.text+"|"}else{_.text=_.text+" "}}else if(R===g.CC_MOD_MUTE){if(!this.rights){_.text=""}else if(this.reportAbuseMuteOption){_.colour=X.RED;_.text="Moderator option: Mute player for 48 hours: <ON>"}else{_.colour=X.WHITE;_.text="Moderator option: Mute player for 48 hours: <OFF>"}}else if(R===g.CC_LAST_LOGIN_INFO||R===g.CC_LAST_LOGIN_INFO2){if(this.lastAddress===0){_.text=""}else{let L;if(this.daysSinceLastLogin===0){L="earlier today"}else if(this.daysSinceLastLogin===1){L="yesterday"}else{L=this.daysSinceLastLogin+" days ago"}_.text="You last logged in "+L+" from: "+I0.formatIPv4(this.lastAddress)}}else if(R===g.CC_UNREAD_MESSAGES){if(this.unreadMessages===0){_.text="0 unread messages";_.colour=X.YELLOW}if(this.unreadMessages===1){_.text="1 unread message";_.colour=X.GREEN}if(this.unreadMessages>1){_.text=this.unreadMessages+" unread messages";_.colour=X.GREEN}}else if(R===g.CC_RECOVERY1){if(this.daysSinceRecoveriesChanged===201){_.text=""}else if(this.daysSinceRecoveriesChanged===200){_.text="You have not yet set any password recovery questions."}else{let L;if(this.daysSinceRecoveriesChanged===0){L="Earlier today"}else if(this.daysSinceRecoveriesChanged===1){L="Yesterday"}else{L=this.daysSinceRecoveriesChanged+" days ago"}_.text=L+" you changed your recovery questions"}}else if(R===g.CC_RECOVERY2){if(this.daysSinceRecoveriesChanged===201){_.text=""}else if(this.daysSinceRecoveriesChanged===200){_.text="We strongly recommend you do so now to secure your account."}else{_.text="If you do not remember making this change then cancel it immediately"}}else if(R===g.CC_RECOVERY3){if(this.daysSinceRecoveriesChanged===201){_.text=""}else if(this.daysSinceRecoveriesChanged===200){_.text="Do this from the 'account management' area on our front webpage"}else{_.text="Do this from the 'account management' area on our front webpage"}}};executeClientscript1=(_,R)=>{if(!_.scripts||R>=_.scripts.length){return-2}try{const L=_.scripts[R];if(!L){return-1}let G=0;let K=0;while(true){const Q=L[K++];if(Q===0){return G}if(Q===1){G+=this.skillLevel[L[K++]]}else if(Q===2){G+=this.skillBaseLevel[L[K++]]}else if(Q===3){G+=this.skillExperience[L[K++]]}else if(Q===4){const H=g.instances[L[K++]];const $=L[K++]+1;if(H.invSlotObjId&&H.invSlotObjCount){for(let J=0;J<H.invSlotObjId.length;J++){if(H.invSlotObjId[J]===$){G+=H.invSlotObjCount[J]}}}else{G+=0}}else if(Q===5){G+=this.varps[L[K++]]}else if(Q===6){G+=this.levelExperience[this.skillBaseLevel[L[K++]]-1]}else if(Q===7){G+=this.varps[L[K++]]*100/46875|0}else if(Q===8){G+=this.localPlayer?.combatLevel||0}else if(Q===9){for(let H=0;H<19;H++){if(H===18){H=20}G+=this.skillBaseLevel[H]}}else if(Q===10){const H=g.instances[L[K++]];const $=L[K++]+1;for(let J=0;J<H.invSlotObjId.length;J++){if(H.invSlotObjId[J]===$){G+=999999999;break}}}else if(Q===11){G+=this.energy}else if(Q===12){G+=this.weightCarried}else if(Q===13){const H=this.varps[L[K++]];const $=L[K++];G+=(H&1<<$)===0?0:1}}}catch(L){return-1}};getIntString=(_)=>{return _<999999999?String(_):"*"};formatObjCountTagged=(_)=>{let R=String(_);for(let L=R.length-3;L>0;L-=3){R=R.substring(0,L)+","+R.substring(L)}if(R.length>8){R="@gre@"+R.substring(0,R.length-8)+" million @whi@("+R+")"}else if(R.length>4){R="@cya@"+R.substring(0,R.length-4)+"K @whi@("+R+")"}return" "+R};formatObjCount=(_)=>{if(_<1e5){return String(_)}else if(_<1e7){return(_/1000|0)+"K"}else{return(_/1e6|0)+"M"}};async load(){if(this.isMobile&&d.lowMemory){this.tfps=30}if(this.alreadyStarted){this.errorStarted=true;return}this.alreadyStarted=true;try{await this.showProgress(10,"Connecting to fileserver");this.db=new H8(await H8.openDatabase());const _=new p(new Uint8Array(await T8(`${d.httpAddress}/crc`)));for(let A=0;A<9;A++){this.archiveChecksums[A]=_.g4}if(!d.lowMemory){await this.setMidi("scape_main",12345678,40000,false)}const R=await this.loadArchive("title","title screen",this.archiveChecksums[1],10);this.titleArchive=R;this.fontPlain11=y0.fromArchive(R,"p11");this.fontPlain12=y0.fromArchive(R,"p12");this.fontBold12=y0.fromArchive(R,"b12");this.fontQuill8=y0.fromArchive(R,"q8");await this.loadTitleBackground();this.loadTitleImages();const L=await this.loadArchive("config","config",this.archiveChecksums[2],15);const G=await this.loadArchive("interface","interface",this.archiveChecksums[3],20);const K=await this.loadArchive("media","2d graphics",this.archiveChecksums[4],30);const Q=await this.loadArchive("models","3d graphics",this.archiveChecksums[5],40);const H=await this.loadArchive("textures","textures",this.archiveChecksums[6],60);const $=await this.loadArchive("wordenc","chat system",this.archiveChecksums[7],65);const J=await this.loadArchive("sounds","sound effects",this.archiveChecksums[8],70);this.levelTileFlags=new I1(s.LEVELS,s.SIZE,s.SIZE);this.levelHeightmap=new A1(s.LEVELS,s.SIZE+1,s.SIZE+1);if(this.levelHeightmap){this.scene=new V(this.levelHeightmap,s.SIZE,s.LEVELS,s.SIZE)}for(let A=0;A<s.LEVELS;A++){this.levelCollisionMap[A]=new s}this.imageMinimap=new V0(512,512);await this.showProgress(75,"Unpacking media");this.imageInvback=B0.fromArchive(K,"invback",0);this.imageChatback=B0.fromArchive(K,"chatback",0);this.imageMapback=B0.fromArchive(K,"mapback",0);this.imageBackbase1=B0.fromArchive(K,"backbase1",0);this.imageBackbase2=B0.fromArchive(K,"backbase2",0);this.imageBackhmid1=B0.fromArchive(K,"backhmid1",0);for(let A=0;A<13;A++){this.imageSideicons[A]=B0.fromArchive(K,"sideicons",A)}this.imageCompass=V0.fromArchive(K,"compass",0);try{for(let A=0;A<50;A++){if(A===22){continue}this.imageMapscene[A]=B0.fromArchive(K,"mapscene",A)}}catch(A){}try{for(let A=0;A<50;A++){this.imageMapfunction[A]=V0.fromArchive(K,"mapfunction",A)}}catch(A){}try{for(let A=0;A<20;A++){this.imageHitmarks[A]=V0.fromArchive(K,"hitmarks",A)}}catch(A){}try{for(let A=0;A<20;A++){this.imageHeadicons[A]=V0.fromArchive(K,"headicons",A)}}catch(A){}this.imageMapflag=V0.fromArchive(K,"mapflag",0);for(let A=0;A<8;A++){this.imageCrosses[A]=V0.fromArchive(K,"cross",A)}this.imageMapdot0=V0.fromArchive(K,"mapdots",0);this.imageMapdot1=V0.fromArchive(K,"mapdots",1);this.imageMapdot2=V0.fromArchive(K,"mapdots",2);this.imageMapdot3=V0.fromArchive(K,"mapdots",3);this.imageScrollbar0=B0.fromArchive(K,"scrollbar",0);this.imageScrollbar1=B0.fromArchive(K,"scrollbar",1);this.imageRedstone1=B0.fromArchive(K,"redstone1",0);this.imageRedstone2=B0.fromArchive(K,"redstone2",0);this.imageRedstone3=B0.fromArchive(K,"redstone3",0);this.imageRedstone1h=B0.fromArchive(K,"redstone1",0);this.imageRedstone1h?.flipHorizontally();this.imageRedstone2h=B0.fromArchive(K,"redstone2",0);this.imageRedstone2h?.flipHorizontally();this.imageRedstone1v=B0.fromArchive(K,"redstone1",0);this.imageRedstone1v?.flipVertically();this.imageRedstone2v=B0.fromArchive(K,"redstone2",0);this.imageRedstone2v?.flipVertically();this.imageRedstone3v=B0.fromArchive(K,"redstone3",0);this.imageRedstone3v?.flipVertically();this.imageRedstone1hv=B0.fromArchive(K,"redstone1",0);this.imageRedstone1hv?.flipHorizontally();this.imageRedstone1hv?.flipVertically();this.imageRedstone2hv=B0.fromArchive(K,"redstone2",0);this.imageRedstone2hv?.flipHorizontally();this.imageRedstone2hv?.flipVertically();const O=V0.fromArchive(K,"backleft1",0);this.areaBackleft1=new w0(O.width,O.height);O.blitOpaque(0,0);const q=V0.fromArchive(K,"backleft2",0);this.areaBackleft2=new w0(q.width,q.height);q.blitOpaque(0,0);const N=V0.fromArchive(K,"backright1",0);this.areaBackright1=new w0(N.width,N.height);N.blitOpaque(0,0);const U=V0.fromArchive(K,"backright2",0);this.areaBackright2=new w0(U.width,U.height);U.blitOpaque(0,0);const b=V0.fromArchive(K,"backtop1",0);this.areaBacktop1=new w0(b.width,b.height);b.blitOpaque(0,0);const I=V0.fromArchive(K,"backtop2",0);this.areaBacktop2=new w0(I.width,I.height);I.blitOpaque(0,0);const j=V0.fromArchive(K,"backvmid1",0);this.areaBackvmid1=new w0(j.width,j.height);j.blitOpaque(0,0);const F=V0.fromArchive(K,"backvmid2",0);this.areaBackvmid2=new w0(F.width,F.height);F.blitOpaque(0,0);const T=V0.fromArchive(K,"backvmid3",0);this.areaBackvmid3=new w0(T.width,T.height);T.blitOpaque(0,0);const Y=V0.fromArchive(K,"backhmid2",0);this.areaBackhmid2=new w0(Y.width,Y.height);Y.blitOpaque(0,0);const u=(Math.random()*21|0)-10;const w=(Math.random()*21|0)-10;const h=(Math.random()*21|0)-10;const v=(Math.random()*41|0)-20;for(let A=0;A<50;A++){if(this.imageMapfunction[A]){this.imageMapfunction[A]?.translate(u+v,w+v,h+v)}if(this.imageMapscene[A]){this.imageMapscene[A]?.translate(u+v,w+v,h+v)}}await this.showProgress(80,"Unpacking textures");B.unpackTextures(H);B.setBrightness(0.8);B.initPool(20);await this.showProgress(83,"Unpacking models");E.unpack(Q);B1.unpack(Q);G1.unpack(Q);await this.showProgress(86,"Unpacking config");G0.unpack(L);h0.unpack(L);W0.unpack(L);Y0.unpack(L,d.members);_1.unpack(L);i0.unpack(L);p0.unpack(L);F1.unpack(L);if(!d.lowMemory){await this.showProgress(90,"Unpacking sounds");Z0.unpack(J)}await this.showProgress(92,"Unpacking interfaces");g.unpack(G,K,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]);await this.showProgress(97,"Preparing game engine");for(let A=0;A<33;A++){let P=999;let z=0;for(let f=0;f<35;f++){if(this.imageMapback.pixels[f+A*this.imageMapback.width]===0){if(P===999){P=f}}else if(P!==999){z=f;break}}this.compassMaskLineOffsets[A]=P;this.compassMaskLineLengths[A]=z-P}for(let A=9;A<160;A++){let P=999;let z=0;for(let f=10;f<168;f++){if(this.imageMapback.pixels[f+A*this.imageMapback.width]===0&&(f>34||A>34)){if(P===999){P=f}}else if(P!==999){z=f;break}}this.minimapMaskLineOffsets[A-9]=P-21;this.minimapMaskLineLengths[A-9]=z-P}B.init3D(479,96);this.areaChatbackOffsets=B.lineOffset;B.init3D(190,261);this.areaSidebarOffsets=B.lineOffset;B.init3D(512,334);this.areaViewportOffsets=B.lineOffset;const n=new Int32Array(9);for(let A=0;A<9;A++){const P=A*32+128+15;const z=P*3+600;const f=B.sin[P];n[A]=z*f>>16}V.init(512,334,500,800,n);k1.unpack($);this.initializeLevelExperience()}catch(_){this.errorLoading=true}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost){return}this.loopCycle++;if(this.ingame){await this.updateGame()}else{await this.updateTitleScreen()}}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.ingame){this.drawGame()}else{await this.drawTitleScreen()}this.dragCycles=0}async refresh(){this.redrawTitleBackground=true}showProgress=async(_,R)=>{await this.loadTitle();if(!this.titleArchive){await super.showProgress(_,R);return}this.imageTitle4?.bind();const L=360;const G=200;const K=20;this.fontBold12?.drawStringCenter(L/2|0,(G/2|0)-K-26,"RuneScape is loading - please wait...",X.WHITE);const Q=(G/2|0)-18-K;k.drawRect((L/2|0)-152,Q,304,34,X.PROGRESS_RED);k.drawRect((L/2|0)-151,Q+1,302,32,X.BLACK);k.fillRect((L/2|0)-150,Q+2,_*3,30,X.PROGRESS_RED);k.fillRect((L/2|0)-150+_*3,Q+2,300-_*3,30,X.BLACK);this.fontBold12?.drawStringCenter(L/2|0,(G/2|0)+5-K,R,X.WHITE);this.imageTitle4?.draw(214,186);if(this.redrawTitleBackground){this.redrawTitleBackground=false;if(!this.flameActive){this.imageTitle0?.draw(0,0);this.imageTitle1?.draw(661,0)}this.imageTitle2?.draw(128,0);this.imageTitle3?.draw(214,386);this.imageTitle5?.draw(0,265);this.imageTitle6?.draw(574,265);this.imageTitle7?.draw(128,186);this.imageTitle8?.draw(574,186)}await q1(5)};runFlames=()=>{if(!this.flameActive){return}this.updateFlames();this.updateFlames();this.drawFlames()};loadTitle=async()=>{if(!this.imageTitle2){this.drawArea=null;this.areaChatback=null;this.areaMapback=null;this.areaSidebar=null;this.areaViewport=null;this.areaBackbase1=null;this.areaBackbase2=null;this.areaBackhmid1=null;this.imageTitle0=new w0(128,265);k.clear();this.imageTitle1=new w0(128,265);k.clear();this.imageTitle2=new w0(533,186);k.clear();this.imageTitle3=new w0(360,146);k.clear();this.imageTitle4=new w0(360,200);k.clear();this.imageTitle5=new w0(214,267);k.clear();this.imageTitle6=new w0(215,267);k.clear();this.imageTitle7=new w0(86,79);k.clear();this.imageTitle8=new w0(87,79);k.clear();if(this.titleArchive){await this.loadTitleBackground();this.loadTitleImages()}this.redrawTitleBackground=true}};loadTitleBackground=async()=>{if(!this.titleArchive){return}const _=await V0.fromJpeg(this.titleArchive,"title");this.imageTitle0?.bind();_.blitOpaque(0,0);this.imageTitle1?.bind();_.blitOpaque(-661,0);this.imageTitle2?.bind();_.blitOpaque(-128,0);this.imageTitle3?.bind();_.blitOpaque(-214,-386);this.imageTitle4?.bind();_.blitOpaque(-214,-186);this.imageTitle5?.bind();_.blitOpaque(0,-265);this.imageTitle6?.bind();_.blitOpaque(-128,-186);this.imageTitle7?.bind();_.blitOpaque(-128,-186);this.imageTitle8?.bind();_.blitOpaque(-574,-186);_.flipHorizontally();this.imageTitle0?.bind();_.blitOpaque(394,0);this.imageTitle1?.bind();_.blitOpaque(-267,0);this.imageTitle2?.bind();_.blitOpaque(266,0);this.imageTitle3?.bind();_.blitOpaque(180,-386);this.imageTitle4?.bind();_.blitOpaque(180,-186);this.imageTitle5?.bind();_.blitOpaque(394,-265);this.imageTitle6?.bind();_.blitOpaque(-180,-265);this.imageTitle7?.bind();_.blitOpaque(212,-186);this.imageTitle8?.bind();_.blitOpaque(-180,-186);const R=V0.fromArchive(this.titleArchive,"logo");this.imageTitle2?.bind();R.draw((this.width/2|0)-(R.width/2|0)-128,18)};updateFlameBuffer=(_)=>{if(!this.flameBuffer0||!this.flameBuffer1){return}const R=256;this.flameBuffer0.fill(0);for(let L=0;L<5000;L++){const G=Math.random()*128*R|0;this.flameBuffer0[G]=Math.random()*256|0}for(let L=0;L<20;L++){for(let K=1;K<R-1;K++){for(let Q=1;Q<127;Q++){const H=Q+(K<<7);this.flameBuffer1[H]=(this.flameBuffer0[H-1]+this.flameBuffer0[H+1]+this.flameBuffer0[H-128]+this.flameBuffer0[H+128])/4|0}}const G=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1;this.flameBuffer1=G}if(_){let L=0;for(let G=0;G<_.height;G++){for(let K=0;K<_.width;K++){if(_.pixels[L++]!==0){const Q=K+_.cropX+16;const H=G+_.cropY+16;const $=Q+(H<<7);this.flameBuffer0[$]=0}}}}};loadTitleImages=()=>{if(!this.titleArchive){return}this.imageTitlebox=B0.fromArchive(this.titleArchive,"titlebox");this.imageTitlebutton=B0.fromArchive(this.titleArchive,"titlebutton");for(let _=0;_<12;_++){this.imageRunes[_]=B0.fromArchive(this.titleArchive,"runes",_)}this.imageFlamesLeft=new V0(128,265);this.imageFlamesRight=new V0(128,265);if(this.imageTitle0)z5(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)z5(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let _=0;_<64;_++){this.flameGradient0[_]=_*262144}for(let _=0;_<64;_++){this.flameGradient0[_+64]=_*1024+X.RED}for(let _=0;_<64;_++){this.flameGradient0[_+128]=_*4+X.YELLOW}for(let _=0;_<64;_++){this.flameGradient0[_+192]=X.WHITE}this.flameGradient1=new Int32Array(256);for(let _=0;_<64;_++){this.flameGradient1[_]=_*1024}for(let _=0;_<64;_++){this.flameGradient1[_+64]=_*4+X.GREEN}for(let _=0;_<64;_++){this.flameGradient1[_+128]=_*262144+X.CYAN}for(let _=0;_<64;_++){this.flameGradient1[_+192]=X.WHITE}this.flameGradient2=new Int32Array(256);for(let _=0;_<64;_++){this.flameGradient2[_]=_*4}for(let _=0;_<64;_++){this.flameGradient2[_+64]=_*262144+X.BLUE}for(let _=0;_<64;_++){this.flameGradient2[_+128]=_*1024+X.MAGENTA}for(let _=0;_<64;_++){this.flameGradient2[_+192]=X.WHITE}this.flameGradient=new Int32Array(256);this.flameBuffer0=new Int32Array(32768);this.flameBuffer1=new Int32Array(32768);this.updateFlameBuffer(null);this.flameBuffer3=new Int32Array(32768);this.flameBuffer2=new Int32Array(32768);this.showProgress(10,"Connecting to fileserver").then(()=>{if(!this.flameActive){this.flameActive=true;this.flamesInterval=setInterval(this.runFlames,35)}})};updateTitleScreen=async()=>{if(this.titleScreenState===0){let _=(this.width/2|0)-80;let R=(this.height/2|0)+20;R+=20;if(this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20){this.titleScreenState=3;this.titleLoginField=0}_=(this.width/2|0)+80;if(this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20){this.loginMessage0="";this.loginMessage1="Enter your username & password.";this.titleScreenState=2;this.titleLoginField=0}}else if(this.titleScreenState===2){let _=(this.height/2|0)-40;_+=30;_+=25;if(this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_){this.titleLoginField=0}_+=15;if(this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_){this.titleLoginField=1}let R=(this.width/2|0)-80;let L=(this.height/2|0)+50;L+=20;if(this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=L-20&&this.mouseClickY<=L+20){await this.login(this.username,this.password,false)}R=(this.width/2|0)+80;if(this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=L-20&&this.mouseClickY<=L+20){this.titleScreenState=0;this.username="";this.password=""}while(true){const G=this.pollKey();if(G===-1){return}let K=false;for(let Q=0;Q<y0.CHARSET.length;Q++){if(String.fromCharCode(G)===y0.CHARSET.charAt(Q)){K=true;break}}if(this.titleLoginField===0){if(G===8&&this.username.length>0){this.username=this.username.substring(0,this.username.length-1)}if(G===9||G===10||G===13){this.titleLoginField=1}if(K){this.username=this.username+String.fromCharCode(G)}if(this.username.length>12){this.username=this.username.substring(0,12)}}else if(this.titleLoginField===1){if(G===8&&this.password.length>0){this.password=this.password.substring(0,this.password.length-1)}if(G===9||G===10||G===13){this.titleLoginField=0}if(K){this.password=this.password+String.fromCharCode(G)}if(this.password.length>20){this.password=this.password.substring(0,20)}}}}else if(this.titleScreenState===3){const _=this.width/2|0;let R=(this.height/2|0)+50;R+=20;if(this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20){this.titleScreenState=0}}};drawTitleScreen=async()=>{await this.loadTitle();this.imageTitle4?.bind();this.imageTitlebox?.draw(0,0);const _=360;const R=200;if(this.titleScreenState===0){let L=_/2|0;let G=(R/2|0)-20;this.fontBold12?.drawStringTaggableCenter(L,G,"Welcome to RuneScape",X.YELLOW,true);L=(_/2|0)-80;G=(R/2|0)+20;this.imageTitlebutton?.draw(L-73,G-20);this.fontBold12?.drawStringTaggableCenter(L,G+5,"New user",X.WHITE,true);L=(_/2|0)+80;this.imageTitlebutton?.draw(L-73,G-20);this.fontBold12?.drawStringTaggableCenter(L,G+5,"Existing User",X.WHITE,true)}else if(this.titleScreenState===2){let L=(_/2|0)-80;let G=(R/2|0)-40;if(this.loginMessage0.length>0){this.fontBold12?.drawStringTaggableCenter(_/2,G-15,this.loginMessage0,X.YELLOW,true);this.fontBold12?.drawStringTaggableCenter(_/2,G,this.loginMessage1,X.YELLOW,true);G+=30}else{this.fontBold12?.drawStringTaggableCenter(_/2,G-7,this.loginMessage1,X.YELLOW,true);G+=30}this.fontBold12?.drawStringTaggable(_/2-90,G,`Username: ${this.username}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,X.WHITE,true);G+=15;this.fontBold12?.drawStringTaggable(_/2-88,G,`Password: ${I0.toAsterisks(this.password)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,X.WHITE,true);G=(R/2|0)+50;this.imageTitlebutton?.draw(L-73,G-20);this.fontBold12?.drawStringTaggableCenter(L,G+5,"Login",X.WHITE,true);L=(_/2|0)+80;this.imageTitlebutton?.draw(L-73,G-20);this.fontBold12?.drawStringTaggableCenter(L,G+5,"Cancel",X.WHITE,true)}else if(this.titleScreenState===3){this.fontBold12?.drawStringTaggableCenter(_/2,R/2-60,"Create a free account",X.YELLOW,true);const L=_/2|0;let G=(R/2|0)-35;this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"To create a new account you need to",X.WHITE,true);G+=15;this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"go back to the main RuneScape webpage",X.WHITE,true);G+=15;this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"and choose the red 'create account'",X.WHITE,true);G+=15;this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"button at the top right of that page.",X.WHITE,true);G=(R/2|0)+50;this.imageTitlebutton?.draw(L-73,G-20);this.fontBold12?.drawStringTaggableCenter(L,G+5,"Cancel",X.WHITE,true)}this.imageTitle4?.draw(214,186);if(this.redrawTitleBackground){this.redrawTitleBackground=false;this.imageTitle2?.draw(128,0);this.imageTitle3?.draw(214,386);this.imageTitle5?.draw(0,265);this.imageTitle6?.draw(574,265);this.imageTitle7?.draw(128,186);this.imageTitle8?.draw(574,186)}};login=async(_,R,L)=>{try{if(!L){this.loginMessage0="";this.loginMessage1="Connecting to server...";await this.drawTitleScreen()}this.stream=new Q8(await Q8.openSocket({host:d.serverAddress,port:43594+d.portOffset}));await this.stream.readBytes(this.in.data,0,8);this.in.pos=0;this.serverSeed=this.in.g8;const G=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);this.out.pos=0;this.out.p1(10);this.out.p4(G[0]);this.out.p4(G[1]);this.out.p4(G[2]);this.out.p4(G[3]);this.out.p4(0);this.out.pjstr(_);this.out.pjstr(R);this.out.rsaenc(d.modulus,d.exponent);this.loginout.pos=0;if(L){this.loginout.p1(18)}else{this.loginout.p1(16)}this.loginout.p1(this.out.pos+36+1+1);this.loginout.p1(d.clientversion);this.loginout.p1(d.lowMemory?1:0);for(let Q=0;Q<9;Q++){this.loginout.p4(this.archiveChecksums[Q])}this.loginout.pdata(this.out.data,this.out.pos,0);this.out.random=new $8(G);for(let Q=0;Q<4;Q++){G[Q]+=50}this.randomIn=new $8(G);this.stream?.write(this.loginout.data,this.loginout.pos);const K=await this.stream.read();if(K===1){await q1(2000);await this.login(_,R,L);return}if(K===2||K===18){this.rights=K===18;S0.setDisabled();this.ingame=true;this.out.pos=0;this.in.pos=0;this.packetType=-1;this.lastPacketType0=-1;this.lastPacketType1=-1;this.lastPacketType2=-1;this.packetSize=0;this.idleNetCycles=0;this.systemUpdateTimer=0;this.idleTimeout=0;this.hintType=0;this.menuSize=0;this.menuVisible=false;this.idleCycles=Date.now();for(let Q=0;Q<100;Q++){this.messageText[Q]=null}this.objSelected=0;this.spellSelected=0;this.sceneState=0;this.waveCount=0;this.cameraAnticheatOffsetX=(Math.random()*100|0)-50;this.cameraAnticheatOffsetZ=(Math.random()*110|0)-55;this.cameraAnticheatAngle=(Math.random()*80|0)-40;this.minimapAnticheatAngle=(Math.random()*120|0)-60;this.minimapZoom=(Math.random()*30|0)-20;this.orbitCameraYaw=(Math.random()*20|0)-10&2047;this.minimapLevel=-1;this.flagSceneTileX=0;this.flagSceneTileZ=0;this.playerCount=0;this.npcCount=0;for(let Q=0;Q<this.MAX_PLAYER_COUNT;Q++){this.players[Q]=null;this.playerAppearanceBuffer[Q]=null}for(let Q=0;Q<8192;Q++){this.npcs[Q]=null}this.localPlayer=this.players[this.LOCAL_PLAYER_INDEX]=new U0;this.projectiles.clear();this.spotanims.clear();this.temporaryLocs.clear();for(let Q=0;Q<s.LEVELS;Q++){for(let H=0;H<s.SIZE;H++){for(let $=0;$<s.SIZE;$++){this.levelObjStacks[Q][H][$]=null}}}this.spawnedLocations=new g0;this.friendCount=0;this.stickyChatInterfaceId=-1;this.chatInterfaceId=-1;this.viewportInterfaceId=-1;this.sidebarInterfaceId=-1;this.pressedContinueOption=false;this.selectedTab=3;this.chatbackInputOpen=false;this.menuVisible=false;this.showSocialInput=false;this.modalMessage=null;this.inMultizone=0;this.flashingTab=-1;this.designGenderMale=true;this.validateCharacterDesign();for(let Q=0;Q<5;Q++){this.designColors[Q]=0}D8(true);d.oplogic1=0;d.oplogic2=0;d.oplogic3=0;d.oplogic4=0;d.oplogic5=0;d.oplogic6=0;d.oplogic7=0;d.oplogic8=0;d.oplogic9=0;this.prepareGameScreen();return}if(K===3){this.loginMessage0="";this.loginMessage1="Invalid username or password.";return}if(K===4){this.loginMessage0="Your account has been disabled.";this.loginMessage1="Please check your message-centre for details.";return}if(K===5){this.loginMessage0="Your account is already logged in.";this.loginMessage1="Try again in 60 secs...";return}if(K===6){this.loginMessage0="RuneScape has been updated!";this.loginMessage1="Please reload this page.";return}if(K===7){this.loginMessage0="This world is full.";this.loginMessage1="Please use a different world.";return}if(K===8){this.loginMessage0="Unable to connect.";this.loginMessage1="Login server offline.";return}if(K===9){this.loginMessage0="Login limit exceeded.";this.loginMessage1="Too many connections from your address.";return}if(K===10){this.loginMessage0="Unable to connect.";this.loginMessage1="Bad session id.";return}if(K===11){this.loginMessage1="Login server rejected session.";this.loginMessage1="Please try again.";return}if(K===12){this.loginMessage0="You need a members account to login to this world.";this.loginMessage1="Please subscribe, or use a different world.";return}if(K===13){this.loginMessage0="Could not complete login.";this.loginMessage1="Please try using a different world.";return}if(K===14){this.loginMessage0="The server is being updated.";this.loginMessage1="Please wait 1 minute and try again.";return}if(K===15){this.ingame=true;this.out.pos=0;this.in.pos=0;this.packetType=-1;this.lastPacketType0=-1;this.lastPacketType1=-1;this.lastPacketType2=-1;this.packetSize=0;this.idleNetCycles=0;this.systemUpdateTimer=0;this.menuSize=0;this.menuVisible=false;return}if(K===16){this.loginMessage0="Login attempts exceeded.";this.loginMessage1="Please wait 1 minute and try again.";return}if(K===17){this.loginMessage0="You are standing in a members-only area.";this.loginMessage1="To play on this world move to a free area first"}}catch(G){this.loginMessage0="";this.loginMessage1="Error connecting to server."}};updateGame=async()=>{if(this.players===null){return}if(this.systemUpdateTimer>1){this.systemUpdateTimer--}if(this.idleTimeout>0){this.idleTimeout--}for(let _=0;_<5&&await this.read();_++){}if(this.ingame){for(let R=0;R<this.waveCount;R++){if(this.waveDelay[R]<=0){try{const L=Z0.generate(this.waveIds[R],this.waveLoops[R]);if(!L){throw new Error}if(Date.now()+(L.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0)){this.lastWaveLength=L.pos;this.lastWaveStartTime=Date.now();this.lastWaveId=this.waveIds[R];this.lastWaveLoops=this.waveLoops[R];await T6(L.data.slice(0,L.pos),this.waveVolume)}}catch(L){}this.waveCount--;for(let L=R;L<this.waveCount;L++){this.waveIds[L]=this.waveIds[L+1];this.waveLoops[L]=this.waveLoops[L+1];this.waveDelay[L]=this.waveDelay[L+1]}R--}else{this.waveDelay[R]--}}if(this.nextMusicDelay>0){this.nextMusicDelay-=20;if(this.nextMusicDelay<0){this.nextMusicDelay=0}if(this.nextMusicDelay===0&&this.midiActive&&!d.lowMemory&&this.currentMidi){await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,false)}}const _=S0.flush();if(_){this.out.p1isaac(c.EVENT_TRACKING);this.out.p2(_.pos);this.out.pdata(_.data,_.pos,0);_.release()}this.idleNetCycles++;if(this.idleNetCycles>750){await this.tryReconnect()}this.updatePlayers();this.updateNpcs();this.updateEntityChats();this.updateTemporaryLocs();if((this.actionKey[1]===1||this.actionKey[2]===1||this.actionKey[3]===1||this.actionKey[4]===1)&&this.cameraMovedWrite++>5){this.cameraMovedWrite=0;this.out.p1isaac(c.EVENT_CAMERA_POSITION);this.out.p2(this.orbitCameraPitch);this.out.p2(this.orbitCameraYaw);this.out.p1(this.minimapAnticheatAngle);this.out.p1(this.minimapZoom)}this.sceneDelta++;if(this.crossMode!==0){this.crossCycle+=20;if(this.crossCycle>=400){this.crossMode=0}}if(this.selectedArea!==0){this.selectedCycle++;if(this.selectedCycle>=15){if(this.selectedArea===2){this.redrawSidebar=true}if(this.selectedArea===3){this.redrawChatback=true}this.selectedArea=0}}if(this.objDragArea!==0){this.objDragCycles++;if(this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5){this.objGrabThreshold=true}if(this.mouseButton===0){if(this.objDragArea===2){this.redrawSidebar=true}if(this.objDragArea===3){this.redrawChatback=true}this.objDragArea=0;if(this.objGrabThreshold&&this.objDragCycles>=5){this.hoveredSlotParentId=-1;this.handleInput();if(this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){const R=g.instances[this.objDragInterfaceId];if(R.invSlotObjId){const L=R.invSlotObjId[this.hoveredSlot];R.invSlotObjId[this.hoveredSlot]=R.invSlotObjId[this.objDragSlot];R.invSlotObjId[this.objDragSlot]=L}if(R.invSlotObjCount){const L=R.invSlotObjCount[this.hoveredSlot];R.invSlotObjCount[this.hoveredSlot]=R.invSlotObjCount[this.objDragSlot];R.invSlotObjCount[this.objDragSlot]=L}this.out.p1isaac(c.INV_BUTTOND);this.out.p2(this.objDragInterfaceId);this.out.p2(this.objDragSlot);this.out.p2(this.hoveredSlot)}}else if((this.mouseButtonsOption===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2){this.showContextMenu()}else if(this.menuSize>0){await this.useMenuOption(this.menuSize-1)}this.selectedCycle=10;this.mouseClickButton=0}}d.cyclelogic3++;if(d.cyclelogic3>127){d.cyclelogic3=0;this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC3);this.out.p3(4991788)}if(V.clickTileX!==-1){if(this.localPlayer){const R=V.clickTileX;const L=V.clickTileZ;const G=this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],R,L,0,0,0,0,0,0,true);V.clickTileX=-1;if(G){this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=1;this.crossCycle=0}}}if(this.mouseClickButton===1&&this.modalMessage){this.modalMessage=null;this.redrawChatback=true;this.mouseClickButton=0}await this.handleMouseInput();this.handleMinimapInput();this.handleTabInput();this.handleChatSettingsInput();if(this.mouseButton===1||this.mouseClickButton===1){this.dragCycles++}if(this.sceneState===2){this.updateOrbitCamera()}if(this.sceneState===2&&this.cutscene){this.applyCutscene()}for(let R=0;R<5;R++){this.cameraModifierCycle[R]++}await this.handleInputKey();if(Date.now()-this.idleCycles>90000){this.idleTimeout=250;this.idleCycles=Date.now()-1e4;this.out.p1isaac(c.IDLE_TIMER)}this.cameraOffsetCycle++;if(this.cameraOffsetCycle>500){this.cameraOffsetCycle=0;const R=Math.random()*8|0;if((R&1)===1){this.cameraAnticheatOffsetX+=this.cameraOffsetXModifier}if((R&2)===2){this.cameraAnticheatOffsetZ+=this.cameraOffsetZModifier}if((R&4)===4){this.cameraAnticheatAngle+=this.cameraOffsetYawModifier}}if(this.cameraAnticheatOffsetX<-50){this.cameraOffsetXModifier=2}if(this.cameraAnticheatOffsetX>50){this.cameraOffsetXModifier=-2}if(this.cameraAnticheatOffsetZ<-55){this.cameraOffsetZModifier=2}if(this.cameraAnticheatOffsetZ>55){this.cameraOffsetZModifier=-2}if(this.cameraAnticheatAngle<-40){this.cameraOffsetYawModifier=1}if(this.cameraAnticheatAngle>40){this.cameraOffsetYawModifier=-1}this.minimapOffsetCycle++;if(this.minimapOffsetCycle>500){this.minimapOffsetCycle=0;const R=Math.random()*8|0;if((R&1)===1){this.minimapAnticheatAngle+=this.minimapAngleModifier}if((R&2)===2){this.minimapZoom+=this.minimapZoomModifier}}if(this.minimapAnticheatAngle<-60){this.minimapAngleModifier=2}if(this.minimapAnticheatAngle>60){this.minimapAngleModifier=-2}if(this.minimapZoom<-20){this.minimapZoomModifier=1}if(this.minimapZoom>10){this.minimapZoomModifier=-1}d.cyclelogic4++;if(d.cyclelogic4>110){d.cyclelogic4=0;this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC4);this.out.p4(0)}this.heartbeatTimer++;if(this.heartbeatTimer>50){this.out.p1isaac(c.NO_TIMEOUT)}try{if(this.stream&&this.out.pos>0){this.stream.write(this.out.data,this.out.pos);this.out.pos=0;this.heartbeatTimer=0}}catch(R){await this.tryReconnect()}}};drawGame=()=>{if(this.players===null){return}if(this.redrawTitleBackground){this.redrawTitleBackground=false;this.areaBackleft1?.draw(0,11);this.areaBackleft2?.draw(0,375);this.areaBackright1?.draw(729,5);this.areaBackright2?.draw(752,231);this.areaBacktop1?.draw(0,0);this.areaBacktop2?.draw(561,0);this.areaBackvmid1?.draw(520,11);this.areaBackvmid2?.draw(520,231);this.areaBackvmid3?.draw(501,375);this.areaBackhmid2?.draw(0,345);this.redrawSidebar=true;this.redrawChatback=true;this.redrawSideicons=true;this.redrawPrivacySettings=true;if(this.sceneState!==2){this.areaViewport?.draw(8,11);this.areaMapback?.draw(561,5)}}if(this.sceneState===2){this.drawScene()}if(this.menuVisible&&this.menuArea===1){this.redrawSidebar=true}let _=false;if(this.sidebarInterfaceId!==-1){_=this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta);if(_){this.redrawSidebar=true}}if(this.selectedArea===2){this.redrawSidebar=true}if(this.objDragArea===2){this.redrawSidebar=true}if(this.redrawSidebar){this.drawSidebar();this.redrawSidebar=false}if(this.chatInterfaceId===-1){this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77;if(this.mouseX>453&&this.mouseX<565&&this.mouseY>350){this.handleScrollInput(this.mouseX-22,this.mouseY-375,this.chatScrollHeight,77,false,463,0,this.chatInterface)}let R=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(R<0){R=0}if(R>this.chatScrollHeight-77){R=this.chatScrollHeight-77}if(this.chatScrollOffset!==R){this.chatScrollOffset=R;this.redrawChatback=true}}if(this.chatInterfaceId!==-1){_=this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta);if(_){this.redrawChatback=true}}if(this.selectedArea===3){this.redrawChatback=true}if(this.objDragArea===3){this.redrawChatback=true}if(this.modalMessage){this.redrawChatback=true}if(this.menuVisible&&this.menuArea===2){this.redrawChatback=true}if(this.redrawChatback){this.drawChatback();this.redrawChatback=false}if(this.sceneState===2){this.drawMinimap();this.areaMapback?.draw(561,5)}if(this.flashingTab!==-1){this.redrawSideicons=true}if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab){this.flashingTab=-1;this.out.p1isaac(c.TUTORIAL_CLICKSIDE);this.out.p1(this.selectedTab)}this.redrawSideicons=false;this.areaBackhmid1?.bind();this.imageBackhmid1?.draw(0,0);if(this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0){this.imageRedstone1?.draw(29,30)}else if(this.selectedTab===1){this.imageRedstone2?.draw(59,29)}else if(this.selectedTab===2){this.imageRedstone2?.draw(87,29)}else if(this.selectedTab===3){this.imageRedstone3?.draw(115,29)}else if(this.selectedTab===4){this.imageRedstone2h?.draw(156,29)}else if(this.selectedTab===5){this.imageRedstone2h?.draw(184,29)}else if(this.selectedTab===6){this.imageRedstone1h?.draw(212,30)}}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10)){this.imageSideicons[0]?.draw(35,34)}if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10)){this.imageSideicons[1]?.draw(59,32)}if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10)){this.imageSideicons[2]?.draw(86,32)}if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10)){this.imageSideicons[3]?.draw(121,33)}if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10)){this.imageSideicons[4]?.draw(157,34)}if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10)){this.imageSideicons[5]?.draw(185,32)}if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10)){this.imageSideicons[6]?.draw(212,34)}}this.areaBackhmid1?.draw(520,165);this.areaBackbase2?.bind();this.imageBackbase2?.draw(0,0);if(this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7){this.imageRedstone1v?.draw(49,0)}else if(this.selectedTab===8){this.imageRedstone2v?.draw(81,0)}else if(this.selectedTab===9){this.imageRedstone2v?.draw(108,0)}else if(this.selectedTab===10){this.imageRedstone3v?.draw(136,1)}else if(this.selectedTab===11){this.imageRedstone2hv?.draw(178,0)}else if(this.selectedTab===12){this.imageRedstone2hv?.draw(205,0)}else if(this.selectedTab===13){this.imageRedstone1hv?.draw(233,0)}}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10)){this.imageSideicons[7]?.draw(80,2)}if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10)){this.imageSideicons[8]?.draw(107,3)}if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10)){this.imageSideicons[9]?.draw(142,4)}if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10)){this.imageSideicons[10]?.draw(179,2)}if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10)){this.imageSideicons[11]?.draw(206,2)}if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10)){this.imageSideicons[12]?.draw(230,2)}}this.areaBackbase2?.draw(501,492);this.areaViewport?.bind()}if(this.redrawPrivacySettings){this.redrawPrivacySettings=false;this.areaBackbase1?.bind();this.imageBackbase1?.draw(0,0);this.fontPlain12?.drawStringTaggableCenter(57,33,"Public chat",X.WHITE,true);if(this.publicChatSetting===0){this.fontPlain12?.drawStringTaggableCenter(57,46,"On",X.GREEN,true)}if(this.publicChatSetting===1){this.fontPlain12?.drawStringTaggableCenter(57,46,"Friends",X.YELLOW,true)}if(this.publicChatSetting===2){this.fontPlain12?.drawStringTaggableCenter(57,46,"Off",X.RED,true)}if(this.publicChatSetting===3){this.fontPlain12?.drawStringTaggableCenter(57,46,"Hide",X.CYAN,true)}this.fontPlain12?.drawStringTaggableCenter(186,33,"Private chat",X.WHITE,true);if(this.privateChatSetting===0){this.fontPlain12?.drawStringTaggableCenter(186,46,"On",X.GREEN,true)}if(this.privateChatSetting===1){this.fontPlain12?.drawStringTaggableCenter(186,46,"Friends",X.YELLOW,true)}if(this.privateChatSetting===2){this.fontPlain12?.drawStringTaggableCenter(186,46,"Off",X.RED,true)}this.fontPlain12?.drawStringTaggableCenter(326,33,"Trade/duel",X.WHITE,true);if(this.tradeChatSetting===0){this.fontPlain12?.drawStringTaggableCenter(326,46,"On",X.GREEN,true)}if(this.tradeChatSetting===1){this.fontPlain12?.drawStringTaggableCenter(326,46,"Friends",X.YELLOW,true)}if(this.tradeChatSetting===2){this.fontPlain12?.drawStringTaggableCenter(326,46,"Off",X.RED,true)}this.fontPlain12?.drawStringTaggableCenter(462,38,"Report abuse",X.WHITE,true);this.areaBackbase1?.draw(0,471);this.areaViewport?.bind()}this.sceneDelta=0};drawScene=()=>{this.sceneCycle++;this.pushPlayers();this.pushNpcs();this.pushProjectiles();this.pushSpotanims();this.pushLocs();if(!this.cutscene){let $=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>$){$=this.cameraPitchClamp/256|0}if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>$){$=this.cameraModifierWobbleScale[4]+128}const J=this.orbitCameraYaw+this.cameraAnticheatAngle&2047;if(this.localPlayer){this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,J,$,$*3+600)}d.cyclelogic2++;if(d.cyclelogic2>1802){d.cyclelogic2=0;this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC2);this.out.p1(0);const O=this.out.pos;this.out.p2(29711);this.out.p1(70);this.out.p1(Math.random()*256|0);this.out.p1(242);this.out.p1(186);this.out.p1(39);this.out.p1(61);if((Math.random()*2|0)===0){this.out.p1(13)}if((Math.random()*2|0)===0){this.out.p2(57856)}this.out.p2(Math.random()*65536|0);this.out.psize1(this.out.pos-O)}}let _;if(this.cutscene){_=this.getTopLevelCutscene()}else{_=this.getTopLevel()}const R=this.cameraX;const L=this.cameraY;const G=this.cameraZ;const K=this.cameraPitch;const Q=this.cameraYaw;let H;for(let $=0;$<5;$++){if(this.cameraModifierEnabled[$]){H=Math.random()*(this.cameraModifierJitter[$]*2+1)-this.cameraModifierJitter[$]+Math.sin(this.cameraModifierCycle[$]*(this.cameraModifierWobbleSpeed[$]/100))*this.cameraModifierWobbleScale[$]|0;if($===0){this.cameraX+=H}if($===1){this.cameraY+=H}if($===2){this.cameraZ+=H}if($===3){this.cameraYaw=this.cameraYaw+H&2047}if($===4){this.cameraPitch+=H;if(this.cameraPitch<128){this.cameraPitch=128}if(this.cameraPitch>383){this.cameraPitch=383}}}}H=B.cycle;E.checkHover=true;E.pickedCount=0;E.mouseX=this.mouseX-8;E.mouseY=this.mouseY-11;k.clear();this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,_,this.cameraYaw,this.cameraPitch,this.loopCycle);this.scene?.clearTemporaryLocs();this.draw2DEntityElements();this.updateTextures(H);this.draw3DEntityElements();this.areaViewport?.draw(8,11);this.cameraX=R;this.cameraY=L;this.cameraZ=G;this.cameraPitch=K;this.cameraYaw=Q};clearCaches=()=>{h0.modelCacheStatic?.clear();h0.modelCacheDynamic?.clear();_1.modelCache?.clear();Y0.modelCache?.clear();Y0.iconCache?.clear();U0.modelCache?.clear();p0.modelCache?.clear()};projectFromEntity=(_,R)=>{this.projectFromGround(_.x,R,_.z)};projectFromGround=(_,R,L)=>{if(_<128||L<128||_>13056||L>13056){this.projectX=-1;this.projectY=-1;return}const G=this.getHeightmapY(this.currentLevel,_,L)-R;this.project(_,G,L)};project=(_,R,L)=>{let G=_-this.cameraX;let K=R-this.cameraY;let Q=L-this.cameraZ;const H=B.sin[this.cameraPitch];const $=B.cos[this.cameraPitch];const J=B.sin[this.cameraYaw];const O=B.cos[this.cameraYaw];let q=Q*J+G*O>>16;Q=Q*O-G*J>>16;G=q;q=K*$-Q*H>>16;Q=K*H+Q*$>>16;K=q;if(Q>=50){this.projectX=B.centerX+((G<<9)/Q|0);this.projectY=B.centerY+((K<<9)/Q|0)}else{this.projectX=-1;this.projectY=-1}};draw2DEntityElements=()=>{this.chatCount=0;for(let _=-1;_<this.playerCount+this.npcCount;_++){let R=null;if(_===-1){R=this.localPlayer}else if(_<this.playerCount){R=this.players[this.playerIds[_]]}else{R=this.npcs[this.npcIds[_-this.playerCount]]}if(!R||!R.isVisible()){continue}if(_<this.playerCount){let L=30;const G=R;if(G.headicons!==0){this.projectFromEntity(R,R.height+15);if(this.projectX>-1){for(let K=0;K<8;K++){if((G.headicons&1<<K)!==0){this.imageHeadicons[K]?.draw(this.projectX-12,this.projectY-L);L-=25}}}}if(_>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[_]){this.projectFromEntity(R,R.height+15);if(this.projectX>-1){this.imageHeadicons[7]?.draw(this.projectX-12,this.projectY-L)}}}else if(this.hintType===1&&this.hintNpc===this.npcIds[_-this.playerCount]&&this.loopCycle%20<10){this.projectFromEntity(R,R.height+15);if(this.projectX>-1){this.imageHeadicons[2]?.draw(this.projectX-12,this.projectY-28)}}if(R.chat&&(_>=this.playerCount||this.publicChatSetting===0||this.publicChatSetting===3||this.publicChatSetting===1&&this.isFriend(R.name))){this.projectFromEntity(R,R.height);if(this.projectX>-1&&this.chatCount<d.MAX_CHATS&&this.fontBold12){this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(R.chat)/2|0;this.chatHeight[this.chatCount]=this.fontBold12.height;this.chatX[this.chatCount]=this.projectX;this.chatY[this.chatCount]=this.projectY;this.chatColors[this.chatCount]=R.chatColor;this.chatStyles[this.chatCount]=R.chatStyle;this.chatTimers[this.chatCount]=R.chatTimer;this.chats[this.chatCount++]=R.chat;if(this.chatEffects===0&&R.chatStyle===1){this.chatHeight[this.chatCount]+=10;this.chatY[this.chatCount]+=5}if(this.chatEffects===0&&R.chatStyle===2){this.chatWidth[this.chatCount]=60}}}if(R.combatCycle>this.loopCycle+100){this.projectFromEntity(R,R.height+15);if(this.projectX>-1){let L=R.health*30/R.totalHealth|0;if(L>30){L=30}k.fillRect(this.projectX-15,this.projectY-3,L,5,X.GREEN);k.fillRect(this.projectX-15+L,this.projectY-3,30-L,5,X.RED)}}if(R.combatCycle>this.loopCycle+330){this.projectFromEntity(R,R.height/2|0);if(this.projectX>-1){this.imageHitmarks[R.damageType]?.draw(this.projectX-12,this.projectY-12);this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,R.damage.toString(),X.BLACK);this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,R.damage.toString(),X.WHITE)}}}for(let _=0;_<this.chatCount;_++){const R=this.chatX[_];let L=this.chatY[_];const G=this.chatWidth[_];const K=this.chatHeight[_];let Q=true;while(Q){Q=false;for(let $=0;$<_;$++){if(L+2>this.chatY[$]-this.chatHeight[$]&&L-K<this.chatY[$]+2&&R-G<this.chatX[$]+this.chatWidth[$]&&R+G>this.chatX[$]-this.chatWidth[$]&&this.chatY[$]-this.chatHeight[$]<L){L=this.chatY[$]-this.chatHeight[$];Q=true}}}this.projectX=this.chatX[_];this.projectY=this.chatY[_]=L;const H=this.chats[_];if(this.chatEffects===0){let $=X.YELLOW;if(this.chatColors[_]<6){$=X.CHAT_COLORS[this.chatColors[_]]}if(this.chatColors[_]===6){$=this.sceneCycle%20<10?X.RED:X.YELLOW}if(this.chatColors[_]===7){$=this.sceneCycle%20<10?X.BLUE:X.CYAN}if(this.chatColors[_]===8){$=this.sceneCycle%20<10?45056:8454016}if(this.chatColors[_]===9){const J=150-this.chatTimers[_];if(J<50){$=J*1280+X.RED}else if(J<100){$=X.YELLOW-(J-50)*327680}else if(J<150){$=(J-100)*5+X.GREEN}}if(this.chatColors[_]===10){const J=150-this.chatTimers[_];if(J<50){$=J*5+X.RED}else if(J<100){$=X.MAGENTA-(J-50)*327680}else if(J<150){$=(J-100)*327680+X.BLUE-(J-100)*5}}if(this.chatColors[_]===11){const J=150-this.chatTimers[_];if(J<50){$=X.WHITE-J*327685}else if(J<100){$=(J-50)*327685+X.GREEN}else if(J<150){$=X.WHITE-(J-100)*327680}}if(this.chatStyles[_]===0){this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,H,X.BLACK);this.fontBold12?.drawStringCenter(this.projectX,this.projectY,H,$)}if(this.chatStyles[_]===1){this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,H,X.BLACK,this.sceneCycle);this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,H,$,this.sceneCycle)}if(this.chatStyles[_]===2){const J=this.fontBold12?.stringWidth(H)??0;const O=(150-this.chatTimers[_])*(J+100)/150;k.setBounds(this.projectX-50,0,this.projectX+50,334);this.fontBold12?.drawString(this.projectX+50-O,this.projectY+1,H,X.BLACK);this.fontBold12?.drawString(this.projectX+50-O,this.projectY,H,$);k.resetBounds()}}else{this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,H,X.BLACK);this.fontBold12?.drawStringCenter(this.projectX,this.projectY,H,X.YELLOW)}}};draw3DEntityElements=()=>{this.drawPrivateMessages();if(this.crossMode===1){this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-8,this.crossY-8-11)}if(this.crossMode===2){this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-8,this.crossY-8-11)}if(this.viewportInterfaceId!==-1){this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta);this.drawInterface(g.instances[this.viewportInterfaceId],0,0,0)}this.drawWildyLevel();if(!this.menuVisible){this.handleInput();this.drawTooltip()}else if(this.menuArea===0){this.drawMenu()}if(this.inMultizone===1){if(this.wildernessLevel>0||this.worldLocationState===1){this.imageHeadicons[1]?.draw(472,258)}else{this.imageHeadicons[1]?.draw(472,296)}}if(this.wildernessLevel>0){this.imageHeadicons[0]?.draw(472,296);this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,X.YELLOW)}if(this.worldLocationState===1){this.imageHeadicons[6]?.draw(472,296);this.fontPlain12?.drawStringCenter(484,329,"Arena",X.YELLOW)}if(this.systemUpdateTimer!==0){let _=this.systemUpdateTimer/50|0;const R=_/60|0;_%=60;if(_<10){this.fontPlain12?.drawString(4,329,"System update in: "+R+":0"+_,X.YELLOW)}else{this.fontPlain12?.drawString(4,329,"System update in: "+R+":"+_,X.YELLOW)}}};drawPrivateMessages=()=>{if(this.splitPrivateChat===0){return}const _=this.fontPlain12;let R=0;if(this.systemUpdateTimer!==0){R=1}for(let L=0;L<100;L++){if(!this.messageText[L]){continue}const G=this.messageType[L];let K;if((G===3||G===7)&&(G===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[L]))){K=329-R*13;_?.drawString(4,K,"From "+this.messageSender[L]+": "+this.messageText[L],X.BLACK);_?.drawString(4,K-1,"From "+this.messageSender[L]+": "+this.messageText[L],X.CYAN);R++;if(R>=5){return}}if(G===5&&this.privateChatSetting<2){K=329-R*13;_?.drawString(4,K,this.messageText[L],X.BLACK);_?.drawString(4,K-1,this.messageText[L],X.CYAN);R++;if(R>=5){return}}if(G===6&&this.privateChatSetting<2){K=329-R*13;_?.drawString(4,K,"To "+this.messageSender[L]+": "+this.messageText[L],X.BLACK);_?.drawString(4,K-1,"To "+this.messageSender[L]+": "+this.messageText[L],X.CYAN);R++;if(R>=5){return}}}};drawWildyLevel=()=>{if(!this.localPlayer){return}const _=(this.localPlayer.x>>7)+this.sceneBaseTileX;const R=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(_>=2944&&_<3392&&R>=3520&&R<6400){this.wildernessLevel=((R-3520)/8|0)+1}else if(_>=2944&&_<3392&&R>=9920&&R<12800){this.wildernessLevel=((R-9920)/8|0)+1}else{this.wildernessLevel=0}this.worldLocationState=0;if(_>=3328&&_<3392&&R>=3200&&R<3264){const L=_&63;const G=R&63;if(L>=4&&L<=29&&G>=44&&G<=58){this.worldLocationState=1}else if(L>=36&&L<=61&&G>=44&&G<=58){this.worldLocationState=1}else if(L>=4&&L<=29&&G>=25&&G<=39){this.worldLocationState=1}else if(L>=36&&L<=61&&G>=25&&G<=39){this.worldLocationState=1}else if(L>=4&&L<=29&&G>=6&&G<=20){this.worldLocationState=1}else if(L>=36&&L<=61&&G>=6&&G<=20){this.worldLocationState=1}}if(this.worldLocationState===0&&_>=3328&&_<=3393&&R>=3203&&R<=3325){this.worldLocationState=2}this.overrideChat=0;if(_>=3053&&_<=3156&&R>=3056&&R<=3136){this.overrideChat=1}else if(_>=3072&&_<=3118&&R>=9492&&R<=9535){this.overrideChat=1}if(this.overrideChat===1&&_>=3139&&_<=3199&&R>=3008&&R<=3062){this.overrideChat=0}};drawSidebar=()=>{this.areaSidebar?.bind();if(this.areaSidebarOffsets){B.lineOffset=this.areaSidebarOffsets}this.imageInvback?.draw(0,0);if(this.sidebarInterfaceId!==-1){this.drawInterface(g.instances[this.sidebarInterfaceId],0,0,0)}else if(this.tabInterfaceId[this.selectedTab]!==-1){this.drawInterface(g.instances[this.tabInterfaceId[this.selectedTab]],0,0,0)}if(this.menuVisible&&this.menuArea===1){this.drawMenu()}this.areaSidebar?.draw(562,231);this.areaViewport?.bind();if(this.areaViewportOffsets){B.lineOffset=this.areaViewportOffsets}};drawChatback=()=>{this.areaChatback?.bind();if(this.areaChatbackOffsets){B.lineOffset=this.areaChatbackOffsets}this.imageChatback?.draw(0,0);if(this.showSocialInput){this.fontBold12?.drawStringCenter(239,40,this.socialMessage,X.BLACK);this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",X.DARKBLUE)}else if(this.chatbackInputOpen){this.fontBold12?.drawStringCenter(239,40,"Enter amount:",X.BLACK);this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",X.DARKBLUE)}else if(this.modalMessage){this.fontBold12?.drawStringCenter(239,40,this.modalMessage,X.BLACK);this.fontBold12?.drawStringCenter(239,60,"Click to continue",X.DARKBLUE)}else if(this.chatInterfaceId!==-1){this.drawInterface(g.instances[this.chatInterfaceId],0,0,0)}else if(this.stickyChatInterfaceId===-1){let _=this.fontPlain12;let R=0;k.setBounds(0,0,463,77);for(let L=0;L<100;L++){const G=this.messageText[L];if(!G){continue}const K=this.messageType[L];const Q=this.chatScrollOffset+70-R*14;if(K===0){if(Q>0&&Q<110){_?.drawString(4,Q,G,X.BLACK)}R++}if(K===1){if(Q>0&&Q<110){_?.drawString(4,Q,this.messageSender[L]+":",X.WHITE);_?.drawString(_.stringWidth(this.messageSender[L])+12,Q,G,X.BLUE)}R++}if(K===2&&(this.publicChatSetting===0||this.publicChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110){_?.drawString(4,Q,this.messageSender[L]+":",X.BLACK);_?.drawString(_.stringWidth(this.messageSender[L])+12,Q,G,X.BLUE)}R++}if((K===3||K===7)&&this.splitPrivateChat===0&&(K===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110){_?.drawString(4,Q,"From "+this.messageSender[L]+":",X.BLACK);_?.drawString(_.stringWidth("From "+this.messageSender[L])+12,Q,G,X.DARKRED)}R++}if(K===4&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110){_?.drawString(4,Q,this.messageSender[L]+" "+this.messageText[L],X.TRADE_MESSAGE)}R++}if(K===5&&this.splitPrivateChat===0&&this.privateChatSetting<2){if(Q>0&&Q<110){_?.drawString(4,Q,G,X.DARKRED)}R++}if(K===6&&this.splitPrivateChat===0&&this.privateChatSetting<2){if(Q>0&&Q<110){_?.drawString(4,Q,"To "+this.messageSender[L]+":",X.BLACK);_?.drawString(_.stringWidth("To "+this.messageSender[L])+12,Q,G,X.DARKRED)}R++}if(K===8&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110){_?.drawString(4,Q,this.messageSender[L]+" "+this.messageText[L],X.DUEL_MESSAGE)}R++}}k.resetBounds();this.chatScrollHeight=R*14+7;if(this.chatScrollHeight<78){this.chatScrollHeight=78}this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77);_?.drawString(4,90,I0.formatName(this.username)+":",X.BLACK);_?.drawString(_.stringWidth(this.username+": ")+6,90,this.chatTyped+"*",X.BLUE);k.drawHorizontalLine(0,77,X.BLACK,479)}else{this.drawInterface(g.instances[this.stickyChatInterfaceId],0,0,0)}if(this.menuVisible&&this.menuArea===2){this.drawMenu()}this.areaChatback?.draw(22,375);this.areaViewport?.bind();if(this.areaViewportOffsets){B.lineOffset=this.areaViewportOffsets}};drawMinimap=()=>{this.areaMapback?.bind();if(!this.localPlayer){return}const _=this.orbitCameraYaw+this.minimapAnticheatAngle&2047;let R=(this.localPlayer.x/32|0)+48;let L=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(21,9,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,R,L,_,this.minimapZoom+256);this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let G=0;G<this.activeMapFunctionCount;G++){R=this.activeMapFunctionX[G]*4+2-(this.localPlayer.x/32|0);L=this.activeMapFunctionZ[G]*4+2-(this.localPlayer.z/32|0);this.drawOnMinimap(L,this.activeMapFunctions[G],R)}for(let G=0;G<s.SIZE;G++){for(let K=0;K<s.SIZE;K++){const Q=this.levelObjStacks[this.currentLevel][G][K];if(Q){R=G*4+2-(this.localPlayer.x/32|0);L=K*4+2-(this.localPlayer.z/32|0);this.drawOnMinimap(L,this.imageMapdot0,R)}}}for(let G=0;G<this.npcCount;G++){const K=this.npcs[this.npcIds[G]];if(K&&K.isVisible()&&K.type&&K.type.minimap){R=(K.x/32|0)-(this.localPlayer.x/32|0);L=(K.z/32|0)-(this.localPlayer.z/32|0);this.drawOnMinimap(L,this.imageMapdot1,R)}}for(let G=0;G<this.playerCount;G++){const K=this.players[this.playerIds[G]];if(K&&K.isVisible()&&K.name){R=(K.x/32|0)-(this.localPlayer.x/32|0);L=(K.z/32|0)-(this.localPlayer.z/32|0);let Q=false;const H=I0.toBase37(K.name);for(let $=0;$<this.friendCount;$++){if(H===this.friendName37[$]&&this.friendWorld[$]!==0){Q=true;break}}if(Q){this.drawOnMinimap(L,this.imageMapdot3,R)}else{this.drawOnMinimap(L,this.imageMapdot2,R)}}}if(this.flagSceneTileX!==0){R=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0);L=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0);this.drawOnMinimap(L,this.imageMapflag,R)}k.fillRect(93,82,3,3,X.WHITE);this.areaViewport?.bind()};drawOnMinimap=(_,R,L)=>{if(!R){return}const G=this.orbitCameraYaw+this.minimapAnticheatAngle&2047;const K=L*L+_*_;if(K>6400){return}let Q=B.sin[G];let H=B.cos[G];Q=Q*256/(this.minimapZoom+256)|0;H=H*256/(this.minimapZoom+256)|0;const $=_*Q+L*H>>16;const J=_*H-L*Q>>16;if(K>2500&&this.imageMapback){R.drawMasked($+94-(R.cropW/2|0),83-J-(R.cropH/2|0),this.imageMapback)}else{R.draw($+94-(R.cropW/2|0),83-J-(R.cropH/2|0))}};createMinimap=(_)=>{if(!this.imageMinimap){return}const R=this.imageMinimap.pixels;const L=R.length;for(let Q=0;Q<L;Q++){R[Q]=0}for(let Q=1;Q<s.SIZE-1;Q++){let H=(s.SIZE-1-Q)*512*4+24628;for(let $=1;$<s.SIZE-1;$++){if(this.levelTileFlags&&(this.levelTileFlags[_][$][Q]&24)===0){this.scene?.drawMinimapTile(_,$,Q,R,H,512)}if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][$][Q]&8)!==0){this.scene?.drawMinimapTile(_+1,$,Q,R,H,512)}H+=4}}const G=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10;const K=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let Q=1;Q<s.SIZE-1;Q++){for(let H=1;H<s.SIZE-1;H++){if(this.levelTileFlags&&(this.levelTileFlags[_][H][Q]&24)===0){this.drawMinimapLoc(H,Q,_,G,K)}if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][H][Q]&8)!==0){this.drawMinimapLoc(H,Q,_+1,G,K)}}}this.areaViewport?.bind();this.activeMapFunctionCount=0;for(let Q=0;Q<s.SIZE;Q++){for(let H=0;H<s.SIZE;H++){let $=this.scene?.getGroundDecorationBitset(this.currentLevel,Q,H)??0;if($===0){continue}$=$>>14&32767;const J=h0.get($).mapfunction;if(J<0){continue}let O=Q;let q=H;if(J!==22&&J!==29&&J!==34&&J!==36&&J!==46&&J!==47&&J!==48){const N=s.SIZE;const U=s.SIZE;const b=this.levelCollisionMap[this.currentLevel];if(b){const I=b.flags;for(let j=0;j<10;j++){const F=Math.random()*4|0;if(F===0&&O>0&&O>Q-3&&(I[s.index(O-1,q)]&S.BLOCK_WEST)===S.OPEN){O--}if(F===1&&O<N-1&&O<Q+3&&(I[s.index(O+1,q)]&S.BLOCK_EAST)===S.OPEN){O++}if(F===2&&q>0&&q>H-3&&(I[s.index(O,q-1)]&S.BLOCK_SOUTH)===S.OPEN){q--}if(F===3&&q<U-1&&q<H+3&&(I[s.index(O,q+1)]&S.BLOCK_NORTH)===S.OPEN){q++}}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[J];this.activeMapFunctionX[this.activeMapFunctionCount]=O;this.activeMapFunctionZ[this.activeMapFunctionCount]=q;this.activeMapFunctionCount++}}};drawMinimapLoc=(_,R,L,G,K)=>{if(!this.scene||!this.imageMinimap){return}let Q=this.scene.getWallBitset(L,_,R);if(Q!==0){const H=this.scene.getInfo(L,_,R,Q);const $=H>>6&3;const J=H&31;let O=G;if(Q>0){O=K}const q=this.imageMinimap.pixels;const N=_*4+(103-R)*512*4+24624;const U=Q>>14&32767;const b=h0.get(U);if(b.mapscene===-1){if(J===y.WALL_STRAIGHT.id||J===y.WALL_L.id){if($===x.WEST){q[N]=O;q[N+512]=O;q[N+1024]=O;q[N+1536]=O}else if($===x.NORTH){q[N]=O;q[N+1]=O;q[N+2]=O;q[N+3]=O}else if($===x.EAST){q[N+3]=O;q[N+3+512]=O;q[N+3+1024]=O;q[N+3+1536]=O}else if($===x.SOUTH){q[N+1536]=O;q[N+1536+1]=O;q[N+1536+2]=O;q[N+1536+3]=O}}if(J===y.WALL_SQUARE_CORNER.id){if($===x.WEST){q[N]=O}else if($===x.NORTH){q[N+3]=O}else if($===x.EAST){q[N+3+1536]=O}else if($===x.SOUTH){q[N+1536]=O}}if(J===y.WALL_L.id){if($===x.SOUTH){q[N]=O;q[N+512]=O;q[N+1024]=O;q[N+1536]=O}else if($===x.WEST){q[N]=O;q[N+1]=O;q[N+2]=O;q[N+3]=O}else if($===x.NORTH){q[N+3]=O;q[N+3+512]=O;q[N+3+1024]=O;q[N+3+1536]=O}else if($===x.EAST){q[N+1536]=O;q[N+1536+1]=O;q[N+1536+2]=O;q[N+1536+3]=O}}}else{const I=this.imageMapscene[b.mapscene];if(I){const j=(b.width*4-I.width)/2|0;const F=(b.length*4-I.height)/2|0;I.draw(_*4+48+j,(s.SIZE-R-b.length)*4+F+48)}}}Q=this.scene.getLocBitset(L,_,R);if(Q!==0){const H=this.scene.getInfo(L,_,R,Q);const $=H>>6&3;const J=H&31;const O=Q>>14&32767;const q=h0.get(O);if(q.mapscene!==-1){const N=this.imageMapscene[q.mapscene];if(N){const U=(q.width*4-N.width)/2|0;const b=(q.length*4-N.height)/2|0;N.draw(_*4+48+U,(s.SIZE-R-q.length)*4+b+48)}}else if(J===y.WALL_DIAGONAL.id){let N=15658734;if(Q>0){N=15597568}const U=this.imageMinimap.pixels;const b=_*4+(s.SIZE-1-R)*512*4+24624;if($===x.WEST||$===x.EAST){U[b+1536]=N;U[b+1024+1]=N;U[b+512+2]=N;U[b+3]=N}else{U[b]=N;U[b+512+1]=N;U[b+1024+2]=N;U[b+1536+3]=N}}}Q=this.scene.getGroundDecorationBitset(L,_,R);if(Q!==0){const H=h0.get(Q>>14&32767);if(H.mapscene!==-1){const $=this.imageMapscene[H.mapscene];if($){const J=(H.width*4-$.width)/2|0;const O=(H.length*4-$.height)/2|0;$.draw(_*4+48+J,(s.SIZE-R-H.length)*4+O+48)}}}};drawTooltip=()=>{if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0){return}let _;if(this.objSelected===1&&this.menuSize<2){_="Use "+this.objSelectedName+" with..."}else if(this.spellSelected===1&&this.menuSize<2){_=this.spellCaption+"..."}else{_=this.menuOption[this.menuSize-1]}if(this.menuSize>2){_=_+"@whi@ / "+(this.menuSize-2)+" more options"}this.fontBold12?.drawStringTooltip(4,15,_,X.WHITE,true,this.loopCycle/1000|0)};drawMenu=()=>{const _=this.menuX;const R=this.menuY;const L=this.menuWidth;const G=this.menuHeight;const K=X.OPTIONS_MENU;k.fillRect(_,R,L,G,K);k.fillRect(_+1,R+1,L-2,16,X.BLACK);k.drawRect(_+1,R+18,L-2,G-19,X.BLACK);this.fontBold12?.drawString(_+3,R+14,"Choose Option",K);let Q=this.mouseX;let H=this.mouseY;if(this.menuArea===0){Q-=8;H-=11}if(this.menuArea===1){Q-=562;H-=231}if(this.menuArea===2){Q-=22;H-=375}for(let $=0;$<this.menuSize;$++){const J=R+(this.menuSize-1-$)*15+31;let O=X.WHITE;if(Q>_&&Q<_+L&&H>J-13&&H<J+3){O=X.YELLOW}this.fontBold12?.drawStringTaggable(_+3,J,this.menuOption[$],O,true)}};handleMouseInput=async()=>{if(this.objDragArea!==0){return}let _=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=520&&this.mouseClickY>=165&&this.mouseClickX<=788&&this.mouseClickY<=230){_=0}if(this.menuVisible){if(_!==1){let R=this.mouseX;let L=this.mouseY;if(this.menuArea===0){R-=8;L-=11}else if(this.menuArea===1){R-=562;L-=231}else if(this.menuArea===2){R-=22;L-=375}if(R<this.menuX-10||R>this.menuX+this.menuWidth+10||L<this.menuY-10||L>this.menuY+this.menuHeight+10){this.menuVisible=false;if(this.menuArea===1){this.redrawSidebar=true}if(this.menuArea===2){this.redrawChatback=true}}}if(_===1){const R=this.menuX;const L=this.menuY;const G=this.menuWidth;let K=this.mouseClickX;let Q=this.mouseClickY;if(this.menuArea===0){K-=8;Q-=11}else if(this.menuArea===1){K-=562;Q-=231}else if(this.menuArea===2){K-=22;Q-=375}let H=-1;for(let $=0;$<this.menuSize;$++){const J=L+(this.menuSize-1-$)*15+31;if(K>R&&K<R+G&&Q>J-13&&Q<J+3){H=$}}if(H!==-1){await this.useMenuOption(H)}this.menuVisible=false;if(this.menuArea===1){this.redrawSidebar=true}else if(this.menuArea===2){this.redrawChatback=true}}}else{if(_===1&&this.menuSize>0){const R=this.menuAction[this.menuSize-1];if(R===602||R===596||R===22||R===892||R===415||R===405||R===38||R===422||R===478||R===347||R===188){const L=this.menuParamB[this.menuSize-1];const G=this.menuParamC[this.menuSize-1];const K=g.instances[G];if(K.draggable){this.objGrabThreshold=false;this.objDragCycles=0;this.objDragInterfaceId=G;this.objDragSlot=L;this.objDragArea=2;this.objGrabX=this.mouseClickX;this.objGrabY=this.mouseClickY;if(g.instances[G].layer===this.viewportInterfaceId){this.objDragArea=1}if(g.instances[G].layer===this.chatInterfaceId){this.objDragArea=3}return}}}if(_===1&&(this.mouseButtonsOption===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2){_=2}if(_===1&&this.menuSize>0){await this.useMenuOption(this.menuSize-1)}if(_!==2||this.menuSize<=0){return}this.showContextMenu()}};handleMinimapInput=()=>{if(this.mouseClickButton===1&&this.localPlayer){let _=this.mouseClickX-21-561;let R=this.mouseClickY-9-5;if(_>=0&&R>=0&&_<146&&R<151){_-=73;R-=75;const L=this.orbitCameraYaw+this.minimapAnticheatAngle&2047;let G=B.sin[L];let K=B.cos[L];G=G*(this.minimapZoom+256)>>8;K=K*(this.minimapZoom+256)>>8;const Q=R*G+_*K>>11;const H=R*K-_*G>>11;const $=this.localPlayer.x+Q>>7;const J=this.localPlayer.z-H>>7;if(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],$,J,1,0,0,0,0,0,true)){this.out.p1(_);this.out.p1(R);this.out.p2(this.orbitCameraYaw);this.out.p1(57);this.out.p1(this.minimapAnticheatAngle);this.out.p1(this.minimapZoom);this.out.p1(89);this.out.p2(this.localPlayer.x);this.out.p2(this.localPlayer.z);this.out.p1(this.tryMoveNearest);this.out.p1(63)}}}};isAddFriendOption=(_)=>{if(_<0){return false}let R=this.menuAction[_];if(R>=2000){R-=2000}return R===406};useMenuOption=async(_)=>{if(_<0){return}if(this.chatbackInputOpen){this.chatbackInputOpen=false;this.redrawChatback=true}let R=this.menuAction[_];const L=this.menuParamA[_];const G=this.menuParamB[_];const K=this.menuParamC[_];if(R>=2000){R-=2000}if(R===903||R===363){let Q=this.menuOption[_];const H=Q.indexOf("@whi@");if(H!==-1){Q=Q.substring(H+5).trim();const $=I0.formatName(I0.fromBase37(I0.toBase37(Q)));let J=false;for(let O=0;O<this.playerCount;O++){const q=this.players[this.playerIds[O]];if(q&&q.name&&q.name.toLowerCase()===$.toLowerCase()&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],q.pathTileX[0],q.pathTileZ[0],2,1,1,0,0,0,false);if(R===903){this.out.p1isaac(c.OPPLAYER4)}else if(R===363){this.out.p1isaac(c.OPPLAYER1)}this.out.p2(this.playerIds[O]);J=true;break}}if(!J){this.addMessage(0,"Unable to find "+$,"")}}}else if(R===450&&this.interactWithLoc(c.OPLOCU,G,K,L)){this.out.p2(this.objInterface);this.out.p2(this.objSelectedSlot);this.out.p2(this.objSelectedInterface)}else if(R===405||R===38||R===422||R===478||R===347){if(R===478){if((G&3)===0){d.oplogic5++}if(d.oplogic5>=90){this.out.p1isaac(c.ANTICHEAT_OPLOGIC5)}this.out.p1isaac(c.OPHELD4)}else if(R===347){this.out.p1isaac(c.OPHELD5)}else if(R===422){this.out.p1isaac(c.OPHELD3)}else if(R===405){d.oplogic3+=L;if(d.oplogic3>=97){this.out.p1isaac(c.ANTICHEAT_OPLOGIC3);this.out.p3(14953816)}this.out.p1isaac(c.OPHELD1)}else if(R===38){this.out.p1isaac(c.OPHELD2)}this.out.p2(L);this.out.p2(G);this.out.p2(K);this.selectedCycle=0;this.selectedInterface=K;this.selectedItem=G;this.selectedArea=2;if(g.instances[K].layer===this.viewportInterfaceId){this.selectedArea=1}if(g.instances[K].layer===this.chatInterfaceId){this.selectedArea=3}}else if(R===728||R===542||R===6||R===963||R===245){const Q=this.npcs[L];if(Q&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,false);this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;if(R===542){this.out.p1isaac(c.OPNPC2)}else if(R===6){if((L&3)===0){d.oplogic2++}if(d.oplogic2>=124){this.out.p1isaac(c.ANTICHEAT_OPLOGIC2);this.out.p4(0)}this.out.p1isaac(c.OPNPC3)}else if(R===963){this.out.p1isaac(c.OPNPC4)}else if(R===728){this.out.p1isaac(c.OPNPC1)}else if(R===245){if((L&3)===0){d.oplogic4++}if(d.oplogic4>=85){this.out.p1isaac(c.ANTICHEAT_OPLOGIC4);this.out.p2(39596)}this.out.p1isaac(c.OPNPC5)}this.out.p2(L)}}else if(R===217){if(this.localPlayer){const Q=this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,0,0,0,0,0,false);if(!Q){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,1,1,0,0,0,false)}this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(c.OPOBJU);this.out.p2(G+this.sceneBaseTileX);this.out.p2(K+this.sceneBaseTileZ);this.out.p2(L);this.out.p2(this.objInterface);this.out.p2(this.objSelectedSlot);this.out.p2(this.objSelectedInterface)}}else if(R===1175){const Q=L>>14&32767;const H=h0.get(Q);let $;if(!H.desc){$="It's a "+H.name+"."}else{$=H.desc}this.addMessage(0,$,"")}else if(R===285){this.interactWithLoc(c.OPLOC1,G,K,L)}else if(R===881){this.out.p1isaac(c.OPHELDU);this.out.p2(L);this.out.p2(G);this.out.p2(K);this.out.p2(this.objInterface);this.out.p2(this.objSelectedSlot);this.out.p2(this.objSelectedInterface);this.selectedCycle=0;this.selectedInterface=K;this.selectedItem=G;this.selectedArea=2;if(g.instances[K].layer===this.viewportInterfaceId){this.selectedArea=1}if(g.instances[K].layer===this.chatInterfaceId){this.selectedArea=3}}else if(R===391){this.out.p1isaac(c.OPHELDT);this.out.p2(L);this.out.p2(G);this.out.p2(K);this.out.p2(this.activeSpellId);this.selectedCycle=0;this.selectedInterface=K;this.selectedItem=G;this.selectedArea=2;if(g.instances[K].layer===this.viewportInterfaceId){this.selectedArea=1}if(g.instances[K].layer===this.chatInterfaceId){this.selectedArea=3}}else if(R===660){if(this.menuVisible){this.scene?.click(G-8,K-11)}else{this.scene?.click(this.mouseClickX-8,this.mouseClickY-11)}}else if(R===188){this.objSelected=1;this.objSelectedSlot=G;this.objSelectedInterface=K;this.objInterface=L;this.objSelectedName=Y0.get(L).name;this.spellSelected=0;return}else if(R===44){if(!this.pressedContinueOption){this.out.p1isaac(c.RESUME_PAUSEBUTTON);this.out.p2(K);this.pressedContinueOption=true}}else if(R===1773){const Q=Y0.get(L);let H;if(K>=1e5){H=K+" x "+Q.name}else if(!Q.desc){H="It's a "+Q.name+"."}else{H=Q.desc}this.addMessage(0,H,"")}else if(R===900){const Q=this.npcs[L];if(Q&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,false);this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(c.OPNPCU);this.out.p2(L);this.out.p2(this.objInterface);this.out.p2(this.objSelectedSlot);this.out.p2(this.objSelectedInterface)}}else if(R===1373||R===1544||R===151||R===1101){const Q=this.players[L];if(Q&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,false);this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;if(R===1101){this.out.p1isaac(c.OPPLAYER1)}else if(R===151){d.oplogic8++;if(d.oplogic8>=90){this.out.p1isaac(c.ANTICHEAT_OPLOGIC8);this.out.p2(31114)}this.out.p1isaac(c.OPPLAYER2)}else if(R===1373){this.out.p1isaac(c.OPPLAYER4)}else if(R===1544){this.out.p1isaac(c.OPPLAYER3)}this.out.p2(L)}}else if(R===265){const Q=this.npcs[L];if(Q&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,false);this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(c.OPNPCT);this.out.p2(L);this.out.p2(this.activeSpellId)}}else if(R===679){const Q=this.menuOption[_];const H=Q.indexOf("@whi@");if(H!==-1){const $=I0.toBase37(Q.substring(H+5).trim());let J=-1;for(let O=0;O<this.friendCount;O++){if(this.friendName37[O]===$){J=O;break}}if(J!==-1&&this.friendWorld[J]>0){this.redrawChatback=true;this.chatbackInputOpen=false;this.showSocialInput=true;this.socialInput="";this.socialAction=3;this.socialName37=this.friendName37[J];this.socialMessage="Enter message to send to "+this.friendName[J]}}}else if(R===55){if(this.interactWithLoc(c.OPLOCT,G,K,L)){this.out.p2(this.activeSpellId)}}else if(R===224||R===993||R===99||R===746||R===877){if(this.localPlayer){const Q=this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,0,0,0,0,0,false);if(!Q){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,1,1,0,0,0,false)}this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;if(R===224){this.out.p1isaac(c.OPOBJ1)}else if(R===746){this.out.p1isaac(c.OPOBJ4)}else if(R===877){this.out.p1isaac(c.OPOBJ5)}else if(R===99){this.out.p1isaac(c.OPOBJ3)}else if(R===993){this.out.p1isaac(c.OPOBJ2)}this.out.p2(G+this.sceneBaseTileX);this.out.p2(K+this.sceneBaseTileZ);this.out.p2(L)}}else if(R===1607){const Q=this.npcs[L];if(Q&&Q.type){let H;if(!Q.type.desc){H="It's a "+Q.type.name+"."}else{H=Q.type.desc}this.addMessage(0,H,"")}}else if(R===504){this.interactWithLoc(c.OPLOC2,G,K,L)}else if(R===930){const Q=g.instances[K];this.spellSelected=1;this.activeSpellId=K;this.activeSpellFlags=Q.actionTarget;this.objSelected=0;let H=Q.actionVerb;if(H&&H.indexOf(" ")!==-1){H=H.substring(0,H.indexOf(" "))}let $=Q.actionVerb;if($&&$.indexOf(" ")!==-1){$=$.substring($.indexOf(" ")+1)}this.spellCaption=H+" "+Q.action+" "+$;if(this.activeSpellFlags===16){this.redrawSidebar=true;this.selectedTab=3;this.redrawSideicons=true}return}else if(R===951){const Q=g.instances[K];let H=true;if(Q.clientCode>0){H=this.handleInterfaceAction(Q)}if(H){this.out.p1isaac(c.IF_BUTTON);this.out.p2(K)}}else if(R===602||R===596||R===22||R===892||R===415){if(R===22){this.out.p1isaac(c.INV_BUTTON3)}else if(R===415){if((K&3)===0){d.oplogic7++}if(d.oplogic7>=55){this.out.p1isaac(c.ANTICHEAT_OPLOGIC7);this.out.p4(0)}this.out.p1isaac(c.INV_BUTTON5)}else if(R===602){this.out.p1isaac(c.INV_BUTTON1)}else if(R===892){if((G&3)===0){d.oplogic9++}if(d.oplogic9>=130){this.out.p1isaac(c.ANTICHEAT_OPLOGIC9);this.out.p1(177)}this.out.p1isaac(c.INV_BUTTON4)}else if(R===596){this.out.p1isaac(c.INV_BUTTON2)}this.out.p2(L);this.out.p2(G);this.out.p2(K);this.selectedCycle=0;this.selectedInterface=K;this.selectedItem=G;this.selectedArea=2;if(g.instances[K].layer===this.viewportInterfaceId){this.selectedArea=1}if(g.instances[K].layer===this.chatInterfaceId){this.selectedArea=3}}else if(R===581){if((L&3)===0){d.oplogic1++}if(d.oplogic1>=99){this.out.p1isaac(c.ANTICHEAT_OPLOGIC1);this.out.p4(0)}this.interactWithLoc(c.OPLOC4,G,K,L)}else if(R===965){if(this.localPlayer){const Q=this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,0,0,0,0,0,false);if(!Q){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,1,1,0,0,0,false)}this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(c.OPOBJT);this.out.p2(G+this.sceneBaseTileX);this.out.p2(K+this.sceneBaseTileZ);this.out.p2(L);this.out.p2(this.activeSpellId)}}else if(R===1501){d.oplogic6+=this.sceneBaseTileZ;if(d.oplogic6>=92){this.out.p1isaac(c.ANTICHEAT_OPLOGIC6);this.out.p4(0)}this.interactWithLoc(c.OPLOC5,G,K,L)}else if(R===364){this.interactWithLoc(c.OPLOC3,G,K,L)}else if(R===1102){const Q=Y0.get(L);let H;if(!Q.desc){H="It's a "+Q.name+"."}else{H=Q.desc}this.addMessage(0,H,"")}else if(R===960){this.out.p1isaac(c.IF_BUTTON);this.out.p2(K);const Q=g.instances[K];if(Q.scripts&&Q.scripts[0]&&Q.scripts[0][0]===5){const H=Q.scripts[0][1];if(Q.scriptOperand&&this.varps[H]!==Q.scriptOperand[0]){this.varps[H]=Q.scriptOperand[0];await this.updateVarp(H);this.redrawSidebar=true}}}else if(R===34){const Q=this.menuOption[_];const H=Q.indexOf("@whi@");if(H!==-1){this.closeInterfaces();this.reportAbuseInput=Q.substring(H+5).trim();this.reportAbuseMuteOption=false;for(let $=0;$<g.instances.length;$++){if(g.instances[$]&&g.instances[$].clientCode===g.CC_REPORT_INPUT){this.reportAbuseInterfaceID=this.viewportInterfaceId=g.instances[$].layer;break}}}}else if(R===947){this.closeInterfaces()}else if(R===367){const Q=this.players[L];if(Q&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,false);this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(c.OPPLAYERU);this.out.p2(L);this.out.p2(this.objInterface);this.out.p2(this.objSelectedSlot);this.out.p2(this.objSelectedInterface)}}else if(R===465){this.out.p1isaac(c.IF_BUTTON);this.out.p2(K);const Q=g.instances[K];if(Q.scripts&&Q.scripts[0]&&Q.scripts[0][0]===5){const H=Q.scripts[0][1];this.varps[H]=1-this.varps[H];await this.updateVarp(H);this.redrawSidebar=true}}else if(R===406||R===436||R===557||R===556){const Q=this.menuOption[_];const H=Q.indexOf("@whi@");if(H!==-1){const $=I0.toBase37(Q.substring(H+5).trim());if(R===406){this.addFriend($)}else if(R===436){this.addIgnore($)}else if(R===557){this.removeFriend($)}else if(R===556){this.removeIgnore($)}}}else if(R===651){const Q=this.players[L];if(Q&&this.localPlayer){this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,false);this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(c.OPPLAYERT);this.out.p2(L);this.out.p2(this.activeSpellId)}}this.objSelected=0;this.spellSelected=0};handleInterfaceAction=(_)=>{const R=_.clientCode;if(R===g.CC_ADD_FRIEND){this.redrawChatback=true;this.chatbackInputOpen=false;this.showSocialInput=true;this.socialInput="";this.socialAction=1;this.socialMessage="Enter name of friend to add to list"}if(R===g.CC_DEL_FRIEND){this.redrawChatback=true;this.chatbackInputOpen=false;this.showSocialInput=true;this.socialInput="";this.socialAction=2;this.socialMessage="Enter name of friend to delete from list"}if(R===g.CC_LOGOUT){this.idleTimeout=250;return true}if(R===g.CC_ADD_IGNORE){this.redrawChatback=true;this.chatbackInputOpen=false;this.showSocialInput=true;this.socialInput="";this.socialAction=4;this.socialMessage="Enter name of player to add to list"}if(R===g.CC_DEL_IGNORE){this.redrawChatback=true;this.chatbackInputOpen=false;this.showSocialInput=true;this.socialInput="";this.socialAction=5;this.socialMessage="Enter name of player to delete from list"}if(R>=g.CC_CHANGE_HEAD_L&&R<=g.CC_CHANGE_FEET_R){const L=(R-300)/2|0;const G=R&1;let K=this.designIdentikits[L];if(K!==-1){while(true){if(G===0){K--;if(K<0){K=i0.count-1}}if(G===1){K++;if(K>=i0.count){K=0}}if(!i0.instances[K].disable&&i0.instances[K].type===L+(this.designGenderMale?0:7)){this.designIdentikits[L]=K;this.updateDesignModel=true;break}}}}if(R>=g.CC_RECOLOUR_HAIR_L&&R<=g.CC_RECOLOUR_SKIN_R){const L=(R-314)/2|0;const G=R&1;let K=this.designColors[L];if(G===0){K--;if(K<0){K=U0.DESIGN_IDK_COLORS[L].length-1}}if(G===1){K++;if(K>=U0.DESIGN_IDK_COLORS[L].length){K=0}}this.designColors[L]=K;this.updateDesignModel=true}if(R===g.CC_SWITCH_TO_MALE&&!this.designGenderMale){this.designGenderMale=true;this.validateCharacterDesign()}if(R===g.CC_SWITCH_TO_FEMALE&&this.designGenderMale){this.designGenderMale=false;this.validateCharacterDesign()}if(R===g.CC_ACCEPT_DESIGN){this.out.p1isaac(c.IF_PLAYERDESIGN);this.out.p1(this.designGenderMale?0:1);for(let L=0;L<7;L++){this.out.p1(this.designIdentikits[L])}for(let L=0;L<5;L++){this.out.p1(this.designColors[L])}return true}if(R===g.CC_MOD_MUTE){this.reportAbuseMuteOption=!this.reportAbuseMuteOption}if(R>=g.CC_REPORT_RULE1&&R<=g.CC_REPORT_RULE12){this.closeInterfaces();if(this.reportAbuseInput.length>0){this.out.p1isaac(c.BUG_REPORT);this.out.p8(I0.toBase37(this.reportAbuseInput));this.out.p1(R-601);this.out.p1(this.reportAbuseMuteOption?1:0)}}return false};validateCharacterDesign=()=>{this.updateDesignModel=true;for(let _=0;_<7;_++){this.designIdentikits[_]=-1;for(let R=0;R<i0.count;R++){if(!i0.instances[R].disable&&i0.instances[R].type===_+(this.designGenderMale?0:7)){this.designIdentikits[_]=R;break}}}};interactWithLoc=(_,R,L,G)=>{if(!this.localPlayer||!this.scene){return false}const K=G>>14&32767;const Q=this.scene.getInfo(this.currentLevel,R,L,G);if(Q===-1){return false}const H=Q&31;const $=Q>>6&3;if(H===y.CENTREPIECE_STRAIGHT.id||H===y.CENTREPIECE_DIAGONAL.id||H===y.GROUND_DECOR.id){const J=h0.get(K);let O;let q;if($===x.WEST||$===x.EAST){O=J.width;q=J.length}else{O=J.length;q=J.width}let N=J.forceapproach;if($!==0){N=(N<<$&15)+(N>>4-$)}this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],R,L,2,O,q,0,0,N,false)}else{this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],R,L,2,0,0,$,H+1,0,false)}this.crossX=this.mouseClickX;this.crossY=this.mouseClickY;this.crossMode=2;this.crossCycle=0;this.out.p1isaac(_);this.out.p2(R+this.sceneBaseTileX);this.out.p2(L+this.sceneBaseTileZ);this.out.p2(K);return true};handleTabInput=()=>{if(this.mouseClickButton===1){if(this.mouseClickX>=549&&this.mouseClickX<=583&&this.mouseClickY>=195&&this.mouseClickY<231&&this.tabInterfaceId[0]!==-1){this.redrawSidebar=true;this.selectedTab=0;this.redrawSideicons=true}else if(this.mouseClickX>=579&&this.mouseClickX<=609&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[1]!==-1){this.redrawSidebar=true;this.selectedTab=1;this.redrawSideicons=true}else if(this.mouseClickX>=607&&this.mouseClickX<=637&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[2]!==-1){this.redrawSidebar=true;this.selectedTab=2;this.redrawSideicons=true}else if(this.mouseClickX>=635&&this.mouseClickX<=679&&this.mouseClickY>=194&&this.mouseClickY<229&&this.tabInterfaceId[3]!==-1){this.redrawSidebar=true;this.selectedTab=3;this.redrawSideicons=true}else if(this.mouseClickX>=676&&this.mouseClickX<=706&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[4]!==-1){this.redrawSidebar=true;this.selectedTab=4;this.redrawSideicons=true}else if(this.mouseClickX>=704&&this.mouseClickX<=734&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[5]!==-1){this.redrawSidebar=true;this.selectedTab=5;this.redrawSideicons=true}else if(this.mouseClickX>=732&&this.mouseClickX<=766&&this.mouseClickY>=195&&this.mouseClickY<231&&this.tabInterfaceId[6]!==-1){this.redrawSidebar=true;this.selectedTab=6;this.redrawSideicons=true}else if(this.mouseClickX>=550&&this.mouseClickX<=584&&this.mouseClickY>=492&&this.mouseClickY<528&&this.tabInterfaceId[7]!==-1){this.redrawSidebar=true;this.selectedTab=7;this.redrawSideicons=true}else if(this.mouseClickX>=582&&this.mouseClickX<=612&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[8]!==-1){this.redrawSidebar=true;this.selectedTab=8;this.redrawSideicons=true}else if(this.mouseClickX>=609&&this.mouseClickX<=639&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[9]!==-1){this.redrawSidebar=true;this.selectedTab=9;this.redrawSideicons=true}else if(this.mouseClickX>=637&&this.mouseClickX<=681&&this.mouseClickY>=493&&this.mouseClickY<528&&this.tabInterfaceId[10]!==-1){this.redrawSidebar=true;this.selectedTab=10;this.redrawSideicons=true}else if(this.mouseClickX>=679&&this.mouseClickX<=709&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[11]!==-1){this.redrawSidebar=true;this.selectedTab=11;this.redrawSideicons=true}else if(this.mouseClickX>=706&&this.mouseClickX<=736&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[12]!==-1){this.redrawSidebar=true;this.selectedTab=12;this.redrawSideicons=true}else if(this.mouseClickX>=734&&this.mouseClickX<=768&&this.mouseClickY>=492&&this.mouseClickY<528&&this.tabInterfaceId[13]!==-1){this.redrawSidebar=true;this.selectedTab=13;this.redrawSideicons=true}d.cyclelogic1++;if(d.cyclelogic1>150){d.cyclelogic1=0;this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC1);this.out.p1(43)}}};handleInputKey=async()=>{while(true){let _;do{while(true){_=this.pollKey();if(_===-1){return}if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceID){if(_===8&&this.reportAbuseInput.length>0){this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1)}break}if(this.showSocialInput){if(_>=32&&_<=122&&this.socialInput.length<80){this.socialInput=this.socialInput+String.fromCharCode(_);this.redrawChatback=true}if(_===8&&this.socialInput.length>0){this.socialInput=this.socialInput.substring(0,this.socialInput.length-1);this.redrawChatback=true}if(_===13||_===10){this.showSocialInput=false;this.redrawChatback=true;let R;if(this.socialAction===1){R=I0.toBase37(this.socialInput);this.addFriend(R)}if(this.socialAction===2&&this.friendCount>0){R=I0.toBase37(this.socialInput);this.removeFriend(R)}if(this.socialAction===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(c.MESSAGE_PRIVATE);this.out.p1(0);const L=this.out.pos;this.out.p8(this.socialName37);m1.pack(this.out,this.socialInput);this.out.psize1(this.out.pos-L);this.socialInput=I0.toSentenceCase(this.socialInput);this.socialInput=k1.filter(this.socialInput);this.addMessage(6,this.socialInput,I0.formatName(I0.fromBase37(this.socialName37)));if(this.privateChatSetting===2){this.privateChatSetting=1;this.redrawPrivacySettings=true;this.out.p1isaac(c.CHAT_SETMODE);this.out.p1(this.publicChatSetting);this.out.p1(this.privateChatSetting);this.out.p1(this.tradeChatSetting)}}if(this.socialAction===4&&this.ignoreCount<100){R=I0.toBase37(this.socialInput);this.addIgnore(R)}if(this.socialAction===5&&this.ignoreCount>0){R=I0.toBase37(this.socialInput);this.removeIgnore(R)}}}else if(this.chatbackInputOpen){if(_>=48&&_<=57&&this.chatbackInput.length<10){this.chatbackInput=this.chatbackInput+String.fromCharCode(_);this.redrawChatback=true}if(_===8&&this.chatbackInput.length>0){this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1);this.redrawChatback=true}if(_===13||_===10){if(this.chatbackInput.length>0){let R=0;try{R=parseInt(this.chatbackInput,10)}catch(L){}this.out.p1isaac(c.RESUME_P_COUNTDIALOG);this.out.p4(R)}this.chatbackInputOpen=false;this.redrawChatback=true}}else if(this.chatInterfaceId===-1){if(_>=32&&_<=126&&this.chatTyped.length<80){this.chatTyped=this.chatTyped+String.fromCharCode(_);this.redrawChatback=true}if(_===8&&this.chatTyped.length>0){this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1);this.redrawChatback=true}if((_===13||_===10)&&this.chatTyped.length>0){if(this.chatTyped.startsWith("::")){this.out.p1isaac(c.CLIENT_CHEAT);this.out.p1(this.chatTyped.length-1);this.out.pjstr(this.chatTyped.substring(2))}else{let R=0;if(this.chatTyped.startsWith("yellow:")){R=0;this.chatTyped=this.chatTyped.substring(7)}else if(this.chatTyped.startsWith("red:")){R=1;this.chatTyped=this.chatTyped.substring(4)}else if(this.chatTyped.startsWith("green:")){R=2;this.chatTyped=this.chatTyped.substring(6)}else if(this.chatTyped.startsWith("cyan:")){R=3;this.chatTyped=this.chatTyped.substring(5)}else if(this.chatTyped.startsWith("purple:")){R=4;this.chatTyped=this.chatTyped.substring(7)}else if(this.chatTyped.startsWith("white:")){R=5;this.chatTyped=this.chatTyped.substring(6)}else if(this.chatTyped.startsWith("flash1:")){R=6;this.chatTyped=this.chatTyped.substring(7)}else if(this.chatTyped.startsWith("flash2:")){R=7;this.chatTyped=this.chatTyped.substring(7)}else if(this.chatTyped.startsWith("flash3:")){R=8;this.chatTyped=this.chatTyped.substring(7)}else if(this.chatTyped.startsWith("glow1:")){R=9;this.chatTyped=this.chatTyped.substring(6)}else if(this.chatTyped.startsWith("glow2:")){R=10;this.chatTyped=this.chatTyped.substring(6)}else if(this.chatTyped.startsWith("glow3:")){R=11;this.chatTyped=this.chatTyped.substring(6)}let L=0;if(this.chatTyped.startsWith("wave:")){L=1;this.chatTyped=this.chatTyped.substring(5)}if(this.chatTyped.startsWith("scroll:")){L=2;this.chatTyped=this.chatTyped.substring(7)}this.out.p1isaac(c.MESSAGE_PUBLIC);this.out.p1(0);const G=this.out.pos;this.out.p1(R);this.out.p1(L);m1.pack(this.out,this.chatTyped);this.out.psize1(this.out.pos-G);this.chatTyped=I0.toSentenceCase(this.chatTyped);this.chatTyped=k1.filter(this.chatTyped);if(this.localPlayer&&this.localPlayer.name){this.localPlayer.chat=this.chatTyped;this.localPlayer.chatColor=R;this.localPlayer.chatStyle=L;this.localPlayer.chatTimer=150;this.addMessage(2,this.localPlayer.chat,this.localPlayer.name)}if(this.publicChatSetting===2){this.publicChatSetting=3;this.redrawPrivacySettings=true;this.out.p1isaac(c.CHAT_SETMODE);this.out.p1(this.publicChatSetting);this.out.p1(this.privateChatSetting);this.out.p1(this.tradeChatSetting)}}this.chatTyped="";this.redrawChatback=true}}}}while((_<97||_>122)&&(_<65||_>90)&&(_<48||_>57)&&_!==32);if(this.reportAbuseInput.length<12){this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(_)}}};handleChatSettingsInput=()=>{if(this.mouseClickButton===1){if(this.mouseClickX>=8&&this.mouseClickX<=108&&this.mouseClickY>=490&&this.mouseClickY<=522){this.publicChatSetting=(this.publicChatSetting+1)%4;this.redrawPrivacySettings=true;this.redrawChatback=true;this.out.p1isaac(c.CHAT_SETMODE);this.out.p1(this.publicChatSetting);this.out.p1(this.privateChatSetting);this.out.p1(this.tradeChatSetting)}else if(this.mouseClickX>=137&&this.mouseClickX<=237&&this.mouseClickY>=490&&this.mouseClickY<=522){this.privateChatSetting=(this.privateChatSetting+1)%3;this.redrawPrivacySettings=true;this.redrawChatback=true;this.out.p1isaac(c.CHAT_SETMODE);this.out.p1(this.publicChatSetting);this.out.p1(this.privateChatSetting);this.out.p1(this.tradeChatSetting)}else if(this.mouseClickX>=275&&this.mouseClickX<=375&&this.mouseClickY>=490&&this.mouseClickY<=522){this.tradeChatSetting=(this.tradeChatSetting+1)%3;this.redrawPrivacySettings=true;this.redrawChatback=true;this.out.p1isaac(c.CHAT_SETMODE);this.out.p1(this.publicChatSetting);this.out.p1(this.privateChatSetting);this.out.p1(this.tradeChatSetting)}else if(this.mouseClickX>=416&&this.mouseClickX<=516&&this.mouseClickY>=490&&this.mouseClickY<=522){this.closeInterfaces();this.reportAbuseInput="";this.reportAbuseMuteOption=false;for(let _=0;_<g.instances.length;_++){if(g.instances[_]&&g.instances[_].clientCode===600){this.reportAbuseInterfaceID=this.viewportInterfaceId=g.instances[_].layer;return}}}}};handleScrollInput=(_,R,L,G,K,Q,H,$)=>{if(this.scrollGrabbed){this.scrollInputPadding=32}else{this.scrollInputPadding=0}this.scrollGrabbed=false;if(_>=Q&&_<Q+16&&R>=H&&R<H+16){$.scrollPosition-=this.dragCycles*4;if(K){this.redrawSidebar=true}}else if(_>=Q&&_<Q+16&&R>=H+G-16&&R<H+G){$.scrollPosition+=this.dragCycles*4;if(K){this.redrawSidebar=true}}else if(_>=Q-this.scrollInputPadding&&_<Q+this.scrollInputPadding+16&&R>=H+16&&R<H+G-16&&this.dragCycles>0){let J=(G-32)*G/L|0;if(J<8){J=8}const O=R-H-(J/2|0)-16;const q=G-J-32;$.scrollPosition=(L-G)*O/q|0;if(K){this.redrawSidebar=true}this.scrollGrabbed=true}};prepareGameScreen=()=>{if(!this.areaChatback){this.unloadTitle();this.drawArea=null;this.imageTitle2=null;this.imageTitle3=null;this.imageTitle4=null;this.imageTitle0=null;this.imageTitle1=null;this.imageTitle5=null;this.imageTitle6=null;this.imageTitle7=null;this.imageTitle8=null;this.areaChatback=new w0(479,96);this.areaMapback=new w0(168,160);k.clear();this.imageMapback?.draw(0,0);this.areaSidebar=new w0(190,261);this.areaViewport=new w0(512,334);k.clear();this.areaBackbase1=new w0(501,61);this.areaBackbase2=new w0(288,40);this.areaBackhmid1=new w0(269,66);this.redrawTitleBackground=true}};isFriend=(_)=>{if(!_){return false}for(let R=0;R<this.friendCount;R++){if(_.toLowerCase()===this.friendName[R]?.toLowerCase()){return true}}if(!this.localPlayer){return false}return _.toLowerCase()===this.localPlayer.name?.toLowerCase()};addFriend=(_)=>{if(_===0n){return}if(this.friendCount>=100){this.addMessage(0,"Your friends list is full. Max of 100 hit","");return}const R=I0.formatName(I0.fromBase37(_));for(let L=0;L<this.friendCount;L++){if(this.friendName37[L]===_){this.addMessage(0,R+" is already on your friend list","");return}}for(let L=0;L<this.ignoreCount;L++){if(this.ignoreName37[L]===_){this.addMessage(0,"Please remove "+R+" from your ignore list first","");return}}if(!this.localPlayer||!this.localPlayer.name){return}if(R!==this.localPlayer.name){this.friendName[this.friendCount]=R;this.friendName37[this.friendCount]=_;this.friendWorld[this.friendCount]=0;this.friendCount++;this.redrawSidebar=true;this.out.p1isaac(c.FRIENDLIST_ADD);this.out.p8(_)}};removeFriend=(_)=>{if(_===0n){return}for(let R=0;R<this.friendCount;R++){if(this.friendName37[R]===_){this.friendCount--;this.redrawSidebar=true;for(let L=R;L<this.friendCount;L++){this.friendName[L]=this.friendName[L+1];this.friendWorld[L]=this.friendWorld[L+1];this.friendName37[L]=this.friendName37[L+1]}this.out.p1isaac(c.FRIENDLIST_DEL);this.out.p8(_);return}}};addIgnore=(_)=>{if(_===0n){return}if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}const R=I0.formatName(I0.fromBase37(_));for(let L=0;L<this.ignoreCount;L++){if(this.ignoreName37[L]===_){this.addMessage(0,R+" is already on your ignore list","");return}}for(let L=0;L<this.friendCount;L++){if(this.friendName37[L]===_){this.addMessage(0,"Please remove "+R+" from your friend list first","");return}}this.ignoreName37[this.ignoreCount++]=_;this.redrawSidebar=true;this.out.p1isaac(c.IGNORELIST_ADD);this.out.p8(_)};removeIgnore=(_)=>{if(_===0n){return}for(let R=0;R<this.ignoreCount;R++){if(this.ignoreName37[R]===_){this.ignoreCount--;this.redrawSidebar=true;for(let L=R;L<this.ignoreCount;L++){this.ignoreName37[L]=this.ignoreName37[L+1]}this.out.p1isaac(c.IGNORELIST_DEL);this.out.p8(_);return}}};sortObjStacks=(_,R)=>{const L=this.levelObjStacks[this.currentLevel][_][R];if(!L){this.scene?.removeObjStack(this.currentLevel,_,R);return}let G=-99999999;let K=null;for(let b=L.head();b;b=L.next()){const I=Y0.get(b.index);let j=I.cost;if(I.stackable){j*=b.count+1}if(j>G){G=j;K=b}}if(!K){return}L.addHead(K);let Q=-1;let H=-1;let $=0;let J=0;for(let b=L.head();b;b=L.next()){if(b.index!==K.index&&Q===-1){Q=b.index;$=b.count}if(b.index!==K.index&&b.index!==Q&&H===-1){H=b.index;J=b.count}}let O=null;if(Q!==-1){O=Y0.get(Q).getInterfaceModel($)}let q=null;if(H!==-1){q=Y0.get(H).getInterfaceModel(J)}const N=_+(R<<7)+1610612736|0;const U=Y0.get(K.index);this.scene?.addObjStack(_,R,this.getHeightmapY(this.currentLevel,_*128+64,R*128+64),this.currentLevel,N,U.getInterfaceModel(K.count),q,O)};addLoc=(_,R,L,G,K,Q,H)=>{if(R<1||L<1||R>102||L>102){return}if(d.lowMemory&&_!==this.currentLevel){return}if(!this.scene){return}let $=0;if(H===b0.WALL){$=this.scene.getWallBitset(_,R,L)}if(H===b0.WALL_DECOR){$=this.scene.getWallDecorationBitset(_,L,R)}if(H===b0.GROUND){$=this.scene.getLocBitset(_,R,L)}if(H===b0.GROUND_DECOR){$=this.scene.getGroundDecorationBitset(_,R,L)}if($!==0){const J=this.scene.getInfo(_,R,L,$);const O=$>>14&32767;const q=J&31;const N=J>>6;if(H===b0.WALL){this.scene?.removeWall(_,R,L,1);const U=h0.get(O);if(U.blockwalk){this.levelCollisionMap[_]?.removeWall(R,L,q,N,U.blockrange)}}if(H===b0.WALL_DECOR){this.scene?.removeWallDecoration(_,R,L)}if(H===b0.GROUND){this.scene.removeLoc(_,R,L);const U=h0.get(O);if(R+U.width>s.SIZE-1||L+U.width>s.SIZE-1||R+U.length>s.SIZE-1||L+U.length>s.SIZE-1){return}if(U.blockwalk){this.levelCollisionMap[_]?.removeLoc(R,L,U.width,U.length,N,U.blockrange)}}if(H===b0.GROUND_DECOR){this.scene?.removeGroundDecoration(_,R,L);const U=h0.get(O);if(U.blockwalk&&U.active){this.levelCollisionMap[_]?.removeFloor(R,L)}}}if(G>=0){let J=_;if(this.levelTileFlags&&_<3&&(this.levelTileFlags[1][R][L]&2)===2){J=_+1}if(this.levelHeightmap){H0.addLoc(_,R,L,this.scene,this.levelHeightmap,this.locList,this.levelCollisionMap[_],G,Q,K,J)}}};closeInterfaces=()=>{this.out.p1isaac(c.CLOSE_MODAL);if(this.sidebarInterfaceId!==-1){this.sidebarInterfaceId=-1;this.redrawSidebar=true;this.pressedContinueOption=false;this.redrawSideicons=true}if(this.chatInterfaceId!==-1){this.chatInterfaceId=-1;this.redrawChatback=true;this.pressedContinueOption=false}this.viewportInterfaceId=-1};async tryReconnect(){if(this.idleTimeout>0){await this.logout()}else{this.areaViewport?.bind();this.fontPlain12?.drawStringCenter(257,144,"Connection lost",X.BLACK);this.fontPlain12?.drawStringCenter(256,143,"Connection lost",X.WHITE);this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",X.BLACK);this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",X.WHITE);this.areaViewport?.draw(8,11);this.flagSceneTileX=0;this.stream?.close();this.ingame=false;await this.login(this.username,this.password,true);if(!this.ingame){await this.logout()}}}logout=async()=>{if(this.stream){this.stream.close()}this.stream=null;this.ingame=false;this.titleScreenState=0;this.username="";this.password="";S0.setDisabled();this.clearCaches();this.scene?.reset();for(let _=0;_<s.LEVELS;_++){this.levelCollisionMap[_]?.reset()}D8(false);this.currentMidi=null;this.nextMusicDelay=0;if(!d.lowMemory){await this.setMidi("scape_main",12345678,40000,false)}};read=async()=>{if(!this.stream){return false}try{let _=this.stream.available;if(_===0){return false}if(this.packetType===-1){await this.stream.readBytes(this.in.data,0,1);this.packetType=this.in.data[0]&255;if(this.randomIn){this.packetType=this.packetType-this.randomIn.nextInt&255}this.packetSize=v8.SERVERPROT_SIZES[this.packetType];_--}if(this.packetSize===-1){if(_<=0){return false}await this.stream.readBytes(this.in.data,0,1);this.packetSize=this.in.data[0]&255;_--}if(this.packetSize===-2){if(_<=1){return false}await this.stream.readBytes(this.in.data,0,2);this.in.pos=0;this.packetSize=this.in.g2;_-=2}if(_<this.packetSize){return false}this.in.pos=0;await this.stream.readBytes(this.in.data,0,this.packetSize);this.idleNetCycles=0;this.lastPacketType2=this.lastPacketType1;this.lastPacketType1=this.lastPacketType0;this.lastPacketType0=this.packetType;if(this.packetType===t.VARP_SMALL){const R=this.in.g2;const L=this.in.g1b;this.varCache[R]=L;if(this.varps[R]!==L){this.varps[R]=L;await this.updateVarp(R);this.redrawSidebar=true;if(this.stickyChatInterfaceId!==-1){this.redrawChatback=true}}this.packetType=-1;return true}if(this.packetType===t.UPDATE_FRIENDLIST){const R=this.in.g8;const L=this.in.g1;let G=I0.formatName(I0.fromBase37(R));for(let Q=0;Q<this.friendCount;Q++){if(R===this.friendName37[Q]){if(this.friendWorld[Q]!==L){this.friendWorld[Q]=L;this.redrawSidebar=true;if(L>0){this.addMessage(5,G+" has logged in.","")}if(L===0){this.addMessage(5,G+" has logged out.","")}}G=null;break}}if(G&&this.friendCount<100){this.friendName37[this.friendCount]=R;this.friendName[this.friendCount]=G;this.friendWorld[this.friendCount]=L;this.friendCount++;this.redrawSidebar=true}let K=false;while(!K){K=true;for(let Q=0;Q<this.friendCount-1;Q++){if(this.friendWorld[Q]!==d.nodeId&&this.friendWorld[Q+1]===d.nodeId||this.friendWorld[Q]===0&&this.friendWorld[Q+1]!==0){const H=this.friendWorld[Q];this.friendWorld[Q]=this.friendWorld[Q+1];this.friendWorld[Q+1]=H;const $=this.friendName[Q];this.friendName[Q]=this.friendName[Q+1];this.friendName[Q+1]=$;const J=this.friendName37[Q];this.friendName37[Q]=this.friendName37[Q+1];this.friendName37[Q+1]=J;this.redrawSidebar=true;K=false}}}this.packetType=-1;return true}if(this.packetType===t.UPDATE_REBOOT_TIMER){this.systemUpdateTimer=this.in.g2*30;this.packetType=-1;return true}if(this.packetType===t.DATA_LAND_DONE){const R=this.in.g1;const L=this.in.g1;let G=-1;if(this.sceneMapIndex){for(let K=0;K<this.sceneMapIndex.length;K++){if(this.sceneMapIndex[K]===(R<<8)+L){G=K}}}if(G!==-1){const K=this.sceneMapLandData;if(K){const Q=K[G];if(G!==-1&&Q){this.db?.cachesave(`m${R}_${L}`,Q);this.sceneState=1}}}this.packetType=-1;return true}if(this.packetType===t.NPC_INFO){this.readNpcInfo(this.in,this.packetSize);this.packetType=-1;return true}if(this.packetType===t.REBUILD_NORMAL){const R=this.in.g2;const L=this.in.g2;if(this.sceneCenterZoneX===R&&this.sceneCenterZoneZ===L&&this.sceneState!==0){this.packetType=-1;return true}this.sceneCenterZoneX=R;this.sceneCenterZoneZ=L;this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8;this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8;this.sceneState=1;this.areaViewport?.bind();this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",X.BLACK);this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",X.WHITE);this.areaViewport?.draw(8,11);const G=(this.packetSize-2)/10|0;this.sceneMapLandData=new l(G,null);this.sceneMapLocData=new l(G,null);this.sceneMapIndex=new Int32Array(G);this.out.p1isaac(c.REBUILD_GETMAPS);this.out.p1(0);let K=0;for(let b=0;b<G;b++){const I=this.in.g1;const j=this.in.g1;const F=this.in.g4;const T=this.in.g4;this.sceneMapIndex[b]=(I<<8)+j;let Y;if(F!==0){Y=await this.db?.cacheload(`m${I}_${j}`);if(Y&&p.crc32(Y)!==F){Y=undefined}if(!Y){this.sceneState=0;this.out.p1(0);this.out.p1(I);this.out.p1(j);K+=3}else{this.sceneMapLandData[b]=Y}}if(T!==0){Y=await this.db?.cacheload(`l${I}_${j}`);if(Y&&p.crc32(Y)!==T){Y=undefined}if(!Y){this.sceneState=0;this.out.p1(1);this.out.p1(I);this.out.p1(j);K+=3}else{this.sceneMapLocData[b]=Y}}}this.out.psize1(K);this.areaViewport?.bind();if(this.sceneState===0){this.fontPlain12?.drawStringCenter(257,166,"Map area updated since last visit, so load will take longer this time only",X.BLACK);this.fontPlain12?.drawStringCenter(256,165,"Map area updated since last visit, so load will take longer this time only",X.WHITE)}this.areaViewport?.draw(8,11);const Q=this.sceneBaseTileX-this.mapLastBaseX;const H=this.sceneBaseTileZ-this.mapLastBaseZ;this.mapLastBaseX=this.sceneBaseTileX;this.mapLastBaseZ=this.sceneBaseTileZ;for(let b=0;b<8192;b++){const I=this.npcs[b];if(I){for(let j=0;j<10;j++){I.pathTileX[j]-=Q;I.pathTileZ[j]-=H}I.x-=Q*128;I.z-=H*128}}for(let b=0;b<this.MAX_PLAYER_COUNT;b++){const I=this.players[b];if(I){for(let j=0;j<10;j++){I.pathTileX[j]-=Q;I.pathTileZ[j]-=H}I.x-=Q*128;I.z-=H*128}}let $=0;let J=s.SIZE;let O=1;if(Q<0){$=s.SIZE-1;J=-1;O=-1}let q=0;let N=s.SIZE;let U=1;if(H<0){q=s.SIZE-1;N=-1;U=-1}for(let b=$;b!==J;b+=O){for(let I=q;I!==N;I+=U){const j=b+Q;const F=I+H;for(let T=0;T<s.LEVELS;T++){if(j>=0&&F>=0&&j<s.SIZE&&F<s.SIZE){this.levelObjStacks[T][b][I]=this.levelObjStacks[T][j][F]}else{this.levelObjStacks[T][b][I]=null}}}}for(let b=this.spawnedLocations.head();b;b=this.spawnedLocations.next()){b.x-=Q;b.z-=H;if(b.x<0||b.z<0||b.x>=s.SIZE||b.z>=s.SIZE){b.unlink()}}if(this.flagSceneTileX!==0){this.flagSceneTileX-=Q;this.flagSceneTileZ-=H}this.cutscene=false;this.packetType=-1;return true}if(this.packetType===t.IF_SETPLAYERHEAD){g.instances[this.in.g2].model=this.localPlayer?.getHeadModel()||null;this.packetType=-1;return true}if(this.packetType===t.HINT_ARROW){this.hintType=this.in.g1;if(this.hintType===1){this.hintNpc=this.in.g2}if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2){this.hintOffsetX=64;this.hintOffsetZ=64}if(this.hintType===3){this.hintOffsetX=0;this.hintOffsetZ=64}if(this.hintType===4){this.hintOffsetX=128;this.hintOffsetZ=64}if(this.hintType===5){this.hintOffsetX=64;this.hintOffsetZ=0}if(this.hintType===6){this.hintOffsetX=64;this.hintOffsetZ=128}this.hintType=2;this.hintTileX=this.in.g2;this.hintTileZ=this.in.g2;this.hintHeight=this.in.g1}if(this.hintType===10){this.hintPlayer=this.in.g2}this.packetType=-1;return true}if(this.packetType===t.MIDI_SONG){const R=this.in.gjstr;const L=this.in.g4;const G=this.in.g4;if(!(R===this.currentMidi)&&this.midiActive&&!d.lowMemory){await this.setMidi(R,L,G,true)}this.currentMidi=R;this.midiCrc=L;this.midiSize=G;this.nextMusicDelay=0;this.packetType=-1;return true}if(this.packetType===t.LOGOUT){await this.logout();this.packetType=-1;return false}if(this.packetType===t.DATA_LOC_DONE){const R=this.in.g1;const L=this.in.g1;let G=-1;if(this.sceneMapIndex){for(let K=0;K<this.sceneMapIndex.length;K++){if(this.sceneMapIndex[K]===(R<<8)+L){G=K}}}if(G!==-1){const K=this.sceneMapLocData;if(K){const Q=K[G];if(G!==-1&&Q){this.db?.cachesave(`l${R}_${L}`,Q);this.sceneState=1}}}this.packetType=-1;return true}if(this.packetType===t.UNSET_MAP_FLAG){this.flagSceneTileX=0;this.packetType=-1;return true}if(this.packetType===t.UPDATE_UID192){this.localPid=this.in.g2;this.packetType=-1;return true}if(this.packetType===t.OBJ_COUNT||this.packetType===t.LOC_MERGE||this.packetType===t.OBJ_REVEAL||this.packetType===t.MAP_ANIM||this.packetType===t.MAP_PROJANIM||this.packetType===t.OBJ_DEL||this.packetType===t.OBJ_ADD||this.packetType===t.LOC_ANIM||this.packetType===t.LOC_DEL||this.packetType===t.LOC_ADD_CHANGE){this.readZonePacket(this.in,this.packetType);this.packetType=-1;return true}if(this.packetType===t.IF_OPENMAINSIDEMODAL){const R=this.in.g2;const L=this.in.g2;if(this.chatInterfaceId!==-1){this.chatInterfaceId=-1;this.redrawChatback=true}if(this.chatbackInputOpen){this.chatbackInputOpen=false;this.redrawChatback=true}this.viewportInterfaceId=R;this.sidebarInterfaceId=L;this.redrawSidebar=true;this.redrawSideicons=true;this.pressedContinueOption=false;this.packetType=-1;return true}if(this.packetType===t.VARP_LARGE){const R=this.in.g2;const L=this.in.g4;this.varCache[R]=L;if(this.varps[R]!==L){this.varps[R]=L;await this.updateVarp(R);this.redrawSidebar=true;if(this.stickyChatInterfaceId!==-1){this.redrawChatback=true}}this.packetType=-1;return true}if(this.packetType===t.IF_SETANIM){const R=this.in.g2;g.instances[R].anim=this.in.g2;this.packetType=-1;return true}if(this.packetType===t.IF_OPENSIDEOVERLAY){let R=this.in.g2;const L=this.in.g1;if(R===65535){R=-1}this.tabInterfaceId[L]=R;this.redrawSidebar=true;this.redrawSideicons=true;this.packetType=-1;return true}if(this.packetType===t.DATA_LOC){const R=this.in.g1;const L=this.in.g1;const G=this.in.g2;const K=this.in.g2;let Q=-1;if(this.sceneMapIndex){for(let H=0;H<this.sceneMapIndex.length;H++){if(this.sceneMapIndex[H]===(R<<8)+L){Q=H}}}if(Q!==-1&&this.sceneMapLocData){if(!this.sceneMapLocData[Q]||this.sceneMapLocData[Q]?.length!==K){this.sceneMapLocData[Q]=new Uint8Array(K)}const H=this.sceneMapLocData[Q];if(H){this.in.gdata(this.packetSize-6,G,H)}}this.packetType=-1;return true}if(this.packetType===t.FINISH_TRACKING){const R=S0.stop();if(R){this.out.p1isaac(c.EVENT_TRACKING);this.out.p2(R.pos);this.out.pdata(R.data,R.pos,0);R.release()}this.packetType=-1;return true}if(this.packetType===t.UPDATE_INV_FULL){this.redrawSidebar=true;const R=this.in.g2;const L=g.instances[R];const G=this.in.g1;if(L.invSlotObjId&&L.invSlotObjCount){for(let K=0;K<G;K++){L.invSlotObjId[K]=this.in.g2;let Q=this.in.g1;if(Q===255){Q=this.in.g4}L.invSlotObjCount[K]=Q}for(let K=G;K<L.invSlotObjId.length;K++){L.invSlotObjId[K]=0;L.invSlotObjCount[K]=0}}else{for(let K=0;K<G;K++){this.in.g2;if(this.in.g1===255){this.in.g4}}}this.packetType=-1;return true}if(this.packetType===t.ENABLE_TRACKING){S0.setEnabled();this.packetType=-1;return true}if(this.packetType===t.P_COUNTDIALOG){this.showSocialInput=false;this.chatbackInputOpen=true;this.chatbackInput="";this.redrawChatback=true;this.packetType=-1;return true}if(this.packetType===t.UPDATE_INV_STOP_TRANSMIT){const R=g.instances[this.in.g2];if(R.invSlotObjId){for(let L=0;L<R.invSlotObjId.length;L++){R.invSlotObjId[L]=-1;R.invSlotObjId[L]=0}}this.packetType=-1;return true}if(this.packetType===t.LAST_LOGIN_INFO){this.lastAddress=this.in.g4;this.daysSinceLastLogin=this.in.g2;this.daysSinceRecoveriesChanged=this.in.g1;this.unreadMessages=this.in.g2;if(this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let R=650;if(this.daysSinceRecoveriesChanged!==201){R=655}this.reportAbuseInput="";this.reportAbuseMuteOption=false;for(let L=0;L<g.instances.length;L++){if(g.instances[L]&&g.instances[L].clientCode===R){this.viewportInterfaceId=g.instances[L].layer;break}}}this.packetType=-1;return true}if(this.packetType===t.TUTORIAL_FLASHSIDE){this.flashingTab=this.in.g1;if(this.flashingTab===this.selectedTab){if(this.flashingTab===3){this.selectedTab=1}else{this.selectedTab=3}this.redrawSidebar=true}this.packetType=-1;return true}if(this.packetType===t.MIDI_JINGLE){if(this.midiActive&&!d.lowMemory){const R=this.in.g2;const L=this.in.g4;const G=this.packetSize-6;this.nextMusicDelay=R}this.packetType=-1;return true}if(this.packetType===t.SET_MULTIWAY){this.inMultizone=this.in.g1;this.packetType=-1;return true}if(this.packetType===t.SYNTH_SOUND){const R=this.in.g2;const L=this.in.g1;const G=this.in.g2;if(this.waveEnabled&&!d.lowMemory&&this.waveCount<50){this.waveIds[this.waveCount]=R;this.waveLoops[this.waveCount]=L;this.waveDelay[this.waveCount]=G+Z0.delays[R];this.waveCount++}this.packetType=-1;return true}if(this.packetType===t.IF_SETNPCHEAD){const R=this.in.g2;const L=this.in.g2;const G=_1.get(L);g.instances[R].model=G.getHeadModel();this.packetType=-1;return true}if(this.packetType===t.UPDATE_ZONE_PARTIAL_FOLLOWS){this.baseX=this.in.g1;this.baseZ=this.in.g1;this.packetType=-1;return true}if(this.packetType===t.IF_SETRECOL){const R=this.in.g2;const L=this.in.g2;const G=this.in.g2;const K=g.instances[R];const Q=K.model;Q?.recolor(L,G);this.packetType=-1;return true}if(this.packetType===t.CHAT_FILTER_SETTINGS){this.publicChatSetting=this.in.g1;this.privateChatSetting=this.in.g1;this.tradeChatSetting=this.in.g1;this.redrawPrivacySettings=true;this.redrawChatback=true;this.packetType=-1;return true}if(this.packetType===t.IF_OPENSIDEMODAL){const R=this.in.g2;this.resetInterfaceAnimation(R);if(this.chatInterfaceId!==-1){this.chatInterfaceId=-1;this.redrawChatback=true}if(this.chatbackInputOpen){this.chatbackInputOpen=false;this.redrawChatback=true}this.sidebarInterfaceId=R;this.redrawSidebar=true;this.redrawSideicons=true;this.viewportInterfaceId=-1;this.pressedContinueOption=false;this.packetType=-1;return true}if(this.packetType===t.IF_OPENCHATMODAL){const R=this.in.g2;this.resetInterfaceAnimation(R);if(this.sidebarInterfaceId!==-1){this.sidebarInterfaceId=-1;this.redrawSidebar=true;this.redrawSideicons=true}this.chatInterfaceId=R;this.redrawChatback=true;this.viewportInterfaceId=-1;this.pressedContinueOption=false;this.packetType=-1;return true}if(this.packetType===t.IF_SETPOSITION){const R=this.in.g2;const L=this.in.g2b;const G=this.in.g2b;const K=g.instances[R];K.x=L;K.y=G;this.packetType=-1;return true}if(this.packetType===t.CAM_MOVETO){this.cutscene=true;this.cutsceneSrcLocalTileX=this.in.g1;this.cutsceneSrcLocalTileZ=this.in.g1;this.cutsceneSrcHeight=this.in.g2;this.cutsceneMoveSpeed=this.in.g1;this.cutsceneMoveAcceleration=this.in.g1;if(this.cutsceneMoveAcceleration>=100){this.cameraX=this.cutsceneSrcLocalTileX*128+64;this.cameraZ=this.cutsceneSrcLocalTileZ*128+64;this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight}this.packetType=-1;return true}if(this.packetType===t.UPDATE_ZONE_FULL_FOLLOWS){this.baseX=this.in.g1;this.baseZ=this.in.g1;for(let R=this.baseX;R<this.baseX+8;R++){for(let L=this.baseZ;L<this.baseZ+8;L++){if(this.levelObjStacks[this.currentLevel][R][L]){this.levelObjStacks[this.currentLevel][R][L]=null;this.sortObjStacks(R,L)}}}for(let R=this.spawnedLocations.head();R;R=this.spawnedLocations.next()){if(R.x>=this.baseX&&R.x<this.baseX+8&&R.z>=this.baseZ&&R.z<this.baseZ+8&&R.plane===this.currentLevel){this.addLoc(R.plane,R.x,R.z,R.lastLocIndex,R.lastAngle,R.lastShape,R.layer);R.unlink()}}this.packetType=-1;return true}if(this.packetType===t.DATA_LAND){const R=this.in.g1;const L=this.in.g1;const G=this.in.g2;const K=this.in.g2;let Q=-1;if(this.sceneMapIndex){for(let H=0;H<this.sceneMapIndex.length;H++){if(this.sceneMapIndex[H]===(R<<8)+L){Q=H}}}if(Q!==-1&&this.sceneMapLandData){if(!this.sceneMapLandData[Q]||this.sceneMapLandData[Q]?.length!==K){this.sceneMapLandData[Q]=new Uint8Array(K)}const H=this.sceneMapLandData[Q];if(H){this.in.gdata(this.packetSize-6,G,H)}}this.packetType=-1;return true}if(this.packetType===t.MESSAGE_PRIVATE){const R=this.in.g8;const L=this.in.g4;const G=this.in.g1;let K=false;for(let Q=0;Q<100;Q++){if(this.messageIds[Q]===L){K=true;break}}if(G<=1){for(let Q=0;Q<this.ignoreCount;Q++){if(this.ignoreName37[Q]===R){K=true;break}}}if(!K&&this.overrideChat===0){try{this.messageIds[this.privateMessageCount]=L;this.privateMessageCount=(this.privateMessageCount+1)%100;const Q=m1.unpack(this.in,this.packetSize-13);const H=k1.filter(Q);if(G>1){this.addMessage(7,H,I0.formatName(I0.fromBase37(R)))}else{this.addMessage(3,H,I0.formatName(I0.fromBase37(R)))}}catch(Q){}}this.packetType=-1;return true}if(this.packetType===t.RESET_CLIENT_VARCACHE){for(let R=0;R<this.varps.length;R++){if(this.varps[R]!==this.varCache[R]){this.varps[R]=this.varCache[R];await this.updateVarp(R);this.redrawSidebar=true}}this.packetType=-1;return true}if(this.packetType===t.IF_SETMODEL){const R=this.in.g2;const L=this.in.g2;g.instances[R].model=E.model(L);this.packetType=-1;return true}if(this.packetType===t.TUTORIAL_OPENCHAT){this.stickyChatInterfaceId=this.in.g2b;this.redrawChatback=true;this.packetType=-1;return true}if(this.packetType===t.UPDATE_RUNENERGY){if(this.selectedTab===12){this.redrawSidebar=true}this.energy=this.in.g1;this.packetType=-1;return true}if(this.packetType===t.CAM_LOOKAT){this.cutscene=true;this.cutsceneDstLocalTileX=this.in.g1;this.cutsceneDstLocalTileZ=this.in.g1;this.cutsceneDstHeight=this.in.g2;this.cutsceneRotateSpeed=this.in.g1;this.cutsceneRotateAcceleration=this.in.g1;if(this.cutsceneRotateAcceleration>=100){const R=this.cutsceneDstLocalTileX*128+64;const L=this.cutsceneDstLocalTileZ*128+64;const G=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;const K=R-this.cameraX;const Q=G-this.cameraY;const H=L-this.cameraZ;const $=Math.sqrt(K*K+H*H)|0;this.cameraPitch=(Math.atan2(Q,$)*325.949|0)&2047;this.cameraYaw=(Math.atan2(K,H)*-325.949|0)&2047;if(this.cameraPitch<128){this.cameraPitch=128}if(this.cameraPitch>383){this.cameraPitch=383}}this.packetType=-1;return true}if(this.packetType===t.IF_SHOWSIDE){this.selectedTab=this.in.g1;this.redrawSidebar=true;this.redrawSideicons=true;this.packetType=-1;return true}if(this.packetType===t.MESSAGE_GAME){const R=this.in.gjstr;let L;if(R.endsWith(":tradereq:")){const G=R.substring(0,R.indexOf(":"));L=I0.toBase37(G);let K=false;for(let Q=0;Q<this.ignoreCount;Q++){if(this.ignoreName37[Q]===L){K=true;break}}if(!K&&this.overrideChat===0){this.addMessage(4,"wishes to trade with you.",G)}}else if(R.endsWith(":duelreq:")){const G=R.substring(0,R.indexOf(":"));L=I0.toBase37(G);let K=false;for(let Q=0;Q<this.ignoreCount;Q++){if(this.ignoreName37[Q]===L){K=true;break}}if(!K&&this.overrideChat===0){this.addMessage(8,"wishes to duel with you.",G)}}else{this.addMessage(0,R,"")}this.packetType=-1;return true}if(this.packetType===t.IF_SETOBJECT){const R=this.in.g2;const L=this.in.g2;const G=this.in.g2;const K=Y0.get(L);g.instances[R].model=K.getInterfaceModel(50);g.instances[R].xan=K.xan2d;g.instances[R].yan=K.yan2d;g.instances[R].zoom=K.zoom2d*100/G|0;this.packetType=-1;return true}if(this.packetType===t.IF_OPENMAINMODAL){const R=this.in.g2;this.resetInterfaceAnimation(R);if(this.sidebarInterfaceId!==-1){this.sidebarInterfaceId=-1;this.redrawSidebar=true;this.redrawSideicons=true}if(this.chatInterfaceId!==-1){this.chatInterfaceId=-1;this.redrawChatback=true}if(this.chatbackInputOpen){this.chatbackInputOpen=false;this.redrawChatback=true}this.viewportInterfaceId=R;this.pressedContinueOption=false;this.packetType=-1;return true}if(this.packetType===t.IF_SETCOLOUR){const R=this.in.g2;const L=this.in.g2;const G=L>>10&31;const K=L>>5&31;const Q=L&31;g.instances[R].colour=(G<<19)+(K<<11)+(Q<<3);this.packetType=-1;return true}if(this.packetType===t.RESET_ANIMS){for(let R=0;R<this.players.length;R++){const L=this.players[R];if(!L){continue}L.primarySeqId=-1}for(let R=0;R<this.npcs.length;R++){const L=this.npcs[R];if(!L){continue}L.primarySeqId=-1}this.packetType=-1;return true}if(this.packetType===t.IF_SETHIDE){const R=this.in.g2;g.instances[R].hide=this.in.g1===1;this.packetType=-1;return true}if(this.packetType===t.UPDATE_IGNORELIST){this.ignoreCount=this.packetSize/8|0;for(let R=0;R<this.ignoreCount;R++){this.ignoreName37[R]=this.in.g8}this.packetType=-1;return true}if(this.packetType===t.CAM_RESET){this.cutscene=false;for(let R=0;R<5;R++){this.cameraModifierEnabled[R]=false}this.packetType=-1;return true}if(this.packetType===t.IF_CLOSE){if(this.sidebarInterfaceId!==-1){this.sidebarInterfaceId=-1;this.redrawSidebar=true;this.redrawSideicons=true}if(this.chatInterfaceId!==-1){this.chatInterfaceId=-1;this.redrawChatback=true}if(this.chatbackInputOpen){this.chatbackInputOpen=false;this.redrawChatback=true}this.viewportInterfaceId=-1;this.pressedContinueOption=false;this.packetType=-1;return true}if(this.packetType===t.IF_SETTEXT){const R=this.in.g2;g.instances[R].text=this.in.gjstr;if(g.instances[R].layer===this.tabInterfaceId[this.selectedTab]){this.redrawSidebar=true}this.packetType=-1;return true}if(this.packetType===t.UPDATE_STAT){this.redrawSidebar=true;const R=this.in.g1;const L=this.in.g4;const G=this.in.g1;this.skillExperience[R]=L;this.skillLevel[R]=G;this.skillBaseLevel[R]=1;for(let K=0;K<98;K++){if(L>=this.levelExperience[K]){this.skillBaseLevel[R]=K+2}}this.packetType=-1;return true}if(this.packetType===t.UPDATE_ZONE_PARTIAL_ENCLOSED){this.baseX=this.in.g1;this.baseZ=this.in.g1;while(this.in.pos<this.packetSize){const R=this.in.g1;this.readZonePacket(this.in,R)}this.packetType=-1;return true}if(this.packetType===t.UPDATE_RUNWEIGHT){if(this.selectedTab===12){this.redrawSidebar=true}this.weightCarried=this.in.g2b;this.packetType=-1;return true}if(this.packetType===t.CAM_SHAKE){const R=this.in.g1;const L=this.in.g1;const G=this.in.g1;const K=this.in.g1;this.cameraModifierEnabled[R]=true;this.cameraModifierJitter[R]=L;this.cameraModifierWobbleScale[R]=G;this.cameraModifierWobbleSpeed[R]=K;this.cameraModifierCycle[R]=0;this.packetType=-1;return true}if(this.packetType===t.UPDATE_INV_PARTIAL){this.redrawSidebar=true;const R=this.in.g2;const L=g.instances[R];while(this.in.pos<this.packetSize){const G=this.in.g1;const K=this.in.g2;let Q=this.in.g1;if(Q===255){Q=this.in.g4}if(L.invSlotObjId&&L.invSlotObjCount&&G>=0&&G<L.invSlotObjId.length){L.invSlotObjId[G]=K;L.invSlotObjCount[G]=Q}}this.packetType=-1;return true}if(this.packetType===t.PLAYER_INFO){this.lastTickFlag=!this.lastTickFlag;this.readPlayerInfo(this.in,this.packetSize);if(this.sceneState===1){this.sceneState=2;H0.levelBuilt=this.currentLevel;this.buildScene()}if(d.lowMemory&&this.sceneState===2&&H0.levelBuilt!==this.currentLevel){this.areaViewport?.bind();this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",X.BLACK);this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",X.WHITE);this.areaViewport?.draw(8,11);H0.levelBuilt=this.currentLevel;this.buildScene()}if(this.currentLevel!==this.minimapLevel&&this.sceneState===2){this.minimapLevel=this.currentLevel;this.createMinimap(this.currentLevel)}this.packetType=-1;return true}await this.logout()}catch(_){await this.tryReconnect()}return true};buildScene=()=>{try{this.minimapLevel=-1;this.temporaryLocs.clear();this.locList.clear();this.spotanims.clear();this.projectiles.clear();B.clearTexels();this.clearCaches();this.scene?.reset();for(let L=0;L<s.LEVELS;L++){this.levelCollisionMap[L]?.reset()}const _=new H0(s.SIZE,s.SIZE,this.levelHeightmap,this.levelTileFlags);H0.lowMemory=d.lowMemory;const R=this.sceneMapLandData?.length??0;if(this.sceneMapIndex){for(let L=0;L<R;L++){const G=this.sceneMapIndex[L]>>8;const K=this.sceneMapIndex[L]&255;if(G===33&&K>=71&&K<=73){H0.lowMemory=false;break}}}if(d.lowMemory){this.scene?.setMinLevel(this.currentLevel)}else{this.scene?.setMinLevel(0)}if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(c.NO_TIMEOUT);for(let L=0;L<R;L++){const G=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX;const K=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ;const Q=this.sceneMapLandData[L];if(Q){const H=new p(Q).g4;const $=h1.decompress(Q,H,true,true);_.readLandscape((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,G,K,$)}else if(this.sceneCenterZoneZ<800){_.clearLandscape(K,G,64,64)}}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(c.NO_TIMEOUT);for(let L=0;L<R;L++){const G=this.sceneMapLocData[L];if(G){const K=new p(G).g4;const Q=h1.decompress(G,K,true,true);const H=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX;const $=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ;_.readLocs(this.scene,this.locList,this.levelCollisionMap,Q,H,$)}}}this.out.p1isaac(c.NO_TIMEOUT);_.build(this.scene,this.levelCollisionMap);this.areaViewport?.bind();this.out.p1isaac(c.NO_TIMEOUT);for(let L=this.locList.head();L;L=this.locList.next()){if((this.levelTileFlags&&this.levelTileFlags[1][L.heightmapNE][L.heightmapNW]&2)===2){L.heightmapSW--;if(L.heightmapSW<0){L.unlink()}}}for(let L=0;L<s.SIZE;L++){for(let G=0;G<s.SIZE;G++){this.sortObjStacks(L,G)}}for(let L=this.spawnedLocations.head();L;L=this.spawnedLocations.next()){this.addLoc(L.plane,L.x,L.z,L.locIndex,L.angle,L.shape,L.layer)}}catch(_){}h0.modelCacheStatic?.clear();B.initPool(20)};resetInterfaceAnimation=(_)=>{const R=g.instances[_];if(!R.childId){return}for(let L=0;L<R.childId.length&&R.childId[L]!==-1;L++){const G=g.instances[R.childId[L]];if(G.type===1){this.resetInterfaceAnimation(G.id)}G.seqFrame=0;G.seqCycle=0}};initializeLevelExperience=()=>{let _=0;for(let R=0;R<99;R++){const L=R+1;const G=L+Math.pow(2,L/7)*300|0;_+=G;this.levelExperience[R]=_/4|0}};addMessage=(_,R,L)=>{if(_===0&&this.stickyChatInterfaceId!==-1){this.modalMessage=R;this.mouseClickButton=0}if(this.chatInterfaceId===-1){this.redrawChatback=true}for(let G=99;G>0;G--){this.messageType[G]=this.messageType[G-1];this.messageSender[G]=this.messageSender[G-1];this.messageText[G]=this.messageText[G-1]}this.messageType[0]=_;this.messageSender[0]=L;this.messageText[0]=R};updateVarp=async(_)=>{const R=F1.instances[_].clientcode;if(R!==0){const L=this.varps[_];if(R===1){if(L===1){B.setBrightness(0.9)}if(L===2){B.setBrightness(0.8)}if(L===3){B.setBrightness(0.7)}if(L===4){B.setBrightness(0.6)}Y0.iconCache?.clear();this.redrawTitleBackground=true}if(R===3){const G=this.midiActive;if(L===0){this.midiVolume=256;K8(256);this.midiActive=true}if(L===1){this.midiVolume=192;K8(192);this.midiActive=true}if(L===2){this.midiVolume=128;K8(128);this.midiActive=true}if(L===3){this.midiVolume=64;K8(64);this.midiActive=true}if(L===4){this.midiActive=false}if(this.midiActive!==G){if(this.midiActive&&this.currentMidi){await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,false)}else{D8(false)}this.nextMusicDelay=0}}if(R===4){if(L===0){this.waveVolume=256;v1(256);this.waveEnabled=true}if(L===1){this.waveVolume=192;v1(192);this.waveEnabled=true}if(L===2){this.waveVolume=128;v1(128);this.waveEnabled=true}if(L===3){this.waveVolume=64;v1(64);this.waveEnabled=true}if(L===4){this.waveEnabled=false}}if(R===5){this.mouseButtonsOption=L}if(R===6){this.chatEffects=L}if(R===8){this.splitPrivateChat=L;this.redrawChatback=true}}};handleChatMouseInput=(_,R)=>{let L=0;for(let G=0;G<100;G++){if(!this.messageText[G]){continue}const K=this.messageType[G];const Q=this.chatScrollOffset+70+4-L*14;if(Q<-20){break}if(K===0){L++}if((K===1||K===2)&&(K===1||this.publicChatSetting===0||this.publicChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q&&this.localPlayer&&this.messageSender[G]!==this.localPlayer.name){if(this.rights){this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=34;this.menuSize++}this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=436;this.menuSize++;this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=406;this.menuSize++}L++}if((K===3||K===7)&&this.splitPrivateChat===0&&(K===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q){if(this.rights){this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=34;this.menuSize++}this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=436;this.menuSize++;this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=406;this.menuSize++}L++}if(K===4&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q){this.menuOption[this.menuSize]="Accept trade @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=903;this.menuSize++}L++}if((K===5||K===6)&&this.splitPrivateChat===0&&this.privateChatSetting<2){L++}if(K===8&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q){this.menuOption[this.menuSize]="Accept duel @whi@"+this.messageSender[G];this.menuAction[this.menuSize]=363;this.menuSize++}L++}}};handlePrivateChatInput=(_)=>{if(this.splitPrivateChat===0){return}let R=0;if(this.systemUpdateTimer!==0){R=1}for(let L=0;L<100;L++){if(this.messageText[L]!==null){const G=this.messageType[L];if((G===3||G===7)&&(G===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[L]))){const K=329-R*13;if(this.mouseX>8&&this.mouseX<520&&_-11>K-10&&_-11<=K+3){if(this.rights){this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[L];this.menuAction[this.menuSize]=2034;this.menuSize++}this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[L];this.menuAction[this.menuSize]=2436;this.menuSize++;this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[L];this.menuAction[this.menuSize]=2406;this.menuSize++}R++;if(R>=5){return}}if((G===5||G===6)&&this.privateChatSetting<2){R++;if(R>=5){return}}}}};handleInterfaceInput=(_,R,L,G,K,Q)=>{if(_.type!==0||!_.childId||_.hide||R<G||L<K||R>G+_.width||L>K+_.height||!_.childX||!_.childY){return}const H=_.childId.length;for(let $=0;$<H;$++){let J=_.childX[$]+G;let O=_.childY[$]+K-Q;const q=g.instances[_.childId[$]];J+=q.x;O+=q.y;if((q.overLayer>=0||q.overColour!==0)&&R>=J&&L>=O&&R<J+q.width&&L<O+q.height){if(q.overLayer>=0){this.lastHoveredInterfaceId=q.overLayer}else{this.lastHoveredInterfaceId=q.id}}if(q.type===0){this.handleInterfaceInput(q,R,L,J,O,q.scrollPosition);if(q.scroll>q.height){this.handleScrollInput(R,L,q.scroll,q.height,true,J+q.width,O,q)}}else if(q.type===2){let N=0;for(let U=0;U<q.height;U++){for(let b=0;b<q.width;b++){let I=J+b*(q.marginX+32);let j=O+U*(q.marginY+32);if(N<20&&q.invSlotOffsetX&&q.invSlotOffsetY){I+=q.invSlotOffsetX[N];j+=q.invSlotOffsetY[N]}if(R<I||L<j||R>=I+32||L>=j+32){N++;continue}this.hoveredSlot=N;this.hoveredSlotParentId=q.id;if(!q.invSlotObjId||q.invSlotObjId[N]<=0){N++;continue}const F=Y0.get(q.invSlotObjId[N]-1);if(this.objSelected===1&&q.interactable){if(q.id!==this.objSelectedInterface||N!==this.objSelectedSlot){this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+F.name;this.menuAction[this.menuSize]=881;this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}else if(this.spellSelected===1&&q.interactable){if((this.activeSpellFlags&16)===16){this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+F.name;this.menuAction[this.menuSize]=391;this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}else{if(q.interactable){for(let T=4;T>=3;T--){if(F.iop&&F.iop[T]){this.menuOption[this.menuSize]=F.iop[T]+" @lre@"+F.name;if(T===3){this.menuAction[this.menuSize]=478}else if(T===4){this.menuAction[this.menuSize]=347}this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}else if(T===4){this.menuOption[this.menuSize]="Drop @lre@"+F.name;this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}}if(q.usable){this.menuOption[this.menuSize]="Use @lre@"+F.name;this.menuAction[this.menuSize]=188;this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}if(q.interactable&&F.iop){for(let T=2;T>=0;T--){if(F.iop[T]){this.menuOption[this.menuSize]=F.iop[T]+" @lre@"+F.name;if(T===0){this.menuAction[this.menuSize]=405}else if(T===1){this.menuAction[this.menuSize]=38}else if(T===2){this.menuAction[this.menuSize]=422}this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}}if(q.iops){for(let T=4;T>=0;T--){if(q.iops[T]){this.menuOption[this.menuSize]=q.iops[T]+" @lre@"+F.name;if(T===0){this.menuAction[this.menuSize]=602}else if(T===1){this.menuAction[this.menuSize]=596}else if(T===2){this.menuAction[this.menuSize]=22}else if(T===3){this.menuAction[this.menuSize]=892}else if(T===4){this.menuAction[this.menuSize]=415}this.menuParamA[this.menuSize]=F.id;this.menuParamB[this.menuSize]=N;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}}this.menuOption[this.menuSize]="Examine @lre@"+F.name;this.menuAction[this.menuSize]=1773;this.menuParamA[this.menuSize]=F.id;if(q.invSlotObjCount){this.menuParamC[this.menuSize]=q.invSlotObjCount[N]}this.menuSize++}N++}}}else if(R>=J&&L>=O&&R<J+q.width&&L<O+q.height){if(q.buttonType===g.BUTTON_OK){let N=false;if(q.clientCode!==0){N=this.handleSocialMenuOption(q)}if(!N&&q.option){this.menuOption[this.menuSize]=q.option;this.menuAction[this.menuSize]=951;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}else if(q.buttonType===g.BUTTON_TARGET&&this.spellSelected===0){let N=q.actionVerb;if(N&&N.indexOf(" ")!==-1){N=N.substring(0,N.indexOf(" "))}this.menuOption[this.menuSize]=N+" @gre@"+q.action;this.menuAction[this.menuSize]=930;this.menuParamC[this.menuSize]=q.id;this.menuSize++}else if(q.buttonType===g.BUTTON_CLOSE){this.menuOption[this.menuSize]="Close";this.menuAction[this.menuSize]=947;this.menuParamC[this.menuSize]=q.id;this.menuSize++}else if(q.buttonType===g.BUTTON_TOGGLE&&q.option){this.menuOption[this.menuSize]=q.option;this.menuAction[this.menuSize]=465;this.menuParamC[this.menuSize]=q.id;this.menuSize++}else if(q.buttonType===g.BUTTON_SELECT&&q.option){this.menuOption[this.menuSize]=q.option;this.menuAction[this.menuSize]=960;this.menuParamC[this.menuSize]=q.id;this.menuSize++}else if(q.buttonType===g.BUTTON_CONTINUE&&!this.pressedContinueOption&&q.option){this.menuOption[this.menuSize]=q.option;this.menuAction[this.menuSize]=44;this.menuParamC[this.menuSize]=q.id;this.menuSize++}}}};handleSocialMenuOption=(_)=>{let R=_.clientCode;if(R>=g.CC_FRIENDS_START&&R<=g.CC_FRIENDS_UPDATE_END){if(R>=g.CC_FRIENDS_UPDATE_START){R-=g.CC_FRIENDS_UPDATE_START}else{R--}this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[R];this.menuAction[this.menuSize]=557;this.menuSize++;this.menuOption[this.menuSize]="Message @whi@"+this.friendName[R];this.menuAction[this.menuSize]=679;this.menuSize++;return true}else if(R>=g.CC_IGNORES_START&&R<=g.CC_IGNORES_END){this.menuOption[this.menuSize]="Remove @whi@"+_.text;this.menuAction[this.menuSize]=556;this.menuSize++;return true}return false};handleViewportOptions=()=>{if(this.objSelected===0&&this.spellSelected===0){this.menuOption[this.menuSize]="Walk here";this.menuAction[this.menuSize]=660;this.menuParamB[this.menuSize]=this.mouseX;this.menuParamC[this.menuSize]=this.mouseY;this.menuSize++}let _=-1;for(let R=0;R<E.pickedCount;R++){const L=E.pickedBitsets[R];const G=L&127;const K=L>>7&127;const Q=L>>29&3;const H=L>>14&32767;if(L===_){continue}_=L;if(Q===2&&this.scene&&this.scene.getInfo(this.currentLevel,G,K,L)>=0){const $=h0.get(H);if(this.objSelected===1){this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+$.name;this.menuAction[this.menuSize]=450;this.menuParamA[this.menuSize]=L;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}else if(this.spellSelected!==1){if($.op){for(let J=4;J>=0;J--){if($.op[J]){this.menuOption[this.menuSize]=$.op[J]+" @cya@"+$.name;if(J===0){this.menuAction[this.menuSize]=285}if(J===1){this.menuAction[this.menuSize]=504}if(J===2){this.menuAction[this.menuSize]=364}if(J===3){this.menuAction[this.menuSize]=581}if(J===4){this.menuAction[this.menuSize]=1501}this.menuParamA[this.menuSize]=L;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}}}this.menuOption[this.menuSize]="Examine @cya@"+$.name;this.menuAction[this.menuSize]=1175;this.menuParamA[this.menuSize]=L;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}else if((this.activeSpellFlags&4)===4){this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+$.name;this.menuAction[this.menuSize]=55;this.menuParamA[this.menuSize]=L;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}}if(Q===1){const $=this.npcs[H];if($&&$.type&&$.type.size===1&&($.x&127)===64&&($.z&127)===64){for(let J=0;J<this.npcCount;J++){const O=this.npcs[this.npcIds[J]];if(O&&O!==$&&O.type&&O.type.size===1&&O.x===$.x&&O.z===$.z){this.addNpcOptions(O.type,this.npcIds[J],G,K)}}}if($&&$.type){this.addNpcOptions($.type,H,G,K)}}if(Q===0){const $=this.players[H];if($&&($.x&127)===64&&($.z&127)===64){for(let J=0;J<this.npcCount;J++){const O=this.npcs[this.npcIds[J]];if(O&&O.type&&O.type.size===1&&O.x===$.x&&O.z===$.z){this.addNpcOptions(O.type,this.npcIds[J],G,K)}}for(let J=0;J<this.playerCount;J++){const O=this.players[this.playerIds[J]];if(O&&O!==$&&O.x===$.x&&O.z===$.z){this.addPlayerOptions(O,this.playerIds[J],G,K)}}}if($){this.addPlayerOptions($,H,G,K)}}if(Q===3){const $=this.levelObjStacks[this.currentLevel][G][K];if(!$){continue}for(let J=$.tail();J;J=$.prev()){const O=Y0.get(J.index);if(this.objSelected===1){this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+O.name;this.menuAction[this.menuSize]=217;this.menuParamA[this.menuSize]=J.index;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}else if(this.spellSelected!==1){for(let q=4;q>=0;q--){if(O.op&&O.op[q]){this.menuOption[this.menuSize]=O.op[q]+" @lre@"+O.name;if(q===0){this.menuAction[this.menuSize]=224}if(q===1){this.menuAction[this.menuSize]=993}if(q===2){this.menuAction[this.menuSize]=99}if(q===3){this.menuAction[this.menuSize]=746}if(q===4){this.menuAction[this.menuSize]=877}this.menuParamA[this.menuSize]=J.index;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}else if(q===2){this.menuOption[this.menuSize]="Take @lre@"+O.name;this.menuAction[this.menuSize]=99;this.menuParamA[this.menuSize]=J.index;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}}this.menuOption[this.menuSize]="Examine @lre@"+O.name;this.menuAction[this.menuSize]=1102;this.menuParamA[this.menuSize]=J.index;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}else if((this.activeSpellFlags&1)===1){this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+O.name;this.menuAction[this.menuSize]=965;this.menuParamA[this.menuSize]=J.index;this.menuParamB[this.menuSize]=G;this.menuParamC[this.menuSize]=K;this.menuSize++}}}}};addNpcOptions=(_,R,L,G)=>{if(this.menuSize>=400){return}let K=_.name;if(_.vislevel!==0&&this.localPlayer){K=K+this.getCombatLevelColorTag(this.localPlayer.combatLevel,_.vislevel)+" (level-"+_.vislevel+")"}if(this.objSelected===1){this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+K;this.menuAction[this.menuSize]=900;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}else if(this.spellSelected!==1){let Q;if(_.op){for(Q=4;Q>=0;Q--){if(_.op[Q]&&_.op[Q]?.toLowerCase()!=="attack"){this.menuOption[this.menuSize]=_.op[Q]+" @yel@"+K;if(Q===0){this.menuAction[this.menuSize]=728}else if(Q===1){this.menuAction[this.menuSize]=542}else if(Q===2){this.menuAction[this.menuSize]=6}else if(Q===3){this.menuAction[this.menuSize]=963}else if(Q===4){this.menuAction[this.menuSize]=245}this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}}}if(_.op){for(Q=4;Q>=0;Q--){if(_.op[Q]&&_.op[Q]?.toLowerCase()==="attack"){let H=0;if(this.localPlayer&&_.vislevel>this.localPlayer.combatLevel){H=2000}this.menuOption[this.menuSize]=_.op[Q]+" @yel@"+K;if(Q===0){this.menuAction[this.menuSize]=H+728}else if(Q===1){this.menuAction[this.menuSize]=H+542}else if(Q===2){this.menuAction[this.menuSize]=H+6}else if(Q===3){this.menuAction[this.menuSize]=H+963}else if(Q===4){this.menuAction[this.menuSize]=H+245}this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}}}this.menuOption[this.menuSize]="Examine @yel@"+K;this.menuAction[this.menuSize]=1607;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}else if((this.activeSpellFlags&2)===2){this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+K;this.menuAction[this.menuSize]=265;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}};addPlayerOptions=(_,R,L,G)=>{if(_===this.localPlayer||this.menuSize>=400){return}let K=null;if(this.localPlayer){K=_.name+this.getCombatLevelColorTag(this.localPlayer.combatLevel,_.combatLevel)+" (level-"+_.combatLevel+")"}if(this.objSelected===1){this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+K;this.menuAction[this.menuSize]=367;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}else if(this.spellSelected!==1){this.menuOption[this.menuSize]="Follow @whi@"+K;this.menuAction[this.menuSize]=1544;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++;if(this.overrideChat===0){this.menuOption[this.menuSize]="Trade with @whi@"+K;this.menuAction[this.menuSize]=1373;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}if(this.wildernessLevel>0){this.menuOption[this.menuSize]="Attack @whi@"+K;if(this.localPlayer&&this.localPlayer.combatLevel>=_.combatLevel){this.menuAction[this.menuSize]=151}else{this.menuAction[this.menuSize]=2151}this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}if(this.worldLocationState===1){this.menuOption[this.menuSize]="Fight @whi@"+K;this.menuAction[this.menuSize]=151;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}if(this.worldLocationState===2){this.menuOption[this.menuSize]="Duel-with @whi@"+K;this.menuAction[this.menuSize]=1101;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}}else if((this.activeSpellFlags&8)===8){this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+K;this.menuAction[this.menuSize]=651;this.menuParamA[this.menuSize]=R;this.menuParamB[this.menuSize]=L;this.menuParamC[this.menuSize]=G;this.menuSize++}for(let Q=0;Q<this.menuSize;Q++){if(this.menuAction[Q]===660){this.menuOption[Q]="Walk here @whi@"+K;return}}};getCombatLevelColorTag=(_,R)=>{const L=_-R;if(L<-9){return"@red@"}else if(L<-6){return"@or3@"}else if(L<-3){return"@or2@"}else if(L<0){return"@or1@"}else if(L>9){return"@gre@"}else if(L>6){return"@gr3@"}else if(L>3){return"@gr2@"}else if(L>0){return"@gr1@"}else{return"@yel@"}};handleInput=()=>{if(this.objDragArea===0){this.menuOption[0]="Cancel";this.menuAction[0]=1252;this.menuSize=1;this.handlePrivateChatInput(this.mouseY);this.lastHoveredInterfaceId=0;if(this.mouseX>8&&this.mouseY>11&&this.mouseX<520&&this.mouseY<345){if(this.viewportInterfaceId===-1){this.handleViewportOptions()}else{this.handleInterfaceInput(g.instances[this.viewportInterfaceId],this.mouseX,this.mouseY,8,11,0)}}if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex){this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId}this.lastHoveredInterfaceId=0;if(this.mouseX>562&&this.mouseY>231&&this.mouseX<752&&this.mouseY<492){if(this.sidebarInterfaceId!==-1){this.handleInterfaceInput(g.instances[this.sidebarInterfaceId],this.mouseX,this.mouseY,562,231,0)}else if(this.tabInterfaceId[this.selectedTab]!==-1){this.handleInterfaceInput(g.instances[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,562,231,0)}}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex){this.redrawSidebar=true;this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId}this.lastHoveredInterfaceId=0;if(this.mouseX>22&&this.mouseY>375&&this.mouseX<431&&this.mouseY<471){if(this.chatInterfaceId===-1){this.handleChatMouseInput(this.mouseX-22,this.mouseY-375)}else{this.handleInterfaceInput(g.instances[this.chatInterfaceId],this.mouseX,this.mouseY,22,375,0)}}if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex){this.redrawChatback=true;this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId}let _=false;while(!_){_=true;for(let R=0;R<this.menuSize-1;R++){if(this.menuAction[R]<1000&&this.menuAction[R+1]>1000){const L=this.menuOption[R];this.menuOption[R]=this.menuOption[R+1];this.menuOption[R+1]=L;const G=this.menuAction[R];this.menuAction[R]=this.menuAction[R+1];this.menuAction[R+1]=G;const K=this.menuParamB[R];this.menuParamB[R]=this.menuParamB[R+1];this.menuParamB[R+1]=K;const Q=this.menuParamC[R];this.menuParamC[R]=this.menuParamC[R+1];this.menuParamC[R+1]=Q;const H=this.menuParamA[R];this.menuParamA[R]=this.menuParamA[R+1];this.menuParamA[R+1]=H;_=false}}}}};showContextMenu=()=>{let _=0;if(this.fontBold12){_=this.fontBold12.stringWidth("Choose Option");let K;for(let Q=0;Q<this.menuSize;Q++){K=this.fontBold12.stringWidth(this.menuOption[Q]);if(K>_){_=K}}}_+=8;const R=this.menuSize*15+21;let L;let G;if(this.mouseClickX>8&&this.mouseClickY>11&&this.mouseClickX<520&&this.mouseClickY<345){L=this.mouseClickX-(_/2|0)-8;if(L+_>512){L=512-_}else if(L<0){L=0}G=this.mouseClickY-11;if(G+R>334){G=334-R}else if(G<0){G=0}this.menuVisible=true;this.menuArea=0;this.menuX=L;this.menuY=G;this.menuWidth=_;this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>562&&this.mouseClickY>231&&this.mouseClickX<752&&this.mouseClickY<492){L=this.mouseClickX-(_/2|0)-562;if(L<0){L=0}else if(L+_>190){L=190-_}G=this.mouseClickY-231;if(G<0){G=0}else if(G+R>261){G=261-R}this.menuVisible=true;this.menuArea=1;this.menuX=L;this.menuY=G;this.menuWidth=_;this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>22&&this.mouseClickY>375&&this.mouseClickX<501&&this.mouseClickY<471){L=this.mouseClickX-(_/2|0)-22;if(L<0){L=0}else if(L+_>479){L=479-_}G=this.mouseClickY-375;if(G<0){G=0}else if(G+R>96){G=96-R}this.menuVisible=true;this.menuArea=2;this.menuX=L;this.menuY=G;this.menuWidth=_;this.menuHeight=this.menuSize*15+22}};tryMove=(_,R,L,G,K,Q,H,$,J,O,q)=>{const N=this.levelCollisionMap[this.currentLevel];if(!N){return false}const U=s.SIZE;const b=s.SIZE;for(let A=0;A<U;A++){for(let P=0;P<b;P++){const z=s.index(A,P);this.bfsDirection[z]=0;this.bfsCost[z]=99999999}}let I=_;let j=R;const F=s.index(_,R);this.bfsDirection[F]=99;this.bfsCost[F]=0;let T=0;let Y=0;this.bfsStepX[T]=_;this.bfsStepZ[T++]=R;let u=false;let w=this.bfsStepX.length;const h=N.flags;while(Y!==T){I=this.bfsStepX[Y];j=this.bfsStepZ[Y];Y=(Y+1)%w;if(I===L&&j===G){u=true;break}if(J!==y.WALL_STRAIGHT.id){if((J<y.WALLDECOR_STRAIGHT_OFFSET.id||J===y.CENTREPIECE_STRAIGHT.id)&&N.reachedWall(I,j,L,G,J-1,$)){u=true;break}if(J<y.CENTREPIECE_STRAIGHT.id&&N.reachedWallDecoration(I,j,L,G,J-1,$)){u=true;break}}if(Q!==0&&H!==0&&N.reachedLoc(I,j,L,G,Q,H,O)){u=true;break}const A=this.bfsCost[s.index(I,j)]+1;let P=s.index(I-1,j);if(I>0&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_WEST)===S.OPEN){this.bfsStepX[T]=I-1;this.bfsStepZ[T]=j;T=(T+1)%w;this.bfsDirection[P]=2;this.bfsCost[P]=A}P=s.index(I+1,j);if(I<U-1&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_EAST)===S.OPEN){this.bfsStepX[T]=I+1;this.bfsStepZ[T]=j;T=(T+1)%w;this.bfsDirection[P]=8;this.bfsCost[P]=A}P=s.index(I,j-1);if(j>0&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_SOUTH)===S.OPEN){this.bfsStepX[T]=I;this.bfsStepZ[T]=j-1;T=(T+1)%w;this.bfsDirection[P]=1;this.bfsCost[P]=A}P=s.index(I,j+1);if(j<b-1&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_NORTH)===S.OPEN){this.bfsStepX[T]=I;this.bfsStepZ[T]=j+1;T=(T+1)%w;this.bfsDirection[P]=4;this.bfsCost[P]=A}P=s.index(I-1,j-1);if(I>0&&j>0&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_SOUTH_WEST)===0&&(h[s.index(I-1,j)]&S.BLOCK_WEST)===S.OPEN&&(h[s.index(I,j-1)]&S.BLOCK_SOUTH)===S.OPEN){this.bfsStepX[T]=I-1;this.bfsStepZ[T]=j-1;T=(T+1)%w;this.bfsDirection[P]=3;this.bfsCost[P]=A}P=s.index(I+1,j-1);if(I<U-1&&j>0&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_SOUTH_EAST)===0&&(h[s.index(I+1,j)]&S.BLOCK_EAST)===S.OPEN&&(h[s.index(I,j-1)]&S.BLOCK_SOUTH)===S.OPEN){this.bfsStepX[T]=I+1;this.bfsStepZ[T]=j-1;T=(T+1)%w;this.bfsDirection[P]=9;this.bfsCost[P]=A}P=s.index(I-1,j+1);if(I>0&&j<b-1&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_NORTH_WEST)===0&&(h[s.index(I-1,j)]&S.BLOCK_WEST)===S.OPEN&&(h[s.index(I,j+1)]&S.BLOCK_NORTH)===S.OPEN){this.bfsStepX[T]=I-1;this.bfsStepZ[T]=j+1;T=(T+1)%w;this.bfsDirection[P]=6;this.bfsCost[P]=A}P=s.index(I+1,j+1);if(I<U-1&&j<b-1&&this.bfsDirection[P]===0&&(h[P]&S.BLOCK_NORTH_EAST)===0&&(h[s.index(I+1,j)]&S.BLOCK_EAST)===S.OPEN&&(h[s.index(I,j+1)]&S.BLOCK_NORTH)===S.OPEN){this.bfsStepX[T]=I+1;this.bfsStepZ[T]=j+1;T=(T+1)%w;this.bfsDirection[P]=12;this.bfsCost[P]=A}}this.tryMoveNearest=0;if(!u){if(q){let A=100;for(let P=1;P<2;P++){for(let z=L-P;z<=L+P;z++){for(let f=G-P;f<=G+P;f++){const m=s.index(z,f);if(z>=0&&f>=0&&z<s.SIZE&&f<s.SIZE&&this.bfsCost[m]<A){A=this.bfsCost[m];I=z;j=f;this.tryMoveNearest=1;u=true}}}if(u){break}}}if(!u){return false}}Y=0;this.bfsStepX[Y]=I;this.bfsStepZ[Y++]=j;let v=this.bfsDirection[s.index(I,j)];let n=v;while(I!==_||j!==R){if(n!==v){v=n;this.bfsStepX[Y]=I;this.bfsStepZ[Y++]=j}if((n&K1.EAST)!==0){I++}else if((n&K1.WEST)!==0){I--}if((n&K1.NORTH)!==0){j++}else if((n&K1.SOUTH)!==0){j--}n=this.bfsDirection[s.index(I,j)]}if(Y>0){w=Math.min(Y,25);Y--;const A=this.bfsStepX[Y];const P=this.bfsStepZ[Y];if(K===0){this.out.p1isaac(c.MOVE_GAMECLICK);this.out.p1(w+w+3)}else if(K===1){this.out.p1isaac(c.MOVE_MINIMAPCLICK);this.out.p1(w+w+3+14)}else if(K===2){this.out.p1isaac(c.MOVE_OPCLICK);this.out.p1(w+w+3)}if(this.actionKey[5]===1){this.out.p1(1)}else{this.out.p1(0)}this.out.p2(A+this.sceneBaseTileX);this.out.p2(P+this.sceneBaseTileZ);this.flagSceneTileX=this.bfsStepX[0];this.flagSceneTileZ=this.bfsStepZ[0];for(let z=1;z<w;z++){Y--;this.out.p1(this.bfsStepX[Y]-A);this.out.p1(this.bfsStepZ[Y]-P)}return true}return K!==1};readPlayerInfo=(_,R)=>{this.entityRemovalCount=0;this.entityUpdateCount=0;this.readLocalPlayer(_);this.readPlayers(_);this.readNewPlayers(_,R);this.readPlayerUpdates(_);for(let L=0;L<this.entityRemovalCount;L++){const G=this.entityRemovalIds[L];const K=this.players[G];if(!K){continue}if(K.cycle!==this.loopCycle){this.players[G]=null}}if(_.pos!==R){throw new Error(`eek! Error packet size mismatch in getplayer pos:${_.pos} psize:${R}`)}for(let L=0;L<this.playerCount;L++){if(!this.players[this.playerIds[L]]){throw new Error(`eek! ${this.username} null entry in pl list - pos:${L} size:${this.playerCount}`)}}};readLocalPlayer=(_)=>{_.bits();const R=_.gBit(1);if(R!==0){const L=_.gBit(2);if(L===0){this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}else if(L===1){const G=_.gBit(3);this.localPlayer?.step(false,G);const K=_.gBit(1);if(K===1){this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}}else if(L===2){const G=_.gBit(3);this.localPlayer?.step(true,G);const K=_.gBit(3);this.localPlayer?.step(true,K);const Q=_.gBit(1);if(Q===1){this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}}else if(L===3){this.currentLevel=_.gBit(2);const G=_.gBit(7);const K=_.gBit(7);const Q=_.gBit(1);this.localPlayer?.move(Q===1,G,K);const H=_.gBit(1);if(H===1){this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}}}};readPlayers=(_)=>{const R=_.gBit(8);if(R<this.playerCount){for(let L=R;L<this.playerCount;L++){this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[L]}}if(R>this.playerCount){throw new Error(`eek! ${this.username} Too many players`)}this.playerCount=0;for(let L=0;L<R;L++){const G=this.playerIds[L];const K=this.players[G];const Q=_.gBit(1);if(Q===0){this.playerIds[this.playerCount++]=G;if(K){K.cycle=this.loopCycle}}else{const H=_.gBit(2);if(H===0){this.playerIds[this.playerCount++]=G;if(K){K.cycle=this.loopCycle}this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===1){this.playerIds[this.playerCount++]=G;if(K){K.cycle=this.loopCycle}const $=_.gBit(3);K?.step(false,$);const J=_.gBit(1);if(J===1){this.entityUpdateIds[this.entityUpdateCount++]=G}}else if(H===2){this.playerIds[this.playerCount++]=G;if(K){K.cycle=this.loopCycle}const $=_.gBit(3);K?.step(true,$);const J=_.gBit(3);K?.step(true,J);const O=_.gBit(1);if(O===1){this.entityUpdateIds[this.entityUpdateCount++]=G}}else if(H===3){this.entityRemovalIds[this.entityRemovalCount++]=G}}}};readNewPlayers=(_,R)=>{let L;while(_.bitPos+10<R*8){L=_.gBit(11);if(L===2047){break}if(!this.players[L]){this.players[L]=new U0;const J=this.playerAppearanceBuffer[L];if(J){this.players[L]?.read(J)}}this.playerIds[this.playerCount++]=L;const G=this.players[L];if(G){G.cycle=this.loopCycle}let K=_.gBit(5);if(K>15){K-=32}let Q=_.gBit(5);if(Q>15){Q-=32}const H=_.gBit(1);if(this.localPlayer){G?.move(H===1,this.localPlayer.pathTileX[0]+K,this.localPlayer.pathTileZ[0]+Q)}const $=_.gBit(1);if($===1){this.entityUpdateIds[this.entityUpdateCount++]=L}}_.bytes()};readPlayerUpdates=(_)=>{for(let R=0;R<this.entityUpdateCount;R++){const L=this.entityUpdateIds[R];const G=this.players[L];if(!G){continue}let K=_.g1;if((K&U0.BIG_UPDATE)===U0.BIG_UPDATE){K+=_.g1<<8}this.readPlayerUpdatesBlocks(G,L,K,_)}};readPlayerUpdatesBlocks=(_,R,L,G)=>{_.lastMask=L;_.lastMaskCycle=this.loopCycle;if((L&U0.APPEARANCE)===U0.APPEARANCE){const K=G.g1;const Q=new Uint8Array(K);const H=new p(Q);G.gdata(K,0,Q);this.playerAppearanceBuffer[R]=H;_.read(H)}if((L&U0.ANIM)===U0.ANIM){let K=G.g2;if(K===65535){K=-1}if(K===_.primarySeqId){_.primarySeqLoop=0}const Q=G.g1;if(K===-1||_.primarySeqId===-1||G0.instances[K].priority>G0.instances[_.primarySeqId].priority||G0.instances[_.primarySeqId].priority===0){_.primarySeqId=K;_.primarySeqFrame=0;_.primarySeqCycle=0;_.primarySeqDelay=Q;_.primarySeqLoop=0}}if((L&U0.FACE_ENTITY)===U0.FACE_ENTITY){_.targetId=G.g2;if(_.targetId===65535){_.targetId=-1}}if((L&U0.SAY)===U0.SAY){_.chat=G.gjstr;_.chatColor=0;_.chatStyle=0;_.chatTimer=150;if(_.name){this.addMessage(2,_.chat,_.name)}}if((L&U0.DAMAGE)===U0.DAMAGE){_.damage=G.g1;_.damageType=G.g1;_.combatCycle=this.loopCycle+400;_.health=G.g1;_.totalHealth=G.g1}if((L&U0.FACE_COORD)===U0.FACE_COORD){_.targetTileX=G.g2;_.targetTileZ=G.g2;_.lastFaceX=_.targetTileX;_.lastFaceZ=_.targetTileZ}if((L&U0.CHAT)===U0.CHAT){const K=G.g2;const Q=G.g1;const H=G.g1;const $=G.pos;if(_.name){const J=I0.toBase37(_.name);let O=false;if(Q<=1){for(let q=0;q<this.ignoreCount;q++){if(this.ignoreName37[q]===J){O=true;break}}}if(!O&&this.overrideChat===0){try{const q=m1.unpack(G,H);const N=k1.filter(q);_.chat=N;_.chatColor=K>>8;_.chatStyle=K&255;_.chatTimer=150;if(Q>1){this.addMessage(1,N,_.name)}else{this.addMessage(2,N,_.name)}}catch(q){}}}G.pos=$+H}if((L&U0.SPOTANIM)===U0.SPOTANIM){_.spotanimId=G.g2;const K=G.g4;_.spotanimOffset=K>>16;_.spotanimLastCycle=this.loopCycle+(K&65535);_.spotanimFrame=0;_.spotanimCycle=0;if(_.spotanimLastCycle>this.loopCycle){_.spotanimFrame=-1}if(_.spotanimId===65535){_.spotanimId=-1}}if((L&U0.EXACT_MOVE)===U0.EXACT_MOVE){_.forceMoveStartSceneTileX=G.g1;_.forceMoveStartSceneTileZ=G.g1;_.forceMoveEndSceneTileX=G.g1;_.forceMoveEndSceneTileZ=G.g1;_.forceMoveEndCycle=G.g2+this.loopCycle;_.forceMoveStartCycle=G.g2+this.loopCycle;_.forceMoveFaceDirection=G.g1;_.pathLength=0;_.pathTileX[0]=_.forceMoveEndSceneTileX;_.pathTileZ[0]=_.forceMoveEndSceneTileZ}};readNpcInfo=(_,R)=>{this.entityRemovalCount=0;this.entityUpdateCount=0;this.readNpcs(_);this.readNewNpcs(_,R);this.readNpcUpdates(_);for(let L=0;L<this.entityRemovalCount;L++){const G=this.entityRemovalIds[L];const K=this.npcs[G];if(!K){continue}if(K.cycle!==this.loopCycle){K.type=null;this.npcs[G]=null}}if(_.pos!==R){throw new Error(`eek! ${this.username} size mismatch in getnpcpos - pos:${_.pos} psize:${R}`)}for(let L=0;L<this.npcCount;L++){if(!this.npcs[this.npcIds[L]]){throw new Error(`eek! ${this.username} null entry in npc list - pos:${L} size:${this.npcCount}`)}}};readNpcs=(_)=>{_.bits();const R=_.gBit(8);if(R<this.npcCount){for(let L=R;L<this.npcCount;L++){this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[L]}}if(R>this.npcCount){throw new Error(`eek! ${this.username} Too many npcs`)}this.npcCount=0;for(let L=0;L<R;L++){const G=this.npcIds[L];const K=this.npcs[G];const Q=_.gBit(1);if(Q===0){this.npcIds[this.npcCount++]=G;if(K){K.cycle=this.loopCycle}}else{const H=_.gBit(2);if(H===0){this.npcIds[this.npcCount++]=G;if(K){K.cycle=this.loopCycle}this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===1){this.npcIds[this.npcCount++]=G;if(K){K.cycle=this.loopCycle}const $=_.gBit(3);K?.step(false,$);const J=_.gBit(1);if(J===1){this.entityUpdateIds[this.entityUpdateCount++]=G}}else if(H===2){this.npcIds[this.npcCount++]=G;if(K){K.cycle=this.loopCycle}const $=_.gBit(3);K?.step(true,$);const J=_.gBit(3);K?.step(true,J);const O=_.gBit(1);if(O===1){this.entityUpdateIds[this.entityUpdateCount++]=G}}else if(H===3){this.entityRemovalIds[this.entityRemovalCount++]=G}}}};readNewNpcs=(_,R)=>{while(_.bitPos+21<R*8){const L=_.gBit(13);if(L===8191){break}if(!this.npcs[L]){this.npcs[L]=new f0}const G=this.npcs[L];this.npcIds[this.npcCount++]=L;if(G){G.cycle=this.loopCycle;G.type=_1.get(_.gBit(11));G.size=G.type.size;G.seqWalkId=G.type.walkanim;G.seqTurnAroundId=G.type.walkanim_b;G.seqTurnLeftId=G.type.walkanim_r;G.seqTurnRightId=G.type.walkanim_l;G.seqStandId=G.type.readyanim}else{_.gBit(11)}let K=_.gBit(5);if(K>15){K-=32}let Q=_.gBit(5);if(Q>15){Q-=32}if(this.localPlayer){G?.move(false,this.localPlayer.pathTileX[0]+K,this.localPlayer.pathTileZ[0]+Q)}const H=_.gBit(1);if(H===1){this.entityUpdateIds[this.entityUpdateCount++]=L}}_.bytes()};readNpcUpdates=(_)=>{for(let R=0;R<this.entityUpdateCount;R++){const L=this.entityUpdateIds[R];const G=this.npcs[L];if(!G){continue}const K=_.g1;G.lastMask=K;G.lastMaskCycle=this.loopCycle;if((K&f0.ANIM)===f0.ANIM){let Q=_.g2;if(Q===65535){Q=-1}if(Q===G.primarySeqId){G.primarySeqLoop=0}const H=_.g1;if(Q===-1||G.primarySeqId===-1||G0.instances[Q].priority>G0.instances[G.primarySeqId].priority||G0.instances[G.primarySeqId].priority===0){G.primarySeqId=Q;G.primarySeqFrame=0;G.primarySeqCycle=0;G.primarySeqDelay=H;G.primarySeqLoop=0}}if((K&f0.FACE_ENTITY)===f0.FACE_ENTITY){G.targetId=_.g2;if(G.targetId===65535){G.targetId=-1}}if((K&f0.SAY)===f0.SAY){G.chat=_.gjstr;G.chatTimer=100}if((K&f0.DAMAGE)===f0.DAMAGE){G.damage=_.g1;G.damageType=_.g1;G.combatCycle=this.loopCycle+400;G.health=_.g1;G.totalHealth=_.g1}if((K&f0.CHANGE_TYPE)===f0.CHANGE_TYPE){G.type=_1.get(_.g2);G.seqWalkId=G.type.walkanim;G.seqTurnAroundId=G.type.walkanim_b;G.seqTurnLeftId=G.type.walkanim_r;G.seqTurnRightId=G.type.walkanim_l;G.seqStandId=G.type.readyanim}if((K&f0.SPOTANIM)===f0.SPOTANIM){G.spotanimId=_.g2;const Q=_.g4;G.spotanimOffset=Q>>16;G.spotanimLastCycle=this.loopCycle+(Q&65535);G.spotanimFrame=0;G.spotanimCycle=0;if(G.spotanimLastCycle>this.loopCycle){G.spotanimFrame=-1}if(G.spotanimId===65535){G.spotanimId=-1}}if((K&f0.FACE_COORD)===f0.FACE_COORD){G.targetTileX=_.g2;G.targetTileZ=_.g2;G.lastFaceX=G.targetTileX;G.lastFaceZ=G.targetTileZ}}};updatePlayers=()=>{for(let _=-1;_<this.playerCount;_++){let R;if(_===-1){R=this.LOCAL_PLAYER_INDEX}else{R=this.playerIds[_]}const L=this.players[R];if(L){this.updateEntity(L)}}d.cyclelogic6++;if(d.cyclelogic6>1406){d.cyclelogic6=0;this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC6);this.out.p1(0);const _=this.out.pos;this.out.p1(162);this.out.p1(22);if((Math.random()*2|0)===0){this.out.p1(84)}this.out.p2(31824);this.out.p2(13490);if((Math.random()*2|0)===0){this.out.p1(123)}if((Math.random()*2|0)===0){this.out.p1(134)}this.out.p1(100);this.out.p1(94);this.out.p2(35521);this.out.psize1(this.out.pos-_)}};updateEntity=(_)=>{if(_.x<128||_.z<128||_.x>=13184||_.z>=13184){_.primarySeqId=-1;_.spotanimId=-1;_.forceMoveEndCycle=0;_.forceMoveStartCycle=0;_.x=_.pathTileX[0]*128+_.size*64;_.z=_.pathTileZ[0]*128+_.size*64;_.pathLength=0}if(_===this.localPlayer&&(_.x<1536||_.z<1536||_.x>=11776||_.z>=11776)){_.primarySeqId=-1;_.spotanimId=-1;_.forceMoveEndCycle=0;_.forceMoveStartCycle=0;_.x=_.pathTileX[0]*128+_.size*64;_.z=_.pathTileZ[0]*128+_.size*64;_.pathLength=0}if(_.forceMoveEndCycle>this.loopCycle){this.updateForceMovement(_)}else if(_.forceMoveStartCycle>=this.loopCycle){this.startForceMovement(_)}else{this.updateMovement(_)}this.updateFacingDirection(_);this.updateSequences(_)};pushPlayers=()=>{if(!this.localPlayer){return}if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ){this.flagSceneTileX=0}for(let _=-1;_<this.playerCount;_++){let R;let L;if(_===-1){R=this.localPlayer;L=this.LOCAL_PLAYER_INDEX<<14}else{R=this.players[this.playerIds[_]];L=this.playerIds[_]<<14}if(!R||!R.isVisible()){continue}R.lowMemory=(d.lowMemory&&this.playerCount>50||this.playerCount>200)&&_!==-1&&R.secondarySeqId===R.seqStandId;const G=R.x>>7;const K=R.z>>7;if(G<0||G>=s.SIZE||K<0||K>=s.SIZE){continue}if(!R.locModel||this.loopCycle<R.locStartCycle||this.loopCycle>=R.locStopCycle){if((R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[G][K]===this.sceneCycle){continue}this.tileLastOccupiedCycle[G][K]=this.sceneCycle}R.y=this.getHeightmapY(this.currentLevel,R.x,R.z);this.scene?.addTemporary(this.currentLevel,R.x,R.y,R.z,null,R,L,R.yaw,60,R.seqStretches)}else{R.lowMemory=false;R.y=this.getHeightmapY(this.currentLevel,R.x,R.z);this.scene?.addTemporary2(this.currentLevel,R.x,R.y,R.z,R.minTileX,R.minTileZ,R.maxTileX,R.maxTileZ,null,R,L,R.yaw)}}};updateNpcs=()=>{for(let _=0;_<this.npcCount;_++){const R=this.npcIds[_];const L=this.npcs[R];if(L&&L.type){this.updateEntity(L)}}};pushNpcs=()=>{for(let _=0;_<this.npcCount;_++){const R=this.npcs[this.npcIds[_]];const L=(this.npcIds[_]<<14)+536870912|0;if(!R||!R.isVisible()){continue}const G=R.x>>7;const K=R.z>>7;if(G<0||G>=s.SIZE||K<0||K>=s.SIZE){continue}if(R.size===1&&(R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[G][K]===this.sceneCycle){continue}this.tileLastOccupiedCycle[G][K]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,R.x,this.getHeightmapY(this.currentLevel,R.x,R.z),R.z,null,R,L,R.yaw,(R.size-1)*64+60,R.seqStretches)}};pushProjectiles=()=>{for(let _=this.projectiles.head();_;_=this.projectiles.next()){if(_.level!==this.currentLevel||this.loopCycle>_.lastCycle){_.unlink()}else if(this.loopCycle>=_.startCycle){if(_.target>0){const R=this.npcs[_.target-1];if(R){_.updateVelocity(R.x,this.getHeightmapY(_.level,R.x,R.z)-_.offsetY,R.z,this.loopCycle)}}if(_.target<0){const R=-_.target-1;let L;if(R===this.localPid){L=this.localPlayer}else{L=this.players[R]}if(L){_.updateVelocity(L.x,this.getHeightmapY(_.level,L.x,L.z)-_.offsetY,L.z,this.loopCycle)}}_.update(this.sceneDelta);this.scene?.addTemporary(this.currentLevel,_.x|0,_.y|0,_.z|0,null,_,-1,_.yaw,60,false)}}};pushSpotanims=()=>{for(let _=this.spotanims.head();_;_=this.spotanims.next()){if(_.level!==this.currentLevel||_.seqComplete){_.unlink()}else if(this.loopCycle>=_.startCycle){_.update(this.sceneDelta);if(_.seqComplete){_.unlink()}else{this.scene?.addTemporary(_.level,_.x,_.y,_.z,null,_,-1,0,60,false)}}}};pushLocs=()=>{for(let _=this.locList.head();_;_=this.locList.next()){let R=false;_.seqCycle+=this.sceneDelta;if(_.seqFrame===-1){_.seqFrame=0;R=true}if(_.seq.delay){while(_.seqCycle>_.seq.delay[_.seqFrame]){_.seqCycle-=_.seq.delay[_.seqFrame]+1;_.seqFrame++;R=true;if(_.seqFrame>=_.seq.frameCount){_.seqFrame-=_.seq.replayoff;if(_.seqFrame<0||_.seqFrame>=_.seq.frameCount){_.unlink();R=false;break}}}}if(R&&this.scene){const L=_.heightmapSW;const G=_.heightmapNE;const K=_.heightmapNW;let Q=0;if(_.heightmapSE===0){Q=this.scene.getWallBitset(L,G,K)}else if(_.heightmapSE===1){Q=this.scene.getWallDecorationBitset(L,K,G)}else if(_.heightmapSE===2){Q=this.scene.getLocBitset(L,G,K)}else if(_.heightmapSE===3){Q=this.scene.getGroundDecorationBitset(L,G,K)}if(this.levelHeightmap&&Q!==0&&(Q>>14&32767)===_.index){const H=this.levelHeightmap[L][G][K];const $=this.levelHeightmap[L][G+1][K];const J=this.levelHeightmap[L][G+1][K+1];const O=this.levelHeightmap[L][G][K+1];const q=h0.get(_.index);let N=-1;if(_.seqFrame!==-1&&_.seq.frames){N=_.seq.frames[_.seqFrame]}if(_.heightmapSE===2){const U=this.scene.getInfo(L,G,K,Q);let b=U&31;const I=U>>6;if(b===y.CENTREPIECE_DIAGONAL.id){b=y.CENTREPIECE_STRAIGHT.id}this.scene?.setLocModel(L,G,K,q.getModel(b,I,H,$,J,O,N))}else if(_.heightmapSE===1){this.scene?.setWallDecorationModel(L,G,K,q.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,0,H,$,J,O,N))}else if(_.heightmapSE===0){const U=this.scene.getInfo(L,G,K,Q);const b=U&31;const I=U>>6;if(b===y.WALL_L.id){const j=I+1&3;this.scene?.setWallModels(G,K,L,q.getModel(y.WALL_L.id,I+4,H,$,J,O,N),q.getModel(y.WALL_L.id,j,H,$,J,O,N))}else{this.scene?.setWallModel(L,G,K,q.getModel(b,I,H,$,J,O,N))}}else if(_.heightmapSE===3){const U=this.scene.getInfo(L,G,K,Q);const b=U>>6;this.scene?.setGroundDecorationModel(L,G,K,q.getModel(y.GROUND_DECOR.id,b,H,$,J,O,N))}}else{_.unlink()}}}};updateEntityChats=()=>{for(let _=-1;_<this.playerCount;_++){let R;if(_===-1){R=this.LOCAL_PLAYER_INDEX}else{R=this.playerIds[_]}const L=this.players[R];if(L&&L.chatTimer>0){L.chatTimer--;if(L.chatTimer===0){L.chat=null}}}for(let _=0;_<this.npcCount;_++){const R=this.npcIds[_];const L=this.npcs[R];if(L&&L.chatTimer>0){L.chatTimer--;if(L.chatTimer===0){L.chat=null}}}};updateTemporaryLocs=()=>{if(this.sceneState===2){for(let _=this.temporaryLocs.head();_;_=this.temporaryLocs.next()){if(this.loopCycle>=_.lastCycle){this.addLoc(_.plane,_.x,_.z,_.locIndex,_.angle,_.shape,_.layer);_.unlink()}}d.cyclelogic5++;if(d.cyclelogic5>85){d.cyclelogic5=0;this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC5)}}};updateForceMovement=(_)=>{const R=_.forceMoveEndCycle-this.loopCycle;const L=_.forceMoveStartSceneTileX*128+_.size*64;const G=_.forceMoveStartSceneTileZ*128+_.size*64;_.x+=(L-_.x)/R|0;_.z+=(G-_.z)/R|0;_.seqTrigger=0;if(_.forceMoveFaceDirection===0){_.dstYaw=1024}if(_.forceMoveFaceDirection===1){_.dstYaw=1536}if(_.forceMoveFaceDirection===2){_.dstYaw=0}if(_.forceMoveFaceDirection===3){_.dstYaw=512}};startForceMovement=(_)=>{if(_.forceMoveStartCycle===this.loopCycle||_.primarySeqId===-1||_.primarySeqDelay!==0||_.primarySeqCycle+1>G0.instances[_.primarySeqId].delay[_.primarySeqFrame]){const R=_.forceMoveStartCycle-_.forceMoveEndCycle;const L=this.loopCycle-_.forceMoveEndCycle;const G=_.forceMoveStartSceneTileX*128+_.size*64;const K=_.forceMoveStartSceneTileZ*128+_.size*64;const Q=_.forceMoveEndSceneTileX*128+_.size*64;const H=_.forceMoveEndSceneTileZ*128+_.size*64;_.x=(G*(R-L)+Q*L)/R|0;_.z=(K*(R-L)+H*L)/R|0}_.seqTrigger=0;if(_.forceMoveFaceDirection===0){_.dstYaw=1024}if(_.forceMoveFaceDirection===1){_.dstYaw=1536}if(_.forceMoveFaceDirection===2){_.dstYaw=0}if(_.forceMoveFaceDirection===3){_.dstYaw=512}_.yaw=_.dstYaw};updateFacingDirection=(_)=>{if(_.targetId!==-1&&_.targetId<32768){const L=this.npcs[_.targetId];if(L){const G=_.x-L.x;const K=_.z-L.z;if(G!==0||K!==0){_.dstYaw=(Math.atan2(G,K)*325.949|0)&2047}}}if(_.targetId>=32768){let L=_.targetId-32768;if(L===this.localPid){L=this.LOCAL_PLAYER_INDEX}const G=this.players[L];if(G){const K=_.x-G.x;const Q=_.z-G.z;if(K!==0||Q!==0){_.dstYaw=(Math.atan2(K,Q)*325.949|0)&2047}}}if((_.targetTileX!==0||_.targetTileZ!==0)&&(_.pathLength===0||_.seqTrigger>0)){const L=_.x-(_.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64;const G=_.z-(_.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(L!==0||G!==0){_.dstYaw=(Math.atan2(L,G)*325.949|0)&2047}_.targetTileX=0;_.targetTileZ=0}const R=_.dstYaw-_.yaw&2047;if(R!==0){if(R<32||R>2016){_.yaw=_.dstYaw}else if(R>1024){_.yaw-=32}else{_.yaw+=32}_.yaw&=2047;if(_.secondarySeqId===_.seqStandId&&_.yaw!==_.dstYaw){if(_.seqTurnId!==-1){_.secondarySeqId=_.seqTurnId;return}_.secondarySeqId=_.seqWalkId}}};updateSequences=(_)=>{_.seqStretches=false;let R;if(_.secondarySeqId!==-1){R=G0.instances[_.secondarySeqId];_.secondarySeqCycle++;if(R.delay&&_.secondarySeqFrame<R.frameCount&&_.secondarySeqCycle>R.delay[_.secondarySeqFrame]){_.secondarySeqCycle=0;_.secondarySeqFrame++}if(_.secondarySeqFrame>=R.frameCount){_.secondarySeqCycle=0;_.secondarySeqFrame=0}}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){R=G0.instances[_.primarySeqId];_.primarySeqCycle++;while(R.delay&&_.primarySeqFrame<R.frameCount&&_.primarySeqCycle>R.delay[_.primarySeqFrame]){_.primarySeqCycle-=R.delay[_.primarySeqFrame];_.primarySeqFrame++}if(_.primarySeqFrame>=R.frameCount){_.primarySeqFrame-=R.replayoff;_.primarySeqLoop++;if(_.primarySeqLoop>=R.replaycount){_.primarySeqId=-1}if(_.primarySeqFrame<0||_.primarySeqFrame>=R.frameCount){_.primarySeqId=-1}}_.seqStretches=R.stretches}if(_.primarySeqDelay>0){_.primarySeqDelay--}if(_.spotanimId!==-1&&this.loopCycle>=_.spotanimLastCycle){if(_.spotanimFrame<0){_.spotanimFrame=0}R=p0.instances[_.spotanimId].seq;_.spotanimCycle++;while(R&&R.delay&&_.spotanimFrame<R.frameCount&&_.spotanimCycle>R.delay[_.spotanimFrame]){_.spotanimCycle-=R.delay[_.spotanimFrame];_.spotanimFrame++}if(R&&_.spotanimFrame>=R.frameCount){if(_.spotanimFrame<0||_.spotanimFrame>=R.frameCount){_.spotanimId=-1}}}};updateMovement=(_)=>{_.secondarySeqId=_.seqStandId;if(_.pathLength===0){_.seqTrigger=0;return}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){const Q=G0.instances[_.primarySeqId];if(!Q.walkmerge){_.seqTrigger++;return}}const R=_.x;const L=_.z;const G=_.pathTileX[_.pathLength-1]*128+_.size*64;const K=_.pathTileZ[_.pathLength-1]*128+_.size*64;if(G-R<=256&&G-R>=-256&&K-L<=256&&K-L>=-256){if(R<G){if(L<K){_.dstYaw=1280}else if(L>K){_.dstYaw=1792}else{_.dstYaw=1536}}else if(R>G){if(L<K){_.dstYaw=768}else if(L>K){_.dstYaw=256}else{_.dstYaw=512}}else if(L<K){_.dstYaw=1024}else{_.dstYaw=0}let Q=_.dstYaw-_.yaw&2047;if(Q>1024){Q-=2048}let H=_.seqTurnAroundId;if(Q>=-256&&Q<=256){H=_.seqWalkId}else if(Q>=256&&Q<768){H=_.seqTurnRightId}else if(Q>=-768&&Q<=-256){H=_.seqTurnLeftId}if(H===-1){H=_.seqWalkId}_.secondarySeqId=H;let $=4;if(_.yaw!==_.dstYaw&&_.targetId===-1){$=2}if(_.pathLength>2){$=6}if(_.pathLength>3){$=8}if(_.seqTrigger>0&&_.pathLength>1){$=8;_.seqTrigger--}if(_.pathRunning[_.pathLength-1]){$<<=1}if($>=8&&_.secondarySeqId===_.seqWalkId&&_.seqRunId!==-1){_.secondarySeqId=_.seqRunId}if(R<G){_.x+=$;if(_.x>G){_.x=G}}else if(R>G){_.x-=$;if(_.x<G){_.x=G}}if(L<K){_.z+=$;if(_.z>K){_.z=K}}else if(L>K){_.z-=$;if(_.z<K){_.z=K}}if(_.x===G&&_.z===K){_.pathLength--}}else{_.x=G;_.z=K}};getTopLevel=()=>{let _=3;if(this.cameraPitch<310&&this.localPlayer){let R=this.cameraX>>7;let L=this.cameraZ>>7;const G=this.localPlayer.x>>7;const K=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0){_=this.currentLevel}let Q;if(G>R){Q=G-R}else{Q=R-G}let H;if(K>L){H=K-L}else{H=L-K}let $;let J;if(Q>H){$=H*65536/Q|0;J=32768;while(R!==G){if(R<G){R++}else if(R>G){R--}if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0){_=this.currentLevel}J+=$;if(J>=65536){J-=65536;if(L<K){L++}else if(L>K){L--}if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0){_=this.currentLevel}}}}else{$=Q*65536/H|0;J=32768;while(L!==K){if(L<K){L++}else if(L>K){L--}if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0){_=this.currentLevel}J+=$;if(J>=65536){J-=65536;if(R<G){R++}else if(R>G){R--}if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0){_=this.currentLevel}}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0){_=this.currentLevel}return _};getTopLevelCutscene=()=>{if(!this.levelTileFlags){return 0}const _=this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ);return _-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel};getHeightmapY=(_,R,L)=>{if(!this.levelHeightmap){return 0}const G=Math.min(R>>7,s.SIZE-1);const K=Math.min(L>>7,s.SIZE-1);let Q=_;if(_<3&&this.levelTileFlags&&(this.levelTileFlags[1][G][K]&2)===2){Q=_+1}const H=R&127;const $=L&127;const J=this.levelHeightmap[Q][G][K]*(128-H)+this.levelHeightmap[Q][G+1][K]*H>>7;const O=this.levelHeightmap[Q][G][K+1]*(128-H)+this.levelHeightmap[Q][G+1][K+1]*H>>7;return J*(128-$)+O*$>>7};orbitCamera=(_,R,L,G,K,Q)=>{const H=2048-K&2047;const $=2048-G&2047;let J=0;let O=0;let q=Q;let N;let U;let b;if(H!==0){N=B.sin[H];U=B.cos[H];b=O*U-Q*N>>16;q=O*N+Q*U>>16;O=b}if($!==0){N=B.sin[$];U=B.cos[$];b=q*N+J*U>>16;q=q*U-J*N>>16;J=b}this.cameraX=_-J;this.cameraY=R-O;this.cameraZ=L-q;this.cameraPitch=K;this.cameraYaw=G};updateOrbitCamera=()=>{if(!this.localPlayer){return}const _=this.localPlayer.x+this.cameraAnticheatOffsetX;const R=this.localPlayer.z+this.cameraAnticheatOffsetZ;if(this.orbitCameraX-_<-500||this.orbitCameraX-_>500||this.orbitCameraZ-R<-500||this.orbitCameraZ-R>500){this.orbitCameraX=_;this.orbitCameraZ=R}if(this.orbitCameraX!==_){this.orbitCameraX+=(_-this.orbitCameraX)/16|0}if(this.orbitCameraZ!==R){this.orbitCameraZ+=(R-this.orbitCameraZ)/16|0}if(this.actionKey[1]===1){this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0}else if(this.actionKey[2]===1){this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0}else{this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0}if(this.actionKey[3]===1){this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0}else if(this.actionKey[4]===1){this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0}else{this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0}this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047;this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraPitch<128){this.orbitCameraPitch=128}if(this.orbitCameraPitch>383){this.orbitCameraPitch=383}const L=this.orbitCameraX>>7;const G=this.orbitCameraZ>>7;const K=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ);let Q=0;if(this.levelHeightmap){if(L>3&&G>3&&L<100&&G<100){for(let $=L-4;$<=L+4;$++){for(let J=G-4;J<=G+4;J++){let O=this.currentLevel;if(O<3&&this.levelTileFlags&&(this.levelTileFlags[1][$][J]&2)===2){O++}const q=K-this.levelHeightmap[O][$][J];if(q>Q){Q=q}}}}}let H=Q*192;if(H>98048){H=98048}if(H<32768){H=32768}if(H>this.cameraPitchClamp){this.cameraPitchClamp+=(H-this.cameraPitchClamp)/24|0}else if(H<this.cameraPitchClamp){this.cameraPitchClamp+=(H-this.cameraPitchClamp)/80|0}};applyCutscene=()=>{let _=this.cutsceneSrcLocalTileX*128+64;let R=this.cutsceneSrcLocalTileZ*128+64;let L=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<_){this.cameraX+=this.cutsceneMoveSpeed+((_-this.cameraX)*this.cutsceneMoveAcceleration/1000|0);if(this.cameraX>_){this.cameraX=_}}if(this.cameraX>_){this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-_)*this.cutsceneMoveAcceleration/1000|0);if(this.cameraX<_){this.cameraX=_}}if(this.cameraY<L){this.cameraY+=this.cutsceneMoveSpeed+((L-this.cameraY)*this.cutsceneMoveAcceleration/1000|0);if(this.cameraY>L){this.cameraY=L}}if(this.cameraY>L){this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-L)*this.cutsceneMoveAcceleration/1000|0);if(this.cameraY<L){this.cameraY=L}}if(this.cameraZ<R){this.cameraZ+=this.cutsceneMoveSpeed+((R-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0);if(this.cameraZ>R){this.cameraZ=R}}if(this.cameraZ>R){this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-R)*this.cutsceneMoveAcceleration/1000|0);if(this.cameraZ<R){this.cameraZ=R}}_=this.cutsceneDstLocalTileX*128+64;R=this.cutsceneDstLocalTileZ*128+64;L=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;const G=_-this.cameraX;const K=L-this.cameraY;const Q=R-this.cameraZ;const H=Math.sqrt(G*G+Q*Q)|0;let $=(Math.atan2(K,H)*325.949|0)&2047;const J=(Math.atan2(G,Q)*-325.949|0)&2047;if($<128){$=128}if($>383){$=383}if(this.cameraPitch<$){this.cameraPitch+=this.cutsceneRotateSpeed+(($-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0);if(this.cameraPitch>$){this.cameraPitch=$}}if(this.cameraPitch>$){this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-$)*this.cutsceneRotateAcceleration/1000|0);if(this.cameraPitch<$){this.cameraPitch=$}}let O=J-this.cameraYaw;if(O>1024){O-=2048}if(O<-1024){O+=2048}if(O>0){this.cameraYaw+=this.cutsceneRotateSpeed+(O*this.cutsceneRotateAcceleration/1000|0);this.cameraYaw&=2047}if(O<0){this.cameraYaw-=this.cutsceneRotateSpeed+(-O*this.cutsceneRotateAcceleration/1000|0);this.cameraYaw&=2047}let q=J-this.cameraYaw;if(q>1024){q-=2048}if(q<-1024){q+=2048}if(q<0&&O>0||q>0&&O<0){this.cameraYaw=J}};readZonePacket=(_,R)=>{const L=_.g1;let G=this.baseX+(L>>4&7);let K=this.baseZ+(L&7);if(R===t.LOC_ADD_CHANGE||R===t.LOC_DEL){const Q=_.g1;const H=Q>>2;const $=Q&3;const J=y.of(H).layer;let O;if(R===t.LOC_DEL){O=-1}else{O=_.g2}if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){let q=null;for(let N=this.spawnedLocations.head();N;N=this.spawnedLocations.next()){if(N.plane===this.currentLevel&&N.x===G&&N.z===K&&N.layer===J){q=N;break}}if(!q&&this.scene){let N=0;let U=-1;let b=0;let I=0;if(J===b0.WALL){N=this.scene.getWallBitset(this.currentLevel,G,K)}else if(J===b0.WALL_DECOR){N=this.scene.getWallDecorationBitset(this.currentLevel,K,G)}else if(J===b0.GROUND){N=this.scene.getLocBitset(this.currentLevel,G,K)}else if(J===b0.GROUND_DECOR){N=this.scene.getGroundDecorationBitset(this.currentLevel,G,K)}if(N!==0){const j=this.scene.getInfo(this.currentLevel,G,K,N);U=N>>14&32767;b=j&31;I=j>>6}q=new S8(this.currentLevel,J,G,K,0,x.WEST,y.WALL_STRAIGHT.id,U,I,b);this.spawnedLocations.addTail(q)}if(q){q.locIndex=O;q.shape=H;q.angle=$}this.addLoc(this.currentLevel,G,K,O,$,H,J)}}else if(R===t.LOC_ANIM){const Q=_.g1;const H=Q>>2;const $=y.of(H).layer;const J=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE&&this.scene){let O=0;if($===b0.WALL){O=this.scene.getWallBitset(this.currentLevel,G,K)}else if($===b0.WALL_DECOR){O=this.scene.getWallDecorationBitset(this.currentLevel,K,G)}else if($===b0.GROUND){O=this.scene.getLocBitset(this.currentLevel,G,K)}else if($===b0.GROUND_DECOR){O=this.scene.getGroundDecorationBitset(this.currentLevel,G,K)}if(O!==0){const q=new X0(O>>14&32767,this.currentLevel,$,G,K,G0.instances[J],false);this.locList.addTail(q)}}}else if(R===t.OBJ_ADD){const Q=_.g2;const H=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){const $=new L8(Q,H);if(!this.levelObjStacks[this.currentLevel][G][K]){this.levelObjStacks[this.currentLevel][G][K]=new g0}this.levelObjStacks[this.currentLevel][G][K]?.addTail($);this.sortObjStacks(G,K)}}else if(R===t.OBJ_DEL){const Q=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){const H=this.levelObjStacks[this.currentLevel][G][K];if(H){for(let $=H.head();$;$=H.next()){if($.index===(Q&32767)){$.unlink();break}}if(!H.head()){this.levelObjStacks[this.currentLevel][G][K]=null}this.sortObjStacks(G,K)}}}else if(R===t.MAP_PROJANIM){let Q=G+_.g1b;let H=K+_.g1b;const $=_.g2b;const J=_.g2;const O=_.g1;const q=_.g1;const N=_.g2;const U=_.g2;const b=_.g1;const I=_.g1;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE&&Q>=0&&H>=0&&Q<s.SIZE&&H<s.SIZE){G=G*128+64;K=K*128+64;Q=Q*128+64;H=H*128+64;const j=new P8(J,this.currentLevel,G,this.getHeightmapY(this.currentLevel,G,K)-O,K,N+this.loopCycle,U+this.loopCycle,b,I,$,q);j.updateVelocity(Q,this.getHeightmapY(this.currentLevel,Q,H)-q,H,N+this.loopCycle);this.projectiles.addTail(j)}}else if(R===t.MAP_ANIM){const Q=_.g2;const H=_.g1;const $=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){G=G*128+64;K=K*128+64;const J=new z8(Q,this.currentLevel,G,K,this.getHeightmapY(this.currentLevel,G,K)-H,this.loopCycle,$);this.spotanims.addTail(J)}}else if(R===t.OBJ_REVEAL){const Q=_.g2;const H=_.g2;const $=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE&&$!==this.localPid){const J=new L8(Q,H);if(!this.levelObjStacks[this.currentLevel][G][K]){this.levelObjStacks[this.currentLevel][G][K]=new g0}this.levelObjStacks[this.currentLevel][G][K]?.addTail(J);this.sortObjStacks(G,K)}}else if(R===t.LOC_MERGE){const Q=_.g1;const H=Q>>2;const $=Q&3;const J=y.of(H).layer;const O=_.g2;const q=_.g2;const N=_.g2;const U=_.g2;let b=_.g1b;let I=_.g1b;let j=_.g1b;let F=_.g1b;let T;if(U===this.localPid){T=this.localPlayer}else{T=this.players[U]}if(T&&this.levelHeightmap){const Y=new R8(this.currentLevel,J,G,K,-1,$,H,q+this.loopCycle);this.temporaryLocs.addTail(Y);const u=new R8(this.currentLevel,J,G,K,O,$,H,N+this.loopCycle);this.temporaryLocs.addTail(u);const w=this.levelHeightmap[this.currentLevel][G][K];const h=this.levelHeightmap[this.currentLevel][G+1][K];const v=this.levelHeightmap[this.currentLevel][G+1][K+1];const n=this.levelHeightmap[this.currentLevel][G][K+1];const A=h0.get(O);T.locStartCycle=q+this.loopCycle;T.locStopCycle=N+this.loopCycle;T.locModel=A.getModel(H,$,w,h,v,n,-1);let P=A.width;let z=A.length;if($===x.NORTH||$===x.SOUTH){P=A.length;z=A.width}T.locOffsetX=G*128+P*64;T.locOffsetZ=K*128+z*64;T.locOffsetY=this.getHeightmapY(this.currentLevel,T.locOffsetX,T.locOffsetZ);let f;if(b>j){f=b;b=j;j=f}if(I>F){f=I;I=F;F=f}T.minTileX=G+b;T.maxTileX=G+j;T.minTileZ=K+I;T.maxTileZ=K+F}}else if(R===t.OBJ_COUNT){const Q=_.g2;const H=_.g2;const $=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){const J=this.levelObjStacks[this.currentLevel][G][K];if(J){for(let O=J.head();O;O=J.next()){if(O.index===(Q&32767)&&O.count===H){O.count=$;break}}this.sortObjStacks(G,K)}}}};updateTextures=(_)=>{if(!d.lowMemory){if(B.textureCycle[17]>=_){const R=B.textures[17];if(!R){return}const L=R.width*R.height-1;const G=R.width*this.sceneDelta*2;const K=R.pixels;const Q=this.textureBuffer;for(let H=0;H<=L;H++){Q[H]=K[H-G&L]}R.pixels=Q;this.textureBuffer=K;B.pushTexture(17)}if(B.textureCycle[24]>=_){const R=B.textures[24];if(!R){return}const L=R.width*R.height-1;const G=R.width*this.sceneDelta*2;const K=R.pixels;const Q=this.textureBuffer;for(let H=0;H<=L;H++){Q[H]=K[H-G&L]}R.pixels=Q;this.textureBuffer=K;B.pushTexture(24)}}};updateFlames=()=>{if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset){return}const _=256;for(let R=10;R<117;R++){const L=Math.random()*100|0;if(L<50)this.flameBuffer3[R+(_-2<<7)]=255}for(let R=0;R<100;R++){const L=(Math.random()*124|0)+2;const G=(Math.random()*128|0)+128;const K=L+(G<<7);this.flameBuffer3[K]=192}for(let R=1;R<_-1;R++){for(let L=1;L<127;L++){const G=L+(R<<7);this.flameBuffer2[G]=(this.flameBuffer3[G-1]+this.flameBuffer3[G+1]+this.flameBuffer3[G-128]+this.flameBuffer3[G+128])/4|0}}this.flameCycle0+=128;if(this.flameCycle0>this.flameBuffer0.length){this.flameCycle0-=this.flameBuffer0.length;this.updateFlameBuffer(this.imageRunes[Math.random()*12|0])}for(let R=1;R<_-1;R++){for(let L=1;L<127;L++){const G=L+(R<<7);let K=this.flameBuffer2[G+128]-(this.flameBuffer0[G+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(K<0){K=0}this.flameBuffer3[G]=K}}for(let R=0;R<_-1;R++){this.flameLineOffset[R]=this.flameLineOffset[R+1]}this.flameLineOffset[_-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0;if(this.flameGradientCycle0>0){this.flameGradientCycle0-=4}if(this.flameGradientCycle1>0){this.flameGradientCycle1-=4}if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){const R=Math.random()*2000|0;if(R===0){this.flameGradientCycle0=1024}else if(R===1){this.flameGradientCycle1=1024}}};mix=(_,R,L)=>{const G=256-R;return((_&16711935)*G+(L&16711935)*R&4278255360)+((_&65280)*G+(L&65280)*R&16711680)>>8};drawFlames=()=>{if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3){return}const _=256;if(this.flameGradientCycle0>0){for(let G=0;G<256;G++){if(this.flameGradientCycle0>768){this.flameGradient[G]=this.mix(this.flameGradient0[G],1024-this.flameGradientCycle0,this.flameGradient1[G])}else if(this.flameGradientCycle0>256){this.flameGradient[G]=this.flameGradient1[G]}else{this.flameGradient[G]=this.mix(this.flameGradient1[G],256-this.flameGradientCycle0,this.flameGradient0[G])}}}else if(this.flameGradientCycle1>0){for(let G=0;G<256;G++){if(this.flameGradientCycle1>768){this.flameGradient[G]=this.mix(this.flameGradient0[G],1024-this.flameGradientCycle1,this.flameGradient2[G])}else if(this.flameGradientCycle1>256){this.flameGradient[G]=this.flameGradient2[G]}else{this.flameGradient[G]=this.mix(this.flameGradient2[G],256-this.flameGradientCycle1,this.flameGradient0[G])}}}else{for(let G=0;G<256;G++){this.flameGradient[G]=this.flameGradient0[G]}}for(let G=0;G<33920;G++){if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[G]=this.imageFlamesLeft.pixels[G]}let R=0;let L=1152;for(let G=1;G<_-1;G++){const K=this.flameLineOffset[G]*(_-G)/_|0;let Q=K+22;if(Q<0){Q=0}R+=Q;for(let H=Q;H<128;H++){let $=this.flameBuffer3[R++];if($===0){L++}else{const J=$;const O=256-$;$=this.flameGradient[$];if(this.imageTitle0){const q=this.imageTitle0.pixels[L];this.imageTitle0.pixels[L++]=(($&16711935)*J+(q&16711935)*O&4278255360)+(($&65280)*J+(q&65280)*O&16711680)>>8}}}L+=Q}this.imageTitle0?.draw(0,0);for(let G=0;G<33920;G++){if(this.imageTitle1&&this.imageFlamesRight){this.imageTitle1.pixels[G]=this.imageFlamesRight.pixels[G]}}R=0;L=1176;for(let G=1;G<_-1;G++){const K=this.flameLineOffset[G]*(_-G)/_|0;const Q=103-K;L+=K;for(let H=0;H<Q;H++){let $=this.flameBuffer3[R++];if($===0){L++}else{const J=$;const O=256-$;$=this.flameGradient[$];if(this.imageTitle1){const q=this.imageTitle1.pixels[L];this.imageTitle1.pixels[L++]=(($&16711935)*J+(q&16711935)*O&4278255360)+(($&65280)*J+(q&65280)*O&16711680)>>8}}}R+=128-Q;L+=128-Q-K}this.imageTitle1?.draw(661,0)}}export{d as Client};

//# debugId=A6B6A30C71121D9264756E2164756E21
