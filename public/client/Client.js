var{defineProperty:V5,getOwnPropertyNames:f6,getOwnPropertyDescriptor:C6}=Object,n6=Object.prototype.hasOwnProperty;var d5=new WeakMap,I8=(_)=>{var R=d5.get(_),L;if(R)return R;if(R=V5({},"__esModule",{value:!0}),_&&typeof _==="object"||typeof _==="function")f6(_).map((G)=>!n6.call(R,G)&&V5(R,G,{get:()=>_[G],enumerable:!(L=C6(_,G))||L.enumerable}));return d5.set(_,R),R};var t5=(_,R)=>{for(var L in R)V5(_,L,{get:R[L],enumerable:!0,configurable:!0,set:(G)=>R[L]=()=>G})};var o5=(_,R)=>()=>(_&&(R=_(_=0)),R);var E8=((_)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(_,{get:(R,L)=>(typeof require!=="undefined"?require:R)[L]}):_)(function(_){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+_+'" is not supported')});var Z5={};t5(Z5,{win32:()=>Y5,toNamespacedPath:()=>G_,sep:()=>O_,resolve:()=>l6,relative:()=>L_,posix:()=>E1,parse:()=>J_,normalize:()=>e6,join:()=>R_,isAbsolute:()=>__,format:()=>$_,extname:()=>H_,dirname:()=>K_,delimiter:()=>q_,default:()=>o6,basename:()=>Q_});var s6,e5,p6,y6,r6,x6,i6=(_,R)=>()=>(R||_((R={exports:{}}).exports,R),R.exports),a6=(_,R,L,G)=>{if(R&&typeof R=="object"||typeof R=="function")for(let K of y6(R))!x6.call(_,K)&&K!==L&&e5(_,K,{get:()=>R[K],enumerable:!(G=p6(R,K))||G.enumerable});return _},c6=(_,R,L)=>(L=_!=null?s6(r6(_)):{},a6(R||!_||!_.__esModule?e5(L,"default",{value:_,enumerable:!0}):L,_)),d6,_6,v0,t6,l5=function(_){return _},R6=function(){throw new Error("Not implemented")},E1,Y5,o6,l6,e6,__,R_,L_,G_,K_,Q_,H_,$_,J_,O_,q_;var u5=o5(()=>{s6=Object.create,e5=Object.defineProperty,p6=Object.getOwnPropertyDescriptor,y6=Object.getOwnPropertyNames,r6=Object.getPrototypeOf,x6=Object.prototype.hasOwnProperty,d6=i6((_,R)=>{function L(H){if(typeof H!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(H))}function G(H,$){for(var J="",O=0,q=-1,b=0,U,N=0;N<=H.length;++N){if(N<H.length)U=H.charCodeAt(N);else{if(U===47)break;U=47}if(U===47){if(!(q===N-1||b===1))if(q!==N-1&&b===2){if(J.length<2||O!==2||J.charCodeAt(J.length-1)!==46||J.charCodeAt(J.length-2)!==46){if(J.length>2){var I=J.lastIndexOf("/");if(I!==J.length-1){I===-1?(J="",O=0):(J=J.slice(0,I),O=J.length-1-J.lastIndexOf("/")),q=N,b=0;continue}}else if(J.length===2||J.length===1){J="",O=0,q=N,b=0;continue}}$&&(J.length>0?J+="/..":J="..",O=2)}else J.length>0?J+="/"+H.slice(q+1,N):J=H.slice(q+1,N),O=N-q-1;q=N,b=0}else U===46&&b!==-1?++b:b=-1}return J}function K(H,$){var J=$.dir||$.root,O=$.base||($.name||"")+($.ext||"");return J?J===$.root?J+O:J+H+O:O}var Q={resolve:function(){for(var H="",$=!1,J,O=arguments.length-1;O>=-1&&!$;O--){var q;O>=0?q=arguments[O]:(J===void 0&&(J=process.cwd()),q=J),L(q),q.length!==0&&(H=q+"/"+H,$=q.charCodeAt(0)===47)}return H=G(H,!$),$?H.length>0?"/"+H:"/":H.length>0?H:"."},normalize:function(H){if(L(H),H.length===0)return".";var $=H.charCodeAt(0)===47,J=H.charCodeAt(H.length-1)===47;return H=G(H,!$),H.length===0&&!$&&(H="."),H.length>0&&J&&(H+="/"),$?"/"+H:H},isAbsolute:function(H){return L(H),H.length>0&&H.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var H,$=0;$<arguments.length;++$){var J=arguments[$];L(J),J.length>0&&(H===void 0?H=J:H+="/"+J)}return H===void 0?".":Q.normalize(H)},relative:function(H,$){if(L(H),L($),H===$||(H=Q.resolve(H),$=Q.resolve($),H===$))return"";for(var J=1;J<H.length&&H.charCodeAt(J)===47;++J);for(var O=H.length,q=O-J,b=1;b<$.length&&$.charCodeAt(b)===47;++b);for(var U=$.length,N=U-b,I=q<N?q:N,k=-1,F=0;F<=I;++F){if(F===I){if(N>I){if($.charCodeAt(b+F)===47)return $.slice(b+F+1);if(F===0)return $.slice(b+F)}else q>I&&(H.charCodeAt(J+F)===47?k=F:F===0&&(k=0));break}var T=H.charCodeAt(J+F),Y=$.charCodeAt(b+F);if(T!==Y)break;T===47&&(k=F)}var u="";for(F=J+k+1;F<=O;++F)(F===O||H.charCodeAt(F)===47)&&(u.length===0?u+="..":u+="/..");return u.length>0?u+$.slice(b+k):(b+=k,$.charCodeAt(b)===47&&++b,$.slice(b))},_makeLong:function(H){return H},dirname:function(H){if(L(H),H.length===0)return".";for(var $=H.charCodeAt(0),J=$===47,O=-1,q=!0,b=H.length-1;b>=1;--b)if($=H.charCodeAt(b),$===47){if(!q){O=b;break}}else q=!1;return O===-1?J?"/":".":J&&O===1?"//":H.slice(0,O)},basename:function(H,$){if($!==void 0&&typeof $!="string")throw new TypeError('"ext" argument must be a string');L(H);var J=0,O=-1,q=!0,b;if($!==void 0&&$.length>0&&$.length<=H.length){if($.length===H.length&&$===H)return"";var U=$.length-1,N=-1;for(b=H.length-1;b>=0;--b){var I=H.charCodeAt(b);if(I===47){if(!q){J=b+1;break}}else N===-1&&(q=!1,N=b+1),U>=0&&(I===$.charCodeAt(U)?--U===-1&&(O=b):(U=-1,O=N))}return J===O?O=N:O===-1&&(O=H.length),H.slice(J,O)}else{for(b=H.length-1;b>=0;--b)if(H.charCodeAt(b)===47){if(!q){J=b+1;break}}else O===-1&&(q=!1,O=b+1);return O===-1?"":H.slice(J,O)}},extname:function(H){L(H);for(var $=-1,J=0,O=-1,q=!0,b=0,U=H.length-1;U>=0;--U){var N=H.charCodeAt(U);if(N===47){if(!q){J=U+1;break}continue}O===-1&&(q=!1,O=U+1),N===46?$===-1?$=U:b!==1&&(b=1):$!==-1&&(b=-1)}return $===-1||O===-1||b===0||b===1&&$===O-1&&$===J+1?"":H.slice($,O)},format:function(H){if(H===null||typeof H!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof H);return K("/",H)},parse:function(H){L(H);var $={root:"",dir:"",base:"",ext:"",name:""};if(H.length===0)return $;var J=H.charCodeAt(0),O=J===47,q;O?($.root="/",q=1):q=0;for(var b=-1,U=0,N=-1,I=!0,k=H.length-1,F=0;k>=q;--k){if(J=H.charCodeAt(k),J===47){if(!I){U=k+1;break}continue}N===-1&&(I=!1,N=k+1),J===46?b===-1?b=k:F!==1&&(F=1):b!==-1&&(F=-1)}return b===-1||N===-1||F===0||F===1&&b===N-1&&b===U+1?N!==-1&&(U===0&&O?$.base=$.name=H.slice(1,N):$.base=$.name=H.slice(U,N)):(U===0&&O?($.name=H.slice(1,b),$.base=H.slice(1,N)):($.name=H.slice(U,b),$.base=H.slice(U,N)),$.ext=H.slice(b,N)),U>0?$.dir=H.slice(0,U-1):O&&($.dir="/"),$},sep:"/",delimiter:":",win32:null,posix:null};Q.posix=Q,R.exports=Q}),_6=c6(d6()),v0=_6,t6=_6;v0.parse??=R6;t6.parse??=R6;E1={resolve:v0.resolve.bind(v0),normalize:v0.normalize.bind(v0),isAbsolute:v0.isAbsolute.bind(v0),join:v0.join.bind(v0),relative:v0.relative.bind(v0),toNamespacedPath:l5,dirname:v0.dirname.bind(v0),basename:v0.basename.bind(v0),extname:v0.extname.bind(v0),format:v0.format.bind(v0),parse:v0.parse.bind(v0),sep:"/",delimiter:":",win32:void 0,posix:void 0,_makeLong:l5},Y5={sep:"\\",delimiter:";",win32:void 0,...E1,posix:E1};E1.win32=Y5.win32=Y5;E1.posix=E1;o6=E1,{resolve:l6,normalize:e6,isAbsolute:__,join:R_,relative:L_,toNamespacedPath:G_,dirname:K_,basename:Q_,extname:H_,format:$_,parse:J_,sep:O_,delimiter:q_}=E1});var B5={};t5(B5,{resolveObject:()=>O6,resolve:()=>J6,parse:()=>z1,format:()=>$6,default:()=>V_,Url:()=>e0,URLSearchParams:()=>Q6,URL:()=>W5});function h5(_){return typeof _=="string"}function H6(_){return typeof _=="object"&&_!==null}function F8(_){return _===null}function b_(_){return _==null}function e0(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function z1(_,R,L){if(_&&H6(_)&&_ instanceof e0)return _;var G=new e0;return G.parse(_,R,L),G}function $6(_){return h5(_)&&(_=z1(_)),_ instanceof e0?_.format():e0.prototype.format.call(_)}function J6(_,R){return z1(_,!1,!0).resolve(R)}function O6(_,R){return _?z1(_,!1,!0).resolveObject(R):R}var W5,Q6,N_,U_,I_,E_,F_,w5,L6,G6,T_=255,K6,k_,j_,X5,P1,A5,V_;var m5=o5(()=>{({URL:W5,URLSearchParams:Q6}=globalThis);N_=/^([a-z0-9.+-]+:)/i,U_=/:[0-9]*$/,I_=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,E_=["<",">",'"',"`"," ","\r",`
`,"\t"],F_=["{","}","|","\\","^","`"].concat(E_),w5=["'"].concat(F_),L6=["%","/","?",";","#"].concat(w5),G6=["/","?","#"],K6=/^[+a-z0-9A-Z_-]{0,63}$/,k_=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,j_={javascript:!0,"javascript:":!0},X5={javascript:!0,"javascript:":!0},P1={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},A5={parse(_){var R=decodeURIComponent;return(_+"").replace(/\+/g," ").split("&").filter(Boolean).reduce(function(L,G,K){var Q=G.split("="),H=R(Q[0]||""),$=R(Q[1]||""),J=L[H];return L[H]=J===void 0?$:[].concat(J,$),L},{})},stringify(_){var R=encodeURIComponent;return Object.keys(_||{}).reduce(function(L,G){return[].concat(_[G]).forEach(function(K){L.push(R(G)+"="+R(K))}),L},[]).join("&").replace(/\s/g,"+")}};e0.prototype.parse=function(_,R,L){if(!h5(_))throw new TypeError("Parameter 'url' must be a string, not "+typeof _);var G=_.indexOf("?"),K=G!==-1&&G<_.indexOf("#")?"?":"#",Q=_.split(K),H=/\\/g;Q[0]=Q[0].replace(H,"/"),_=Q.join(K);var $=_;if($=$.trim(),!L&&_.split("#").length===1){var J=I_.exec($);if(J)return this.path=$,this.href=$,this.pathname=J[1],J[2]?(this.search=J[2],R?this.query=A5.parse(this.search.substr(1)):this.query=this.search.substr(1)):R&&(this.search="",this.query={}),this}var O=N_.exec($);if(O){O=O[0];var q=O.toLowerCase();this.protocol=q,$=$.substr(O.length)}if(L||O||$.match(/^\/\/[^@\/]+@[^@\/]+/)){var b=$.substr(0,2)==="//";b&&!(O&&X5[O])&&($=$.substr(2),this.slashes=!0)}if(!X5[O]&&(b||O&&!P1[O])){for(var U=-1,N=0;N<G6.length;N++){var I=$.indexOf(G6[N]);I!==-1&&(U===-1||I<U)&&(U=I)}var k,F;U===-1?F=$.lastIndexOf("@"):F=$.lastIndexOf("@",U),F!==-1&&(k=$.slice(0,F),$=$.slice(F+1),this.auth=decodeURIComponent(k)),U=-1;for(var N=0;N<L6.length;N++){var I=$.indexOf(L6[N]);I!==-1&&(U===-1||I<U)&&(U=I)}U===-1&&(U=$.length),this.host=$.slice(0,U),$=$.slice(U),this.parseHost(),this.hostname=this.hostname||"";var T=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!T)for(var Y=this.hostname.split(/\./),N=0,u=Y.length;N<u;N++){var w=Y[N];if(!!w&&!w.match(K6)){for(var B="",v=0,n=w.length;v<n;v++)w.charCodeAt(v)>127?B+="x":B+=w[v];if(!B.match(K6)){var W=Y.slice(0,N),P=Y.slice(N+1),z=w.match(k_);z&&(W.push(z[1]),P.unshift(z[2])),P.length&&($="/"+P.join(".")+$),this.hostname=W.join(".");break}}}this.hostname.length>T_?this.hostname="":this.hostname=this.hostname.toLowerCase(),T||(this.hostname=new W5(`https://${this.hostname}`).hostname);var f=this.port?":"+this.port:"",m=this.hostname||"";this.host=m+f,this.href+=this.host,T&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),$[0]!=="/"&&($="/"+$))}if(!j_[q])for(var N=0,u=w5.length;N<u;N++){var M=w5[N];if($.indexOf(M)!==-1){var r=encodeURIComponent(M);r===M&&(r=escape(M)),$=$.split(M).join(r)}}var a=$.indexOf("#");a!==-1&&(this.hash=$.substr(a),$=$.slice(0,a));var C=$.indexOf("?");if(C!==-1?(this.search=$.substr(C),this.query=$.substr(C+1),R&&(this.query=A5.parse(this.query)),$=$.slice(0,C)):R&&(this.search="",this.query={}),$&&(this.pathname=$),P1[q]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var f=this.pathname||"",L0=this.search||"";this.path=f+L0}return this.href=this.format(),this};e0.prototype.format=function(){var _=this.auth||"";_&&(_=encodeURIComponent(_),_=_.replace(/%3A/i,":"),_+="@");var R=this.protocol||"",L=this.pathname||"",G=this.hash||"",K=!1,Q="";this.host?K=_+this.host:this.hostname&&(K=_+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(K+=":"+this.port)),this.query&&H6(this.query)&&Object.keys(this.query).length&&(Q=A5.stringify(this.query));var H=this.search||Q&&"?"+Q||"";return R&&R.substr(-1)!==":"&&(R+=":"),this.slashes||(!R||P1[R])&&K!==!1?(K="//"+(K||""),L&&L.charAt(0)!=="/"&&(L="/"+L)):K||(K=""),G&&G.charAt(0)!=="#"&&(G="#"+G),H&&H.charAt(0)!=="?"&&(H="?"+H),L=L.replace(/[?#]/g,function($){return encodeURIComponent($)}),H=H.replace("#","%23"),R+K+L+H+G};e0.prototype.resolve=function(_){return this.resolveObject(z1(_,!1,!0)).format()};e0.prototype.resolveObject=function(_){if(h5(_)){var R=new e0;R.parse(_,!1,!0),_=R}for(var L=new e0,G=Object.keys(this),K=0;K<G.length;K++){var Q=G[K];L[Q]=this[Q]}if(L.hash=_.hash,_.href==="")return L.href=L.format(),L;if(_.slashes&&!_.protocol){for(var H=Object.keys(_),$=0;$<H.length;$++){var J=H[$];J!=="protocol"&&(L[J]=_[J])}return P1[L.protocol]&&L.hostname&&!L.pathname&&(L.path=L.pathname="/"),L.href=L.format(),L}if(_.protocol&&_.protocol!==L.protocol){if(!P1[_.protocol]){for(var O=Object.keys(_),q=0;q<O.length;q++){var b=O[q];L[b]=_[b]}return L.href=L.format(),L}if(L.protocol=_.protocol,!_.host&&!X5[_.protocol]){for(var u=(_.pathname||"").split("/");u.length&&!(_.host=u.shift()););_.host||(_.host=""),_.hostname||(_.hostname=""),u[0]!==""&&u.unshift(""),u.length<2&&u.unshift(""),L.pathname=u.join("/")}else L.pathname=_.pathname;if(L.search=_.search,L.query=_.query,L.host=_.host||"",L.auth=_.auth,L.hostname=_.hostname||_.host,L.port=_.port,L.pathname||L.search){var U=L.pathname||"",N=L.search||"";L.path=U+N}return L.slashes=L.slashes||_.slashes,L.href=L.format(),L}var I=L.pathname&&L.pathname.charAt(0)==="/",k=_.host||_.pathname&&_.pathname.charAt(0)==="/",F=k||I||L.host&&_.pathname,T=F,Y=L.pathname&&L.pathname.split("/")||[],u=_.pathname&&_.pathname.split("/")||[],w=L.protocol&&!P1[L.protocol];if(w&&(L.hostname="",L.port=null,L.host&&(Y[0]===""?Y[0]=L.host:Y.unshift(L.host)),L.host="",_.protocol&&(_.hostname=null,_.port=null,_.host&&(u[0]===""?u[0]=_.host:u.unshift(_.host)),_.host=null),F=F&&(u[0]===""||Y[0]==="")),k)L.host=_.host||_.host===""?_.host:L.host,L.hostname=_.hostname||_.hostname===""?_.hostname:L.hostname,L.search=_.search,L.query=_.query,Y=u;else if(u.length)Y||(Y=[]),Y.pop(),Y=Y.concat(u),L.search=_.search,L.query=_.query;else if(!b_(_.search)){if(w){L.hostname=L.host=Y.shift();var B=L.host&&L.host.indexOf("@")>0?L.host.split("@"):!1;B&&(L.auth=B.shift(),L.host=L.hostname=B.shift())}return L.search=_.search,L.query=_.query,(!F8(L.pathname)||!F8(L.search))&&(L.path=(L.pathname?L.pathname:"")+(L.search?L.search:"")),L.href=L.format(),L}if(!Y.length)return L.pathname=null,L.search?L.path="/"+L.search:L.path=null,L.href=L.format(),L;for(var v=Y.slice(-1)[0],n=(L.host||_.host||Y.length>1)&&(v==="."||v==="..")||v==="",W=0,P=Y.length;P>=0;P--)v=Y[P],v==="."?Y.splice(P,1):v===".."?(Y.splice(P,1),W++):W&&(Y.splice(P,1),W--);if(!F&&!T)for(;W--;W)Y.unshift("..");F&&Y[0]!==""&&(!Y[0]||Y[0].charAt(0)!=="/")&&Y.unshift(""),n&&Y.join("/").substr(-1)!=="/"&&Y.push("");var z=Y[0]===""||Y[0]&&Y[0].charAt(0)==="/";if(w){L.hostname=L.host=z?"":Y.length?Y.shift():"";var B=L.host&&L.host.indexOf("@")>0?L.host.split("@"):!1;B&&(L.auth=B.shift(),L.host=L.hostname=B.shift())}return F=F||L.host&&Y.length,F&&!z&&Y.unshift(""),Y.length?L.pathname=Y.join("/"):(L.pathname=null,L.path=null),(!F8(L.pathname)||!F8(L.search))&&(L.path=(L.pathname?L.pathname:"")+(L.search?L.search:"")),L.auth=_.auth||L.auth,L.slashes=L.slashes||_.slashes,L.href=L.format(),L};e0.prototype.parseHost=function(){var _=this.host,R=U_.exec(_);R&&(R=R[0],R!==":"&&(this.port=R.substr(1)),_=_.substr(0,_.length-R.length)),_&&(this.hostname=_)};V_={parse:z1,resolve:J6,resolveObject:O6,format:$6,Url:e0,URL:W5,URLSearchParams:Q6}});var S5=(()=>{var _=import.meta.url;return async function(R={}){var L,G=R,K,Q,H=new Promise((Z,D)=>{K=Z,Q=D}),$=typeof window=="object",J=typeof WorkerGlobalScope!="undefined",O=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer",q=!$&&!O&&!J,b=Object.assign({},G),U=[],N="./this.program",I=(Z,D)=>{throw D},k="";function F(Z){if(G.locateFile)return G.locateFile(Z,k);return k+Z}var T,Y;if(O){if(typeof process=="undefined"||!process.release||process.release.name!=="node")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");var u=process.versions.node,w=u.split(".").slice(0,3);w=w[0]*1e4+w[1]*100+w[2].split("-")[0]*1;var B=160000;if(w<160000)throw new Error("This emscripten-generated code requires node v16.0.0 (detected v"+u+")");var v=(()=>({})),n=(u5(),I8(Z5));if(!import.meta.url.startsWith("data:"))k=n.dirname((m5(),I8(B5)).fileURLToPath(import.meta.url))+"/";if(Y=(Z)=>{Z=Q1(Z)?new URL(Z):Z;var D=v.readFileSync(Z);return i(Buffer.isBuffer(D)),D},T=async(Z,D=!0)=>{Z=Q1(Z)?new URL(Z):Z;var o=v.readFileSync(Z,D?void 0:"utf8");return i(D?Buffer.isBuffer(o):typeof o=="string"),o},!G.thisProgram&&process.argv.length>1)N=process.argv[1].replace(/\\/g,"/");U=process.argv.slice(2),I=(Z,D)=>{throw process.exitCode=Z,D}}else if(q){if(typeof process=="object"&&!0||typeof window=="object"||typeof WorkerGlobalScope!="undefined")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)")}else if($||J){if(J)k=self.location.href;else if(typeof document!="undefined"&&document.currentScript)k=document.currentScript.src;if(_)k=_;if(k.startsWith("blob:"))k="";else k=k.substr(0,k.replace(/[?#].*/,"").lastIndexOf("/")+1);if(!(typeof window=="object"||typeof WorkerGlobalScope!="undefined"))throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");{if(J)Y=(Z)=>{var D=new XMLHttpRequest;return D.open("GET",Z,!1),D.responseType="arraybuffer",D.send(null),new Uint8Array(D.response)};T=async(Z)=>{if(Q1(Z))return new Promise((o,K0)=>{var O0=new XMLHttpRequest;O0.open("GET",Z,!0),O0.responseType="arraybuffer",O0.onload=()=>{if(O0.status==200||O0.status==0&&O0.response){o(O0.response);return}K0(O0.status)},O0.onerror=K0,O0.send(null)});var D=await fetch(Z,{credentials:"same-origin"});if(D.ok)return D.arrayBuffer();throw new Error(D.status+" : "+D.url)}}}else throw new Error("environment detection error");var W=G.print||void 0,P=G.printErr||void 0;if(Object.assign(G,b),b=null,E5(),G.arguments)U=G.arguments;if(a0("arguments","arguments_"),G.thisProgram)N=G.thisProgram;a0("thisProgram","thisProgram"),i(typeof G.memoryInitializerPrefixURL=="undefined","Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead"),i(typeof G.pthreadMainPrefixURL=="undefined","Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead"),i(typeof G.cdInitializerPrefixURL=="undefined","Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead"),i(typeof G.filePackagePrefixURL=="undefined","Module.filePackagePrefixURL option was removed, use Module.locateFile instead"),i(typeof G.read=="undefined","Module.read option was removed"),i(typeof G.readAsync=="undefined","Module.readAsync option was removed (modify readAsync in JS)"),i(typeof G.readBinary=="undefined","Module.readBinary option was removed (modify readBinary in JS)"),i(typeof G.setWindowTitle=="undefined","Module.setWindowTitle option was removed (modify emscripten_set_window_title in JS)"),i(typeof G.TOTAL_MEMORY=="undefined","Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY"),a0("asm","wasmExports"),a0("readAsync","readAsync"),a0("readBinary","readBinary"),a0("setWindowTitle","setWindowTitle");var z="IDBFS is no longer included by default; build with -lidbfs.js",f="PROXYFS is no longer included by default; build with -lproxyfs.js",m="WORKERFS is no longer included by default; build with -lworkerfs.js",M="FETCHFS is no longer included by default; build with -lfetchfs.js",r="ICASEFS is no longer included by default; build with -licasefs.js",a="JSFILEFS is no longer included by default; build with -ljsfilefs.js",C="OPFS is no longer included by default; build with -lopfs.js",L0="NODEFS is no longer included by default; build with -lnodefs.js";i(!q,"shell environment detected but not enabled at build time.  Add `shell` to `-sENVIRONMENT` to enable.");var e=G.wasmBinary;if(a0("wasmBinary","wasmBinary"),typeof WebAssembly!="object")P("no native wasm support detected");var G0,J0=!1,Q0;function i(Z,D){if(!Z)m0("Assertion failed"+(D?": "+D:""))}var j0,$0,F0,T0,L1,b1,P0,V1,Y1,g8,Z1,u1=!1,f8="data:application/octet-stream;base64,",f1=(Z)=>Z.startsWith(f8),Q1=(Z)=>Z.startsWith("file://");function C8(){var Z=b8();if(i((Z&3)==0),Z==0)Z+=4;P0[Z>>2]=34821223,P0[Z+4>>2]=2310721022,P0[0]=1668509029}function w1(){if(J0)return;var Z=b8();if(Z==0)Z+=4;var D=P0[Z>>2],o=P0[Z+4>>2];if(D!=34821223||o!=2310721022)m0(`Stack overflow! Stack cookie has been overwritten at ${N1(Z)}, expected hex dwords 0x89BACDFE and 0x2135467, but received ${N1(o)} ${N1(D)}`);if(P0[0]!=1668509029)m0("Runtime error: The application has corrupted its heap memory area (address zero)!")}if((()=>{var Z=new Int16Array(1),D=new Int8Array(Z.buffer);if(Z[0]=25459,D[0]!==115||D[1]!==99)throw"Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)"})(),G.ENVIRONMENT)throw new Error("Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)");function a0(Z,D,o=!0){if(!Object.getOwnPropertyDescriptor(G,Z))Object.defineProperty(G,Z,{configurable:!0,get(){let K0=o?" (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)":"";m0(`\`Module.${Z}\` has been replaced by \`${D}\``+K0)}})}function n8(Z){if(Object.getOwnPropertyDescriptor(G,Z))m0(`\`Module.${Z}\` was supplied but \`${Z}\` not included in INCOMING_MODULE_JS_API`)}function C1(Z){return Z==="FS_createPath"||Z==="FS_createDataFile"||Z==="FS_createPreloadedFile"||Z==="FS_unlink"||Z==="addRunDependency"||Z==="FS_createLazyFile"||Z==="FS_createDevice"||Z==="removeRunDependency"}function n1(Z,D){if(typeof globalThis!="undefined"&&!Object.getOwnPropertyDescriptor(globalThis,Z))Object.defineProperty(globalThis,Z,{configurable:!0,get(){D();return}})}function s1(Z,D){n1(Z,()=>{C0(`\`${Z}\` is not longer defined by emscripten. ${D}`)})}s1("buffer","Please use HEAP8.buffer or wasmMemory.buffer"),s1("asm","Please use wasmExports instead");function s8(Z){n1(Z,()=>{var D=`\`${Z}\` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line`,o=Z;if(!o.startsWith("_"))o="$"+Z;if(D+=` (e.g. -sDEFAULT_LIBRARY_FUNCS_TO_INCLUDE='${o}')`,C1(Z))D+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you";C0(D)}),p1(Z)}function p1(Z){if(!Object.getOwnPropertyDescriptor(G,Z))Object.defineProperty(G,Z,{configurable:!0,get(){var D=`'${Z}' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the Emscripten FAQ)`;if(C1(Z))D+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you";m0(D)}})}function A6(...Z){}function y1(){var Z=G0.buffer;G.HEAP8=$0=new Int8Array(Z),G.HEAP16=T0=new Int16Array(Z),G.HEAPU8=F0=new Uint8Array(Z),G.HEAPU16=L1=new Uint16Array(Z),G.HEAP32=b1=new Int32Array(Z),G.HEAPU32=P0=new Uint32Array(Z),G.HEAPF32=V1=new Float32Array(Z),G.HEAPF64=Z1=new Float64Array(Z),G.HEAP64=Y1=new BigInt64Array(Z),G.HEAPU64=g8=new BigUint64Array(Z)}i(!G.STACK_SIZE,"STACK_SIZE can no longer be set at runtime.  Use -sSTACK_SIZE at link time"),i(typeof Int32Array!="undefined"&&typeof Float64Array!=="undefined"&&Int32Array.prototype.subarray!=null&&Int32Array.prototype.set!=null,"JS engine does not provide full typed array support"),i(!G.wasmMemory,"Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally"),i(!G.INITIAL_MEMORY,"Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically");var r1=[],x1=[],W6=[],i1=[];function p8(){if(G.preRun){if(typeof G.preRun=="function")G.preRun=[G.preRun];while(G.preRun.length)x8(G.preRun.shift())}X1(r1)}function y8(){i(!u1),u1=!0,w1(),X1(x1)}function r8(){if(w1(),G.postRun){if(typeof G.postRun=="function")G.postRun=[G.postRun];while(G.postRun.length)a8(G.postRun.shift())}X1(i1)}function x8(Z){r1.unshift(Z)}function i8(Z){x1.unshift(Z)}function h6(Z){}function a8(Z){i1.unshift(Z)}var c0=0,H1=null,o0={},d0=null;function B6(Z){var D=Z;while(!0){if(!o0[Z])return Z;Z=D+Math.random()}}function c8(Z){if(c0++,G.monitorRunDependencies?.(c0),Z){if(i(!o0[Z]),o0[Z]=1,d0===null&&typeof setInterval!="undefined")d0=setInterval(()=>{if(J0){clearInterval(d0),d0=null;return}var D=!1;for(var o in o0){if(!D)D=!0,P("still waiting on run dependencies:");P(`dependency: ${o}`)}if(D)P("(end of list)")},1e4)}else P("warning: run dependency added without ID")}function d8(Z){if(c0--,G.monitorRunDependencies?.(c0),Z)i(o0[Z]),delete o0[Z];else P("warning: run dependency removed without ID");if(c0==0){if(d0!==null)clearInterval(d0),d0=null;if(H1){var D=H1;H1=null,D()}}}function m0(Z){G.onAbort?.(Z),Z="Aborted("+Z+")",P(Z),J0=!0;var D=new WebAssembly.RuntimeError(Z);throw Q(D),D}var z0={error(){m0("Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM")},init(){z0.error()},createDataFile(){z0.error()},createPreloadedFile(){z0.error()},createLazyFile(){z0.error()},open(){z0.error()},mkdev(){z0.error()},registerDevice(){z0.error()},analyzePath(){z0.error()},ErrnoError(){z0.error()}};G.FS_createDataFile=z0.createDataFile,G.FS_createPreloadedFile=z0.createPreloadedFile;function M0(Z,D){return(...o)=>{i(u1,`native function \`${Z}\` called before runtime initialization`);var K0=r0[Z];return i(K0,`exported native function \`${Z}\` not found`),i(o.length<=D,`native function \`${Z}\` called with ${o.length} args but expects ${D}`),K0(...o)}}var $1;function t8(){if(G.locateFile){var Z="tinymidipcm.wasm";if(!f1(Z))return F(Z);return Z}return new URL("tinymidipcm.wasm",import.meta.url).href}function o8(Z){if(Z==$1&&e)return new Uint8Array(e);if(Y)return Y(Z);throw"both async and sync fetching of the wasm failed"}async function l8(Z){if(!e)try{var D=await T(Z);return new Uint8Array(D)}catch{}return o8(Z)}async function e8(Z,D){try{var o=await l8(Z),K0=await WebAssembly.instantiate(o,D);return K0}catch(O0){if(P(`failed to asynchronously prepare wasm: ${O0}`),Q1($1))P(`warning: Loading from a file URI (${$1}) is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing`);m0(O0)}}async function _5(Z,D,o){if(!Z&&typeof WebAssembly.instantiateStreaming=="function"&&!f1(D)&&!Q1(D)&&!O)try{var K0=fetch(D,{credentials:"same-origin"}),O0=await WebAssembly.instantiateStreaming(K0,o);return O0}catch(b0){P(`wasm streaming compile failed: ${b0}`),P("falling back to ArrayBuffer instantiation")}return e8(D,o)}function R5(){return{env:S1,wasi_snapshot_preview1:S1}}async function L5(){function Z(k0,t0){return r0=k0.exports,G0=r0.memory,i(G0,"memory not found in wasm exports"),y1(),i8(r0.__wasm_call_ctors),d8("wasm-instantiate"),r0}c8("wasm-instantiate");var D=G;function o(k0){return i(G===D,"the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?"),D=null,Z(k0.instance)}var K0=R5();if(G.instantiateWasm)try{return G.instantiateWasm(K0,Z)}catch(k0){P(`Module.instantiateWasm callback failed with error: ${k0}`),Q(k0)}$1??=t8();try{var O0=await _5(e,$1,K0),b0=o(O0);return b0}catch(k0){return Q(k0),Promise.reject(k0)}}class J8{name="ExitStatus";constructor(Z){this.message=`Program terminated with exit(${Z})`,this.status=Z}}var X1=(Z)=>{while(Z.length>0)Z.shift()(G)};function G5(Z,D="i8"){if(D.endsWith("*"))D="*";switch(D){case"i1":return $0[Z];case"i8":return $0[Z];case"i16":return T0[Z>>1];case"i32":return b1[Z>>2];case"i64":return Y1[Z>>3];case"float":return V1[Z>>2];case"double":return Z1[Z>>3];case"*":return P0[Z>>2];default:m0(`invalid type for getValue: ${D}`)}}var v5=G.noExitRuntime||!0,N1=(Z)=>{return i(typeof Z==="number"),Z>>>=0,"0x"+Z.toString(16).padStart(8,"0")};function K5(Z,D,o="i8"){if(o.endsWith("*"))o="*";switch(o){case"i1":$0[Z]=D;break;case"i8":$0[Z]=D;break;case"i16":T0[Z>>1]=D;break;case"i32":b1[Z>>2]=D;break;case"i64":Y1[Z>>3]=BigInt(D);break;case"float":V1[Z>>2]=D;break;case"double":Z1[Z>>3]=D;break;case"*":P0[Z>>2]=D;break;default:m0(`invalid type for setValue: ${o}`)}}var m6=(Z)=>i5(Z),S6=()=>k5(),C0=(Z)=>{if(C0.shown||={},!C0.shown[Z]){if(C0.shown[Z]=1,O)Z="warning: "+Z;P(Z)}},Q5=()=>m0("native code called abort()"),H5=()=>2147483648,$5=(Z,D)=>{return i(D,"alignment argument is required"),Math.ceil(Z/D)*D},J5=(Z)=>{var D=G0.buffer,o=(Z-D.byteLength+65535)/65536|0;try{return G0.grow(o),y1(),1}catch(K0){P(`growMemory: Attempted to grow heap from ${D.byteLength} bytes to ${Z} bytes, but got error: ${K0}`)}},O5=(Z)=>{var D=F0.length;Z>>>=0,i(Z>D);var o=H5();if(Z>o)return P(`Cannot enlarge memory, requested ${Z} bytes, but the limit is ${o} bytes!`),!1;for(var K0=1;K0<=4;K0*=2){var O0=D*(1+0.2/K0);O0=Math.min(O0,Z+100663296);var b0=Math.min(o,$5(Math.max(Z,O0),65536)),k0=J5(b0);if(k0)return!0}return P(`Failed to grow the heap from ${D} bytes to ${b0} bytes, not enough memory!`),!1},a1=typeof TextDecoder!="undefined"?new TextDecoder:void 0,c1=(Z,D=0,o=NaN)=>{var K0=D+o,O0=D;while(Z[O0]&&!(O0>=K0))++O0;if(O0-D>16&&Z.buffer&&a1)return a1.decode(Z.subarray(D,O0));var b0="";while(D<O0){var k0=Z[D++];if(!(k0&128)){b0+=String.fromCharCode(k0);continue}var t0=Z[D++]&63;if((k0&224)==192){b0+=String.fromCharCode((k0&31)<<6|t0);continue}var U1=Z[D++]&63;if((k0&240)==224)k0=(k0&15)<<12|t0<<6|U1;else{if((k0&248)!=240)C0("Invalid UTF-8 leading byte "+N1(k0)+" encountered when deserializing a UTF-8 string in wasm memory to a JS string!");k0=(k0&7)<<18|t0<<12|U1<<6|Z[D++]&63}if(k0<65536)b0+=String.fromCharCode(k0);else{var c5=k0-65536;b0+=String.fromCharCode(55296|c5>>10,56320|c5&1023)}}return b0},q5=(Z,D)=>{return i(typeof Z=="number",`UTF8ToString expects a number (got ${typeof Z})`),Z?c1(F0,Z,D):""},g5={varargs:void 0,getStr(Z){var D=q5(Z);return D}},b5=(Z)=>{m0("fd_close called without SYSCALLS_REQUIRE_FILESYSTEM")},O8=9007199254740992,q8=-9007199254740992,N5=(Z)=>Z<q8||Z>O8?NaN:Number(Z);function f5(Z,D,o,K0){return D=N5(D),70}var d1=[null,[],[]],t1=(Z,D)=>{var o=d1[Z];if(i(o),D===0||D===10)(Z===1?W:P)(c1(o)),o.length=0;else o.push(D)},U5=()=>{if(y5(0),d1[1].length)t1(1,10);if(d1[2].length)t1(2,10)},I5=(Z,D,o,K0)=>{var O0=0;for(var b0=0;b0<o;b0++){var k0=P0[D>>2],t0=P0[D+4>>2];D+=8;for(var U1=0;U1<t0;U1++)t1(Z,F0[k0+U1]);O0+=t0}return P0[K0>>2]=O0,0};function E5(){n8("fetchSettings")}var S1={_abort_js:Q5,emscripten_resize_heap:O5,fd_close:b5,fd_seek:f5,fd_write:I5},r0=await L5(),C5=M0("__wasm_call_ctors",0),n5=G._malloc=M0("malloc",1),s5=G._free=M0("free",1),F5=G._tsf_load_memory=M0("tsf_load_memory",2),l0=G._tsf_close=M0("tsf_close",1),P6=G._tsf_reset=M0("tsf_reset",1),z6=G._tsf_set_output=M0("tsf_set_output",4),D6=G._realloc=M0("realloc",2),p5=G._tsf_channel_set_bank_preset=M0("tsf_channel_set_bank_preset",4),M6=G._tml_load_memory=M0("tml_load_memory",2),v6=G._midi_render=M0("midi_render",7),y5=M0("fflush",1),r5=M0("strerror",1),x5=r0.emscripten_stack_init,g6=r0.emscripten_stack_get_free,T5=r0.emscripten_stack_get_base,b8=r0.emscripten_stack_get_end,i5=r0._emscripten_stack_restore,a5=r0._emscripten_stack_alloc,k5=r0.emscripten_stack_get_current;G.setValue=K5,G.getValue=G5;var j5=["writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","stackAlloc","getTempRet0","setTempRet0","zeroMemory","exitJS","strError","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","emscriptenLog","readEmAsmArgs","jstoi_q","getExecutableName","listenOnce","autoResumeAudioContext","getDynCaller","dynCall","handleException","keepRuntimeAlive","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","asmjsMangle","asyncLoad","mmapAlloc","HandleAllocator","getNativeTypeSize","STACK_SIZE","STACK_ALIGN","POINTER_SIZE","ASSERTIONS","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","generateFuncType","convertJsFunctionToWasm","getEmptyTableSlot","updateTableMap","getFunctionAddress","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","stringToUTF8Array","stringToUTF8","lengthBytesUTF8","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","stringToNewUTF8","stringToUTF8OnStack","writeArrayToMemory","registerKeyEventCallback","maybeCStringToJsString","findEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","jsStackTrace","getCallstack","convertPCtoSourceLocation","getEnvStrings","checkWasiClock","wasiRightsToMuslOFlags","wasiOFlagsToMuslOFlags","initRandomFill","randomFill","safeSetTimeout","setImmediateWrapped","safeRequestAnimationFrame","clearImmediateWrapped","registerPostMainLoop","registerPreMainLoop","getPromise","makePromise","idsToPromises","makePromiseCallback","ExceptionInfo","findMatchingCatch","Browser_asyncPrepareDataCounter","isLeapYear","ydayFromDate","arraySum","addDays","getSocketFromFD","getSocketAddress","FS_createPreloadedFile","FS_modeStringToFlags","FS_getMode","FS_stdin_getChar","FS_unlink","FS_createDataFile","FS_mkdirTree","_setNetworkCallback","heapObjectForWebGLType","toTypedArrayIndex","webgl_enable_ANGLE_instanced_arrays","webgl_enable_OES_vertex_array_object","webgl_enable_WEBGL_draw_buffers","webgl_enable_WEBGL_multi_draw","webgl_enable_EXT_polygon_offset_clamp","webgl_enable_EXT_clip_control","webgl_enable_WEBGL_polygon_mode","emscriptenWebGLGet","computeUnpackAlignedImageSize","colorChannelsInGlTextureFormat","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","__glGetActiveAttribOrUniform","writeGLArray","registerWebGlEventCallback","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate","writeStringToMemory","writeAsciiToMemory","setErrNo","demangle","stackTrace"];j5.forEach(s8);var N8=["run","addOnPreRun","addOnInit","addOnPreMain","addOnExit","addOnPostRun","addRunDependency","removeRunDependency","out","err","callMain","abort","wasmMemory","wasmExports","writeStackCookie","checkStackCookie","INT53_MAX","INT53_MIN","bigintToI53Checked","stackSave","stackRestore","ptrToString","getHeapMax","growMemory","ENV","ERRNO_CODES","DNS","Protocols","Sockets","timers","warnOnce","readEmAsmArgsArray","jstoi_s","alignMemory","wasmTable","noExitRuntime","freeTableIndexes","functionsInTableMap","PATH","PATH_FS","UTF8Decoder","UTF8ArrayToString","UTF8ToString","UTF16Decoder","JSEvents","specialHTMLTargets","findCanvasEventTarget","currentFullscreenStrategy","restoreOldWindowedStyle","UNWIND_CACHE","ExitStatus","flush_NO_FILESYSTEM","emSetImmediate","emClearImmediate_deps","emClearImmediate","promiseMap","uncaughtExceptionCount","exceptionLast","exceptionCaught","Browser","getPreloadedImageData__data","wget","MONTH_DAYS_REGULAR","MONTH_DAYS_LEAP","MONTH_DAYS_REGULAR_CUMULATIVE","MONTH_DAYS_LEAP_CUMULATIVE","SYSCALLS","preloadPlugins","FS_stdin_getChar_buffer","FS_createPath","FS_createDevice","FS_readFile","FS","FS_createLazyFile","MEMFS","TTY","PIPEFS","SOCKFS","tempFixedLengthArray","miniTempWebGLFloatBuffers","miniTempWebGLIntBuffers","GL","AL","GLUT","EGL","GLEW","IDBStore","SDL","SDL_gfx","allocateUTF8","allocateUTF8OnStack","print","printErr"];N8.forEach(p1);var U8;function o1(){x5(),C8()}function l1(){if(c0>0){H1=l1;return}if(o1(),p8(),c0>0){H1=l1;return}function Z(){if(i(!U8),U8=!0,G.calledRun=!0,J0)return;y8(),K(G),G.onRuntimeInitialized?.(),i(!G._main,'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]'),r8()}if(G.setStatus)G.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>G.setStatus(""),1),Z()},1);else Z();w1()}function A(){var Z=W,D=P,o=!1;W=P=(K0)=>{o=!0};try{U5()}catch(K0){}if(W=Z,P=D,o)C0("stdio streams had content in them that was not flushed. you should set EXIT_RUNTIME to 1 (see the Emscripten FAQ), or make sure to emit a newline when you printf etc."),C0("(this may also be due to not including full filesystem support - try building with -sFORCE_FILESYSTEM)")}if(G.preInit){if(typeof G.preInit=="function")G.preInit=[G.preInit];while(G.preInit.length>0)G.preInit.pop()()}l1(),L=H;for(let Z of Object.keys(G))if(!(Z in R))Object.defineProperty(R,Z,{configurable:!0,get(){m0(`Access to module property ('${Z}') is no longer possible via the module constructor argument; Instead, use the result of the module constructor.`)}});return L}})();(()=>{var _=S5;S5=function(R){if(new.target)throw new Error("loadTinyMidiPCM() should not be called with `new loadTinyMidiPCM()`");return _(R)}})();var q6=S5;var P5=["F11","F12"],E0={Backspace:{code:8,ch:8},Enter:{code:10,ch:10},Shift:{code:16,ch:65535},Escape:{code:27,ch:27},Tab:{code:9,ch:9},CapsLock:{code:20,ch:65535}," ":{code:32,ch:32},Control:{code:17,ch:65535},Alt:{code:18,ch:65535},Meta:{code:524,ch:65535},ArrowLeft:{code:37,ch:65535},ArrowRight:{code:39,ch:65535},ArrowUp:{code:38,ch:65535},ArrowDown:{code:40,ch:65535},Insert:{code:155,ch:65535},Home:{code:36,ch:65535},PageUp:{code:33,ch:65535},Delete:{code:127,ch:127},End:{code:35,ch:65535},PageDown:{code:34,ch:65535},"`":{code:192,ch:96},"~":{code:192,ch:126},"!":{code:49,ch:33},"@":{code:50,ch:64},"#":{code:51,ch:35},$:{code:52,ch:36},"%":{code:53,ch:37},"^":{code:54,ch:94},"&":{code:55,ch:38},"*":{code:56,ch:42},"(":{code:57,ch:40},")":{code:48,ch:41},"-":{code:45,ch:45},_:{code:45,ch:95},"=":{code:61,ch:61},"+":{code:61,ch:43},"[":{code:91,ch:91},"{":{code:91,ch:123},"]":{code:93,ch:93},"}":{code:93,ch:125},"\\":{code:92,ch:92},"|":{code:92,ch:124},";":{code:59,ch:59},":":{code:59,ch:58},"'":{code:222,ch:39},'"':{code:222,ch:34},",":{code:44,ch:44},"<":{code:44,ch:60},".":{code:46,ch:46},">":{code:46,ch:62},"/":{code:47,ch:47},"?":{code:47,ch:63},F1:{code:112,ch:65535},F2:{code:113,ch:65535},F3:{code:114,ch:65535},F4:{code:115,ch:65535},F5:{code:116,ch:65535},F6:{code:117,ch:65535},F7:{code:118,ch:65535},F8:{code:119,ch:65535},F9:{code:120,ch:65535},F10:{code:121,ch:65535},F11:{code:122,ch:65535},F12:{code:123,ch:65535},"0":{code:48,ch:48},"1":{code:49,ch:49},"2":{code:50,ch:50},"3":{code:51,ch:51},"4":{code:52,ch:52},"5":{code:53,ch:53},"6":{code:54,ch:54},"7":{code:55,ch:55},"8":{code:56,ch:56},"9":{code:57,ch:57},a:{code:65,ch:97},b:{code:66,ch:98},c:{code:67,ch:99},d:{code:68,ch:100},e:{code:69,ch:101},f:{code:70,ch:102},g:{code:71,ch:103},h:{code:72,ch:104},i:{code:73,ch:105},j:{code:74,ch:106},k:{code:75,ch:107},l:{code:76,ch:108},m:{code:77,ch:109},n:{code:78,ch:110},o:{code:79,ch:111},p:{code:80,ch:112},q:{code:81,ch:113},r:{code:82,ch:114},s:{code:83,ch:115},t:{code:84,ch:116},u:{code:85,ch:117},v:{code:86,ch:118},w:{code:87,ch:119},x:{code:88,ch:120},y:{code:89,ch:121},z:{code:90,ch:122},A:{code:65,ch:65},B:{code:66,ch:66},C:{code:67,ch:67},D:{code:68,ch:68},E:{code:69,ch:69},F:{code:70,ch:70},G:{code:71,ch:71},H:{code:72,ch:72},I:{code:73,ch:73},J:{code:74,ch:74},K:{code:75,ch:75},L:{code:76,ch:76},M:{code:77,ch:77},N:{code:78,ch:78},O:{code:79,ch:79},P:{code:80,ch:80},Q:{code:81,ch:81},R:{code:82,ch:82},S:{code:83,ch:83},T:{code:84,ch:84},U:{code:85,ch:85},V:{code:86,ch:86},W:{code:87,ch:87},X:{code:88,ch:88},Y:{code:89,ch:89},Z:{code:90,ch:90}};class D0{key;next;prev;constructor(){this.key=0n,this.next=this,this.prev=this}unlink(){if(!this.prev||!this.next)return;this.prev.next=this.next,this.next.prev=this.prev,this.next=null,this.prev=null}}class x0 extends D0{next2;prev2;constructor(){super();this.next2=this,this.prev2=this}uncache(){if(!this.prev2||!this.next2)return;this.prev2.next2=this.next2,this.next2.prev2=this.prev2,this.next2=null,this.prev2=null}}class g0{sentinel;cursor=null;constructor(){let _=new D0;_.next=_,_.prev=_,this.sentinel=_}addTail(_){if(_.prev)_.unlink();if(_.prev=this.sentinel.prev,_.next=this.sentinel,_.prev)_.prev.next=_;_.next.prev=_}addHead(_){if(_.prev)_.unlink();if(_.prev=this.sentinel,_.next=this.sentinel.next,_.prev.next=_,_.next)_.next.prev=_}removeHead(){let _=this.sentinel.next;if(_===this.sentinel)return null;return _?.unlink(),_}head(){let _=this.sentinel.next;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next||null,_}tail(){let _=this.sentinel.prev;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.prev||null,_}next(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next||null,_}prev(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.prev||null,_}clear(){while(!0){let _=this.sentinel.next;if(_===this.sentinel)return;_?.unlink()}}}var q1=async(_)=>new Promise((R)=>setTimeout(R,_)),T8=async(_)=>new Uint8Array(await(await fetch(_)).arrayBuffer());function z5(_,R,L,G,K){while(K--)L[G++]=_[R++]}function b6(_){let R=0n;for(let L=0;L<_.length;L++)R=R<<8n|BigInt(_[L]);return R}function N6(_){let R=[];while(_>0n)R.unshift(Number(_&0xffn)),_>>=8n;if(R[0]&128)R.unshift(0);return new Uint8Array(R)}function U6(_,R,L){let G=1n;while(R>0n){if(R%2n===1n)G=G*_%L;_=_*_%L,R>>=1n}return G}class p extends x0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new g0;static cacheMid=new g0;static cacheMax=new g0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let _=0;_<32;_++)p.bitmask[_]=(1<<_)-1;p.bitmask[32]=4294967295;for(let _=0;_<256;_++){let R=_;for(let L=0;L<8;L++)if((R&1)===1)R=R>>>1^p.CRC32_POLYNOMIAL;else R>>>=1;p.crctable[_]=R}}static crc32=(_)=>{let R=4294967295;for(let L=0;L<_.length;L++)R=R>>>8^p.crctable[(R^_[L])&255];return~R};view;data;pos=0;bitPos=0;random=null;constructor(_){if(!_)throw new Error("Input src packet array was null!");super();if(_ instanceof Int8Array)this.data=new Uint8Array(_);else this.data=_;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc=(_)=>{let R=null;if(_===0&&p.cacheMinCount>0)p.cacheMinCount--,R=p.cacheMin.removeHead();else if(_===1&&p.cacheMidCount>0)p.cacheMidCount--,R=p.cacheMid.removeHead();else if(_===2&&p.cacheMaxCount>0)p.cacheMaxCount--,R=p.cacheMax.removeHead();if(R)return R.pos=0,R;if(_===0)return new p(new Uint8Array(100));else if(_===1)return new p(new Uint8Array(5000));return new p(new Uint8Array(30000))};release(){if(this.pos=0,this.view.byteLength===100&&p.cacheMinCount<1000)p.cacheMin.addTail(this),p.cacheMinCount++;else if(this.view.byteLength===5000&&p.cacheMidCount<250)p.cacheMid.addTail(this),p.cacheMidCount++;else if(this.view.byteLength===30000&&p.cacheMaxCount<50)p.cacheMax.addTail(this),p.cacheMaxCount++}get g1(){return this.view.getUint8(this.pos++)}get g1b(){return this.view.getInt8(this.pos++)}get g2(){let _=this.view.getUint16(this.pos);return this.pos+=2,_}get g2b(){let _=this.view.getInt16(this.pos);return this.pos+=2,_}get g3(){let _=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,_}get g4(){let _=this.view.getInt32(this.pos);return this.pos+=4,_}get g8(){let _=this.view.getBigInt64(this.pos);return this.pos+=8,_}get gsmart(){return this.view.getUint8(this.pos)<128?this.g1-64:this.g2-49152}get gsmarts(){return this.view.getUint8(this.pos)<128?this.g1:this.g2-32768}get gjstr(){let _=this.view,R=_.byteLength,L="",G;while((G=_.getUint8(this.pos++))!==10&&this.pos<R)L+=String.fromCharCode(G);return L}gdata(_,R,L){L.set(this.data.subarray(this.pos,this.pos+_),R),this.pos+=_}p1isaac(_){this.view.setUint8(this.pos++,_+(this.random?.nextInt??0)&255)}p1(_){this.view.setUint8(this.pos++,_)}p2(_){this.view.setUint16(this.pos,_),this.pos+=2}ip2(_){this.view.setUint16(this.pos,_,!0),this.pos+=2}p3(_){this.view.setUint8(this.pos++,_>>16),this.view.setUint16(this.pos,_),this.pos+=2}p4(_){this.view.setInt32(this.pos,_),this.pos+=4}ip4(_){this.view.setInt32(this.pos,_,!0),this.pos+=4}p8(_){this.view.setBigInt64(this.pos,_),this.pos+=8}pjstr(_){let R=this.view,L=_.length;for(let G=0;G<L;G++)R.setUint8(this.pos++,_.charCodeAt(G));R.setUint8(this.pos++,10)}pdata(_,R,L){this.data.set(_.subarray(L,L+R),this.pos),this.pos+=R-L}psize1(_){this.view.setUint8(this.pos-_-1,_)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(_){let R=this.bitPos>>>3,L=8-(this.bitPos&7),G=0;this.bitPos+=_;for(;_>L;L=8)G+=(this.view.getUint8(R++)&p.bitmask[L])<<_-L,_-=L;if(_===L)G+=this.view.getUint8(R)&p.bitmask[L];else G+=this.view.getUint8(R)>>>L-_&p.bitmask[_];return G}rsaenc(_,R){let L=this.pos;this.pos=0;let G=new Uint8Array(L);this.gdata(L,0,G);let K=b6(G),Q=U6(K,R,_),H=N6(Q);this.pos=0,this.p1(H.length),this.pdata(H,H.length,0)}}class S0{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled=()=>{this.outBuffer=p.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.enabled=!0};static setDisabled=()=>{this.enabled=!1,this.outBuffer=null};static flush=()=>{let _=null;if(this.oldBuffer&&this.enabled)_=this.oldBuffer;return this.oldBuffer=null,_};static stop=()=>{let _=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.enabled)_=this.outBuffer;return this.setDisabled(),_};static mousePressed=(_,R,L)=>{if(!(this.enabled&&_>=0&&_<789&&R>=0&&R<532))return;this.trackedCount++;let G=performance.now(),K=(G-this.lastTime)/10|0;if(K>250)K=250;if(this.lastTime=G,this.ensureCapacity(5),L===1)this.outBuffer?.p1(1);else this.outBuffer?.p1(2);this.outBuffer?.p1(K),this.outBuffer?.p3(_+(R<<10))};static mouseReleased=(_)=>{if(!this.enabled)return;this.trackedCount++;let R=performance.now(),L=(R-this.lastTime)/10|0;if(L>250)L=250;if(this.lastTime=R,this.ensureCapacity(2),_===1)this.outBuffer?.p1(3);else this.outBuffer?.p1(4);this.outBuffer?.p1(L)};static mouseMoved=(_,R)=>{if(!(this.enabled&&_>=0&&_<789&&R>=0&&R<532))return;let L=performance.now();if(L-this.lastMoveTime>=50){this.lastMoveTime=L,this.trackedCount++;let G=(L-this.lastTime)/10|0;if(G>250)G=250;if(this.lastTime=L,_-this.lastX<8&&_-this.lastX>=-8&&R-this.lastY<8&&R-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer?.p1(5),this.outBuffer?.p1(G),this.outBuffer?.p1(_+(R-this.lastY+8<<4)+8-this.lastX);else if(_-this.lastX<128&&_-this.lastX>=-128&&R-this.lastY<128&&R-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer?.p1(6),this.outBuffer?.p1(G),this.outBuffer?.p1(_+128-this.lastX),this.outBuffer?.p1(R+128-this.lastY);else this.ensureCapacity(5),this.outBuffer?.p1(7),this.outBuffer?.p1(G),this.outBuffer?.p3(_+(R<<10));this.lastX=_,this.lastY=R}};static keyPressed=(_)=>{if(!this.enabled)return;this.trackedCount++;let R=performance.now(),L=(R-this.lastTime)/10|0;if(L>250)L=250;if(this.lastTime=R,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer?.p1(8),this.outBuffer?.p1(L),this.outBuffer?.p1(_)};static keyReleased=(_)=>{if(!this.enabled)return;this.trackedCount++;let R=performance.now(),L=(R-this.lastTime)/10|0;if(L>250)L=250;if(this.lastTime=R,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer?.p1(9),this.outBuffer?.p1(L),this.outBuffer?.p1(_)};static focusGained=()=>{if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(10),this.outBuffer?.p1(R)};static focusLost=()=>{if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(11),this.outBuffer?.p1(R)};static mouseEntered=()=>{if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(12),this.outBuffer?.p1(R)};static mouseExited=()=>{if(!this.enabled)return;this.trackedCount++;let _=performance.now(),R=(_-this.lastTime)/10|0;if(R>250)R=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer?.p1(13),this.outBuffer?.p1(R)};static ensureCapacity=(_)=>{if(!this.outBuffer)return;if(this.outBuffer.pos+_>=500){let R=this.outBuffer;this.outBuffer=p.alloc(1),this.oldBuffer=R}}}var u0=document.getElementById("canvas"),q0=u0.getContext("2d",{willReadFrequently:!0}),D1=document.createElement("canvas"),A1=document.createElement("img"),k8=D1.getContext("2d",{willReadFrequently:!0});class j extends x0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind=(_,R,L)=>{this.pixels=_,this.width2d=R,this.height2d=L,this.setBounds(0,0,R,L)};static resetBounds=()=>{this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0};static setBounds=(_,R,L,G)=>{if(_<0)_=0;if(R<0)R=0;if(L>this.width2d)L=this.width2d;if(G>this.height2d)G=this.height2d;this.top=R,this.bottom=G,this.left=_,this.right=L,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0};static clear=()=>{let _=this.width2d*this.height2d;for(let R=0;R<_;R++)this.pixels[R]=0};static drawRect=(_,R,L,G,K)=>{this.drawHorizontalLine(_,R,K,L),this.drawHorizontalLine(_,R+G-1,K,L),this.drawVerticalLine(_,R,K,G),this.drawVerticalLine(_+L-1,R,K,G)};static drawHorizontalLine=(_,R,L,G)=>{if(R<this.top||R>=this.bottom)return;if(_<this.left)G-=this.left-_,_=this.left;if(_+G>this.right)G=this.right-_;let K=_+R*this.width2d;for(let Q=0;Q<G;Q++)this.pixels[K+Q]=L};static drawVerticalLine=(_,R,L,G)=>{if(_<this.left||_>=this.right)return;if(R<this.top)G-=this.top-R,R=this.top;if(R+G>this.bottom)G=this.bottom-R;let K=_+R*this.width2d;for(let Q=0;Q<G;Q++)this.pixels[K+Q*this.width2d]=L};static drawLine=(_,R,L,G,K)=>{let Q=Math.abs(L-_),H=Math.abs(G-R),$=_<L?1:-1,J=R<G?1:-1,O=Q-H;while(!0){if(_>=this.left&&_<this.right&&R>=this.top&&R<this.bottom)this.pixels[_+R*this.width2d]=K;if(_===L&&R===G)break;let q=2*O;if(q>-H)O=O-H,_=_+$;if(q<Q)O=O+Q,R=R+J}};static fillRect=(_,R,L,G,K)=>{if(_<this.left)L-=this.left-_,_=this.left;if(R<this.top)G-=this.top-R,R=this.top;if(_+L>this.right)L=this.right-_;if(R+G>this.bottom)G=this.bottom-R;let Q=this.width2d-L,H=_+R*this.width2d;for(let $=-G;$<0;$++){for(let J=-L;J<0;J++)this.pixels[H++]=K;H+=Q}};static fillRectAlpha(_,R,L,G,K,Q){if(_<this.left)L-=this.left-_,_=this.left;if(R<this.top)G-=this.top-R,R=this.top;if(_+L>this.right)L=this.right-_;if(R+G>this.bottom)G=this.bottom-R;let H=256-Q,$=(K>>16&255)*Q,J=(K>>8&255)*Q,O=(K&255)*Q,q=this.width2d-L,b=_+R*this.width2d;for(let U=0;U<G;U++){for(let N=-L;N<0;N++){let I=(this.pixels[b]>>16&255)*H,k=(this.pixels[b]>>8&255)*H,F=(this.pixels[b]&255)*H,T=($+I>>8<<16)+(J+k>>8<<8)+(O+F>>8);this.pixels[b++]=T}b+=q}}static fillCircle(_,R,L,G,K){let Q=256-K,H=(G>>16&255)*K,$=(G>>8&255)*K,J=(G&255)*K,O=R-L;if(O<0)O=0;let q=R+L;if(q>=this.height2d)q=this.height2d-1;for(let b=O;b<=q;b++){let U=b-R,N=Math.sqrt(L*L-U*U)|0,I=_-N;if(I<0)I=0;let k=_+N;if(k>=this.width2d)k=this.width2d-1;let F=I+b*this.width2d;for(let T=I;T<=k;T++){let Y=(this.pixels[F]>>16&255)*Q,u=(this.pixels[F]>>8&255)*Q,w=(this.pixels[F]&255)*Q,B=(H+Y>>8<<16)+($+u>>8<<8)+(J+w>>8);this.pixels[F++]=B}}}static setPixel=(_,R,L)=>{if(_<this.left||_>=this.right||R<this.top||R>=this.bottom)return;this.pixels[_+R*this.width2d]=L}}class h0 extends x0{pixels;width;height;cropX;cropY;cropW;cropH;palette;constructor(_,R,L){super();this.pixels=new Int8Array(_*R),this.width=this.cropW=_,this.height=this.cropH=R,this.cropX=this.cropY=0,this.palette=L}static fromArchive=(_,R,L=0)=>{let G=new p(_.read(R+".dat")),K=new p(_.read("index.dat"));K.pos=G.g2;let{g2:Q,g2:H,g1:$}=K,J=new Int32Array($);for(let F=1;F<$;F++)if(J[F]=K.g3,J[F]===0)J[F]=1;for(let F=0;F<L;F++)K.pos+=2,G.pos+=K.g2*K.g2,K.pos+=1;if(G.pos>G.length||K.pos>K.length)throw new Error;let{g1:O,g1:q,g2:b,g2:U}=K,N=new h0(b,U,J);N.cropX=O,N.cropY=q,N.cropW=Q,N.cropH=H;let I=N.pixels,k=K.g1;if(k===0){let F=N.width*N.height;for(let T=0;T<F;T++)I[T]=G.g1b}else if(k===1){let{width:F,height:T}=N;for(let Y=0;Y<F;Y++)for(let u=0;u<T;u++)I[Y+u*F]=G.g1b}return N};draw(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let L=_+R*j.width2d,G=0,K=this.height,Q=this.width,H=j.width2d-Q,$=0;if(R<j.top){let J=j.top-R;K-=J,R=j.top,G+=J*Q,L+=J*j.width2d}if(R+K>j.bottom)K-=R+K-j.bottom;if(_<j.left){let J=j.left-_;Q-=J,_=j.left,G+=J,L+=J,$+=J,H+=J}if(_+Q>j.right){let J=_+Q-j.right;Q-=J,$+=J,H+=J}if(Q>0&&K>0)this.copyImage(Q,K,this.pixels,G,$,j.pixels,L,H)}flipHorizontally(){let _=this.pixels,R=this.width,L=this.height;for(let G=0;G<L;G++){let K=R/2|0;for(let Q=0;Q<K;Q++){let H=Q+G*R,$=R-Q-1+G*R,J=_[H];_[H]=_[$],_[$]=J}}}flipVertically(){let _=this.pixels,R=this.width,L=this.height;for(let G=0;G<(L/2|0);G++)for(let K=0;K<R;K++){let Q=K+G*R,H=K+(L-G-1)*R,$=_[Q];_[Q]=_[H],_[H]=$}}translate(_,R,L){for(let G=0;G<this.palette.length;G++){let K=this.palette[G]>>16&255;if(K+=_,K<0)K=0;else if(K>255)K=255;let Q=this.palette[G]>>8&255;if(Q+=R,Q<0)Q=0;else if(Q>255)Q=255;let H=this.palette[G]&255;if(H+=L,H<0)H=0;else if(H>255)H=255;this.palette[G]=(K<<16)+(Q<<8)+H}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let _=new Int8Array(this.cropW*this.cropH),R=0;for(let L=0;L<this.height;L++)for(let G=0;G<this.width;G++)_[(G+this.cropX>>1)+(L+this.cropY>>1)*this.cropW]=this.pixels[R++];this.pixels=_,this.width=this.cropW,this.height=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width===this.cropW&&this.height===this.cropH)return;let _=new Int8Array(this.cropW*this.cropH),R=0;for(let L=0;L<this.height;L++)for(let G=0;G<this.width;G++)_[G+this.cropX+(L+this.cropY)*this.cropW]=this.pixels[R++];this.pixels=_,this.width=this.cropW,this.height=this.cropH,this.cropX=0,this.cropY=0}copyImage(_,R,L,G,K,Q,H,$){let J=-(_>>2);_=-(_&3);for(let O=-R;O<0;O++){for(let q=J;q<0;q++){let b=L[G++];if(b===0)H++;else Q[H++]=this.palette[b&255];if(b=L[G++],b===0)H++;else Q[H++]=this.palette[b&255];if(b=L[G++],b===0)H++;else Q[H++]=this.palette[b&255];if(b=L[G++],b===0)H++;else Q[H++]=this.palette[b&255]}for(let q=_;q<0;q++){let b=L[G++];if(b===0)H++;else Q[H++]=this.palette[b&255]}H+=$,G+=K}}clip(_,R,L,G){try{let K=this.width,Q=this.height,H=0,$=0,J=(K<<16)/L|0,O=(Q<<16)/G|0,q=this.cropW,b=this.cropH,U=(q<<16)/L|0,N=(b<<16)/G|0;if(_=_+(this.cropX*L+q-1)/q|0,R=R+(this.cropY*G+b-1)/b|0,this.cropX*L%q!=0)H=(q-this.cropX*L%q<<16)/L|0;if(this.cropY*G%b!=0)$=(b-this.cropY*G%b<<16)/G|0;L=L*(this.width-(H>>16))/q|0,G=G*(this.height-($>>16))/b|0;let I=_+R*j.width2d,k=j.width2d-L,F;if(R<j.top)F=j.top-R,G-=F,R=0,I+=F*j.width2d,$+=N*F;if(R+G>j.bottom)G-=R+G-j.bottom;if(_<j.left)F=j.left-_,L-=F,_=0,I+=F,H+=U*F,k+=F;if(_+L>j.right)F=_+L-j.right,L-=F,k+=F;this.plot_scale(j.pixels,this.pixels,this.palette,H,$,I,k,L,G,U,N,K)}catch(K){}}plot_scale(_,R,L,G,K,Q,H,$,J,O,q,b){try{let U=G;for(let N=-J;N<0;N++){let I=(K>>16)*b;for(let k=-$;k<0;k++){let F=R[(G>>16)+I];if(F==0)Q++;else _[Q++]=L[F&255];G+=O}K+=q,G=U,Q+=H}}catch(U){}}}class l extends Array{constructor(_,R){super(_);for(let L=0;L<_;L++)this[L]=R}}class D5 extends Array{constructor(_,R,L){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let K=0;K<R;K++)this[G][K]=L}}}class e1 extends Array{constructor(_,R,L,G){super(_);for(let K=0;K<_;K++){this[K]=new Array(R);for(let Q=0;Q<R;Q++){this[K][Q]=new Array(L);for(let H=0;H<L;H++)this[K][Q][H]=G}}}}class j8 extends Array{constructor(_,R,L,G,K){super(_);for(let Q=0;Q<_;Q++){this[Q]=new Array(R);for(let H=0;H<R;H++){this[Q][H]=new Array(L);for(let $=0;$<L;$++){this[Q][H][$]=new Array(G);for(let J=0;J<G;J++)this[Q][H][$][J]=K}}}}}class I1 extends Array{constructor(_,R,L){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let K=0;K<R;K++)this[G][K]=new Uint8Array(L)}}}class J1 extends Array{constructor(_,R){super(_);for(let L=0;L<_;L++)this[L]=new Int32Array(R)}}class W1 extends Array{constructor(_,R,L){super(_);for(let G=0;G<_;G++){this[G]=new Array(R);for(let K=0;K<R;K++)this[G][K]=new Int32Array(L)}}}class h extends j{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static palette=new Int32Array(65536);static textures=new l(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new l(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texturePalette=new l(50,null);static opaque=!1;static textureTranslucent=new l(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let _=1;_<512;_++)this.reciprocal15[_]=32768/_|0;for(let _=1;_<2048;_++)this.reciprocal16[_]=65536/_|0;for(let _=0;_<2048;_++)this.sin[_]=Math.sin(_*0.0030679615757712823)*65536|0,this.cos[_]=Math.cos(_*0.0030679615757712823)*65536|0}static init2D=()=>{this.lineOffset=new Int32Array(j.height2d);for(let _=0;_<j.height2d;_++)this.lineOffset[_]=j.width2d*_;this.centerX=j.width2d/2|0,this.centerY=j.height2d/2|0};static init3D=(_,R)=>{this.lineOffset=new Int32Array(R);for(let L=0;L<R;L++)this.lineOffset[L]=_*L;this.centerX=_/2|0,this.centerY=R/2|0};static clearTexels=()=>{this.texelPool=null,this.activeTexels.fill(null)};static unpackTextures=(_)=>{this.textureCount=0;for(let R=0;R<50;R++)try{if(this.textures[R]=h0.fromArchive(_,R.toString()),this.lowMemory&&this.textures[R]?.cropW===128)this.textures[R]?.shrink();else this.textures[R]?.crop();this.textureCount++}catch(L){}};static getAverageTextureRGB=(_)=>{if(this.averageTextureRGB[_]!==0)return this.averageTextureRGB[_];let R=this.texturePalette[_];if(!R)return 0;let L=0,G=0,K=0,Q=R.length;for(let $=0;$<Q;$++)L+=R[$]>>16&255,G+=R[$]>>8&255,K+=R[$]&255;let H=((L/Q|0)<<16)+((G/Q|0)<<8)+(K/Q|0);if(H=this.setGamma(H,1.4),H===0)H=1;return this.averageTextureRGB[_]=H,H};static setBrightness=(_)=>{let R=_+Math.random()*0.03-0.015,L=0;for(let G=0;G<512;G++){let K=(G/8|0)/64+0.0078125,Q=(G&7)/8+0.0625;for(let H=0;H<128;H++){let $=H/128,J=$,O=$,q=$;if(Q!==0){let k;if($<0.5)k=$*(Q+1);else k=$+Q-$*Q;let F=$*2-k,T=K+0.3333333333333333;if(T>1)T--;let Y=K-0.3333333333333333;if(Y<0)Y++;if(T*6<1)J=F+(k-F)*6*T;else if(T*2<1)J=k;else if(T*3<2)J=F+(k-F)*(0.6666666666666666-T)*6;else J=F;if(K*6<1)O=F+(k-F)*6*K;else if(K*2<1)O=k;else if(K*3<2)O=F+(k-F)*(0.6666666666666666-K)*6;else O=F;if(Y*6<1)q=F+(k-F)*6*Y;else if(Y*2<1)q=k;else if(Y*3<2)q=F+(k-F)*(0.6666666666666666-Y)*6;else q=F}let b=J*256|0,U=O*256|0,N=q*256|0,I=(b<<16)+(U<<8)+N;this.palette[L++]=this.setGamma(I,R)}}for(let G=0;G<50;G++){let K=this.textures[G];if(!K)continue;let Q=K.palette;this.texturePalette[G]=new Int32Array(Q.length);for(let H=0;H<Q.length;H++){let $=this.texturePalette[G];if(!$)continue;$[H]=this.setGamma(Q[H],R)}}for(let G=0;G<50;G++)this.pushTexture(G)};static setGamma=(_,R)=>{let L=(_>>16)/256,G=(_>>8&255)/256,K=(_&255)/256,Q=Math.pow(L,R),H=Math.pow(G,R),$=Math.pow(K,R),J=Q*256|0,O=H*256|0,q=$*256|0;return(J<<16)+(O<<8)+q};static initPool=(_)=>{if(this.texelPool)return;if(this.poolSize=_,this.lowMemory)this.texelPool=new J1(_,16384);else this.texelPool=new J1(_,65536);this.activeTexels.fill(null)};static fillGouraudTriangle=(_,R,L,G,K,Q,H,$,J)=>{let O=0,q=0;if(K!==G)O=(R-_<<16)/(K-G)|0,q=($-H<<15)/(K-G)|0;let b=0,U=0;if(Q!==K)b=(L-R<<16)/(Q-K)|0,U=(J-$<<15)/(Q-K)|0;let N=0,I=0;if(Q!==G)N=(_-L<<16)/(G-Q)|0,I=(H-J<<15)/(G-Q)|0;if(G<=K&&G<=Q){if(G<j.bottom){if(K>j.bottom)K=j.bottom;if(Q>j.bottom)Q=j.bottom;if(K<Q){if(L=_<<=16,J=H<<=15,G<0)L-=N*G,_-=O*G,J-=I*G,H-=q*G,G=0;if(R<<=16,$<<=15,K<0)R-=b*K,$-=U*K,K=0;if(G!==K&&N<O||G===K&&N>b){Q-=K,K-=G,G=h.lineOffset[G];while(!0){if(K--,K<0)while(!0){if(Q--,Q<0)return;this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,j.pixels,G,0),L+=N,R+=b,J+=I,$+=U,G+=j.width2d}this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,j.pixels,G,0),L+=N,_+=O,J+=I,H+=q,G+=j.width2d}}else{Q-=K,K-=G,G=h.lineOffset[G];while(!0){if(K--,K<0)while(!0){if(Q--,Q<0)return;this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,j.pixels,G,0),L+=N,R+=b,J+=I,$+=U,G+=j.width2d}this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,j.pixels,G,0),L+=N,_+=O,J+=I,H+=q,G+=j.width2d}}}else{if(R=_<<=16,$=H<<=15,G<0)R-=N*G,_-=O*G,$-=I*G,H-=q*G,G=0;if(L<<=16,J<<=15,Q<0)L-=b*Q,J-=U*Q,Q=0;if(G!==Q&&N<O||G===Q&&b>O){K-=Q,Q-=G,G=h.lineOffset[G];while(!0){if(Q--,Q<0)while(!0){if(K--,K<0)return;this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,j.pixels,G,0),L+=b,_+=O,J+=U,H+=q,G+=j.width2d}this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,j.pixels,G,0),R+=N,_+=O,$+=I,H+=q,G+=j.width2d}}else{K-=Q,Q-=G,G=h.lineOffset[G];while(!0){if(Q--,Q<0)while(!0){if(K--,K<0)return;this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,j.pixels,G,0),L+=b,_+=O,J+=U,H+=q,G+=j.width2d}this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,j.pixels,G,0),R+=N,_+=O,$+=I,H+=q,G+=j.width2d}}}}}else if(K<=Q){if(K<j.bottom){if(Q>j.bottom)Q=j.bottom;if(G>j.bottom)G=j.bottom;if(Q<G){if(_=R<<=16,H=$<<=15,K<0)_-=O*K,R-=b*K,H-=q*K,$-=U*K,K=0;if(L<<=16,J<<=15,Q<0)L-=N*Q,J-=I*Q,Q=0;if(K!==Q&&O<b||K===Q&&O>N){G-=Q,Q-=K,K=h.lineOffset[K];while(!0){if(Q--,Q<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,j.pixels,K,0),_+=O,L+=N,H+=q,J+=I,K+=j.width2d}this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,j.pixels,K,0),_+=O,R+=b,H+=q,$+=U,K+=j.width2d}}else{G-=Q,Q-=K,K=h.lineOffset[K];while(!0){if(Q--,Q<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,j.pixels,K,0),_+=O,L+=N,H+=q,J+=I,K+=j.width2d}this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,j.pixels,K,0),_+=O,R+=b,H+=q,$+=U,K+=j.width2d}}}else{if(L=R<<=16,J=$<<=15,K<0)L-=O*K,R-=b*K,J-=q*K,$-=U*K,K=0;if(_<<=16,H<<=15,G<0)_-=N*G,H-=I*G,G=0;if(Q-=G,G-=K,K=h.lineOffset[K],O<b)while(!0){if(G--,G<0)while(!0){if(Q--,Q<0)return;this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,j.pixels,K,0),_+=N,R+=b,H+=I,$+=U,K+=j.width2d}this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,j.pixels,K,0),L+=O,R+=b,J+=q,$+=U,K+=j.width2d}else while(!0){if(G--,G<0)while(!0){if(Q--,Q<0)return;this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,j.pixels,K,0),_+=N,R+=b,H+=I,$+=U,K+=j.width2d}this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,j.pixels,K,0),L+=O,R+=b,J+=q,$+=U,K+=j.width2d}}}}else if(Q<j.bottom){if(G>j.bottom)G=j.bottom;if(K>j.bottom)K=j.bottom;if(G<K){if(R=L<<=16,$=J<<=15,Q<0)R-=b*Q,L-=N*Q,$-=U*Q,J-=I*Q,Q=0;if(_<<=16,H<<=15,G<0)_-=O*G,H-=q*G,G=0;if(K-=G,G-=Q,Q=h.lineOffset[Q],b<N)while(!0){if(G--,G<0)while(!0){if(K--,K<0)return;this.drawGouraudScanline(R>>16,_>>16,$>>7,H>>7,j.pixels,Q,0),R+=b,_+=O,$+=U,H+=q,Q+=j.width2d}this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,j.pixels,Q,0),R+=b,L+=N,$+=U,J+=I,Q+=j.width2d}else while(!0){if(G--,G<0)while(!0){if(K--,K<0)return;this.drawGouraudScanline(_>>16,R>>16,H>>7,$>>7,j.pixels,Q,0),R+=b,_+=O,$+=U,H+=q,Q+=j.width2d}this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,j.pixels,Q,0),R+=b,L+=N,$+=U,J+=I,Q+=j.width2d}}else{if(_=L<<=16,H=J<<=15,Q<0)_-=b*Q,L-=N*Q,H-=U*Q,J-=I*Q,Q=0;if(R<<=16,$<<=15,K<0)R-=O*K,$-=q*K,K=0;if(G-=K,K-=Q,Q=h.lineOffset[Q],b<N)while(!0){if(K--,K<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(R>>16,L>>16,$>>7,J>>7,j.pixels,Q,0),R+=O,L+=N,$+=q,J+=I,Q+=j.width2d}this.drawGouraudScanline(_>>16,L>>16,H>>7,J>>7,j.pixels,Q,0),_+=b,L+=N,H+=U,J+=I,Q+=j.width2d}else while(!0){if(K--,K<0)while(!0){if(G--,G<0)return;this.drawGouraudScanline(L>>16,R>>16,J>>7,$>>7,j.pixels,Q,0),R+=O,L+=N,$+=q,J+=I,Q+=j.width2d}this.drawGouraudScanline(L>>16,_>>16,J>>7,H>>7,j.pixels,Q,0),_+=b,L+=N,H+=U,J+=I,Q+=j.width2d}}}};static drawGouraudScanline=(_,R,L,G,K,Q,H)=>{let $;if(h.jagged){let J;if(h.clipX){if(R-_>3)J=(G-L)/(R-_)|0;else J=0;if(R>j.boundX)R=j.boundX;if(_<0)L-=_*J,_=0;if(_>=R)return;Q+=_,H=R-_>>2,J<<=2}else if(_<R)if(Q+=_,H=R-_>>2,H>0)J=(G-L)*h.reciprocal15[H]>>15;else J=0;else return;if(h.alpha===0)while(!0){if(H--,H<0){if(H=R-_&3,H>0){$=h.palette[L>>8];do K[Q++]=$,H--;while(H>0);return}break}$=h.palette[L>>8],L+=J,K[Q++]=$,K[Q++]=$,K[Q++]=$,K[Q++]=$}else{let O=h.alpha,q=256-h.alpha;while(!0){if(H--,H<0){if(H=R-_&3,H>0){$=h.palette[L>>8],$=(($&16711935)*q>>8&16711935)+(($&65280)*q>>8&65280);do K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280),H--;while(H>0)}break}$=h.palette[L>>8],L+=J,$=(($&16711935)*q>>8&16711935)+(($&65280)*q>>8&65280),K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280),K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280),K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280),K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280)}}}else if(_<R){let J=(G-L)/(R-_)|0;if(h.clipX){if(R>j.boundX)R=j.boundX;if(_<0)L-=_*J,_=0;if(_>=R)return}if(Q+=_,H=R-_,h.alpha===0)do K[Q++]=h.palette[L>>8],L+=J,H--;while(H>0);else{let O=h.alpha,q=256-h.alpha;do $=h.palette[L>>8],L+=J,$=(($&16711935)*q>>8&16711935)+(($&65280)*q>>8&65280),K[Q++]=$+((K[Q]&16711935)*O>>8&16711935)+((K[Q]&65280)*O>>8&65280),H--;while(H>0)}}};static fillTriangle=(_,R,L,G,K,Q,H)=>{let $=0;if(K!==G)$=(R-_<<16)/(K-G)|0;let J=0;if(Q!==K)J=(L-R<<16)/(Q-K)|0;let O=0;if(Q!==G)O=(_-L<<16)/(G-Q)|0;if(G<=K&&G<=Q){if(G<j.bottom){if(K>j.bottom)K=j.bottom;if(Q>j.bottom)Q=j.bottom;if(K<Q){if(L=_<<=16,G<0)L-=O*G,_-=$*G,G=0;if(R<<=16,K<0)R-=J*K,K=0;if(G!==K&&O<$||G===K&&O>J){Q-=K,K-=G,G=this.lineOffset[G];while(!0){if(K--,K<0)while(!0){if(Q--,Q<0)return;this.drawScanline(L>>16,R>>16,j.pixels,G,H),L+=O,R+=J,G+=j.width2d}this.drawScanline(L>>16,_>>16,j.pixels,G,H),L+=O,_+=$,G+=j.width2d}}else{Q-=K,K-=G,G=this.lineOffset[G];while(!0){if(K--,K<0)while(!0){if(Q--,Q<0)return;this.drawScanline(R>>16,L>>16,j.pixels,G,H),L+=O,R+=J,G+=j.width2d}this.drawScanline(_>>16,L>>16,j.pixels,G,H),L+=O,_+=$,G+=j.width2d}}}else{if(R=_<<=16,G<0)R-=O*G,_-=$*G,G=0;if(L<<=16,Q<0)L-=J*Q,Q=0;if(G!==Q&&O<$||G===Q&&J>$){K-=Q,Q-=G,G=this.lineOffset[G];while(!0){if(Q--,Q<0)while(!0){if(K--,K<0)return;this.drawScanline(L>>16,_>>16,j.pixels,G,H),L+=J,_+=$,G+=j.width2d}this.drawScanline(R>>16,_>>16,j.pixels,G,H),R+=O,_+=$,G+=j.width2d}}else{K-=Q,Q-=G,G=this.lineOffset[G];while(!0){if(Q--,Q<0)while(!0){if(K--,K<0)return;this.drawScanline(_>>16,L>>16,j.pixels,G,H),L+=J,_+=$,G+=j.width2d}this.drawScanline(_>>16,R>>16,j.pixels,G,H),R+=O,_+=$,G+=j.width2d}}}}}else if(K<=Q){if(K<j.bottom){if(Q>j.bottom)Q=j.bottom;if(G>j.bottom)G=j.bottom;if(Q<G){if(_=R<<=16,K<0)_-=$*K,R-=J*K,K=0;if(L<<=16,Q<0)L-=O*Q,Q=0;if(K!==Q&&$<J||K===Q&&$>O){G-=Q,Q-=K,K=this.lineOffset[K];while(!0){if(Q--,Q<0)while(!0){if(G--,G<0)return;this.drawScanline(_>>16,L>>16,j.pixels,K,H),_+=$,L+=O,K+=j.width2d}this.drawScanline(_>>16,R>>16,j.pixels,K,H),_+=$,R+=J,K+=j.width2d}}else{G-=Q,Q-=K,K=this.lineOffset[K];while(!0){if(Q--,Q<0)while(!0){if(G--,G<0)return;this.drawScanline(L>>16,_>>16,j.pixels,K,H),_+=$,L+=O,K+=j.width2d}this.drawScanline(R>>16,_>>16,j.pixels,K,H),_+=$,R+=J,K+=j.width2d}}}else{if(L=R<<=16,K<0)L-=$*K,R-=J*K,K=0;if(_<<=16,G<0)_-=O*G,G=0;if($<J){Q-=G,G-=K,K=this.lineOffset[K];while(!0){if(G--,G<0)while(!0){if(Q--,Q<0)return;this.drawScanline(_>>16,R>>16,j.pixels,K,H),_+=O,R+=J,K+=j.width2d}this.drawScanline(L>>16,R>>16,j.pixels,K,H),L+=$,R+=J,K+=j.width2d}}else{Q-=G,G-=K,K=this.lineOffset[K];while(!0){if(G--,G<0)while(!0){if(Q--,Q<0)return;this.drawScanline(R>>16,_>>16,j.pixels,K,H),_+=O,R+=J,K+=j.width2d}this.drawScanline(R>>16,L>>16,j.pixels,K,H),L+=$,R+=J,K+=j.width2d}}}}}else if(Q<j.bottom){if(G>j.bottom)G=j.bottom;if(K>j.bottom)K=j.bottom;if(G<K){if(R=L<<=16,Q<0)R-=J*Q,L-=O*Q,Q=0;if(_<<=16,G<0)_-=$*G,G=0;if(J<O){K-=G,G-=Q,Q=this.lineOffset[Q];while(!0){if(G--,G<0)while(!0){if(K--,K<0)return;this.drawScanline(R>>16,_>>16,j.pixels,Q,H),R+=J,_+=$,Q+=j.width2d}this.drawScanline(R>>16,L>>16,j.pixels,Q,H),R+=J,L+=O,Q+=j.width2d}}else{K-=G,G-=Q,Q=this.lineOffset[Q];while(!0){if(G--,G<0)while(!0){if(K--,K<0)return;this.drawScanline(_>>16,R>>16,j.pixels,Q,H),R+=J,_+=$,Q+=j.width2d}this.drawScanline(L>>16,R>>16,j.pixels,Q,H),R+=J,L+=O,Q+=j.width2d}}}else{if(_=L<<=16,Q<0)_-=J*Q,L-=O*Q,Q=0;if(R<<=16,K<0)R-=$*K,K=0;if(J<O){G-=K,K-=Q,Q=this.lineOffset[Q];while(!0){if(K--,K<0)while(!0){if(G--,G<0)return;this.drawScanline(R>>16,L>>16,j.pixels,Q,H),R+=$,L+=O,Q+=j.width2d}this.drawScanline(_>>16,L>>16,j.pixels,Q,H),_+=J,L+=O,Q+=j.width2d}}else{G-=K,K-=Q,Q=this.lineOffset[Q];while(!0){if(K--,K<0)while(!0){if(G--,G<0)return;this.drawScanline(L>>16,R>>16,j.pixels,Q,H),R+=$,L+=O,Q+=j.width2d}this.drawScanline(L>>16,_>>16,j.pixels,Q,H),_+=J,L+=O,Q+=j.width2d}}}}};static fillTexturedTriangle=(_,R,L,G,K,Q,H,$,J,O,q,b,U,N,I,k,F,T,Y)=>{let u=this.getTexels(Y);this.opaque=!this.textureTranslucent[Y];let w=O-U,B=q-I,v=b-F,n=N-O,W=k-q,P=T-b,z=n*q-W*O<<14,f=W*b-P*q<<8,m=P*O-n*b<<5,M=w*q-B*O<<14,r=B*b-v*q<<8,a=v*O-w*b<<5,C=B*n-w*W<<14,L0=v*W-B*P<<8,e=w*P-v*n<<5,G0=0,J0=0;if(K!==G)G0=(R-_<<16)/(K-G)|0,J0=($-H<<16)/(K-G)|0;let Q0=0,i=0;if(Q!==K)Q0=(L-R<<16)/(Q-K)|0,i=(J-$<<16)/(Q-K)|0;let j0=0,$0=0;if(Q!==G)j0=(_-L<<16)/(G-Q)|0,$0=(H-J<<16)/(G-Q)|0;if(G<=K&&G<=Q){if(G<j.bottom){if(K>j.bottom)K=j.bottom;if(Q>j.bottom)Q=j.bottom;if(K<Q){if(L=_<<=16,J=H<<=16,G<0)L-=j0*G,_-=G0*G,J-=$0*G,H-=J0*G,G=0;if(R<<=16,$<<=16,K<0)R-=Q0*K,$-=i*K,K=0;let F0=G-this.centerY;if(z+=m*F0,M+=a*F0,C+=e*F0,z|=0,M|=0,C|=0,G!==K&&j0<G0||G===K&&j0>Q0){Q-=K,K-=G,G=this.lineOffset[G];while(!0){if(K--,K<0)while(!0){if(Q--,Q<0)return;this.drawTexturedScanline(L>>16,R>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,J>>8,$>>8),L+=j0,R+=Q0,J+=$0,$+=i,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(L>>16,_>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,J>>8,H>>8),L+=j0,_+=G0,J+=$0,H+=J0,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}else{Q-=K,K-=G,G=this.lineOffset[G];while(!0){if(K--,K<0)while(!0){if(Q--,Q<0)return;this.drawTexturedScanline(R>>16,L>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,$>>8,J>>8),L+=j0,R+=Q0,J+=$0,$+=i,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(_>>16,L>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,H>>8,J>>8),L+=j0,_+=G0,J+=$0,H+=J0,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}}else{if(R=_<<=16,$=H<<=16,G<0)R-=j0*G,_-=G0*G,$-=$0*G,H-=J0*G,G=0;if(L<<=16,J<<=16,Q<0)L-=Q0*Q,J-=i*Q,Q=0;let F0=G-this.centerY;if(z+=m*F0,M+=a*F0,C+=e*F0,z|=0,M|=0,C|=0,(G===Q||j0>=G0)&&(G!==Q||Q0<=G0)){K-=Q,Q-=G,G=this.lineOffset[G];while(!0){if(Q--,Q<0)while(!0){if(K--,K<0)return;this.drawTexturedScanline(_>>16,L>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,H>>8,J>>8),L+=Q0,_+=G0,J+=i,H+=J0,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(_>>16,R>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,H>>8,$>>8),R+=j0,_+=G0,$+=$0,H+=J0,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}else{K-=Q,Q-=G,G=this.lineOffset[G];while(!0){if(Q--,Q<0)while(!0){if(K--,K<0)return;this.drawTexturedScanline(L>>16,_>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,J>>8,H>>8),L+=Q0,_+=G0,J+=i,H+=J0,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(R>>16,_>>16,j.pixels,G,u,0,0,z,M,C,f,r,L0,$>>8,H>>8),R+=j0,_+=G0,$+=$0,H+=J0,G+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}}}}else if(K<=Q){if(K<j.bottom){if(Q>j.bottom)Q=j.bottom;if(G>j.bottom)G=j.bottom;if(Q<G){if(_=R<<=16,H=$<<=16,K<0)_-=G0*K,R-=Q0*K,H-=J0*K,$-=i*K,K=0;if(L<<=16,J<<=16,Q<0)L-=j0*Q,J-=$0*Q,Q=0;let F0=K-this.centerY;if(z+=m*F0,M+=a*F0,C+=e*F0,z|=0,M|=0,C|=0,K!==Q&&G0<Q0||K===Q&&G0>j0){G-=Q,Q-=K,K=this.lineOffset[K];while(!0){if(Q--,Q<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(_>>16,L>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,H>>8,J>>8),_+=G0,L+=j0,H+=J0,J+=$0,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(_>>16,R>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,H>>8,$>>8),_+=G0,R+=Q0,H+=J0,$+=i,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}else{G-=Q,Q-=K,K=this.lineOffset[K];while(!0){if(Q--,Q<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(L>>16,_>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,J>>8,H>>8),_+=G0,L+=j0,H+=J0,J+=$0,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(R>>16,_>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,$>>8,H>>8),_+=G0,R+=Q0,H+=J0,$+=i,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}}else{if(L=R<<=16,J=$<<=16,K<0)L-=G0*K,R-=Q0*K,J-=J0*K,$-=i*K,K=0;if(_<<=16,H<<=16,G<0)_-=j0*G,H-=$0*G,G=0;let F0=K-this.centerY;if(z+=m*F0,M+=a*F0,C+=e*F0,z|=0,M|=0,C|=0,Q-=G,G-=K,K=this.lineOffset[K],G0<Q0)while(!0){if(G--,G<0)while(!0){if(Q--,Q<0)return;this.drawTexturedScanline(_>>16,R>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,H>>8,$>>8),_+=j0,R+=Q0,H+=$0,$+=i,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(L>>16,R>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,J>>8,$>>8),L+=G0,R+=Q0,J+=J0,$+=i,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}else while(!0){if(G--,G<0)while(!0){if(Q--,Q<0)return;this.drawTexturedScanline(R>>16,_>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,$>>8,H>>8),_+=j0,R+=Q0,H+=$0,$+=i,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(R>>16,L>>16,j.pixels,K,u,0,0,z,M,C,f,r,L0,$>>8,J>>8),L+=G0,R+=Q0,J+=J0,$+=i,K+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}}}else if(Q<j.bottom){if(G>j.bottom)G=j.bottom;if(K>j.bottom)K=j.bottom;if(G<K){if(R=L<<=16,$=J<<=16,Q<0)R-=Q0*Q,L-=j0*Q,$-=i*Q,J-=$0*Q,Q=0;if(_<<=16,H<<=16,G<0)_-=G0*G,H-=J0*G,G=0;let F0=Q-this.centerY;if(z+=m*F0,M+=a*F0,C+=e*F0,z|=0,M|=0,C|=0,K-=G,G-=Q,Q=this.lineOffset[Q],Q0<j0)while(!0){if(G--,G<0)while(!0){if(K--,K<0)return;this.drawTexturedScanline(R>>16,_>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,$>>8,H>>8),R+=Q0,_+=G0,$+=i,H+=J0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(R>>16,L>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,$>>8,J>>8),R+=Q0,L+=j0,$+=i,J+=$0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}else while(!0){if(G--,G<0)while(!0){if(K--,K<0)return;this.drawTexturedScanline(_>>16,R>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,H>>8,$>>8),R+=Q0,_+=G0,$+=i,H+=J0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(L>>16,R>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,J>>8,$>>8),R+=Q0,L+=j0,$+=i,J+=$0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}else{if(_=L<<=16,H=J<<=16,Q<0)_-=Q0*Q,L-=j0*Q,H-=i*Q,J-=$0*Q,Q=0;if(R<<=16,$<<=16,K<0)R-=G0*K,$-=J0*K,K=0;let F0=Q-this.centerY;if(z+=m*F0,M+=a*F0,C+=e*F0,z|=0,M|=0,C|=0,G-=K,K-=Q,Q=this.lineOffset[Q],Q0<j0)while(!0){if(K--,K<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(R>>16,L>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,$>>8,J>>8),R+=G0,L+=j0,$+=J0,J+=$0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(_>>16,L>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,H>>8,J>>8),_+=Q0,L+=j0,H+=i,J+=$0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}else while(!0){if(K--,K<0)while(!0){if(G--,G<0)return;this.drawTexturedScanline(L>>16,R>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,J>>8,$>>8),R+=G0,L+=j0,$+=J0,J+=$0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}this.drawTexturedScanline(L>>16,_>>16,j.pixels,Q,u,0,0,z,M,C,f,r,L0,J>>8,H>>8),_+=Q0,L+=j0,H+=i,J+=$0,Q+=j.width2d,z+=m,M+=a,C+=e,z|=0,M|=0,C|=0}}}};static drawTexturedScanline=(_,R,L,G,K,Q,H,$,J,O,q,b,U,N,I)=>{if(_>=R)return;let k,F;if(this.clipX){if(k=(I-N)/(R-_)|0,R>j.boundX)R=j.boundX;if(_<0)N-=_*k,_=0;if(_>=R)return;F=R-_>>3,k<<=12}else if(R-_>7)F=R-_>>3,k=(I-N)*this.reciprocal15[F]>>6;else F=0,k=0;N<<=9,G+=_;let T,Y,u,w,B,v,n;if(this.lowMemory&&K){if(T=0,Y=0,w=_-this.centerX,$=$+(q>>3)*w,J=J+(b>>3)*w,O=O+(U>>3)*w,$|=0,J|=0,O|=0,u=O>>12,u!==0){if(Q=$/u|0,H=J/u|0,Q<0)Q=0;else if(Q>4032)Q=4032}if($=$+q,J=J+b,O=O+U,$|=0,J|=0,O|=0,u=O>>12,u!==0){if(T=$/u|0,Y=J/u|0,T<7)T=7;else if(T>4032)T=4032}if(B=T-Q>>3,v=Y-H>>3,Q+=N>>3&786432,n=N>>23,this.opaque){while(F-- >0){if(L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v,L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q=T,H=Y,$+=q,J+=b,O+=U,u=O>>12,u!==0){if(T=$/u|0,Y=J/u|0,T<7)T=7;else if(T>4032)T=4032}B=T-Q>>3,v=Y-H>>3,N+=k,Q+=N>>3&786432,n=N>>23}F=R-_&7;while(F-- >0)L[G++]=K[(H&4032)+(Q>>6)]>>>n,Q+=B,H+=v}else{while(F-- >0){let W;if((W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G=G+1,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;if(G=G+1,Q=T,H=Y,$+=q,J+=b,O+=U,$|=0,J|=0,O|=0,u=O>>12,u!==0){if(T=$/u|0,Y=J/u|0,T<7)T=7;else if(T>4032)T=4032}B=T-Q>>3,v=Y-H>>3,N+=k,Q+=N>>3&786432,n=N>>23}F=R-_&7;while(F-- >0){let W;if((W=K[(H&4032)+(Q>>6)]>>>n)!==0)L[G]=W;G++,Q+=B,H+=v}}return}if(T=0,Y=0,w=_-this.centerX,$=$+(q>>3)*w,J=J+(b>>3)*w,O=O+(U>>3)*w,$|=0,J|=0,O|=0,u=O>>14,u!==0){if(Q=$/u|0,H=J/u|0,Q<0)Q=0;else if(Q>16256)Q=16256}if($=$+q,J=J+b,O=O+U,$|=0,J|=0,O|=0,u=O>>14,u!==0){if(T=$/u|0,Y=J/u|0,T<7)T=7;else if(T>16256)T=16256}if(B=T-Q>>3,v=Y-H>>3,Q+=N&6291456,n=N>>23,this.opaque&&K){while(F-- >0){if(L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v,L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q=T,H=Y,$+=q,J+=b,O+=U,$|=0,J|=0,O|=0,u=O>>14,u!==0){if(T=$/u|0,Y=J/u|0,T<7)T=7;else if(T>16256)T=16256}B=T-Q>>3,v=Y-H>>3,N+=k,Q+=N&6291456,n=N>>23}F=R-_&7;while(F-- >0)L[G++]=K[(H&16256)+(Q>>7)]>>>n,Q+=B,H+=v;return}while(F-- >0&&K){let W;if((W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G=G+1,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q+=B,H+=v,(W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;if(G++,Q=T,H=Y,$+=q,J+=b,O+=U,$|=0,J|=0,O|=0,u=O>>14,u!==0){if(T=$/u|0,Y=J/u|0,T<7)T=7;else if(T>16256)T=16256}B=T-Q>>3,v=Y-H>>3,N+=k,Q+=N&6291456,n=N>>23}F=R-_&7;while(F-- >0&&K){let W;if((W=K[(H&16256)+(Q>>7)]>>>n)!==0)L[G]=W;G++,Q+=B,H+=v}};static drawScanline=(_,R,L,G,K)=>{if(this.clipX){if(R>j.boundX)R=j.boundX;if(_<0)_=0}if(_>=R)return;G+=_;let Q=R-_>>2;if(this.alpha===0)while(!0){if(Q--,Q<0){Q=R-_&3;while(!0){if(Q--,Q<0)return;L[G++]=K}}L[G++]=K,L[G++]=K,L[G++]=K,L[G++]=K}let H=this.alpha,$=256-this.alpha;K=((K&16711935)*$>>8&16711935)+((K&65280)*$>>8&65280);while(!0){if(Q--,Q<0){Q=R-_&3;while(!0){if(Q--,Q<0)return;L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280)}}L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280),L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280),L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280),L[G++]=K+((L[G]&16711935)*H>>8&16711935)+((L[G]&65280)*H>>8&65280)}};static pushTexture=(_)=>{if(this.activeTexels[_]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[_],this.activeTexels[_]=null};static getTexels=(_)=>{if(this.textureCycle[_]=this.cycle++,this.activeTexels[_])return this.activeTexels[_];let R;if(this.poolSize>0&&this.texelPool)R=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let K=0,Q=-1;for(let H=0;H<this.textureCount;H++)if(this.activeTexels[H]&&(this.textureCycle[H]<K||Q===-1))K=this.textureCycle[H],Q=H;R=this.activeTexels[Q],this.activeTexels[Q]=null}this.activeTexels[_]=R;let L=this.textures[_],G=this.texturePalette[_];if(!R||!L||!G)return null;if(this.lowMemory){this.textureTranslucent[_]=!1;for(let K=0;K<4096;K++){let Q=R[K]=G[L.pixels[K]]&16316671;if(Q===0)this.textureTranslucent[_]=!0;R[K+4096]=Q-(Q>>>3)&16316671,R[K+8192]=Q-(Q>>>2)&16316671,R[K+12288]=Q-(Q>>>2)-(Q>>>3)&16316671}}else{if(L.width===64)for(let K=0;K<128;K++)for(let Q=0;Q<128;Q++)R[Q+(K<<7|0)]=G[L.pixels[(Q>>1)+(K>>1<<6|0)]];else for(let K=0;K<16384;K++)R[K]=G[L.pixels[K]];this.textureTranslucent[_]=!1;for(let K=0;K<16384;K++){R[K]&=16316671;let Q=R[K];if(Q===0)this.textureTranslucent[_]=!0;R[K+16384]=Q-(Q>>>3)&16316671,R[K+32768]=Q-(Q>>>2)&16316671,R[K+49152]=Q-(Q>>>2)-(Q>>>3)&16316671}}return R}}class w0{image;width;height;ctx;paint;pixels;constructor(_,R,L=q0){this.ctx=L,this.image=this.ctx.getImageData(0,0,_,R),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(_*R),this.width=_,this.height=R,this.bind()}clear(){this.pixels.fill(0)}bind(){j.bind(this.pixels,this.width,this.height)}draw(_,R){this.#_(),this.ctx.putImageData(this.image,_,R)}#_(){let _=this.pixels.length,R=this.pixels,L=this.paint;for(let G=0;G<_;G++){let K=R[G];L[G]=K>>16&255|(K>>8&255)<<8|(K&255)<<16|4278190080}}}class V8{slowestMS=0;averageMS=[];averageIndexMS=0;drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=!0;resizeToFit=!1;tfps=50;hasFocus=!0;ingame=!1;idleCycles=Date.now();mouseButton=0;mouseX=0;mouseY=0;mouseClickButton=0;mouseClickX=0;mouseClickY=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;input=null;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;constructor(_=!1){if(u0.tabIndex=-1,q0.fillStyle="black",q0.fillRect(0,0,u0.width,u0.height),this.resizeToFit=_,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(u0.width,u0.height)}get width(){return u0.width}get height(){return u0.height}resize=(_,R)=>{u0.width=_,u0.height=R,this.drawArea=new w0(_,R),h.init2D()};async run(){if(u0.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),u0.onmousedown=this.onmousedown,u0.onmouseup=this.onmouseup,u0.onmouseenter=this.onmouseenter,u0.onmouseleave=this.onmouseleave,u0.onmousemove=this.onmousemove,u0.onfocus=this.onfocus,u0.onblur=this.onblur,this.isMobile)u0.ontouchstart=this.ontouchstart,u0.ontouchend=this.ontouchend,u0.ontouchmove=this.ontouchmove;else u0.onkeydown=this.onkeydown,u0.onkeyup=this.onkeyup;u0.oncontextmenu=(Q)=>{Q.preventDefault()},window.oncontextmenu=(Q)=>{Q.preventDefault()},await this.showProgress(0,"Loading..."),await this.load();for(let Q=0;Q<10;Q++)this.otim[Q]=performance.now();let _,R=0,L=256,G=1,K=0;while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let Q=L,H=G;L=300,G=1,_=performance.now();let $=this.otim[R];if($===0)L=Q,G=H;else if(_>$)L=this.deltime*2560/(_-$)|0;if(L<25)L=25;else if(L>256)L=256,G=this.deltime-(_-$)/10|0;if(this.otim[R]=_,R=(R+1)%10,G>1){for(let O=0;O<10;O++)if(this.otim[O]!==0)this.otim[O]+=G}if(G<this.mindel)G=this.mindel;await q1(G);while(K<256)await this.update(),this.mouseClickButton=0,this.keyQueueReadPos=this.keyQueueWritePos,K+=L;if(K&=255,this.deltime>0)this.fps=L*1000/(this.deltime*256)|0;let J=performance.now();if(this.redrawScreen)this.refresh();if(await this.draw(),this.frameTime[this.fpos]=(performance.now()-J)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let O=1000/this.tfps-(performance.now()-_);if(O>0)await q1(O)}}if(this.state===-1)this.shutdown()}shutdown=()=>{this.state=-2};setFramerate=(_)=>{this.deltime=1000/_|0};setTargetedFramerate=(_)=>{this.tfps=Math.max(Math.min(50,_|0),0)};start=()=>{if(this.state>=0)this.state=0};stop=()=>{if(this.state>=0)this.state=4000/this.deltime|0};destroy=()=>{this.state=-1};async load(){}async update(){}async draw(){}async refresh(){}async showProgress(_,R){let L=this.width,G=this.height;if(this.redrawScreen)q0.fillStyle="black",q0.fillRect(0,0,L,G),this.redrawScreen=!1;let K=G/2-18;q0.fillStyle="rgb(140, 17, 17)",q0.rect((L/2|0)-152,K,304,34),q0.fillRect((L/2|0)-150,K+2,_*3,30),q0.fillStyle="black",q0.fillRect((L/2|0)-150+_*3,K+2,300-_*3,30),q0.font="bold 13px helvetica, sans-serif",q0.textAlign="center",q0.fillStyle="white",q0.fillText(R,L/2|0,K+22),await q1(5)}pollKey=()=>{let _=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)_=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return _};get ms(){let _=this.frameTime.length,R=0;for(let G=0;G<_;G++)R+=this.frameTime[G];let L=R/_*1000;if(L>this.slowestMS)this.slowestMS=L;return this.averageMS[this.averageIndexMS]=L,this.averageIndexMS=(this.averageIndexMS+1)%250,L}get msAvg(){return this.averageMS.reduce((_,R)=>_+R,0)/250}onkeydown=(_)=>{let R=_.key;this.idleCycles=Date.now();let L=E0[R];if(!L||_.code.length===0&&!_.isTrusted)return;let{code:G,ch:K}=L;if(_.ctrlKey){if(K>=65&&K<=93||K==95)K-=64;else if(K>=97&&K<=122)K-=96}if(K<30)K=0;if(G===E0.ArrowLeft.code)K=1;else if(G===E0.ArrowRight.code)K=2;else if(G===E0.ArrowUp.code)K=3;else if(G===E0.ArrowDown.code)K=4;else if(G===E0.Control.code)K=5;else if(G===E0.Shift.code)K=6;else if(G===E0.Alt.code)K=7;else if(G===E0.Backspace.code)K=8;else if(G===E0.Delete.code)K=8;else if(G===E0.Tab.code)K=9;else if(G===E0.Enter.code)K=10;else if(G>=E0.F1.code&&G<=E0.F12.code)K=G+1008-E0.F1.code;else if(G===E0.Home.code)K=1000;else if(G===E0.End.code)K=1001;else if(G===E0.PageUp.code)K=1002;else if(G===E0.PageDown.code)K=1003;if(K>0&&K<128)this.actionKey[K]=1;if(K>4)this.keyQueue[this.keyQueueWritePos]=K,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if(S0.enabled)S0.keyPressed(K);if(!P5.includes(R))_.preventDefault()};onkeyup=(_)=>{let R=_.key;this.idleCycles=Date.now();let L=E0[R];if(!L||_.code.length===0&&!_.isTrusted)return;let{code:G,ch:K}=L;if(K<30)K=0;if(G===E0.ArrowLeft.code)K=1;else if(G===E0.ArrowRight.code)K=2;else if(G===E0.ArrowUp.code)K=3;else if(G===E0.ArrowDown.code)K=4;else if(G===E0.Control.code)K=5;else if(G===E0.Shift.code)K=6;else if(G===E0.Alt.code)K=7;else if(G===E0.Backspace.code)K=8;else if(G===E0.Delete.code)K=8;else if(G===E0.Tab.code)K=9;else if(G===E0.Enter.code)K=10;else if(G>=E0.F1.code&&G<=E0.F12.code)K=G+1008-E0.F1.code;else if(G===E0.Home.code)K=1000;else if(G===E0.End.code)K=1001;else if(G===E0.PageUp.code)K=1002;else if(G===E0.PageDown.code)K=1003;if(K>0&&K<128)this.actionKey[K]=0;if(S0.enabled)S0.keyReleased(K);if(!P5.includes(R))_.preventDefault()};onmousedown=(_)=>{if(this.touching=!1,_.clientX>0||_.clientY>0)this.setMousePosition(_);if(this.idleCycles=Date.now(),this.mouseClickX=this.mouseX,this.mouseClickY=this.mouseY,this.isMobile&&!this.isCapacitor){if(this.insideChatInputArea()||this.insideUsernameArea()||this.inPasswordArea()){this.mouseClickButton=1,this.mouseButton=1;return}if(_.timeStamp>=this.time+500)this.mouseClickButton=2,this.mouseButton=2;else this.mouseClickButton=1,this.mouseButton=1}else if(_.button===2)this.mouseClickButton=2,this.mouseButton=2;else this.mouseClickButton=1,this.mouseButton=1;if(S0.enabled)S0.mousePressed(this.mouseClickX,this.mouseClickY,_.buttons)};onmouseup=(_)=>{if(this.setMousePosition(_),this.idleCycles=Date.now(),this.mouseButton=0,S0.enabled)S0.mouseReleased(_.buttons)};onmouseenter=(_)=>{if(this.setMousePosition(_),S0.enabled)S0.mouseEntered()};onmouseleave=(_)=>{if(this.setMousePosition(_),this.idleCycles=Date.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,S0.enabled)S0.mouseExited()};onmousemove=(_)=>{if(this.setMousePosition(_),this.idleCycles=Date.now(),S0.enabled)S0.mouseMoved(this.mouseX,this.mouseY)};onfocus=(_)=>{if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),S0.enabled)S0.focusGained()};onblur=(_)=>{this.hasFocus=!1;for(let R=0;R<128;R++)this.actionKey[R]=0;if(S0.enabled)S0.focusLost()};ontouchstart=(_)=>{if(!this.isMobile)return;if(this.input!==null)this.input.parentNode?.removeChild(this.input),this.input=null;this.touching=!0;let R=_.changedTouches[0],L=R.clientX|0,G=R.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:L,clientY:G})),this.sx=this.nx=this.mx=R.screenX|0,this.sy=this.ny=this.my=R.screenY|0,this.time=_.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()};ontouchend=(_)=>{if(!this.isMobile||!this.touching)return;let R=_.changedTouches[0],L=R.clientX|0,G=R.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:L,clientY:G})),this.nx=R.screenX|0,this.ny=R.screenY|0,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea()){this.touching=!1;return}else if(this.startedInTabArea&&!this.insideTabArea()){this.touching=!1;return}else if(this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()){if(this.input!==null){if(this.input.parentNode?.contains(this.input))this.input.parentNode?.removeChild(this.input);this.input=null}let $=document.createElement("input");if(this.insideUsernameArea())$.setAttribute("id","username"),$.setAttribute("placeholder","Username");else if(this.inPasswordArea())$.setAttribute("id","password"),$.setAttribute("placeholder","Password");else if(this.insideChatInputArea())$.setAttribute("id","chatinput"),$.setAttribute("placeholder","Chatinput");else if(this.insideChatPopupArea())$.setAttribute("id","chatpopup"),$.setAttribute("placeholder","Chatpopup");if(this.isAndroid)$.setAttribute("type","password");else $.setAttribute("type",this.inPasswordArea()?"password":"text");if($.setAttribute("autofocus","autofocus"),$.setAttribute("spellcheck","false"),$.setAttribute("autocomplete","off"),$.setAttribute("style",`position: fixed; left: ${L}px; top: ${G}px; width: 1px; height: 1px; opacity: 0;`),document.body.appendChild($),$.focus(),$.click(),this.isAndroid)$.oninput=(J)=>{if(!(J instanceof InputEvent))return;let O=J,q=O.data;if(q===null)return;if(O.inputType!=="insertText")return;this.onkeydown(new KeyboardEvent("keydown",{key:q,code:q}))};$.onkeydown=(J)=>{if(this.isAndroid){if(J.key==="Enter"||J.key==="Backspace")this.onkeydown(new KeyboardEvent("keydown",{key:J.key,code:J.key}));return}this.onkeydown(new KeyboardEvent("keydown",{key:J.key,code:J.key}))},$.onkeyup=(J)=>{if(this.isAndroid){if(J.key==="Enter"||J.key==="Backspace")this.onkeyup(new KeyboardEvent("keyup",{key:J.key,code:J.key}));return}this.onkeyup(new KeyboardEvent("keyup",{key:J.key,code:J.key}))},$.onfocus=(J)=>{this.input?.parentNode?.removeChild(this.input),this.input=null,this.onfocus(J)},this.input=$,this.touching=!1;return}let Q=_.timeStamp>=this.time+500,H=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(Q&&!H)this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{buttons:2}));else this.mouseButton=0,this.touching=!1};ontouchmove=(_)=>{if(!this.isMobile||!this.touching)return;let R=_.changedTouches[0],L=R.clientX|0,G=R.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:L,clientY:G})),this.nx=R.screenX|0,this.ny=R.screenY|0,this.startedInViewport&&this.getViewportInterfaceId()===-1){if(this.mx-this.nx>0)this.rotate(2);else if(this.mx-this.nx<0)this.rotate(0);if(this.my-this.ny>0)this.rotate(3);else if(this.my-this.ny<0)this.rotate(1)}else if(this.startedInTabArea||this.getViewportInterfaceId()!==-1)this.onmousedown(new MouseEvent("mousedown",{buttons:1}));this.mx=this.nx,this.my=this.ny};get isMobile(){return["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some((R)=>navigator.userAgent.includes(R))}get isAndroid(){return["Android"].some((R)=>navigator.userAgent.includes(R))}get isCapacitor(){return["Capacitor"].some((R)=>navigator.userAgent.includes(R))}insideViewportArea=()=>{return this.ingame&&this.mouseX>=8&&this.mouseX<=520&&this.mouseY>=11&&this.mouseY<=345};insideChatInputArea=()=>{return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=449&&this.mouseY<=482};insideChatPopupArea=()=>{return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=383&&this.mouseY<=482};insideTabArea=()=>{return this.ingame&&this.mouseX>=562&&this.mouseX<=752&&this.mouseY>=231&&this.mouseY<=492};insideUsernameArea=()=>{return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=262&&this.mouseY<=279};inPasswordArea=()=>{return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=279&&this.mouseY<=296};rotate=(_)=>{if(_===0)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}));else if(_===1)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}));else if(_===2)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}));else if(_===3)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))};isFullScreen=()=>{return document.fullscreenElement!==null};setMousePosition=(_)=>{if(this.isFullScreen()){let K=_.target.getBoundingClientRect(),Q=window.innerHeight/u0.height,H=(window.innerWidth-u0.width*Q)/2;this.mouseX=this.mapCoord(_.clientX-K.left-H,0,u0.width*Q,0,789)|0,this.mouseY=this.mapCoord(_.clientY-K.top,0,u0.height*Q,0,532)|0}else{let G=u0.getBoundingClientRect(),K=u0.width/G.width,Q=u0.height/G.height;this.mouseX=(_.clientX-G.left)*K|0,this.mouseY=(_.clientY-G.top)*Q|0}if(this.mouseX<0)this.mouseX=0;if(this.mouseY<0)this.mouseY=0;if(this.mouseX>789)this.mouseX=789;if(this.mouseY>532)this.mouseY=532};mapCoord=(_,R,L,G,K)=>{return(_-R)*(K-G)/(L-R)+G}}class n0{id;debugname=null;constructor(_){this.id=_}decodeType(_){while(!0){let R=_.g1;if(R===0)break;this.decode(R,_)}return this}}class A0 extends n0{static count=0;static instances=[];static unpack=(_)=>{let R=new p(_.read("flo.dat"));this.count=R.g2;for(let L=0;L<this.count;L++)this.instances[L]=new A0(L).decodeType(R)};static hsl24to16=(_,R,L)=>{if(L>179)R=R/2|0;if(L>192)R=R/2|0;if(L>217)R=R/2|0;if(L>243)R=R/2|0;return((_/4|0)<<10)+((R/32|0)<<7)+(L/2|0)};static mulHSL=(_,R)=>{if(_===-1)return 12345678;if(R=R*(_&127)/128|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R};static adjustLightness=(_,R)=>{if(_===-2)return 12345678;if(_===-1){if(R<0)R=0;else if(R>127)R=127;return 127-R}else{if(R=R*(_&127)/128|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}};rgb=0;texture=-1;opcode3=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;decode(_,R){if(_===1)this.rgb=R.g3,this.setColor(this.rgb);else if(_===2)this.texture=R.g1;else if(_===3)this.opcode3=!0;else if(_===5)this.occlude=!1;else if(_===6)this.debugname=R.gjstr}setColor(_){let R=(_>>16&255)/256,L=(_>>8&255)/256,G=(_&255)/256,K=R;if(L<R)K=L;if(G<K)K=G;let Q=R;if(L>R)Q=L;if(G>Q)Q=G;let H=0,$=0,J=(K+Q)/2;if(K!==Q){if(J<0.5)$=(Q-K)/(Q+K);if(J>=0.5)$=(Q-K)/(2-Q-K);if(R===Q)H=(L-G)/(Q-K);else if(L===Q)H=(G-R)/(Q-K)+2;else if(G===Q)H=(R-L)/(Q-K)+4}if(H/=6,this.hue=H*256|0,this.saturation=$*256|0,this.lightness=J*256|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(J>0.5)this.luminance=(1-J)*$*512|0;else this.luminance=J*$*512|0;if(this.luminance<1)this.luminance=1;this.chroma=H*this.luminance|0;let O=this.hue+(Math.random()*16|0)-8;if(O<0)O=0;else if(O>255)O=255;let q=this.saturation+(Math.random()*48|0)-24;if(q<0)q=0;else if(q>255)q=255;let b=this.lightness+(Math.random()*48|0)-24;if(b<0)b=0;else if(b>255)b=255;this.hsl=A0.hsl24to16(O,q,b)}}class h1{static instances=[];static unpack=(_)=>{let R=new p(_.read("base_head.dat")),L=new p(_.read("base_type.dat")),G=new p(_.read("base_label.dat")),K=R.g2;R.pos+=2;for(let Q=0;Q<K;Q++){let{g2:H,g1:$}=R,J=new Uint8Array($),O=new l($,null);for(let q=0;q<$;q++){J[q]=L.g1;let b=G.g1,U=new Uint8Array(b);for(let N=0;N<b;N++)U[N]=G.g1;O[q]=U}this.instances[H]=new h1,this.instances[H].length=$,this.instances[H].types=J,this.instances[H].labels=O}};length=0;types=null;labels=null}class G1{static instances=[];static unpack=(_)=>{let R=new p(_.read("frame_head.dat")),L=new p(_.read("frame_tran1.dat")),G=new p(_.read("frame_tran2.dat")),K=new p(_.read("frame_del.dat")),Q=R.g2;R.pos+=2;let H=new Int32Array(500),$=new Int32Array(500),J=new Int32Array(500),O=new Int32Array(500);for(let q=0;q<Q;q++){let b=R.g2,U=this.instances[b]=new G1;U.delay=K.g1;let N=R.g2,I=h1.instances[N];U.base=I;let k=R.g1,F=-1,T=0;for(let Y=0;Y<k;Y++){if(!I.types)throw new Error("SeqBase not loaded!!!");let u=L.g1;if(u>0){if(I.types[Y]!==0){for(let B=Y-1;B>F;B--)if(I.types[B]===0){H[T]=B,$[T]=0,J[T]=0,O[T]=0,T++;break}}H[T]=Y;let w=0;if(I.types[H[T]]===3)w=128;if((u&1)===0)$[T]=w;else $[T]=G.gsmart;if((u&2)===0)J[T]=w;else J[T]=G.gsmart;if((u&4)===0)O[T]=w;else O[T]=G.gsmart;F=Y,T++}}U.length=T,U.bases=new Int32Array(T),U.x=new Int32Array(T),U.y=new Int32Array(T),U.z=new Int32Array(T);for(let Y=0;Y<T;Y++)U.bases[Y]=H[Y],U.x[Y]=$[Y],U.y[Y]=J[Y],U.z[Y]=O[Y]}};delay=0;base=null;length=0;bases=null;x=null;y=null;z=null}class _0 extends n0{static count=0;static instances=[];static unpack=(_)=>{let R=new p(_.read("seq.dat"));this.count=R.g2;for(let L=0;L<this.count;L++){let G=new _0(L).decodeType(R);if(G.frameCount===0)G.frameCount=1,G.frames=new Int16Array(1),G.frames[0]=-1,G.iframes=new Int16Array(1),G.iframes[0]=-1,G.delay=new Int16Array(1),G.delay[0]=-1;this.instances[L]=G}};frameCount=0;frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;righthand=-1;lefthand=-1;replaycount=99;duration=0;decode(_,R){if(_===1){this.frameCount=R.g1,this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let L=0;L<this.frameCount;L++){if(this.frames[L]=R.g2,this.iframes[L]=R.g2,this.iframes[L]===65535)this.iframes[L]=-1;if(this.delay[L]=R.g2,this.delay[L]===0)this.delay[L]=G1.instances[this.frames[L]].delay;if(this.delay[L]===0)this.delay[L]=1;this.duration+=this.delay[L]}}else if(_===2)this.replayoff=R.g2;else if(_===3){let L=R.g1;this.walkmerge=new Int32Array(L+1);for(let G=0;G<L;G++)this.walkmerge[G]=R.g1;this.walkmerge[L]=9999999}else if(_===4)this.stretches=!0;else if(_===5)this.priority=R.g1;else if(_===6)this.righthand=R.g2;else if(_===7)this.lefthand=R.g2;else if(_===8)this.replaycount=R.g1}}class Y8{bucketCount;buckets;constructor(_){this.buckets=[],this.bucketCount=_;for(let R=0;R<_;R++)this.buckets[R]=new D0}get(_){let R=this.buckets[Number(_&BigInt(this.bucketCount-1))];if(!R.next)return null;for(let G=R.next;G!==R;G=G.next){if(!G)continue;if(G.key===_)return G}return null}put(_,R){if(R.prev)R.unlink();let L=this.buckets[Number(_&BigInt(this.bucketCount-1))];if(R.prev=L.prev,R.next=L,R.prev)R.prev.next=R;R.next.prev=R,R.key=_}}class Z8{head;constructor(){this.head=new x0}push(_){if(_.prev2)_.uncache();if(_.prev2=this.head.prev2,_.next2=this.head,_.prev2)_.prev2.next2=_;_.next2.prev2=_}pop(){let _=this.head.next2;if(_===this.head)return null;else return _?.uncache(),_}}class s0{capacity;hashtable;history;available;constructor(_){this.capacity=_,this.available=_,this.hashtable=new Y8(1024),this.history=new Z8}get(_){let R=this.hashtable.get(_);if(R)this.history.push(R);return R}put(_,R){if(this.available===0){let L=this.history.pop();L?.unlink(),L?.uncache()}else this.available--;this.hashtable.put(_,R),this.history.push(R)}clear(){let _=this.history.pop();if(!_){this.available=this.capacity;return}_.unlink(),_.uncache()}}class N0{static WALL=0;static WALL_DECOR=1;static GROUND=2;static GROUND_DECOR=3}class y{static WALL_STRAIGHT=new y(0,N0.WALL);static WALL_DIAGONAL_CORNER=new y(1,N0.WALL);static WALL_L=new y(2,N0.WALL);static WALL_SQUARE_CORNER=new y(3,N0.WALL);static WALLDECOR_STRAIGHT_NOOFFSET=new y(4,N0.WALL_DECOR);static WALLDECOR_STRAIGHT_OFFSET=new y(5,N0.WALL_DECOR);static WALLDECOR_DIAGONAL_OFFSET=new y(6,N0.WALL_DECOR);static WALLDECOR_DIAGONAL_NOOFFSET=new y(7,N0.WALL_DECOR);static WALLDECOR_DIAGONAL_BOTH=new y(8,N0.WALL_DECOR);static WALL_DIAGONAL=new y(9,N0.GROUND);static CENTREPIECE_STRAIGHT=new y(10,N0.GROUND);static CENTREPIECE_DIAGONAL=new y(11,N0.GROUND);static ROOF_STRAIGHT=new y(12,N0.GROUND);static ROOF_DIAGONAL_WITH_ROOFEDGE=new y(13,N0.GROUND);static ROOF_DIAGONAL=new y(14,N0.GROUND);static ROOF_L_CONCAVE=new y(15,N0.GROUND);static ROOF_L_CONVEX=new y(16,N0.GROUND);static ROOF_FLAT=new y(17,N0.GROUND);static ROOFEDGE_STRAIGHT=new y(18,N0.GROUND);static ROOFEDGE_DIAGONAL_CORNER=new y(19,N0.GROUND);static ROOFEDGE_L=new y(20,N0.GROUND);static ROOFEDGE_SQUARE_CORNER=new y(21,N0.GROUND);static GROUND_DECOR=new y(22,N0.GROUND_DECOR);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(_){let R=this.values();for(let L=0;L<R.length;L++){let G=R[L];if(G.id===_)return G}throw Error("shape not found")}id;layer;constructor(_,R){this.id=_,this.layer=R}}class x{static WEST=0;static NORTH=1;static EAST=2;static SOUTH=3}class u8{vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColorsOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1;data=null}class w8{x=0;y=0;z=0;w=0}class E extends x0{static metadata=null;static head=null;static face1=null;static face2=null;static face3=null;static face4=null;static face5=null;static point1=null;static point2=null;static point3=null;static point4=null;static point5=null;static vertex1=null;static vertex2=null;static axis=null;static faceClippedX=new l(4096,!1);static faceNearClipped=new l(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new J1(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new J1(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColor=new Int32Array(10);static baseX=0;static baseY=0;static baseZ=0;static checkHover=!1;static mouseX=0;static mouseY=0;static pickedCount=0;static pickedBitsets=new Int32Array(1000);static checkHoverFace=!1;static unpack(_){try{E.head=new p(_.read("ob_head.dat")),E.face1=new p(_.read("ob_face1.dat")),E.face2=new p(_.read("ob_face2.dat")),E.face3=new p(_.read("ob_face3.dat")),E.face4=new p(_.read("ob_face4.dat")),E.face5=new p(_.read("ob_face5.dat")),E.point1=new p(_.read("ob_point1.dat")),E.point2=new p(_.read("ob_point2.dat")),E.point3=new p(_.read("ob_point3.dat")),E.point4=new p(_.read("ob_point4.dat")),E.point5=new p(_.read("ob_point5.dat")),E.vertex1=new p(_.read("ob_vertex1.dat")),E.vertex2=new p(_.read("ob_vertex2.dat")),E.axis=new p(_.read("ob_axis.dat")),E.head.pos=0,E.point1.pos=0,E.point2.pos=0,E.point3.pos=0,E.point4.pos=0,E.vertex1.pos=0,E.vertex2.pos=0;let R=E.head.g2;E.metadata=new l(R+100,null);let L=0,G=0,K=0,Q=0,H=0,$=0,J=0;for(let O=0;O<R;O++){let q=E.head.g2,b=new u8;b.vertexCount=E.head.g2,b.faceCount=E.head.g2,b.texturedFaceCount=E.head.g1,b.vertexFlagsOffset=E.point1.pos,b.vertexXOffset=E.point2.pos,b.vertexYOffset=E.point3.pos,b.vertexZOffset=E.point4.pos,b.faceVerticesOffset=E.vertex1.pos,b.faceOrientationsOffset=E.vertex2.pos;let U=E.head.g1,N=E.head.g1,I=E.head.g1,k=E.head.g1,F=E.head.g1;for(let T=0;T<b.vertexCount;T++){let Y=E.point1.g1;if((Y&1)!==0)E.point2.gsmart;if((Y&2)!==0)E.point3.gsmart;if((Y&4)!==0)E.point4.gsmart}for(let T=0;T<b.faceCount;T++){if(E.vertex2.g1===1)E.vertex1.gsmart,E.vertex1.gsmart;E.vertex1.gsmart}if(b.faceColorsOffset=K,K+=b.faceCount*2,U===1)b.faceInfosOffset=Q,Q+=b.faceCount;if(N===255)b.facePrioritiesOffset=H,H+=b.faceCount;else b.facePrioritiesOffset=-N-1;if(I===1)b.faceAlphasOffset=$,$+=b.faceCount;if(k===1)b.faceLabelsOffset=J,J+=b.faceCount;if(F===1)b.vertexLabelsOffset=G,G+=b.vertexCount;b.faceTextureAxisOffset=L,L+=b.texturedFaceCount,E.metadata[q]=b}}catch(R){}}static unpack317(_,R){if(E.metadata===null)E.metadata=[];if(_===null){let I=new u8;I.vertexCount=0,I.faceCount=0,I.texturedFaceCount=0,E.metadata[R]=I;return}let L=new p(_);L.pos=L.length-18;let G=new u8;G.data=_,G.vertexCount=L.g2,G.faceCount=L.g2,G.texturedFaceCount=L.g1,E.metadata[R]=G;let{g1:K,g1:Q,g1:H,g1:$,g1:J,g2:O,g2:q,g2:b,g2:U}=L,N=0;if(G.vertexFlagsOffset=N,N+=G.vertexCount,G.faceOrientationsOffset=N,N+=G.faceCount,G.facePrioritiesOffset=N,Q===255)N+=G.faceCount;else G.facePrioritiesOffset=-Q-1;if(G.faceLabelsOffset=N,$===1)N+=G.faceCount;else G.faceLabelsOffset=-1;if(G.faceInfosOffset=N,K===1)N+=G.faceCount;else G.faceInfosOffset=-1;if(G.vertexLabelsOffset=N,J===1)N+=G.vertexCount;else G.vertexLabelsOffset=-1;if(G.faceAlphasOffset=N,H===1)N+=G.faceCount;else G.faceAlphasOffset=-1;G.faceVerticesOffset=N,N+=U,G.faceColorsOffset=N,N+=G.faceCount*2,G.faceTextureAxisOffset=N,N+=G.texturedFaceCount*6,G.vertexXOffset=N,N+=O,G.vertexYOffset=N,N+=q,G.vertexZOffset=N,N+=b}static mulColorLightness(_,R,L){if((L&2)===2){if(R<0)R=0;else if(R>127)R=127;return 127-R}if(R=R*(_&127)>>7,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}static modelCopyFaces=(_,R,L)=>{let{vertexCount:G,faceCount:K,texturedFaceCount:Q}=_,H;if(R){H=new Int32Array(G);for(let N=0;N<G;N++)H[N]=_.vertexY[N]}else H=_.vertexY;let $,J,O,q,b=null,U=null;if(L){$=new Int32Array(K),J=new Int32Array(K),O=new Int32Array(K);for(let N=0;N<K;N++){if(_.faceColorA)$[N]=_.faceColorA[N];if(_.faceColorB)J[N]=_.faceColorB[N];if(_.faceColorC)O[N]=_.faceColorC[N]}if(q=new Int32Array(K),!_.faceInfo)for(let N=0;N<K;N++)q[N]=0;else for(let N=0;N<K;N++)q[N]=_.faceInfo[N];b=new l(G,null);for(let N=0;N<G;N++){let I=b[N]=new w8;if(_.vertexNormal){let k=_.vertexNormal[N];if(k)I.x=k.x,I.y=k.y,I.z=k.z,I.w=k.w}}U=_.vertexNormalOriginal}else $=_.faceColorA,J=_.faceColorB,O=_.faceColorC,q=_.faceInfo;return new E({vertexCount:G,vertexX:_.vertexX,vertexY:H,vertexZ:_.vertexZ,faceCount:K,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:$,faceColorB:J,faceColorC:O,faceInfo:q,facePriority:_.facePriority,faceAlpha:_.faceAlpha,faceColor:_.faceColor,priority:_.priority,texturedFaceCount:Q,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,minX:_.minX,maxX:_.maxX,minZ:_.minZ,maxZ:_.maxZ,radius:_.radius,minY:_.minY,maxY:_.maxY,maxDepth:_.maxDepth,minDepth:_.minDepth,vertexNormal:b,vertexNormalOriginal:U})};static modelShareColored=(_,R,L,G)=>{let{vertexCount:K,faceCount:Q,texturedFaceCount:H}=_,$,J,O;if(G)$=_.vertexX,J=_.vertexY,O=_.vertexZ;else{$=new Int32Array(K),J=new Int32Array(K),O=new Int32Array(K);for(let U=0;U<K;U++)$[U]=_.vertexX[U],J[U]=_.vertexY[U],O[U]=_.vertexZ[U]}let q;if(R)q=_.faceColor;else{q=new Int32Array(Q);for(let U=0;U<Q;U++)if(_.faceColor)q[U]=_.faceColor[U]}let b;if(L)b=_.faceAlpha;else if(b=new Int32Array(Q),!_.faceAlpha)for(let U=0;U<Q;U++)b[U]=0;else for(let U=0;U<Q;U++)b[U]=_.faceAlpha[U];return new E({vertexCount:K,vertexX:$,vertexY:J,vertexZ:O,faceCount:Q,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:b,faceColor:q,priority:_.priority,texturedFaceCount:H,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,vertexLabel:_.vertexLabel,faceLabel:_.faceLabel})};static modelShareAlpha=(_,R)=>{let{vertexCount:L,faceCount:G,texturedFaceCount:K}=_,Q=new Int32Array(L),H=new Int32Array(L),$=new Int32Array(L);for(let O=0;O<L;O++)Q[O]=_.vertexX[O],H[O]=_.vertexY[O],$[O]=_.vertexZ[O];let J;if(R)J=_.faceAlpha;else if(J=new Int32Array(G),!_.faceAlpha)for(let O=0;O<G;O++)J[O]=0;else for(let O=0;O<G;O++)J[O]=_.faceAlpha[O];return new E({vertexCount:L,vertexX:Q,vertexY:H,vertexZ:$,faceCount:G,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:_.faceColorA,faceColorB:_.faceColorB,faceColorC:_.faceColorC,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:J,faceColor:_.faceColor,priority:_.priority,texturedFaceCount:K,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,labelVertices:_.labelVertices,labelFaces:_.labelFaces})};static modelFromModelsBounds=(_,R)=>{let L=!1,G=!1,K=!1,Q=!1,H=0,$=0,J=0,O=-1;for(let f=0;f<R;f++){let m=_[f];if(m){if(H+=m.vertexCount,$+=m.faceCount,J+=m.texturedFaceCount,L||=m.faceInfo!==null,!m.facePriority){if(O===-1)O=m.priority;if(O!==m.priority)G=!0}else G=!0;K||=m.faceAlpha!==null,Q||=m.faceColor!==null}}let q=new Int32Array(H),b=new Int32Array(H),U=new Int32Array(H),N=new Int32Array($),I=new Int32Array($),k=new Int32Array($),F=new Int32Array($),T=new Int32Array($),Y=new Int32Array($),u=new Int32Array(J),w=new Int32Array(J),B=new Int32Array(J),v=null;if(L)v=new Int32Array($);let n=null;if(G)n=new Int32Array($);let W=null;if(K)W=new Int32Array($);let P=null;if(Q)P=new Int32Array($);H=0,$=0,J=0;for(let f=0;f<R;f++){let m=_[f];if(m){let M=H;for(let r=0;r<m.vertexCount;r++)q[H]=m.vertexX[r],b[H]=m.vertexY[r],U[H]=m.vertexZ[r],H++;for(let r=0;r<m.faceCount;r++){if(N[$]=m.faceVertexA[r]+M,I[$]=m.faceVertexB[r]+M,k[$]=m.faceVertexC[r]+M,m.faceColorA)F[$]=m.faceColorA[r];if(m.faceColorB)T[$]=m.faceColorB[r];if(m.faceColorC)Y[$]=m.faceColorC[r];if(L){if(!m.faceInfo){if(v)v[$]=0}else if(v)v[$]=m.faceInfo[r]}if(G){if(!m.facePriority){if(n)n[$]=m.priority}else if(n)n[$]=m.facePriority[r]}if(K){if(!m.faceAlpha){if(W)W[$]=0}else if(W)W[$]=m.faceAlpha[r]}if(Q&&m.faceColor){if(P)P[$]=m.faceColor[r]}$++}for(let r=0;r<m.texturedFaceCount;r++)u[J]=m.texturedVertexA[r]+M,w[J]=m.texturedVertexB[r]+M,B[J]=m.texturedVertexC[r]+M,J++}}let z=new E({vertexCount:H,vertexX:q,vertexY:b,vertexZ:U,faceCount:$,faceVertexA:N,faceVertexB:I,faceVertexC:k,faceColorA:F,faceColorB:T,faceColorC:Y,faceInfo:v,facePriority:n,faceAlpha:W,faceColor:P,priority:O,texturedFaceCount:J,texturedVertexA:u,texturedVertexB:w,texturedVertexC:B});return z.calculateBoundsCylinder(),z};static modelFromModels=(_,R)=>{let L=!1,G=!1,K=!1,Q=!1,H=0,$=0,J=0,O=-1;for(let z=0;z<R;z++){let f=_[z];if(f){if(H+=f.vertexCount,$+=f.faceCount,J+=f.texturedFaceCount,L||=f.faceInfo!==null,!f.facePriority){if(O===-1)O=f.priority;if(O!==f.priority)G=!0}else G=!0;K||=f.faceAlpha!==null,Q||=f.faceLabel!==null}}let q=new Int32Array(H),b=new Int32Array(H),U=new Int32Array(H),N=new Int32Array(H),I=new Int32Array($),k=new Int32Array($),F=new Int32Array($),T=new Int32Array(J),Y=new Int32Array(J),u=new Int32Array(J),w=null;if(L)w=new Int32Array($);let B=null;if(G)B=new Int32Array($);let v=null;if(K)v=new Int32Array($);let n=null;if(Q)n=new Int32Array($);let W=new Int32Array($);H=0,$=0,J=0;let P=(z,f,m,M,r,a,C)=>{let L0=-1,e=z.vertexX[f],G0=z.vertexY[f],J0=z.vertexZ[f];for(let Q0=0;Q0<C;Q0++)if(e===m[Q0]&&G0===M[Q0]&&J0===r[Q0]){L0=Q0;break}if(L0===-1){if(m[C]=e,M[C]=G0,r[C]=J0,a&&z.vertexLabel)a[C]=z.vertexLabel[f];L0=C++}return{vertex:L0,vertexCount:C}};for(let z=0;z<R;z++){let f=_[z];if(f){for(let m=0;m<f.faceCount;m++){if(L){if(!f.faceInfo){if(w)w[$]=0}else if(w)w[$]=f.faceInfo[m]}if(G){if(!f.facePriority){if(B)B[$]=f.priority}else if(B)B[$]=f.facePriority[m]}if(K){if(!f.faceAlpha){if(v)v[$]=0}else if(v)v[$]=f.faceAlpha[m]}if(Q&&f.faceLabel){if(n)n[$]=f.faceLabel[m]}if(f.faceColor)W[$]=f.faceColor[m];let M=P(f,f.faceVertexA[m],q,b,U,N,H);H=M.vertexCount;let r=P(f,f.faceVertexB[m],q,b,U,N,H);H=r.vertexCount;let a=P(f,f.faceVertexC[m],q,b,U,N,H);H=a.vertexCount,I[$]=M.vertex,k[$]=r.vertex,F[$]=a.vertex,$++}for(let m=0;m<f.texturedFaceCount;m++){let M=P(f,f.texturedVertexA[m],q,b,U,N,H);H=M.vertexCount;let r=P(f,f.texturedVertexB[m],q,b,U,N,H);H=r.vertexCount;let a=P(f,f.texturedVertexC[m],q,b,U,N,H);H=a.vertexCount,T[J]=M.vertex,Y[J]=r.vertex,u[J]=a.vertex,J++}}}return new E({vertexCount:H,vertexX:q,vertexY:b,vertexZ:U,faceCount:$,faceVertexA:I,faceVertexB:k,faceVertexC:F,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:w,facePriority:B,faceAlpha:v,faceColor:W,priority:O,texturedFaceCount:J,texturedVertexA:T,texturedVertexB:Y,texturedVertexC:u,vertexLabel:N,faceLabel:n})};static model=(_)=>{if(!E.metadata)throw new Error("cant loading model metadata!!!!!");let R=E.metadata[_];if(!R)throw new Error("cant loading model metadata!!!!!");if(!E.head||!E.face1||!E.face2||!E.face3||!E.face4||!E.face5||!E.point1||!E.point2||!E.point3||!E.point4||!E.point5||!E.vertex1||!E.vertex2||!E.axis)throw new Error("cant loading model!!!!!");let{vertexCount:L,faceCount:G,texturedFaceCount:K}=R,Q=new Int32Array(L),H=new Int32Array(L),$=new Int32Array(L),J=new Int32Array(G),O=new Int32Array(G),q=new Int32Array(G),b=new Int32Array(K),U=new Int32Array(K),N=new Int32Array(K),I=null;if(R.vertexLabelsOffset>=0)I=new Int32Array(L);let k=null;if(R.faceInfosOffset>=0)k=new Int32Array(G);let F=null,T=0;if(R.facePrioritiesOffset>=0)F=new Int32Array(G);else T=-R.facePrioritiesOffset-1;let Y=null;if(R.faceAlphasOffset>=0)Y=new Int32Array(G);let u=null;if(R.faceLabelsOffset>=0)u=new Int32Array(G);let w=new Int32Array(G);E.point1.pos=R.vertexFlagsOffset,E.point2.pos=R.vertexXOffset,E.point3.pos=R.vertexYOffset,E.point4.pos=R.vertexZOffset,E.point5.pos=R.vertexLabelsOffset;let B=0,v=0,n=0,W,P,z;for(let m=0;m<L;m++){let M=E.point1.g1;if(W=0,(M&1)!==0)W=E.point2.gsmart;if(P=0,(M&2)!==0)P=E.point3.gsmart;if(z=0,(M&4)!==0)z=E.point4.gsmart;if(Q[m]=B+W,H[m]=v+P,$[m]=n+z,B=Q[m],v=H[m],n=$[m],I)I[m]=E.point5.g1}E.face1.pos=R.faceColorsOffset,E.face2.pos=R.faceInfosOffset,E.face3.pos=R.facePrioritiesOffset,E.face4.pos=R.faceAlphasOffset,E.face5.pos=R.faceLabelsOffset;for(let m=0;m<G;m++){if(w[m]=E.face1.g2,k)k[m]=E.face2.g1;if(F)F[m]=E.face3.g1;if(Y)Y[m]=E.face4.g1;if(u)u[m]=E.face5.g1}E.vertex1.pos=R.faceVerticesOffset,E.vertex2.pos=R.faceOrientationsOffset,W=0,P=0,z=0;let f=0;for(let m=0;m<G;m++){let M=E.vertex2.g1;if(M===1)W=E.vertex1.gsmart+f,f=W,P=E.vertex1.gsmart+f,f=P,z=E.vertex1.gsmart+f,f=z;else if(M===2)P=z,z=E.vertex1.gsmart+f,f=z;else if(M===3)W=z,z=E.vertex1.gsmart+f,f=z;else if(M===4){let r=W;W=P,P=r,z=E.vertex1.gsmart+f,f=z}J[m]=W,O[m]=P,q[m]=z}E.axis.pos=R.faceTextureAxisOffset*6;for(let m=0;m<K;m++)b[m]=E.axis.g2,U[m]=E.axis.g2,N[m]=E.axis.g2;return new E({vertexCount:L,vertexX:Q,vertexY:H,vertexZ:$,faceCount:G,faceVertexA:J,faceVertexB:O,faceVertexC:q,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:k,facePriority:F,faceAlpha:Y,faceColor:w,priority:T,texturedFaceCount:K,texturedVertexA:b,texturedVertexB:U,texturedVertexC:N,vertexLabel:I,faceLabel:u})};static model317=(_,R)=>{if(!E.metadata||!E.metadata[R])throw new Error("No model metadata");let L=E.metadata[R];if(L.data=_,!L.data.length)throw new Error("No model data");let{vertexCount:G,faceCount:K,texturedFaceCount:Q}=L,H=new Int32Array(G),$=new Int32Array(G),J=new Int32Array(G),O=new Int32Array(K),q=new Int32Array(K),b=new Int32Array(K),U=new Int32Array(Q),N=new Int32Array(Q),I=new Int32Array(Q),k=null;if(L.vertexLabelsOffset>=0)k=new Int32Array(G);let F=null;if(L.faceInfosOffset>=0)F=new Int32Array(K);let T=null,Y=0;if(L.facePrioritiesOffset>=0)T=new Int32Array(K);else Y=-L.facePrioritiesOffset-1;let u=null;if(L.faceAlphasOffset>=0)u=new Int32Array(K);let w=null;if(L.faceLabelsOffset>=0)w=new Int32Array(K);let B=new Int32Array(K),v=new p(L.data);v.pos=L.vertexFlagsOffset;let n=new p(L.data);n.pos=L.vertexXOffset;let W=new p(L.data);W.pos=L.vertexYOffset;let P=new p(L.data);P.pos=L.vertexZOffset;let z=new p(L.data);z.pos=L.vertexLabelsOffset;let f=0,m=0,M=0,r,a,C;for(let T0=0;T0<G;T0++){let L1=v.g1;if(r=0,(L1&1)!==0)r=n.gsmart;if(a=0,(L1&2)!==0)a=W.gsmart;if(C=0,(L1&4)!==0)C=P.gsmart;if(H[T0]=f+r,$[T0]=m+a,J[T0]=M+C,f=H[T0],m=$[T0],M=J[T0],k)k[T0]=z.g1}let L0=new p(L.data);L0.pos=L.faceColorsOffset;let e=new p(L.data);e.pos=L.faceInfosOffset;let G0=new p(L.data);G0.pos=L.facePrioritiesOffset;let J0=new p(L.data);J0.pos=L.faceAlphasOffset;let Q0=new p(L.data);Q0.pos=L.faceLabelsOffset;for(let T0=0;T0<K;T0++){if(B[T0]=L0.g2,F)F[T0]=e.g1;if(T)T[T0]=G0.g1;if(u)u[T0]=J0.g1;if(w)w[T0]=Q0.g1}let i=new p(L.data);i.pos=L.faceVerticesOffset;let j0=new p(L.data);j0.pos=L.faceOrientationsOffset,r=0,a=0,C=0;let $0=0;for(let T0=0;T0<K;T0++){let L1=j0.g1;if(L1===1)r=i.gsmart+$0,$0=r,a=i.gsmart+$0,$0=a,C=i.gsmart+$0,$0=C;else if(L1===2)a=C,C=i.gsmart+$0,$0=C;else if(L1===3)r=C,C=i.gsmart+$0,$0=C;else if(L1===4){let b1=r;r=a,a=b1,C=i.gsmart+$0,$0=C}O[T0]=r,q[T0]=a,b[T0]=C}let F0=new p(L.data);F0.pos=L.faceTextureAxisOffset;for(let T0=0;T0<Q;T0++)U[T0]=F0.g2,N[T0]=F0.g2,I[T0]=F0.g2;return new E({vertexCount:G,vertexX:H,vertexY:$,vertexZ:J,faceCount:K,faceVertexA:O,faceVertexB:q,faceVertexC:b,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:F,facePriority:T,faceAlpha:u,faceColor:B,priority:Y,texturedFaceCount:Q,texturedVertexA:U,texturedVertexB:N,texturedVertexC:I,vertexLabel:k,faceLabel:w})};vertexCount;vertexX;vertexY;vertexZ;faceCount;faceVertexA;faceVertexB;faceVertexC;faceColorA;faceColorB;faceColorC;faceInfo;facePriority;faceAlpha;faceColor;priority;texturedFaceCount;texturedVertexA;texturedVertexB;texturedVertexC;minX;maxX;minZ;maxZ;radius;minY;maxY;maxDepth;minDepth;vertexLabel;faceLabel;labelVertices;labelFaces;vertexNormal;vertexNormalOriginal;objRaise=0;pickable=!1;pickedFace=-1;pickedFaceDepth=-1;constructor(_){super();this.vertexCount=_.vertexCount,this.vertexX=_.vertexX,this.vertexY=_.vertexY,this.vertexZ=_.vertexZ,this.faceCount=_.faceCount,this.faceVertexA=_.faceVertexA,this.faceVertexB=_.faceVertexB,this.faceVertexC=_.faceVertexC,this.faceColorA=_.faceColorA,this.faceColorB=_.faceColorB,this.faceColorC=_.faceColorC,this.faceInfo=_.faceInfo,this.facePriority=_.facePriority,this.faceAlpha=_.faceAlpha,this.faceColor=_.faceColor,this.priority=_.priority,this.texturedFaceCount=_.texturedFaceCount,this.texturedVertexA=_.texturedVertexA,this.texturedVertexB=_.texturedVertexB,this.texturedVertexC=_.texturedVertexC,this.minX=_.minX??0,this.maxX=_.maxX??0,this.minZ=_.minZ??0,this.maxZ=_.maxZ??0,this.radius=_.radius??0,this.minY=_.minY??0,this.maxY=_.maxY??0,this.maxDepth=_.maxDepth??0,this.minDepth=_.minDepth??0,this.vertexLabel=_.vertexLabel??null,this.faceLabel=_.faceLabel??null,this.labelVertices=_.labelVertices??null,this.labelFaces=_.labelFaces??null,this.vertexNormal=_.vertexNormal??null,this.vertexNormalOriginal=_.vertexNormalOriginal??null}calculateBoundsCylinder(){this.maxY=0,this.radius=0,this.minY=0;for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_],L=this.vertexY[_],G=this.vertexZ[_];if(-L>this.maxY)this.maxY=-L;if(L>this.minY)this.minY=L;let K=R*R+G*G;if(K>this.radius)this.radius=K}this.radius=Math.sqrt(this.radius)+0.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0)}calculateBoundsY(){this.maxY=0,this.minY=0;for(let _=0;_<this.vertexCount;_++){let R=this.vertexY[_];if(-R>this.maxY)this.maxY=-R;if(R>this.minY)this.minY=R}this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0)}createLabelReferences(){if(this.vertexLabel){let _=new Int32Array(256),R=0;for(let G=0;G<this.vertexCount;G++){let K=this.vertexLabel[G];if(_[K]++,K>R)R=K}this.labelVertices=new l(R+1,null);for(let G=0;G<=R;G++)this.labelVertices[G]=new Int32Array(_[G]),_[G]=0;let L=0;while(L<this.vertexCount){let G=this.vertexLabel[L],K=this.labelVertices[G];if(!K)continue;K[_[G]++]=L++}this.vertexLabel=null}if(this.faceLabel){let _=new Int32Array(256),R=0;for(let G=0;G<this.faceCount;G++){let K=this.faceLabel[G];if(_[K]++,K>R)R=K}this.labelFaces=new l(R+1,null);for(let G=0;G<=R;G++)this.labelFaces[G]=new Int32Array(_[G]),_[G]=0;let L=0;while(L<this.faceCount){let G=this.faceLabel[L],K=this.labelFaces[G];if(!K)continue;K[_[G]++]=L++}this.faceLabel=null}}applyTransforms(_,R,L){if(_===-1)return;if(!L||R===-1)this.applyTransform(_);else{let G=G1.instances[_],K=G1.instances[R],Q=G.base;E.baseX=0,E.baseY=0,E.baseZ=0;let H=0,$=L[H++];for(let J=0;J<G.length;J++){if(!G.bases)continue;let O=G.bases[J];while(O>$)$=L[H++];if(Q&&Q.types&&G.x&&G.y&&G.z&&Q.labels&&(O!==$||Q.types[O]===0))this.applyTransform2(G.x[J],G.y[J],G.z[J],Q.labels[O],Q.types[O])}E.baseX=0,E.baseY=0,E.baseZ=0,H=0,$=L[H++];for(let J=0;J<K.length;J++){if(!K.bases)continue;let O=K.bases[J];while(O>$)$=L[H++];if(Q&&Q.types&&K.x&&K.y&&K.z&&Q.labels&&(O===$||Q.types[O]===0))this.applyTransform2(K.x[J],K.y[J],K.z[J],Q.labels[O],Q.types[O])}}}applyTransform(_){if(!this.labelVertices||_===-1||!G1.instances[_])return;let R=G1.instances[_],L=R.base;E.baseX=0,E.baseY=0,E.baseZ=0;for(let G=0;G<R.length;G++){if(!R.bases||!R.x||!R.y||!R.z||!L||!L.labels||!L.types)continue;let K=R.bases[G];this.applyTransform2(R.x[G],R.y[G],R.z[G],L.labels[K],L.types[K])}}rotateY90(){for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_];this.vertexX[_]=this.vertexZ[_],this.vertexZ[_]=-R}}rotateX(_){let R=h.sin[_],L=h.cos[_];for(let G=0;G<this.vertexCount;G++){let K=this.vertexY[G]*L-this.vertexZ[G]*R>>16;this.vertexZ[G]=this.vertexY[G]*R+this.vertexZ[G]*L>>16,this.vertexY[G]=K}}translate(_,R,L){for(let G=0;G<this.vertexCount;G++)this.vertexX[G]+=R,this.vertexY[G]+=_,this.vertexZ[G]+=L}recolor(_,R){if(!this.faceColor)return;for(let L=0;L<this.faceCount;L++)if(this.faceColor[L]===_)this.faceColor[L]=R}rotateY180(){for(let _=0;_<this.vertexCount;_++)this.vertexZ[_]=-this.vertexZ[_];for(let _=0;_<this.faceCount;_++){let R=this.faceVertexA[_];this.faceVertexA[_]=this.faceVertexC[_],this.faceVertexC[_]=R}}scale(_,R,L){for(let G=0;G<this.vertexCount;G++)this.vertexX[G]=this.vertexX[G]*_/128|0,this.vertexY[G]=this.vertexY[G]*R/128|0,this.vertexZ[G]=this.vertexZ[G]*L/128|0}calculateNormals(_,R,L,G,K,Q){let H=Math.sqrt(L*L+G*G+K*K)|0,$=R*H>>8;if(!this.faceColorA||!this.faceColorB||!this.faceColorC)this.faceColorA=new Int32Array(this.faceCount),this.faceColorB=new Int32Array(this.faceCount),this.faceColorC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new l(this.vertexCount,null);for(let J=0;J<this.vertexCount;J++)this.vertexNormal[J]=new w8}for(let J=0;J<this.faceCount;J++){let O=this.faceVertexA[J],q=this.faceVertexB[J],b=this.faceVertexC[J],U=this.vertexX[q]-this.vertexX[O],N=this.vertexY[q]-this.vertexY[O],I=this.vertexZ[q]-this.vertexZ[O],k=this.vertexX[b]-this.vertexX[O],F=this.vertexY[b]-this.vertexY[O],T=this.vertexZ[b]-this.vertexZ[O],Y=N*T-F*I,u=I*k-T*U,w=U*F-k*N;while(Y>8192||u>8192||w>8192||Y<-8192||u<-8192||w<-8192)Y>>=1,u>>=1,w>>=1;let B=Math.sqrt(Y*Y+u*u+w*w)|0;if(B<=0)B=1;if(Y=Y*256/B|0,u=u*256/B|0,w=w*256/B|0,!this.faceInfo||(this.faceInfo[J]&1)===0){let v=this.vertexNormal[O];if(v)v.x+=Y,v.y+=u,v.z+=w,v.w++;if(v=this.vertexNormal[q],v)v.x+=Y,v.y+=u,v.z+=w,v.w++;if(v=this.vertexNormal[b],v)v.x+=Y,v.y+=u,v.z+=w,v.w++}else{let v=_+((L*Y+G*u+K*w)/($+($/2|0))|0);if(this.faceColor)this.faceColorA[J]=E.mulColorLightness(this.faceColor[J],v,this.faceInfo[J])}}if(Q)this.applyLighting(_,$,L,G,K);else{this.vertexNormalOriginal=new l(this.vertexCount,null);for(let J=0;J<this.vertexCount;J++){let O=this.vertexNormal[J],q=new w8;if(O)q.x=O.x,q.y=O.y,q.z=O.z,q.w=O.w;this.vertexNormalOriginal[J]=q}}if(Q)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(_,R,L,G,K){for(let Q=0;Q<this.faceCount;Q++){let H=this.faceVertexA[Q],$=this.faceVertexB[Q],J=this.faceVertexC[Q];if(!this.faceInfo&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){let O=this.faceColor[Q],q=this.vertexNormal[H];if(q)this.faceColorA[Q]=E.mulColorLightness(O,_+((L*q.x+G*q.y+K*q.z)/(R*q.w)|0),0);let b=this.vertexNormal[$];if(b)this.faceColorB[Q]=E.mulColorLightness(O,_+((L*b.x+G*b.y+K*b.z)/(R*b.w)|0),0);let U=this.vertexNormal[J];if(U)this.faceColorC[Q]=E.mulColorLightness(O,_+((L*U.x+G*U.y+K*U.z)/(R*U.w)|0),0)}else if(this.faceInfo&&(this.faceInfo[Q]&1)===0&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){let O=this.faceColor[Q],q=this.faceInfo[Q],b=this.vertexNormal[H];if(b)this.faceColorA[Q]=E.mulColorLightness(O,_+((L*b.x+G*b.y+K*b.z)/(R*b.w)|0),q);let U=this.vertexNormal[$];if(U)this.faceColorB[Q]=E.mulColorLightness(O,_+((L*U.x+G*U.y+K*U.z)/(R*U.w)|0),q);let N=this.vertexNormal[J];if(N)this.faceColorC[Q]=E.mulColorLightness(O,_+((L*N.x+G*N.y+K*N.z)/(R*N.w)|0),q)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo){for(let Q=0;Q<this.faceCount;Q++)if((this.faceInfo[Q]&2)===2)return}this.faceColor=null}drawSimple(_,R,L,G,K,Q,H){let $=h.sin[_],J=h.cos[_],O=h.sin[R],q=h.cos[R],b=h.sin[L],U=h.cos[L],N=h.sin[G],I=h.cos[G],k=Q*N+H*I>>16;for(let F=0;F<this.vertexCount;F++){let T=this.vertexX[F],Y=this.vertexY[F],u=this.vertexZ[F],w;if(L!==0)w=Y*b+T*U>>16,Y=Y*U-T*b>>16,T=w;if(_!==0)w=Y*J-u*$>>16,u=Y*$+u*J>>16,Y=w;if(R!==0)w=u*O+T*q>>16,u=u*q-T*O>>16,T=w;if(T+=K,Y+=Q,u+=H,w=Y*I-u*N>>16,u=Y*N+u*I>>16,Y=w,E.vertexScreenX&&E.vertexScreenY&&E.vertexScreenZ)E.vertexScreenZ[F]=u-k,E.vertexScreenX[F]=h.centerX+((T<<9)/u|0),E.vertexScreenY[F]=h.centerY+((Y<<9)/u|0);if(this.texturedFaceCount>0&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ)E.vertexViewSpaceX[F]=T,E.vertexViewSpaceY[F]=Y,E.vertexViewSpaceZ[F]=u}try{this.draw2(!1,!1,0)}catch(F){}}draw(_,R,L,G,K,Q,H,$,J){let O=$*K-Q*G>>16,q=H*R+O*L>>16,b=this.radius*L>>16,U=q+b;if(U<=50||q>=3500)return;let N=$*G+Q*K>>16,I=N-this.radius<<9;if((I/U|0)>=j.centerX2d)return;let k=N+this.radius<<9;if((k/U|0)<=-j.centerX2d)return;let F=H*L-O*R>>16,T=this.radius*R>>16,Y=F+T<<9;if((Y/U|0)<=-j.centerY2d)return;let u=T+(this.maxY*L>>16),w=F-u<<9;if((w/U|0)>=j.centerY2d)return;let B=b+(this.maxY*R>>16),v=q-B<=50,n=!1;if(J>0&&E.checkHover){let m=q-b;if(m<=50)m=50;if(N>0)I=I/U|0,k=k/m|0;else k=k/U|0,I=I/m|0;if(F>0)w=w/U|0,Y=Y/m|0;else Y=Y/U|0,w=w/m|0;let M=E.mouseX-h.centerX,r=E.mouseY-h.centerY;if(M>I&&M<k&&r>w&&r<Y)if(this.pickable)E.pickedBitsets[E.pickedCount++]=J;else n=!0}let W=h.centerX,P=h.centerY,z=0,f=0;if(_!==0)z=h.sin[_],f=h.cos[_];for(let m=0;m<this.vertexCount;m++){let M=this.vertexX[m],r=this.vertexY[m],a=this.vertexZ[m],C;if(_!==0)C=a*z+M*f>>16,a=a*f-M*z>>16,M=C;if(M+=Q,r+=H,a+=$,C=a*G+M*K>>16,a=a*K-M*G>>16,M=C,C=r*L-a*R>>16,a=r*R+a*L>>16,r=C,E.vertexScreenZ)E.vertexScreenZ[m]=a-q;if(a>=50&&E.vertexScreenX&&E.vertexScreenY)E.vertexScreenX[m]=W+((M<<9)/a|0),E.vertexScreenY[m]=P+((r<<9)/a|0);else if(E.vertexScreenX)E.vertexScreenX[m]=-5000,v=!0;if((v||this.texturedFaceCount>0)&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ)E.vertexViewSpaceX[m]=M,E.vertexViewSpaceY[m]=r,E.vertexViewSpaceZ[m]=a}try{this.draw2(v,n,J)}catch(m){}}draw2(_,R,L,G=!1){if(E.checkHoverFace)this.pickedFace=-1,this.pickedFaceDepth=-1;for(let $=0;$<this.maxDepth;$++)if(E.tmpDepthFaceCount)E.tmpDepthFaceCount[$]=0;for(let $=0;$<this.faceCount;$++){if(this.faceInfo&&this.faceInfo[$]===-1)continue;if(E.vertexScreenX&&E.vertexScreenY&&E.vertexScreenZ&&E.tmpDepthFaces&&E.tmpDepthFaceCount){let J=this.faceVertexA[$],O=this.faceVertexB[$],q=this.faceVertexC[$],b=E.vertexScreenX[J],U=E.vertexScreenX[O],N=E.vertexScreenX[q],I=E.vertexScreenY[J],k=E.vertexScreenY[O],F=E.vertexScreenY[q],T=E.vertexScreenZ[J],Y=E.vertexScreenZ[O],u=E.vertexScreenZ[q];if(_&&(b===-5000||U===-5000||N===-5000)){if(E.faceNearClipped)E.faceNearClipped[$]=!0;if(E.tmpDepthFaces&&E.tmpDepthFaceCount){let w=((T+Y+u)/3|0)+this.minDepth;E.tmpDepthFaces[w][E.tmpDepthFaceCount[w]++]=$}}else{if(R&&this.pointWithinTriangle(E.mouseX,E.mouseY,I,k,F,b,U,N))E.pickedBitsets[E.pickedCount++]=L,R=!1;let w=b-U,B=I-k,v=N-U,n=F-k;if(w*n-B*v<=0)continue;if(E.faceNearClipped)E.faceNearClipped[$]=!1;if(E.faceClippedX)E.faceClippedX[$]=b<0||U<0||N<0||b>j.boundX||U>j.boundX||N>j.boundX;if(E.tmpDepthFaces&&E.tmpDepthFaceCount){let W=((T+Y+u)/3|0)+this.minDepth;if(E.tmpDepthFaces[W][E.tmpDepthFaceCount[W]++]=$,E.checkHoverFace&&this.pointWithinTriangle(E.mouseX,E.mouseY,I,k,F,b,U,N)&&this.pickedFaceDepth<W)this.pickedFace=$,this.pickedFaceDepth=W}}}}if(!this.facePriority&&E.tmpDepthFaceCount){for(let $=this.maxDepth-1;$>=0;$--){let J=E.tmpDepthFaceCount[$];if(J<=0)continue;if(E.tmpDepthFaces){let O=E.tmpDepthFaces[$];for(let q=0;q<J;q++)this.drawFace(O[q],G)}}return}for(let $=0;$<12;$++)if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum)E.tmpPriorityFaceCount[$]=0,E.tmpPriorityDepthSum[$]=0;if(E.tmpDepthFaceCount)for(let $=this.maxDepth-1;$>=0;$--){let J=E.tmpDepthFaceCount[$];if(J>0&&E.tmpDepthFaces){let O=E.tmpDepthFaces[$];for(let q=0;q<J;q++)if(this.facePriority&&E.tmpPriorityFaceCount&&E.tmpPriorityFaces){let b=O[q],U=this.facePriority[b],N=E.tmpPriorityFaceCount[U]++;if(E.tmpPriorityFaces[U][N]=b,U<10&&E.tmpPriorityDepthSum)E.tmpPriorityDepthSum[U]+=$;else if(U===10&&E.tmpPriority10FaceDepth)E.tmpPriority10FaceDepth[N]=$;else if(E.tmpPriority11FaceDepth)E.tmpPriority11FaceDepth[N]=$}}}let K=0;if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum&&(E.tmpPriorityFaceCount[1]>0||E.tmpPriorityFaceCount[2]>0))K=(E.tmpPriorityDepthSum[1]+E.tmpPriorityDepthSum[2])/(E.tmpPriorityFaceCount[1]+E.tmpPriorityFaceCount[2])|0;let Q=0;if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum&&(E.tmpPriorityFaceCount[3]>0||E.tmpPriorityFaceCount[4]>0))Q=(E.tmpPriorityDepthSum[3]+E.tmpPriorityDepthSum[4])/(E.tmpPriorityFaceCount[3]+E.tmpPriorityFaceCount[4])|0;let H=0;if(E.tmpPriorityFaceCount&&E.tmpPriorityDepthSum&&(E.tmpPriorityFaceCount[6]>0||E.tmpPriorityFaceCount[8]>0))H=(E.tmpPriorityDepthSum[6]+E.tmpPriorityDepthSum[8])/(E.tmpPriorityFaceCount[6]+E.tmpPriorityFaceCount[8])|0;if(E.tmpPriorityFaceCount&&E.tmpPriorityFaces){let $=0,J=E.tmpPriorityFaceCount[10],O=E.tmpPriorityFaces[10],q=E.tmpPriority10FaceDepth;if($===J)$=0,J=E.tmpPriorityFaceCount[11],O=E.tmpPriorityFaces[11],q=E.tmpPriority11FaceDepth;let b;if($<J&&q)b=q[$];else b=-1000;for(let U=0;U<10;U++){while(U===0&&b>K)try{if(this.drawFace(O[$++],G),$===J&&O!==E.tmpPriorityFaces[11])$=0,J=E.tmpPriorityFaceCount[11],O=E.tmpPriorityFaces[11],q=E.tmpPriority11FaceDepth;if($<J&&q)b=q[$];else b=-1000}catch(k){}while(U===3&&b>Q)try{if(this.drawFace(O[$++],G),$===J&&O!==E.tmpPriorityFaces[11])$=0,J=E.tmpPriorityFaceCount[11],O=E.tmpPriorityFaces[11],q=E.tmpPriority11FaceDepth;if($<J&&q)b=q[$];else b=-1000}catch(k){}while(U===5&&b>H)try{if(this.drawFace(O[$++],G),$===J&&O!==E.tmpPriorityFaces[11])$=0,J=E.tmpPriorityFaceCount[11],O=E.tmpPriorityFaces[11],q=E.tmpPriority11FaceDepth;if($<J&&q)b=q[$];else b=-1000}catch(k){}let N=E.tmpPriorityFaceCount[U],I=E.tmpPriorityFaces[U];for(let k=0;k<N;k++)this.drawFace(I[k],G)}while(b!==-1000)try{if(this.drawFace(O[$++],G),$===J&&O!==E.tmpPriorityFaces[11])$=0,O=E.tmpPriorityFaces[11],J=E.tmpPriorityFaceCount[11],q=E.tmpPriority11FaceDepth;if($<J&&q)b=q[$];else b=-1000}catch(U){}}}drawFace(_,R=!1){if(E.faceNearClipped&&E.faceNearClipped[_]){this.drawNearClippedFace(_,R);return}let L=this.faceVertexA[_],G=this.faceVertexB[_],K=this.faceVertexC[_];if(E.faceClippedX)h.clipX=E.faceClippedX[_];if(!this.faceAlpha)h.alpha=0;else h.alpha=this.faceAlpha[_];let Q;if(!this.faceInfo)Q=0;else Q=this.faceInfo[_]&3;if(R&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC)h.drawLine(E.vertexScreenX[L],E.vertexScreenY[L],E.vertexScreenX[G],E.vertexScreenY[G],h.palette[this.faceColorA[_]]),h.drawLine(E.vertexScreenX[G],E.vertexScreenY[G],E.vertexScreenX[K],E.vertexScreenY[K],h.palette[this.faceColorB[_]]),h.drawLine(E.vertexScreenX[K],E.vertexScreenY[K],E.vertexScreenX[L],E.vertexScreenY[L],h.palette[this.faceColorC[_]]);else if(Q===0&&this.faceColorA&&this.faceColorB&&this.faceColorC&&E.vertexScreenX&&E.vertexScreenY)h.fillGouraudTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],this.faceColorA[_],this.faceColorB[_],this.faceColorC[_]);else if(Q===1&&this.faceColorA&&E.vertexScreenX&&E.vertexScreenY)h.fillTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],h.palette[this.faceColorA[_]]);else if(Q===2&&this.faceInfo&&this.faceColor&&this.faceColorA&&this.faceColorB&&this.faceColorC&&E.vertexScreenX&&E.vertexScreenY&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){let H=this.faceInfo[_]>>2,$=this.texturedVertexA[H],J=this.texturedVertexB[H],O=this.texturedVertexC[H];h.fillTexturedTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],this.faceColorA[_],this.faceColorB[_],this.faceColorC[_],E.vertexViewSpaceX[$],E.vertexViewSpaceY[$],E.vertexViewSpaceZ[$],E.vertexViewSpaceX[J],E.vertexViewSpaceX[O],E.vertexViewSpaceY[J],E.vertexViewSpaceY[O],E.vertexViewSpaceZ[J],E.vertexViewSpaceZ[O],this.faceColor[_])}else if(Q===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&E.vertexScreenX&&E.vertexScreenY&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){let H=this.faceInfo[_]>>2,$=this.texturedVertexA[H],J=this.texturedVertexB[H],O=this.texturedVertexC[H];h.fillTexturedTriangle(E.vertexScreenX[L],E.vertexScreenX[G],E.vertexScreenX[K],E.vertexScreenY[L],E.vertexScreenY[G],E.vertexScreenY[K],this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[$],E.vertexViewSpaceY[$],E.vertexViewSpaceZ[$],E.vertexViewSpaceX[J],E.vertexViewSpaceX[O],E.vertexViewSpaceY[J],E.vertexViewSpaceY[O],E.vertexViewSpaceZ[J],E.vertexViewSpaceZ[O],this.faceColor[_])}}drawNearClippedFace(_,R=!1){let L=0;if(E.vertexViewSpaceZ){let O=h.centerX,q=h.centerY,b=this.faceVertexA[_],U=this.faceVertexB[_],N=this.faceVertexC[_],I=E.vertexViewSpaceZ[b],k=E.vertexViewSpaceZ[U],F=E.vertexViewSpaceZ[N];if(I>=50&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorA)E.clippedX[L]=E.vertexScreenX[b],E.clippedY[L]=E.vertexScreenY[b],E.clippedColor[L++]=this.faceColorA[_];else if(E.vertexViewSpaceX&&E.vertexViewSpaceY&&this.faceColorA){let T=E.vertexViewSpaceX[b],Y=E.vertexViewSpaceY[b],u=this.faceColorA[_];if(F>=50&&this.faceColorC){let w=(50-I)*h.reciprocal16[F-I];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[N]-T)*w>>16)<<9)/50|0),E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[N]-Y)*w>>16)<<9)/50|0),E.clippedColor[L++]=u+((this.faceColorC[_]-u)*w>>16)}if(k>=50&&this.faceColorB){let w=(50-I)*h.reciprocal16[k-I];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[U]-T)*w>>16)<<9)/50|0),E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[U]-Y)*w>>16)<<9)/50|0),E.clippedColor[L++]=u+((this.faceColorB[_]-u)*w>>16)}}if(k>=50&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorB)E.clippedX[L]=E.vertexScreenX[U],E.clippedY[L]=E.vertexScreenY[U],E.clippedColor[L++]=this.faceColorB[_];else if(E.vertexViewSpaceX&&E.vertexViewSpaceY&&this.faceColorB){let T=E.vertexViewSpaceX[U],Y=E.vertexViewSpaceY[U],u=this.faceColorB[_];if(I>=50&&this.faceColorA){let w=(50-k)*h.reciprocal16[I-k];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[b]-T)*w>>16)<<9)/50|0),E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[b]-Y)*w>>16)<<9)/50|0),E.clippedColor[L++]=u+((this.faceColorA[_]-u)*w>>16)}if(F>=50&&this.faceColorC){let w=(50-k)*h.reciprocal16[F-k];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[N]-T)*w>>16)<<9)/50|0),E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[N]-Y)*w>>16)<<9)/50|0),E.clippedColor[L++]=u+((this.faceColorC[_]-u)*w>>16)}}if(F>=50&&E.vertexScreenX&&E.vertexScreenY&&this.faceColorC)E.clippedX[L]=E.vertexScreenX[N],E.clippedY[L]=E.vertexScreenY[N],E.clippedColor[L++]=this.faceColorC[_];else if(E.vertexViewSpaceX&&E.vertexViewSpaceY&&this.faceColorC){let T=E.vertexViewSpaceX[N],Y=E.vertexViewSpaceY[N],u=this.faceColorC[_];if(k>=50&&this.faceColorB){let w=(50-F)*h.reciprocal16[k-F];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[U]-T)*w>>16)<<9)/50|0),E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[U]-Y)*w>>16)<<9)/50|0),E.clippedColor[L++]=u+((this.faceColorB[_]-u)*w>>16)}if(I>=50&&this.faceColorA){let w=(50-F)*h.reciprocal16[I-F];E.clippedX[L]=O+((T+((E.vertexViewSpaceX[b]-T)*w>>16)<<9)/50|0),E.clippedY[L]=q+((Y+((E.vertexViewSpaceY[b]-Y)*w>>16)<<9)/50|0),E.clippedColor[L++]=u+((this.faceColorA[_]-u)*w>>16)}}}let G=E.clippedX[0],K=E.clippedX[1],Q=E.clippedX[2],H=E.clippedY[0],$=E.clippedY[1],J=E.clippedY[2];if((G-K)*(J-$)-(H-$)*(Q-K)<=0)return;if(h.clipX=!1,L===3){if(G<0||K<0||Q<0||G>j.boundX||K>j.boundX||Q>j.boundX)h.clipX=!0;let O;if(!this.faceInfo)O=0;else O=this.faceInfo[_]&3;if(R)h.drawLine(G,K,H,$,E.clippedColor[0]),h.drawLine(K,Q,$,J,E.clippedColor[1]),h.drawLine(Q,G,J,H,E.clippedColor[2]);else if(O===0)h.fillGouraudTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2]);else if(O===1&&this.faceColorA)h.fillTriangle(G,K,Q,H,$,J,h.palette[this.faceColorA[_]]);else if(O===2&&this.faceInfo&&this.faceColor&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,b=this.texturedVertexA[q],U=this.texturedVertexB[q],N=this.texturedVertexC[q];h.fillTexturedTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2],E.vertexViewSpaceX[b],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[b],E.vertexViewSpaceX[U],E.vertexViewSpaceX[N],E.vertexViewSpaceY[U],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[N],this.faceColor[_])}else if(O===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,b=this.texturedVertexA[q],U=this.texturedVertexB[q],N=this.texturedVertexC[q];h.fillTexturedTriangle(G,K,Q,H,$,J,this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[b],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[b],E.vertexViewSpaceX[U],E.vertexViewSpaceX[N],E.vertexViewSpaceY[U],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[N],this.faceColor[_])}}else if(L===4){if(G<0||K<0||Q<0||G>j.boundX||K>j.boundX||Q>j.boundX||E.clippedX[3]<0||E.clippedX[3]>j.boundX)h.clipX=!0;let O;if(!this.faceInfo)O=0;else O=this.faceInfo[_]&3;if(R)h.drawLine(G,K,H,$,E.clippedColor[0]),h.drawLine(K,Q,$,J,E.clippedColor[1]),h.drawLine(Q,E.clippedX[3],J,E.clippedY[3],E.clippedColor[2]),h.drawLine(E.clippedX[3],G,E.clippedY[3],H,E.clippedColor[3]);else if(O===0)h.fillGouraudTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2]),h.fillGouraudTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],E.clippedColor[0],E.clippedColor[2],E.clippedColor[3]);else if(O===1){if(this.faceColorA){let q=h.palette[this.faceColorA[_]];h.fillTriangle(G,K,Q,H,$,J,q),h.fillTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],q)}}else if(O===2&&this.faceInfo&&this.faceColor&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,b=this.texturedVertexA[q],U=this.texturedVertexB[q],N=this.texturedVertexC[q];h.fillTexturedTriangle(G,K,Q,H,$,J,E.clippedColor[0],E.clippedColor[1],E.clippedColor[2],E.vertexViewSpaceX[b],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[b],E.vertexViewSpaceX[U],E.vertexViewSpaceX[N],E.vertexViewSpaceY[U],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[N],this.faceColor[_]),h.fillTexturedTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],E.clippedColor[0],E.clippedColor[2],E.clippedColor[3],E.vertexViewSpaceX[b],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[b],E.vertexViewSpaceX[U],E.vertexViewSpaceX[N],E.vertexViewSpaceY[U],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[N],this.faceColor[_])}else if(O===3&&this.faceInfo&&this.faceColor&&this.faceColorA&&E.vertexViewSpaceX&&E.vertexViewSpaceY&&E.vertexViewSpaceZ){let q=this.faceInfo[_]>>2,b=this.texturedVertexA[q],U=this.texturedVertexB[q],N=this.texturedVertexC[q];h.fillTexturedTriangle(G,K,Q,H,$,J,this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[b],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[b],E.vertexViewSpaceX[U],E.vertexViewSpaceX[N],E.vertexViewSpaceY[U],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[N],this.faceColor[_]),h.fillTexturedTriangle(G,Q,E.clippedX[3],H,J,E.clippedY[3],this.faceColorA[_],this.faceColorA[_],this.faceColorA[_],E.vertexViewSpaceX[b],E.vertexViewSpaceY[b],E.vertexViewSpaceZ[b],E.vertexViewSpaceX[U],E.vertexViewSpaceX[N],E.vertexViewSpaceY[U],E.vertexViewSpaceY[N],E.vertexViewSpaceZ[U],E.vertexViewSpaceZ[N],this.faceColor[_])}}}applyTransform2(_,R,L,G,K){if(!G)return;let Q=G.length;if(K===0){let H=0;E.baseX=0,E.baseY=0,E.baseZ=0;for(let $=0;$<Q;$++){if(!this.labelVertices)continue;let J=G[$];if(J<this.labelVertices.length){let O=this.labelVertices[J];if(O)for(let q=0;q<O.length;q++){let b=O[q];E.baseX+=this.vertexX[b],E.baseY+=this.vertexY[b],E.baseZ+=this.vertexZ[b],H++}}}if(H>0)E.baseX=(E.baseX/H|0)+_,E.baseY=(E.baseY/H|0)+R,E.baseZ=(E.baseZ/H|0)+L;else E.baseX=_,E.baseY=R,E.baseZ=L}else if(K===1)for(let H=0;H<Q;H++){let $=G[H];if(!this.labelVertices||$>=this.labelVertices.length)continue;let J=this.labelVertices[$];if(J)for(let O=0;O<J.length;O++){let q=J[O];this.vertexX[q]+=_,this.vertexY[q]+=R,this.vertexZ[q]+=L}}else if(K===2)for(let H=0;H<Q;H++){let $=G[H];if(!this.labelVertices||$>=this.labelVertices.length)continue;let J=this.labelVertices[$];if(J)for(let O=0;O<J.length;O++){let q=J[O];this.vertexX[q]-=E.baseX,this.vertexY[q]-=E.baseY,this.vertexZ[q]-=E.baseZ;let b=(_&255)*8,U=(R&255)*8,N=(L&255)*8,I,k;if(N!==0){I=h.sin[N],k=h.cos[N];let F=this.vertexY[q]*I+this.vertexX[q]*k>>16;this.vertexY[q]=this.vertexY[q]*k-this.vertexX[q]*I>>16,this.vertexX[q]=F}if(b!==0){I=h.sin[b],k=h.cos[b];let F=this.vertexY[q]*k-this.vertexZ[q]*I>>16;this.vertexZ[q]=this.vertexY[q]*I+this.vertexZ[q]*k>>16,this.vertexY[q]=F}if(U!==0){I=h.sin[U],k=h.cos[U];let F=this.vertexZ[q]*I+this.vertexX[q]*k>>16;this.vertexZ[q]=this.vertexZ[q]*k-this.vertexX[q]*I>>16,this.vertexX[q]=F}this.vertexX[q]+=E.baseX,this.vertexY[q]+=E.baseY,this.vertexZ[q]+=E.baseZ}}else if(K===3)for(let H=0;H<Q;H++){let $=G[H];if(!this.labelVertices||$>=this.labelVertices.length)continue;let J=this.labelVertices[$];if(J)for(let O=0;O<J.length;O++){let q=J[O];this.vertexX[q]-=E.baseX,this.vertexY[q]-=E.baseY,this.vertexZ[q]-=E.baseZ,this.vertexX[q]=this.vertexX[q]*_/128|0,this.vertexY[q]=this.vertexY[q]*R/128|0,this.vertexZ[q]=this.vertexZ[q]*L/128|0,this.vertexX[q]+=E.baseX,this.vertexY[q]+=E.baseY,this.vertexZ[q]+=E.baseZ}}else if(K===5&&this.labelFaces&&this.faceAlpha)for(let H=0;H<Q;H++){let $=G[H];if($>=this.labelFaces.length)continue;let J=this.labelFaces[$];if(J)for(let O=0;O<J.length;O++){let q=J[O];if(this.faceAlpha[q]+=_*8,this.faceAlpha[q]<0)this.faceAlpha[q]=0;if(this.faceAlpha[q]>255)this.faceAlpha[q]=255}}}calculateBoundsAABB(){this.maxY=0,this.radius=0,this.minY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let _=0;_<this.vertexCount;_++){let R=this.vertexX[_],L=this.vertexY[_],G=this.vertexZ[_];if(R<this.minX)this.minX=R;if(R>this.maxX)this.maxX=R;if(G<this.minZ)this.minZ=G;if(G>this.maxZ)this.maxZ=G;if(-L>this.maxY)this.maxY=-L;if(L>this.minY)this.minY=L;let K=R*R+G*G;if(K>this.radius)this.radius=K}this.radius=Math.sqrt(this.radius)|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0)}pointWithinTriangle(_,R,L,G,K,Q,H,$){if(R<L&&R<G&&R<K)return!1;else if(R>L&&R>G&&R>K)return!1;else if(_<Q&&_<H&&_<$)return!1;else return _<=Q||_<=H||_<=$}drawFaceOutline(_){if(!E.vertexScreenX||!E.vertexScreenY||!this.faceColorA||!this.faceColorB||!this.faceColorC)return;let R=this.faceVertexA[_],L=this.faceVertexB[_],G=this.faceVertexC[_];h.drawLine(E.vertexScreenX[R],E.vertexScreenY[R],E.vertexScreenX[L],E.vertexScreenY[L],h.palette[1000]),h.drawLine(E.vertexScreenX[L],E.vertexScreenY[L],E.vertexScreenX[G],E.vertexScreenY[G],h.palette[1000]),h.drawLine(E.vertexScreenX[G],E.vertexScreenY[G],E.vertexScreenX[R],E.vertexScreenY[R],h.palette[1000])}}class B0 extends n0{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCacheStatic=new s0(500);static modelCacheDynamic=new s0(30);static unpack=(_)=>{this.dat=new p(_.read("loc.dat"));let R=new p(_.read("loc.idx"));this.count=R.g2,this.offsets=new Int32Array(this.count);let L=2;for(let G=0;G<this.count;G++)this.offsets[G]=L,L+=R.g2;this.cache=new l(10,null);for(let G=0;G<10;G++)this.cache[G]=new B0(-1)};static get=(_)=>{if(!this.cache||!this.offsets||!this.dat)throw new Error("LocType not loaded!!!");for(let L=0;L<10;L++){let G=this.cache[L];if(!G)continue;if(G.id===_)return G}this.cachePos=(this.cachePos+1)%10;let R=this.cache[this.cachePos];if(this.dat.pos=this.offsets[_],R.id=_,R.reset(),R.decodeType(this.dat),!R.shapes)R.shapes=new Int32Array(1);if(R.active2===-1&&R.shapes){if(R.active=R.shapes.length>0&&R.shapes[0]===y.CENTREPIECE_STRAIGHT.id,R.op)R.active=!0}return R};models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=!1;active2=-1;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;disposeAlpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;offsetx=0;offsety=0;offsetz=0;forcedecor=!1;decode(_,R){if(_===1){let L=R.g1;this.models=new Int32Array(L),this.shapes=new Int32Array(L);for(let G=0;G<L;G++)this.models[G]=R.g2,this.shapes[G]=R.g1}else if(_===2)this.name=R.gjstr;else if(_===3)this.desc=R.gjstr;else if(_===14)this.width=R.g1;else if(_===15)this.length=R.g1;else if(_===17)this.blockwalk=!1;else if(_===18)this.blockrange=!1;else if(_===19){if(this.active2=R.g1,this.active2===1)this.active=!0}else if(_===21)this.hillskew=!0;else if(_===22)this.sharelight=!0;else if(_===23)this.occlude=!0;else if(_===24){if(this.anim=R.g2,this.anim===65535)this.anim=-1}else if(_===25)this.disposeAlpha=!0;else if(_===28)this.wallwidth=R.g1;else if(_===29)this.ambient=R.g1b;else if(_===39)this.contrast=R.g1b;else if(_>=30&&_<39){if(!this.op)this.op=new l(5,null);if(this.op[_-30]=R.gjstr,this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let L=R.g1;this.recol_s=new Uint16Array(L),this.recol_d=new Uint16Array(L);for(let G=0;G<L;G++)this.recol_s[G]=R.g2,this.recol_d[G]=R.g2}else if(_===60)this.mapfunction=R.g2;else if(_===62)this.mirror=!0;else if(_===64)this.shadow=!1;else if(_===65)this.resizex=R.g2;else if(_===66)this.resizey=R.g2;else if(_===67)this.resizez=R.g2;else if(_===68)this.mapscene=R.g2;else if(_===69)this.forceapproach=R.g1;else if(_===70)this.offsetx=R.g2b;else if(_===71)this.offsety=R.g2b;else if(_===72)this.offsetz=R.g2b;else if(_===73)this.forcedecor=!0}getModel(_,R,L,G,K,Q,H){if(!this.shapes)return null;let $=-1;for(let F=0;F<this.shapes.length;F++)if(this.shapes[F]===_){$=F;break}if($===-1)return null;let J=BigInt(BigInt(this.id)<<6n)+BigInt(BigInt($)<<3n)+BigInt(R)+BigInt(BigInt(H)+1n<<32n),O=B0.modelCacheDynamic?.get(J);if(O){if(this.hillskew||this.sharelight)O=E.modelCopyFaces(O,this.hillskew,this.sharelight);if(this.hillskew){let F=(L+G+K+Q)/4|0;for(let T=0;T<O.vertexCount;T++){let Y=O.vertexX[T],u=O.vertexZ[T],w=L+((G-L)*(Y+64)/128|0),B=Q+((K-Q)*(Y+64)/128|0),v=w+((B-w)*(u+64)/128|0);O.vertexY[T]+=v-F}O.calculateBoundsY()}return O}if(!this.models)return null;if($>=this.models.length)return null;let q=this.models[$];if(q===-1)return null;let b=this.mirror!==R>3;if(b)q+=65536;let U=B0.modelCacheStatic?.get(BigInt(q));if(!U){if(U=E.model(q&65535),b)U.rotateY180();B0.modelCacheStatic?.put(BigInt(q),U)}let N=this.resizex!==128||this.resizey!==128||this.resizez!==128,I=this.offsetx!==0||this.offsety!==0||this.offsetz!==0,k=E.modelShareColored(U,!this.recol_s,!this.disposeAlpha,R===x.WEST&&H===-1&&!N&&!I);if(H!==-1)k.createLabelReferences(),k.applyTransform(H),k.labelFaces=null,k.labelVertices=null;while(R-- >0)k.rotateY90();if(this.recol_s&&this.recol_d)for(let F=0;F<this.recol_s.length;F++)k.recolor(this.recol_s[F],this.recol_d[F]);if(N)k.scale(this.resizex,this.resizey,this.resizez);if(I)k.translate(this.offsety,this.offsetx,this.offsetz);if(k.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight),this.blockwalk)k.objRaise=k.maxY;if(B0.modelCacheDynamic?.put(J,k),this.hillskew||this.sharelight)k=E.modelCopyFaces(k,this.hillskew,this.sharelight);if(this.hillskew){let F=(L+G+K+Q)/4|0;for(let T=0;T<k.vertexCount;T++){let Y=k.vertexX[T],u=k.vertexZ[T],w=L+((G-L)*(Y+64)/128|0),B=Q+((K-Q)*(Y+64)/128|0),v=w+((B-w)*(u+64)/128|0);k.vertexY[T]+=v-F}k.calculateBoundsY()}return k}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=!1,this.active2=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.disposeAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1}}class X{static RED=16711680;static GREEN=65280;static BLUE=255;static YELLOW=16776960;static CYAN=65535;static MAGENTA=16711935;static WHITE=16777215;static BLACK=0;static LIGHTRED=16748608;static DARKRED=8388608;static DARKBLUE=128;static ORANGE1=16756736;static ORANGE2=16740352;static ORANGE3=16723968;static GREEN1=12648192;static GREEN2=8453888;static GREEN3=4259584;static PROGRESS_RED=9179409;static OPTIONS_MENU=6116423;static SCROLLBAR_TRACK=2301979;static SCROLLBAR_GRIP_FOREGROUND=5063219;static SCROLLBAR_GRIP_HIGHLIGHT=7759444;static SCROLLBAR_GRIP_LOWLIGHT=3353893;static TRADE_MESSAGE=8388736;static DUEL_MESSAGE=13350793;static CHAT_COLORS=Int32Array.of(X.YELLOW,X.RED,X.GREEN,X.CYAN,X.MAGENTA,X.WHITE);static HAIR_DARK_BROWN=6798;static HAIR_WHITE=107;static HAIR_LIGHT_GREY=10283;static HAIR_DARK_GREY=16;static HAIR_APRICOT=4797;static HAIR_STRAW=7744;static HAIR_LIGHT_BROWN=5799;static HAIR_BROWN=4634;static HAIR_TURQUOISE=33697;static HAIR_GREEN=22433;static HAIR_GINGER=2983;static HAIR_MAGENTA=54193;static BODY_KHAKI=8741;static BODY_CHARCOAL=12;static BODY_CRIMSON=64030;static BODY_NAVY=43162;static BODY_STRAW=7735;static BODY_WHITE=8404;static BODY_RED=1701;static BODY_BLUE=38430;static BODY_GREEN=24094;static BODY_YELLOW=10153;static BODY_PURPLE=56621;static BODY_ORANGE=4783;static BODY_ROSE=1341;static BODY_LIME=16578;static BODY_CYAN=35003;static BODY_EMERALD=25239;static BODY_RECOLOR_KHAKI=9104;static BODY_RECOLOR_CHARCOAL=10275;static BODY_RECOLOR_CRIMSON=7595;static BODY_RECOLOR_NAVY=3610;static BODY_RECOLOR_STRAW=7975;static BODY_RECOLOR_WHITE=8526;static BODY_RECOLOR_RED=918;static BODY_RECOLOR_BLUE=38802;static BODY_RECOLOR_GREEN=24466;static BODY_RECOLOR_YELLOW=10145;static BODY_RECOLOR_PURPLE=58654;static BODY_RECOLOR_ORANGE=5027;static BODY_RECOLOR_ROSE=1457;static BODY_RECOLOR_LIME=16565;static BODY_RECOLOR_CYAN=34991;static BODY_RECOLOR_EMERALD=25486;static FEET_BROWN=4626;static FEET_KHAKI=11146;static FEET_ASHEN=6439;static FEET_DARK=12;static FEET_TERRACOTTA=4758;static FEET_GREY=10270;static SKIN=4574;static SKIN_DARKER=4550;static SKIN_DARKER_DARKER=4537;static SKIN_DARKER_DARKER_DARKER=5681;static SKIN_DARKER_DARKER_DARKER_DARKER=5673;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER=5790;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER=6806;static SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER=8076}var I6=async(_)=>{if(_[0]!==255)_[0]=255;URL.revokeObjectURL(A1.src),A1.src=URL.createObjectURL(new Blob([_],{type:"image/jpeg"})),await new Promise((G)=>A1.onload=()=>G()),k8.clearRect(0,0,D1.width,D1.height);let R=A1.naturalWidth,L=A1.naturalHeight;return D1.width=R,D1.height=L,k8.drawImage(A1,0,0),k8.getImageData(0,0,R,L)};class V0 extends x0{pixels;width;height;cropX;cropY;cropW;cropH;constructor(_,R){super();this.pixels=new Int32Array(_*R),this.width=this.cropW=_,this.height=this.cropH=R,this.cropX=this.cropY=0}static fromJpeg=async(_,R)=>{let L=_.read(R+".dat");if(!L)throw new Error(`${R} jpeg not found!`);let G=await I6(L),K=new V0(G.width,G.height),Q=new Uint32Array(G.data.buffer),H=K.pixels;for(let $=0;$<H.length;$++){let J=Q[$];H[$]=(J>>24&255)<<24|(J&255)<<16|(J>>8&255)<<8|J>>16&255}return K};static fromArchive=(_,R,L=0)=>{let G=new p(_.read(R+".dat")),K=new p(_.read("index.dat"));K.pos=G.g2;let{g2:Q,g2:H,g1:$}=K,J=[],O=$-1;for(let F=0;F<O;F++)if(J[F+1]=K.g3,J[F+1]===0)J[F+1]=1;for(let F=0;F<L;F++)K.pos+=2,G.pos+=K.g2*K.g2,K.pos+=1;if(G.pos>G.length||K.pos>K.length)throw new Error;let{g1:q,g1:b,g2:U,g2:N}=K,I=new V0(U,N);I.cropX=q,I.cropY=b,I.cropW=Q,I.cropH=H;let k=K.g1;if(k===0){let F=I.width*I.height;for(let T=0;T<F;T++)I.pixels[T]=J[G.g1]}else if(k===1){let F=I.width;for(let T=0;T<F;T++){let Y=I.height;for(let u=0;u<Y;u++)I.pixels[T+u*F]=J[G.g1]}}return I};bind(){j.bind(this.pixels,this.width,this.height)}draw(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let L=_+R*j.width2d,G=0,K=this.height,Q=this.width,H=j.width2d-Q,$=0;if(R<j.top){let J=j.top-R;K-=J,R=j.top,G+=J*Q,L+=J*j.width2d}if(R+K>j.bottom)K-=R+K-j.bottom;if(_<j.left){let J=j.left-_;Q-=J,_=j.left,G+=J,L+=J,$+=J,H+=J}if(_+Q>j.right){let J=_+Q-j.right;Q-=J,$+=J,H+=J}if(Q>0&&K>0)this.copyImageDraw(Q,K,this.pixels,G,$,j.pixels,L,H)}drawAlpha(_,R,L){R|=0,L|=0,R+=this.cropX,L+=this.cropY;let G=R+L*j.width2d,K=0,Q=this.height,H=this.width,$=j.width2d-H,J=0;if(L<j.top){let O=j.top-L;Q-=O,L=j.top,K+=O*H,G+=O*j.width2d}if(L+Q>j.bottom)Q-=L+Q-j.bottom;if(R<j.left){let O=j.left-R;H-=O,R=j.left,K+=O,G+=O,J+=O,$+=O}if(R+H>j.right){let O=R+H-j.right;H-=O,J+=O,$+=O}if(H>0&&Q>0)this.copyPixelsAlpha(H,Q,this.pixels,K,J,j.pixels,G,$,_)}blitOpaque(_,R){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let L=_+R*j.width2d,G=0,K=this.height,Q=this.width,H=j.width2d-Q,$=0;if(R<j.top){let J=j.top-R;K-=J,R=j.top,G+=J*Q,L+=J*j.width2d}if(R+K>j.bottom)K-=R+K-j.bottom;if(_<j.left){let J=j.left-_;Q-=J,_=j.left,G+=J,L+=J,$+=J,H+=J}if(_+Q>j.right){let J=_+Q-j.right;Q-=J,$+=J,H+=J}if(Q>0&&K>0)this.copyImageBlitOpaque(Q,K,this.pixels,G,$,j.pixels,L,H)}flipHorizontally(){let _=this.pixels,R=this.width,L=this.height;for(let G=0;G<L;G++){let K=R/2|0;for(let Q=0;Q<K;Q++){let H=Q+G*R,$=R-Q-1+G*R,J=_[H];_[H]=_[$],_[$]=J}}}flipVertically(){let _=this.pixels,R=this.width,L=this.height;for(let G=0;G<(L/2|0);G++)for(let K=0;K<R;K++){let Q=K+G*R,H=K+(L-G-1)*R,$=_[Q];_[Q]=_[H],_[H]=$}}translate(_,R,L){for(let G=0;G<this.pixels.length;G++){let K=this.pixels[G];if(K!==0){let Q=K>>16&255;if(Q+=_,Q<1)Q=1;else if(Q>255)Q=255;let H=K>>8&255;if(H+=R,H<1)H=1;else if(H>255)H=255;let $=K&255;if($+=L,$<1)$=1;else if($>255)$=255;this.pixels[G]=(Q<<16)+(H<<8)+$}}}crop(_,R,L,G){_|=0,R|=0,L|=0,G|=0;try{let K=this.width,Q=0,H=0,$=this.cropW,J=this.cropH,O=($<<16)/L|0,q=(J<<16)/G|0;if(_+=(this.cropX*L+$-1)/$|0,R+=(this.cropY*G+J-1)/J|0,this.cropX*L%$!==0)Q=($-this.cropX*L%$<<16)/L|0;if(this.cropY*G%J!==0)H=(J-this.cropY*G%J<<16)/G|0;L=L*(this.width-(Q>>16))/$|0,G=G*(this.height-(H>>16))/J|0;let b=_+R*j.width2d,U=j.width2d-L;if(R<j.top){let N=j.top-R;G-=N,R=0,b+=N*j.width2d,H+=q*N}if(R+G>j.bottom)G-=R+G-j.bottom;if(_<j.left){let N=j.left-_;L-=N,_=0,b+=N,Q+=O*N,U+=N}if(_+L>j.right){let N=_+L-j.right;L-=N,U+=N}this.scale(L,G,this.pixels,Q,H,j.pixels,U,b,K,O,q)}catch(K){}}drawRotatedMasked(_,R,L,G,K,Q,H,$,J,O){_|=0,R|=0,L|=0,G|=0;try{let q=-L/2|0,b=-G/2|0,U=Math.sin(J/326.11)*65536|0,N=Math.cos(J/326.11)*65536|0,I=U*O>>8,k=N*O>>8,F=(H<<16)+b*I+q*k,T=($<<16)+(b*k-q*I),Y=_+R*j.width2d;for(let u=0;u<G;u++){let w=K[u],B=Y+w,v=F+k*w,n=T-I*w;for(let W=-Q[u];W<0;W++)j.pixels[B++]=this.pixels[(v>>16)+(n>>16)*this.width],v+=k,n-=I;F+=I,T+=k,Y+=j.width2d}}catch(q){}}drawMasked(_,R,L){_|=0,R|=0,_+=this.cropX,R+=this.cropY;let G=_+R*j.width2d,K=0,Q=this.height,H=this.width,$=j.width2d-H,J=0;if(R<j.top){let O=j.top-R;Q-=O,R=j.top,K+=O*H,G+=O*j.width2d}if(R+Q>j.bottom)Q-=R+Q-j.bottom;if(_<j.left){let O=j.left-_;H-=O,_=j.left,K+=O,G+=O,J+=O,$+=O}if(_+H>j.right){let O=_+H-j.right;H-=O,J+=O,$+=O}if(H>0&&Q>0)this.copyPixelsMasked(H,Q,this.pixels,J,K,j.pixels,G,$,L.pixels)}scale(_,R,L,G,K,Q,H,$,J,O,q){try{let b=G;for(let U=-R;U<0;U++){let N=(K>>16)*J;for(let I=-_;I<0;I++){let k=L[(G>>16)+N];if(k===0)$++;else Q[$++]=k;G+=O}K+=q,G=b,$+=H}}catch(b){}}copyImageBlitOpaque(_,R,L,G,K,Q,H,$){let J=-(_>>2);_=-(_&3);for(let O=-R;O<0;O++){for(let q=J;q<0;q++)Q[H++]=L[G++],Q[H++]=L[G++],Q[H++]=L[G++],Q[H++]=L[G++];for(let q=_;q<0;q++)Q[H++]=L[G++];H+=$,G+=K}}copyPixelsAlpha(_,R,L,G,K,Q,H,$,J){let O=256-J;for(let q=-R;q<0;q++){for(let b=-_;b<0;b++){let U=L[G++];if(U===0)H++;else{let N=Q[H];Q[H++]=((U&16711935)*J+(N&16711935)*O&4278255360)+((U&65280)*J+(N&65280)*O&16711680)>>8}}H+=$,G+=K}}copyImageDraw(_,R,L,G,K,Q,H,$){let J=-(_>>2);_=-(_&3);for(let O=-R;O<0;O++){for(let q=J;q<0;q++){let b=L[G++];if(b===0)H++;else Q[H++]=b;if(b=L[G++],b===0)H++;else Q[H++]=b;if(b=L[G++],b===0)H++;else Q[H++]=b;if(b=L[G++],b===0)H++;else Q[H++]=b}for(let q=_;q<0;q++){let b=L[G++];if(b===0)H++;else Q[H++]=b}H+=$,G+=K}}copyPixelsMasked(_,R,L,G,K,Q,H,$,J){let O=-(_>>2);_=-(_&3);for(let q=-R;q<0;q++){for(let b=O;b<0;b++){let U=L[K++];if(U!==0&&J[H]===0)Q[H++]=U;else H++;if(U=L[K++],U!==0&&J[H]===0)Q[H++]=U;else H++;if(U=L[K++],U!==0&&J[H]===0)Q[H++]=U;else H++;if(U=L[K++],U!==0&&J[H]===0)Q[H++]=U;else H++}for(let b=_;b<0;b++){let U=L[K++];if(U!==0&&J[H]===0)Q[H++]=U;else H++}H+=$,K+=G}}}class Y0 extends n0{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static membersWorld=!0;static modelCache=new s0(50);static iconCache=new s0(200);static unpack=(_,R)=>{this.membersWorld=R,this.dat=new p(_.read("obj.dat"));let L=new p(_.read("obj.idx"));this.count=L.g2,this.offsets=new Int32Array(this.count);let G=2;for(let K=0;K<this.count;K++)this.offsets[K]=G,G+=L.g2;this.cache=new l(10,null);for(let K=0;K<10;K++)this.cache[K]=new Y0(-1)};static get=(_)=>{if(!this.cache||!this.offsets||!this.dat)throw new Error("ObjType not loaded!!!");for(let L=0;L<10;L++){let G=this.cache[L];if(!G)continue;if(G.id===_)return G}this.cachePos=(this.cachePos+1)%10;let R=this.cache[this.cachePos];if(this.dat.pos=this.offsets[_],R.id=_,R.reset(),R.decodeType(this.dat),R.certtemplate!==-1)R.toCertificate();if(!this.membersWorld&&R.members)R.name="Members Object",R.desc="Login to a members' server to use this object.",R.op=null,R.iop=null;return R};static getIcon=(_,R)=>{if(Y0.iconCache){let T=Y0.iconCache.get(BigInt(_));if(T&&T.cropH!==R&&T.cropH!==-1)T.unlink(),T=null;if(T)return T}let L=Y0.get(_);if(!L.countobj)R=-1;if(L.countobj&&L.countco&&R>1){let T=-1;for(let Y=0;Y<10;Y++)if(R>=L.countco[Y]&&L.countco[Y]!==0)T=L.countobj[Y];if(T!==-1)L=Y0.get(T)}let G=new V0(32,32),K=h.centerX,Q=h.centerY,H=h.lineOffset,$=j.pixels,J=j.width2d,O=j.height2d,q=j.left,b=j.right,U=j.top,N=j.bottom;h.jagged=!1,j.bind(G.pixels,32,32),j.fillRect(0,0,32,32,X.BLACK),h.init2D();let I=L.getInterfaceModel(1),k=h.sin[L.xan2d]*L.zoom2d>>16,F=h.cos[L.xan2d]*L.zoom2d>>16;I.drawSimple(0,L.yan2d,L.zan2d,L.xan2d,L.xof2d,k+(I.maxY/2|0)+L.yof2d,F+L.yof2d);for(let T=31;T>=0;T--)for(let Y=31;Y>=0;Y--){if(G.pixels[T+Y*32]!==0)continue;if(T>0&&G.pixels[T+Y*32-1]>1)G.pixels[T+Y*32]=1;else if(Y>0&&G.pixels[T+(Y-1)*32]>1)G.pixels[T+Y*32]=1;else if(T<31&&G.pixels[T+Y*32+1]>1)G.pixels[T+Y*32]=1;else if(Y<31&&G.pixels[T+(Y+1)*32]>1)G.pixels[T+Y*32]=1}for(let T=31;T>=0;T--)for(let Y=31;Y>=0;Y--)if(G.pixels[T+Y*32]===0&&T>0&&Y>0&&G.pixels[T+(Y-1)*32-1]>0)G.pixels[T+Y*32]=3153952;if(L.certtemplate!==-1){let T=this.getIcon(L.certlink,10),Y=T.cropW,u=T.cropH;T.cropW=32,T.cropH=32,T.crop(5,5,22,22),T.cropW=Y,T.cropH=u}if(Y0.iconCache?.put(BigInt(_),G),j.bind($,J,O),j.setBounds(q,U,b,N),h.centerX=K,h.centerY=Q,h.lineOffset=H,h.jagged=!0,L.stackable)G.cropW=33;else G.cropW=32;return G.cropH=R,G};model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;decode(_,R){if(_===1)this.model=R.g2;else if(_===2)this.name=R.gjstr;else if(_===3)this.desc=R.gjstr;else if(_===4)this.zoom2d=R.g2;else if(_===5)this.xan2d=R.g2;else if(_===6)this.yan2d=R.g2;else if(_===7){if(this.xof2d=R.g2b,this.xof2d>32767)this.xof2d-=65536}else if(_===8){if(this.yof2d=R.g2b,this.yof2d>32767)this.yof2d-=65536}else if(_===9)this.code9=!0;else if(_===10)this.code10=R.g2;else if(_===11)this.stackable=!0;else if(_===12)this.cost=R.g4;else if(_===16)this.members=!0;else if(_===23)this.manwear=R.g2,this.manwearOffsetY=R.g1b;else if(_===24)this.manwear2=R.g2;else if(_===25)this.womanwear=R.g2,this.womanwearOffsetY=R.g1b;else if(_===26)this.womanwear2=R.g2;else if(_>=30&&_<35){if(!this.op)this.op=new l(5,null);if(this.op[_-30]=R.gjstr,this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_>=35&&_<40){if(!this.iop)this.iop=new l(5,null);this.iop[_-35]=R.gjstr}else if(_===40){let L=R.g1;this.recol_s=new Uint16Array(L),this.recol_d=new Uint16Array(L);for(let G=0;G<L;G++)this.recol_s[G]=R.g2,this.recol_d[G]=R.g2}else if(_===78)this.manwear3=R.g2;else if(_===79)this.womanwear3=R.g2;else if(_===90)this.manhead=R.g2;else if(_===91)this.womanhead=R.g2;else if(_===92)this.manhead2=R.g2;else if(_===93)this.womanhead2=R.g2;else if(_===95)this.zan2d=R.g2;else if(_===97)this.certlink=R.g2;else if(_===98)this.certtemplate=R.g2;else if(_>=100&&_<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[_-100]=R.g2,this.countco[_-100]=R.g2}}getWornModel(_){let R=this.manwear;if(_===1)R=this.womanwear;if(R===-1)return null;let L=this.manwear2,G=this.manwear3;if(_===1)L=this.womanwear2,G=this.womanwear3;let K=E.model(R);if(L!==-1){let Q=E.model(L);if(G===-1){let H=[K,Q];K=E.modelFromModels(H,2)}else{let H=E.model(G),$=[K,Q,H];K=E.modelFromModels($,3)}}if(_===0&&this.manwearOffsetY!==0)K.translate(this.manwearOffsetY,0,0);if(_===1&&this.womanwearOffsetY!==0)K.translate(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let Q=0;Q<this.recol_s.length;Q++)K.recolor(this.recol_s[Q],this.recol_d[Q]);return K}getHeadModel(_){let R=this.manhead;if(_===1)R=this.womanhead;if(R===-1)return null;let L=this.manhead2;if(_===1)L=this.womanhead2;let G=E.model(R);if(L!==-1){let K=E.model(L),Q=[G,K];G=E.modelFromModels(Q,2)}if(this.recol_s&&this.recol_d)for(let K=0;K<this.recol_s.length;K++)G.recolor(this.recol_s[K],this.recol_d[K]);return G}getInterfaceModel(_){if(this.countobj&&this.countco&&_>1){let L=-1;for(let G=0;G<10;G++)if(_>=this.countco[G]&&this.countco[G]!==0)L=this.countobj[G];if(L!==-1)return Y0.get(L).getInterfaceModel(1)}if(Y0.modelCache){let L=Y0.modelCache.get(BigInt(this.id));if(L)return L}let R=E.model(this.model);if(this.recol_s&&this.recol_d)for(let L=0;L<this.recol_s.length;L++)R.recolor(this.recol_s[L],this.recol_d[L]);return R.calculateNormals(64,768,-50,-10,-50,!0),R.pickable=!0,Y0.modelCache?.put(BigInt(this.id),R),R}toCertificate(){let _=Y0.get(this.certtemplate);this.model=_.model,this.zoom2d=_.zoom2d,this.xan2d=_.xan2d,this.yan2d=_.yan2d,this.zan2d=_.zan2d,this.xof2d=_.xof2d,this.yof2d=_.yof2d,this.recol_s=_.recol_s,this.recol_d=_.recol_d;let R=Y0.get(this.certlink);this.name=R.name,this.members=R.members,this.cost=R.cost;let L="a",G=(R.name||"").toLowerCase().charAt(0);if(G==="a"||G==="e"||G==="i"||G==="o"||G==="u")L="an";this.desc=`Swap this note at any bank for ${L} ${R.name}.`,this.stackable=!0}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2000,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1}}class _1 extends n0{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCache=new s0(30);static unpack=(_)=>{this.dat=new p(_.read("npc.dat"));let R=new p(_.read("npc.idx"));this.count=R.g2,this.offsets=new Int32Array(this.count);let L=2;for(let G=0;G<this.count;G++)this.offsets[G]=L,L+=R.g2;this.cache=new l(20,null);for(let G=0;G<20;G++)this.cache[G]=new _1(-1)};static get=(_)=>{if(!this.cache||!this.offsets||!this.dat)throw new Error("NpcType not loaded!!!");for(let L=0;L<20;L++){let G=this.cache[L];if(!G)continue;if(G.id===_)return G}this.cachePos=(this.cachePos+1)%20;let R=this.cache[this.cachePos]=new _1(_);return this.dat.pos=this.offsets[_],R.decodeType(this.dat),R};name=null;desc=null;size=1;models=null;heads=null;disposeAlpha=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;decode(_,R){if(_===1){let L=R.g1;this.models=new Uint16Array(L);for(let G=0;G<L;G++)this.models[G]=R.g2}else if(_===2)this.name=R.gjstr;else if(_===3)this.desc=R.gjstr;else if(_===12)this.size=R.g1b;else if(_===13)this.readyanim=R.g2;else if(_===14)this.walkanim=R.g2;else if(_===16)this.disposeAlpha=!0;else if(_===17)this.walkanim=R.g2,this.walkanim_b=R.g2,this.walkanim_r=R.g2,this.walkanim_l=R.g2;else if(_>=30&&_<40){if(!this.op)this.op=new l(5,null);if(this.op[_-30]=R.gjstr,this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let L=R.g1;this.recol_s=new Uint16Array(L),this.recol_d=new Uint16Array(L);for(let G=0;G<L;G++)this.recol_s[G]=R.g2,this.recol_d[G]=R.g2}else if(_===60){let L=R.g1;this.heads=new Uint16Array(L);for(let G=0;G<L;G++)this.heads[G]=R.g2}else if(_===90)this.resizex=R.g2;else if(_===91)this.resizey=R.g2;else if(_===92)this.resizez=R.g2;else if(_===93)this.minimap=!1;else if(_===95)this.vislevel=R.g2;else if(_===97)this.resizeh=R.g2;else if(_===98)this.resizev=R.g2}getSequencedModel(_,R,L){let G=null,K=null;if(_1.modelCache){if(K=_1.modelCache.get(BigInt(this.id)),!K&&this.models){let Q=new l(this.models.length,null);for(let H=0;H<this.models.length;H++)Q[H]=E.model(this.models[H]);if(Q.length===1)K=Q[0];else K=E.modelFromModels(Q,Q.length);if(this.recol_s&&this.recol_d)for(let H=0;H<this.recol_s.length;H++)K?.recolor(this.recol_s[H],this.recol_d[H]);if(K?.createLabelReferences(),K?.calculateNormals(64,850,-30,-50,-30,!0),K)_1.modelCache.put(BigInt(this.id),K)}}if(K){if(G=E.modelShareAlpha(K,!this.disposeAlpha),_!==-1&&R!==-1)G.applyTransforms(_,R,L);else if(_!==-1)G.applyTransform(_);if(this.resizeh!==128||this.resizev!==128)G.scale(this.resizeh,this.resizev,this.resizeh);if(G.calculateBoundsCylinder(),G.labelFaces=null,G.labelVertices=null,this.size===1)G.pickable=!0;return G}return null}getHeadModel(){if(!this.heads)return null;let _=new l(this.heads.length,null);for(let L=0;L<this.heads.length;L++)_[L]=E.model(this.heads[L]);let R;if(_.length===1)R=_[0];else R=E.modelFromModels(_,_.length);if(this.recol_s&&this.recol_d)for(let L=0;L<this.recol_s.length;L++)R?.recolor(this.recol_s[L],this.recol_d[L]);return R}}class i0 extends n0{static count=0;static instances=[];static unpack=(_)=>{let R=new p(_.read("idk.dat"));this.count=R.g2;for(let L=0;L<this.count;L++)this.instances[L]=new i0(L).decodeType(R)};type=-1;models=null;heads=new Int32Array(5).fill(-1);recol_s=new Int32Array(6);recol_d=new Int32Array(6);disable=!1;decode(_,R){if(_===1)this.type=R.g1;else if(_===2){let L=R.g1;this.models=new Int32Array(L);for(let G=0;G<L;G++)this.models[G]=R.g2}else if(_===3)this.disable=!0;else if(_>=40&&_<50)this.recol_s[_-40]=R.g2;else if(_>=50&&_<60)this.recol_d[_-50]=R.g2;else if(_>=60&&_<70)this.heads[_-60]=R.g2}getModel(){if(!this.models)return null;let _=new l(this.models.length,null);for(let L=0;L<this.models.length;L++)_[L]=E.model(this.models[L]);let R;if(_.length===1)R=_[0];else R=E.modelFromModels(_,_.length);for(let L=0;L<6&&this.recol_s[L]!==0;L++)R?.recolor(this.recol_s[L],this.recol_d[L]);return R}getHeadModel(){let _=0,R=new l(5,null);for(let G=0;G<5;G++)if(this.heads[G]!==-1)R[_++]=E.model(this.heads[G]);let L=E.modelFromModels(R,_);for(let G=0;G<6&&this.recol_s[G]!==0;G++)L.recolor(this.recol_s[G],this.recol_d[G]);return L}}class p0 extends n0{static count=0;static instances=[];static modelCache=new s0(30);static unpack=(_)=>{let R=new p(_.read("spotanim.dat"));this.count=R.g2;for(let L=0;L<this.count;L++)this.instances[L]=new p0(L).decodeType(R)};model=0;anim=-1;seq=null;disposeAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(_,R){if(_===1)this.model=R.g2;else if(_===2){if(this.anim=R.g2,_0.instances)this.seq=_0.instances[this.anim]}else if(_===3)this.disposeAlpha=!0;else if(_===4)this.resizeh=R.g2;else if(_===5)this.resizev=R.g2;else if(_===6)this.orientation=R.g2;else if(_===7)this.ambient=R.g1;else if(_===8)this.contrast=R.g1;else if(_>=40&&_<50)this.recol_s[_-40]=R.g2;else if(_>=50&&_<60)this.recol_d[_-50]=R.g2}getModel(){let _=p0.modelCache?.get(BigInt(this.id));if(_)return _;_=E.model(this.model);for(let R=0;R<6;R++)if(this.recol_s[0]!==0)_.recolor(this.recol_s[R],this.recol_d[R]);return p0.modelCache?.put(BigInt(this.id),_),_}}class F1 extends n0{static count=0;static instances=[];static code3=[];static code3Count=0;static unpack=(_)=>{let R=new p(_.read("varp.dat"));this.count=R.g2;for(let L=0;L<this.count;L++)this.instances[L]=new F1(L).decodeType(R)};scope=0;type=0;code3=!1;protect=!0;clientcode=0;code7=0;transmit=!1;code8=!1;decode(_,R){if(_===1)this.scope=R.g1;else if(_===2)this.type=R.g1;else if(_===3)this.code3=!0,F1.code3[F1.code3Count++]=this.id;else if(_===4)this.protect=!1;else if(_===5)this.clientcode=R.g2;else if(_===6)this.transmit=!0;else if(_===7)this.code7=R.g4;else if(_===8)this.code8=!0;else if(_===10)this.debugname=R.gjstr}}class I0{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37=(_)=>{_=_.trim();let R=0n;for(let L=0;L<_.length&&L<12;L++){let G=_.charCodeAt(L);if(R*=37n,G>=65&&G<=90)R+=BigInt(G+1-65);else if(G>=97&&G<=122)R+=BigInt(G+1-97);else if(G>=48&&G<=57)R+=BigInt(G+27-48)}return R};static fromBase37=(_)=>{if(_<0n||_>=6582952005840035281n)return"invalid_name";if(_%37n===0n)return"invalid_name";let R=0,L=Array(12);while(_!==0n){let G=_;_/=37n,L[11-R++]=this.BASE37_LOOKUP[Number(G-_*37n)]}return L.slice(12-R).join("")};static toSentenceCase=(_)=>{let R=[..._.toLowerCase()],L=!0;for(let G=0;G<R.length;G++){let K=R[G];if(L&&K>="a"&&K<="z")R[G]=K.toUpperCase(),L=!1;if(K==="."||K==="!")L=!0}return R.join("")};static toAsterisks=(_)=>{let R="";for(let L=0;L<_.length;L++)R=R+"*";return R};static formatIPv4=(_)=>{return(_>>24&255)+"."+(_>>16&255)+"."+(_>>8&255)+"."+(_&255)};static formatName=(_)=>{if(_.length===0)return _;let R=[..._];for(let L=0;L<R.length;L++)if(R[L]==="_"){if(R[L]=" ",L+1<R.length&&R[L+1]>="a"&&R[L+1]<="z")R[L+1]=String.fromCharCode(R[L+1].charCodeAt(0)+65-97)}if(R[0]>="a"&&R[0]<="z")R[0]=String.fromCharCode(R[0].charCodeAt(0)+65-97);return R.join("")};static hashCode=(_)=>{let R=_.toUpperCase(),L=0n;for(let G=0;G<R.length;G++)L=L*61n+BigInt(R.charCodeAt(G))-32n,L=L+(L>>56n)&0xffffffffffffffn;return L}}class g{static instances=[];static imageCache=null;static modelCache=null;static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INV=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_GRAPHIC=5;static TYPE_MODEL=6;static TYPE_INV_TEXT=7;static BUTTON_OK=1;static BUTTON_TARGET=2;static BUTTON_CLOSE=3;static BUTTON_TOGGLE=4;static BUTTON_SELECT=5;static BUTTON_CONTINUE=6;static CC_FRIENDS_START=1;static CC_FRIENDS_END=100;static CC_FRIENDS_UPDATE_START=101;static CC_FRIENDS_UPDATE_END=200;static CC_ADD_FRIEND=201;static CC_DEL_FRIEND=202;static CC_FRIENDS_SIZE=203;static CC_LOGOUT=205;static CC_CHANGE_HEAD_L=300;static CC_CHANGE_HEAD_R=301;static CC_CHANGE_JAW_L=302;static CC_CHANGE_JAW_R=303;static CC_CHANGE_TORSO_L=304;static CC_CHANGE_TORSO_R=305;static CC_CHANGE_ARMS_L=306;static CC_CHANGE_ARMS_R=307;static CC_CHANGE_HANDS_L=308;static CC_CHANGE_HANDS_R=309;static CC_CHANGE_LEGS_L=310;static CC_CHANGE_LEGS_R=311;static CC_CHANGE_FEET_L=312;static CC_CHANGE_FEET_R=313;static CC_RECOLOUR_HAIR_L=314;static CC_RECOLOUR_HAIR_R=315;static CC_RECOLOUR_TORSO_L=316;static CC_RECOLOUR_TORSO_R=317;static CC_RECOLOUR_LEGS_L=318;static CC_RECOLOUR_LEGS_R=319;static CC_RECOLOUR_FEET_L=320;static CC_RECOLOUR_FEET_R=321;static CC_RECOLOUR_SKIN_L=322;static CC_RECOLOUR_SKIN_R=323;static CC_SWITCH_TO_MALE=324;static CC_SWITCH_TO_FEMALE=325;static CC_ACCEPT_DESIGN=326;static CC_DESIGN_PREVIEW=327;static CC_IGNORES_START=401;static CC_IGNORES_END=500;static CC_ADD_IGNORE=501;static CC_DEL_IGNORE=502;static CC_IGNORES_SIZE=503;static CC_REPORT_INPUT=600;static CC_REPORT_RULE1=601;static CC_REPORT_RULE2=602;static CC_REPORT_RULE3=603;static CC_REPORT_RULE4=604;static CC_REPORT_RULE5=605;static CC_REPORT_RULE6=606;static CC_REPORT_RULE7=607;static CC_REPORT_RULE8=608;static CC_REPORT_RULE9=609;static CC_REPORT_RULE10=610;static CC_REPORT_RULE11=611;static CC_REPORT_RULE12=612;static CC_MOD_MUTE=613;static CC_LAST_LOGIN_INFO=650;static CC_UNREAD_MESSAGES=651;static CC_RECOVERY1=652;static CC_RECOVERY2=653;static CC_RECOVERY3=654;static CC_LAST_LOGIN_INFO2=655;static unpack=(_,R,L)=>{this.imageCache=new s0(50000),this.modelCache=new s0(50000);let G=new p(_.read("data")),K=-1;G.pos+=2;while(G.pos<G.length){let Q=G.g2;if(Q===65535)K=G.g2,Q=G.g2;let H=this.instances[Q]=new g;if(H.id=Q,H.layer=K,H.type=G.g1,H.buttonType=G.g1,H.clientCode=G.g2,H.width=G.g2,H.height=G.g2,H.overLayer=G.g1,H.overLayer===0)H.overLayer=-1;else H.overLayer=(H.overLayer-1<<8)+G.g1;let $=G.g1;if($>0){H.scriptComparator=new Uint8Array($),H.scriptOperand=new Uint16Array($);for(let O=0;O<$;O++)H.scriptComparator[O]=G.g1,H.scriptOperand[O]=G.g2}let J=G.g1;if(J>0){H.scripts=new l(J,null);for(let O=0;O<J;O++){let q=G.g2,b=new Uint16Array(q);H.scripts[O]=b;for(let U=0;U<q;U++)b[U]=G.g2}}if(H.type===g.TYPE_LAYER){H.scroll=G.g2,H.hide=G.g1===1;let O=G.g1;H.childId=new Array(O),H.childX=new Array(O),H.childY=new Array(O);for(let q=0;q<O;q++)H.childId[q]=G.g2,H.childX[q]=G.g2b,H.childY[q]=G.g2b}if(H.type===g.TYPE_UNUSED)G.pos+=3;if(H.type===g.TYPE_INV){H.invSlotObjId=new Int32Array(H.width*H.height),H.invSlotObjCount=new Int32Array(H.width*H.height),H.draggable=G.g1===1,H.interactable=G.g1===1,H.usable=G.g1===1,H.marginX=G.g1,H.marginY=G.g1,H.invSlotOffsetX=new Int16Array(20),H.invSlotOffsetY=new Int16Array(20),H.invSlotSprite=new l(20,null);for(let O=0;O<20;O++)if(G.g1===1){H.invSlotOffsetX[O]=G.g2b,H.invSlotOffsetY[O]=G.g2b;let q=G.gjstr;if(q.length>0){let b=q.lastIndexOf(",");H.invSlotSprite[O]=this.getImage(R,q.substring(0,b),parseInt(q.substring(b+1),10))}}H.iops=new l(5,null);for(let O=0;O<5;O++){let q=G.gjstr;if(H.iops[O]=q,q.length===0)H.iops[O]=null}}if(H.type===g.TYPE_RECT)H.fill=G.g1===1;if(H.type===g.TYPE_TEXT||H.type===g.TYPE_UNUSED){H.center=G.g1===1;let O=G.g1;if(L)H.font=L[O];H.shadowed=G.g1===1}if(H.type===g.TYPE_TEXT)H.text=G.gjstr,H.activeText=G.gjstr;if(H.type===g.TYPE_UNUSED||H.type===g.TYPE_RECT||H.type===g.TYPE_TEXT)H.colour=G.g4;if(H.type===g.TYPE_RECT||H.type===g.TYPE_TEXT)H.activeColour=G.g4,H.overColour=G.g4;if(H.type===g.TYPE_GRAPHIC){let O=G.gjstr;if(O.length>0){let b=O.lastIndexOf(",");H.graphic=this.getImage(R,O.substring(0,b),parseInt(O.substring(b+1),10))}let q=G.gjstr;if(q.length>0){let b=q.lastIndexOf(",");H.activeGraphic=this.getImage(R,q.substring(0,b),parseInt(q.substring(b+1),10))}}if(H.type===g.TYPE_MODEL){let O=G.g1;if(O!==0)H.model=this.getModel((O-1<<8)+G.g1);let q=G.g1;if(q!==0)H.activeModel=this.getModel((q-1<<8)+G.g1);if(H.anim=G.g1,H.anim===0)H.anim=-1;else H.anim=(H.anim-1<<8)+G.g1;if(H.activeAnim=G.g1,H.activeAnim===0)H.activeAnim=-1;else H.activeAnim=(H.activeAnim-1<<8)+G.g1;H.zoom=G.g2,H.xan=G.g2,H.yan=G.g2}if(H.type===g.TYPE_INV_TEXT){H.invSlotObjId=new Int32Array(H.width*H.height),H.invSlotObjCount=new Int32Array(H.width*H.height),H.center=G.g1===1;let O=G.g1;if(L)H.font=L[O];H.shadowed=G.g1===1,H.colour=G.g4,H.marginX=G.g2b,H.marginY=G.g2b,H.interactable=G.g1===1,H.iops=new l(5,null);for(let q=0;q<5;q++){let b=G.gjstr;if(H.iops[q]=b,b.length===0)H.iops[q]=null}}if(H.buttonType===g.BUTTON_TARGET||H.type===g.TYPE_INV)H.actionVerb=G.gjstr,H.action=G.gjstr,H.actionTarget=G.g2;if(H.buttonType===g.BUTTON_OK||H.buttonType===g.BUTTON_TOGGLE||H.buttonType===g.BUTTON_SELECT||H.buttonType===g.BUTTON_CONTINUE){if(H.option=G.gjstr,H.option.length===0){if(H.buttonType===g.BUTTON_OK)H.option="Ok";else if(H.buttonType===g.BUTTON_TOGGLE)H.option="Select";else if(H.buttonType===g.BUTTON_SELECT)H.option="Select";else if(H.buttonType===g.BUTTON_CONTINUE)H.option="Continue"}}}this.imageCache=null,this.modelCache=null};static getImage=(_,R,L)=>{let G=I0.hashCode(R)<<8n|BigInt(L);if(this.imageCache){let Q=this.imageCache.get(G);if(Q)return Q}let K;try{K=V0.fromArchive(_,R,L),this.imageCache?.put(G,K)}catch(Q){return null}return K};static getModel=(_)=>{if(this.modelCache){let L=this.modelCache.get(BigInt(_));if(L)return L}let R=E.model(_);return this.modelCache?.put(BigInt(_),R),R};id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;invSlotOffsetX=null;invSlotOffsetY=null;invSlotSprite=null;iops=null;fill=!1;center=!1;font=null;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=null;activeModel=null;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null;x=0;y=0;scrollPosition=0;invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;getModel(_,R,L){let G=this.model;if(L)G=this.activeModel;if(!G)return null;if(_===-1&&R===-1&&!G.faceColor)return G;let K=E.modelShareColored(G,!0,!0,!1);if(_!==-1||R!==-1)K.createLabelReferences();if(_!==-1)K.applyTransform(_);if(R!==-1)K.applyTransform(R);return K.calculateNormals(64,768,-50,-10,-50,!0),K}getAbsoluteX(){if(this.layer===this.id)return this.x;let _=g.instances[this.layer];if(!_.childId||!_.childX||!_.childY)return this.x;let R=_.childId.indexOf(this.id);if(R===-1)return this.x;let L=_.childX[R];while(_.layer!==_.id){let G=g.instances[_.layer];if(G.childId&&G.childX&&G.childY){if(R=G.childId.indexOf(_.id),R!==-1)L+=G.childX[R]}_=G}return L}getAbsoluteY(){if(this.layer===this.id)return this.y;let _=g.instances[this.layer];if(!_.childId||!_.childX||!_.childY)return this.y;let R=_.childId.indexOf(this.id);if(R===-1)return this.y;let L=_.childY[R];while(_.layer!==_.id){let G=g.instances[_.layer];if(G.childId&&G.childX&&G.childY){if(R=G.childId.indexOf(_.id),R!==-1)L+=G.childY[R]}_=G}return L}outline(_){let R=this.getAbsoluteX(),L=this.getAbsoluteY();j.drawRect(R,L,this.width,this.height,_)}move(_,R){if(this.layer===this.id)return;this.x=0,this.y=0;let L=g.instances[this.layer];if(L.childId&&L.childX&&L.childY){let G=L.childId.indexOf(this.id);if(G!==-1)L.childX[G]=_,L.childY[G]=R}}delete(){if(this.layer===this.id)return;let _=g.instances[this.layer];if(_.childId&&_.childX&&_.childY){let R=_.childId.indexOf(this.id);if(R!==-1)_.childId.splice(R,1),_.childX.splice(R,1),_.childY.splice(R,1)}}}class S{static OPEN=0;static WALL_NORTH_WEST=1;static WALL_NORTH=2;static WALL_NORTH_EAST=4;static WALL_EAST=8;static WALL_SOUTH_EAST=S.WALL_NORTH_WEST<<4;static WALL_SOUTH=S.WALL_NORTH<<4;static WALL_SOUTH_WEST=S.WALL_NORTH_EAST<<4;static WALL_WEST=S.WALL_EAST<<4;static LOC=256;static WALL_NORTH_WEST_PROJ_BLOCKER=512;static WALL_NORTH_PROJ_BLOCKER=1024;static WALL_NORTH_EAST_PROJ_BLOCKER=2048;static WALL_EAST_PROJ_BLOCKER=4096;static WALL_SOUTH_EAST_PROJ_BLOCKER=S.WALL_NORTH_WEST_PROJ_BLOCKER<<4;static WALL_SOUTH_PROJ_BLOCKER=S.WALL_NORTH_PROJ_BLOCKER<<4;static WALL_SOUTH_WEST_PROJ_BLOCKER=S.WALL_NORTH_EAST_PROJ_BLOCKER<<4;static WALL_WEST_PROJ_BLOCKER=S.WALL_EAST_PROJ_BLOCKER<<4;static LOC_PROJ_BLOCKER=S.LOC<<9;static ANTIMACRO=524288;static FLOOR=2097152;static FLOOR_BLOCKED=S.FLOOR|S.ANTIMACRO;static WALK_BLOCKED=S.LOC|S.FLOOR_BLOCKED;static BLOCK_SOUTH=S.WALL_NORTH|S.WALK_BLOCKED;static BLOCK_WEST=S.WALL_EAST|S.WALK_BLOCKED;static BLOCK_SOUTH_WEST=S.WALL_NORTH|S.WALL_NORTH_EAST|S.BLOCK_WEST;static BLOCK_NORTH=S.WALL_SOUTH|S.WALK_BLOCKED;static BLOCK_NORTH_WEST=S.WALL_EAST|S.WALL_SOUTH_EAST|S.BLOCK_NORTH;static BLOCK_EAST=S.WALL_WEST|S.WALK_BLOCKED;static BLOCK_SOUTH_EAST=S.WALL_NORTH_WEST|S.WALL_NORTH|S.BLOCK_EAST;static BLOCK_NORTH_EAST=S.WALL_SOUTH|S.WALL_SOUTH_WEST|S.BLOCK_EAST;static BOUNDS=16777215}class K1{static NORTH=1;static EAST=2;static SOUTH=4;static WEST=8}class s{static LEVELS=4;static SIZE=104;static index=(_,R)=>_*s.SIZE+R;offsetX;offsetZ;sizeX;sizeZ;flags;constructor(){this.offsetX=0,this.offsetZ=0,this.sizeX=s.SIZE,this.sizeZ=s.SIZE,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset=()=>{for(let _=0;_<this.sizeX;_++)for(let R=0;R<this.sizeZ;R++){let L=s.index(_,R);if(_===0||R===0||_===this.sizeX-1||R===this.sizeZ-1)this.flags[L]=S.BOUNDS;else this.flags[L]=S.OPEN}};addFloor=(_,R)=>{this.flags[s.index(_-this.offsetX,R-this.offsetZ)]|=S.FLOOR};removeFloor=(_,R)=>{this.flags[s.index(_-this.offsetX,R-this.offsetZ)]&=~S.FLOOR};addLoc=(_,R,L,G,K,Q)=>{let H=S.LOC;if(Q)H|=S.LOC_PROJ_BLOCKER;let $=_-this.offsetX,J=R-this.offsetZ;if(K===x.NORTH||K===x.SOUTH){let O=L;L=G,G=O}for(let O=$;O<$+L;O++){if(!(O>=0&&O<this.sizeX))continue;for(let q=J;q<J+G;q++){if(!(q>=0&&q<this.sizeZ))continue;this.add(O,q,H)}}};removeLoc=(_,R,L,G,K,Q)=>{let H=S.LOC;if(Q)H|=S.LOC_PROJ_BLOCKER;let $=_-this.offsetX,J=R-this.offsetZ;if(K===x.NORTH||K===x.SOUTH){let O=L;L=G,G=O}for(let O=$;O<$+L;O++){if(!(O>=0&&O<this.sizeX))continue;for(let q=J;q<J+G;q++){if(!(q>=0&&q<this.sizeZ))continue;this.remove(O,q,H)}}};addWall=(_,R,L,G,K)=>{let Q=_-this.offsetX,H=R-this.offsetZ,$=K?S.WALL_WEST_PROJ_BLOCKER:S.WALL_WEST,J=K?S.WALL_EAST_PROJ_BLOCKER:S.WALL_EAST,O=K?S.WALL_NORTH_PROJ_BLOCKER:S.WALL_NORTH,q=K?S.WALL_SOUTH_PROJ_BLOCKER:S.WALL_SOUTH,b=K?S.WALL_NORTH_WEST_PROJ_BLOCKER:S.WALL_NORTH_WEST,U=K?S.WALL_SOUTH_EAST_PROJ_BLOCKER:S.WALL_SOUTH_EAST,N=K?S.WALL_NORTH_EAST_PROJ_BLOCKER:S.WALL_NORTH_EAST,I=K?S.WALL_SOUTH_WEST_PROJ_BLOCKER:S.WALL_SOUTH_WEST;if(L===y.WALL_STRAIGHT.id){if(G===x.WEST)this.add(Q,H,$),this.add(Q-1,H,J);else if(G===x.NORTH)this.add(Q,H,O),this.add(Q,H+1,q);else if(G===x.EAST)this.add(Q,H,J),this.add(Q+1,H,$);else if(G===x.SOUTH)this.add(Q,H,q),this.add(Q,H-1,O)}else if(L===y.WALL_DIAGONAL_CORNER.id||L===y.WALL_SQUARE_CORNER.id){if(G===x.WEST)this.add(Q,H,b),this.add(Q-1,H+1,U);else if(G===x.NORTH)this.add(Q,H,N),this.add(Q+1,H+1,I);else if(G===x.EAST)this.add(Q,H,U),this.add(Q+1,H-1,b);else if(G===x.SOUTH)this.add(Q,H,I),this.add(Q-1,H-1,N)}else if(L===y.WALL_L.id){if(G===x.WEST)this.add(Q,H,O|$),this.add(Q-1,H,J),this.add(Q,H+1,q);else if(G===x.NORTH)this.add(Q,H,O|J),this.add(Q,H+1,q),this.add(Q+1,H,$);else if(G===x.EAST)this.add(Q,H,q|J),this.add(Q+1,H,$),this.add(Q,H-1,O);else if(G===x.SOUTH)this.add(Q,H,q|$),this.add(Q,H-1,O),this.add(Q-1,H,J)}if(K)this.addWall(_,R,L,G,!1)};removeWall=(_,R,L,G,K)=>{let Q=_-this.offsetX,H=R-this.offsetZ,$=K?S.WALL_WEST_PROJ_BLOCKER:S.WALL_WEST,J=K?S.WALL_EAST_PROJ_BLOCKER:S.WALL_EAST,O=K?S.WALL_NORTH_PROJ_BLOCKER:S.WALL_NORTH,q=K?S.WALL_SOUTH_PROJ_BLOCKER:S.WALL_SOUTH,b=K?S.WALL_NORTH_WEST_PROJ_BLOCKER:S.WALL_NORTH_WEST,U=K?S.WALL_SOUTH_EAST_PROJ_BLOCKER:S.WALL_SOUTH_EAST,N=K?S.WALL_NORTH_EAST_PROJ_BLOCKER:S.WALL_NORTH_EAST,I=K?S.WALL_SOUTH_WEST_PROJ_BLOCKER:S.WALL_SOUTH_WEST;if(L===y.WALL_STRAIGHT.id){if(G===x.WEST)this.remove(Q,H,$),this.remove(Q-1,H,J);else if(G===x.NORTH)this.remove(Q,H,O),this.remove(Q,H+1,q);else if(G===x.EAST)this.remove(Q,H,J),this.remove(Q+1,H,$);else if(G===x.SOUTH)this.remove(Q,H,q),this.remove(Q,H-1,O)}else if(L===y.WALL_DIAGONAL_CORNER.id||L===y.WALL_SQUARE_CORNER.id){if(G===x.WEST)this.remove(Q,H,b),this.remove(Q-1,H+1,U);else if(G===x.NORTH)this.remove(Q,H,N),this.remove(Q+1,H+1,I);else if(G===x.EAST)this.remove(Q,H,U),this.remove(Q+1,H-1,b);else if(G===x.SOUTH)this.remove(Q,H,I),this.remove(Q-1,H-1,N)}else if(L===y.WALL_L.id){if(G===x.WEST)this.remove(Q,H,O|$),this.remove(Q-1,H,J),this.remove(Q,H+1,q);else if(G===x.NORTH)this.remove(Q,H,O|J),this.remove(Q,H+1,q),this.remove(Q+1,H,$);else if(G===x.EAST)this.remove(Q,H,q|J),this.remove(Q+1,H,$),this.remove(Q,H-1,O);else if(G===x.SOUTH)this.remove(Q,H,q|$),this.remove(Q,H-1,O),this.remove(Q-1,H,J)}if(K)this.removeWall(_,R,L,G,!1)};reachedWall=(_,R,L,G,K,Q)=>{if(_===L&&R===G)return!0;let H=_-this.offsetX,$=R-this.offsetZ,J=L-this.offsetX,O=G-this.offsetZ,q=s.index(H,$);if(K===y.WALL_STRAIGHT.id){if(Q===x.WEST){if(H===J-1&&$===O)return!0;else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN)return!0}else if(Q===x.NORTH){if(H===J&&$===O+1)return!0;else if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN)return!0;else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN)return!0}else if(Q===x.EAST){if(H===J+1&&$===O)return!0;else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN)return!0}else if(Q===x.SOUTH){if(H===J&&$===O-1)return!0;else if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN)return!0;else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN)return!0}}else if(K===y.WALL_L.id){if(Q===x.WEST){if(H===J-1&&$===O)return!0;else if(H===J&&$===O+1)return!0;else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN)return!0}else if(Q===x.NORTH){if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN)return!0;else if(H===J&&$===O+1)return!0;else if(H===J+1&&$===O)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.BLOCK_SOUTH)===S.OPEN)return!0}else if(Q===x.EAST){if(H===J-1&&$===O&&(this.flags[q]&S.BLOCK_WEST)===S.OPEN)return!0;else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN)return!0;else if(H===J+1&&$===O)return!0;else if(H===J&&$===O-1)return!0}else if(Q===x.SOUTH){if(H===J-1&&$===O)return!0;else if(H===J&&$===O+1&&(this.flags[q]&S.BLOCK_NORTH)===S.OPEN)return!0;else if(H===J+1&&$===O&&(this.flags[q]&S.BLOCK_EAST)===S.OPEN)return!0;else if(H===J&&$===O-1)return!0}}else if(K===y.WALL_DIAGONAL.id){if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN)return!0;else if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN)return!0;else if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN)return!0}return!1};reachedWallDecoration=(_,R,L,G,K,Q)=>{if(_===L&&R===G)return!0;let H=_-this.offsetX,$=R-this.offsetZ,J=L-this.offsetX,O=G-this.offsetZ,q=s.index(H,$);if(K===y.WALLDECOR_DIAGONAL_OFFSET.id||K===y.WALLDECOR_DIAGONAL_NOOFFSET.id){if(K===y.WALLDECOR_DIAGONAL_NOOFFSET.id)Q=Q+2&3;if(Q===x.WEST){if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN)return!0}else if(Q===x.NORTH){if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN)return!0}else if(Q===x.EAST){if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN)return!0;else if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN)return!0}else if(Q===x.SOUTH){if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN)return!0;else if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN)return!0}}else if(K===y.WALLDECOR_DIAGONAL_BOTH.id){if(H===J&&$===O+1&&(this.flags[q]&S.WALL_SOUTH)===S.OPEN)return!0;else if(H===J&&$===O-1&&(this.flags[q]&S.WALL_NORTH)===S.OPEN)return!0;else if(H===J-1&&$===O&&(this.flags[q]&S.WALL_EAST)===S.OPEN)return!0;else if(H===J+1&&$===O&&(this.flags[q]&S.WALL_WEST)===S.OPEN)return!0}return!1};reachedLoc=(_,R,L,G,K,Q,H)=>{let $=L+K-1,J=G+Q-1,O=s.index(_-this.offsetX,R-this.offsetZ);if(_>=L&&_<=$&&R>=G&&R<=J)return!0;else if(_===L-1&&R>=G&&R<=J&&(this.flags[O]&S.WALL_EAST)===S.OPEN&&(H&K1.WEST)===S.OPEN)return!0;else if(_===$+1&&R>=G&&R<=J&&(this.flags[O]&S.WALL_WEST)===S.OPEN&&(H&K1.EAST)===S.OPEN)return!0;else if(R===G-1&&_>=L&&_<=$&&(this.flags[O]&S.WALL_NORTH)===S.OPEN&&(H&K1.SOUTH)===S.OPEN)return!0;else if(R===J+1&&_>=L&&_<=$&&(this.flags[O]&S.WALL_SOUTH)===S.OPEN&&(H&K1.NORTH)===S.OPEN)return!0;return!1};add=(_,R,L)=>{this.flags[s.index(_,R)]|=L};remove=(_,R,L)=>{this.flags[s.index(_,R)]&=S.BOUNDS-L}}class X8{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(_,R,L,G,K,Q,H,$,J,O,q){this.minTileX=_,this.maxTileX=R,this.minTileZ=L,this.maxTileZ=G,this.type=K,this.minX=Q,this.maxX=H,this.minZ=$,this.maxZ=J,this.minY=O,this.maxY=q}}class A8{y;x;z;model;bitset;info;constructor(_,R,L,G,K,Q){this.y=_,this.x=R,this.z=L,this.model=G,this.bitset=K,this.info=Q}}class W8{level;y;x;z;model;entity;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;bitset;info;distance=0;cycle=0;constructor(_,R,L,G,K,Q,H,$,J,O,q,b,U){this.level=_,this.y=R,this.x=L,this.z=G,this.model=K,this.entity=Q,this.yaw=H,this.minSceneTileX=$,this.maxSceneTileX=J,this.minSceneTileZ=O,this.maxSceneTileZ=q,this.bitset=b,this.info=U}}class h8{y;x;z;topObj;middleObj;bottomObj;bitset;offset;constructor(_,R,L,G,K,Q,H,$){this.y=_,this.x=R,this.z=L,this.topObj=G,this.middleObj=K,this.bottomObj=Q,this.bitset=H,this.offset=$}}class R1 extends D0{level;x;z;occludeLevel;locs;locSpan;underlay=null;overlay=null;wall=null;wallDecoration=null;groundDecoration=null;objStack=null;bridge=null;locCount=0;locSpans=0;drawLevel=0;visible=!1;update=!1;containsLocs=!1;checkLocSpans=0;blockLocSpans=0;inverseBlockLocSpans=0;backWallTypes=0;constructor(_,R,L){super();this.occludeLevel=this.level=_,this.x=R,this.z=L,this.locs=new l(5,null),this.locSpan=new Int32Array(5)}}class R0{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;angle;backgroundRgb;foregroundRgb;constructor(_,R,L,G,K,Q,H,$,J,O,q,b,U,N,I,k,F,T,Y){this.flat=!(F!==G||F!==N||F!==$),this.shape=R,this.angle=Q,this.backgroundRgb=U,this.foregroundRgb=J;let u=R0.SHAPE_POINTS[R],w=u.length;this.vertexX=new Int32Array(w),this.vertexY=new Int32Array(w),this.vertexZ=new Int32Array(w);let B=new Int32Array(w),v=new Int32Array(w),n=_*R0.FULL_SQUARE,W=T*R0.FULL_SQUARE;for(let m=0;m<w;m++){let M=u[m];if((M&1)===0&&M<=8)M=(M-Q-Q-1&7)+1;if(M>8&&M<=12)M=(M-Q-9&3)+9;if(M>12&&M<=16)M=(M-Q-13&3)+13;let r,a,C,L0,e;if(M===1)r=n,a=W,C=F,L0=H,e=O;else if(M===2)r=n+R0.HALF_SQUARE,a=W,C=F+G>>1,L0=H+Y>>1,e=O+L>>1;else if(M===3)r=n+R0.FULL_SQUARE,a=W,C=G,L0=Y,e=L;else if(M===4)r=n+R0.FULL_SQUARE,a=W+R0.HALF_SQUARE,C=G+N>>1,L0=Y+K>>1,e=L+I>>1;else if(M===5)r=n+R0.FULL_SQUARE,a=W+R0.FULL_SQUARE,C=N,L0=K,e=I;else if(M===6)r=n+R0.HALF_SQUARE,a=W+R0.FULL_SQUARE,C=N+$>>1,L0=K+k>>1,e=I+b>>1;else if(M===7)r=n,a=W+R0.FULL_SQUARE,C=$,L0=k,e=b;else if(M===8)r=n,a=W+R0.HALF_SQUARE,C=$+F>>1,L0=k+H>>1,e=b+O>>1;else if(M===9)r=n+R0.HALF_SQUARE,a=W+R0.CORNER_SMALL,C=F+G>>1,L0=H+Y>>1,e=O+L>>1;else if(M===10)r=n+R0.CORNER_BIG,a=W+R0.HALF_SQUARE,C=G+N>>1,L0=Y+K>>1,e=L+I>>1;else if(M===11)r=n+R0.HALF_SQUARE,a=W+R0.CORNER_BIG,C=N+$>>1,L0=K+k>>1,e=I+b>>1;else if(M===12)r=n+R0.CORNER_SMALL,a=W+R0.HALF_SQUARE,C=$+F>>1,L0=k+H>>1,e=b+O>>1;else if(M===13)r=n+R0.CORNER_SMALL,a=W+R0.CORNER_SMALL,C=F,L0=H,e=O;else if(M===14)r=n+R0.CORNER_BIG,a=W+R0.CORNER_SMALL,C=G,L0=Y,e=L;else if(M===15)r=n+R0.CORNER_BIG,a=W+R0.CORNER_BIG,C=N,L0=K,e=I;else r=n+R0.CORNER_SMALL,a=W+R0.CORNER_BIG,C=$,L0=k,e=b;this.vertexX[m]=r,this.vertexY[m]=C,this.vertexZ[m]=a,B[m]=L0,v[m]=e}let P=R0.SHAPE_PATHS[R],z=P.length/4|0;if(this.triangleVertexA=new Int32Array(z),this.triangleVertexB=new Int32Array(z),this.triangleVertexC=new Int32Array(z),this.triangleColorA=new Int32Array(z),this.triangleColorB=new Int32Array(z),this.triangleColorC=new Int32Array(z),q!==-1)this.triangleTextureIds=new Int32Array(z);else this.triangleTextureIds=null;let f=0;for(let m=0;m<z;m++){let M=P[f],r=P[f+1],a=P[f+2],C=P[f+3];if(f+=4,r<4)r=r-Q&3;if(a<4)a=a-Q&3;if(C<4)C=C-Q&3;if(this.triangleVertexA[m]=r,this.triangleVertexB[m]=a,this.triangleVertexC[m]=C,M===0){if(this.triangleColorA[m]=B[r],this.triangleColorB[m]=B[a],this.triangleColorC[m]=B[C],this.triangleTextureIds)this.triangleTextureIds[m]=-1}else if(this.triangleColorA[m]=v[r],this.triangleColorB[m]=v[a],this.triangleColorC[m]=v[C],this.triangleTextureIds)this.triangleTextureIds[m]=q}}}class T1{static PLAIN=0;static DIAGONAL=1;static LEFT_SEMI_DIAGONAL_SMALL=2;static RIGHT_SEMI_DIAGONAL_SMALL=3;static LEFT_SEMI_DIAGONAL_BIG=4;static RIGHT_SEMI_DIAGONAL_BIG=5;static HALF_SQUARE=6;static CORNER_SMALL=7;static CORNER_BIG=8;static FAN_SMALL=9;static FAN_BIG=10;static TRAPEZIUM=11}class _8{southwestColor;southeastColor;northeastColor;northwestColor;textureId;color;flat;constructor(_,R,L,G,K,Q,H){this.southwestColor=_,this.southeastColor=R,this.northeastColor=L,this.northwestColor=G,this.textureId=K,this.color=Q,this.flat=H}}class B8{y;x;z;typeA;typeB;modelA;modelB;bitset;info;constructor(_,R,L,G,K,Q,H,$,J){this.y=_,this.x=R,this.z=L,this.typeA=G,this.typeB=K,this.modelA=Q,this.modelB=H,this.bitset=$,this.info=J}}class m8{y;x;z;type;angle;model;bitset;info;constructor(_,R,L,G,K,Q,H,$){this.y=_,this.x=R,this.z=L,this.type=G,this.angle=K,this.model=Q,this.bitset=H,this.info=$}}class V{static visibilityMatrix=new j8(8,32,51,51,!1);static locBuffer=new l(100,null);static levelOccluderCount=new Int32Array(s.LEVELS);static levelOccluders=new D5(s.LEVELS,500,null);static activeOccluders=new l(500,null);static drawTileQueue=new g0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS=Int8Array.of(0,0,2,0,0,2,1,1,0);static WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS=Int8Array.of(2,0,0,2,0,0,0,4,4);static WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS=Int8Array.of(0,4,4,8,0,0,8,0,0);static WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init=(_,R,L,G,K)=>{this.viewportLeft=0,this.viewportTop=0,this.viewportRight=_,this.viewportBottom=R,this.viewportCenterX=_/2|0,this.viewportCenterY=R/2|0;let Q=new j8(9,32,53,53,!1);for(let H=128;H<=384;H+=32)for(let $=0;$<2048;$+=64){this.sinEyePitch=h.sin[H],this.cosEyePitch=h.cos[H],this.sinEyeYaw=h.sin[$],this.cosEyeYaw=h.cos[$];let J=(H-128)/32|0,O=$/64|0;for(let q=-26;q<=26;q++)for(let b=-26;b<=26;b++){let U=q*128,N=b*128,I=!1;for(let k=-L;k<=G;k+=128)if(this.testPoint(U,N,K[J]+k)){I=!0;break}Q[J][O][q+25+1][b+25+1]=I}}for(let H=0;H<8;H++)for(let $=0;$<32;$++)for(let J=-25;J<25;J++)for(let O=-25;O<25;O++){let q=!1;_:for(let b=-1;b<=1;b++)for(let U=-1;U<=1;U++){if(Q[H][$][J+b+25+1][O+U+25+1]){q=!0;break _}if(Q[H][($+1)%31][J+b+25+1][O+U+25+1]){q=!0;break _}if(Q[H+1][$][J+b+25+1][O+U+25+1]){q=!0;break _}if(Q[H+1][($+1)%31][J+b+25+1][O+U+25+1]){q=!0;break _}}this.visibilityMatrix[H][$][J+25][O+25]=q}};static addOccluder=(_,R,L,G,K,Q,H,$)=>{V.levelOccluders[_][V.levelOccluderCount[_]++]=new X8(L/128|0,Q/128|0,K/128|0,$/128|0,R,L,Q,K,$,G,H)};static testPoint=(_,R,L)=>{let G=R*this.sinEyeYaw+_*this.cosEyeYaw>>16,K=R*this.cosEyeYaw-_*this.sinEyeYaw>>16,Q=L*this.sinEyePitch+K*this.cosEyePitch>>16,H=L*this.cosEyePitch-K*this.sinEyePitch>>16;if(Q<50||Q>3500)return!1;let $=this.viewportCenterX+((G<<9)/Q|0),J=this.viewportCenterY+((H<<9)/Q|0);return $>=this.viewportLeft&&$<=this.viewportRight&&J>=this.viewportTop&&J<=this.viewportBottom};maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(_,R,L,G){this.maxLevel=L,this.maxTileX=G,this.maxTileZ=R,this.levelTiles=new e1(L,G,R,null),this.levelTileOcclusionCycles=new W1(L,G+1,R+1),this.levelHeightmaps=_,this.temporaryLocs=new l(5000,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset=()=>{for(let _=0;_<this.maxLevel;_++)for(let R=0;R<this.maxTileX;R++)for(let L=0;L<this.maxTileZ;L++)this.levelTiles[_][R][L]=null;for(let _=0;_<s.LEVELS;_++){for(let R=0;R<V.levelOccluderCount[_];R++)V.levelOccluders[_][R]=null;V.levelOccluderCount[_]=0}for(let _=0;_<this.temporaryLocCount;_++)this.temporaryLocs[_]=null;this.temporaryLocCount=0,V.locBuffer.fill(null)};setMinLevel=(_)=>{this.minLevel=_;for(let R=0;R<this.maxTileX;R++)for(let L=0;L<this.maxTileZ;L++)this.levelTiles[_][R][L]=new R1(_,R,L)};setBridge=(_,R)=>{let L=this.levelTiles[0][_][R];for(let K=0;K<3;K++){this.levelTiles[K][_][R]=this.levelTiles[K+1][_][R];let Q=this.levelTiles[K][_][R];if(Q)Q.level--}if(!this.levelTiles[0][_][R])this.levelTiles[0][_][R]=new R1(0,_,R);let G=this.levelTiles[0][_][R];if(G)G.bridge=L;this.levelTiles[3][_][R]=null};setDrawLevel=(_,R,L,G)=>{let K=this.levelTiles[_][R][L];if(!K)return;K.drawLevel=G};setTile=(_,R,L,G,K,Q,H,$,J,O,q,b,U,N,I,k,F,T,Y,u)=>{if(G===T1.PLAIN){for(let B=_;B>=0;B--)if(!this.levelTiles[B][R][L])this.levelTiles[B][R][L]=new R1(B,R,L);let w=this.levelTiles[_][R][L];if(w)w.underlay=new _8(q,b,U,N,-1,Y,!1)}else if(G===T1.DIAGONAL){for(let B=_;B>=0;B--)if(!this.levelTiles[B][R][L])this.levelTiles[B][R][L]=new R1(B,R,L);let w=this.levelTiles[_][R][L];if(w)w.underlay=new _8(I,k,F,T,Q,u,H===$&&H===J&&H===O)}else{for(let B=_;B>=0;B--)if(!this.levelTiles[B][R][L])this.levelTiles[B][R][L]=new R1(B,R,L);let w=this.levelTiles[_][R][L];if(w)w.overlay=new R0(R,G,k,$,U,K,q,O,u,I,Q,T,Y,J,F,N,H,L,b)}};addGroundDecoration=(_,R,L,G,K,Q,H)=>{if(!this.levelTiles[R][L][G])this.levelTiles[R][L][G]=new R1(R,L,G);let $=this.levelTiles[R][L][G];if($)$.groundDecoration=new A8(K,L*128+64,G*128+64,_,Q,H)};removeGroundDecoration=(_,R,L)=>{let G=this.levelTiles[_][R][L];if(!G)return;G.groundDecoration=null};addObjStack=(_,R,L,G,K,Q,H,$)=>{let J=0,O=this.levelTiles[G][_][R];if(O)for(let b=0;b<O.locCount;b++){let U=O.locs[b];if(!U||!U.model)continue;let N=U.model.objRaise;if(N>J)J=N}else this.levelTiles[G][_][R]=new R1(G,_,R);let q=this.levelTiles[G][_][R];if(q)q.objStack=new h8(L,_*128+64,R*128+64,Q,H,$,K,J)};removeObjStack=(_,R,L)=>{let G=this.levelTiles[_][R][L];if(!G)return;G.objStack=null};addWall=(_,R,L,G,K,Q,H,$,J,O)=>{if(!H&&!$)return;for(let b=_;b>=0;b--)if(!this.levelTiles[b][R][L])this.levelTiles[b][R][L]=new R1(b,R,L);let q=this.levelTiles[_][R][L];if(q)q.wall=new B8(G,R*128+64,L*128+64,K,Q,H,$,J,O)};removeWall=(_,R,L,G)=>{let K=this.levelTiles[_][R][L];if(G===1&&K)K.wall=null};setWallDecoration=(_,R,L,G,K,Q,H,$,J,O,q)=>{if(!$)return;for(let U=_;U>=0;U--)if(!this.levelTiles[U][R][L])this.levelTiles[U][R][L]=new R1(U,R,L);let b=this.levelTiles[_][R][L];if(b)b.wallDecoration=new m8(G,R*128+K+64,L*128+Q+64,q,O,$,H,J)};removeWallDecoration=(_,R,L)=>{let G=this.levelTiles[_][R][L];if(!G)return;G.wallDecoration=null};setWallDecorationOffset=(_,R,L,G)=>{let K=this.levelTiles[_][R][L];if(!K)return;let Q=K.wallDecoration;if(!Q)return;let H=R*128+64,$=L*128+64;Q.x=H+((Q.x-H)*G/16|0),Q.z=$+((Q.z-$)*G/16|0)};setWallDecorationModel=(_,R,L,G)=>{if(!G)return;let K=this.levelTiles[_][R][L];if(!K)return;let Q=K.wallDecoration;if(!Q)return;Q.model=G};setGroundDecorationModel=(_,R,L,G)=>{if(!G)return;let K=this.levelTiles[_][R][L];if(!K)return;let Q=K.groundDecoration;if(!Q)return;Q.model=G};setWallModel=(_,R,L,G)=>{if(!G)return;let K=this.levelTiles[_][R][L];if(!K)return;let Q=K.wall;if(!Q)return;Q.modelA=G};setWallModels=(_,R,L,G,K)=>{if(!G)return;let Q=this.levelTiles[L][_][R];if(!Q)return;let H=Q.wall;if(!H)return;H.modelA=G,H.modelB=K};addLoc=(_,R,L,G,K,Q,H,$,J,O,q)=>{if(!K&&!Q)return!0;let b=R*128+J*64,U=L*128+O*64;return this.addLoc2(b,U,G,_,R,L,J,O,K,Q,H,$,q,!1)};addTemporary=(_,R,L,G,K,Q,H,$,J,O)=>{if(!K&&!Q)return!0;let q=R-J,b=G-J,U=R+J,N=G+J;if(O){if($>640&&$<1408)N+=128;if($>1152&&$<1920)U+=128;if($>1664||$<384)b-=128;if($>128&&$<896)q-=128}return q=q/128|0,b=b/128|0,U=U/128|0,N=N/128|0,this.addLoc2(R,G,L,_,q,b,U+1-q,N-b+1,K,Q,H,0,$,!0)};addTemporary2=(_,R,L,G,K,Q,H,$,J,O,q,b)=>{return!J&&!O||this.addLoc2(R,G,L,_,K,Q,H+1-K,$-Q+1,J,O,q,0,b,!0)};removeLoc=(_,R,L)=>{let G=this.levelTiles[_][R][L];if(!G)return;for(let K=0;K<G.locCount;K++){let Q=G.locs[K];if(Q&&(Q.bitset>>29&3)===2&&Q.minSceneTileX===R&&Q.minSceneTileZ===L){this.removeLoc2(Q);return}}};setLocModel=(_,R,L,G)=>{if(!G)return;let K=this.levelTiles[_][R][L];if(!K)return;for(let Q=0;Q<K.locCount;Q++){let H=K.locs[Q];if(H&&(H.bitset>>29&3)===2){H.model=G;return}}};clearTemporaryLocs=()=>{for(let _=0;_<this.temporaryLocCount;_++){let R=this.temporaryLocs[_];if(R)this.removeLoc2(R);this.temporaryLocs[_]=null}this.temporaryLocCount=0};getWallBitset=(_,R,L)=>{let G=this.levelTiles[_][R][L];return!G||!G.wall?0:G.wall.bitset};getWallDecorationBitset=(_,R,L)=>{let G=this.levelTiles[_][L][R];return!G||!G.wallDecoration?0:G.wallDecoration.bitset};getLocBitset=(_,R,L)=>{let G=this.levelTiles[_][R][L];if(!G)return 0;for(let K=0;K<G.locCount;K++){let Q=G.locs[K];if(Q&&(Q.bitset>>29&3)===2&&Q.minSceneTileX===R&&Q.minSceneTileZ===L)return Q.bitset}return 0};getGroundDecorationBitset=(_,R,L)=>{let G=this.levelTiles[_][R][L];return!G||!G.groundDecoration?0:G.groundDecoration.bitset};getInfo=(_,R,L,G)=>{let K=this.levelTiles[_][R][L];if(!K)return-1;else if(K.wall&&K.wall.bitset===G)return K.wall.info&255;else if(K.wallDecoration&&K.wallDecoration.bitset===G)return K.wallDecoration.info&255;else if(K.groundDecoration&&K.groundDecoration.bitset===G)return K.groundDecoration.info&255;else{for(let Q=0;Q<K.locCount;Q++){let H=K.locs[Q];if(H&&H.bitset===G)return H.info&255}return-1}};buildModels=(_,R,L,G,K)=>{let Q=Math.sqrt(L*L+G*G+K*K)|0,H=R*Q>>8;for(let $=0;$<this.maxLevel;$++)for(let J=0;J<this.maxTileX;J++)for(let O=0;O<this.maxTileZ;O++){let q=this.levelTiles[$][J][O];if(!q)continue;let b=q.wall;if(b&&b.modelA&&b.modelA.vertexNormal){if(this.mergeLocNormals($,J,O,1,1,b.modelA),b.modelB&&b.modelB.vertexNormal)this.mergeLocNormals($,J,O,1,1,b.modelB),this.mergeNormals(b.modelA,b.modelB,0,0,0,!1),b.modelB.applyLighting(_,H,L,G,K);b.modelA.applyLighting(_,H,L,G,K)}for(let N=0;N<q.locCount;N++){let I=q.locs[N];if(I&&I.model&&I.model.vertexNormal)this.mergeLocNormals($,J,O,I.maxSceneTileX+1-I.minSceneTileX,I.maxSceneTileZ-I.minSceneTileZ+1,I.model),I.model.applyLighting(_,H,L,G,K)}let U=q.groundDecoration;if(U&&U.model&&U.model.vertexNormal)this.mergeGroundDecorationNormals($,J,O,U.model),U.model.applyLighting(_,H,L,G,K)}};mergeGroundDecorationNormals=(_,R,L,G)=>{if(R<this.maxTileX){let K=this.levelTiles[_][R+1][L];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal)this.mergeNormals(G,K.groundDecoration.model,128,0,0,!0)}if(L<this.maxTileX){let K=this.levelTiles[_][R][L+1];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal)this.mergeNormals(G,K.groundDecoration.model,0,0,128,!0)}if(R<this.maxTileX&&L<this.maxTileZ){let K=this.levelTiles[_][R+1][L+1];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal)this.mergeNormals(G,K.groundDecoration.model,128,0,128,!0)}if(R<this.maxTileX&&L>0){let K=this.levelTiles[_][R+1][L-1];if(K&&K.groundDecoration&&K.groundDecoration.model&&K.groundDecoration.model.vertexNormal)this.mergeNormals(G,K.groundDecoration.model,128,0,-128,!0)}};mergeLocNormals=(_,R,L,G,K,Q)=>{let H=!0,$=R,J=R+G,O=L-1,q=L+K;for(let b=_;b<=_+1;b++){if(b===this.maxLevel)continue;for(let U=$;U<=J;U++){if(U<0||U>=this.maxTileX)continue;for(let N=O;N<=q;N++){if(N<0||N>=this.maxTileZ||H&&U<J&&N<q&&(N>=L||U===R))continue;let I=this.levelTiles[b][U][N];if(!I)continue;let k=(U-R)*128+(1-G)*64,F=(N-L)*128+(1-K)*64,T=((this.levelHeightmaps[b][U][N]+this.levelHeightmaps[b][U+1][N]+this.levelHeightmaps[b][U][N+1]+this.levelHeightmaps[b][U+1][N+1])/4|0)-((this.levelHeightmaps[_][R][L]+this.levelHeightmaps[_][R+1][L]+this.levelHeightmaps[_][R][L+1]+this.levelHeightmaps[_][R+1][L+1])/4|0),Y=I.wall;if(Y&&Y.modelA&&Y.modelA.vertexNormal)this.mergeNormals(Q,Y.modelA,k,T,F,H);if(Y&&Y.modelB&&Y.modelB.vertexNormal)this.mergeNormals(Q,Y.modelB,k,T,F,H);for(let u=0;u<I.locCount;u++){let w=I.locs[u];if(!w||!w.model||!w.model.vertexNormal)continue;let B=w.maxSceneTileX+1-w.minSceneTileX,v=w.maxSceneTileZ+1-w.minSceneTileZ;this.mergeNormals(Q,w.model,(w.minSceneTileX-R)*128+(B-G)*64,T,(w.minSceneTileZ-L)*128+(v-K)*64,H)}}}$--,H=!1}};mergeNormals=(_,R,L,G,K,Q)=>{this.tmpMergeIndex++;let H=0,$=R.vertexX,J=R.vertexCount;if(_.vertexNormal&&_.vertexNormalOriginal)for(let O=0;O<_.vertexCount;O++){let q=_.vertexNormal[O],b=_.vertexNormalOriginal[O];if(b&&b.w!==0){let U=_.vertexY[O]-G;if(U>R.minY)continue;let N=_.vertexX[O]-L;if(N<R.minX||N>R.maxX)continue;let I=_.vertexZ[O]-K;if(I<R.minZ||I>R.maxZ)continue;if(R.vertexNormal&&R.vertexNormalOriginal)for(let k=0;k<J;k++){let F=R.vertexNormal[k],T=R.vertexNormalOriginal[k];if(N!==$[k]||I!==R.vertexZ[k]||U!==R.vertexY[k]||T&&T.w===0)continue;if(q&&F&&T)q.x+=T.x,q.y+=T.y,q.z+=T.z,q.w+=T.w,F.x+=b.x,F.y+=b.y,F.z+=b.z,F.w+=b.w,H++;this.mergeIndexA[O]=this.tmpMergeIndex,this.mergeIndexB[k]=this.tmpMergeIndex}}}if(H<3||!Q)return;if(_.faceInfo){for(let O=0;O<_.faceCount;O++)if(this.mergeIndexA[_.faceVertexA[O]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexB[O]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexC[O]]===this.tmpMergeIndex)_.faceInfo[O]=-1}if(R.faceInfo){for(let O=0;O<R.faceCount;O++)if(this.mergeIndexB[R.faceVertexA[O]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexB[O]]===this.tmpMergeIndex&&this.mergeIndexB[R.faceVertexC[O]]===this.tmpMergeIndex)R.faceInfo[O]=-1}};drawMinimapTile=(_,R,L,G,K,Q)=>{let H=this.levelTiles[_][R][L];if(!H)return;let $=H.underlay;if($){let F=$.color;if(F!==0)for(let T=0;T<4;T++)G[K]=F,G[K+1]=F,G[K+2]=F,G[K+3]=F,K+=Q;return}let J=H.overlay;if(!J)return;let{shape:O,angle:q,backgroundRgb:b,foregroundRgb:U}=J,N=V.MINIMAP_TILE_MASK[O],I=V.MINIMAP_TILE_ROTATION_MAP[q],k=0;if(b!==0){for(let F=0;F<4;F++)G[K]=N[I[k++]]===0?b:U,G[K+1]=N[I[k++]]===0?b:U,G[K+2]=N[I[k++]]===0?b:U,G[K+3]=N[I[k++]]===0?b:U,K+=Q;return}for(let F=0;F<4;F++){if(N[I[k++]]!==0)G[K]=U;if(N[I[k++]]!==0)G[K+1]=U;if(N[I[k++]]!==0)G[K+2]=U;if(N[I[k++]]!==0)G[K+3]=U;K+=Q}};click=(_,R)=>{V.takingInput=!0,V.mouseX=_,V.mouseY=R,V.clickTileX=-1,V.clickTileZ=-1};draw=(_,R,L,G,K,Q,H)=>{if(_<0)_=0;else if(_>=this.maxTileX*128)_=this.maxTileX*128-1;if(L<0)L=0;else if(L>=this.maxTileZ*128)L=this.maxTileZ*128-1;if(V.cycle++,V.sinEyePitch=h.sin[Q],V.cosEyePitch=h.cos[Q],V.sinEyeYaw=h.sin[K],V.cosEyeYaw=h.cos[K],V.visibilityMap=V.visibilityMatrix[(Q-128)/32|0][K/64|0],V.eyeX=_,V.eyeY=R,V.eyeZ=L,V.eyeTileX=_/128|0,V.eyeTileZ=L/128|0,V.topLevel=G,V.minDrawTileX=V.eyeTileX-25,V.minDrawTileX<0)V.minDrawTileX=0;if(V.minDrawTileZ=V.eyeTileZ-25,V.minDrawTileZ<0)V.minDrawTileZ=0;if(V.maxDrawTileX=V.eyeTileX+25,V.maxDrawTileX>this.maxTileX)V.maxDrawTileX=this.maxTileX;if(V.maxDrawTileZ=V.eyeTileZ+25,V.maxDrawTileZ>this.maxTileZ)V.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),V.tilesRemaining=0;for(let $=this.minLevel;$<this.maxLevel;$++){let J=this.levelTiles[$];for(let O=V.minDrawTileX;O<V.maxDrawTileX;O++)for(let q=V.minDrawTileZ;q<V.maxDrawTileZ;q++){let b=J[O][q];if(!b)continue;if(b.drawLevel<=G&&(V.visibilityMap[O+25-V.eyeTileX][q+25-V.eyeTileZ]||this.levelHeightmaps[$][O][q]-R>=2000))b.visible=!0,b.update=!0,b.containsLocs=b.locCount>0,V.tilesRemaining++;else b.visible=!1,b.update=!1,b.checkLocSpans=0}}for(let $=this.minLevel;$<this.maxLevel;$++){let J=this.levelTiles[$];for(let O=-25;O<=0;O++){let q=V.eyeTileX+O,b=V.eyeTileX-O;if(q<V.minDrawTileX&&b>=V.maxDrawTileX)continue;for(let U=-25;U<=0;U++){let N=V.eyeTileZ+U,I=V.eyeTileZ-U,k;if(q>=V.minDrawTileX){if(N>=V.minDrawTileZ){if(k=J[q][N],k&&k.visible)this.drawTile(k,!0,H)}if(I<V.maxDrawTileZ){if(k=J[q][I],k&&k.visible)this.drawTile(k,!0,H)}}if(b<V.maxDrawTileX){if(N>=V.minDrawTileZ){if(k=J[b][N],k&&k.visible)this.drawTile(k,!0,H)}if(I<V.maxDrawTileZ){if(k=J[b][I],k&&k.visible)this.drawTile(k,!0,H)}}if(V.tilesRemaining===0){V.takingInput=!1;return}}}}for(let $=this.minLevel;$<this.maxLevel;$++){let J=this.levelTiles[$];for(let O=-25;O<=0;O++){let q=V.eyeTileX+O,b=V.eyeTileX-O;if(q<V.minDrawTileX&&b>=V.maxDrawTileX)continue;for(let U=-25;U<=0;U++){let N=V.eyeTileZ+U,I=V.eyeTileZ-U,k;if(q>=V.minDrawTileX){if(N>=V.minDrawTileZ){if(k=J[q][N],k&&k.visible)this.drawTile(k,!1,H)}if(I<V.maxDrawTileZ){if(k=J[q][I],k&&k.visible)this.drawTile(k,!1,H)}}if(b<V.maxDrawTileX){if(N>=V.minDrawTileZ){if(k=J[b][N],k&&k.visible)this.drawTile(k,!1,H)}if(I<V.maxDrawTileZ){if(k=J[b][I],k&&k.visible)this.drawTile(k,!1,H)}}if(V.tilesRemaining===0){V.takingInput=!1;return}}}}};addLoc2=(_,R,L,G,K,Q,H,$,J,O,q,b,U,N)=>{if(!J&&!O)return!1;for(let k=K;k<K+H;k++)for(let F=Q;F<Q+$;F++){if(k<0||F<0||k>=this.maxTileX||F>=this.maxTileZ)return!1;let T=this.levelTiles[G][k][F];if(T&&T.locCount>=5)return!1}let I=new W8(G,L,_,R,J,O,U,K,K+H-1,Q,Q+$-1,q,b);for(let k=K;k<K+H;k++)for(let F=Q;F<Q+$;F++){let T=0;if(k>K)T|=1;if(k<K+H-1)T+=4;if(F>Q)T+=8;if(F<Q+$-1)T+=2;for(let u=G;u>=0;u--)if(!this.levelTiles[u][k][F])this.levelTiles[u][k][F]=new R1(u,k,F);let Y=this.levelTiles[G][k][F];if(Y)Y.locs[Y.locCount]=I,Y.locSpan[Y.locCount]=T,Y.locSpans|=T,Y.locCount++}if(N)this.temporaryLocs[this.temporaryLocCount++]=I;return!0};removeLoc2=(_)=>{for(let R=_.minSceneTileX;R<=_.maxSceneTileX;R++)for(let L=_.minSceneTileZ;L<=_.maxSceneTileZ;L++){let G=this.levelTiles[_.level][R][L];if(!G)continue;for(let K=0;K<G.locCount;K++)if(G.locs[K]===_){G.locCount--;for(let Q=K;Q<G.locCount;Q++)G.locs[Q]=G.locs[Q+1],G.locSpan[Q]=G.locSpan[Q+1];G.locs[G.locCount]=null;break}G.locSpans=0;for(let K=0;K<G.locCount;K++)G.locSpans|=G.locSpan[K]}};updateActiveOccluders=()=>{let _=V.levelOccluderCount[V.topLevel],R=V.levelOccluders[V.topLevel];V.activeOccluderCount=0;for(let L=0;L<_;L++){let G=R[L];if(!G)continue;let K,Q,H,$;if(G.type===1){if(K=G.minTileX+25-V.eyeTileX,K>=0&&K<=50){if(Q=G.minTileZ+25-V.eyeTileZ,Q<0)Q=0;if(H=G.maxTileZ+25-V.eyeTileZ,H>50)H=50;let J=!1;while(Q<=H)if(V.visibilityMap&&V.visibilityMap[K][Q++]){J=!0;break}if(J){if($=V.eyeX-G.minX,$>32)G.mode=1;else{if($>=-32)continue;G.mode=2,$=-$}G.minDeltaZ=(G.minZ-V.eyeZ<<8)/$|0,G.maxDeltaZ=(G.maxZ-V.eyeZ<<8)/$|0,G.minDeltaY=(G.minY-V.eyeY<<8)/$|0,G.maxDeltaY=(G.maxY-V.eyeY<<8)/$|0,V.activeOccluders[V.activeOccluderCount++]=G}}}else if(G.type===2){if(K=G.minTileZ+25-V.eyeTileZ,K>=0&&K<=50){if(Q=G.minTileX+25-V.eyeTileX,Q<0)Q=0;if(H=G.maxTileX+25-V.eyeTileX,H>50)H=50;let J=!1;while(Q<=H)if(V.visibilityMap&&V.visibilityMap[Q++][K]){J=!0;break}if(J){if($=V.eyeZ-G.minZ,$>32)G.mode=3;else{if($>=-32)continue;G.mode=4,$=-$}G.minDeltaX=(G.minX-V.eyeX<<8)/$|0,G.maxDeltaX=(G.maxX-V.eyeX<<8)/$|0,G.minDeltaY=(G.minY-V.eyeY<<8)/$|0,G.maxDeltaY=(G.maxY-V.eyeY<<8)/$|0,V.activeOccluders[V.activeOccluderCount++]=G}}}else if(G.type===4){if(K=G.minY-V.eyeY,K>128){if(Q=G.minTileZ+25-V.eyeTileZ,Q<0)Q=0;if(H=G.maxTileZ+25-V.eyeTileZ,H>50)H=50;if(Q<=H){let J=G.minTileX+25-V.eyeTileX;if(J<0)J=0;if($=G.maxTileX+25-V.eyeTileX,$>50)$=50;let O=!1;_:for(let q=J;q<=$;q++)for(let b=Q;b<=H;b++)if(V.visibilityMap&&V.visibilityMap[q][b]){O=!0;break _}if(O)G.mode=5,G.minDeltaX=(G.minX-V.eyeX<<8)/K|0,G.maxDeltaX=(G.maxX-V.eyeX<<8)/K|0,G.minDeltaZ=(G.minZ-V.eyeZ<<8)/K|0,G.maxDeltaZ=(G.maxZ-V.eyeZ<<8)/K|0,V.activeOccluders[V.activeOccluderCount++]=G}}}}};drawTile=(_,R,L)=>{V.drawTileQueue.addTail(_);while(!0){let G;do if(G=V.drawTileQueue.removeHead(),!G)return;while(!G.update);let{x:K,z:Q,level:H,occludeLevel:$}=G,J=this.levelTiles[H];if(G.visible){if(R){if(H>0){let F=this.levelTiles[H-1][K][Q];if(F&&F.update)continue}if(K<=V.eyeTileX&&K>V.minDrawTileX){let F=J[K-1][Q];if(F&&F.update&&(F.visible||(G.locSpans&1)===0))continue}if(K>=V.eyeTileX&&K<V.maxDrawTileX-1){let F=J[K+1][Q];if(F&&F.update&&(F.visible||(G.locSpans&4)===0))continue}if(Q<=V.eyeTileZ&&Q>V.minDrawTileZ){let F=J[K][Q-1];if(F&&F.update&&(F.visible||(G.locSpans&8)===0))continue}if(Q>=V.eyeTileZ&&Q<V.maxDrawTileZ-1){let F=J[K][Q+1];if(F&&F.update&&(F.visible||(G.locSpans&2)===0))continue}}else R=!0;if(G.visible=!1,G.bridge){let F=G.bridge;if(!F.underlay){if(F.overlay&&!this.tileVisible(0,K,Q))this.drawTileOverlay(K,Q,F.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(0,K,Q))this.drawTileUnderlay(F.underlay,0,K,Q,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let T=F.wall;if(T)T.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset);for(let Y=0;Y<F.locCount;Y++){let u=F.locs[Y];if(u){let w=u.model;if(!w)w=u.entity?.draw(L)??null;w?.draw(u.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,u.x-V.eyeX,u.y-V.eyeY,u.z-V.eyeZ,u.bitset)}}}let q=!1;if(!G.underlay){if(G.overlay&&!this.tileVisible($,K,Q))q=!0,this.drawTileOverlay(K,Q,G.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible($,K,Q))q=!0,this.drawTileUnderlay(G.underlay,$,K,Q,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let b=0,U=0,N=G.wall,I=G.wallDecoration;if(N||I){if(V.eyeTileX===K)b+=1;else if(V.eyeTileX<K)b+=2;if(V.eyeTileZ===Q)b+=3;else if(V.eyeTileZ>Q)b+=6;U=V.FRONT_WALL_TYPES[b],G.backWallTypes=V.BACK_WALL_TYPES[b]}if(N){if((N.typeA&V.DIRECTION_ALLOW_WALL_CORNER_TYPE[b])===0)G.checkLocSpans=0;else if(N.typeA===16)G.checkLocSpans=3,G.blockLocSpans=V.WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS[b],G.inverseBlockLocSpans=3-G.blockLocSpans;else if(N.typeA===32)G.checkLocSpans=6,G.blockLocSpans=V.WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS[b],G.inverseBlockLocSpans=6-G.blockLocSpans;else if(N.typeA===64)G.checkLocSpans=12,G.blockLocSpans=V.WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS[b],G.inverseBlockLocSpans=12-G.blockLocSpans;else G.checkLocSpans=9,G.blockLocSpans=V.WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS[b],G.inverseBlockLocSpans=9-G.blockLocSpans;if((N.typeA&U)!==0&&!this.wallVisible($,K,Q,N.typeA))N.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,N.x-V.eyeX,N.y-V.eyeY,N.z-V.eyeZ,N.bitset);if((N.typeB&U)!==0&&!this.wallVisible($,K,Q,N.typeB))N.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,N.x-V.eyeX,N.y-V.eyeY,N.z-V.eyeZ,N.bitset)}if(I&&!this.visible($,K,Q,I.model.maxY)){if((I.type&U)!==0)I.model.draw(I.angle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,I.x-V.eyeX,I.y-V.eyeY,I.z-V.eyeZ,I.bitset);else if((I.type&768)!==0){let F=I.x-V.eyeX,T=I.y-V.eyeY,Y=I.z-V.eyeZ,u=I.angle,w;if(u===x.NORTH||u===x.EAST)w=-F;else w=F;let B;if(u===x.EAST||u===x.SOUTH)B=-Y;else B=Y;if((I.type&256)!==0&&B<w){let v=F+V.WALL_DECORATION_INSET_X[u],n=Y+V.WALL_DECORATION_INSET_Z[u];I.model.draw(u*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,v,T,n,I.bitset)}if((I.type&512)!==0&&B>w){let v=F+V.WALL_DECORATION_OUTSET_X[u],n=Y+V.WALL_DECORATION_OUTSET_Z[u];I.model.draw(u*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,v,T,n,I.bitset)}}}if(q){let F=G.groundDecoration;if(F)F.model?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,F.x-V.eyeX,F.y-V.eyeY,F.z-V.eyeZ,F.bitset);let T=G.objStack;if(T&&T.offset===0){if(T.bottomObj)T.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset);if(T.middleObj)T.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset);if(T.topObj)T.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,T.x-V.eyeX,T.y-V.eyeY,T.z-V.eyeZ,T.bitset)}}let k=G.locSpans;if(k!==0){if(K<V.eyeTileX&&(k&4)!==0){let F=J[K+1][Q];if(F&&F.update)V.drawTileQueue.addTail(F)}if(Q<V.eyeTileZ&&(k&2)!==0){let F=J[K][Q+1];if(F&&F.update)V.drawTileQueue.addTail(F)}if(K>V.eyeTileX&&(k&1)!==0){let F=J[K-1][Q];if(F&&F.update)V.drawTileQueue.addTail(F)}if(Q>V.eyeTileZ&&(k&8)!==0){let F=J[K][Q-1];if(F&&F.update)V.drawTileQueue.addTail(F)}}}if(G.checkLocSpans!==0){let q=!0;for(let b=0;b<G.locCount;b++){let U=G.locs[b];if(!U)continue;if(U.cycle!==V.cycle&&(G.locSpan[b]&G.checkLocSpans)===G.blockLocSpans){q=!1;break}}if(q){let b=G.wall;if(b&&!this.wallVisible($,K,Q,b.typeA))b.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY,b.z-V.eyeZ,b.bitset);G.checkLocSpans=0}}if(G.containsLocs){let q=G.locCount;G.containsLocs=!1;let b=0;_:for(let U=0;U<q;U++){let N=G.locs[U];if(!N||N.cycle===V.cycle)continue;for(let Y=N.minSceneTileX;Y<=N.maxSceneTileX;Y++)for(let u=N.minSceneTileZ;u<=N.maxSceneTileZ;u++){let w=J[Y][u];if(!w)continue;if(!w.visible){if(w.checkLocSpans===0)continue;let B=0;if(Y>N.minSceneTileX)B+=1;if(Y<N.maxSceneTileX)B+=4;if(u>N.minSceneTileZ)B+=8;if(u<N.maxSceneTileZ)B+=2;if((B&w.checkLocSpans)!==G.inverseBlockLocSpans)continue}G.containsLocs=!0;continue _}V.locBuffer[b++]=N;let I=V.eyeTileX-N.minSceneTileX,k=N.maxSceneTileX-V.eyeTileX;if(k>I)I=k;let F=V.eyeTileZ-N.minSceneTileZ,T=N.maxSceneTileZ-V.eyeTileZ;if(T>F)N.distance=I+T;else N.distance=I+F}while(!0){let U=-50,N=-1;for(let k=0;k<b;k++){let F=V.locBuffer[k];if(!F)continue;if(F.cycle!==V.cycle){if(F.distance>U)U=F.distance,N=k}}if(N===-1)break;let I=V.locBuffer[N];if(I){I.cycle=V.cycle;let k=I.model;if(!k)k=I.entity?.draw(L)??null;if(k&&!this.locVisible($,I.minSceneTileX,I.maxSceneTileX,I.minSceneTileZ,I.maxSceneTileZ,k.maxY))k.draw(I.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,I.x-V.eyeX,I.y-V.eyeY,I.z-V.eyeZ,I.bitset);for(let F=I.minSceneTileX;F<=I.maxSceneTileX;F++)for(let T=I.minSceneTileZ;T<=I.maxSceneTileZ;T++){let Y=J[F][T];if(!Y)continue;if(Y.checkLocSpans!==0)V.drawTileQueue.addTail(Y);else if((F!==K||T!==Q)&&Y.update)V.drawTileQueue.addTail(Y)}}}if(G.containsLocs)continue}if(!G.update||G.checkLocSpans!==0)continue;if(K<=V.eyeTileX&&K>V.minDrawTileX){let q=J[K-1][Q];if(q&&q.update)continue}if(K>=V.eyeTileX&&K<V.maxDrawTileX-1){let q=J[K+1][Q];if(q&&q.update)continue}if(Q<=V.eyeTileZ&&Q>V.minDrawTileZ){let q=J[K][Q-1];if(q&&q.update)continue}if(Q>=V.eyeTileZ&&Q<V.maxDrawTileZ-1){let q=J[K][Q+1];if(q&&q.update)continue}G.update=!1,V.tilesRemaining--;let O=G.objStack;if(O&&O.offset!==0){if(O.bottomObj)O.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY-O.offset,O.z-V.eyeZ,O.bitset);if(O.middleObj)O.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY-O.offset,O.z-V.eyeZ,O.bitset);if(O.topObj)O.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,O.x-V.eyeX,O.y-V.eyeY-O.offset,O.z-V.eyeZ,O.bitset)}if(G.backWallTypes!==0){let q=G.wallDecoration;if(q&&!this.visible($,K,Q,q.model.maxY)){if((q.type&G.backWallTypes)!==0)q.model.draw(q.angle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,q.x-V.eyeX,q.y-V.eyeY,q.z-V.eyeZ,q.bitset);else if((q.type&768)!==0){let U=q.x-V.eyeX,N=q.y-V.eyeY,I=q.z-V.eyeZ,k=q.angle,F;if(k===x.NORTH||k===x.EAST)F=-U;else F=U;let T;if(k===x.EAST||k===x.SOUTH)T=-I;else T=I;if((q.type&256)!==0&&T>=F){let Y=U+V.WALL_DECORATION_INSET_X[k],u=I+V.WALL_DECORATION_INSET_Z[k];q.model.draw(k*512+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Y,N,u,q.bitset)}if((q.type&512)!==0&&T<=F){let Y=U+V.WALL_DECORATION_OUTSET_X[k],u=I+V.WALL_DECORATION_OUTSET_Z[k];q.model.draw(k*512+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,Y,N,u,q.bitset)}}}let b=G.wall;if(b){if((b.typeB&G.backWallTypes)!==0&&!this.wallVisible($,K,Q,b.typeB))b.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY,b.z-V.eyeZ,b.bitset);if((b.typeA&G.backWallTypes)!==0&&!this.wallVisible($,K,Q,b.typeA))b.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY,b.z-V.eyeZ,b.bitset)}}if(H<this.maxLevel-1){let q=this.levelTiles[H+1][K][Q];if(q&&q.update)V.drawTileQueue.addTail(q)}if(K<V.eyeTileX){let q=J[K+1][Q];if(q&&q.update)V.drawTileQueue.addTail(q)}if(Q<V.eyeTileZ){let q=J[K][Q+1];if(q&&q.update)V.drawTileQueue.addTail(q)}if(K>V.eyeTileX){let q=J[K-1][Q];if(q&&q.update)V.drawTileQueue.addTail(q)}if(Q>V.eyeTileZ){let q=J[K][Q-1];if(q&&q.update)V.drawTileQueue.addTail(q)}}};drawTileUnderlay=(_,R,L,G,K,Q,H,$)=>{let J,O=J=(L<<7)-V.eyeX,q,b=q=(G<<7)-V.eyeZ,U,N=U=O+128,I,k=I=b+128,F=this.levelHeightmaps[R][L][G]-V.eyeY,T=this.levelHeightmaps[R][L+1][G]-V.eyeY,Y=this.levelHeightmaps[R][L+1][G+1]-V.eyeY,u=this.levelHeightmaps[R][L][G+1]-V.eyeY,w=b*H+O*$>>16;if(b=b*$-O*H>>16,O=w,w=F*Q-b*K>>16,b=F*K+b*Q>>16,F=w,b<50)return;if(w=q*H+N*$>>16,q=q*$-N*H>>16,N=w,w=T*Q-q*K>>16,q=T*K+q*Q>>16,T=w,q<50)return;if(w=k*H+U*$>>16,k=k*$-U*H>>16,U=w,w=Y*Q-k*K>>16,k=Y*K+k*Q>>16,Y=w,k<50)return;if(w=I*H+J*$>>16,I=I*$-J*H>>16,J=w,w=u*Q-I*K>>16,I=u*K+I*Q>>16,u=w,I<50)return;let B=h.centerX+((O<<9)/b|0),v=h.centerY+((F<<9)/b|0),n=h.centerX+((N<<9)/q|0),W=h.centerY+((T<<9)/q|0),P=h.centerX+((U<<9)/k|0),z=h.centerY+((Y<<9)/k|0),f=h.centerX+((J<<9)/I|0),m=h.centerY+((u<<9)/I|0);if(h.alpha=0,(P-f)*(W-m)-(z-m)*(n-f)>0){if(h.clipX=P<0||f<0||n<0||P>j.boundX||f>j.boundX||n>j.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,z,m,W,P,f,n))V.clickTileX=L,V.clickTileZ=G;if(_.textureId===-1){if(_.northeastColor!==12345678)h.fillGouraudTriangle(P,f,n,z,m,W,_.northeastColor,_.northwestColor,_.southeastColor)}else if(V.lowMemory){let M=V.TEXTURE_HSL[_.textureId];h.fillGouraudTriangle(P,f,n,z,m,W,this.mulLightness(M,_.northeastColor),this.mulLightness(M,_.northwestColor),this.mulLightness(M,_.southeastColor))}else if(_.flat)h.fillTexturedTriangle(P,f,n,z,m,W,_.northeastColor,_.northwestColor,_.southeastColor,O,F,b,N,J,T,u,q,I,_.textureId);else h.fillTexturedTriangle(P,f,n,z,m,W,_.northeastColor,_.northwestColor,_.southeastColor,U,Y,k,J,N,u,T,I,q,_.textureId)}if((B-n)*(m-W)-(v-W)*(f-n)<=0)return;if(h.clipX=B<0||n<0||f<0||B>j.boundX||n>j.boundX||f>j.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,v,W,m,B,n,f))V.clickTileX=L,V.clickTileZ=G;if(_.textureId!==-1){if(!V.lowMemory){h.fillTexturedTriangle(B,n,f,v,W,m,_.southwestColor,_.southeastColor,_.northwestColor,O,F,b,N,J,T,u,q,I,_.textureId);return}let M=V.TEXTURE_HSL[_.textureId];h.fillGouraudTriangle(B,n,f,v,W,m,this.mulLightness(M,_.southwestColor),this.mulLightness(M,_.southeastColor),this.mulLightness(M,_.northwestColor))}else if(_.southwestColor!==12345678)h.fillGouraudTriangle(B,n,f,v,W,m,_.southwestColor,_.southeastColor,_.northwestColor)};drawTileOverlay=(_,R,L,G,K,Q,H)=>{let $=L.vertexX.length;for(let J=0;J<$;J++){let O=L.vertexX[J]-V.eyeX,q=L.vertexY[J]-V.eyeY,b=L.vertexZ[J]-V.eyeZ,U=b*Q+O*H>>16;if(b=b*H-O*Q>>16,O=U,U=q*K-b*G>>16,b=q*G+b*K>>16,q=U,b<50)return;if(L.triangleTextureIds)R0.tmpViewspaceX[J]=O,R0.tmpViewspaceY[J]=q,R0.tmpViewspaceZ[J]=b;R0.tmpScreenX[J]=h.centerX+((O<<9)/b|0),R0.tmpScreenY[J]=h.centerY+((q<<9)/b|0)}h.alpha=0,$=L.triangleVertexA.length;for(let J=0;J<$;J++){let O=L.triangleVertexA[J],q=L.triangleVertexB[J],b=L.triangleVertexC[J],U=R0.tmpScreenX[O],N=R0.tmpScreenX[q],I=R0.tmpScreenX[b],k=R0.tmpScreenY[O],F=R0.tmpScreenY[q],T=R0.tmpScreenY[b];if((U-N)*(T-F)-(k-F)*(I-N)>0){if(h.clipX=U<0||N<0||I<0||U>j.boundX||N>j.boundX||I>j.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,k,F,T,U,N,I))V.clickTileX=_,V.clickTileZ=R;if(!L.triangleTextureIds||L.triangleTextureIds[J]===-1){if(L.triangleColorA[J]!==12345678)h.fillGouraudTriangle(U,N,I,k,F,T,L.triangleColorA[J],L.triangleColorB[J],L.triangleColorC[J])}else if(V.lowMemory){let Y=V.TEXTURE_HSL[L.triangleTextureIds[J]];h.fillGouraudTriangle(U,N,I,k,F,T,this.mulLightness(Y,L.triangleColorA[J]),this.mulLightness(Y,L.triangleColorB[J]),this.mulLightness(Y,L.triangleColorC[J]))}else if(L.flat)h.fillTexturedTriangle(U,N,I,k,F,T,L.triangleColorA[J],L.triangleColorB[J],L.triangleColorC[J],R0.tmpViewspaceX[0],R0.tmpViewspaceY[0],R0.tmpViewspaceZ[0],R0.tmpViewspaceX[1],R0.tmpViewspaceX[3],R0.tmpViewspaceY[1],R0.tmpViewspaceY[3],R0.tmpViewspaceZ[1],R0.tmpViewspaceZ[3],L.triangleTextureIds[J]);else h.fillTexturedTriangle(U,N,I,k,F,T,L.triangleColorA[J],L.triangleColorB[J],L.triangleColorC[J],R0.tmpViewspaceX[O],R0.tmpViewspaceY[O],R0.tmpViewspaceZ[O],R0.tmpViewspaceX[q],R0.tmpViewspaceX[b],R0.tmpViewspaceY[q],R0.tmpViewspaceY[b],R0.tmpViewspaceZ[q],R0.tmpViewspaceZ[b],L.triangleTextureIds[J])}}};tileVisible=(_,R,L)=>{let G=this.levelTileOcclusionCycles[_][R][L];if(G===-V.cycle)return!1;else if(G===V.cycle)return!0;else{let K=R<<7,Q=L<<7;if(this.occluded(K+1,this.levelHeightmaps[_][R][L],Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L],Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L+1],Q+128-1)&&this.occluded(K+1,this.levelHeightmaps[_][R][L+1],Q+128-1))return this.levelTileOcclusionCycles[_][R][L]=V.cycle,!0;else return this.levelTileOcclusionCycles[_][R][L]=-V.cycle,!1}};wallVisible=(_,R,L,G)=>{if(!this.tileVisible(_,R,L))return!1;let K=R<<7,Q=L<<7,H=this.levelHeightmaps[_][R][L]-1,$=H-120,J=H-230,O=H-238;if(G<16){if(G===1){if(K>V.eyeX){if(!this.occluded(K,H,Q))return!1;if(!this.occluded(K,H,Q+128))return!1}if(_>0){if(!this.occluded(K,$,Q))return!1;if(!this.occluded(K,$,Q+128))return!1}if(!this.occluded(K,J,Q))return!1;return this.occluded(K,J,Q+128)}if(G===2){if(Q<V.eyeZ){if(!this.occluded(K,H,Q+128))return!1;if(!this.occluded(K+128,H,Q+128))return!1}if(_>0){if(!this.occluded(K,$,Q+128))return!1;if(!this.occluded(K+128,$,Q+128))return!1}if(!this.occluded(K,J,Q+128))return!1;return this.occluded(K+128,J,Q+128)}if(G===4){if(K<V.eyeX){if(!this.occluded(K+128,H,Q))return!1;if(!this.occluded(K+128,H,Q+128))return!1}if(_>0){if(!this.occluded(K+128,$,Q))return!1;if(!this.occluded(K+128,$,Q+128))return!1}if(!this.occluded(K+128,J,Q))return!1;return this.occluded(K+128,J,Q+128)}if(G===8){if(Q>V.eyeZ){if(!this.occluded(K,H,Q))return!1;if(!this.occluded(K+128,H,Q))return!1}if(_>0){if(!this.occluded(K,$,Q))return!1;if(!this.occluded(K+128,$,Q))return!1}if(!this.occluded(K,J,Q))return!1;return this.occluded(K+128,J,Q)}}if(!this.occluded(K+64,O,Q+64))return!1;else if(G===16)return this.occluded(K,J,Q+128);else if(G===32)return this.occluded(K+128,J,Q+128);else if(G===64)return this.occluded(K+128,J,Q);else if(G===128)return this.occluded(K,J,Q);return!0};visible=(_,R,L,G)=>{if(this.tileVisible(_,R,L)){let K=R<<7,Q=L<<7;return this.occluded(K+1,this.levelHeightmaps[_][R][L]-G,Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L]-G,Q+1)&&this.occluded(K+128-1,this.levelHeightmaps[_][R+1][L+1]-G,Q+128-1)&&this.occluded(K+1,this.levelHeightmaps[_][R][L+1]-G,Q+128-1)}return!1};locVisible=(_,R,L,G,K,Q)=>{let H,$;if(R!==L||G!==K){for(H=R;H<=L;H++)for($=G;$<=K;$++)if(this.levelTileOcclusionCycles[_][H][$]===-V.cycle)return!1;$=(R<<7)+1;let J=(G<<7)+2,O=this.levelHeightmaps[_][R][G]-Q;if(!this.occluded($,O,J))return!1;let q=(L<<7)-1;if(!this.occluded(q,O,J))return!1;let b=(K<<7)-1;if(!this.occluded($,O,b))return!1;else return this.occluded(q,O,b)}else if(this.tileVisible(_,R,G))return H=R<<7,$=G<<7,this.occluded(H+1,this.levelHeightmaps[_][R][G]-Q,$+1)&&this.occluded(H+128-1,this.levelHeightmaps[_][R+1][G]-Q,$+1)&&this.occluded(H+128-1,this.levelHeightmaps[_][R+1][G+1]-Q,$+128-1)&&this.occluded(H+1,this.levelHeightmaps[_][R][G+1]-Q,$+128-1);return!1};occluded=(_,R,L)=>{for(let G=0;G<V.activeOccluderCount;G++){let K=V.activeOccluders[G];if(!K)continue;if(K.mode===1){let Q=K.minX-_;if(Q>0){let H=K.minZ+(K.minDeltaZ*Q>>8),$=K.maxZ+(K.maxDeltaZ*Q>>8),J=K.minY+(K.minDeltaY*Q>>8),O=K.maxY+(K.maxDeltaY*Q>>8);if(L>=H&&L<=$&&R>=J&&R<=O)return!0}}else if(K.mode===2){let Q=_-K.minX;if(Q>0){let H=K.minZ+(K.minDeltaZ*Q>>8),$=K.maxZ+(K.maxDeltaZ*Q>>8),J=K.minY+(K.minDeltaY*Q>>8),O=K.maxY+(K.maxDeltaY*Q>>8);if(L>=H&&L<=$&&R>=J&&R<=O)return!0}}else if(K.mode===3){let Q=K.minZ-L;if(Q>0){let H=K.minX+(K.minDeltaX*Q>>8),$=K.maxX+(K.maxDeltaX*Q>>8),J=K.minY+(K.minDeltaY*Q>>8),O=K.maxY+(K.maxDeltaY*Q>>8);if(_>=H&&_<=$&&R>=J&&R<=O)return!0}}else if(K.mode===4){let Q=L-K.minZ;if(Q>0){let H=K.minX+(K.minDeltaX*Q>>8),$=K.maxX+(K.maxDeltaX*Q>>8),J=K.minY+(K.minDeltaY*Q>>8),O=K.maxY+(K.maxDeltaY*Q>>8);if(_>=H&&_<=$&&R>=J&&R<=O)return!0}}else if(K.mode===5){let Q=R-K.minY;if(Q>0){let H=K.minX+(K.minDeltaX*Q>>8),$=K.maxX+(K.maxDeltaX*Q>>8),J=K.minZ+(K.minDeltaZ*Q>>8),O=K.maxZ+(K.maxDeltaZ*Q>>8);if(_>=H&&_<=$&&L>=J&&L<=O)return!0}}}return!1};pointInsideTriangle=(_,R,L,G,K,Q,H,$)=>{if(R<L&&R<G&&R<K)return!1;else if(R>L&&R>G&&R>K)return!1;else if(_<Q&&_<H&&_<$)return!1;else if(_>Q&&_>H&&_>$)return!1;let J=(R-L)*(H-Q)-(_-Q)*(G-L),O=(R-K)*(Q-$)-(_-$)*(L-K),q=(R-G)*($-H)-(_-H)*(K-G);return J*q>0&&q*O>0};mulLightness=(_,R)=>{if(R=(127-R)*(_&127)/160|0,R<2)R=2;else if(R>126)R=126;return(_&65408)+R}}class X0 extends D0{heightmapSW;heightmapSE;heightmapNE;heightmapNW;index;seq;seqFrame;seqCycle;constructor(_,R,L,G,K,Q,H){super();if(this.heightmapSW=R,this.heightmapSE=L,this.heightmapNE=G,this.heightmapNW=K,this.index=_,this.seq=Q,H&&Q.replayoff!==-1&&this.seq.delay)this.seqFrame=Math.random()*this.seq.frameCount|0,this.seqCycle=Math.random()*this.seq.delay[this.seqFrame]|0;else this.seqFrame=-1,this.seqCycle=0}}class H0{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin=(_,R)=>{let L=this.perlinScale(_+45365,R+91923,4)+(this.perlinScale(_+10294,R+37821,2)-128>>1)+(this.perlinScale(_,R,1)-128>>2)-128;if(L=(L*0.3|0)+35,L<10)L=10;else if(L>60)L=60;return L};static perlinScale=(_,R,L)=>{let G=_/L|0,K=_&L-1,Q=R/L|0,H=R&L-1,$=this.smoothNoise(G,Q),J=this.smoothNoise(G+1,Q),O=this.smoothNoise(G,Q+1),q=this.smoothNoise(G+1,Q+1),b=this.interpolate($,J,K,L),U=this.interpolate(O,q,K,L);return this.interpolate(b,U,H,L)};static interpolate=(_,R,L,G)=>{let K=65536-h.cos[L*1024/G|0]>>1;return(_*(65536-K)>>16)+(R*K>>16)};static smoothNoise=(_,R)=>{let L=this.noise(_-1,R-1)+this.noise(_+1,R-1)+this.noise(_-1,R+1)+this.noise(_+1,R+1),G=this.noise(_-1,R)+this.noise(_+1,R)+this.noise(_,R-1)+this.noise(_,R+1),K=this.noise(_,R);return(L/16|0)+(G/8|0)+(K/4|0)};static noise=(_,R)=>{let L=_+R*57,G=BigInt(L<<13^L);return Number((G*(G*G*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255};static addLoc=(_,R,L,G,K,Q,H,$,J,O,q)=>{let b=K[q][R][L],U=K[q][R+1][L],N=K[q][R+1][L+1],I=K[q][R][L+1],k=b+U+N+I>>2,F=B0.get($),T=R+(L<<7)+($<<14)+1073741824|0;if(!F.active)T+=-2147483648;T|=0;let Y=((O<<6)+J|0)<<24>>24;if(J===y.GROUND_DECOR.id){if(G?.addGroundDecoration(F.getModel(y.GROUND_DECOR.id,O,b,U,N,I,-1),_,R,L,k,T,Y),F.blockwalk&&F.active)H?.addFloor(R,L);if(F.anim!==-1)Q.addTail(new X0($,_,3,R,L,_0.instances[F.anim],!0))}else if(J===y.CENTREPIECE_STRAIGHT.id||J===y.CENTREPIECE_DIAGONAL.id){let u=F.getModel(y.CENTREPIECE_STRAIGHT.id,O,b,U,N,I,-1);if(u){let w=0;if(J===y.CENTREPIECE_DIAGONAL.id)w+=256;let B,v;if(O===x.NORTH||O===x.SOUTH)B=F.length,v=F.width;else B=F.width,v=F.length;G?.addLoc(_,R,L,k,u,null,T,Y,B,v,w)}if(F.blockwalk)H?.addLoc(R,L,F.width,F.length,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,2,R,L,_0.instances[F.anim],!0))}else if(J>=y.ROOF_STRAIGHT.id){if(G?.addLoc(_,R,L,k,F.getModel(J,O,b,U,N,I,-1),null,T,Y,1,1,0),F.blockwalk)H?.addLoc(R,L,F.width,F.length,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,2,R,L,_0.instances[F.anim],!0))}else if(J===y.WALL_STRAIGHT.id){if(G?.addWall(_,R,L,k,H0.ROTATION_WALL_TYPE[O],0,F.getModel(y.WALL_STRAIGHT.id,O,b,U,N,I,-1),null,T,Y),F.blockwalk)H?.addWall(R,L,J,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,0,R,L,_0.instances[F.anim],!0))}else if(J===y.WALL_DIAGONAL_CORNER.id){if(G?.addWall(_,R,L,k,H0.ROTATION_WALL_CORNER_TYPE[O],0,F.getModel(y.WALL_DIAGONAL_CORNER.id,O,b,U,N,I,-1),null,T,Y),F.blockwalk)H?.addWall(R,L,J,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,0,R,L,_0.instances[F.anim],!0))}else if(J===y.WALL_L.id){let u=O+1&3;if(G?.addWall(_,R,L,k,H0.ROTATION_WALL_TYPE[O],H0.ROTATION_WALL_TYPE[u],F.getModel(y.WALL_L.id,O+4,b,U,N,I,-1),F.getModel(y.WALL_L.id,u,b,U,N,I,-1),T,Y),F.blockwalk)H?.addWall(R,L,J,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,0,R,L,_0.instances[F.anim],!0))}else if(J===y.WALL_SQUARE_CORNER.id){if(G?.addWall(_,R,L,k,H0.ROTATION_WALL_CORNER_TYPE[O],0,F.getModel(y.WALL_SQUARE_CORNER.id,O,b,U,N,I,-1),null,T,Y),F.blockwalk)H?.addWall(R,L,J,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,0,R,L,_0.instances[F.anim],!0))}else if(J===y.WALL_DIAGONAL.id){if(G?.addLoc(_,R,L,k,F.getModel(J,O,b,U,N,I,-1),null,T,Y,1,1,0),F.blockwalk)H?.addLoc(R,L,F.width,F.length,O,F.blockrange);if(F.anim!==-1)Q.addTail(new X0($,_,2,R,L,_0.instances[F.anim],!0))}else if(J===y.WALLDECOR_STRAIGHT_NOOFFSET.id){if(G?.setWallDecoration(_,R,L,k,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,b,U,N,I,-1),Y,O*512,H0.ROTATION_WALL_TYPE[O]),F.anim!==-1)Q.addTail(new X0($,_,1,R,L,_0.instances[F.anim],!0))}else if(J===y.WALLDECOR_STRAIGHT_OFFSET.id){let u=16;if(G){let w=G.getWallBitset(_,R,L);if(w>0)u=B0.get(w>>14&32767).wallwidth}if(G?.setWallDecoration(_,R,L,k,H0.WALL_DECORATION_ROTATION_FORWARD_X[O]*u,H0.WALL_DECORATION_ROTATION_FORWARD_Z[O]*u,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,b,U,N,I,-1),Y,O*512,H0.ROTATION_WALL_TYPE[O]),F.anim!==-1)Q.addTail(new X0($,_,1,R,L,_0.instances[F.anim],!0))}else if(J===y.WALLDECOR_DIAGONAL_OFFSET.id){if(G?.setWallDecoration(_,R,L,k,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,b,U,N,I,-1),Y,O,256),F.anim!==-1)Q.addTail(new X0($,_,1,R,L,_0.instances[F.anim],!0))}else if(J===y.WALLDECOR_DIAGONAL_NOOFFSET.id){if(G?.setWallDecoration(_,R,L,k,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,b,U,N,I,-1),Y,O,512),F.anim!==-1)Q.addTail(new X0($,_,1,R,L,_0.instances[F.anim],!0))}else if(J===y.WALLDECOR_DIAGONAL_BOTH.id){if(G?.setWallDecoration(_,R,L,k,0,0,T,F.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,b,U,N,I,-1),Y,O,768),F.anim!==-1)Q.addTail(new X0($,_,1,R,L,_0.instances[F.anim],!0))}};maxTileX;maxTileZ;levelHeightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;levelShademap;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;levelOccludemap;constructor(_,R,L,G){this.maxTileX=_,this.maxTileZ=R,this.levelHeightmap=L,this.levelTileFlags=G,this.levelTileUnderlayIds=new I1(s.LEVELS,_,R),this.levelTileOverlayIds=new I1(s.LEVELS,_,R),this.levelTileOverlayShape=new I1(s.LEVELS,_,R),this.levelTileOverlayRotation=new I1(s.LEVELS,_,R),this.levelOccludemap=new W1(s.LEVELS,_+1,R+1),this.levelShademap=new I1(s.LEVELS,_+1,R+1),this.levelLightmap=new J1(_+1,R+1),this.blendChroma=new Int32Array(R),this.blendSaturation=new Int32Array(R),this.blendLightness=new Int32Array(R),this.blendLuminance=new Int32Array(R),this.blendMagnitude=new Int32Array(R)}build=(_,R)=>{for(let L=0;L<s.LEVELS;L++)for(let G=0;G<s.SIZE;G++)for(let K=0;K<s.SIZE;K++)if((this.levelTileFlags[L][G][K]&1)===1){let Q=L;if((this.levelTileFlags[1][G][K]&2)===2)Q--;if(Q>=0)R[Q]?.addFloor(G,K)}if(H0.randomHueOffset+=(Math.random()*5|0)-2,H0.randomHueOffset<-8)H0.randomHueOffset=-8;else if(H0.randomHueOffset>8)H0.randomHueOffset=8;if(H0.randomLightnessOffset+=(Math.random()*5|0)-2,H0.randomLightnessOffset<-16)H0.randomLightnessOffset=-16;else if(H0.randomLightnessOffset>16)H0.randomLightnessOffset=16;for(let L=0;L<s.LEVELS;L++){let G=this.levelShademap[L],K=96,Q=768,H=-50,$=-10,J=-50,q=768*(Math.sqrt(5100)|0)>>8;for(let b=1;b<this.maxTileZ-1;b++)for(let U=1;U<this.maxTileX-1;U++){let N=this.levelHeightmap[L][U+1][b]-this.levelHeightmap[L][U-1][b],I=this.levelHeightmap[L][U][b+1]-this.levelHeightmap[L][U][b-1],k=Math.sqrt(N*N+I*I+65536)|0,F=(N<<8)/k|0,T=65536/k|0,Y=(I<<8)/k|0,u=96+((-50*F+-10*T+-50*Y)/q|0),w=(G[U-1][b]>>2)+(G[U+1][b]>>3)+(G[U][b-1]>>2)+(G[U][b+1]>>3)+(G[U][b]>>1);this.levelLightmap[U][b]=u-w}for(let b=0;b<this.maxTileZ;b++)this.blendChroma[b]=0,this.blendSaturation[b]=0,this.blendLightness[b]=0,this.blendLuminance[b]=0,this.blendMagnitude[b]=0;for(let b=-5;b<this.maxTileX+5;b++){for(let U=0;U<this.maxTileZ;U++){let N=b+5,I;if(N>=0&&N<this.maxTileX){let F=this.levelTileUnderlayIds[L][N][U]&255;if(F>0){let T=A0.instances[F-1];this.blendChroma[U]+=T.chroma,this.blendSaturation[U]+=T.saturation,this.blendLightness[U]+=T.lightness,this.blendLuminance[U]+=T.luminance,I=this.blendMagnitude[U]++}}let k=b-5;if(k>=0&&k<this.maxTileX){let F=this.levelTileUnderlayIds[L][k][U]&255;if(F>0){let T=A0.instances[F-1];this.blendChroma[U]-=T.chroma,this.blendSaturation[U]-=T.saturation,this.blendLightness[U]-=T.lightness,this.blendLuminance[U]-=T.luminance,I=this.blendMagnitude[U]--}}}if(b>=1&&b<this.maxTileX-1){let U=0,N=0,I=0,k=0,F=0;for(let T=-5;T<this.maxTileZ+5;T++){let Y=T+5;if(Y>=0&&Y<this.maxTileZ)U+=this.blendChroma[Y],N+=this.blendSaturation[Y],I+=this.blendLightness[Y],k+=this.blendLuminance[Y],F+=this.blendMagnitude[Y];let u=T-5;if(u>=0&&u<this.maxTileZ)U-=this.blendChroma[u],N-=this.blendSaturation[u],I-=this.blendLightness[u],k-=this.blendLuminance[u],F-=this.blendMagnitude[u];if(T>=1&&T<this.maxTileZ-1&&(!H0.lowMemory||(this.levelTileFlags[L][b][T]&16)===0&&this.getDrawLevel(L,b,T)===H0.levelBuilt)){let w=this.levelTileUnderlayIds[L][b][T]&255,B=this.levelTileOverlayIds[L][b][T]&255;if(w>0||B>0){let v=this.levelHeightmap[L][b][T],n=this.levelHeightmap[L][b+1][T],W=this.levelHeightmap[L][b+1][T+1],P=this.levelHeightmap[L][b][T+1],z=this.levelLightmap[b][T],f=this.levelLightmap[b+1][T],m=this.levelLightmap[b+1][T+1],M=this.levelLightmap[b][T+1],r=-1,a=-1;if(w>0){let L0=U*256/k|0,e=N/F|0,G0=I/F|0;r=A0.hsl24to16(L0,e,G0);let J0=L0+H0.randomHueOffset&255;if(G0+=H0.randomLightnessOffset,G0<0)G0=0;else if(G0>255)G0=255;a=A0.hsl24to16(J0,e,G0)}if(L>0){let L0=w!==0||this.levelTileOverlayShape[L][b][T]===T1.PLAIN;if(B>0&&!A0.instances[B-1].occlude)L0=!1;if(L0&&v===n&&v===W&&v===P)this.levelOccludemap[L][b][T]|=2340}let C=0;if(r!==-1)C=h.palette[A0.mulHSL(a,96)];if(B===0)_?.setTile(L,b,T,T1.PLAIN,x.WEST,-1,v,n,W,P,A0.mulHSL(r,z),A0.mulHSL(r,f),A0.mulHSL(r,m),A0.mulHSL(r,M),X.BLACK,X.BLACK,X.BLACK,X.BLACK,C,X.BLACK);else{let L0=this.levelTileOverlayShape[L][b][T]+1,e=this.levelTileOverlayRotation[L][b][T],G0=A0.instances[B-1],J0=G0.texture,Q0,i;if(J0>=0)i=h.getAverageTextureRGB(J0),Q0=-1;else if(G0.rgb===X.MAGENTA)i=0,Q0=-2,J0=-1;else Q0=A0.hsl24to16(G0.hue,G0.saturation,G0.lightness),i=h.palette[A0.adjustLightness(G0.hsl,96)];_?.setTile(L,b,T,L0,e,J0,v,n,W,P,A0.mulHSL(r,z),A0.mulHSL(r,f),A0.mulHSL(r,m),A0.mulHSL(r,M),A0.adjustLightness(Q0,z),A0.adjustLightness(Q0,f),A0.adjustLightness(Q0,m),A0.adjustLightness(Q0,M),C,i)}}}}}}for(let b=1;b<this.maxTileZ-1;b++)for(let U=1;U<this.maxTileX-1;U++)_?.setDrawLevel(L,U,b,this.getDrawLevel(L,U,b))}if(!H0.fullbright)_?.buildModels(64,768,-50,-10,-50);for(let L=0;L<this.maxTileX;L++)for(let G=0;G<this.maxTileZ;G++)if((this.levelTileFlags[1][L][G]&2)===2)_?.setBridge(L,G);if(!H0.fullbright){let L=1,G=2,K=4;for(let Q=0;Q<s.LEVELS;Q++){if(Q>0)L<<=3,G<<=3,K<<=3;for(let H=0;H<=Q;H++)for(let $=0;$<=this.maxTileZ;$++)for(let J=0;J<=this.maxTileX;J++){if((this.levelOccludemap[H][J][$]&L)!==0){let O=$,q=$,b=H,U=H;while(O>0&&(this.levelOccludemap[H][J][O-1]&L)!==0)O--;while(q<this.maxTileZ&&(this.levelOccludemap[H][J][q+1]&L)!==0)q++;_:while(b>0){for(let I=O;I<=q;I++)if((this.levelOccludemap[b-1][J][I]&L)===0)break _;b--}_:while(U<Q){for(let I=O;I<=q;I++)if((this.levelOccludemap[U+1][J][I]&L)===0)break _;U++}if((U+1-b)*(q+1-O)>=8){let I=this.levelHeightmap[U][J][O]-240,k=this.levelHeightmap[b][J][O];V.addOccluder(Q,1,J*128,I,O*128,J*128,k,q*128+128);for(let F=b;F<=U;F++)for(let T=O;T<=q;T++)this.levelOccludemap[F][J][T]&=~L}}if((this.levelOccludemap[H][J][$]&G)!==0){let O=J,q=J,b=H,U=H;while(O>0&&(this.levelOccludemap[H][O-1][$]&G)!==0)O--;while(q<this.maxTileX&&(this.levelOccludemap[H][q+1][$]&G)!==0)q++;_:while(b>0){for(let I=O;I<=q;I++)if((this.levelOccludemap[b-1][I][$]&G)===0)break _;b--}_:while(U<Q){for(let I=O;I<=q;I++)if((this.levelOccludemap[U+1][I][$]&G)===0)break _;U++}if((U+1-b)*(q+1-O)>=8){let I=this.levelHeightmap[U][O][$]-240,k=this.levelHeightmap[b][O][$];V.addOccluder(Q,2,O*128,I,$*128,q*128+128,k,$*128);for(let F=b;F<=U;F++)for(let T=O;T<=q;T++)this.levelOccludemap[F][T][$]&=~G}}if((this.levelOccludemap[H][J][$]&K)!==0){let O=J,q=J,b=$,U=$;while(b>0&&(this.levelOccludemap[H][J][b-1]&K)!==0)b--;while(U<this.maxTileZ&&(this.levelOccludemap[H][J][U+1]&K)!==0)U++;_:while(O>0){for(let N=b;N<=U;N++)if((this.levelOccludemap[H][O-1][N]&K)===0)break _;O--}_:while(q<this.maxTileX){for(let N=b;N<=U;N++)if((this.levelOccludemap[H][q+1][N]&K)===0)break _;q++}if((q+1-O)*(U+1-b)>=4){let N=this.levelHeightmap[H][O][b];V.addOccluder(Q,4,O*128,N,b*128,q*128+128,N,U*128+128);for(let I=O;I<=q;I++)for(let k=b;k<=U;k++)this.levelOccludemap[H][I][k]&=~K}}}}}};clearLandscape=(_,R,L,G)=>{let K=0;for(let Q=0;Q<A0.count;Q++)if(A0.instances[Q].debugname?.toLowerCase()==="water"){K=Q+1<<24>>24;break}for(let Q=_;Q<_+L;Q++)for(let H=R;H<R+G;H++)if(H>=0&&H<this.maxTileX&&Q>=0&&Q<this.maxTileZ){this.levelTileOverlayIds[0][H][Q]=K;for(let $=0;$<s.LEVELS;$++)this.levelHeightmap[$][H][Q]=0,this.levelTileFlags[$][H][Q]=0}};readLandscape=(_,R,L,G,K)=>{let Q=new p(K);for(let H=0;H<s.LEVELS;H++)for(let $=0;$<64;$++)for(let J=0;J<64;J++){let O=$+L,q=J+G,b;if(O>=0&&O<s.SIZE&&q>=0&&q<s.SIZE){this.levelTileFlags[H][O][q]=0;while(!0){if(b=Q.g1,b===0){if(H===0)this.levelHeightmap[0][O][q]=-H0.perlin(O+_+932731,q+556238+R)*8;else this.levelHeightmap[H][O][q]=this.levelHeightmap[H-1][O][q]-240;break}if(b===1){let U=Q.g1;if(U===1)U=0;if(H===0)this.levelHeightmap[0][O][q]=-U*8;else this.levelHeightmap[H][O][q]=this.levelHeightmap[H-1][O][q]-U*8;break}if(b<=49)this.levelTileOverlayIds[H][O][q]=Q.g1b,this.levelTileOverlayShape[H][O][q]=((b-2)/4|0)<<24>>24,this.levelTileOverlayRotation[H][O][q]=(b-2&3)<<24>>24;else if(b<=81)this.levelTileFlags[H][O][q]=b-49<<24>>24;else this.levelTileUnderlayIds[H][O][q]=b-81<<24>>24}}else while(!0){if(b=Q.g1,b===0)break;if(b===1){Q.g1;break}if(b<=49)Q.g1}}};readLocs=(_,R,L,G,K,Q)=>{let H=new p(G),$=-1;while(!0){let J=H.gsmarts;if(J===0)return;$+=J;let O=0;while(!0){let q=H.gsmarts;if(q===0)break;O+=q-1;let b=O&63,U=O>>6&63,N=O>>12,I=H.g1,k=I>>2,F=I&3,T=U+K,Y=b+Q;if(T>0&&Y>0&&T<s.SIZE-1&&Y<s.SIZE-1){let u=N;if((this.levelTileFlags[1][T][Y]&2)===2)u=N-1;let w=null;if(u>=0)w=L[u];this.addLoc(N,T,Y,_,R,w,$,k,F)}}}};addLoc=(_,R,L,G,K,Q,H,$,J)=>{if(H0.lowMemory){if((this.levelTileFlags[_][R][L]&16)!==0)return;if(this.getDrawLevel(_,R,L)!==H0.levelBuilt)return}let O=this.levelHeightmap[_][R][L],q=this.levelHeightmap[_][R+1][L],b=this.levelHeightmap[_][R+1][L+1],U=this.levelHeightmap[_][R][L+1],N=O+q+b+U>>2,I=B0.get(H),k=R+(L<<7)+(H<<14)+1073741824|0;if(!I.active)k+=-2147483648;k|=0;let F=((J<<6)+$|0)<<24>>24;if($===y.GROUND_DECOR.id){if(!H0.lowMemory||I.active||I.forcedecor){if(G?.addGroundDecoration(I.getModel(y.GROUND_DECOR.id,J,O,q,b,U,-1),_,R,L,N,k,F),I.blockwalk&&I.active)Q?.addFloor(R,L);if(I.anim!==-1)K.addTail(new X0(H,_,3,R,L,_0.instances[I.anim],!0))}}else if($===y.CENTREPIECE_STRAIGHT.id||$===y.CENTREPIECE_DIAGONAL.id){let T=I.getModel(y.CENTREPIECE_STRAIGHT.id,J,O,q,b,U,-1);if(T){let Y=0;if($===y.CENTREPIECE_DIAGONAL.id)Y+=256;let u,w;if(J===x.NORTH||J===x.SOUTH)u=I.length,w=I.width;else u=I.width,w=I.length;if(G?.addLoc(_,R,L,N,T,null,k,F,u,w,Y)&&I.shadow)for(let B=0;B<=u;B++)for(let v=0;v<=w;v++){let n=T.radius/4|0;if(n>30)n=30;if(n>this.levelShademap[_][R+B][L+v])this.levelShademap[_][R+B][L+v]=n<<24>>24}}if(I.blockwalk)Q?.addLoc(R,L,I.width,I.length,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,2,R,L,_0.instances[I.anim],!0))}else if($>=y.ROOF_STRAIGHT.id){if(G?.addLoc(_,R,L,N,I.getModel($,J,O,q,b,U,-1),null,k,F,1,1,0),$>=y.ROOF_STRAIGHT.id&&$<=y.ROOF_FLAT.id&&$!==y.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&_>0)this.levelOccludemap[_][R][L]|=2340;if(I.blockwalk)Q?.addLoc(R,L,I.width,I.length,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,2,R,L,_0.instances[I.anim],!0))}else if($===y.WALL_STRAIGHT.id){if(G?.addWall(_,R,L,N,H0.ROTATION_WALL_TYPE[J],0,I.getModel(y.WALL_STRAIGHT.id,J,O,q,b,U,-1),null,k,F),J===x.WEST){if(I.shadow)this.levelShademap[_][R][L]=50,this.levelShademap[_][R][L+1]=50;if(I.occlude)this.levelOccludemap[_][R][L]|=585}else if(J===x.NORTH){if(I.shadow)this.levelShademap[_][R][L+1]=50,this.levelShademap[_][R+1][L+1]=50;if(I.occlude)this.levelOccludemap[_][R][L+1]|=1170}else if(J===x.EAST){if(I.shadow)this.levelShademap[_][R+1][L]=50,this.levelShademap[_][R+1][L+1]=50;if(I.occlude)this.levelOccludemap[_][R+1][L]|=585}else if(J===x.SOUTH){if(I.shadow)this.levelShademap[_][R][L]=50,this.levelShademap[_][R+1][L]=50;if(I.occlude)this.levelOccludemap[_][R][L]|=1170}if(I.blockwalk)Q?.addWall(R,L,$,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,0,R,L,_0.instances[I.anim],!0));if(I.wallwidth!==16)G?.setWallDecorationOffset(_,R,L,I.wallwidth)}else if($===y.WALL_DIAGONAL_CORNER.id){if(G?.addWall(_,R,L,N,H0.ROTATION_WALL_CORNER_TYPE[J],0,I.getModel(y.WALL_DIAGONAL_CORNER.id,J,O,q,b,U,-1),null,k,F),I.shadow){if(J===x.WEST)this.levelShademap[_][R][L+1]=50;else if(J===x.NORTH)this.levelShademap[_][R+1][L+1]=50;else if(J===x.EAST)this.levelShademap[_][R+1][L]=50;else if(J===x.SOUTH)this.levelShademap[_][R][L]=50}if(I.blockwalk)Q?.addWall(R,L,$,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,0,R,L,_0.instances[I.anim],!0))}else if($===y.WALL_L.id){let T=J+1&3;if(G?.addWall(_,R,L,N,H0.ROTATION_WALL_TYPE[J],H0.ROTATION_WALL_TYPE[T],I.getModel(y.WALL_L.id,J+4,O,q,b,U,-1),I.getModel(y.WALL_L.id,T,O,q,b,U,-1),k,F),I.occlude){if(J===x.WEST)this.levelOccludemap[_][R][L]|=265,this.levelOccludemap[_][R][L+1]|=1170;else if(J===x.NORTH)this.levelOccludemap[_][R][L+1]|=1170,this.levelOccludemap[_][R+1][L]|=585;else if(J===x.EAST)this.levelOccludemap[_][R+1][L]|=585,this.levelOccludemap[_][R][L]|=1170;else if(J===x.SOUTH)this.levelOccludemap[_][R][L]|=1170,this.levelOccludemap[_][R][L]|=585}if(I.blockwalk)Q?.addWall(R,L,$,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,0,R,L,_0.instances[I.anim],!0));if(I.wallwidth!==16)G?.setWallDecorationOffset(_,R,L,I.wallwidth)}else if($===y.WALL_SQUARE_CORNER.id){if(G?.addWall(_,R,L,N,H0.ROTATION_WALL_CORNER_TYPE[J],0,I.getModel(y.WALL_SQUARE_CORNER.id,J,O,q,b,U,-1),null,k,F),I.shadow){if(J===x.WEST)this.levelShademap[_][R][L+1]=50;else if(J===x.NORTH)this.levelShademap[_][R+1][L+1]=50;else if(J===x.EAST)this.levelShademap[_][R+1][L]=50;else if(J===x.SOUTH)this.levelShademap[_][R][L]=50}if(I.blockwalk)Q?.addWall(R,L,$,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,0,R,L,_0.instances[I.anim],!0))}else if($===y.WALL_DIAGONAL.id){if(G?.addLoc(_,R,L,N,I.getModel($,J,O,q,b,U,-1),null,k,F,1,1,0),I.blockwalk)Q?.addLoc(R,L,I.width,I.length,J,I.blockrange);if(I.anim!==-1)K.addTail(new X0(H,_,2,R,L,_0.instances[I.anim],!0))}else if($===y.WALLDECOR_STRAIGHT_NOOFFSET.id){if(G?.setWallDecoration(_,R,L,N,0,0,k,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,b,U,-1),F,J*512,H0.ROTATION_WALL_TYPE[J]),I.anim!==-1)K.addTail(new X0(H,_,1,R,L,_0.instances[I.anim],!0))}else if($===y.WALLDECOR_STRAIGHT_OFFSET.id){let T=16;if(G){let Y=G.getWallBitset(_,R,L);if(Y>0)T=B0.get(Y>>14&32767).wallwidth}if(G?.setWallDecoration(_,R,L,N,H0.WALL_DECORATION_ROTATION_FORWARD_X[J]*T,H0.WALL_DECORATION_ROTATION_FORWARD_Z[J]*T,k,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,b,U,-1),F,J*512,H0.ROTATION_WALL_TYPE[J]),I.anim!==-1)K.addTail(new X0(H,_,1,R,L,_0.instances[I.anim],!0))}else if($===y.WALLDECOR_DIAGONAL_OFFSET.id){if(G?.setWallDecoration(_,R,L,N,0,0,k,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,b,U,-1),F,J,256),I.anim!==-1)K.addTail(new X0(H,_,1,R,L,_0.instances[I.anim],!0))}else if($===y.WALLDECOR_DIAGONAL_NOOFFSET.id){if(G?.setWallDecoration(_,R,L,N,0,0,k,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,b,U,-1),F,J,512),I.anim!==-1)K.addTail(new X0(H,_,1,R,L,_0.instances[I.anim],!0))}else if($===y.WALLDECOR_DIAGONAL_BOTH.id){if(G?.setWallDecoration(_,R,L,N,0,0,k,I.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,x.WEST,O,q,b,U,-1),F,J,768),I.anim!==-1)K.addTail(new X0(H,_,1,R,L,_0.instances[I.anim],!0))}};getDrawLevel=(_,R,L)=>{if((this.levelTileFlags[_][R][L]&8)===0)return _<=0||(this.levelTileFlags[1][R][L]&2)===0?_:_-1;return 0}}class k1 extends D0{}class M1 extends k1{x=0;z=0;yaw=0;seqStretches=!1;size=1;seqStandId=-1;seqTurnId=-1;seqWalkId=-1;seqTurnAroundId=-1;seqTurnLeftId=-1;seqTurnRightId=-1;seqRunId=-1;chat=null;chatTimer=100;chatColor=0;chatStyle=0;damage=0;damageType=0;combatCycle=-1000;health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimOffset=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;pathLength=0;pathTileX=new Int32Array(10);pathTileZ=new Int32Array(10);pathRunning=new l(10,!1);seqTrigger=0;lastMask=-1;lastMaskCycle=-1;lastFaceX=-1;lastFaceZ=-1;move(_,R,L){if(this.primarySeqId!==-1&&_0.instances[this.primarySeqId].priority<=1)this.primarySeqId=-1;if(!_){let G=R-this.pathTileX[0],K=L-this.pathTileZ[0];if(G>=-8&&G<=8&&K>=-8&&K<=8){if(this.pathLength<9)this.pathLength++;for(let Q=this.pathLength;Q>0;Q--)this.pathTileX[Q]=this.pathTileX[Q-1],this.pathTileZ[Q]=this.pathTileZ[Q-1],this.pathRunning[Q]=this.pathRunning[Q-1];this.pathTileX[0]=R,this.pathTileZ[0]=L,this.pathRunning[0]=!1;return}}this.pathLength=0,this.seqTrigger=0,this.pathTileX[0]=R,this.pathTileZ[0]=L,this.x=this.pathTileX[0]*128+this.size*64,this.z=this.pathTileZ[0]*128+this.size*64}step(_,R){let L=this.pathTileX[0],G=this.pathTileZ[0];if(R===0)L--,G++;else if(R===1)G++;else if(R===2)L++,G++;else if(R===3)L--;else if(R===4)L++;else if(R===5)L--,G--;else if(R===6)G--;else if(R===7)L++,G--;if(this.primarySeqId!==-1&&_0.instances[this.primarySeqId].priority<=1)this.primarySeqId=-1;if(this.pathLength<9)this.pathLength++;for(let K=this.pathLength;K>0;K--)this.pathTileX[K]=this.pathTileX[K-1],this.pathTileZ[K]=this.pathTileZ[K-1],this.pathRunning[K]=this.pathRunning[K-1];this.pathTileX[0]=L,this.pathTileZ[0]=G,this.pathRunning[0]=_}}class f0 extends M1{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;type=null;draw(_){if(!this.type)return null;if(this.spotanimId===-1||this.spotanimFrame===-1)return this.getSequencedModel();let R=this.getSequencedModel();if(!R)return null;let L=p0.instances[this.spotanimId],G=E.modelShareColored(L.getModel(),!0,!L.disposeAlpha,!1);if(G.translate(-this.spotanimOffset,0,0),G.createLabelReferences(),L.seq&&L.seq.frames)G.applyTransform(L.seq.frames[this.spotanimFrame]);if(G.labelFaces=null,G.labelVertices=null,L.resizeh!==128||L.resizev!==128)G.scale(L.resizeh,L.resizev,L.resizeh);G.calculateNormals(64+L.ambient,850+L.contrast,-30,-50,-30,!0);let K=[R,G],Q=E.modelFromModelsBounds(K,2);if(this.type.size===1)Q.pickable=!0;return Q}isVisible(){return this.type!==null}getSequencedModel(){if(!this.type)return null;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let L=_0.instances[this.primarySeqId].frames;if(L){let G=L[this.primarySeqFrame],K=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){let Q=_0.instances[this.secondarySeqId].frames;if(Q)K=Q[this.secondarySeqFrame]}return this.type.getSequencedModel(G,K,_0.instances[this.primarySeqId].walkmerge)}}let _=-1;if(this.secondarySeqId>=0){let L=_0.instances[this.secondarySeqId].frames;if(L)_=L[this.secondarySeqFrame]}let R=this.type.getSequencedModel(_,-1,null);if(!R)return null;return this.height=R.maxY,R}}class U0 extends M1{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static TORSO_RECOLORS=[X.BODY_RECOLOR_KHAKI,X.BODY_RECOLOR_CHARCOAL,X.BODY_RECOLOR_CRIMSON,X.BODY_RECOLOR_NAVY,X.BODY_RECOLOR_STRAW,X.BODY_RECOLOR_WHITE,X.BODY_RECOLOR_RED,X.BODY_RECOLOR_BLUE,X.BODY_RECOLOR_GREEN,X.BODY_RECOLOR_YELLOW,X.BODY_RECOLOR_PURPLE,X.BODY_RECOLOR_ORANGE,X.BODY_RECOLOR_ROSE,X.BODY_RECOLOR_LIME,X.BODY_RECOLOR_CYAN,X.BODY_RECOLOR_EMERALD];static DESIGN_IDK_COLORS=[[X.HAIR_DARK_BROWN,X.HAIR_WHITE,X.HAIR_LIGHT_GREY,X.HAIR_DARK_GREY,X.HAIR_APRICOT,X.HAIR_STRAW,X.HAIR_LIGHT_BROWN,X.HAIR_BROWN,X.HAIR_TURQUOISE,X.HAIR_GREEN,X.HAIR_GINGER,X.HAIR_MAGENTA],[X.BODY_KHAKI,X.BODY_CHARCOAL,X.BODY_CRIMSON,X.BODY_NAVY,X.BODY_STRAW,X.BODY_WHITE,X.BODY_RED,X.BODY_BLUE,X.BODY_GREEN,X.BODY_YELLOW,X.BODY_PURPLE,X.BODY_ORANGE,X.BODY_ROSE,X.BODY_LIME,X.BODY_CYAN,X.BODY_EMERALD],[X.BODY_EMERALD-1,X.BODY_KHAKI+1,X.BODY_CHARCOAL,X.BODY_CRIMSON,X.BODY_NAVY,X.BODY_STRAW,X.BODY_WHITE,X.BODY_RED,X.BODY_BLUE,X.BODY_GREEN,X.BODY_YELLOW,X.BODY_PURPLE,X.BODY_ORANGE,X.BODY_ROSE,X.BODY_LIME,X.BODY_CYAN],[X.FEET_BROWN,X.FEET_KHAKI,X.FEET_ASHEN,X.FEET_DARK,X.FEET_TERRACOTTA,X.FEET_GREY],[X.SKIN_DARKER,X.SKIN_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER,X.SKIN_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER_DARKER,X.SKIN]];static modelCache=new s0(200);name=null;visible=!1;gender=0;headicons=0;appearances=new Uint16Array(12);colors=new Uint16Array(5);combatLevel=0;appearanceHashcode=0n;y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;lowMemory=!1;draw(_){if(!this.visible)return null;let R=this.getSequencedModel();if(this.height=R.maxY,R.pickable=!0,this.lowMemory)return R;if(this.spotanimId!==-1&&this.spotanimFrame!==-1){let L=p0.instances[this.spotanimId],G=E.modelShareColored(L.getModel(),!0,!L.disposeAlpha,!1);if(G.translate(-this.spotanimOffset,0,0),G.createLabelReferences(),L.seq&&L.seq.frames)G.applyTransform(L.seq.frames[this.spotanimFrame]);if(G.labelFaces=null,G.labelVertices=null,L.resizeh!==128||L.resizev!==128)G.scale(L.resizeh,L.resizev,L.resizeh);G.calculateNormals(L.ambient+64,L.contrast+850,-30,-50,-30,!0);let K=[R,G];R=E.modelFromModelsBounds(K,2)}if(this.locModel){if(_>=this.locStopCycle)this.locModel=null;if(_>=this.locStartCycle&&_<this.locStopCycle){let L=this.locModel;if(L){if(L.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),this.dstYaw===512)L.rotateY90(),L.rotateY90(),L.rotateY90();else if(this.dstYaw===1024)L.rotateY90(),L.rotateY90();else if(this.dstYaw===1536)L.rotateY90();let G=[R,L];if(R=E.modelFromModelsBounds(G,2),this.dstYaw===512)L.rotateY90();else if(this.dstYaw===1024)L.rotateY90(),L.rotateY90();else if(this.dstYaw===1536)L.rotateY90(),L.rotateY90(),L.rotateY90();L.translate(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}}return R.pickable=!0,R}isVisible(){return this.visible}read(_){_.pos=0,this.gender=_.g1,this.headicons=_.g1;for(let R=0;R<12;R++){let L=_.g1;if(L===0)this.appearances[R]=0;else this.appearances[R]=(L<<8)+_.g1}for(let R=0;R<5;R++){let L=_.g1;if(L<0||L>=U0.DESIGN_IDK_COLORS[R].length)L=0;this.colors[R]=L}if(this.seqStandId=_.g2,this.seqStandId===65535)this.seqStandId=-1;if(this.seqTurnId=_.g2,this.seqTurnId===65535)this.seqTurnId=-1;if(this.seqWalkId=_.g2,this.seqWalkId===65535)this.seqWalkId=-1;if(this.seqTurnAroundId=_.g2,this.seqTurnAroundId===65535)this.seqTurnAroundId=-1;if(this.seqTurnLeftId=_.g2,this.seqTurnLeftId===65535)this.seqTurnLeftId=-1;if(this.seqTurnRightId=_.g2,this.seqTurnRightId===65535)this.seqTurnRightId=-1;if(this.seqRunId=_.g2,this.seqRunId===65535)this.seqRunId=-1;this.name=I0.formatName(I0.fromBase37(_.g8)),this.combatLevel=_.g1,this.visible=!0,this.appearanceHashcode=0n;for(let R=0;R<12;R++)if(this.appearanceHashcode<<=0x4n,this.appearances[R]>=256)this.appearanceHashcode+=BigInt(this.appearances[R])-256n;if(this.appearances[0]>=256)this.appearanceHashcode+=BigInt(this.appearances[0])-256n>>4n;if(this.appearances[1]>=256)this.appearanceHashcode+=BigInt(this.appearances[1])-256n>>8n;for(let R=0;R<5;R++)this.appearanceHashcode<<=0x3n,this.appearanceHashcode+=BigInt(this.colors[R]);this.appearanceHashcode<<=0x1n,this.appearanceHashcode+=BigInt(this.gender)}getHeadModel(){if(!this.visible)return null;let _=new l(12,null),R=0;for(let G=0;G<12;G++){let K=this.appearances[G];if(K>=256&&K<512)_[R++]=i0.instances[K-256].getHeadModel();if(K>=512){let Q=Y0.get(K-512).getHeadModel(this.gender);if(Q)_[R++]=Q}}let L=E.modelFromModels(_,R);for(let G=0;G<5;G++){if(this.colors[G]===0)continue;if(L.recolor(U0.DESIGN_IDK_COLORS[G][0],U0.DESIGN_IDK_COLORS[G][this.colors[G]]),G===1)L.recolor(U0.TORSO_RECOLORS[0],U0.TORSO_RECOLORS[this.colors[G]])}return L}getSequencedModel(){let _=this.appearanceHashcode,R=-1,L=-1,G=-1,K=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let $=_0.instances[this.primarySeqId];if($.frames)R=$.frames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){let J=_0.instances[this.secondarySeqId].frames;if(J)L=J[this.secondarySeqFrame]}if($.righthand>=0)G=$.righthand,_+=BigInt(G-this.appearances[5])<<8n;if($.lefthand>=0)K=$.lefthand,_+=BigInt(K-this.appearances[3])<<16n}else if(this.secondarySeqId>=0){let $=_0.instances[this.secondarySeqId].frames;if($)R=$[this.secondarySeqFrame]}let Q=U0.modelCache?.get(_);if(!Q){let $=new l(12,null),J=0;for(let O=0;O<12;O++){let q=this.appearances[O];if(K>=0&&O===3)q=K;if(G>=0&&O===5)q=G;if(q>=256&&q<512){let b=i0.instances[q-256].getModel();if(b)$[J++]=b}if(q>=512){let U=Y0.get(q-512).getWornModel(this.gender);if(U)$[J++]=U}}Q=E.modelFromModels($,J);for(let O=0;O<5;O++){if(this.colors[O]===0)continue;if(Q.recolor(U0.DESIGN_IDK_COLORS[O][0],U0.DESIGN_IDK_COLORS[O][this.colors[O]]),O===1)Q.recolor(U0.TORSO_RECOLORS[0],U0.TORSO_RECOLORS[this.colors[O]])}Q.createLabelReferences(),Q.calculateNormals(64,850,-30,-50,-30,!0),U0.modelCache?.put(_,Q)}if(this.lowMemory)return Q;let H=E.modelShareAlpha(Q,!0);if(R!==-1&&L!==-1)H.applyTransforms(R,L,_0.instances[this.primarySeqId].walkmerge);else if(R!==-1)H.applyTransform(R);return H.calculateBoundsCylinder(),H.labelFaces=null,H.labelVertices=null,H}}class R8 extends D0{plane;layer;x;z;locIndex;angle;shape;lastCycle;constructor(_,R,L,G,K,Q,H,$){super();this.plane=_,this.layer=R,this.x=L,this.z=G,this.locIndex=K,this.angle=Q,this.shape=H,this.lastCycle=$}}class S8 extends D0{plane;layer;x;z;locIndex;angle;shape;lastLocIndex;lastAngle;lastShape;constructor(_,R,L,G,K,Q,H,$,J,O){super();this.plane=_,this.layer=R,this.x=L,this.z=G,this.locIndex=K,this.angle=Q,this.shape=H,this.lastLocIndex=$,this.lastAngle=J,this.lastShape=O}}class L8 extends D0{index;count;constructor(_,R){super();this.index=_,this.count=R}}class P8 extends k1{spotanim;level;srcX;srcZ;srcY;offsetY;startCycle;lastCycle;peakPitch;arc;target;mobile=!1;x=0;z=0;y=0;velocityX=0;velocityZ=0;velocity=0;velocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(_,R,L,G,K,Q,H,$,J,O,q){super();this.spotanim=p0.instances[_],this.level=R,this.srcX=L,this.srcZ=K,this.srcY=G,this.startCycle=Q,this.lastCycle=H,this.peakPitch=$,this.arc=J,this.target=O,this.offsetY=q}updateVelocity(_,R,L,G){if(!this.mobile){let Q=_-this.srcX,H=L-this.srcZ,$=Math.sqrt(Q*Q+H*H);this.x=this.srcX+Q*this.arc/$,this.z=this.srcZ+H*this.arc/$,this.y=this.srcY}let K=this.lastCycle+1-G;if(this.velocityX=(_-this.x)/K,this.velocityZ=(L-this.z)/K,this.velocity=Math.sqrt(this.velocityX*this.velocityX+this.velocityZ*this.velocityZ),!this.mobile)this.velocityY=-this.velocity*Math.tan(this.peakPitch*0.02454369);this.accelerationY=(R-this.y-this.velocityY*K)*2/(K*K)}update(_){if(this.mobile=!0,this.x+=this.velocityX*_,this.z+=this.velocityZ*_,this.y+=this.velocityY*_+this.accelerationY*0.5*_*_,this.velocityY+=this.accelerationY*_,this.yaw=(Math.atan2(this.velocityX,this.velocityZ)*325.949+1024|0)&2047,this.pitch=(Math.atan2(this.velocityY,this.velocity)*325.949|0)&2047,!this.spotanim.seq||!this.spotanim.seq.delay)return;this.seqCycle+=_;while(this.seqCycle>this.spotanim.seq.delay[this.seqFrame])if(this.seqCycle-=this.spotanim.seq.delay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.frameCount)this.seqFrame=0}draw(){let _=this.spotanim.getModel(),R=E.modelShareColored(_,!0,!this.spotanim.disposeAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.frames)R.createLabelReferences(),R.applyTransform(this.spotanim.seq.frames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128)R.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return R.rotateX(this.pitch),R.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),R}}class z8 extends k1{type;level;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(_,R,L,G,K,Q,H){super();this.type=p0.instances[_],this.level=R,this.x=L,this.z=G,this.y=K,this.startCycle=Q+H}update(_){if(!this.type.seq||!this.type.seq.delay)return;for(this.seqCycle+=_;this.seqCycle>this.type.seq.delay[this.seqFrame];)if(this.seqCycle-=this.type.seq.delay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.type.seq.frameCount)this.seqFrame=0,this.seqComplete=!0}draw(){let _=this.type.getModel(),R=E.modelShareColored(_,!0,!this.type.disposeAlpha,!1);if(!this.seqComplete&&this.type.seq&&this.type.seq.frames)R.createLabelReferences(),R.applyTransform(this.type.seq.frames[this.seqFrame]),R.labelFaces=null,R.labelVertices=null;if(this.type.resizeh!==128||this.type.resizev!==128)R.scale(this.type.resizeh,this.type.resizev,this.type.resizeh);if(this.type.orientation!==0){if(this.type.orientation===90)R.rotateY90();else if(this.type.orientation===180)R.rotateY90(),R.rotateY90();else if(this.type.orientation===270)R.rotateY90(),R.rotateY90(),R.rotateY90()}return R.calculateNormals(64+this.type.ambient,850+this.type.contrast,-30,-50,-30,!0),R}}class E6{constructor(_={}){if(this.wasmModule=void 0,this.soundfontBufferPtr=0,this.soundfontPtr=0,this.midiBufferPtr=0,this.renderInterval=_.renderInterval||100,this.sampleRate=_.sampleRate||44100,this.channels=_.channels||2,this.gain=_.gain||0,!_.bufferSize)this.setBufferDuration(1);else this.bufferSize=_.bufferSize;this.onPCMData=_.onPCMData||(()=>{}),this.onRenderEnd=_.onRenderEnd||(()=>{}),this.renderTimer=void 0,this.test=0}async init(){if(this.wasmModule)return;this.wasmModule=await q6(),this.pcmBufferPtr=this.wasmModule._malloc(this.bufferSize),this.msecsPtr=this.wasmModule._malloc(8)}setBufferDuration(_){this.bufferSize=4*this.sampleRate*this.channels*_}ensureInitialized(){if(!this.wasmModule)throw new Error(`${this.constructor.name} not initalized. call .init()`)}setSoundfont(_){this.ensureInitialized();let{_malloc:R,_free:L,_tsf_load_memory:G,_tsf_set_output:K}=this.wasmModule;L(this.soundfontBufferPtr),this.soundfontBufferPtr=R(_.length),this.wasmModule.HEAPU8.set(_,this.soundfontBufferPtr),this.soundfontPtr=G(this.soundfontBufferPtr,_.length),K(this.soundfontPtr,this.channels===2?0:2,this.sampleRate,this.gain)}getPCMBuffer(){this.ensureInitialized();let _=new Uint8Array(this.bufferSize);return _.set(this.wasmModule.HEAPU8.subarray(this.pcmBufferPtr,this.pcmBufferPtr+this.bufferSize)),_}getMIDIMessagePtr(_){let{_malloc:R,_free:L,_tml_load_memory:G}=this.wasmModule;return L(this.midiBufferPtr),this.midiBufferPtr=R(_.length),this.wasmModule.HEAPU8.set(_,this.midiBufferPtr),G(this.midiBufferPtr,_.length)}renderMIDIMessage(_){let{_midi_render:R}=this.wasmModule;return R(this.soundfontPtr,_,this.channels,this.sampleRate,this.pcmBufferPtr,this.bufferSize,this.msecsPtr)}render(_){if(this.ensureInitialized(),!this.soundfontPtr)throw new Error("no soundfont buffer set. call .setSoundfont");window.clearTimeout(this.renderTimer);let{setValue:R,getValue:L,_tsf_reset:G,_tsf_channel_set_bank_preset:K}=this.wasmModule;R(this.msecsPtr,0,"double"),G(this.soundfontPtr),K(this.soundfontPtr,9,128,0);let Q=this.getMIDIMessagePtr(_),H=function(){Q=this.renderMIDIMessage(Q);let $=this.getPCMBuffer();if(this.onPCMData($),Q)this.renderTimer=setTimeout(H,this.renderInterval);else this.onRenderEnd(L(this.msecsPtr,"double"))}.bind(this);this.renderTimer=setTimeout(()=>{H()},16)}}var F6=E6;(function(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext)window.audioContext=new window.AudioContext;var _=function(R){if(window.audioContext){var L=window.audioContext.createBuffer(1,1,22050),G=window.audioContext.createBufferSource();if(G.buffer=L,G.connect(window.audioContext.destination),G.start)G.start(0);else if(G.play)G.play(0);else if(G.noteOn)G.noteOn(0)}document.removeEventListener("touchstart",_),document.removeEventListener("touchend",_),document.removeEventListener("click",_)};document.addEventListener("touchstart",_),document.addEventListener("touchend",_),document.addEventListener("click",_)})();(async()=>{let Q=new Float32Array,H=window.audioContext.createGain();H.gain.setValueAtTime(0.1,window.audioContext.currentTime),H.connect(window.audioContext.destination);let $=window.audioContext.currentTime,J=[],O=new F6({renderInterval:30,onPCMData:(T)=>{let Y=new Float32Array(T.buffer),u=new Float32Array(Q.length+Y.length);u.set(Q,0),u.set(Y,Q.length),Q=u},onRenderEnd:(T)=>{},bufferSize:102400});await O.init();let q=await fetch(new URL("SCC1_Florestan.sf2",import.meta.url)),b=new Uint8Array(await q.arrayBuffer());O.setSoundfont(b);function U(){if(!window.audioContext||!Q.length)return;let T=window.audioContext.createBufferSource(),Y=Q.length/2,u=window.audioContext.createBuffer(2,Y,44100);for(let w=0;w<2;w++){let B=u.getChannelData(w),v=w;for(let n=0;n<Y;n++)B[n]=Q[v],v+=2}if($<window.audioContext.currentTime)$=window.audioContext.currentTime;T.buffer=u,T.connect(H),T.start($),J.push(T),$+=u.duration,Q=new Float32Array}let N;function I(T){let Y=window.audioContext.currentTime;H.gain.cancelScheduledValues(Y),H.gain.setTargetAtTime(0,Y,0.5),setTimeout(T,2000)}function k(){if(N)clearInterval(N);if(Q=new Float32Array,J.length){let T=H.gain.value;H.gain.setValueAtTime(0,window.audioContext.currentTime),J.forEach((Y)=>{Y.stop(window.audioContext.currentTime)}),J=[],H.gain.setValueAtTime(T,window.audioContext.currentTime)}}function F(T,Y){if(T!==-1)window._tinyMidiVolume(T);$=window.audioContext.currentTime,N=setInterval(U,250),O.render(Y)}window._tinyMidiStop=async(T)=>{if(T)I(()=>{k()});else k()},window._tinyMidiVolume=(T=1)=>{H.gain.setValueAtTime(T,window.audioContext.currentTime)},window._tinyMidiPlay=async(T,Y,u)=>{if(!T)return;if(await window._tinyMidiStop(u),u)setTimeout(()=>{F(Y,T)},2000);else F(Y,T)}})();var G8;async function T6(_,R){v1(R);try{let L=await window.audioContext.decodeAudioData(Uint8Array.from(_).buffer),G=window.audioContext.createBufferSource();G.buffer=L,G.connect(G8),G.start()}catch(L){}}function v1(_){if(!G8)G8=window.audioContext.createGain(),G8.connect(window.audioContext.destination);G8.gain.value=_/256}function k6(_,R,L){if(window._tinyMidiPlay)window._tinyMidiPlay(_,R/256,L)}function K8(_){if(window._tinyMidiVolume)window._tinyMidiVolume(_/256)}function D8(_){if(window._tinyMidiStop)window._tinyMidiStop(_)}class M8{seed;constructor(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}setSeed(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(_){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-_}}class y0 extends x0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];static{let _=navigator.userAgent.includes("Capacitor");for(let R=0;R<256;R++){let L=y0.CHARSET.indexOf(String.fromCharCode(R));if(_){if(L>=63)L--}if(L===-1)L=74;y0.CHARCODESET[R]=L}}charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new M8(BigInt(Date.now()));height=0;static fromArchive=(_,R)=>{let L=new p(_.read(R+".dat")),G=new p(_.read("index.dat"));G.pos=L.g2+4;let K=G.g1;if(K>0)G.pos+=(K-1)*3;let Q=new y0;for(let H=0;H<94;H++){Q.charOffsetX[H]=G.g1,Q.charOffsetY[H]=G.g1;let $=Q.charMaskWidth[H]=G.g2,J=Q.charMaskHeight[H]=G.g2,O=G.g1,q=$*J;if(Q.charMask[H]=new Int8Array(q),O===0)for(let b=0;b<$*J;b++)Q.charMask[H][b]=L.g1b;else if(O===1)for(let b=0;b<$;b++)for(let U=0;U<J;U++)Q.charMask[H][b+U*$]=L.g1b;if(J>Q.height)Q.height=J;Q.charOffsetX[H]=1,Q.charAdvance[H]=$+2;{let b=0;for(let U=J/7|0;U<J;U++)b+=Q.charMask[H][U*$];if(b<=(J/7|0))Q.charAdvance[H]--,Q.charOffsetX[H]=0}{let b=0;for(let U=J/7|0;U<J;U++)b+=Q.charMask[H][$+U*$-1];if(b<=(J/7|0))Q.charAdvance[H]--}}Q.charAdvance[94]=Q.charAdvance[8];for(let H=0;H<256;H++)Q.drawWidth[H]=Q.charAdvance[y0.CHARCODESET[H]];return Q};drawString(_,R,L,G){if(!L)return;_|=0,R|=0;let K=L.length;R-=this.height;for(let Q=0;Q<K;Q++){let H=y0.CHARCODESET[L.charCodeAt(Q)];if(H!==94)this.drawChar(this.charMask[H],_+this.charOffsetX[H],R+this.charOffsetY[H],this.charMaskWidth[H],this.charMaskHeight[H],G);_+=this.charAdvance[H]}}drawStringTaggable(_,R,L,G,K){_|=0,R|=0;let Q=L.length;R-=this.height;for(let H=0;H<Q;H++)if(L.charAt(H)==="@"&&H+4<Q&&L.charAt(H+4)==="@")G=this.evaluateTag(L.substring(H+1,H+4)),H+=4;else{let $=y0.CHARCODESET[L.charCodeAt(H)];if($!==94){if(K)this.drawChar(this.charMask[$],_+this.charOffsetX[$]+1,R+this.charOffsetY[$]+1,this.charMaskWidth[$],this.charMaskHeight[$],X.BLACK);this.drawChar(this.charMask[$],_+this.charOffsetX[$],R+this.charOffsetY[$],this.charMaskWidth[$],this.charMaskHeight[$],G)}_+=this.charAdvance[$]}}stringWidth(_){if(!_)return 0;let R=_.length,L=0;for(let G=0;G<R;G++)if(_.charAt(G)==="@"&&G+4<R&&_.charAt(G+4)==="@")G+=4;else L+=this.drawWidth[_.charCodeAt(G)];return L}drawStringTaggableCenter(_,R,L,G,K){_|=0,R|=0,this.drawStringTaggable(_-this.stringWidth(L)/2,R,L,G,K)}drawStringCenter(_,R,L,G){if(!L)return;_|=0,R|=0,this.drawString(_-this.stringWidth(L)/2,R,L,G)}drawStringTooltip(_,R,L,G,K,Q){_|=0,R|=0,this.random.setSeed(BigInt(Q));let H=(this.random.nextInt()&31)+192,$=R-this.height;for(let J=0;J<L.length;J++)if(L.charAt(J)==="@"&&J+4<L.length&&L.charAt(J+4)==="@")G=this.evaluateTag(L.substring(J+1,J+4)),J+=4;else{let O=y0.CHARCODESET[L.charCodeAt(J)];if(O!==94){if(K)this.drawCharAlpha(_+this.charOffsetX[O]+1,$+this.charOffsetY[O]+1,this.charMaskWidth[O],this.charMaskHeight[O],X.BLACK,192,this.charMask[O]);this.drawCharAlpha(_+this.charOffsetX[O],$+this.charOffsetY[O],this.charMaskWidth[O],this.charMaskHeight[O],G,H,this.charMask[O])}if(_+=this.charAdvance[O],(this.random.nextInt()&3)===0)_++}}drawStringRight(_,R,L,G,K=!0){if(_|=0,R|=0,K)this.drawString(_-this.stringWidth(L)+1,R+1,L,X.BLACK);this.drawString(_-this.stringWidth(L),R,L,G)}drawCenteredWave(_,R,L,G,K){if(!L)return;_|=0,R|=0,_-=this.stringWidth(L)/2|0;let Q=R-this.height;for(let H=0;H<L.length;H++){let $=y0.CHARCODESET[L.charCodeAt(H)];if($!=94)this.drawChar(this.charMask[$],_+this.charOffsetX[$],Q+this.charOffsetY[$]+(Math.sin(H/2+K/5)*5|0),this.charMaskWidth[$],this.charMaskHeight[$],G);_+=this.charAdvance[$]}}drawChar(_,R,L,G,K,Q){R|=0,L|=0,G|=0,K|=0;let H=R+L*j.width2d,$=j.width2d-G,J=0,O=0;if(L<j.top){let q=j.top-L;K-=q,L=j.top,O+=q*G,H+=q*j.width2d}if(L+K>=j.bottom)K-=L+K+1-j.bottom;if(R<j.left){let q=j.left-R;G-=q,R=j.left,O+=q,H+=q,J+=q,$+=q}if(R+G>=j.right){let q=R+G+1-j.right;G-=q,J+=q,$+=q}if(G>0&&K>0)this.drawMask(G,K,_,O,J,j.pixels,H,$,Q)}drawCharAlpha(_,R,L,G,K,Q,H){_|=0,R|=0,L|=0,G|=0;let $=_+R*j.width2d,J=j.width2d-L,O=0,q=0;if(R<j.top){let b=j.top-R;G-=b,R=j.top,q+=b*L,$+=b*j.width2d}if(R+G>=j.bottom)G-=R+G+1-j.bottom;if(_<j.left){let b=j.left-_;L-=b,_=j.left,q+=b,$+=b,O+=b,J+=b}if(_+L>=j.right){let b=_+L+1-j.right;L-=b,O+=b,J+=b}if(L>0&&G>0)this.drawMaskAlpha(L,G,j.pixels,$,J,H,q,O,K,Q)}drawMask(_,R,L,G,K,Q,H,$,J){_|=0,R|=0;let O=-(_>>2);_=-(_&3);for(let q=-R;q<0;q++){for(let b=O;b<0;b++){if(L[G++]===0)H++;else Q[H++]=J;if(L[G++]===0)H++;else Q[H++]=J;if(L[G++]===0)H++;else Q[H++]=J;if(L[G++]===0)H++;else Q[H++]=J}for(let b=_;b<0;b++)if(L[G++]===0)H++;else Q[H++]=J;H+=$,G+=K}}drawMaskAlpha(_,R,L,G,K,Q,H,$,J,O){_|=0,R|=0;let q=((J&16711935)*O&4278255360)+((J&65280)*O&16711680)>>8,b=256-O;for(let U=-R;U<0;U++){for(let N=-_;N<0;N++)if(Q[H++]===0)G++;else{let I=L[G];L[G++]=(((I&16711935)*b&4278255360)+((I&65280)*b&16711680)>>8)+q}G+=K,H+=$}}evaluateTag(_){if(_==="red")return X.RED;else if(_==="gre")return X.GREEN;else if(_==="blu")return X.BLUE;else if(_==="yel")return X.YELLOW;else if(_==="cya")return X.CYAN;else if(_==="mag")return X.MAGENTA;else if(_==="whi")return X.WHITE;else if(_==="bla")return X.BLACK;else if(_==="lre")return X.LIGHTRED;else if(_==="dre")return X.DARKRED;else if(_==="dbl")return X.DARKBLUE;else if(_==="or1")return X.ORANGE1;else if(_==="or2")return X.ORANGE2;else if(_==="or3")return X.ORANGE3;else if(_==="gr1")return X.GREEN1;else if(_==="gr2")return X.GREEN2;else if(_==="gr3")return X.GREEN3;else return X.BLACK}split(_,R){if(_.length===0)return[_];let L=[];while(_.length>0){if(this.stringWidth(_)<=R&&_.indexOf("|")===-1){L.push(_);break}let K=_.length;for(let Q=0;Q<_.length;Q++)if(_[Q]===" "){if(this.stringWidth(_.substring(0,Q))>R)break;K=Q}else if(_[Q]==="|"){K=Q;break}L.push(_.substring(0,K)),_=_.substring(K+1)}return L}}var M5=(()=>{var _=import.meta.url;return async function(R={}){var L,G=R,K,Q,H=new Promise((A,Z)=>{K=A,Q=Z}),$=typeof window=="object",J=typeof WorkerGlobalScope!="undefined",O=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer",q=!$&&!O&&!J,b=Object.assign({},G),U=[],N="./this.program",I=(A,Z)=>{throw Z},k="";function F(A){if(G.locateFile)return G.locateFile(A,k);return k+A}var T,Y;if(O){if(typeof process=="undefined"||!process.release||process.release.name!=="node")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");var u=process.versions.node,w=u.split(".").slice(0,3);w=w[0]*1e4+w[1]*100+w[2].split("-")[0]*1;var B=160000;if(w<160000)throw new Error("This emscripten-generated code requires node v16.0.0 (detected v"+u+")");var v=(()=>({})),n=(u5(),I8(Z5));if(!import.meta.url.startsWith("data:"))k=n.dirname((m5(),I8(B5)).fileURLToPath(import.meta.url))+"/";if(Y=(A)=>{A=Q1(A)?new URL(A):A;var Z=v.readFileSync(A);return i(Buffer.isBuffer(Z)),Z},T=async(A,Z=!0)=>{A=Q1(A)?new URL(A):A;var D=v.readFileSync(A,Z?void 0:"utf8");return i(Z?Buffer.isBuffer(D):typeof D=="string"),D},!G.thisProgram&&process.argv.length>1)N=process.argv[1].replace(/\\/g,"/");U=process.argv.slice(2),I=(A,Z)=>{throw process.exitCode=A,Z}}else if(q){if(typeof process=="object"&&!0||typeof window=="object"||typeof WorkerGlobalScope!="undefined")throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)")}else if($||J){if(J)k=self.location.href;else if(typeof document!="undefined"&&document.currentScript)k=document.currentScript.src;if(_)k=_;if(k.startsWith("blob:"))k="";else k=k.substr(0,k.replace(/[?#].*/,"").lastIndexOf("/")+1);if(!(typeof window=="object"||typeof WorkerGlobalScope!="undefined"))throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");{if(J)Y=(A)=>{var Z=new XMLHttpRequest;return Z.open("GET",A,!1),Z.responseType="arraybuffer",Z.send(null),new Uint8Array(Z.response)};T=async(A)=>{if(Q1(A))return new Promise((D,o)=>{var K0=new XMLHttpRequest;K0.open("GET",A,!0),K0.responseType="arraybuffer",K0.onload=()=>{if(K0.status==200||K0.status==0&&K0.response){D(K0.response);return}o(K0.status)},K0.onerror=o,K0.send(null)});var Z=await fetch(A,{credentials:"same-origin"});if(Z.ok)return Z.arrayBuffer();throw new Error(Z.status+" : "+Z.url)}}}else throw new Error("environment detection error");var W=G.print||void 0,P=G.printErr||void 0;if(Object.assign(G,b),b=null,s5(),G.arguments)U=G.arguments;if(a0("arguments","arguments_"),G.thisProgram)N=G.thisProgram;a0("thisProgram","thisProgram"),i(typeof G.memoryInitializerPrefixURL=="undefined","Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead"),i(typeof G.pthreadMainPrefixURL=="undefined","Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead"),i(typeof G.cdInitializerPrefixURL=="undefined","Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead"),i(typeof G.filePackagePrefixURL=="undefined","Module.filePackagePrefixURL option was removed, use Module.locateFile instead"),i(typeof G.read=="undefined","Module.read option was removed"),i(typeof G.readAsync=="undefined","Module.readAsync option was removed (modify readAsync in JS)"),i(typeof G.readBinary=="undefined","Module.readBinary option was removed (modify readBinary in JS)"),i(typeof G.setWindowTitle=="undefined","Module.setWindowTitle option was removed (modify emscripten_set_window_title in JS)"),i(typeof G.TOTAL_MEMORY=="undefined","Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY"),a0("asm","wasmExports"),a0("readAsync","readAsync"),a0("readBinary","readBinary"),a0("setWindowTitle","setWindowTitle");var z="IDBFS is no longer included by default; build with -lidbfs.js",f="PROXYFS is no longer included by default; build with -lproxyfs.js",m="WORKERFS is no longer included by default; build with -lworkerfs.js",M="FETCHFS is no longer included by default; build with -lfetchfs.js",r="ICASEFS is no longer included by default; build with -licasefs.js",a="JSFILEFS is no longer included by default; build with -ljsfilefs.js",C="OPFS is no longer included by default; build with -lopfs.js",L0="NODEFS is no longer included by default; build with -lnodefs.js";i(!q,"shell environment detected but not enabled at build time.  Add `shell` to `-sENVIRONMENT` to enable.");var e=G.wasmBinary;if(a0("wasmBinary","wasmBinary"),typeof WebAssembly!="object")P("no native wasm support detected");var G0,J0=!1,Q0;function i(A,Z){if(!A)m0("Assertion failed"+(Z?": "+Z:""))}var j0,$0,F0,T0,L1,b1,P0,V1,Y1,g8,Z1,u1=!1,f8="data:application/octet-stream;base64,",f1=(A)=>A.startsWith(f8),Q1=(A)=>A.startsWith("file://");function C8(){var A=T5();if(i((A&3)==0),A==0)A+=4;P0[A>>2]=34821223,P0[A+4>>2]=2310721022,P0[0]=1668509029}function w1(){if(J0)return;var A=T5();if(A==0)A+=4;var Z=P0[A>>2],D=P0[A+4>>2];if(Z!=34821223||D!=2310721022)m0(`Stack overflow! Stack cookie has been overwritten at ${N1(A)}, expected hex dwords 0x89BACDFE and 0x2135467, but received ${N1(D)} ${N1(Z)}`);if(P0[0]!=1668509029)m0("Runtime error: The application has corrupted its heap memory area (address zero)!")}if((()=>{var A=new Int16Array(1),Z=new Int8Array(A.buffer);if(A[0]=25459,Z[0]!==115||Z[1]!==99)throw"Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)"})(),G.ENVIRONMENT)throw new Error("Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)");function a0(A,Z,D=!0){if(!Object.getOwnPropertyDescriptor(G,A))Object.defineProperty(G,A,{configurable:!0,get(){let o=D?" (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)":"";m0(`\`Module.${A}\` has been replaced by \`${Z}\``+o)}})}function n8(A){if(Object.getOwnPropertyDescriptor(G,A))m0(`\`Module.${A}\` was supplied but \`${A}\` not included in INCOMING_MODULE_JS_API`)}function C1(A){return A==="FS_createPath"||A==="FS_createDataFile"||A==="FS_createPreloadedFile"||A==="FS_unlink"||A==="addRunDependency"||A==="FS_createLazyFile"||A==="FS_createDevice"||A==="removeRunDependency"}function n1(A,Z){if(typeof globalThis!="undefined"&&!Object.getOwnPropertyDescriptor(globalThis,A))Object.defineProperty(globalThis,A,{configurable:!0,get(){Z();return}})}function s1(A,Z){n1(A,()=>{C0(`\`${A}\` is not longer defined by emscripten. ${Z}`)})}s1("buffer","Please use HEAP8.buffer or wasmMemory.buffer"),s1("asm","Please use wasmExports instead");function s8(A){n1(A,()=>{var Z=`\`${A}\` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line`,D=A;if(!D.startsWith("_"))D="$"+A;if(Z+=` (e.g. -sDEFAULT_LIBRARY_FUNCS_TO_INCLUDE='${D}')`,C1(A))Z+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you";C0(Z)}),p1(A)}function p1(A){if(!Object.getOwnPropertyDescriptor(G,A))Object.defineProperty(G,A,{configurable:!0,get(){var Z=`'${A}' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the Emscripten FAQ)`;if(C1(A))Z+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you";m0(Z)}})}function A6(...A){}function y1(){var A=G0.buffer;G.HEAP8=$0=new Int8Array(A),G.HEAP16=T0=new Int16Array(A),G.HEAPU8=F0=new Uint8Array(A),G.HEAPU16=L1=new Uint16Array(A),G.HEAP32=b1=new Int32Array(A),G.HEAPU32=P0=new Uint32Array(A),G.HEAPF32=V1=new Float32Array(A),G.HEAPF64=Z1=new Float64Array(A),G.HEAP64=Y1=new BigInt64Array(A),G.HEAPU64=g8=new BigUint64Array(A)}i(!G.STACK_SIZE,"STACK_SIZE can no longer be set at runtime.  Use -sSTACK_SIZE at link time"),i(typeof Int32Array!="undefined"&&typeof Float64Array!=="undefined"&&Int32Array.prototype.subarray!=null&&Int32Array.prototype.set!=null,"JS engine does not provide full typed array support"),i(!G.wasmMemory,"Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally"),i(!G.INITIAL_MEMORY,"Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically");var r1=[],x1=[],W6=[],i1=[];function p8(){if(G.preRun){if(typeof G.preRun=="function")G.preRun=[G.preRun];while(G.preRun.length)x8(G.preRun.shift())}X1(r1)}function y8(){i(!u1),u1=!0,w1(),X1(x1)}function r8(){if(w1(),G.postRun){if(typeof G.postRun=="function")G.postRun=[G.postRun];while(G.postRun.length)a8(G.postRun.shift())}X1(i1)}function x8(A){r1.unshift(A)}function i8(A){x1.unshift(A)}function h6(A){}function a8(A){i1.unshift(A)}var c0=0,H1=null,o0={},d0=null;function B6(A){var Z=A;while(!0){if(!o0[A])return A;A=Z+Math.random()}}function c8(A){if(c0++,G.monitorRunDependencies?.(c0),A){if(i(!o0[A]),o0[A]=1,d0===null&&typeof setInterval!="undefined")d0=setInterval(()=>{if(J0){clearInterval(d0),d0=null;return}var Z=!1;for(var D in o0){if(!Z)Z=!0,P("still waiting on run dependencies:");P(`dependency: ${D}`)}if(Z)P("(end of list)")},1e4)}else P("warning: run dependency added without ID")}function d8(A){if(c0--,G.monitorRunDependencies?.(c0),A)i(o0[A]),delete o0[A];else P("warning: run dependency removed without ID");if(c0==0){if(d0!==null)clearInterval(d0),d0=null;if(H1){var Z=H1;H1=null,Z()}}}function m0(A){G.onAbort?.(A),A="Aborted("+A+")",P(A),J0=!0;var Z=new WebAssembly.RuntimeError(A);throw Q(Z),Z}var z0={error(){m0("Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM")},init(){z0.error()},createDataFile(){z0.error()},createPreloadedFile(){z0.error()},createLazyFile(){z0.error()},open(){z0.error()},mkdev(){z0.error()},registerDevice(){z0.error()},analyzePath(){z0.error()},ErrnoError(){z0.error()}};G.FS_createDataFile=z0.createDataFile,G.FS_createPreloadedFile=z0.createPreloadedFile;function M0(A,Z){return(...D)=>{i(u1,`native function \`${A}\` called before runtime initialization`);var o=l0[A];return i(o,`exported native function \`${A}\` not found`),i(D.length<=Z,`native function \`${A}\` called with ${D.length} args but expects ${Z}`),o(...D)}}var $1;function t8(){if(G.locateFile){var A="bzip2.wasm";if(!f1(A))return F(A);return A}return new URL("bzip2.wasm",import.meta.url).href}function o8(A){if(A==$1&&e)return new Uint8Array(e);if(Y)return Y(A);throw"both async and sync fetching of the wasm failed"}async function l8(A){if(!e)try{var Z=await T(A);return new Uint8Array(Z)}catch{}return o8(A)}async function e8(A,Z){try{var D=await l8(A),o=await WebAssembly.instantiate(D,Z);return o}catch(K0){if(P(`failed to asynchronously prepare wasm: ${K0}`),Q1($1))P(`warning: Loading from a file URI (${$1}) is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing`);m0(K0)}}async function _5(A,Z,D){if(!A&&typeof WebAssembly.instantiateStreaming=="function"&&!f1(Z)&&!Q1(Z)&&!O)try{var o=fetch(Z,{credentials:"same-origin"}),K0=await WebAssembly.instantiateStreaming(o,D);return K0}catch(O0){P(`wasm streaming compile failed: ${O0}`),P("falling back to ArrayBuffer instantiation")}return e8(Z,D)}function R5(){return{env:F5,wasi_snapshot_preview1:F5}}async function L5(){function A(b0,k0){return l0=b0.exports,G0=l0.memory,i(G0,"memory not found in wasm exports"),y1(),i8(l0.__wasm_call_ctors),d8("wasm-instantiate"),l0}c8("wasm-instantiate");var Z=G;function D(b0){return i(G===Z,"the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?"),Z=null,A(b0.instance)}var o=R5();if(G.instantiateWasm)try{return G.instantiateWasm(o,A)}catch(b0){P(`Module.instantiateWasm callback failed with error: ${b0}`),Q(b0)}$1??=t8();try{var K0=await _5(e,$1,o),O0=D(K0);return O0}catch(b0){return Q(b0),Promise.reject(b0)}}class J8{name="ExitStatus";constructor(A){this.message=`Program terminated with exit(${A})`,this.status=A}}var X1=(A)=>{while(A.length>0)A.shift()(G)};function G5(A,Z="i8"){if(Z.endsWith("*"))Z="*";switch(Z){case"i1":return $0[A];case"i8":return $0[A];case"i16":return T0[A>>1];case"i32":return b1[A>>2];case"i64":return Y1[A>>3];case"float":return V1[A>>2];case"double":return Z1[A>>3];case"*":return P0[A>>2];default:m0(`invalid type for getValue: ${Z}`)}}var v5=G.noExitRuntime||!0,N1=(A)=>{return i(typeof A==="number"),A>>>=0,"0x"+A.toString(16).padStart(8,"0")};function K5(A,Z,D="i8"){if(D.endsWith("*"))D="*";switch(D){case"i1":$0[A]=Z;break;case"i8":$0[A]=Z;break;case"i16":T0[A>>1]=Z;break;case"i32":b1[A>>2]=Z;break;case"i64":Y1[A>>3]=BigInt(Z);break;case"float":V1[A>>2]=Z;break;case"double":Z1[A>>3]=Z;break;case"*":P0[A>>2]=Z;break;default:m0(`invalid type for setValue: ${D}`)}}var m6=(A)=>b8(A),S6=()=>a5(),C0=(A)=>{if(C0.shown||={},!C0.shown[A]){if(C0.shown[A]=1,O)A="warning: "+A;P(A)}},Q5=()=>m0("native code called abort()"),H5=()=>2147483648,$5=(A,Z)=>{return i(Z,"alignment argument is required"),Math.ceil(A/Z)*Z},J5=(A)=>{var Z=G0.buffer,D=(A-Z.byteLength+65535)/65536|0;try{return G0.grow(D),y1(),1}catch(o){P(`growMemory: Attempted to grow heap from ${Z.byteLength} bytes to ${A} bytes, but got error: ${o}`)}},O5=(A)=>{var Z=F0.length;A>>>=0,i(A>Z);var D=H5();if(A>D)return P(`Cannot enlarge memory, requested ${A} bytes, but the limit is ${D} bytes!`),!1;for(var o=1;o<=4;o*=2){var K0=Z*(1+0.2/o);K0=Math.min(K0,A+100663296);var O0=Math.min(D,$5(Math.max(A,K0),65536)),b0=J5(O0);if(b0)return!0}return P(`Failed to grow the heap from ${Z} bytes to ${O0} bytes, not enough memory!`),!1},a1=0,c1=()=>v5||a1>0,q5=(A)=>{if(Q0=A,!c1())G.onExit?.(A),J0=!0;I(A,new J8(A))},g5=(A,Z)=>{if(Q0=A,l1(),c1()&&!Z){var D=`program exited (with status: ${A}), but keepRuntimeAlive() is set (counter=${a1}) due to an async operation, so halting execution but not exiting the runtime or preventing further async execution (you can use emscripten_force_exit, if you want to force a true shutdown)`;Q(D),P(D)}q5(A)},b5=g5,O8=typeof TextDecoder!="undefined"?new TextDecoder:void 0,q8=(A,Z=0,D=NaN)=>{var o=Z+D,K0=Z;while(A[K0]&&!(K0>=o))++K0;if(K0-Z>16&&A.buffer&&O8)return O8.decode(A.subarray(Z,K0));var O0="";while(Z<K0){var b0=A[Z++];if(!(b0&128)){O0+=String.fromCharCode(b0);continue}var k0=A[Z++]&63;if((b0&224)==192){O0+=String.fromCharCode((b0&31)<<6|k0);continue}var t0=A[Z++]&63;if((b0&240)==224)b0=(b0&15)<<12|k0<<6|t0;else{if((b0&248)!=240)C0("Invalid UTF-8 leading byte "+N1(b0)+" encountered when deserializing a UTF-8 string in wasm memory to a JS string!");b0=(b0&7)<<18|k0<<12|t0<<6|A[Z++]&63}if(b0<65536)O0+=String.fromCharCode(b0);else{var U1=b0-65536;O0+=String.fromCharCode(55296|U1>>10,56320|U1&1023)}}return O0},N5=(A,Z)=>{return i(typeof A=="number",`UTF8ToString expects a number (got ${typeof A})`),A?q8(F0,A,Z):""},f5={varargs:void 0,getStr(A){var Z=N5(A);return Z}},d1=(A)=>{m0("fd_close called without SYSCALLS_REQUIRE_FILESYSTEM")},t1=9007199254740992,U5=-9007199254740992,I5=(A)=>A<U5||A>t1?NaN:Number(A);function E5(A,Z,D,o){return Z=I5(Z),70}var S1=[null,[],[]],r0=(A,Z)=>{var D=S1[A];if(i(D),Z===0||Z===10)(A===1?W:P)(q8(D)),D.length=0;else D.push(Z)},C5=()=>{if(p5(0),S1[1].length)r0(1,10);if(S1[2].length)r0(2,10)},n5=(A,Z,D,o)=>{var K0=0;for(var O0=0;O0<D;O0++){var b0=P0[Z>>2],k0=P0[Z+4>>2];Z+=8;for(var t0=0;t0<k0;t0++)r0(A,F0[b0+t0]);K0+=k0}return P0[o>>2]=K0,0};function s5(){n8("fetchSettings")}var F5={_abort_js:Q5,emscripten_resize_heap:O5,exit:b5,fd_close:d1,fd_seek:E5,fd_write:n5},l0=await L5(),P6=M0("__wasm_call_ctors",0),z6=G._malloc=M0("malloc",1),D6=G._free=M0("free",1),p5=M0("fflush",1),M6=G._BZ2_bzBuffToBuffCompress=M0("BZ2_bzBuffToBuffCompress",7),v6=G._BZ2_bzBuffToBuffDecompress=M0("BZ2_bzBuffToBuffDecompress",6),y5=M0("strerror",1),r5=l0.emscripten_stack_init,x5=l0.emscripten_stack_get_free,g6=l0.emscripten_stack_get_base,T5=l0.emscripten_stack_get_end,b8=l0._emscripten_stack_restore,i5=l0._emscripten_stack_alloc,a5=l0.emscripten_stack_get_current;G.setValue=K5,G.getValue=G5;var k5=["writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","stackAlloc","getTempRet0","setTempRet0","zeroMemory","strError","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","emscriptenLog","readEmAsmArgs","jstoi_q","getExecutableName","listenOnce","autoResumeAudioContext","getDynCaller","dynCall","handleException","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","asmjsMangle","asyncLoad","mmapAlloc","HandleAllocator","getNativeTypeSize","STACK_SIZE","STACK_ALIGN","POINTER_SIZE","ASSERTIONS","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","generateFuncType","convertJsFunctionToWasm","getEmptyTableSlot","updateTableMap","getFunctionAddress","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","stringToUTF8Array","stringToUTF8","lengthBytesUTF8","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","stringToNewUTF8","stringToUTF8OnStack","writeArrayToMemory","registerKeyEventCallback","maybeCStringToJsString","findEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","jsStackTrace","getCallstack","convertPCtoSourceLocation","getEnvStrings","checkWasiClock","wasiRightsToMuslOFlags","wasiOFlagsToMuslOFlags","initRandomFill","randomFill","safeSetTimeout","setImmediateWrapped","safeRequestAnimationFrame","clearImmediateWrapped","registerPostMainLoop","registerPreMainLoop","getPromise","makePromise","idsToPromises","makePromiseCallback","ExceptionInfo","findMatchingCatch","Browser_asyncPrepareDataCounter","isLeapYear","ydayFromDate","arraySum","addDays","getSocketFromFD","getSocketAddress","FS_createPreloadedFile","FS_modeStringToFlags","FS_getMode","FS_stdin_getChar","FS_unlink","FS_createDataFile","FS_mkdirTree","_setNetworkCallback","heapObjectForWebGLType","toTypedArrayIndex","webgl_enable_ANGLE_instanced_arrays","webgl_enable_OES_vertex_array_object","webgl_enable_WEBGL_draw_buffers","webgl_enable_WEBGL_multi_draw","webgl_enable_EXT_polygon_offset_clamp","webgl_enable_EXT_clip_control","webgl_enable_WEBGL_polygon_mode","emscriptenWebGLGet","computeUnpackAlignedImageSize","colorChannelsInGlTextureFormat","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","__glGetActiveAttribOrUniform","writeGLArray","registerWebGlEventCallback","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate","writeStringToMemory","writeAsciiToMemory","setErrNo","demangle","stackTrace"];k5.forEach(s8);var j5=["run","addOnPreRun","addOnInit","addOnPreMain","addOnExit","addOnPostRun","addRunDependency","removeRunDependency","out","err","callMain","abort","wasmMemory","wasmExports","writeStackCookie","checkStackCookie","INT53_MAX","INT53_MIN","bigintToI53Checked","stackSave","stackRestore","ptrToString","exitJS","getHeapMax","growMemory","ENV","ERRNO_CODES","DNS","Protocols","Sockets","timers","warnOnce","readEmAsmArgsArray","jstoi_s","keepRuntimeAlive","alignMemory","wasmTable","noExitRuntime","freeTableIndexes","functionsInTableMap","PATH","PATH_FS","UTF8Decoder","UTF8ArrayToString","UTF8ToString","UTF16Decoder","JSEvents","specialHTMLTargets","findCanvasEventTarget","currentFullscreenStrategy","restoreOldWindowedStyle","UNWIND_CACHE","ExitStatus","flush_NO_FILESYSTEM","emSetImmediate","emClearImmediate_deps","emClearImmediate","promiseMap","uncaughtExceptionCount","exceptionLast","exceptionCaught","Browser","getPreloadedImageData__data","wget","MONTH_DAYS_REGULAR","MONTH_DAYS_LEAP","MONTH_DAYS_REGULAR_CUMULATIVE","MONTH_DAYS_LEAP_CUMULATIVE","SYSCALLS","preloadPlugins","FS_stdin_getChar_buffer","FS_createPath","FS_createDevice","FS_readFile","FS","FS_createLazyFile","MEMFS","TTY","PIPEFS","SOCKFS","tempFixedLengthArray","miniTempWebGLFloatBuffers","miniTempWebGLIntBuffers","GL","AL","GLUT","EGL","GLEW","IDBStore","SDL","SDL_gfx","allocateUTF8","allocateUTF8OnStack","print","printErr"];j5.forEach(p1);var N8;function U8(){r5(),C8()}function o1(){if(c0>0){H1=o1;return}if(U8(),p8(),c0>0){H1=o1;return}function A(){if(i(!N8),N8=!0,G.calledRun=!0,J0)return;y8(),K(G),G.onRuntimeInitialized?.(),i(!G._main,'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]'),r8()}if(G.setStatus)G.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>G.setStatus(""),1),A()},1);else A();w1()}function l1(){var A=W,Z=P,D=!1;W=P=(o)=>{D=!0};try{C5()}catch(o){}if(W=A,P=Z,D)C0("stdio streams had content in them that was not flushed. you should set EXIT_RUNTIME to 1 (see the Emscripten FAQ), or make sure to emit a newline when you printf etc."),C0("(this may also be due to not including full filesystem support - try building with -sFORCE_FILESYSTEM)")}if(G.preInit){if(typeof G.preInit=="function")G.preInit=[G.preInit];while(G.preInit.length>0)G.preInit.pop()()}o1(),L=H;for(let A of Object.keys(G))if(!(A in R))Object.defineProperty(R,A,{configurable:!0,get(){m0(`Access to module property ('${A}') is no longer possible via the module constructor argument; Instead, use the result of the module constructor.`)}});return L}})();(()=>{var _=M5;M5=function(R){if(new.target)throw new Error("loadBZip2WASM() should not be called with `new loadBZip2WASM()`");return _(R)}})();var j6=M5;var Y_={"-2":"BZ_PARAM_ERROR: incorrect parameters","-3":"BZ_MEM_ERROR: couldn't allocate enough memory","-4":"BZ_DATA_ERROR: data integrity error when decompressing","-5":"BZ_DATA_ERROR_MAGIC: compressed data has incorrect header","-7":"BZ_UNEXPECTED_EOF: compressed data ends too early","-8":"BZ_OUTBUFF_FULL: destination buffer is full"};class V6{constructor(){this.wasmModule=void 0}async init(){if(this.wasmModule)return;this.wasmModule=await j6()}ensureInitialized(){if(!this.wasmModule)throw new Error(`${this.constructor.name} not initalized. call .init()`)}handleError(_,R,L){if(_===0)return;this.wasmModule._free(R),this.wasmModule._free(L);let G=Y_[_];if(G)throw new Error(G);throw new Error(`error code: ${_}`)}createWASMBuffers(_,R){let{_malloc:L,setValue:G,HEAPU8:K}=this.wasmModule,Q=L(_.length);K.set(_,Q);let H=L(R),$=L(R);return G($,R,"i32"),{sourcePtr:Q,destPtr:H,destLengthPtr:$}}createBuffer(_,R){let{_free:L,getValue:G,HEAPU8:K}=this.wasmModule,Q=G(R,"i32"),H=new Uint8Array(Q);return H.set(K.subarray(_,_+Q)),L(_),L(R),H}decompress(_,R,L=!1,G=!1){if(G)R=_[0]<<24|_[1]<<16|_[2]<<8|_[3],_[0]=66,_[1]=90,_[2]=104,_[3]=49,L=!1;if(L){let J=new Uint8Array(_.length+4);J[0]=66,J[1]=90,J[2]=104,J[3]=49,J.set(_,4),_=J}this.ensureInitialized();let{sourcePtr:K,destPtr:Q,destLengthPtr:H}=this.createWASMBuffers(_,R),$=this.wasmModule._BZ2_bzBuffToBuffDecompress(Q,H,K,_.length,0,0);return this.wasmModule._free(K),this.handleError($,Q,H),this.createBuffer(Q,H)}compress(_,R=!1,L=!1,G=1,K=0){if(this.ensureInitialized(),!K)K=_.length;if(K<128)K=128;if(G<=0||G>9)throw new RangeError("blockSize should be between 1-9");let{sourcePtr:Q,destPtr:H,destLengthPtr:$}=this.createWASMBuffers(_,K),J=this.wasmModule._BZ2_bzBuffToBuffCompress(H,$,Q,_.length,G,0,30);this.wasmModule._free(Q),this.handleError(J,H,$);let O=this.createBuffer(H,$);if(R)O[0]=_.length>>24&255,O[1]=_.length>>16&255,O[2]=_.length>>8&255,O[3]=_.length&255;if(L)return O.subarray(4);return O}}var Y6=V6;var Z6=new Y6;await Z6.init();var B1=Z6;class Q8{socket;wsin;wsout;closed=!1;ioerror=!1;static openSocket=async(_)=>{return await new Promise((R,L)=>{let G=_.host.startsWith("https"),K=G?"wss":"ws",Q=_.host.substring(_.host.indexOf("//")+2),H=G?_.port+2:_.port+1,$=new WebSocket(`${K}://${Q}:${H}`,"binary");$.addEventListener("open",()=>{R($)}),$.addEventListener("error",()=>{L($)})})};constructor(_){_.onclose=this.onclose,_.onerror=this.onerror,this.wsin=new X6(_,5000),this.wsout=new u6(_,5000),this.socket=_}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(_,R){this.wsout.write(_,R)}async read(){return this.closed?0:this.wsin.fastByte()??await this.wsin.slowByte()}async readBytes(_,R,L){if(this.closed)return;while(L>0){let G=this.wsin.fastBytes(_,R,L)??await this.wsin.slowBytes(_,R,L);if(G.length<=0)throw new Error("EOF");R+=G.length,L-=G.length}}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=(_)=>{if(this.closed)return;this.close()};onerror=(_)=>{if(this.closed)return;this.ioerror=!0,this.close()}}class u6{socket;limit;closed=!1;ioerror=!1;constructor(_,R){this.socket=_,this.limit=R}write(_,R){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,new Error("Error in writer thread");if(R>this.limit||_.length>this.limit)throw new Error("buffer overflow");try{this.socket.send(_.subarray(0,R))}catch(L){this.ioerror=!0}}close(){this.closed=!0}}class w6 extends D0{bytes;position;constructor(_){super();this.bytes=_,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class X6{limit;queue=new g0;event=null;callback=null;total=0;closed=!1;constructor(_,R){this.limit=R,_.binaryType="arraybuffer",_.onmessage=this.onmessage}get available(){return this.total}onmessage=(_)=>{if(this.closed)throw new Error("WebSocketReader is closed!");let R=new w6(new Uint8Array(_.data));if(this.event)this.queue.addTail(R);else this.event=R;if(this.total+=R.len,!this.callback)return;if(this.callback(this.event),this.callback=null,this.total>this.limit)throw new Error("buffer overflow")};readFastByte(){if(this.event&&this.event.available>0)return this.event.read;return null}async readSlowByte(_){this.event=this.queue.removeHead();while(this.total<_)await Promise.race([new Promise((R)=>this.callback=R),q1(2000).then(()=>{if(this.closed)throw new Error("WebSocketReader closed while reading.")})]);return this.event?this.event.read:this.readSlowByte(_)}fastBytes(_,R,L){if(this.closed)throw new Error("WebSocketReader is closed!");if(!(this.event&&this.event.available>=L))return null;while(L>0){let G=this.readFastByte();if(G===null)throw new Error("EOF - tried to read a fast byte when there was not enough immediate bytes.");_[R++]=G,this.total--,L--}return _}async slowBytes(_,R,L){if(this.closed)throw new Error("WebSocketReader is closed!");while(L>0)_[R++]=this.readFastByte()??await this.readSlowByte(L),this.total--,L--;return _}fastByte(){if(this.closed)throw new Error("WebSocketReader is closed!");let _=this.readFastByte();if(_===null)return null;return this.total--,_}async slowByte(){if(this.closed)throw new Error("WebSocketReader is closed!");let _=await this.readSlowByte(1);return this.total--,_}close(){this.closed=!0,this.callback=null,this.total=0,this.event=null,this.queue.clear()}}class c{static REBUILD_GETMAPS=150;static NO_TIMEOUT=108;static IDLE_TIMER=70;static EVENT_TRACKING=81;static EVENT_CAMERA_POSITION=189;static ANTICHEAT_OPLOGIC1=7;static ANTICHEAT_OPLOGIC2=88;static ANTICHEAT_OPLOGIC3=30;static ANTICHEAT_OPLOGIC4=176;static ANTICHEAT_OPLOGIC5=220;static ANTICHEAT_OPLOGIC6=66;static ANTICHEAT_OPLOGIC7=17;static ANTICHEAT_OPLOGIC8=2;static ANTICHEAT_OPLOGIC9=238;static ANTICHEAT_CYCLELOGIC1=233;static ANTICHEAT_CYCLELOGIC2=146;static ANTICHEAT_CYCLELOGIC3=215;static ANTICHEAT_CYCLELOGIC4=236;static ANTICHEAT_CYCLELOGIC5=85;static ANTICHEAT_CYCLELOGIC6=219;static OPOBJ1=140;static OPOBJ2=40;static OPOBJ3=200;static OPOBJ4=178;static OPOBJ5=247;static OPOBJT=138;static OPOBJU=239;static OPNPC1=194;static OPNPC2=8;static OPNPC3=27;static OPNPC4=113;static OPNPC5=100;static OPNPCT=134;static OPNPCU=202;static OPLOC1=245;static OPLOC2=172;static OPLOC3=96;static OPLOC4=97;static OPLOC5=116;static OPLOCT=9;static OPLOCU=75;static OPPLAYER1=164;static OPPLAYER2=53;static OPPLAYER3=185;static OPPLAYER4=206;static OPPLAYERT=177;static OPPLAYERU=248;static OPHELD1=195;static OPHELD2=71;static OPHELD3=133;static OPHELD4=157;static OPHELD5=211;static OPHELDT=48;static OPHELDU=130;static INV_BUTTON1=31;static INV_BUTTON2=59;static INV_BUTTON3=212;static INV_BUTTON4=38;static INV_BUTTON5=6;static IF_BUTTON=155;static RESUME_PAUSEBUTTON=235;static CLOSE_MODAL=231;static RESUME_P_COUNTDIALOG=237;static TUTORIAL_CLICKSIDE=175;static MOVE_OPCLICK=93;static BUG_REPORT=190;static MOVE_MINIMAPCLICK=165;static INV_BUTTOND=159;static IGNORELIST_DEL=171;static IGNORELIST_ADD=79;static IF_PLAYERDESIGN=52;static CHAT_SETMODE=244;static MESSAGE_PRIVATE=148;static FRIENDLIST_DEL=11;static FRIENDLIST_ADD=118;static CLIENT_CHEAT=4;static MESSAGE_PUBLIC=158;static MOVE_GAMECLICK=181}class H8{db;constructor(_){_.onerror=this.onerror,_.onclose=this.onclose,this.db=_}static openDatabase=async()=>{return await new Promise((_,R)=>{let L=indexedDB.open("lostcity",1);L.onsuccess=(G)=>{let K=G.target;_(K.result)},L.onupgradeneeded=(G)=>{G.target.result.createObjectStore("cache")},L.onerror=(G)=>{let K=G.target;R(K.result)}})};async cacheload(_){return await new Promise((R)=>{let K=this.db.transaction("cache","readonly").objectStore("cache").get(_);K.onsuccess=()=>{R(K.result)},K.onerror=(Q)=>{R(void 0)}})}async cachesave(_,R){return await new Promise((L,G)=>{let H=this.db.transaction("cache","readwrite").objectStore("cache").put(R,_);H.onsuccess=()=>{L()},H.onerror=($)=>{G()}})}onclose=(_)=>{};onerror=(_)=>{};genHash=(_)=>{let R=_.trim(),L=0;for(let G=0;G<R.length&&G<12;G++){let K=R.charAt(G);if(L*=37,K>="A"&&K<="Z")L+=K.charCodeAt(0)+1-65;else if(K>="a"&&K<="z")L+=K.charCodeAt(0)+1-97;else if(K>="0"&&K<="9")L+=K.charCodeAt(0)+27-48}return L}}class $8{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(_){for(let R=0;R<_.length;R++)this.rsl[R]=_[R];this.init()}get nextInt(){if(this.count--===0)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let _=2654435769,R=2654435769,L=2654435769,G=2654435769,K=2654435769,Q=2654435769,H=2654435769,$=2654435769;for(let J=0;J<4;J++)_^=R<<11,G+=_,R+=L,R^=L>>>2,K+=R,L+=G,L^=G<<8,Q+=L,G+=K,G^=K>>>16,H+=G,K+=Q,K^=Q<<10,$+=K,Q+=H,Q^=H>>>4,_+=Q,H+=$,H^=$<<8,R+=H,$+=_,$^=_>>>9,L+=$,_+=R;for(let J=0;J<256;J+=8)_+=this.rsl[J],R+=this.rsl[J+1],L+=this.rsl[J+2],G+=this.rsl[J+3],K+=this.rsl[J+4],Q+=this.rsl[J+5],H+=this.rsl[J+6],$+=this.rsl[J+7],_^=R<<11,G+=_,R+=L,R^=L>>>2,K+=R,L+=G,L^=G<<8,Q+=L,G+=K,G^=K>>>16,H+=G,K+=Q,K^=Q<<10,$+=K,Q+=H,Q^=H>>>4,_+=Q,H+=$,H^=$<<8,R+=H,$+=_,$^=_>>>9,L+=$,_+=R,this.mem[J]=_,this.mem[J+1]=R,this.mem[J+2]=L,this.mem[J+3]=G,this.mem[J+4]=K,this.mem[J+5]=Q,this.mem[J+6]=H,this.mem[J+7]=$;for(let J=0;J<256;J+=8)_+=this.mem[J],R+=this.mem[J+1],L+=this.mem[J+2],G+=this.mem[J+3],K+=this.mem[J+4],Q+=this.mem[J+5],H+=this.mem[J+6],$+=this.mem[J+7],_^=R<<11,G+=_,R+=L,R^=L>>>2,K+=R,L+=G,L^=G<<8,Q+=L,G+=K,G^=K>>>16,H+=G,K+=Q,K^=Q<<10,$+=K,Q+=H,Q^=H>>>4,_+=Q,H+=$,H^=$<<8,R+=H,$+=_,$^=_>>>9,L+=$,_+=R,this.mem[J]=_,this.mem[J+1]=R,this.mem[J+2]=L,this.mem[J+3]=G,this.mem[J+4]=K,this.mem[J+5]=Q,this.mem[J+6]=H,this.mem[J+7]=$;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let _=0;_<256;_++){let R=this.mem[_],L=_&3;if(L===0)this.a^=this.a<<13;else if(L===1)this.a^=this.a>>>6;else if(L===2)this.a^=this.a<<2;else if(L===3)this.a^=this.a>>>16;this.a+=this.mem[_+128&255];let G;this.mem[_]=G=this.mem[R>>>2&255]+this.a+this.b,this.rsl[_]=this.b=this.mem[G>>>8>>>2&255]+R}}}class g1{static genHash=(_)=>{let R=0;_=_.toUpperCase();for(let L=0;L<_.length;L++)R=R*61+_.charCodeAt(L)-32|0;return R};buffer;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(_){let R=new p(new Uint8Array(_)),L=R.g3,G=R.g3;if(L===G)this.buffer=_,this.compressedWhole=!1;else this.buffer=B1.decompress(_.subarray(6),L,!0),R=new p(new Uint8Array(this.buffer)),this.compressedWhole=!0;this.fileCount=R.g2,this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let K=R.pos+this.fileCount*10;for(let Q=0;Q<this.fileCount;Q++)this.fileHash.push(R.g4),this.fileUnpackedSize.push(R.g3),this.filePackedSize.push(R.g3),this.fileOffset.push(K),K+=this.filePackedSize[Q]}read(_){let R=g1.genHash(_),L=this.fileHash.indexOf(R);if(L===-1)return null;return this.readIndex(L)}readIndex(_){if(_<0||_>=this.fileCount)return null;if(this.fileUnpacked[_])return this.fileUnpacked[_];let R=this.fileOffset[_],L=R+this.filePackedSize[_],G=Uint8Array.from(this.buffer.subarray(R,R+L));if(this.compressedWhole)return this.fileUnpacked[_]=G,G;else{let K=B1.decompress(G,this.fileUnpackedSize[_],!0);return this.fileUnpacked[_]=K,K}}}class v8{static CLIENTPROT_SCRAMBLED=[95,218,67,50,253,222,194,60,101,128,8,251,92,111,24,33,223,66,232,59,227,113,153,105,126,98,167,102,177,238,62,190,147,23,150,151,156,144,193,155,81,0,198,22,137,210,179,16,168,170,32,181,248,141,58,87,208,106,180,191,221,241,40,176,196,154,65,145,230,78,30,161,188,41,14,129,18,199,47,247,225,34,51,10,159,75,12,56,61,31,39,91,46,242,134,5,122,123,209,228,104,195,21,3,11,44,107,172,6,186,110,215,205,103,27,185,124,77,252,117,86,115,127,207,52,79,43,97,219,116,169,7,118,162,108,36,20,233,88,135,80,19,42,237,57,152,71,9,250,17,4,119,234,130,26,200,189,163,254,245,197,171,220,235,140,244,184,94,211,231,99,246,121,212,112,204,63,148,83,178,1,255,131,13,183,142,236,45,55,35,243,136,37,85,100,160,38,224,146,174,82,48,109,132,125,90,143,138,240,173,165,164,192,175,29,74,28,114,213,73,64,206,76,139,96,2,229,15,93,25,239,202,49,70,214,201,72,203,68,89,69,157,216,217,249,120,226,84,149,187,54,53,158,166,182,133,0];static SERVERPROT_SIZES=[0,-2,4,6,-1,0,0,2,0,0,0,0,5,4,2,2,0,0,0,0,2,-2,2,14,0,6,3,0,4,0,0,0,3,0,0,0,0,0,0,0,0,-1,4,2,6,0,6,0,0,3,7,0,0,0,-1,0,0,0,0,4,0,0,0,0,0,0,0,0,1,15,0,0,0,0,6,0,2,0,0,0,2,0,0,0,1,0,0,4,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,-2,0,0,2,0,0,0,2,9,0,0,0,0,0,4,0,0,0,3,7,9,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,3,2,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,-2,2,0,0,0,0,0,6,0,0,0,2,0,2,0,0,0,-2,0,0,4,0,0,0,0,6,0,0,-2,-2,0,0,0,0,0,0,-2,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0]}class t{static IF_OPENCHATMODAL=14;static IF_OPENMAINSIDEMODAL=28;static IF_CLOSE=129;static IF_OPENSIDEOVERLAY=167;static IF_OPENMAINMODAL=168;static IF_OPENSIDEMODAL=195;static IF_SETCOLOUR=2;static IF_SETHIDE=26;static IF_SETOBJECT=46;static IF_SHOWSIDE=84;static IF_SETMODEL=87;static IF_SETRECOL=103;static IF_SETANIM=146;static IF_SETPLAYERHEAD=197;static IF_SETTEXT=201;static IF_SETNPCHEAD=204;static IF_SETPOSITION=209;static TUTORIAL_FLASHSIDE=126;static TUTORIAL_OPENCHAT=185;static UPDATE_INV_STOP_TRANSMIT=15;static UPDATE_INV_FULL=98;static UPDATE_INV_PARTIAL=213;static CAM_LOOKAT=74;static CAM_SHAKE=13;static CAM_MOVETO=3;static CAM_RESET=239;static NPC_INFO=1;static PLAYER_INFO=184;static FINISH_TRACKING=133;static ENABLE_TRACKING=226;static MESSAGE_GAME=4;static UPDATE_IGNORELIST=21;static CHAT_FILTER_SETTINGS=32;static MESSAGE_PRIVATE=41;static UPDATE_FRIENDLIST=152;static UNSET_MAP_FLAG=19;static UPDATE_RUNWEIGHT=22;static HINT_ARROW=25;static UPDATE_REBOOT_TIMER=43;static UPDATE_STAT=44;static UPDATE_RUNENERGY=68;static RESET_ANIMS=136;static UPDATE_UID192=139;static LAST_LOGIN_INFO=140;static LOGOUT=142;static P_COUNTDIALOG=243;static SET_MULTIWAY=254;static DATA_LOC_DONE=20;static DATA_LAND_DONE=80;static DATA_LAND=132;static DATA_LOC=220;static REBUILD_NORMAL=237;static VARP_SMALL=150;static VARP_LARGE=175;static RESET_CLIENT_VARCACHE=193;static SYNTH_SOUND=12;static MIDI_SONG=54;static MIDI_JINGLE=212;static UPDATE_ZONE_PARTIAL_FOLLOWS=7;static UPDATE_ZONE_FULL_FOLLOWS=135;static UPDATE_ZONE_PARTIAL_ENCLOSED=162;static LOC_MERGE=23;static LOC_ANIM=42;static OBJ_DEL=49;static OBJ_REVEAL=50;static LOC_ADD_CHANGE=59;static MAP_PROJANIM=69;static LOC_DEL=76;static OBJ_COUNT=151;static MAP_ANIM=191;static OBJ_ADD=223}class j1{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((_)=>_.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((_)=>_.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((_)=>_.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack=(_)=>{let R=new p(_.read("fragmentsenc.txt")),L=new p(_.read("badenc.txt")),G=new p(_.read("domainenc.txt")),K=new p(_.read("tldlist.txt"));this.read(L,G,R,K)};static filter=(_)=>{let R=[..._];this.format(R);let L=R.join("").trim(),G=L.toLowerCase(),K=[...G];this.filterTlds(K),this.filterBadWords(K),this.filterDomains(K),this.filterFragments(K);for(let Q=0;Q<this.whitelist.length;Q++){let H=-1;while((H=G.indexOf(this.whitelist[Q],H+1))!==-1){let $=[...this.whitelist[Q]];for(let J=0;J<$.length;J++)K[J+H]=$[J]}}return this.replaceUppercases(K,[...L]),this.formatUppercases(K),K.join("").trim()};static read=(_,R,L,G)=>{this.readBadWords(_),this.readDomains(R),this.readFragments(L),this.readTld(G)};static readTld=(_)=>{let R=_.g4;for(let L=0;L<R;L++)this.tldTypes[L]=_.g1,this.tlds[L]=new Uint16Array(_.g1).map(()=>_.g1)};static readBadWords=(_)=>{let R=_.g4;for(let L=0;L<R;L++){this.bads[L]=new Uint16Array(_.g1).map(()=>_.g1);let G=new Array(_.g1).fill([]).map(()=>[_.g1b,_.g1b]);if(G.length>0)this.badCombinations[L]=G}};static readDomains=(_)=>{let R=_.g4;for(let L=0;L<R;L++)this.domains[L]=new Uint16Array(_.g1).map(()=>_.g1)};static readFragments=(_)=>{let R=_.g4;for(let L=0;L<R;L++)this.fragments[L]=_.g2};static filterTlds=(_)=>{let R=[..._],L=[..._];this.filterBadCombinations(null,R,this.PERIOD),this.filterBadCombinations(null,L,this.SLASH);for(let G=0;G<this.tlds.length;G++)this.filterTld(L,this.tldTypes[G],_,this.tlds[G],R)};static filterBadWords=(_)=>{for(let R=0;R<2;R++)for(let L=this.bads.length-1;L>=0;L--)this.filterBadCombinations(this.badCombinations[L],_,this.bads[L])};static filterDomains=(_)=>{let R=[..._],L=[..._];this.filterBadCombinations(null,R,this.AMPERSAT),this.filterBadCombinations(null,L,this.PERIOD);for(let G=this.domains.length-1;G>=0;G--)this.filterDomain(L,R,this.domains[G],_)};static filterFragments=(_)=>{for(let R=0;R<_.length;){let L=this.indexOfNumber(_,R);if(L===-1)return;let G=!1;for(let H=R;H>=0&&H<L&&!G;H++)if(!this.isSymbol(_[H])&&!this.isNotLowercaseAlpha(_[H]))G=!0;let K=0;if(G)K=0;if(K===0)K=1,R=L;let Q=0;for(let H=L;H<_.length&&H<R;H++)Q=Q*10+_[H].charCodeAt(0)-48;if(Q<=255&&R-L<=8)K++;else K=0;if(K===4)this.maskChars(L,R,_),K=0;R=this.indexOfNonNumber(R,_)}};static isBadFragment=(_)=>{if(this.isNumericalChars(_))return!0;let R=this.getInteger(_),L=this.fragments,G=L.length;if(R===L[0]||R===L[G-1])return!0;let K=0,Q=G-1;while(K<=Q){let H=(K+Q)/2|0;if(R===L[H])return!0;else if(R<L[H])Q=H-1;else K=H+1}return!1};static getInteger=(_)=>{if(_.length>6)return 0;let R=0;for(let L=0;L<_.length;L++){let G=_[_.length-L-1];if(this.isLowercaseAlpha(G))R=R*38+G.charCodeAt(0)+1-97;else if(G==="'")R=R*38+27;else if(this.isNumerical(G))R=R*38+G.charCodeAt(0)+28-48;else if(G!=="\x00")return 0}return R};static indexOfNumber=(_,R)=>{for(let L=R;L<_.length&&L>=0;L++)if(this.isNumerical(_[L]))return L;return-1};static indexOfNonNumber=(_,R)=>{for(let L=_;L<R.length&&L>=0;L++)if(!this.isNumerical(R[L]))return L;return R.length};static getEmulatedDomainCharLen=(_,R,L)=>{if(R===L)return 1;else if(R==="o"&&L==="0")return 1;else if(R==="o"&&L==="("&&_===")")return 2;else if(R==="c"&&(L==="("||L==="<"||L==="["))return 1;else if(R==="e"&&L==="€")return 1;else if(R==="s"&&L==="$")return 1;else if(R==="l"&&L==="i")return 1;return 0};static filterDomain=(_,R,L,G)=>{let K=L.length,Q=G.length;for(let H=0;H<=Q-K;H++){let{matched:$,currentIndex:J}=this.findMatchingDomain(H,L,G);if(!$)continue;let O=this.prefixSymbolStatus(H,G,3,R,["@"]),q=this.suffixSymbolStatus(J-1,G,3,_,[".",","]);if(!(O>2||q>2))continue;this.maskChars(H,J,G)}};static findMatchingDomain=(_,R,L)=>{let G=R.length,K=_,Q=0;while(K<L.length&&Q<G){let H=L[K],$=K+1<L.length?L[K+1]:"\x00",J=this.getEmulatedDomainCharLen($,String.fromCharCode(R[Q]),H);if(J>0)K+=J,Q++;else{if(Q===0)break;let O=this.getEmulatedDomainCharLen($,String.fromCharCode(R[Q-1]),H);if(O>0){if(K+=O,Q===1)_++}else{if(Q>=G||!this.isSymbol(H))break;K++}}}return{matched:Q>=G,currentIndex:K}};static filterBadCombinations=(_,R,L)=>{if(L.length>R.length)return;for(let G=0;G<=R.length-L.length;G++){let K=G,{currentIndex:Q,badIndex:H,hasSymbol:$,hasNumber:J,hasDigit:O}=this.processBadCharacters(R,L,K);K=Q;let q=R[K],b=K+1<R.length?R[K+1]:"\x00";if(!(H>=L.length&&(!J||!O)))continue;let U=!0,N;if($){let F=!1,T=!1;if(G-1<0||this.isSymbol(R[G-1])&&R[G-1]!=="'")F=!0;if(K>=R.length||this.isSymbol(R[K])&&R[K]!=="'")T=!0;if(!F||!T){let Y=!1;if(N=G-2,F)N=G;while(!Y&&N<K){if(N>=0&&(!this.isSymbol(R[N])||R[N]==="'")){let u=[],w;for(w=0;w<3&&N+w<R.length&&(!this.isSymbol(R[N+w])||R[N+w]==="'");w++)u[w]=R[N+w];let B=!0;if(w===0)B=!1;if(w<3&&N-1>=0&&(!this.isSymbol(R[N-1])||R[N-1]==="'"))B=!1;if(B&&!this.isBadFragment(u))Y=!0}N++}if(!Y)U=!1}}else{if(q=" ",G-1>=0)q=R[G-1];if(b=" ",K<R.length)b=R[K];let F=this.getIndex(q),T=this.getIndex(b);if(_&&this.comboMatches(F,_,T))U=!1}if(!U)continue;let I=0,k=0;for(let F=G;F<K;F++)if(this.isNumerical(R[F]))I++;else if(this.isAlpha(R[F]))k++;if(I<=k)this.maskChars(G,K,R)}};static processBadCharacters=(_,R,L)=>{let G=L,K=0,Q=0,H=!1,$=!1,J=!1;for(;G<_.length&&!($&&J);){if(G>=_.length||$&&J)break;let O=_[G],q=G+1<_.length?_[G+1]:"\x00",b;if(K<R.length&&(b=this.getEmulatedBadCharLen(q,String.fromCharCode(R[K]),O))>0){if(b===1&&this.isNumerical(O))$=!0;if(b===2&&(this.isNumerical(O)||this.isNumerical(q)))$=!0;G+=b,K++}else{if(K===0)break;let U;if((U=this.getEmulatedBadCharLen(q,String.fromCharCode(R[K-1]),O))>0)G+=U;else{if(K>=R.length||!this.isNotLowercaseAlpha(O))break;if(this.isSymbol(O)&&O!=="'")H=!0;if(this.isNumerical(O))J=!0;if(G++,Q++,(Q*100/(G-L)|0)>90)break}}}return{currentIndex:G,badIndex:K,hasSymbol:H,hasNumber:$,hasDigit:J}};static getEmulatedBadCharLen=(_,R,L)=>{if(R===L)return 1;if(R>="a"&&R<="m"){if(R==="a"){if(L!=="4"&&L!=="@"&&L!=="^"){if(L==="/"&&_==="\\")return 2;return 0}return 1}if(R==="b"){if(L!=="6"&&L!=="8"){if(L==="1"&&_==="3")return 2;return 0}return 1}if(R==="c"){if(L!=="("&&L!=="<"&&L!=="{"&&L!=="[")return 0;return 1}if(R==="d"){if(L==="["&&_===")")return 2;return 0}if(R==="e"){if(L!=="3"&&L!=="€")return 0;return 1}if(R==="f"){if(L==="p"&&_==="h")return 2;if(L==="£")return 1;return 0}if(R==="g"){if(L!=="9"&&L!=="6")return 0;return 1}if(R==="h"){if(L==="#")return 1;return 0}if(R==="i"){if(L!=="y"&&L!=="l"&&L!=="j"&&L!=="1"&&L!=="!"&&L!==":"&&L!==";"&&L!=="|")return 0;return 1}if(R==="j")return 0;if(R==="k")return 0;if(R==="l"){if(L!=="1"&&L!=="|"&&L!=="i")return 0;return 1}if(R==="m")return 0}if(R>="n"&&R<="z"){if(R==="n")return 0;if(R==="o"){if(L!=="0"&&L!=="*"){if((L!=="("||_!==")")&&(L!=="["||_!=="]")&&(L!=="{"||_!=="}")&&(L!=="<"||_!==">"))return 0;return 2}return 1}if(R==="p")return 0;if(R==="q")return 0;if(R==="r")return 0;if(R==="s"){if(L!=="5"&&L!=="z"&&L!=="$"&&L!=="2")return 0;return 1}if(R==="t"){if(L!=="7"&&L!=="+")return 0;return 1}if(R==="u"){if(L==="v")return 1;if((L!=="\\"||_!=="/")&&(L!=="\\"||_!=="|")&&(L!=="|"||_!=="/"))return 0;return 2}if(R==="v"){if((L!=="\\"||_!=="/")&&(L!=="\\"||_!=="|")&&(L!=="|"||_!=="/"))return 0;return 2}if(R==="w"){if(L==="v"&&_==="v")return 2;return 0}if(R==="x"){if((L!==")"||_!=="(")&&(L!=="}"||_!=="{")&&(L!=="]"||_!=="[")&&(L!==">"||_!=="<"))return 0;return 2}if(R==="y")return 0;if(R==="z")return 0}if(R>="0"&&R<="9")if(R==="0")if(L==="o"||L==="O")return 1;else if((L!=="("||_!==")")&&(L!=="{"||_!=="}")&&(L!=="["||_!=="]"))return 0;else return 2;else if(R==="1")return L==="l"?1:0;else return 0;else if(R===",")return L==="."?1:0;else if(R===".")return L===","?1:0;else if(R==="!")return L==="i"?1:0;return 0};static comboMatches=(_,R,L)=>{let G=0,K=R.length-1;while(G<=K){let Q=(G+K)/2|0;if(R[Q][0]===_&&R[Q][1]===L)return!0;else if(_<R[Q][0]||_===R[Q][0]&&L<R[Q][1])K=Q-1;else G=Q+1}return!1};static getIndex=(_)=>{if(this.isLowercaseAlpha(_))return _.charCodeAt(0)+1-97;else if(_==="'")return 28;else if(this.isNumerical(_))return _.charCodeAt(0)+29-48;return 27};static filterTld=(_,R,L,G,K)=>{if(G.length>L.length)return;for(let Q=0;Q<=L.length-G.length;Q++){let{currentIndex:H,tldIndex:$}=this.processTlds(L,G,Q);if($<G.length)continue;let J=!1,O=this.prefixSymbolStatus(Q,L,3,K,[",","."]),q=this.suffixSymbolStatus(H-1,L,5,_,["\\","/"]);if(R===1&&O>0&&q>0)J=!0;if(R===2&&(O>2&&q>0||O>0&&q>2))J=!0;if(R===3&&O>0&&q>2)J=!0;if(!J)continue;let b=Q,U=H-1,N=!1,I;if(O>2){if(O===4){N=!1;for(I=Q-1;I>=0;I--)if(N){if(K[I]!=="*")break;b=I}else if(K[I]==="*")b=I,N=!0}N=!1;for(I=b-1;I>=0;I--)if(N){if(this.isSymbol(L[I]))break;b=I}else if(!this.isSymbol(L[I]))N=!0,b=I}if(q>2){if(q===4){N=!1;for(I=U+1;I<L.length;I++)if(N){if(_[I]!=="*")break;U=I}else if(_[I]==="*")U=I,N=!0}N=!1;for(I=U+1;I<L.length;I++)if(N){if(this.isSymbol(L[I]))break;U=I}else if(!this.isSymbol(L[I]))N=!0,U=I}this.maskChars(b,U+1,L)}};static processTlds=(_,R,L)=>{let G=0;while(L<_.length&&G<R.length){let K=_[L],Q=L+1<_.length?_[L+1]:"\x00",H;if((H=this.getEmulatedDomainCharLen(Q,String.fromCharCode(R[G]),K))>0)L+=H,G++;else{if(G===0)break;let $;if(($=this.getEmulatedDomainCharLen(Q,String.fromCharCode(R[G-1]),K))>0)L+=$;else{if(!this.isSymbol(K))break;L++}}}return{currentIndex:L,tldIndex:G}};static isSymbol=(_)=>!this.isAlpha(_)&&!this.isNumerical(_);static isNotLowercaseAlpha=(_)=>this.isLowercaseAlpha(_)?_==="v"||_==="x"||_==="j"||_==="q"||_==="z":!0;static isAlpha=(_)=>this.isLowercaseAlpha(_)||this.isUppercaseAlpha(_);static isNumerical=(_)=>_>="0"&&_<="9";static isLowercaseAlpha=(_)=>_>="a"&&_<="z";static isUppercaseAlpha=(_)=>_>="A"&&_<="Z";static isNumericalChars=(_)=>{for(let R=0;R<_.length;R++)if(!this.isNumerical(_[R])&&_[R]!=="\x00")return!1;return!0};static maskChars=(_,R,L)=>{for(let G=_;G<R;G++)L[G]="*"};static maskedCountBackwards=(_,R)=>{let L=0;for(let G=R-1;G>=0&&this.isSymbol(_[G]);G--)if(_[G]==="*")L++;return L};static maskedCountForwards=(_,R)=>{let L=0;for(let G=R+1;G<_.length&&this.isSymbol(_[G]);G++)if(_[G]==="*")L++;return L};static maskedCharsStatus=(_,R,L,G,K)=>{if((K?this.maskedCountBackwards(R,L):this.maskedCountForwards(R,L))>=G)return 4;else if(this.isSymbol(K?_[L-1]:_[L+1]))return 1;return 0};static prefixSymbolStatus=(_,R,L,G,K)=>{if(_===0)return 2;for(let Q=_-1;Q>=0&&this.isSymbol(R[Q]);Q--)if(K.includes(R[Q]))return 3;return this.maskedCharsStatus(R,G,_,L,!0)};static suffixSymbolStatus=(_,R,L,G,K)=>{if(_+1===R.length)return 2;for(let Q=_+1;Q<R.length&&this.isSymbol(R[Q]);Q++)if(K.includes(R[Q]))return 3;return this.maskedCharsStatus(R,G,_,L,!1)};static format=(_)=>{let R=0;for(let L=0;L<_.length;L++){if(this.isCharacterAllowed(_[L]))_[R]=_[L];else _[R]=" ";if(R===0||_[R]!==" "||_[R-1]!==" ")R++}for(let L=R;L<_.length;L++)_[L]=" "};static isCharacterAllowed=(_)=>_>=" "&&_<=""||_===" "||_===`
`||_==="\t"||_==="£"||_==="€";static replaceUppercases=(_,R)=>{for(let L=0;L<R.length;L++)if(_[L]!=="*"&&this.isUppercaseAlpha(R[L]))_[L]=R[L]};static formatUppercases=(_)=>{let R=!0;for(let L=0;L<_.length;L++){let G=_[L];if(!this.isAlpha(G))R=!0;else if(R){if(this.isLowercaseAlpha(G))R=!1}else if(this.isUppercaseAlpha(G))_[L]=String.fromCharCode(G.charCodeAt(0)+97-65)}}}class m1{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack=(_,R)=>{let L=0,G=-1,K;for(let H=0;H<R&&L<100;H++){let $=_.g1;if(K=$>>4&15,G!==-1)this.charBuffer[L++]=this.TABLE[(G<<4)+K-195],G=-1;else if(K<13)this.charBuffer[L++]=this.TABLE[K];else G=K;if(K=$&15,G!==-1)this.charBuffer[L++]=this.TABLE[(G<<4)+K-195],G=-1;else if(K<13)this.charBuffer[L++]=this.TABLE[K];else G=K}let Q=!0;for(let H=0;H<L;H++){let $=this.charBuffer[H];if(Q&&$>="a"&&$<="z")this.charBuffer[H]=$.toUpperCase(),Q=!1;if($==="."||$==="!")Q=!0}return this.charBuffer.slice(0,L).join("")};static pack=(_,R)=>{if(R.length>80)R=R.substring(0,80);R=R.toLowerCase();let L=-1;for(let G=0;G<R.length;G++){let K=R.charAt(G),Q=0;for(let H=0;H<this.TABLE.length;H++)if(K===this.TABLE[H]){Q=H;break}if(Q>12)Q+=195;if(L===-1)if(Q<13)L=Q;else _.p1(Q);else if(Q<13)_.p1((L<<4)+Q),L=-1;else _.p1((L<<4)+(Q>>4)),L=Q&15}if(L!==-1)_.p1(L<<4)}}class O1{start=0;end=0;form=0;length=0;shapeDelta=null;shapePeak=null;threshold=0;position=0;delta=0;amplitude=0;ticks=0;read(_){this.form=_.g1,this.start=_.g4,this.end=_.g4,this.length=_.g1,this.shapeDelta=new Int32Array(this.length),this.shapePeak=new Int32Array(this.length);for(let R=0;R<this.length;R++)this.shapeDelta[R]=_.g2,this.shapePeak[R]=_.g2}reset(){this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0}evaluate(_){if(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta){if(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length)this.position=this.length-1;if(this.threshold=this.shapeDelta[this.position]/65536*_|0,this.threshold>this.ticks)this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0}return this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15}}class W0{static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);start=0;length=500;reverbVolume=100;reverbDelay=0;static init=()=>{this.noise=new Int32Array(32768);for(let _=0;_<32768;_++)if(Math.random()>0.5)this.noise[_]=1;else this.noise[_]=-1;this.sin=new Int32Array(32768);for(let _=0;_<32768;_++)this.sin[_]=Math.sin(_/5215.1903)*16384|0;this.buffer=new Int32Array(220500)};generate(_,R){for(let O=0;O<_;O++)W0.buffer[O]=0;if(R<10)return W0.buffer;let L=_/R|0;this.frequencyBase?.reset(),this.amplitudeBase?.reset();let G=0,K=0,Q=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),G=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/L|0,K=this.frequencyModRate.start*32.768/L|0;let H=0,$=0,J=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),H=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/L|0,$=this.amplitudeModRate.start*32.768/L|0;for(let O=0;O<5;O++)if(this.frequencyBase&&this.harmonicVolume[O]!==0)W0.tmpPhases[O]=0,W0.tmpDelays[O]=this.harmonicDelay[O]*L,W0.tmpVolumes[O]=(this.harmonicVolume[O]<<14)/100|0,W0.tmpSemitones[O]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[O])/L|0,W0.tmpStarts[O]=this.frequencyBase.start*32.768/L|0;if(this.frequencyBase&&this.amplitudeBase)for(let O=0;O<_;O++){let q=this.frequencyBase.evaluate(_),b=this.amplitudeBase.evaluate(_);if(this.frequencyModRate&&this.frequencyModRange){let U=this.frequencyModRate.evaluate(_),N=this.frequencyModRange.evaluate(_);q+=this.generate2(N,Q,this.frequencyModRate.form)>>1,Q+=(U*G>>16)+K}if(this.amplitudeModRate&&this.amplitudeModRange){let U=this.amplitudeModRate.evaluate(_),N=this.amplitudeModRange.evaluate(_);b=b*((this.generate2(N,J,this.amplitudeModRate.form)>>1)+32768)>>15,J+=(U*H>>16)+$}for(let U=0;U<5;U++)if(this.harmonicVolume[U]!==0){let N=O+W0.tmpDelays[U];if(N<_)W0.buffer[N]+=this.generate2(b*W0.tmpVolumes[U]>>15,W0.tmpPhases[U],this.frequencyBase.form),W0.tmpPhases[U]+=(q*W0.tmpSemitones[U]>>16)+W0.tmpStarts[U]}}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let O=0,q=!0;for(let b=0;b<_;b++){let U=this.release.evaluate(_),N=this.attack.evaluate(_),I;if(q)I=this.release.start+((this.release.end-this.release.start)*U>>8);else I=this.release.start+((this.release.end-this.release.start)*N>>8);if(O+=256,O>=I)O=0,q=!q;if(q)W0.buffer[b]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let O=this.reverbDelay*L;for(let q=O;q<_;q++)W0.buffer[q]+=W0.buffer[q-O]*this.reverbVolume/100|0,W0.buffer[q]|=0}for(let O=0;O<_;O++){if(W0.buffer[O]<-32768)W0.buffer[O]=-32768;if(W0.buffer[O]>32767)W0.buffer[O]=32767}return W0.buffer}generate2(_,R,L){if(L===1)return(R&32767)<16384?_:-_;else if(L===2)return W0.sin[R&32767]*_>>14;else if(L===3)return((R&32767)*_>>14)-_;else if(L===4)return W0.noise[(R/2607|0)&32767]*_;else return 0}read(_){if(this.frequencyBase=new O1,this.frequencyBase.read(_),this.amplitudeBase=new O1,this.amplitudeBase.read(_),_.g1!==0)_.pos--,this.frequencyModRate=new O1,this.frequencyModRate.read(_),this.frequencyModRange=new O1,this.frequencyModRange.read(_);if(_.g1!==0)_.pos--,this.amplitudeModRate=new O1,this.amplitudeModRate.read(_),this.amplitudeModRange=new O1,this.amplitudeModRange.read(_);if(_.g1!==0)_.pos--,this.release=new O1,this.release.read(_),this.attack=new O1,this.attack.read(_);for(let R=0;R<10;R++){let L=_.gsmarts;if(L===0)break;this.harmonicVolume[R]=L,this.harmonicSemitone[R]=_.gsmart,this.harmonicDelay[R]=_.gsmarts}this.reverbDelay=_.gsmarts,this.reverbVolume=_.gsmarts,this.length=_.g2,this.start=_.g2}}class Z0{static delays=new Int32Array(1000);static waveBytes=null;static waveBuffer=null;static tracks=new l(1000,null);tones=new l(10,null);loopBegin=0;loopEnd=0;static unpack=(_)=>{let R=new p(_.read("sounds.dat"));this.waveBytes=new Uint8Array(441000),this.waveBuffer=new p(this.waveBytes),W0.init();while(!0){let L=R.g2;if(L===65535)break;let G=new Z0;G.read(R),this.tracks[L]=G,this.delays[L]=G.trim()}};static generate=(_,R)=>{if(!this.tracks[_])return null;return this.tracks[_]?.getWave(R)??null};read(_){for(let R=0;R<10;R++)if(_.g1!==0)_.pos--,this.tones[R]=new W0,this.tones[R]?.read(_);this.loopBegin=_.g2,this.loopEnd=_.g2}trim(){let _=9999999;for(let R=0;R<10;R++)if(this.tones[R]&&(this.tones[R].start/20|0)<_)_=this.tones[R].start/20|0;if(this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<_)_=this.loopBegin/20|0;if(_===9999999||_===0)return 0;for(let R=0;R<10;R++)if(this.tones[R])this.tones[R].start-=_*20;if(this.loopBegin<this.loopEnd)this.loopBegin-=_*20,this.loopEnd-=_*20;return _}getWave(_){let R=this.generate(_);return Z0.waveBuffer.pos=0,Z0.waveBuffer?.p4(1380533830),Z0.waveBuffer?.ip4(R+36),Z0.waveBuffer?.p4(1463899717),Z0.waveBuffer?.p4(1718449184),Z0.waveBuffer?.ip4(16),Z0.waveBuffer?.ip2(1),Z0.waveBuffer?.ip2(1),Z0.waveBuffer?.ip4(22050),Z0.waveBuffer?.ip4(22050),Z0.waveBuffer?.ip2(1),Z0.waveBuffer?.ip2(8),Z0.waveBuffer?.p4(1684108385),Z0.waveBuffer?.ip4(R),Z0.waveBuffer.pos+=R,Z0.waveBuffer}generate(_){let R=0;for(let H=0;H<10;H++)if(this.tones[H]&&this.tones[H].length+this.tones[H].start>R)R=this.tones[H].length+this.tones[H].start;if(R===0)return 0;let L=R*22050/1000|0,G=this.loopBegin*22050/1000|0,K=this.loopEnd*22050/1000|0;if(G<0||K<0||K>L||G>=K)_=0;let Q=L+(K-G)*(_-1);for(let H=44;H<Q+44;H++)if(Z0.waveBytes)Z0.waveBytes[H]=-128;for(let H=0;H<10;H++)if(this.tones[H]){let $=this.tones[H].length*22050/1000|0,J=this.tones[H].start*22050/1000|0,O=this.tones[H].generate($,this.tones[H].length);for(let q=0;q<$;q++)if(Z0.waveBytes)Z0.waveBytes[q+J+44]+=O[q]>>8<<24>>24}if(_>1){G+=44,K+=44,L+=44,Q+=44;let H=Q-L;for(let $=L-1;$>=K;$--)if(Z0.waveBytes)Z0.waveBytes[$+H]=Z0.waveBytes[$];for(let $=1;$<_;$++){let J=(K-G)*$;for(let O=G;O<K;O++)if(Z0.waveBytes)Z0.waveBytes[O+J]=Z0.waveBytes[O]}Q-=44}return Q}}class d extends V8{static clientversion=225;static nodeId=10;static portOffset=0;static members=!0;static lowMemory=!1;static serverAddress="";static httpAddress="";static exponent=58778699976184461502525193738213253649000149147835990136706041084440742975821n;static modulus=7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789n;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;static setHighMemory=()=>{V.lowMemory=!1,h.lowMemory=!1,d.lowMemory=!1,H0.lowMemory=!1};static setLowMemory=()=>{V.lowMemory=!0,h.lowMemory=!0,d.lowMemory=!0,H0.lowMemory=!0};MAX_PLAYER_COUNT=2048;LOCAL_PLAYER_INDEX=2047;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;db=null;loopCycle=0;archiveChecksums=[];stream=null;in=p.alloc(1);out=p.alloc(1);loginout=p.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;packetType=0;packetSize=0;lastPacketType0=0;lastPacketType1=0;lastPacketType2=0;titleArchive=null;redrawTitleBackground=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBacktop2=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new l(13,null);imageMinimap=null;imageCompass=null;imageMapscene=new l(50,null);imageMapfunction=new l(50,null);imageHitmarks=new l(20,null);imageHeadicons=new l(20,null);imageMapflag=null;imageCrosses=new l(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new l(1000,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new g;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];publicChatSetting=0;privateChatSetting=0;tradeChatSetting=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialAction=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new l(100,null);messageSender=new l(100,null);messageType=new Int32Array(100);messageIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;mouseButtonsOption=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceID=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;cameraOffsetCycle=0;cameraAnticheatOffsetX=0;cameraAnticheatOffsetZ=0;cameraAnticheatAngle=0;cameraOffsetXModifier=2;cameraOffsetZModifier=2;cameraOffsetYawModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new l(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;minimapOffsetCycle=0;minimapAnticheatAngle=0;minimapZoom=0;minimapZoomModifier=1;minimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLocData=null;sceneMapIndex=null;mapLastBaseX=0;mapLastBaseZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new l(s.LEVELS,null);currentLevel=0;cameraMovedWrite=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new J1(s.SIZE,s.SIZE);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new l(this.MAX_PLAYER_COUNT,null);playerCount=0;playerIds=new Int32Array(this.MAX_PLAYER_COUNT);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(this.MAX_PLAYER_COUNT);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new l(this.MAX_PLAYER_COUNT,null);npcs=new l(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new g0;spotanims=new g0;locList=new g0;temporaryLocs=new g0;levelObjStacks=new e1(s.LEVELS,s.SIZE,s.SIZE,null);spawnedLocations=new g0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(s.SIZE*s.SIZE);bfsCost=new Int32Array(s.SIZE*s.SIZE);tryMoveNearest=0;localPlayer=null;energy=0;inMultizone=0;localPid=-1;weightCarried=0;heartbeatTimer=0;wildernessLevel=0;worldLocationState=0;rights=!1;designGenderMale=!0;updateDesignModel=!1;designIdentikits=new Int32Array(7);designColors=new Int32Array(5);friendCount=0;chatCount=0;static MAX_CHATS=50;chatX=new Int32Array(d.MAX_CHATS);chatY=new Int32Array(d.MAX_CHATS);chatHeight=new Int32Array(d.MAX_CHATS);chatWidth=new Int32Array(d.MAX_CHATS);chatColors=new Int32Array(d.MAX_CHATS);chatStyles=new Int32Array(d.MAX_CHATS);chatTimers=new Int32Array(d.MAX_CHATS);chats=new l(d.MAX_CHATS,null);friendName=new l(100,null);friendName37=new BigInt64Array(100);friendWorld=new Int32Array(100);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=192;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;currentMidi=null;midiCrc=0;midiSize=0;midiVolume=192;userTileMarkers=new l(16,null);userTileMarkerIndex=0;lastTickFlag=!1;constructor(_,R,L,G){super();if(typeof _!=="undefined"){d.nodeId=_;let K=new URL(window.location.href);d.serverAddress=`${K.protocol}//${K.hostname}`,d.httpAddress=`${K.protocol}//${K.hostname}:${K.port}`}if(typeof R!=="undefined")d.portOffset=R;if(typeof G!=="undefined")d.members=G;if(typeof L!=="undefined")if(L)d.setLowMemory();else d.setHighMemory();this.run()}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}unloadTitle=()=>{if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null};loadArchive=async(_,R,L,G)=>{let K=5,Q=await this.db?.cacheload(_);if(Q&&p.crc32(Q)!==L)Q=void 0;if(Q)return new g1(Q);while(!Q){await this.showProgress(G,`Requesting ${R}`);try{Q=await T8(`${d.httpAddress}/${_}${L}`)}catch(H){Q=void 0;for(let $=K;$>0;$--)await this.showProgress(G,`Error loading - Will retry in ${$} secs.`),await q1(1000);if(K*=2,K>60)K=60}}return await this.db?.cachesave(_,Q),new g1(Q)};setMidi=async(_,R,L,G)=>{let K=await this.db?.cacheload(_+".mid");if(K&&R!==12345678&&p.crc32(K)!==R)K=void 0;if(!K)try{if(K=await T8(`${d.httpAddress}/${_}_${R}.mid`),L!==K.length)K=K.slice(0,L)}catch(Q){}if(!K)return;try{await this.db?.cachesave(_+".mid",K);let Q=new p(Uint8Array.from(K)).g4,H=B1.decompress(K,Q,!0,!0);k6(H,this.midiVolume,G)}catch(Q){}};drawError=()=>{if(q0.fillStyle="black",q0.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.errorLoading){this.flameActive=!1,q0.font="bold 16px helvetica, sans-serif",q0.textAlign="left",q0.fillStyle="yellow";let _=35;q0.fillText("Sorry, an error has occured whilst loading RuneScape",30,_),_+=50,q0.fillStyle="white",q0.fillText("To fix this try the following (in order):",30,_),_+=50,q0.font="bold 12px helvetica, sans-serif",q0.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,q0.fillText("2: Try clearing your web-browsers cache from tools->internet options",30,_),_+=30,q0.fillText("3: Try using a different game-world",30,_),_+=30,q0.fillText("4: Try rebooting your computer",30,_),_+=30,q0.fillText("5: Try selecting a different version of Java from the play-game menu",30,_)}if(this.errorHost)this.flameActive=!1,q0.font="bold 20px helvetica, sans-serif",q0.textAlign="left",q0.fillStyle="white",q0.fillText("Error - unable to load game!",50,50),q0.fillText("To play RuneScape make sure you play from",50,100),q0.fillText("https://2004scape.org",50,150);if(this.errorStarted){this.flameActive=!1,q0.font="bold 13px helvetica, sans-serif",q0.textAlign="left",q0.fillStyle="yellow";let _=35;q0.fillText("Error a copy of RuneScape already appears to be loaded",30,_),_+=50,q0.fillStyle="white",q0.fillText("To fix this try the following (in order):",30,_),_+=50,q0.font="bold 12px helvetica, sans-serif",q0.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,q0.fillText("2: Try rebooting your computer, and reloading",30,_)}};executeInterfaceScript=(_)=>{if(!_.scriptComparator)return!1;for(let R=0;R<_.scriptComparator.length;R++){let L=this.executeClientscript1(_,R);if(!_.scriptOperand)return!1;let G=_.scriptOperand[R];if(_.scriptComparator[R]===2){if(L>=G)return!1}else if(_.scriptComparator[R]===3){if(L<=G)return!1}else if(_.scriptComparator[R]===4){if(L===G)return!1}else if(L!==G)return!1}return!0};drawScrollbar=(_,R,L,G,K)=>{this.imageScrollbar0?.draw(_,R),this.imageScrollbar1?.draw(_,R+K-16),j.fillRect(_,R+16,16,K-32,X.SCROLLBAR_TRACK);let Q=(K-32)*K/G|0;if(Q<8)Q=8;let H=(K-Q-32)*L/(G-K)|0;j.fillRect(_,R+H+16,16,Q,X.SCROLLBAR_GRIP_FOREGROUND),j.drawVerticalLine(_,R+H+16,X.SCROLLBAR_GRIP_HIGHLIGHT,Q),j.drawVerticalLine(_+1,R+H+16,X.SCROLLBAR_GRIP_HIGHLIGHT,Q),j.drawHorizontalLine(_,R+H+16,X.SCROLLBAR_GRIP_HIGHLIGHT,16),j.drawHorizontalLine(_,R+H+17,X.SCROLLBAR_GRIP_HIGHLIGHT,16),j.drawVerticalLine(_+15,R+H+16,X.SCROLLBAR_GRIP_LOWLIGHT,Q),j.drawVerticalLine(_+14,R+H+17,X.SCROLLBAR_GRIP_LOWLIGHT,Q-1),j.drawHorizontalLine(_,R+H+Q+15,X.SCROLLBAR_GRIP_LOWLIGHT,16),j.drawHorizontalLine(_+1,R+H+Q+14,X.SCROLLBAR_GRIP_LOWLIGHT,15)};updateInterfaceAnimation=(_,R)=>{let L=!1,G=g.instances[_];if(!G.childId)return!1;for(let K=0;K<G.childId.length&&G.childId[K]!==-1;K++){let Q=g.instances[G.childId[K]];if(Q.type===1)L||=this.updateInterfaceAnimation(Q.id,R);if(Q.type===6&&(Q.anim!==-1||Q.activeAnim!==-1)){let H=this.executeInterfaceScript(Q),$;if(H)$=Q.activeAnim;else $=Q.anim;if($!==-1){let J=_0.instances[$];if(Q.seqCycle+=R,J.delay)while(Q.seqCycle>J.delay[Q.seqFrame]){if(Q.seqCycle-=J.delay[Q.seqFrame]+1,Q.seqFrame++,Q.seqFrame>=J.frameCount){if(Q.seqFrame-=J.replayoff,Q.seqFrame<0||Q.seqFrame>=J.frameCount)Q.seqFrame=0}L=!0}}}}return L};drawInterface=(_,R,L,G,K=!1)=>{if(_.type!==0||!_.childId||_.hide&&this.viewportHoveredInterfaceIndex!==_.id&&this.sidebarHoveredInterfaceIndex!==_.id&&this.chatHoveredInterfaceIndex!==_.id)return;let Q=j.left,H=j.top,$=j.right,J=j.bottom;j.setBounds(R,L,R+_.width,L+_.height);let O=_.childId.length;for(let q=0;q<O;q++){if(!_.childX||!_.childY)continue;let b=_.childX[q]+R,U=_.childY[q]+L-G,N=g.instances[_.childId[q]];if(b+=N.x,U+=N.y,K)j.drawRect(b,U,N.width,N.height,X.WHITE);if(N.clientCode>0)this.updateInterfaceContent(N);if(N.type===g.TYPE_LAYER){if(N.scrollPosition>N.scroll-N.height)N.scrollPosition=N.scroll-N.height;if(N.scrollPosition<0)N.scrollPosition=0;if(this.drawInterface(N,b,U,N.scrollPosition,K),N.scroll>N.height)this.drawScrollbar(b+N.width,U,N.scrollPosition,N.scroll,N.height)}else if(N.type===g.TYPE_INV){let I=0;for(let k=0;k<N.height;k++)for(let F=0;F<N.width;F++){if(!N.invSlotOffsetX||!N.invSlotOffsetY||!N.invSlotObjId||!N.invSlotObjCount)continue;let T=b+F*(N.marginX+32),Y=U+k*(N.marginY+32);if(I<20)T+=N.invSlotOffsetX[I],Y+=N.invSlotOffsetY[I];if(N.invSlotObjId[I]>0){let u=0,w=0,B=N.invSlotObjId[I]-1;if(T>=-32&&T<=512&&Y>=-32&&Y<=334||this.objDragArea!==0&&this.objDragSlot===I){let v=Y0.getIcon(B,N.invSlotObjCount[I]);if(this.objDragArea!==0&&this.objDragSlot===I&&this.objDragInterfaceId===N.id){if(u=this.mouseX-this.objGrabX,w=this.mouseY-this.objGrabY,u<5&&u>-5)u=0;if(w<5&&w>-5)w=0;if(this.objDragCycles<5)u=0,w=0;v.drawAlpha(128,T+u,Y+w)}else if(this.selectedArea!==0&&this.selectedItem===I&&this.selectedInterface===N.id)v.drawAlpha(128,T,Y);else v.draw(T,Y);if(v.cropW===33||N.invSlotObjCount[I]!==1){let n=N.invSlotObjCount[I];this.fontPlain11?.drawString(T+u+1,Y+10+w,this.formatObjCount(n),X.BLACK),this.fontPlain11?.drawString(T+u,Y+9+w,this.formatObjCount(n),X.YELLOW)}}}else if(N.invSlotSprite&&I<20)N.invSlotSprite[I]?.draw(T,Y);I++}}else if(N.type===g.TYPE_RECT)if(N.fill)j.fillRect(b,U,N.width,N.height,N.colour);else j.drawRect(b,U,N.width,N.height,N.colour);else if(N.type===g.TYPE_TEXT){let{font:I,colour:k,text:F}=N;if((this.chatHoveredInterfaceIndex===N.id||this.sidebarHoveredInterfaceIndex===N.id||this.viewportHoveredInterfaceIndex===N.id)&&N.overColour!==0)k=N.overColour;if(this.executeInterfaceScript(N)){if(k=N.activeColour,N.activeText&&N.activeText.length>0)F=N.activeText}if(N.buttonType===g.BUTTON_CONTINUE&&this.pressedContinueOption)F="Please wait...",k=N.colour;if(!I||!F)continue;for(let T=U+I.height;F.length>0;T+=I.height){if(F.indexOf("%")!==-1){do{let w=F.indexOf("%1");if(w===-1)break;F=F.substring(0,w)+this.getIntString(this.executeClientscript1(N,0))+F.substring(w+2)}while(!0);do{let w=F.indexOf("%2");if(w===-1)break;F=F.substring(0,w)+this.getIntString(this.executeClientscript1(N,1))+F.substring(w+2)}while(!0);do{let w=F.indexOf("%3");if(w===-1)break;F=F.substring(0,w)+this.getIntString(this.executeClientscript1(N,2))+F.substring(w+2)}while(!0);do{let w=F.indexOf("%4");if(w===-1)break;F=F.substring(0,w)+this.getIntString(this.executeClientscript1(N,3))+F.substring(w+2)}while(!0);do{let w=F.indexOf("%5");if(w===-1)break;F=F.substring(0,w)+this.getIntString(this.executeClientscript1(N,4))+F.substring(w+2)}while(!0)}let Y=F.indexOf("\\n"),u;if(Y!==-1)u=F.substring(0,Y),F=F.substring(Y+2);else u=F,F="";if(N.center)I.drawStringTaggableCenter(b+(N.width/2|0),T,u,k,N.shadowed);else I.drawStringTaggable(b,T,u,k,N.shadowed)}}else if(N.type===g.TYPE_GRAPHIC){let I;if(this.executeInterfaceScript(N))I=N.activeGraphic;else I=N.graphic;I?.draw(b,U)}else if(N.type===g.TYPE_MODEL){let I=h.centerX,k=h.centerY;h.centerX=b+(N.width/2|0),h.centerY=U+(N.height/2|0);let F=h.sin[N.xan]*N.zoom>>16,T=h.cos[N.xan]*N.zoom>>16,Y=this.executeInterfaceScript(N),u;if(Y)u=N.activeAnim;else u=N.anim;let w=null;if(u===-1)w=N.getModel(-1,-1,Y);else{let B=_0.instances[u];if(B.frames&&B.iframes)w=N.getModel(B.frames[N.seqFrame],B.iframes[N.seqFrame],Y)}if(w)w.drawSimple(0,N.yan,0,N.xan,0,F,T);h.centerX=I,h.centerY=k}else if(N.type===g.TYPE_INV_TEXT){let I=N.font;if(!I||!N.invSlotObjId||!N.invSlotObjCount)continue;let k=0;for(let F=0;F<N.height;F++)for(let T=0;T<N.width;T++){if(N.invSlotObjId[k]>0){let Y=Y0.get(N.invSlotObjId[k]-1),u=Y.name;if(Y.stackable||N.invSlotObjCount[k]!==1)u=u+" x"+this.formatObjCountTagged(N.invSlotObjCount[k]);if(!u)continue;let w=b+T*(N.marginX+115),B=U+F*(N.marginY+12);if(N.center)I.drawStringTaggableCenter(w+(N.width/2|0),B,u,N.colour,N.shadowed);else I.drawStringTaggable(w,B,u,N.colour,N.shadowed)}k++}}}j.setBounds(Q,H,$,J)};updateInterfaceContent=(_)=>{let R=_.clientCode;if(R>=g.CC_FRIENDS_START&&R<=g.CC_FRIENDS_END)if(R--,R>=this.friendCount)_.text="",_.buttonType=0;else _.text=this.friendName[R],_.buttonType=1;else if(R>=g.CC_FRIENDS_UPDATE_START&&R<=g.CC_FRIENDS_UPDATE_END)if(R-=g.CC_FRIENDS_UPDATE_START,R>=this.friendCount)_.text="",_.buttonType=0;else{if(this.friendWorld[R]===0)_.text="@red@Offline";else if(this.friendWorld[R]===d.nodeId)_.text="@gre@World-"+(this.friendWorld[R]-9);else _.text="@yel@World-"+(this.friendWorld[R]-9);_.buttonType=1}else if(R===g.CC_FRIENDS_SIZE){if(_.scroll=this.friendCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(R>=g.CC_IGNORES_START&&R<=g.CC_IGNORES_END)if(R-=g.CC_IGNORES_START,R>=this.ignoreCount)_.text="",_.buttonType=0;else _.text=I0.formatName(I0.fromBase37(this.ignoreName37[R])),_.buttonType=1;else if(R===g.CC_IGNORES_SIZE){if(_.scroll=this.ignoreCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(R===g.CC_DESIGN_PREVIEW){if(_.xan=150,_.yan=(Math.sin(this.loopCycle/40)*256|0)&2047,this.updateDesignModel){this.updateDesignModel=!1;let L=new l(7,null),G=0;for(let Q=0;Q<7;Q++){let H=this.designIdentikits[Q];if(H>=0)L[G++]=i0.instances[H].getModel()}let K=E.modelFromModels(L,G);for(let Q=0;Q<5;Q++)if(this.designColors[Q]!==0){if(K.recolor(U0.DESIGN_IDK_COLORS[Q][0],U0.DESIGN_IDK_COLORS[Q][this.designColors[Q]]),Q===1)K.recolor(U0.TORSO_RECOLORS[0],U0.TORSO_RECOLORS[this.designColors[Q]])}if(this.localPlayer){let Q=_0.instances[this.localPlayer.seqStandId].frames;if(Q)K.createLabelReferences(),K.applyTransform(Q[0]),K.calculateNormals(64,850,-30,-50,-30,!0),_.model=K}}}else if(R===g.CC_SWITCH_TO_MALE){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGenderMale)_.graphic=this.genderButtonImage1;else _.graphic=this.genderButtonImage0}else if(R===g.CC_SWITCH_TO_FEMALE){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGenderMale)_.graphic=this.genderButtonImage0;else _.graphic=this.genderButtonImage1}else if(R===g.CC_REPORT_INPUT)if(_.text=this.reportAbuseInput,this.loopCycle%20<10)_.text=_.text+"|";else _.text=_.text+" ";else if(R===g.CC_MOD_MUTE)if(!this.rights)_.text="";else if(this.reportAbuseMuteOption)_.colour=X.RED,_.text="Moderator option: Mute player for 48 hours: <ON>";else _.colour=X.WHITE,_.text="Moderator option: Mute player for 48 hours: <OFF>";else if(R===g.CC_LAST_LOGIN_INFO||R===g.CC_LAST_LOGIN_INFO2)if(this.lastAddress===0)_.text="";else{let L;if(this.daysSinceLastLogin===0)L="earlier today";else if(this.daysSinceLastLogin===1)L="yesterday";else L=this.daysSinceLastLogin+" days ago";_.text="You last logged in "+L+" from: "+I0.formatIPv4(this.lastAddress)}else if(R===g.CC_UNREAD_MESSAGES){if(this.unreadMessages===0)_.text="0 unread messages",_.colour=X.YELLOW;if(this.unreadMessages===1)_.text="1 unread message",_.colour=X.GREEN;if(this.unreadMessages>1)_.text=this.unreadMessages+" unread messages",_.colour=X.GREEN}else if(R===g.CC_RECOVERY1)if(this.daysSinceRecoveriesChanged===201)_.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="You have not yet set any password recovery questions.";else{let L;if(this.daysSinceRecoveriesChanged===0)L="Earlier today";else if(this.daysSinceRecoveriesChanged===1)L="Yesterday";else L=this.daysSinceRecoveriesChanged+" days ago";_.text=L+" you changed your recovery questions"}else if(R===g.CC_RECOVERY2)if(this.daysSinceRecoveriesChanged===201)_.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="We strongly recommend you do so now to secure your account.";else _.text="If you do not remember making this change then cancel it immediately";else if(R===g.CC_RECOVERY3)if(this.daysSinceRecoveriesChanged===201)_.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="Do this from the 'account management' area on our front webpage";else _.text="Do this from the 'account management' area on our front webpage"};executeClientscript1=(_,R)=>{if(!_.scripts||R>=_.scripts.length)return-2;try{let L=_.scripts[R];if(!L)return-1;let G=0,K=0;while(!0){let Q=L[K++];if(Q===0)return G;if(Q===1)G+=this.skillLevel[L[K++]];else if(Q===2)G+=this.skillBaseLevel[L[K++]];else if(Q===3)G+=this.skillExperience[L[K++]];else if(Q===4){let H=g.instances[L[K++]],$=L[K++]+1;if(H.invSlotObjId&&H.invSlotObjCount){for(let J=0;J<H.invSlotObjId.length;J++)if(H.invSlotObjId[J]===$)G+=H.invSlotObjCount[J]}else G+=0}else if(Q===5)G+=this.varps[L[K++]];else if(Q===6)G+=this.levelExperience[this.skillBaseLevel[L[K++]]-1];else if(Q===7)G+=this.varps[L[K++]]*100/46875|0;else if(Q===8)G+=this.localPlayer?.combatLevel||0;else if(Q===9)for(let H=0;H<19;H++){if(H===18)H=20;G+=this.skillBaseLevel[H]}else if(Q===10){let H=g.instances[L[K++]],$=L[K++]+1;for(let J=0;J<H.invSlotObjId.length;J++)if(H.invSlotObjId[J]===$){G+=999999999;break}}else if(Q===11)G+=this.energy;else if(Q===12)G+=this.weightCarried;else if(Q===13){let H=this.varps[L[K++]],$=L[K++];G+=(H&1<<$)===0?0:1}}}catch(L){return-1}};getIntString=(_)=>{return _<999999999?String(_):"*"};formatObjCountTagged=(_)=>{let R=String(_);for(let L=R.length-3;L>0;L-=3)R=R.substring(0,L)+","+R.substring(L);if(R.length>8)R="@gre@"+R.substring(0,R.length-8)+" million @whi@("+R+")";else if(R.length>4)R="@cya@"+R.substring(0,R.length-4)+"K @whi@("+R+")";return" "+R};formatObjCount=(_)=>{if(_<1e5)return String(_);else if(_<1e7)return(_/1000|0)+"K";else return(_/1e6|0)+"M"};async load(){if(this.isMobile&&d.lowMemory)this.tfps=30;if(this.alreadyStarted){this.errorStarted=!0;return}this.alreadyStarted=!0;try{await this.showProgress(10,"Connecting to fileserver"),this.db=new H8(await H8.openDatabase());let _=new p(new Uint8Array(await T8(`${d.httpAddress}/crc`)));for(let W=0;W<9;W++)this.archiveChecksums[W]=_.g4;if(!d.lowMemory)await this.setMidi("scape_main",12345678,40000,!1);let R=await this.loadArchive("title","title screen",this.archiveChecksums[1],10);this.titleArchive=R,this.fontPlain11=y0.fromArchive(R,"p11"),this.fontPlain12=y0.fromArchive(R,"p12"),this.fontBold12=y0.fromArchive(R,"b12"),this.fontQuill8=y0.fromArchive(R,"q8"),await this.loadTitleBackground(),this.loadTitleImages();let L=await this.loadArchive("config","config",this.archiveChecksums[2],15),G=await this.loadArchive("interface","interface",this.archiveChecksums[3],20),K=await this.loadArchive("media","2d graphics",this.archiveChecksums[4],30),Q=await this.loadArchive("models","3d graphics",this.archiveChecksums[5],40),H=await this.loadArchive("textures","textures",this.archiveChecksums[6],60),$=await this.loadArchive("wordenc","chat system",this.archiveChecksums[7],65),J=await this.loadArchive("sounds","sound effects",this.archiveChecksums[8],70);if(this.levelTileFlags=new I1(s.LEVELS,s.SIZE,s.SIZE),this.levelHeightmap=new W1(s.LEVELS,s.SIZE+1,s.SIZE+1),this.levelHeightmap)this.scene=new V(this.levelHeightmap,s.SIZE,s.LEVELS,s.SIZE);for(let W=0;W<s.LEVELS;W++)this.levelCollisionMap[W]=new s;this.imageMinimap=new V0(512,512),await this.showProgress(75,"Unpacking media"),this.imageInvback=h0.fromArchive(K,"invback",0),this.imageChatback=h0.fromArchive(K,"chatback",0),this.imageMapback=h0.fromArchive(K,"mapback",0),this.imageBackbase1=h0.fromArchive(K,"backbase1",0),this.imageBackbase2=h0.fromArchive(K,"backbase2",0),this.imageBackhmid1=h0.fromArchive(K,"backhmid1",0);for(let W=0;W<13;W++)this.imageSideicons[W]=h0.fromArchive(K,"sideicons",W);this.imageCompass=V0.fromArchive(K,"compass",0);try{for(let W=0;W<50;W++){if(W===22)continue;this.imageMapscene[W]=h0.fromArchive(K,"mapscene",W)}}catch(W){}try{for(let W=0;W<50;W++)this.imageMapfunction[W]=V0.fromArchive(K,"mapfunction",W)}catch(W){}try{for(let W=0;W<20;W++)this.imageHitmarks[W]=V0.fromArchive(K,"hitmarks",W)}catch(W){}try{for(let W=0;W<20;W++)this.imageHeadicons[W]=V0.fromArchive(K,"headicons",W)}catch(W){}this.imageMapflag=V0.fromArchive(K,"mapflag",0);for(let W=0;W<8;W++)this.imageCrosses[W]=V0.fromArchive(K,"cross",W);this.imageMapdot0=V0.fromArchive(K,"mapdots",0),this.imageMapdot1=V0.fromArchive(K,"mapdots",1),this.imageMapdot2=V0.fromArchive(K,"mapdots",2),this.imageMapdot3=V0.fromArchive(K,"mapdots",3),this.imageScrollbar0=h0.fromArchive(K,"scrollbar",0),this.imageScrollbar1=h0.fromArchive(K,"scrollbar",1),this.imageRedstone1=h0.fromArchive(K,"redstone1",0),this.imageRedstone2=h0.fromArchive(K,"redstone2",0),this.imageRedstone3=h0.fromArchive(K,"redstone3",0),this.imageRedstone1h=h0.fromArchive(K,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=h0.fromArchive(K,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=h0.fromArchive(K,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=h0.fromArchive(K,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=h0.fromArchive(K,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=h0.fromArchive(K,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=h0.fromArchive(K,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();let O=V0.fromArchive(K,"backleft1",0);this.areaBackleft1=new w0(O.width,O.height),O.blitOpaque(0,0);let q=V0.fromArchive(K,"backleft2",0);this.areaBackleft2=new w0(q.width,q.height),q.blitOpaque(0,0);let b=V0.fromArchive(K,"backright1",0);this.areaBackright1=new w0(b.width,b.height),b.blitOpaque(0,0);let U=V0.fromArchive(K,"backright2",0);this.areaBackright2=new w0(U.width,U.height),U.blitOpaque(0,0);let N=V0.fromArchive(K,"backtop1",0);this.areaBacktop1=new w0(N.width,N.height),N.blitOpaque(0,0);let I=V0.fromArchive(K,"backtop2",0);this.areaBacktop2=new w0(I.width,I.height),I.blitOpaque(0,0);let k=V0.fromArchive(K,"backvmid1",0);this.areaBackvmid1=new w0(k.width,k.height),k.blitOpaque(0,0);let F=V0.fromArchive(K,"backvmid2",0);this.areaBackvmid2=new w0(F.width,F.height),F.blitOpaque(0,0);let T=V0.fromArchive(K,"backvmid3",0);this.areaBackvmid3=new w0(T.width,T.height),T.blitOpaque(0,0);let Y=V0.fromArchive(K,"backhmid2",0);this.areaBackhmid2=new w0(Y.width,Y.height),Y.blitOpaque(0,0);let u=(Math.random()*21|0)-10,w=(Math.random()*21|0)-10,B=(Math.random()*21|0)-10,v=(Math.random()*41|0)-20;for(let W=0;W<50;W++){if(this.imageMapfunction[W])this.imageMapfunction[W]?.translate(u+v,w+v,B+v);if(this.imageMapscene[W])this.imageMapscene[W]?.translate(u+v,w+v,B+v)}if(await this.showProgress(80,"Unpacking textures"),h.unpackTextures(H),h.setBrightness(0.8),h.initPool(20),await this.showProgress(83,"Unpacking models"),E.unpack(Q),h1.unpack(Q),G1.unpack(Q),await this.showProgress(86,"Unpacking config"),_0.unpack(L),B0.unpack(L),A0.unpack(L),Y0.unpack(L,d.members),_1.unpack(L),i0.unpack(L),p0.unpack(L),F1.unpack(L),!d.lowMemory)await this.showProgress(90,"Unpacking sounds"),Z0.unpack(J);await this.showProgress(92,"Unpacking interfaces"),g.unpack(G,K,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.showProgress(97,"Preparing game engine");for(let W=0;W<33;W++){let P=999,z=0;for(let f=0;f<35;f++)if(this.imageMapback.pixels[f+W*this.imageMapback.width]===0){if(P===999)P=f}else if(P!==999){z=f;break}this.compassMaskLineOffsets[W]=P,this.compassMaskLineLengths[W]=z-P}for(let W=9;W<160;W++){let P=999,z=0;for(let f=10;f<168;f++)if(this.imageMapback.pixels[f+W*this.imageMapback.width]===0&&(f>34||W>34)){if(P===999)P=f}else if(P!==999){z=f;break}this.minimapMaskLineOffsets[W-9]=P-21,this.minimapMaskLineLengths[W-9]=z-P}h.init3D(479,96),this.areaChatbackOffsets=h.lineOffset,h.init3D(190,261),this.areaSidebarOffsets=h.lineOffset,h.init3D(512,334),this.areaViewportOffsets=h.lineOffset;let n=new Int32Array(9);for(let W=0;W<9;W++){let P=W*32+128+15,z=P*3+600,f=h.sin[P];n[W]=z*f>>16}V.init(512,334,500,800,n),j1.unpack($),this.initializeLevelExperience()}catch(_){this.errorLoading=!0}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitleScreen()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.ingame)this.drawGame();else await this.drawTitleScreen();this.dragCycles=0}async refresh(){this.redrawTitleBackground=!0}showProgress=async(_,R)=>{if(await this.loadTitle(),!this.titleArchive){await super.showProgress(_,R);return}this.imageTitle4?.bind();let L=360,G=200,K=20;this.fontBold12?.drawStringCenter(L/2|0,(G/2|0)-K-26,"RuneScape is loading - please wait...",X.WHITE);let Q=(G/2|0)-18-K;if(j.drawRect((L/2|0)-152,Q,304,34,X.PROGRESS_RED),j.drawRect((L/2|0)-151,Q+1,302,32,X.BLACK),j.fillRect((L/2|0)-150,Q+2,_*3,30,X.PROGRESS_RED),j.fillRect((L/2|0)-150+_*3,Q+2,300-_*3,30,X.BLACK),this.fontBold12?.drawStringCenter(L/2|0,(G/2|0)+5-K,R,X.WHITE),this.imageTitle4?.draw(214,186),this.redrawTitleBackground){if(this.redrawTitleBackground=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(661,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)}await q1(5)};runFlames=()=>{if(!this.flameActive)return;this.updateFlames(),this.updateFlames(),this.drawFlames()};loadTitle=async()=>{if(!this.imageTitle2){if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new w0(128,265),j.clear(),this.imageTitle1=new w0(128,265),j.clear(),this.imageTitle2=new w0(533,186),j.clear(),this.imageTitle3=new w0(360,146),j.clear(),this.imageTitle4=new w0(360,200),j.clear(),this.imageTitle5=new w0(214,267),j.clear(),this.imageTitle6=new w0(215,267),j.clear(),this.imageTitle7=new w0(86,79),j.clear(),this.imageTitle8=new w0(87,79),j.clear(),this.titleArchive)await this.loadTitleBackground(),this.loadTitleImages();this.redrawTitleBackground=!0}};loadTitleBackground=async()=>{if(!this.titleArchive)return;let _=await V0.fromJpeg(this.titleArchive,"title");this.imageTitle0?.bind(),_.blitOpaque(0,0),this.imageTitle1?.bind(),_.blitOpaque(-661,0),this.imageTitle2?.bind(),_.blitOpaque(-128,0),this.imageTitle3?.bind(),_.blitOpaque(-214,-386),this.imageTitle4?.bind(),_.blitOpaque(-214,-186),this.imageTitle5?.bind(),_.blitOpaque(0,-265),this.imageTitle6?.bind(),_.blitOpaque(-128,-186),this.imageTitle7?.bind(),_.blitOpaque(-128,-186),this.imageTitle8?.bind(),_.blitOpaque(-574,-186),_.flipHorizontally(),this.imageTitle0?.bind(),_.blitOpaque(394,0),this.imageTitle1?.bind(),_.blitOpaque(-267,0),this.imageTitle2?.bind(),_.blitOpaque(266,0),this.imageTitle3?.bind(),_.blitOpaque(180,-386),this.imageTitle4?.bind(),_.blitOpaque(180,-186),this.imageTitle5?.bind(),_.blitOpaque(394,-265),this.imageTitle6?.bind(),_.blitOpaque(-180,-265),this.imageTitle7?.bind(),_.blitOpaque(212,-186),this.imageTitle8?.bind(),_.blitOpaque(-180,-186);let R=V0.fromArchive(this.titleArchive,"logo");this.imageTitle2?.bind(),R.draw((this.width/2|0)-(R.width/2|0)-128,18)};updateFlameBuffer=(_)=>{if(!this.flameBuffer0||!this.flameBuffer1)return;let R=256;this.flameBuffer0.fill(0);for(let L=0;L<5000;L++){let G=Math.random()*128*R|0;this.flameBuffer0[G]=Math.random()*256|0}for(let L=0;L<20;L++){for(let K=1;K<R-1;K++)for(let Q=1;Q<127;Q++){let H=Q+(K<<7);this.flameBuffer1[H]=(this.flameBuffer0[H-1]+this.flameBuffer0[H+1]+this.flameBuffer0[H-128]+this.flameBuffer0[H+128])/4|0}let G=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=G}if(_){let L=0;for(let G=0;G<_.height;G++)for(let K=0;K<_.width;K++)if(_.pixels[L++]!==0){let Q=K+_.cropX+16,H=G+_.cropY+16,$=Q+(H<<7);this.flameBuffer0[$]=0}}};loadTitleImages=()=>{if(!this.titleArchive)return;this.imageTitlebox=h0.fromArchive(this.titleArchive,"titlebox"),this.imageTitlebutton=h0.fromArchive(this.titleArchive,"titlebutton");for(let _=0;_<12;_++)this.imageRunes[_]=h0.fromArchive(this.titleArchive,"runes",_);if(this.imageFlamesLeft=new V0(128,265),this.imageFlamesRight=new V0(128,265),this.imageTitle0)z5(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)z5(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient0[_]=_*262144;for(let _=0;_<64;_++)this.flameGradient0[_+64]=_*1024+X.RED;for(let _=0;_<64;_++)this.flameGradient0[_+128]=_*4+X.YELLOW;for(let _=0;_<64;_++)this.flameGradient0[_+192]=X.WHITE;this.flameGradient1=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient1[_]=_*1024;for(let _=0;_<64;_++)this.flameGradient1[_+64]=_*4+X.GREEN;for(let _=0;_<64;_++)this.flameGradient1[_+128]=_*262144+X.CYAN;for(let _=0;_<64;_++)this.flameGradient1[_+192]=X.WHITE;this.flameGradient2=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient2[_]=_*4;for(let _=0;_<64;_++)this.flameGradient2[_+64]=_*262144+X.BLUE;for(let _=0;_<64;_++)this.flameGradient2[_+128]=_*1024+X.MAGENTA;for(let _=0;_<64;_++)this.flameGradient2[_+192]=X.WHITE;this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),this.showProgress(10,"Connecting to fileserver").then(()=>{if(!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames,35)})};updateTitleScreen=async()=>{if(this.titleScreenState===0){let _=(this.width/2|0)-80,R=(this.height/2|0)+20;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=3,this.titleLoginField=0;if(_=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(this.titleScreenState===2){let _=(this.height/2|0)-40;if(_+=30,_+=25,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=0;if(_+=15,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=1;let R=(this.width/2|0)-80,L=(this.height/2|0)+50;if(L+=20,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=L-20&&this.mouseClickY<=L+20)await this.login(this.username,this.password,!1);if(R=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=R-75&&this.mouseClickX<=R+75&&this.mouseClickY>=L-20&&this.mouseClickY<=L+20)this.titleScreenState=0,this.username="",this.password="";while(!0){let G=this.pollKey();if(G===-1)return;let K=!1;for(let Q=0;Q<y0.CHARSET.length;Q++)if(String.fromCharCode(G)===y0.CHARSET.charAt(Q)){K=!0;break}if(this.titleLoginField===0){if(G===8&&this.username.length>0)this.username=this.username.substring(0,this.username.length-1);if(G===9||G===10||G===13)this.titleLoginField=1;if(K)this.username=this.username+String.fromCharCode(G);if(this.username.length>12)this.username=this.username.substring(0,12)}else if(this.titleLoginField===1){if(G===8&&this.password.length>0)this.password=this.password.substring(0,this.password.length-1);if(G===9||G===10||G===13)this.titleLoginField=0;if(K)this.password=this.password+String.fromCharCode(G);if(this.password.length>20)this.password=this.password.substring(0,20)}}}else if(this.titleScreenState===3){let _=this.width/2|0,R=(this.height/2|0)+50;if(R+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=R-20&&this.mouseClickY<=R+20)this.titleScreenState=0}};drawTitleScreen=async()=>{await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let _=360,R=200;if(this.titleScreenState===0){let L=_/2|0,G=(R/2|0)-20;this.fontBold12?.drawStringTaggableCenter(L,G,"Welcome to RuneScape",X.YELLOW,!0),L=(_/2|0)-80,G=(R/2|0)+20,this.imageTitlebutton?.draw(L-73,G-20),this.fontBold12?.drawStringTaggableCenter(L,G+5,"New user",X.WHITE,!0),L=(_/2|0)+80,this.imageTitlebutton?.draw(L-73,G-20),this.fontBold12?.drawStringTaggableCenter(L,G+5,"Existing User",X.WHITE,!0)}else if(this.titleScreenState===2){let L=(_/2|0)-80,G=(R/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(_/2,G-15,this.loginMessage0,X.YELLOW,!0),this.fontBold12?.drawStringTaggableCenter(_/2,G,this.loginMessage1,X.YELLOW,!0),G+=30;else this.fontBold12?.drawStringTaggableCenter(_/2,G-7,this.loginMessage1,X.YELLOW,!0),G+=30;this.fontBold12?.drawStringTaggable(_/2-90,G,`Username: ${this.username}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,X.WHITE,!0),G+=15,this.fontBold12?.drawStringTaggable(_/2-88,G,`Password: ${I0.toAsterisks(this.password)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,X.WHITE,!0),G=(R/2|0)+50,this.imageTitlebutton?.draw(L-73,G-20),this.fontBold12?.drawStringTaggableCenter(L,G+5,"Login",X.WHITE,!0),L=(_/2|0)+80,this.imageTitlebutton?.draw(L-73,G-20),this.fontBold12?.drawStringTaggableCenter(L,G+5,"Cancel",X.WHITE,!0)}else if(this.titleScreenState===3){this.fontBold12?.drawStringTaggableCenter(_/2,R/2-60,"Create a free account",X.YELLOW,!0);let L=_/2|0,G=(R/2|0)-35;this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"To create a new account you need to",X.WHITE,!0),G+=15,this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"go back to the main RuneScape webpage",X.WHITE,!0),G+=15,this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"and choose the red 'create account'",X.WHITE,!0),G+=15,this.fontBold12?.drawStringTaggableCenter(_/2|0,G,"button at the top right of that page.",X.WHITE,!0),G=(R/2|0)+50,this.imageTitlebutton?.draw(L-73,G-20),this.fontBold12?.drawStringTaggableCenter(L,G+5,"Cancel",X.WHITE,!0)}if(this.imageTitle4?.draw(214,186),this.redrawTitleBackground)this.redrawTitleBackground=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)};login=async(_,R,L)=>{try{if(!L)this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitleScreen();this.stream=new Q8(await Q8.openSocket({host:d.serverAddress,port:43594+d.portOffset})),await this.stream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8;let G=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(G[0]),this.out.p4(G[1]),this.out.p4(G[2]),this.out.p4(G[3]),this.out.p4(0),this.out.pjstr(_),this.out.pjstr(R),this.out.rsaenc(d.modulus,d.exponent),this.loginout.pos=0,L)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(d.clientversion),this.loginout.p1(d.lowMemory?1:0);for(let Q=0;Q<9;Q++)this.loginout.p4(this.archiveChecksums[Q]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new $8(G);for(let Q=0;Q<4;Q++)G[Q]+=50;this.randomIn=new $8(G),this.stream?.write(this.loginout.data,this.loginout.pos);let K=await this.stream.read();if(K===1){await q1(2000),await this.login(_,R,L);return}if(K===2||K===18){this.rights=K===18,S0.setDisabled(),this.ingame=!0,this.out.pos=0,this.in.pos=0,this.packetType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.packetSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=Date.now();for(let Q=0;Q<100;Q++)this.messageText[Q]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.cameraAnticheatOffsetX=(Math.random()*100|0)-50,this.cameraAnticheatOffsetZ=(Math.random()*110|0)-55,this.cameraAnticheatAngle=(Math.random()*80|0)-40,this.minimapAnticheatAngle=(Math.random()*120|0)-60,this.minimapZoom=(Math.random()*30|0)-20,this.orbitCameraYaw=(Math.random()*20|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let Q=0;Q<this.MAX_PLAYER_COUNT;Q++)this.players[Q]=null,this.playerAppearanceBuffer[Q]=null;for(let Q=0;Q<8192;Q++)this.npcs[Q]=null;this.localPlayer=this.players[this.LOCAL_PLAYER_INDEX]=new U0,this.projectiles.clear(),this.spotanims.clear(),this.temporaryLocs.clear();for(let Q=0;Q<s.LEVELS;Q++)for(let H=0;H<s.SIZE;H++)for(let $=0;$<s.SIZE;$++)this.levelObjStacks[Q][H][$]=null;this.spawnedLocations=new g0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGenderMale=!0,this.validateCharacterDesign();for(let Q=0;Q<5;Q++)this.designColors[Q]=0;D8(!0),d.oplogic1=0,d.oplogic2=0,d.oplogic3=0,d.oplogic4=0,d.oplogic5=0,d.oplogic6=0,d.oplogic7=0,d.oplogic8=0,d.oplogic9=0,this.prepareGameScreen();return}if(K===3){this.loginMessage0="",this.loginMessage1="Invalid username or password.";return}if(K===4){this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details.";return}if(K===5){this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs...";return}if(K===6){this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page.";return}if(K===7){this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world.";return}if(K===8){this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline.";return}if(K===9){this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address.";return}if(K===10){this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id.";return}if(K===11){this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again.";return}if(K===12){this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world.";return}if(K===13){this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world.";return}if(K===14){this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again.";return}if(K===15){this.ingame=!0,this.out.pos=0,this.in.pos=0,this.packetType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.packetSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1;return}if(K===16){this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again.";return}if(K===17)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first"}catch(G){this.loginMessage0="",this.loginMessage1="Error connecting to server."}};updateGame=async()=>{if(this.players===null)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;for(let _=0;_<5&&await this.read();_++);if(this.ingame){for(let R=0;R<this.waveCount;R++)if(this.waveDelay[R]<=0){try{let L=Z0.generate(this.waveIds[R],this.waveLoops[R]);if(!L)throw new Error;if(Date.now()+(L.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=L.pos,this.lastWaveStartTime=Date.now(),this.lastWaveId=this.waveIds[R],this.lastWaveLoops=this.waveLoops[R],await T6(L.data.slice(0,L.pos),this.waveVolume)}catch(L){}this.waveCount--;for(let L=R;L<this.waveCount;L++)this.waveIds[L]=this.waveIds[L+1],this.waveLoops[L]=this.waveLoops[L+1],this.waveDelay[L]=this.waveDelay[L+1];R--}else this.waveDelay[R]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(this.nextMusicDelay===0&&this.midiActive&&!d.lowMemory&&this.currentMidi)await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1)}let _=S0.flush();if(_)this.out.p1isaac(c.EVENT_TRACKING),this.out.p2(_.pos),this.out.pdata(_.data,_.pos,0),_.release();if(this.idleNetCycles++,this.idleNetCycles>750)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),this.updateTemporaryLocs(),(this.actionKey[1]===1||this.actionKey[2]===1||this.actionKey[3]===1||this.actionKey[4]===1)&&this.cameraMovedWrite++>5)this.cameraMovedWrite=0,this.out.p1isaac(c.EVENT_CAMERA_POSITION),this.out.p2(this.orbitCameraPitch),this.out.p2(this.orbitCameraYaw),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom);if(this.sceneDelta++,this.crossMode!==0){if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0}if(this.selectedArea!==0){if(this.selectedCycle++,this.selectedCycle>=15){if(this.selectedArea===2)this.redrawSidebar=!0;if(this.selectedArea===3)this.redrawChatback=!0;this.selectedArea=0}}if(this.objDragArea!==0){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(this.mouseButton===0){if(this.objDragArea===2)this.redrawSidebar=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let R=g.instances[this.objDragInterfaceId];if(R.invSlotObjId){let L=R.invSlotObjId[this.hoveredSlot];R.invSlotObjId[this.hoveredSlot]=R.invSlotObjId[this.objDragSlot],R.invSlotObjId[this.objDragSlot]=L}if(R.invSlotObjCount){let L=R.invSlotObjCount[this.hoveredSlot];R.invSlotObjCount[this.hoveredSlot]=R.invSlotObjCount[this.objDragSlot],R.invSlotObjCount[this.objDragSlot]=L}this.out.p1isaac(c.INV_BUTTOND),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot)}}else if((this.mouseButtonsOption===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)await this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(d.cyclelogic3++,d.cyclelogic3>127)d.cyclelogic3=0,this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC3),this.out.p3(4991788);if(V.clickTileX!==-1){if(this.localPlayer){let R=V.clickTileX,L=V.clickTileZ,G=this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],R,L,0,0,0,0,0,0,!0);if(V.clickTileX=-1,G)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}}if(this.mouseClickButton===1&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(await this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatSettingsInput(),this.mouseButton===1||this.mouseClickButton===1)this.dragCycles++;if(this.sceneState===2)this.updateOrbitCamera();if(this.sceneState===2&&this.cutscene)this.applyCutscene();for(let R=0;R<5;R++)this.cameraModifierCycle[R]++;if(await this.handleInputKey(),Date.now()-this.idleCycles>90000)this.idleTimeout=250,this.idleCycles=Date.now()-1e4,this.out.p1isaac(c.IDLE_TIMER);if(this.cameraOffsetCycle++,this.cameraOffsetCycle>500){this.cameraOffsetCycle=0;let R=Math.random()*8|0;if((R&1)===1)this.cameraAnticheatOffsetX+=this.cameraOffsetXModifier;if((R&2)===2)this.cameraAnticheatOffsetZ+=this.cameraOffsetZModifier;if((R&4)===4)this.cameraAnticheatAngle+=this.cameraOffsetYawModifier}if(this.cameraAnticheatOffsetX<-50)this.cameraOffsetXModifier=2;if(this.cameraAnticheatOffsetX>50)this.cameraOffsetXModifier=-2;if(this.cameraAnticheatOffsetZ<-55)this.cameraOffsetZModifier=2;if(this.cameraAnticheatOffsetZ>55)this.cameraOffsetZModifier=-2;if(this.cameraAnticheatAngle<-40)this.cameraOffsetYawModifier=1;if(this.cameraAnticheatAngle>40)this.cameraOffsetYawModifier=-1;if(this.minimapOffsetCycle++,this.minimapOffsetCycle>500){this.minimapOffsetCycle=0;let R=Math.random()*8|0;if((R&1)===1)this.minimapAnticheatAngle+=this.minimapAngleModifier;if((R&2)===2)this.minimapZoom+=this.minimapZoomModifier}if(this.minimapAnticheatAngle<-60)this.minimapAngleModifier=2;if(this.minimapAnticheatAngle>60)this.minimapAngleModifier=-2;if(this.minimapZoom<-20)this.minimapZoomModifier=1;if(this.minimapZoom>10)this.minimapZoomModifier=-1;if(d.cyclelogic4++,d.cyclelogic4>110)d.cyclelogic4=0,this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC4),this.out.p4(0);if(this.heartbeatTimer++,this.heartbeatTimer>50)this.out.p1isaac(c.NO_TIMEOUT);try{if(this.stream&&this.out.pos>0)this.stream.write(this.out.data,this.out.pos),this.out.pos=0,this.heartbeatTimer=0}catch(R){await this.tryReconnect()}}};drawGame=()=>{if(this.players===null)return;if(this.redrawTitleBackground){if(this.redrawTitleBackground=!1,this.areaBackleft1?.draw(0,11),this.areaBackleft2?.draw(0,375),this.areaBackright1?.draw(729,5),this.areaBackright2?.draw(752,231),this.areaBacktop1?.draw(0,0),this.areaBacktop2?.draw(561,0),this.areaBackvmid1?.draw(520,11),this.areaBackvmid2?.draw(520,231),this.areaBackvmid3?.draw(501,375),this.areaBackhmid2?.draw(0,345),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,this.sceneState!==2)this.areaViewport?.draw(8,11),this.areaMapback?.draw(561,5)}if(this.sceneState===2)this.drawScene();if(this.menuVisible&&this.menuArea===1)this.redrawSidebar=!0;let _=!1;if(this.sidebarInterfaceId!==-1){if(_=this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta),_)this.redrawSidebar=!0}if(this.selectedArea===2)this.redrawSidebar=!0;if(this.objDragArea===2)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(this.chatInterfaceId===-1){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>453&&this.mouseX<565&&this.mouseY>350)this.handleScrollInput(this.mouseX-22,this.mouseY-375,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let R=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(R<0)R=0;if(R>this.chatScrollHeight-77)R=this.chatScrollHeight-77;if(this.chatScrollOffset!==R)this.chatScrollOffset=R,this.redrawChatback=!0}if(this.chatInterfaceId!==-1){if(_=this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta),_)this.redrawChatback=!0}if(this.selectedArea===3)this.redrawChatback=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&this.menuArea===2)this.redrawChatback=!0;if(this.redrawChatback)this.drawChatback(),this.redrawChatback=!1;if(this.sceneState===2)this.drawMinimap(),this.areaMapback?.draw(561,5);if(this.flashingTab!==-1)this.redrawSideicons=!0;if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(c.TUTORIAL_CLICKSIDE),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0)this.imageRedstone1?.draw(29,30);else if(this.selectedTab===1)this.imageRedstone2?.draw(59,29);else if(this.selectedTab===2)this.imageRedstone2?.draw(87,29);else if(this.selectedTab===3)this.imageRedstone3?.draw(115,29);else if(this.selectedTab===4)this.imageRedstone2h?.draw(156,29);else if(this.selectedTab===5)this.imageRedstone2h?.draw(184,29);else if(this.selectedTab===6)this.imageRedstone1h?.draw(212,30)}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10))this.imageSideicons[0]?.draw(35,34);if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10))this.imageSideicons[1]?.draw(59,32);if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10))this.imageSideicons[2]?.draw(86,32);if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10))this.imageSideicons[3]?.draw(121,33);if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10))this.imageSideicons[4]?.draw(157,34);if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10))this.imageSideicons[5]?.draw(185,32);if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10))this.imageSideicons[6]?.draw(212,34)}if(this.areaBackhmid1?.draw(520,165),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7)this.imageRedstone1v?.draw(49,0);else if(this.selectedTab===8)this.imageRedstone2v?.draw(81,0);else if(this.selectedTab===9)this.imageRedstone2v?.draw(108,0);else if(this.selectedTab===10)this.imageRedstone3v?.draw(136,1);else if(this.selectedTab===11)this.imageRedstone2hv?.draw(178,0);else if(this.selectedTab===12)this.imageRedstone2hv?.draw(205,0);else if(this.selectedTab===13)this.imageRedstone1hv?.draw(233,0)}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10))this.imageSideicons[7]?.draw(80,2);if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10))this.imageSideicons[8]?.draw(107,3);if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10))this.imageSideicons[9]?.draw(142,4);if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10))this.imageSideicons[10]?.draw(179,2);if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10))this.imageSideicons[11]?.draw(206,2);if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10))this.imageSideicons[12]?.draw(230,2)}this.areaBackbase2?.draw(501,492),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(57,33,"Public chat",X.WHITE,!0),this.publicChatSetting===0)this.fontPlain12?.drawStringTaggableCenter(57,46,"On",X.GREEN,!0);if(this.publicChatSetting===1)this.fontPlain12?.drawStringTaggableCenter(57,46,"Friends",X.YELLOW,!0);if(this.publicChatSetting===2)this.fontPlain12?.drawStringTaggableCenter(57,46,"Off",X.RED,!0);if(this.publicChatSetting===3)this.fontPlain12?.drawStringTaggableCenter(57,46,"Hide",X.CYAN,!0);if(this.fontPlain12?.drawStringTaggableCenter(186,33,"Private chat",X.WHITE,!0),this.privateChatSetting===0)this.fontPlain12?.drawStringTaggableCenter(186,46,"On",X.GREEN,!0);if(this.privateChatSetting===1)this.fontPlain12?.drawStringTaggableCenter(186,46,"Friends",X.YELLOW,!0);if(this.privateChatSetting===2)this.fontPlain12?.drawStringTaggableCenter(186,46,"Off",X.RED,!0);if(this.fontPlain12?.drawStringTaggableCenter(326,33,"Trade/duel",X.WHITE,!0),this.tradeChatSetting===0)this.fontPlain12?.drawStringTaggableCenter(326,46,"On",X.GREEN,!0);if(this.tradeChatSetting===1)this.fontPlain12?.drawStringTaggableCenter(326,46,"Friends",X.YELLOW,!0);if(this.tradeChatSetting===2)this.fontPlain12?.drawStringTaggableCenter(326,46,"Off",X.RED,!0);this.fontPlain12?.drawStringTaggableCenter(462,38,"Report abuse",X.WHITE,!0),this.areaBackbase1?.draw(0,471),this.areaViewport?.bind()}this.sceneDelta=0};drawScene=()=>{if(this.sceneCycle++,this.pushPlayers(),this.pushNpcs(),this.pushProjectiles(),this.pushSpotanims(),this.pushLocs(),!this.cutscene){let $=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>$)$=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>$)$=this.cameraModifierWobbleScale[4]+128;let J=this.orbitCameraYaw+this.cameraAnticheatAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,J,$,$*3+600);if(d.cyclelogic2++,d.cyclelogic2>1802){d.cyclelogic2=0,this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC2),this.out.p1(0);let O=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(Math.random()*256|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),(Math.random()*2|0)===0)this.out.p1(13);if((Math.random()*2|0)===0)this.out.p2(57856);this.out.p2(Math.random()*65536|0),this.out.psize1(this.out.pos-O)}}let _;if(this.cutscene)_=this.getTopLevelCutscene();else _=this.getTopLevel();let R=this.cameraX,L=this.cameraY,G=this.cameraZ,K=this.cameraPitch,Q=this.cameraYaw,H;for(let $=0;$<5;$++)if(this.cameraModifierEnabled[$]){if(H=Math.random()*(this.cameraModifierJitter[$]*2+1)-this.cameraModifierJitter[$]+Math.sin(this.cameraModifierCycle[$]*(this.cameraModifierWobbleSpeed[$]/100))*this.cameraModifierWobbleScale[$]|0,$===0)this.cameraX+=H;if($===1)this.cameraY+=H;if($===2)this.cameraZ+=H;if($===3)this.cameraYaw=this.cameraYaw+H&2047;if($===4){if(this.cameraPitch+=H,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}H=h.cycle,E.checkHover=!0,E.pickedCount=0,E.mouseX=this.mouseX-8,E.mouseY=this.mouseY-11,j.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,_,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearTemporaryLocs(),this.draw2DEntityElements(),this.updateTextures(H),this.draw3DEntityElements(),this.areaViewport?.draw(8,11),this.cameraX=R,this.cameraY=L,this.cameraZ=G,this.cameraPitch=K,this.cameraYaw=Q};clearCaches=()=>{B0.modelCacheStatic?.clear(),B0.modelCacheDynamic?.clear(),_1.modelCache?.clear(),Y0.modelCache?.clear(),Y0.iconCache?.clear(),U0.modelCache?.clear(),p0.modelCache?.clear()};projectFromEntity=(_,R)=>{this.projectFromGround(_.x,R,_.z)};projectFromGround=(_,R,L)=>{if(_<128||L<128||_>13056||L>13056){this.projectX=-1,this.projectY=-1;return}let G=this.getHeightmapY(this.currentLevel,_,L)-R;this.project(_,G,L)};project=(_,R,L)=>{let G=_-this.cameraX,K=R-this.cameraY,Q=L-this.cameraZ,H=h.sin[this.cameraPitch],$=h.cos[this.cameraPitch],J=h.sin[this.cameraYaw],O=h.cos[this.cameraYaw],q=Q*J+G*O>>16;if(Q=Q*O-G*J>>16,G=q,q=K*$-Q*H>>16,Q=K*H+Q*$>>16,K=q,Q>=50)this.projectX=h.centerX+((G<<9)/Q|0),this.projectY=h.centerY+((K<<9)/Q|0);else this.projectX=-1,this.projectY=-1};draw2DEntityElements=()=>{this.chatCount=0;for(let _=-1;_<this.playerCount+this.npcCount;_++){let R=null;if(_===-1)R=this.localPlayer;else if(_<this.playerCount)R=this.players[this.playerIds[_]];else R=this.npcs[this.npcIds[_-this.playerCount]];if(!R||!R.isVisible())continue;if(_<this.playerCount){let L=30,G=R;if(G.headicons!==0){if(this.projectFromEntity(R,R.height+15),this.projectX>-1){for(let K=0;K<8;K++)if((G.headicons&1<<K)!==0)this.imageHeadicons[K]?.draw(this.projectX-12,this.projectY-L),L-=25}}if(_>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[_]){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicons[7]?.draw(this.projectX-12,this.projectY-L)}}else if(this.hintType===1&&this.hintNpc===this.npcIds[_-this.playerCount]&&this.loopCycle%20<10){if(this.projectFromEntity(R,R.height+15),this.projectX>-1)this.imageHeadicons[2]?.draw(this.projectX-12,this.projectY-28)}if(R.chat&&(_>=this.playerCount||this.publicChatSetting===0||this.publicChatSetting===3||this.publicChatSetting===1&&this.isFriend(R.name))){if(this.projectFromEntity(R,R.height),this.projectX>-1&&this.chatCount<d.MAX_CHATS&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(R.chat)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=R.chatColor,this.chatStyles[this.chatCount]=R.chatStyle,this.chatTimers[this.chatCount]=R.chatTimer,this.chats[this.chatCount++]=R.chat,this.chatEffects===0&&R.chatStyle===1)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(this.chatEffects===0&&R.chatStyle===2)this.chatWidth[this.chatCount]=60}}if(R.combatCycle>this.loopCycle+100){if(this.projectFromEntity(R,R.height+15),this.projectX>-1){let L=R.health*30/R.totalHealth|0;if(L>30)L=30;j.fillRect(this.projectX-15,this.projectY-3,L,5,X.GREEN),j.fillRect(this.projectX-15+L,this.projectY-3,30-L,5,X.RED)}}if(R.combatCycle>this.loopCycle+330){if(this.projectFromEntity(R,R.height/2|0),this.projectX>-1)this.imageHitmarks[R.damageType]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,R.damage.toString(),X.BLACK),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,R.damage.toString(),X.WHITE)}}for(let _=0;_<this.chatCount;_++){let R=this.chatX[_],L=this.chatY[_],G=this.chatWidth[_],K=this.chatHeight[_],Q=!0;while(Q){Q=!1;for(let $=0;$<_;$++)if(L+2>this.chatY[$]-this.chatHeight[$]&&L-K<this.chatY[$]+2&&R-G<this.chatX[$]+this.chatWidth[$]&&R+G>this.chatX[$]-this.chatWidth[$]&&this.chatY[$]-this.chatHeight[$]<L)L=this.chatY[$]-this.chatHeight[$],Q=!0}this.projectX=this.chatX[_],this.projectY=this.chatY[_]=L;let H=this.chats[_];if(this.chatEffects===0){let $=X.YELLOW;if(this.chatColors[_]<6)$=X.CHAT_COLORS[this.chatColors[_]];if(this.chatColors[_]===6)$=this.sceneCycle%20<10?X.RED:X.YELLOW;if(this.chatColors[_]===7)$=this.sceneCycle%20<10?X.BLUE:X.CYAN;if(this.chatColors[_]===8)$=this.sceneCycle%20<10?45056:8454016;if(this.chatColors[_]===9){let J=150-this.chatTimers[_];if(J<50)$=J*1280+X.RED;else if(J<100)$=X.YELLOW-(J-50)*327680;else if(J<150)$=(J-100)*5+X.GREEN}if(this.chatColors[_]===10){let J=150-this.chatTimers[_];if(J<50)$=J*5+X.RED;else if(J<100)$=X.MAGENTA-(J-50)*327680;else if(J<150)$=(J-100)*327680+X.BLUE-(J-100)*5}if(this.chatColors[_]===11){let J=150-this.chatTimers[_];if(J<50)$=X.WHITE-J*327685;else if(J<100)$=(J-50)*327685+X.GREEN;else if(J<150)$=X.WHITE-(J-100)*327680}if(this.chatStyles[_]===0)this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,H,X.BLACK),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,H,$);if(this.chatStyles[_]===1)this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,H,X.BLACK,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,H,$,this.sceneCycle);if(this.chatStyles[_]===2){let J=this.fontBold12?.stringWidth(H)??0,O=(150-this.chatTimers[_])*(J+100)/150;j.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-O,this.projectY+1,H,X.BLACK),this.fontBold12?.drawString(this.projectX+50-O,this.projectY,H,$),j.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,H,X.BLACK),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,H,X.YELLOW)}};draw3DEntityElements=()=>{if(this.drawPrivateMessages(),this.crossMode===1)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-8,this.crossY-8-11);if(this.crossMode===2)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-8,this.crossY-8-11);if(this.viewportInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(g.instances[this.viewportInterfaceId],0,0,0);if(this.drawWildyLevel(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(this.menuArea===0)this.drawMenu();if(this.inMultizone===1)if(this.wildernessLevel>0||this.worldLocationState===1)this.imageHeadicons[1]?.draw(472,258);else this.imageHeadicons[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicons[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,X.YELLOW);if(this.worldLocationState===1)this.imageHeadicons[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",X.YELLOW);if(this.systemUpdateTimer!==0){let _=this.systemUpdateTimer/50|0,R=_/60|0;if(_%=60,_<10)this.fontPlain12?.drawString(4,329,"System update in: "+R+":0"+_,X.YELLOW);else this.fontPlain12?.drawString(4,329,"System update in: "+R+":"+_,X.YELLOW)}};drawPrivateMessages=()=>{if(this.splitPrivateChat===0)return;let _=this.fontPlain12,R=0;if(this.systemUpdateTimer!==0)R=1;for(let L=0;L<100;L++){if(!this.messageText[L])continue;let G=this.messageType[L],K;if((G===3||G===7)&&(G===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[L]))){if(K=329-R*13,_?.drawString(4,K,"From "+this.messageSender[L]+": "+this.messageText[L],X.BLACK),_?.drawString(4,K-1,"From "+this.messageSender[L]+": "+this.messageText[L],X.CYAN),R++,R>=5)return}if(G===5&&this.privateChatSetting<2){if(K=329-R*13,_?.drawString(4,K,this.messageText[L],X.BLACK),_?.drawString(4,K-1,this.messageText[L],X.CYAN),R++,R>=5)return}if(G===6&&this.privateChatSetting<2){if(K=329-R*13,_?.drawString(4,K,"To "+this.messageSender[L]+": "+this.messageText[L],X.BLACK),_?.drawString(4,K-1,"To "+this.messageSender[L]+": "+this.messageText[L],X.CYAN),R++,R>=5)return}}};drawWildyLevel=()=>{if(!this.localPlayer)return;let _=(this.localPlayer.x>>7)+this.sceneBaseTileX,R=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(_>=2944&&_<3392&&R>=3520&&R<6400)this.wildernessLevel=((R-3520)/8|0)+1;else if(_>=2944&&_<3392&&R>=9920&&R<12800)this.wildernessLevel=((R-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,_>=3328&&_<3392&&R>=3200&&R<3264){let L=_&63,G=R&63;if(L>=4&&L<=29&&G>=44&&G<=58)this.worldLocationState=1;else if(L>=36&&L<=61&&G>=44&&G<=58)this.worldLocationState=1;else if(L>=4&&L<=29&&G>=25&&G<=39)this.worldLocationState=1;else if(L>=36&&L<=61&&G>=25&&G<=39)this.worldLocationState=1;else if(L>=4&&L<=29&&G>=6&&G<=20)this.worldLocationState=1;else if(L>=36&&L<=61&&G>=6&&G<=20)this.worldLocationState=1}if(this.worldLocationState===0&&_>=3328&&_<=3393&&R>=3203&&R<=3325)this.worldLocationState=2;if(this.overrideChat=0,_>=3053&&_<=3156&&R>=3056&&R<=3136)this.overrideChat=1;else if(_>=3072&&_<=3118&&R>=9492&&R<=9535)this.overrideChat=1;if(this.overrideChat===1&&_>=3139&&_<=3199&&R>=3008&&R<=3062)this.overrideChat=0};drawSidebar=()=>{if(this.areaSidebar?.bind(),this.areaSidebarOffsets)h.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),this.sidebarInterfaceId!==-1)this.drawInterface(g.instances[this.sidebarInterfaceId],0,0,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.drawInterface(g.instances[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&this.menuArea===1)this.drawMenu();if(this.areaSidebar?.draw(562,231),this.areaViewport?.bind(),this.areaViewportOffsets)h.lineOffset=this.areaViewportOffsets};drawChatback=()=>{if(this.areaChatback?.bind(),this.areaChatbackOffsets)h.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,X.BLACK),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",X.DARKBLUE);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",X.BLACK),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",X.DARKBLUE);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,X.BLACK),this.fontBold12?.drawStringCenter(239,60,"Click to continue",X.DARKBLUE);else if(this.chatInterfaceId!==-1)this.drawInterface(g.instances[this.chatInterfaceId],0,0,0);else if(this.stickyChatInterfaceId===-1){let _=this.fontPlain12,R=0;j.setBounds(0,0,463,77);for(let L=0;L<100;L++){let G=this.messageText[L];if(!G)continue;let K=this.messageType[L],Q=this.chatScrollOffset+70-R*14;if(K===0){if(Q>0&&Q<110)_?.drawString(4,Q,G,X.BLACK);R++}if(K===1){if(Q>0&&Q<110)_?.drawString(4,Q,this.messageSender[L]+":",X.WHITE),_?.drawString(_.stringWidth(this.messageSender[L])+12,Q,G,X.BLUE);R++}if(K===2&&(this.publicChatSetting===0||this.publicChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110)_?.drawString(4,Q,this.messageSender[L]+":",X.BLACK),_?.drawString(_.stringWidth(this.messageSender[L])+12,Q,G,X.BLUE);R++}if((K===3||K===7)&&this.splitPrivateChat===0&&(K===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110)_?.drawString(4,Q,"From "+this.messageSender[L]+":",X.BLACK),_?.drawString(_.stringWidth("From "+this.messageSender[L])+12,Q,G,X.DARKRED);R++}if(K===4&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110)_?.drawString(4,Q,this.messageSender[L]+" "+this.messageText[L],X.TRADE_MESSAGE);R++}if(K===5&&this.splitPrivateChat===0&&this.privateChatSetting<2){if(Q>0&&Q<110)_?.drawString(4,Q,G,X.DARKRED);R++}if(K===6&&this.splitPrivateChat===0&&this.privateChatSetting<2){if(Q>0&&Q<110)_?.drawString(4,Q,"To "+this.messageSender[L]+":",X.BLACK),_?.drawString(_.stringWidth("To "+this.messageSender[L])+12,Q,G,X.DARKRED);R++}if(K===8&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[L]))){if(Q>0&&Q<110)_?.drawString(4,Q,this.messageSender[L]+" "+this.messageText[L],X.DUEL_MESSAGE);R++}}if(j.resetBounds(),this.chatScrollHeight=R*14+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77),_?.drawString(4,90,I0.formatName(this.username)+":",X.BLACK),_?.drawString(_.stringWidth(this.username+": ")+6,90,this.chatTyped+"*",X.BLUE),j.drawHorizontalLine(0,77,X.BLACK,479)}else this.drawInterface(g.instances[this.stickyChatInterfaceId],0,0,0);if(this.menuVisible&&this.menuArea===2)this.drawMenu();if(this.areaChatback?.draw(22,375),this.areaViewport?.bind(),this.areaViewportOffsets)h.lineOffset=this.areaViewportOffsets};drawMinimap=()=>{if(this.areaMapback?.bind(),!this.localPlayer)return;let _=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,R=(this.localPlayer.x/32|0)+48,L=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(21,9,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,R,L,_,this.minimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let G=0;G<this.activeMapFunctionCount;G++)R=this.activeMapFunctionX[G]*4+2-(this.localPlayer.x/32|0),L=this.activeMapFunctionZ[G]*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(L,this.activeMapFunctions[G],R);for(let G=0;G<s.SIZE;G++)for(let K=0;K<s.SIZE;K++)if(this.levelObjStacks[this.currentLevel][G][K])R=G*4+2-(this.localPlayer.x/32|0),L=K*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(L,this.imageMapdot0,R);for(let G=0;G<this.npcCount;G++){let K=this.npcs[this.npcIds[G]];if(K&&K.isVisible()&&K.type&&K.type.minimap)R=(K.x/32|0)-(this.localPlayer.x/32|0),L=(K.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(L,this.imageMapdot1,R)}for(let G=0;G<this.playerCount;G++){let K=this.players[this.playerIds[G]];if(K&&K.isVisible()&&K.name){R=(K.x/32|0)-(this.localPlayer.x/32|0),L=(K.z/32|0)-(this.localPlayer.z/32|0);let Q=!1,H=I0.toBase37(K.name);for(let $=0;$<this.friendCount;$++)if(H===this.friendName37[$]&&this.friendWorld[$]!==0){Q=!0;break}if(Q)this.drawOnMinimap(L,this.imageMapdot3,R);else this.drawOnMinimap(L,this.imageMapdot2,R)}}if(this.flagSceneTileX!==0)R=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0),L=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(L,this.imageMapflag,R);j.fillRect(93,82,3,3,X.WHITE),this.areaViewport?.bind()};drawOnMinimap=(_,R,L)=>{if(!R)return;let G=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,K=L*L+_*_;if(K>6400)return;let Q=h.sin[G],H=h.cos[G];Q=Q*256/(this.minimapZoom+256)|0,H=H*256/(this.minimapZoom+256)|0;let $=_*Q+L*H>>16,J=_*H-L*Q>>16;if(K>2500&&this.imageMapback)R.drawMasked($+94-(R.cropW/2|0),83-J-(R.cropH/2|0),this.imageMapback);else R.draw($+94-(R.cropW/2|0),83-J-(R.cropH/2|0))};createMinimap=(_)=>{if(!this.imageMinimap)return;let R=this.imageMinimap.pixels,L=R.length;for(let Q=0;Q<L;Q++)R[Q]=0;for(let Q=1;Q<s.SIZE-1;Q++){let H=(s.SIZE-1-Q)*512*4+24628;for(let $=1;$<s.SIZE-1;$++){if(this.levelTileFlags&&(this.levelTileFlags[_][$][Q]&24)===0)this.scene?.drawMinimapTile(_,$,Q,R,H,512);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][$][Q]&8)!==0)this.scene?.drawMinimapTile(_+1,$,Q,R,H,512);H+=4}}let G=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10,K=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let Q=1;Q<s.SIZE-1;Q++)for(let H=1;H<s.SIZE-1;H++){if(this.levelTileFlags&&(this.levelTileFlags[_][H][Q]&24)===0)this.drawMinimapLoc(H,Q,_,G,K);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][H][Q]&8)!==0)this.drawMinimapLoc(H,Q,_+1,G,K)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let Q=0;Q<s.SIZE;Q++)for(let H=0;H<s.SIZE;H++){let $=this.scene?.getGroundDecorationBitset(this.currentLevel,Q,H)??0;if($===0)continue;$=$>>14&32767;let J=B0.get($).mapfunction;if(J<0)continue;let O=Q,q=H;if(J!==22&&J!==29&&J!==34&&J!==36&&J!==46&&J!==47&&J!==48){let b=s.SIZE,U=s.SIZE,N=this.levelCollisionMap[this.currentLevel];if(N){let I=N.flags;for(let k=0;k<10;k++){let F=Math.random()*4|0;if(F===0&&O>0&&O>Q-3&&(I[s.index(O-1,q)]&S.BLOCK_WEST)===S.OPEN)O--;if(F===1&&O<b-1&&O<Q+3&&(I[s.index(O+1,q)]&S.BLOCK_EAST)===S.OPEN)O++;if(F===2&&q>0&&q>H-3&&(I[s.index(O,q-1)]&S.BLOCK_SOUTH)===S.OPEN)q--;if(F===3&&q<U-1&&q<H+3&&(I[s.index(O,q+1)]&S.BLOCK_NORTH)===S.OPEN)q++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[J],this.activeMapFunctionX[this.activeMapFunctionCount]=O,this.activeMapFunctionZ[this.activeMapFunctionCount]=q,this.activeMapFunctionCount++}};drawMinimapLoc=(_,R,L,G,K)=>{if(!this.scene||!this.imageMinimap)return;let Q=this.scene.getWallBitset(L,_,R);if(Q!==0){let H=this.scene.getInfo(L,_,R,Q),$=H>>6&3,J=H&31,O=G;if(Q>0)O=K;let q=this.imageMinimap.pixels,b=_*4+(103-R)*512*4+24624,U=Q>>14&32767,N=B0.get(U);if(N.mapscene===-1){if(J===y.WALL_STRAIGHT.id||J===y.WALL_L.id){if($===x.WEST)q[b]=O,q[b+512]=O,q[b+1024]=O,q[b+1536]=O;else if($===x.NORTH)q[b]=O,q[b+1]=O,q[b+2]=O,q[b+3]=O;else if($===x.EAST)q[b+3]=O,q[b+3+512]=O,q[b+3+1024]=O,q[b+3+1536]=O;else if($===x.SOUTH)q[b+1536]=O,q[b+1536+1]=O,q[b+1536+2]=O,q[b+1536+3]=O}if(J===y.WALL_SQUARE_CORNER.id){if($===x.WEST)q[b]=O;else if($===x.NORTH)q[b+3]=O;else if($===x.EAST)q[b+3+1536]=O;else if($===x.SOUTH)q[b+1536]=O}if(J===y.WALL_L.id){if($===x.SOUTH)q[b]=O,q[b+512]=O,q[b+1024]=O,q[b+1536]=O;else if($===x.WEST)q[b]=O,q[b+1]=O,q[b+2]=O,q[b+3]=O;else if($===x.NORTH)q[b+3]=O,q[b+3+512]=O,q[b+3+1024]=O,q[b+3+1536]=O;else if($===x.EAST)q[b+1536]=O,q[b+1536+1]=O,q[b+1536+2]=O,q[b+1536+3]=O}}else{let I=this.imageMapscene[N.mapscene];if(I){let k=(N.width*4-I.width)/2|0,F=(N.length*4-I.height)/2|0;I.draw(_*4+48+k,(s.SIZE-R-N.length)*4+F+48)}}}if(Q=this.scene.getLocBitset(L,_,R),Q!==0){let H=this.scene.getInfo(L,_,R,Q),$=H>>6&3,J=H&31,O=Q>>14&32767,q=B0.get(O);if(q.mapscene!==-1){let b=this.imageMapscene[q.mapscene];if(b){let U=(q.width*4-b.width)/2|0,N=(q.length*4-b.height)/2|0;b.draw(_*4+48+U,(s.SIZE-R-q.length)*4+N+48)}}else if(J===y.WALL_DIAGONAL.id){let b=15658734;if(Q>0)b=15597568;let U=this.imageMinimap.pixels,N=_*4+(s.SIZE-1-R)*512*4+24624;if($===x.WEST||$===x.EAST)U[N+1536]=b,U[N+1024+1]=b,U[N+512+2]=b,U[N+3]=b;else U[N]=b,U[N+512+1]=b,U[N+1024+2]=b,U[N+1536+3]=b}}if(Q=this.scene.getGroundDecorationBitset(L,_,R),Q!==0){let H=B0.get(Q>>14&32767);if(H.mapscene!==-1){let $=this.imageMapscene[H.mapscene];if($){let J=(H.width*4-$.width)/2|0,O=(H.length*4-$.height)/2|0;$.draw(_*4+48+J,(s.SIZE-R-H.length)*4+O+48)}}}};drawTooltip=()=>{if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0)return;let _;if(this.objSelected===1&&this.menuSize<2)_="Use "+this.objSelectedName+" with...";else if(this.spellSelected===1&&this.menuSize<2)_=this.spellCaption+"...";else _=this.menuOption[this.menuSize-1];if(this.menuSize>2)_=_+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,_,X.WHITE,!0,this.loopCycle/1000|0)};drawMenu=()=>{let _=this.menuX,R=this.menuY,L=this.menuWidth,G=this.menuHeight,K=X.OPTIONS_MENU;j.fillRect(_,R,L,G,K),j.fillRect(_+1,R+1,L-2,16,X.BLACK),j.drawRect(_+1,R+18,L-2,G-19,X.BLACK),this.fontBold12?.drawString(_+3,R+14,"Choose Option",K);let Q=this.mouseX,H=this.mouseY;if(this.menuArea===0)Q-=8,H-=11;if(this.menuArea===1)Q-=562,H-=231;if(this.menuArea===2)Q-=22,H-=375;for(let $=0;$<this.menuSize;$++){let J=R+(this.menuSize-1-$)*15+31,O=X.WHITE;if(Q>_&&Q<_+L&&H>J-13&&H<J+3)O=X.YELLOW;this.fontBold12?.drawStringTaggable(_+3,J,this.menuOption[$],O,!0)}};handleMouseInput=async()=>{if(this.objDragArea!==0)return;let _=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=520&&this.mouseClickY>=165&&this.mouseClickX<=788&&this.mouseClickY<=230)_=0;if(this.menuVisible){if(_!==1){let R=this.mouseX,L=this.mouseY;if(this.menuArea===0)R-=8,L-=11;else if(this.menuArea===1)R-=562,L-=231;else if(this.menuArea===2)R-=22,L-=375;if(R<this.menuX-10||R>this.menuX+this.menuWidth+10||L<this.menuY-10||L>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;if(this.menuArea===2)this.redrawChatback=!0}}if(_===1){let R=this.menuX,L=this.menuY,G=this.menuWidth,K=this.mouseClickX,Q=this.mouseClickY;if(this.menuArea===0)K-=8,Q-=11;else if(this.menuArea===1)K-=562,Q-=231;else if(this.menuArea===2)K-=22,Q-=375;let H=-1;for(let $=0;$<this.menuSize;$++){let J=L+(this.menuSize-1-$)*15+31;if(K>R&&K<R+G&&Q>J-13&&Q<J+3)H=$}if(H!==-1)await this.useMenuOption(H);if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;else if(this.menuArea===2)this.redrawChatback=!0}}else{if(_===1&&this.menuSize>0){let R=this.menuAction[this.menuSize-1];if(R===602||R===596||R===22||R===892||R===415||R===405||R===38||R===422||R===478||R===347||R===188){let L=this.menuParamB[this.menuSize-1],G=this.menuParamC[this.menuSize-1];if(g.instances[G].draggable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=G,this.objDragSlot=L,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,g.instances[G].layer===this.viewportInterfaceId)this.objDragArea=1;if(g.instances[G].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(_===1&&(this.mouseButtonsOption===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)_=2;if(_===1&&this.menuSize>0)await this.useMenuOption(this.menuSize-1);if(_!==2||this.menuSize<=0)return;this.showContextMenu()}};handleMinimapInput=()=>{if(this.mouseClickButton===1&&this.localPlayer){let _=this.mouseClickX-21-561,R=this.mouseClickY-9-5;if(_>=0&&R>=0&&_<146&&R<151){_-=73,R-=75;let L=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,G=h.sin[L],K=h.cos[L];G=G*(this.minimapZoom+256)>>8,K=K*(this.minimapZoom+256)>>8;let Q=R*G+_*K>>11,H=R*K-_*G>>11,$=this.localPlayer.x+Q>>7,J=this.localPlayer.z-H>>7;if(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],$,J,1,0,0,0,0,0,!0))this.out.p1(_),this.out.p1(R),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}}};isAddFriendOption=(_)=>{if(_<0)return!1;let R=this.menuAction[_];if(R>=2000)R-=2000;return R===406};useMenuOption=async(_)=>{if(_<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let R=this.menuAction[_],L=this.menuParamA[_],G=this.menuParamB[_],K=this.menuParamC[_];if(R>=2000)R-=2000;if(R===903||R===363){let Q=this.menuOption[_],H=Q.indexOf("@whi@");if(H!==-1){Q=Q.substring(H+5).trim();let $=I0.formatName(I0.fromBase37(I0.toBase37(Q))),J=!1;for(let O=0;O<this.playerCount;O++){let q=this.players[this.playerIds[O]];if(q&&q.name&&q.name.toLowerCase()===$.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],q.pathTileX[0],q.pathTileZ[0],2,1,1,0,0,0,!1),R===903)this.out.p1isaac(c.OPPLAYER4);else if(R===363)this.out.p1isaac(c.OPPLAYER1);this.out.p2(this.playerIds[O]),J=!0;break}}if(!J)this.addMessage(0,"Unable to find "+$,"")}}else if(R===450&&this.interactWithLoc(c.OPLOCU,G,K,L))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface);else if(R===405||R===38||R===422||R===478||R===347){if(R===478){if((G&3)===0)d.oplogic5++;if(d.oplogic5>=90)this.out.p1isaac(c.ANTICHEAT_OPLOGIC5);this.out.p1isaac(c.OPHELD4)}else if(R===347)this.out.p1isaac(c.OPHELD5);else if(R===422)this.out.p1isaac(c.OPHELD3);else if(R===405){if(d.oplogic3+=L,d.oplogic3>=97)this.out.p1isaac(c.ANTICHEAT_OPLOGIC3),this.out.p3(14953816);this.out.p1isaac(c.OPHELD1)}else if(R===38)this.out.p1isaac(c.OPHELD2);if(this.out.p2(L),this.out.p2(G),this.out.p2(K),this.selectedCycle=0,this.selectedInterface=K,this.selectedItem=G,this.selectedArea=2,g.instances[K].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.instances[K].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===728||R===542||R===6||R===963||R===245){let Q=this.npcs[L];if(Q&&this.localPlayer){if(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===542)this.out.p1isaac(c.OPNPC2);else if(R===6){if((L&3)===0)d.oplogic2++;if(d.oplogic2>=124)this.out.p1isaac(c.ANTICHEAT_OPLOGIC2),this.out.p4(0);this.out.p1isaac(c.OPNPC3)}else if(R===963)this.out.p1isaac(c.OPNPC4);else if(R===728)this.out.p1isaac(c.OPNPC1);else if(R===245){if((L&3)===0)d.oplogic4++;if(d.oplogic4>=85)this.out.p1isaac(c.ANTICHEAT_OPLOGIC4),this.out.p2(39596);this.out.p1isaac(c.OPNPC5)}this.out.p2(L)}}else if(R===217){if(this.localPlayer){if(!this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(c.OPOBJU),this.out.p2(G+this.sceneBaseTileX),this.out.p2(K+this.sceneBaseTileZ),this.out.p2(L),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}else if(R===1175){let Q=L>>14&32767,H=B0.get(Q),$;if(!H.desc)$="It's a "+H.name+".";else $=H.desc;this.addMessage(0,$,"")}else if(R===285)this.interactWithLoc(c.OPLOC1,G,K,L);else if(R===881){if(this.out.p1isaac(c.OPHELDU),this.out.p2(L),this.out.p2(G),this.out.p2(K),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=K,this.selectedItem=G,this.selectedArea=2,g.instances[K].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.instances[K].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===391){if(this.out.p1isaac(c.OPHELDT),this.out.p2(L),this.out.p2(G),this.out.p2(K),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=K,this.selectedItem=G,this.selectedArea=2,g.instances[K].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.instances[K].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===660)if(this.menuVisible)this.scene?.click(G-8,K-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else if(R===188){this.objSelected=1,this.objSelectedSlot=G,this.objSelectedInterface=K,this.objInterface=L,this.objSelectedName=Y0.get(L).name,this.spellSelected=0;return}else if(R===44){if(!this.pressedContinueOption)this.out.p1isaac(c.RESUME_PAUSEBUTTON),this.out.p2(K),this.pressedContinueOption=!0}else if(R===1773){let Q=Y0.get(L),H;if(K>=1e5)H=K+" x "+Q.name;else if(!Q.desc)H="It's a "+Q.name+".";else H=Q.desc;this.addMessage(0,H,"")}else if(R===900){let Q=this.npcs[L];if(Q&&this.localPlayer)this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(c.OPNPCU),this.out.p2(L),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===1373||R===1544||R===151||R===1101){let Q=this.players[L];if(Q&&this.localPlayer){if(this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===1101)this.out.p1isaac(c.OPPLAYER1);else if(R===151){if(d.oplogic8++,d.oplogic8>=90)this.out.p1isaac(c.ANTICHEAT_OPLOGIC8),this.out.p2(31114);this.out.p1isaac(c.OPPLAYER2)}else if(R===1373)this.out.p1isaac(c.OPPLAYER4);else if(R===1544)this.out.p1isaac(c.OPPLAYER3);this.out.p2(L)}}else if(R===265){let Q=this.npcs[L];if(Q&&this.localPlayer)this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(c.OPNPCT),this.out.p2(L),this.out.p2(this.activeSpellId)}else if(R===679){let Q=this.menuOption[_],H=Q.indexOf("@whi@");if(H!==-1){let $=I0.toBase37(Q.substring(H+5).trim()),J=-1;for(let O=0;O<this.friendCount;O++)if(this.friendName37[O]===$){J=O;break}if(J!==-1&&this.friendWorld[J]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=3,this.socialName37=this.friendName37[J],this.socialMessage="Enter message to send to "+this.friendName[J]}}else if(R===55){if(this.interactWithLoc(c.OPLOCT,G,K,L))this.out.p2(this.activeSpellId)}else if(R===224||R===993||R===99||R===746||R===877){if(this.localPlayer){if(!this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,R===224)this.out.p1isaac(c.OPOBJ1);else if(R===746)this.out.p1isaac(c.OPOBJ4);else if(R===877)this.out.p1isaac(c.OPOBJ5);else if(R===99)this.out.p1isaac(c.OPOBJ3);else if(R===993)this.out.p1isaac(c.OPOBJ2);this.out.p2(G+this.sceneBaseTileX),this.out.p2(K+this.sceneBaseTileZ),this.out.p2(L)}}else if(R===1607){let Q=this.npcs[L];if(Q&&Q.type){let H;if(!Q.type.desc)H="It's a "+Q.type.name+".";else H=Q.type.desc;this.addMessage(0,H,"")}}else if(R===504)this.interactWithLoc(c.OPLOC2,G,K,L);else if(R===930){let Q=g.instances[K];this.spellSelected=1,this.activeSpellId=K,this.activeSpellFlags=Q.actionTarget,this.objSelected=0;let H=Q.actionVerb;if(H&&H.indexOf(" ")!==-1)H=H.substring(0,H.indexOf(" "));let $=Q.actionVerb;if($&&$.indexOf(" ")!==-1)$=$.substring($.indexOf(" ")+1);if(this.spellCaption=H+" "+Q.action+" "+$,this.activeSpellFlags===16)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}else if(R===951){let Q=g.instances[K],H=!0;if(Q.clientCode>0)H=this.handleInterfaceAction(Q);if(H)this.out.p1isaac(c.IF_BUTTON),this.out.p2(K)}else if(R===602||R===596||R===22||R===892||R===415){if(R===22)this.out.p1isaac(c.INV_BUTTON3);else if(R===415){if((K&3)===0)d.oplogic7++;if(d.oplogic7>=55)this.out.p1isaac(c.ANTICHEAT_OPLOGIC7),this.out.p4(0);this.out.p1isaac(c.INV_BUTTON5)}else if(R===602)this.out.p1isaac(c.INV_BUTTON1);else if(R===892){if((G&3)===0)d.oplogic9++;if(d.oplogic9>=130)this.out.p1isaac(c.ANTICHEAT_OPLOGIC9),this.out.p1(177);this.out.p1isaac(c.INV_BUTTON4)}else if(R===596)this.out.p1isaac(c.INV_BUTTON2);if(this.out.p2(L),this.out.p2(G),this.out.p2(K),this.selectedCycle=0,this.selectedInterface=K,this.selectedItem=G,this.selectedArea=2,g.instances[K].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.instances[K].layer===this.chatInterfaceId)this.selectedArea=3}else if(R===581){if((L&3)===0)d.oplogic1++;if(d.oplogic1>=99)this.out.p1isaac(c.ANTICHEAT_OPLOGIC1),this.out.p4(0);this.interactWithLoc(c.OPLOC4,G,K,L)}else if(R===965){if(this.localPlayer){if(!this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],G,K,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(c.OPOBJT),this.out.p2(G+this.sceneBaseTileX),this.out.p2(K+this.sceneBaseTileZ),this.out.p2(L),this.out.p2(this.activeSpellId)}}else if(R===1501){if(d.oplogic6+=this.sceneBaseTileZ,d.oplogic6>=92)this.out.p1isaac(c.ANTICHEAT_OPLOGIC6),this.out.p4(0);this.interactWithLoc(c.OPLOC5,G,K,L)}else if(R===364)this.interactWithLoc(c.OPLOC3,G,K,L);else if(R===1102){let Q=Y0.get(L),H;if(!Q.desc)H="It's a "+Q.name+".";else H=Q.desc;this.addMessage(0,H,"")}else if(R===960){this.out.p1isaac(c.IF_BUTTON),this.out.p2(K);let Q=g.instances[K];if(Q.scripts&&Q.scripts[0]&&Q.scripts[0][0]===5){let H=Q.scripts[0][1];if(Q.scriptOperand&&this.varps[H]!==Q.scriptOperand[0])this.varps[H]=Q.scriptOperand[0],await this.updateVarp(H),this.redrawSidebar=!0}}else if(R===34){let Q=this.menuOption[_],H=Q.indexOf("@whi@");if(H!==-1){this.closeInterfaces(),this.reportAbuseInput=Q.substring(H+5).trim(),this.reportAbuseMuteOption=!1;for(let $=0;$<g.instances.length;$++)if(g.instances[$]&&g.instances[$].clientCode===g.CC_REPORT_INPUT){this.reportAbuseInterfaceID=this.viewportInterfaceId=g.instances[$].layer;break}}}else if(R===947)this.closeInterfaces();else if(R===367){let Q=this.players[L];if(Q&&this.localPlayer)this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(c.OPPLAYERU),this.out.p2(L),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(R===465){this.out.p1isaac(c.IF_BUTTON),this.out.p2(K);let Q=g.instances[K];if(Q.scripts&&Q.scripts[0]&&Q.scripts[0][0]===5){let H=Q.scripts[0][1];this.varps[H]=1-this.varps[H],await this.updateVarp(H),this.redrawSidebar=!0}}else if(R===406||R===436||R===557||R===556){let Q=this.menuOption[_],H=Q.indexOf("@whi@");if(H!==-1){let $=I0.toBase37(Q.substring(H+5).trim());if(R===406)this.addFriend($);else if(R===436)this.addIgnore($);else if(R===557)this.removeFriend($);else if(R===556)this.removeIgnore($)}}else if(R===651){let Q=this.players[L];if(Q&&this.localPlayer)this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],Q.pathTileX[0],Q.pathTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(c.OPPLAYERT),this.out.p2(L),this.out.p2(this.activeSpellId)}this.objSelected=0,this.spellSelected=0};handleInterfaceAction=(_)=>{let R=_.clientCode;if(R===g.CC_ADD_FRIEND)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=1,this.socialMessage="Enter name of friend to add to list";if(R===g.CC_DEL_FRIEND)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=2,this.socialMessage="Enter name of friend to delete from list";if(R===g.CC_LOGOUT)return this.idleTimeout=250,!0;if(R===g.CC_ADD_IGNORE)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=4,this.socialMessage="Enter name of player to add to list";if(R===g.CC_DEL_IGNORE)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=5,this.socialMessage="Enter name of player to delete from list";if(R>=g.CC_CHANGE_HEAD_L&&R<=g.CC_CHANGE_FEET_R){let L=(R-300)/2|0,G=R&1,K=this.designIdentikits[L];if(K!==-1)while(!0){if(G===0){if(K--,K<0)K=i0.count-1}if(G===1){if(K++,K>=i0.count)K=0}if(!i0.instances[K].disable&&i0.instances[K].type===L+(this.designGenderMale?0:7)){this.designIdentikits[L]=K,this.updateDesignModel=!0;break}}}if(R>=g.CC_RECOLOUR_HAIR_L&&R<=g.CC_RECOLOUR_SKIN_R){let L=(R-314)/2|0,G=R&1,K=this.designColors[L];if(G===0){if(K--,K<0)K=U0.DESIGN_IDK_COLORS[L].length-1}if(G===1){if(K++,K>=U0.DESIGN_IDK_COLORS[L].length)K=0}this.designColors[L]=K,this.updateDesignModel=!0}if(R===g.CC_SWITCH_TO_MALE&&!this.designGenderMale)this.designGenderMale=!0,this.validateCharacterDesign();if(R===g.CC_SWITCH_TO_FEMALE&&this.designGenderMale)this.designGenderMale=!1,this.validateCharacterDesign();if(R===g.CC_ACCEPT_DESIGN){this.out.p1isaac(c.IF_PLAYERDESIGN),this.out.p1(this.designGenderMale?0:1);for(let L=0;L<7;L++)this.out.p1(this.designIdentikits[L]);for(let L=0;L<5;L++)this.out.p1(this.designColors[L]);return!0}if(R===g.CC_MOD_MUTE)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;if(R>=g.CC_REPORT_RULE1&&R<=g.CC_REPORT_RULE12){if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(c.BUG_REPORT),this.out.p8(I0.toBase37(this.reportAbuseInput)),this.out.p1(R-601),this.out.p1(this.reportAbuseMuteOption?1:0)}return!1};validateCharacterDesign=()=>{this.updateDesignModel=!0;for(let _=0;_<7;_++){this.designIdentikits[_]=-1;for(let R=0;R<i0.count;R++)if(!i0.instances[R].disable&&i0.instances[R].type===_+(this.designGenderMale?0:7)){this.designIdentikits[_]=R;break}}};interactWithLoc=(_,R,L,G)=>{if(!this.localPlayer||!this.scene)return!1;let K=G>>14&32767,Q=this.scene.getInfo(this.currentLevel,R,L,G);if(Q===-1)return!1;let H=Q&31,$=Q>>6&3;if(H===y.CENTREPIECE_STRAIGHT.id||H===y.CENTREPIECE_DIAGONAL.id||H===y.GROUND_DECOR.id){let J=B0.get(K),O,q;if($===x.WEST||$===x.EAST)O=J.width,q=J.length;else O=J.length,q=J.width;let b=J.forceapproach;if($!==0)b=(b<<$&15)+(b>>4-$);this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],R,L,2,O,q,0,0,b,!1)}else this.tryMove(this.localPlayer.pathTileX[0],this.localPlayer.pathTileZ[0],R,L,2,0,0,$,H+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(_),this.out.p2(R+this.sceneBaseTileX),this.out.p2(L+this.sceneBaseTileZ),this.out.p2(K),!0};handleTabInput=()=>{if(this.mouseClickButton===1){if(this.mouseClickX>=549&&this.mouseClickX<=583&&this.mouseClickY>=195&&this.mouseClickY<231&&this.tabInterfaceId[0]!==-1)this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=579&&this.mouseClickX<=609&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[1]!==-1)this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=607&&this.mouseClickX<=637&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[2]!==-1)this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=635&&this.mouseClickX<=679&&this.mouseClickY>=194&&this.mouseClickY<229&&this.tabInterfaceId[3]!==-1)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=676&&this.mouseClickX<=706&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[4]!==-1)this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=704&&this.mouseClickX<=734&&this.mouseClickY>=194&&this.mouseClickY<231&&this.tabInterfaceId[5]!==-1)this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=732&&this.mouseClickX<=766&&this.mouseClickY>=195&&this.mouseClickY<231&&this.tabInterfaceId[6]!==-1)this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=550&&this.mouseClickX<=584&&this.mouseClickY>=492&&this.mouseClickY<528&&this.tabInterfaceId[7]!==-1)this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=582&&this.mouseClickX<=612&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[8]!==-1)this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=609&&this.mouseClickX<=639&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[9]!==-1)this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=637&&this.mouseClickX<=681&&this.mouseClickY>=493&&this.mouseClickY<528&&this.tabInterfaceId[10]!==-1)this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=679&&this.mouseClickX<=709&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[11]!==-1)this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=706&&this.mouseClickX<=736&&this.mouseClickY>=492&&this.mouseClickY<529&&this.tabInterfaceId[12]!==-1)this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=734&&this.mouseClickX<=768&&this.mouseClickY>=492&&this.mouseClickY<528&&this.tabInterfaceId[13]!==-1)this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(d.cyclelogic1++,d.cyclelogic1>150)d.cyclelogic1=0,this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC1),this.out.p1(43)}};handleInputKey=async()=>{while(!0){let _;do while(!0){if(_=this.pollKey(),_===-1)return;if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceID){if(_===8&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(_>=32&&_<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(_===13||_===10){this.showSocialInput=!1,this.redrawChatback=!0;let R;if(this.socialAction===1)R=I0.toBase37(this.socialInput),this.addFriend(R);if(this.socialAction===2&&this.friendCount>0)R=I0.toBase37(this.socialInput),this.removeFriend(R);if(this.socialAction===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(c.MESSAGE_PRIVATE),this.out.p1(0);let L=this.out.pos;if(this.out.p8(this.socialName37),m1.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-L),this.socialInput=I0.toSentenceCase(this.socialInput),this.socialInput=j1.filter(this.socialInput),this.addMessage(6,this.socialInput,I0.formatName(I0.fromBase37(this.socialName37))),this.privateChatSetting===2)this.privateChatSetting=1,this.redrawPrivacySettings=!0,this.out.p1isaac(c.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)}if(this.socialAction===4&&this.ignoreCount<100)R=I0.toBase37(this.socialInput),this.addIgnore(R);if(this.socialAction===5&&this.ignoreCount>0)R=I0.toBase37(this.socialInput),this.removeIgnore(R)}}else if(this.chatbackInputOpen){if(_>=48&&_<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(_===13||_===10){if(this.chatbackInput.length>0){let R=0;try{R=parseInt(this.chatbackInput,10)}catch(L){}this.out.p1isaac(c.RESUME_P_COUNTDIALOG),this.out.p4(R)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(this.chatInterfaceId===-1){if(_>=32&&_<=126&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((_===13||_===10)&&this.chatTyped.length>0){if(this.chatTyped.startsWith("::"))this.out.p1isaac(c.CLIENT_CHEAT),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let R=0;if(this.chatTyped.startsWith("yellow:"))R=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))R=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))R=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))R=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))R=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))R=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))R=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))R=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))R=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))R=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))R=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))R=11,this.chatTyped=this.chatTyped.substring(6);let L=0;if(this.chatTyped.startsWith("wave:"))L=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))L=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(c.MESSAGE_PUBLIC),this.out.p1(0);let G=this.out.pos;if(this.out.p1(R),this.out.p1(L),m1.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-G),this.chatTyped=I0.toSentenceCase(this.chatTyped),this.chatTyped=j1.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)this.localPlayer.chat=this.chatTyped,this.localPlayer.chatColor=R,this.localPlayer.chatStyle=L,this.localPlayer.chatTimer=150,this.addMessage(2,this.localPlayer.chat,this.localPlayer.name);if(this.publicChatSetting===2)this.publicChatSetting=3,this.redrawPrivacySettings=!0,this.out.p1isaac(c.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)}this.chatTyped="",this.redrawChatback=!0}}}while((_<97||_>122)&&(_<65||_>90)&&(_<48||_>57)&&_!==32);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(_)}};handleChatSettingsInput=()=>{if(this.mouseClickButton===1){if(this.mouseClickX>=8&&this.mouseClickX<=108&&this.mouseClickY>=490&&this.mouseClickY<=522)this.publicChatSetting=(this.publicChatSetting+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(c.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=137&&this.mouseClickX<=237&&this.mouseClickY>=490&&this.mouseClickY<=522)this.privateChatSetting=(this.privateChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(c.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=275&&this.mouseClickX<=375&&this.mouseClickY>=490&&this.mouseClickY<=522)this.tradeChatSetting=(this.tradeChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(c.CHAT_SETMODE),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=416&&this.mouseClickX<=516&&this.mouseClickY>=490&&this.mouseClickY<=522){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let _=0;_<g.instances.length;_++)if(g.instances[_]&&g.instances[_].clientCode===600){this.reportAbuseInterfaceID=this.viewportInterfaceId=g.instances[_].layer;return}}}};handleScrollInput=(_,R,L,G,K,Q,H,$)=>{if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,_>=Q&&_<Q+16&&R>=H&&R<H+16){if($.scrollPosition-=this.dragCycles*4,K)this.redrawSidebar=!0}else if(_>=Q&&_<Q+16&&R>=H+G-16&&R<H+G){if($.scrollPosition+=this.dragCycles*4,K)this.redrawSidebar=!0}else if(_>=Q-this.scrollInputPadding&&_<Q+this.scrollInputPadding+16&&R>=H+16&&R<H+G-16&&this.dragCycles>0){let J=(G-32)*G/L|0;if(J<8)J=8;let O=R-H-(J/2|0)-16,q=G-J-32;if($.scrollPosition=(L-G)*O/q|0,K)this.redrawSidebar=!0;this.scrollGrabbed=!0}};prepareGameScreen=()=>{if(!this.areaChatback)this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new w0(479,96),this.areaMapback=new w0(168,160),j.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new w0(190,261),this.areaViewport=new w0(512,334),j.clear(),this.areaBackbase1=new w0(501,61),this.areaBackbase2=new w0(288,40),this.areaBackhmid1=new w0(269,66),this.redrawTitleBackground=!0};isFriend=(_)=>{if(!_)return!1;for(let R=0;R<this.friendCount;R++)if(_.toLowerCase()===this.friendName[R]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return _.toLowerCase()===this.localPlayer.name?.toLowerCase()};addFriend=(_)=>{if(_===0n)return;if(this.friendCount>=100){this.addMessage(0,"Your friends list is full. Max of 100 hit","");return}let R=I0.formatName(I0.fromBase37(_));for(let L=0;L<this.friendCount;L++)if(this.friendName37[L]===_){this.addMessage(0,R+" is already on your friend list","");return}for(let L=0;L<this.ignoreCount;L++)if(this.ignoreName37[L]===_){this.addMessage(0,"Please remove "+R+" from your ignore list first","");return}if(!this.localPlayer||!this.localPlayer.name)return;if(R!==this.localPlayer.name)this.friendName[this.friendCount]=R,this.friendName37[this.friendCount]=_,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(c.FRIENDLIST_ADD),this.out.p8(_)};removeFriend=(_)=>{if(_===0n)return;for(let R=0;R<this.friendCount;R++)if(this.friendName37[R]===_){this.friendCount--,this.redrawSidebar=!0;for(let L=R;L<this.friendCount;L++)this.friendName[L]=this.friendName[L+1],this.friendWorld[L]=this.friendWorld[L+1],this.friendName37[L]=this.friendName37[L+1];this.out.p1isaac(c.FRIENDLIST_DEL),this.out.p8(_);return}};addIgnore=(_)=>{if(_===0n)return;if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}let R=I0.formatName(I0.fromBase37(_));for(let L=0;L<this.ignoreCount;L++)if(this.ignoreName37[L]===_){this.addMessage(0,R+" is already on your ignore list","");return}for(let L=0;L<this.friendCount;L++)if(this.friendName37[L]===_){this.addMessage(0,"Please remove "+R+" from your friend list first","");return}this.ignoreName37[this.ignoreCount++]=_,this.redrawSidebar=!0,this.out.p1isaac(c.IGNORELIST_ADD),this.out.p8(_)};removeIgnore=(_)=>{if(_===0n)return;for(let R=0;R<this.ignoreCount;R++)if(this.ignoreName37[R]===_){this.ignoreCount--,this.redrawSidebar=!0;for(let L=R;L<this.ignoreCount;L++)this.ignoreName37[L]=this.ignoreName37[L+1];this.out.p1isaac(c.IGNORELIST_DEL),this.out.p8(_);return}};sortObjStacks=(_,R)=>{let L=this.levelObjStacks[this.currentLevel][_][R];if(!L){this.scene?.removeObjStack(this.currentLevel,_,R);return}let G=-99999999,K=null;for(let N=L.head();N;N=L.next()){let I=Y0.get(N.index),k=I.cost;if(I.stackable)k*=N.count+1;if(k>G)G=k,K=N}if(!K)return;L.addHead(K);let Q=-1,H=-1,$=0,J=0;for(let N=L.head();N;N=L.next()){if(N.index!==K.index&&Q===-1)Q=N.index,$=N.count;if(N.index!==K.index&&N.index!==Q&&H===-1)H=N.index,J=N.count}let O=null;if(Q!==-1)O=Y0.get(Q).getInterfaceModel($);let q=null;if(H!==-1)q=Y0.get(H).getInterfaceModel(J);let b=_+(R<<7)+1610612736|0,U=Y0.get(K.index);this.scene?.addObjStack(_,R,this.getHeightmapY(this.currentLevel,_*128+64,R*128+64),this.currentLevel,b,U.getInterfaceModel(K.count),q,O)};addLoc=(_,R,L,G,K,Q,H)=>{if(R<1||L<1||R>102||L>102)return;if(d.lowMemory&&_!==this.currentLevel)return;if(!this.scene)return;let $=0;if(H===N0.WALL)$=this.scene.getWallBitset(_,R,L);if(H===N0.WALL_DECOR)$=this.scene.getWallDecorationBitset(_,L,R);if(H===N0.GROUND)$=this.scene.getLocBitset(_,R,L);if(H===N0.GROUND_DECOR)$=this.scene.getGroundDecorationBitset(_,R,L);if($!==0){let J=this.scene.getInfo(_,R,L,$),O=$>>14&32767,q=J&31,b=J>>6;if(H===N0.WALL){this.scene?.removeWall(_,R,L,1);let U=B0.get(O);if(U.blockwalk)this.levelCollisionMap[_]?.removeWall(R,L,q,b,U.blockrange)}if(H===N0.WALL_DECOR)this.scene?.removeWallDecoration(_,R,L);if(H===N0.GROUND){this.scene.removeLoc(_,R,L);let U=B0.get(O);if(R+U.width>s.SIZE-1||L+U.width>s.SIZE-1||R+U.length>s.SIZE-1||L+U.length>s.SIZE-1)return;if(U.blockwalk)this.levelCollisionMap[_]?.removeLoc(R,L,U.width,U.length,b,U.blockrange)}if(H===N0.GROUND_DECOR){this.scene?.removeGroundDecoration(_,R,L);let U=B0.get(O);if(U.blockwalk&&U.active)this.levelCollisionMap[_]?.removeFloor(R,L)}}if(G>=0){let J=_;if(this.levelTileFlags&&_<3&&(this.levelTileFlags[1][R][L]&2)===2)J=_+1;if(this.levelHeightmap)H0.addLoc(_,R,L,this.scene,this.levelHeightmap,this.locList,this.levelCollisionMap[_],G,Q,K,J)}};closeInterfaces=()=>{if(this.out.p1isaac(c.CLOSE_MODAL),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1};async tryReconnect(){if(this.idleTimeout>0)await this.logout();else if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",X.BLACK),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",X.WHITE),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",X.BLACK),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",X.WHITE),this.areaViewport?.draw(8,11),this.flagSceneTileX=0,this.stream?.close(),this.ingame=!1,await this.login(this.username,this.password,!0),!this.ingame)await this.logout()}logout=async()=>{if(this.stream)this.stream.close();this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",S0.setDisabled(),this.clearCaches(),this.scene?.reset();for(let _=0;_<s.LEVELS;_++)this.levelCollisionMap[_]?.reset();if(D8(!1),this.currentMidi=null,this.nextMusicDelay=0,!d.lowMemory)await this.setMidi("scape_main",12345678,40000,!1)};read=async()=>{if(!this.stream)return!1;try{let _=this.stream.available;if(_===0)return!1;if(this.packetType===-1){if(await this.stream.readBytes(this.in.data,0,1),this.packetType=this.in.data[0]&255,this.randomIn)this.packetType=this.packetType-this.randomIn.nextInt&255;this.packetSize=v8.SERVERPROT_SIZES[this.packetType],_--}if(this.packetSize===-1){if(_<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.packetSize=this.in.data[0]&255,_--}if(this.packetSize===-2){if(_<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.packetSize=this.in.g2,_-=2}if(_<this.packetSize)return!1;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.packetSize),this.idleNetCycles=0,this.lastPacketType2=this.lastPacketType1,this.lastPacketType1=this.lastPacketType0,this.lastPacketType0=this.packetType,this.packetType===t.VARP_SMALL){let R=this.in.g2,L=this.in.g1b;if(this.varCache[R]=L,this.varps[R]!==L){if(this.varps[R]=L,await this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.packetType=-1,!0}if(this.packetType===t.UPDATE_FRIENDLIST){let R=this.in.g8,L=this.in.g1,G=I0.formatName(I0.fromBase37(R));for(let Q=0;Q<this.friendCount;Q++)if(R===this.friendName37[Q]){if(this.friendWorld[Q]!==L){if(this.friendWorld[Q]=L,this.redrawSidebar=!0,L>0)this.addMessage(5,G+" has logged in.","");if(L===0)this.addMessage(5,G+" has logged out.","")}G=null;break}if(G&&this.friendCount<100)this.friendName37[this.friendCount]=R,this.friendName[this.friendCount]=G,this.friendWorld[this.friendCount]=L,this.friendCount++,this.redrawSidebar=!0;let K=!1;while(!K){K=!0;for(let Q=0;Q<this.friendCount-1;Q++)if(this.friendWorld[Q]!==d.nodeId&&this.friendWorld[Q+1]===d.nodeId||this.friendWorld[Q]===0&&this.friendWorld[Q+1]!==0){let H=this.friendWorld[Q];this.friendWorld[Q]=this.friendWorld[Q+1],this.friendWorld[Q+1]=H;let $=this.friendName[Q];this.friendName[Q]=this.friendName[Q+1],this.friendName[Q+1]=$;let J=this.friendName37[Q];this.friendName37[Q]=this.friendName37[Q+1],this.friendName37[Q+1]=J,this.redrawSidebar=!0,K=!1}}return this.packetType=-1,!0}if(this.packetType===t.UPDATE_REBOOT_TIMER)return this.systemUpdateTimer=this.in.g2*30,this.packetType=-1,!0;if(this.packetType===t.DATA_LAND_DONE){let R=this.in.g1,L=this.in.g1,G=-1;if(this.sceneMapIndex){for(let K=0;K<this.sceneMapIndex.length;K++)if(this.sceneMapIndex[K]===(R<<8)+L)G=K}if(G!==-1){let K=this.sceneMapLandData;if(K){let Q=K[G];if(G!==-1&&Q)this.db?.cachesave(`m${R}_${L}`,Q),this.sceneState=1}}return this.packetType=-1,!0}if(this.packetType===t.NPC_INFO)return this.readNpcInfo(this.in,this.packetSize),this.packetType=-1,!0;if(this.packetType===t.REBUILD_NORMAL){let R=this.in.g2,L=this.in.g2;if(this.sceneCenterZoneX===R&&this.sceneCenterZoneZ===L&&this.sceneState!==0)return this.packetType=-1,!0;this.sceneCenterZoneX=R,this.sceneCenterZoneZ=L,this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8,this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8,this.sceneState=1,this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",X.BLACK),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",X.WHITE),this.areaViewport?.draw(8,11);let G=(this.packetSize-2)/10|0;this.sceneMapLandData=new l(G,null),this.sceneMapLocData=new l(G,null),this.sceneMapIndex=new Int32Array(G),this.out.p1isaac(c.REBUILD_GETMAPS),this.out.p1(0);let K=0;for(let N=0;N<G;N++){let I=this.in.g1,k=this.in.g1,F=this.in.g4,T=this.in.g4;this.sceneMapIndex[N]=(I<<8)+k;let Y;if(F!==0){if(Y=await this.db?.cacheload(`m${I}_${k}`),Y&&p.crc32(Y)!==F)Y=void 0;if(!Y)this.sceneState=0,this.out.p1(0),this.out.p1(I),this.out.p1(k),K+=3;else this.sceneMapLandData[N]=Y}if(T!==0){if(Y=await this.db?.cacheload(`l${I}_${k}`),Y&&p.crc32(Y)!==T)Y=void 0;if(!Y)this.sceneState=0,this.out.p1(1),this.out.p1(I),this.out.p1(k),K+=3;else this.sceneMapLocData[N]=Y}}if(this.out.psize1(K),this.areaViewport?.bind(),this.sceneState===0)this.fontPlain12?.drawStringCenter(257,166,"Map area updated since last visit, so load will take longer this time only",X.BLACK),this.fontPlain12?.drawStringCenter(256,165,"Map area updated since last visit, so load will take longer this time only",X.WHITE);this.areaViewport?.draw(8,11);let Q=this.sceneBaseTileX-this.mapLastBaseX,H=this.sceneBaseTileZ-this.mapLastBaseZ;this.mapLastBaseX=this.sceneBaseTileX,this.mapLastBaseZ=this.sceneBaseTileZ;for(let N=0;N<8192;N++){let I=this.npcs[N];if(I){for(let k=0;k<10;k++)I.pathTileX[k]-=Q,I.pathTileZ[k]-=H;I.x-=Q*128,I.z-=H*128}}for(let N=0;N<this.MAX_PLAYER_COUNT;N++){let I=this.players[N];if(I){for(let k=0;k<10;k++)I.pathTileX[k]-=Q,I.pathTileZ[k]-=H;I.x-=Q*128,I.z-=H*128}}let $=0,J=s.SIZE,O=1;if(Q<0)$=s.SIZE-1,J=-1,O=-1;let q=0,b=s.SIZE,U=1;if(H<0)q=s.SIZE-1,b=-1,U=-1;for(let N=$;N!==J;N+=O)for(let I=q;I!==b;I+=U){let k=N+Q,F=I+H;for(let T=0;T<s.LEVELS;T++)if(k>=0&&F>=0&&k<s.SIZE&&F<s.SIZE)this.levelObjStacks[T][N][I]=this.levelObjStacks[T][k][F];else this.levelObjStacks[T][N][I]=null}for(let N=this.spawnedLocations.head();N;N=this.spawnedLocations.next())if(N.x-=Q,N.z-=H,N.x<0||N.z<0||N.x>=s.SIZE||N.z>=s.SIZE)N.unlink();if(this.flagSceneTileX!==0)this.flagSceneTileX-=Q,this.flagSceneTileZ-=H;return this.cutscene=!1,this.packetType=-1,!0}if(this.packetType===t.IF_SETPLAYERHEAD)return g.instances[this.in.g2].model=this.localPlayer?.getHeadModel()||null,this.packetType=-1,!0;if(this.packetType===t.HINT_ARROW){if(this.hintType=this.in.g1,this.hintType===1)this.hintNpc=this.in.g2;if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2)this.hintOffsetX=64,this.hintOffsetZ=64;if(this.hintType===3)this.hintOffsetX=0,this.hintOffsetZ=64;if(this.hintType===4)this.hintOffsetX=128,this.hintOffsetZ=64;if(this.hintType===5)this.hintOffsetX=64,this.hintOffsetZ=0;if(this.hintType===6)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2,this.hintTileZ=this.in.g2,this.hintHeight=this.in.g1}if(this.hintType===10)this.hintPlayer=this.in.g2;return this.packetType=-1,!0}if(this.packetType===t.MIDI_SONG){let R=this.in.gjstr,L=this.in.g4,G=this.in.g4;if(R!==this.currentMidi&&this.midiActive&&!d.lowMemory)await this.setMidi(R,L,G,!0);return this.currentMidi=R,this.midiCrc=L,this.midiSize=G,this.nextMusicDelay=0,this.packetType=-1,!0}if(this.packetType===t.LOGOUT)return await this.logout(),this.packetType=-1,!1;if(this.packetType===t.DATA_LOC_DONE){let R=this.in.g1,L=this.in.g1,G=-1;if(this.sceneMapIndex){for(let K=0;K<this.sceneMapIndex.length;K++)if(this.sceneMapIndex[K]===(R<<8)+L)G=K}if(G!==-1){let K=this.sceneMapLocData;if(K){let Q=K[G];if(G!==-1&&Q)this.db?.cachesave(`l${R}_${L}`,Q),this.sceneState=1}}return this.packetType=-1,!0}if(this.packetType===t.UNSET_MAP_FLAG)return this.flagSceneTileX=0,this.packetType=-1,!0;if(this.packetType===t.UPDATE_UID192)return this.localPid=this.in.g2,this.packetType=-1,!0;if(this.packetType===t.OBJ_COUNT||this.packetType===t.LOC_MERGE||this.packetType===t.OBJ_REVEAL||this.packetType===t.MAP_ANIM||this.packetType===t.MAP_PROJANIM||this.packetType===t.OBJ_DEL||this.packetType===t.OBJ_ADD||this.packetType===t.LOC_ANIM||this.packetType===t.LOC_DEL||this.packetType===t.LOC_ADD_CHANGE)return this.readZonePacket(this.in,this.packetType),this.packetType=-1,!0;if(this.packetType===t.IF_OPENMAINSIDEMODAL){let R=this.in.g2,L=this.in.g2;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.sidebarInterfaceId=L,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.packetType=-1,!0}if(this.packetType===t.VARP_LARGE){let R=this.in.g2,L=this.in.g4;if(this.varCache[R]=L,this.varps[R]!==L){if(this.varps[R]=L,await this.updateVarp(R),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.packetType=-1,!0}if(this.packetType===t.IF_SETANIM){let R=this.in.g2;return g.instances[R].anim=this.in.g2,this.packetType=-1,!0}if(this.packetType===t.IF_OPENSIDEOVERLAY){let R=this.in.g2,L=this.in.g1;if(R===65535)R=-1;return this.tabInterfaceId[L]=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.packetType=-1,!0}if(this.packetType===t.DATA_LOC){let R=this.in.g1,L=this.in.g1,G=this.in.g2,K=this.in.g2,Q=-1;if(this.sceneMapIndex){for(let H=0;H<this.sceneMapIndex.length;H++)if(this.sceneMapIndex[H]===(R<<8)+L)Q=H}if(Q!==-1&&this.sceneMapLocData){if(!this.sceneMapLocData[Q]||this.sceneMapLocData[Q]?.length!==K)this.sceneMapLocData[Q]=new Uint8Array(K);let H=this.sceneMapLocData[Q];if(H)this.in.gdata(this.packetSize-6,G,H)}return this.packetType=-1,!0}if(this.packetType===t.FINISH_TRACKING){let R=S0.stop();if(R)this.out.p1isaac(c.EVENT_TRACKING),this.out.p2(R.pos),this.out.pdata(R.data,R.pos,0),R.release();return this.packetType=-1,!0}if(this.packetType===t.UPDATE_INV_FULL){this.redrawSidebar=!0;let R=this.in.g2,L=g.instances[R],G=this.in.g1;if(L.invSlotObjId&&L.invSlotObjCount){for(let K=0;K<G;K++){L.invSlotObjId[K]=this.in.g2;let Q=this.in.g1;if(Q===255)Q=this.in.g4;L.invSlotObjCount[K]=Q}for(let K=G;K<L.invSlotObjId.length;K++)L.invSlotObjId[K]=0,L.invSlotObjCount[K]=0}else for(let K=0;K<G;K++)if(this.in.g2,this.in.g1===255)this.in.g4;return this.packetType=-1,!0}if(this.packetType===t.ENABLE_TRACKING)return S0.setEnabled(),this.packetType=-1,!0;if(this.packetType===t.P_COUNTDIALOG)return this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.packetType=-1,!0;if(this.packetType===t.UPDATE_INV_STOP_TRANSMIT){let R=g.instances[this.in.g2];if(R.invSlotObjId)for(let L=0;L<R.invSlotObjId.length;L++)R.invSlotObjId[L]=-1,R.invSlotObjId[L]=0;return this.packetType=-1,!0}if(this.packetType===t.LAST_LOGIN_INFO){if(this.lastAddress=this.in.g4,this.daysSinceLastLogin=this.in.g2,this.daysSinceRecoveriesChanged=this.in.g1,this.unreadMessages=this.in.g2,this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let R=650;if(this.daysSinceRecoveriesChanged!==201)R=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let L=0;L<g.instances.length;L++)if(g.instances[L]&&g.instances[L].clientCode===R){this.viewportInterfaceId=g.instances[L].layer;break}}return this.packetType=-1,!0}if(this.packetType===t.TUTORIAL_FLASHSIDE){if(this.flashingTab=this.in.g1,this.flashingTab===this.selectedTab){if(this.flashingTab===3)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.packetType=-1,!0}if(this.packetType===t.MIDI_JINGLE){if(this.midiActive&&!d.lowMemory){let R=this.in.g2,L=this.in.g4,G=this.packetSize-6;this.nextMusicDelay=R}return this.packetType=-1,!0}if(this.packetType===t.SET_MULTIWAY)return this.inMultizone=this.in.g1,this.packetType=-1,!0;if(this.packetType===t.SYNTH_SOUND){let R=this.in.g2,L=this.in.g1,G=this.in.g2;if(this.waveEnabled&&!d.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=R,this.waveLoops[this.waveCount]=L,this.waveDelay[this.waveCount]=G+Z0.delays[R],this.waveCount++;return this.packetType=-1,!0}if(this.packetType===t.IF_SETNPCHEAD){let R=this.in.g2,L=this.in.g2,G=_1.get(L);return g.instances[R].model=G.getHeadModel(),this.packetType=-1,!0}if(this.packetType===t.UPDATE_ZONE_PARTIAL_FOLLOWS)return this.baseX=this.in.g1,this.baseZ=this.in.g1,this.packetType=-1,!0;if(this.packetType===t.IF_SETRECOL){let R=this.in.g2,L=this.in.g2,G=this.in.g2;return g.instances[R].model?.recolor(L,G),this.packetType=-1,!0}if(this.packetType===t.CHAT_FILTER_SETTINGS)return this.publicChatSetting=this.in.g1,this.privateChatSetting=this.in.g1,this.tradeChatSetting=this.in.g1,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.packetType=-1,!0;if(this.packetType===t.IF_OPENSIDEMODAL){let R=this.in.g2;if(this.resetInterfaceAnimation(R),this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0}if(this.packetType===t.IF_OPENCHATMODAL){let R=this.in.g2;if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=R,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0}if(this.packetType===t.IF_SETPOSITION){let R=this.in.g2,L=this.in.g2b,G=this.in.g2b,K=g.instances[R];return K.x=L,K.y=G,this.packetType=-1,!0}if(this.packetType===t.CAM_MOVETO){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1,this.cutsceneSrcLocalTileZ=this.in.g1,this.cutsceneSrcHeight=this.in.g2,this.cutsceneMoveSpeed=this.in.g1,this.cutsceneMoveAcceleration=this.in.g1,this.cutsceneMoveAcceleration>=100)this.cameraX=this.cutsceneSrcLocalTileX*128+64,this.cameraZ=this.cutsceneSrcLocalTileZ*128+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.packetType=-1,!0}if(this.packetType===t.UPDATE_ZONE_FULL_FOLLOWS){this.baseX=this.in.g1,this.baseZ=this.in.g1;for(let R=this.baseX;R<this.baseX+8;R++)for(let L=this.baseZ;L<this.baseZ+8;L++)if(this.levelObjStacks[this.currentLevel][R][L])this.levelObjStacks[this.currentLevel][R][L]=null,this.sortObjStacks(R,L);for(let R=this.spawnedLocations.head();R;R=this.spawnedLocations.next())if(R.x>=this.baseX&&R.x<this.baseX+8&&R.z>=this.baseZ&&R.z<this.baseZ+8&&R.plane===this.currentLevel)this.addLoc(R.plane,R.x,R.z,R.lastLocIndex,R.lastAngle,R.lastShape,R.layer),R.unlink();return this.packetType=-1,!0}if(this.packetType===t.DATA_LAND){let R=this.in.g1,L=this.in.g1,G=this.in.g2,K=this.in.g2,Q=-1;if(this.sceneMapIndex){for(let H=0;H<this.sceneMapIndex.length;H++)if(this.sceneMapIndex[H]===(R<<8)+L)Q=H}if(Q!==-1&&this.sceneMapLandData){if(!this.sceneMapLandData[Q]||this.sceneMapLandData[Q]?.length!==K)this.sceneMapLandData[Q]=new Uint8Array(K);let H=this.sceneMapLandData[Q];if(H)this.in.gdata(this.packetSize-6,G,H)}return this.packetType=-1,!0}if(this.packetType===t.MESSAGE_PRIVATE){let R=this.in.g8,L=this.in.g4,G=this.in.g1,K=!1;for(let Q=0;Q<100;Q++)if(this.messageIds[Q]===L){K=!0;break}if(G<=1){for(let Q=0;Q<this.ignoreCount;Q++)if(this.ignoreName37[Q]===R){K=!0;break}}if(!K&&this.overrideChat===0)try{this.messageIds[this.privateMessageCount]=L,this.privateMessageCount=(this.privateMessageCount+1)%100;let Q=m1.unpack(this.in,this.packetSize-13),H=j1.filter(Q);if(G>1)this.addMessage(7,H,I0.formatName(I0.fromBase37(R)));else this.addMessage(3,H,I0.formatName(I0.fromBase37(R)))}catch(Q){}return this.packetType=-1,!0}if(this.packetType===t.RESET_CLIENT_VARCACHE){for(let R=0;R<this.varps.length;R++)if(this.varps[R]!==this.varCache[R])this.varps[R]=this.varCache[R],await this.updateVarp(R),this.redrawSidebar=!0;return this.packetType=-1,!0}if(this.packetType===t.IF_SETMODEL){let R=this.in.g2,L=this.in.g2;return g.instances[R].model=E.model(L),this.packetType=-1,!0}if(this.packetType===t.TUTORIAL_OPENCHAT)return this.stickyChatInterfaceId=this.in.g2b,this.redrawChatback=!0,this.packetType=-1,!0;if(this.packetType===t.UPDATE_RUNENERGY){if(this.selectedTab===12)this.redrawSidebar=!0;return this.energy=this.in.g1,this.packetType=-1,!0}if(this.packetType===t.CAM_LOOKAT){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1,this.cutsceneDstLocalTileZ=this.in.g1,this.cutsceneDstHeight=this.in.g2,this.cutsceneRotateSpeed=this.in.g1,this.cutsceneRotateAcceleration=this.in.g1,this.cutsceneRotateAcceleration>=100){let R=this.cutsceneDstLocalTileX*128+64,L=this.cutsceneDstLocalTileZ*128+64,G=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,K=R-this.cameraX,Q=G-this.cameraY,H=L-this.cameraZ,$=Math.sqrt(K*K+H*H)|0;if(this.cameraPitch=(Math.atan2(Q,$)*325.949|0)&2047,this.cameraYaw=(Math.atan2(K,H)*-325.949|0)&2047,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}return this.packetType=-1,!0}if(this.packetType===t.IF_SHOWSIDE)return this.selectedTab=this.in.g1,this.redrawSidebar=!0,this.redrawSideicons=!0,this.packetType=-1,!0;if(this.packetType===t.MESSAGE_GAME){let R=this.in.gjstr,L;if(R.endsWith(":tradereq:")){let G=R.substring(0,R.indexOf(":"));L=I0.toBase37(G);let K=!1;for(let Q=0;Q<this.ignoreCount;Q++)if(this.ignoreName37[Q]===L){K=!0;break}if(!K&&this.overrideChat===0)this.addMessage(4,"wishes to trade with you.",G)}else if(R.endsWith(":duelreq:")){let G=R.substring(0,R.indexOf(":"));L=I0.toBase37(G);let K=!1;for(let Q=0;Q<this.ignoreCount;Q++)if(this.ignoreName37[Q]===L){K=!0;break}if(!K&&this.overrideChat===0)this.addMessage(8,"wishes to duel with you.",G)}else this.addMessage(0,R,"");return this.packetType=-1,!0}if(this.packetType===t.IF_SETOBJECT){let R=this.in.g2,L=this.in.g2,G=this.in.g2,K=Y0.get(L);return g.instances[R].model=K.getInterfaceModel(50),g.instances[R].xan=K.xan2d,g.instances[R].yan=K.yan2d,g.instances[R].zoom=K.zoom2d*100/G|0,this.packetType=-1,!0}if(this.packetType===t.IF_OPENMAINMODAL){let R=this.in.g2;if(this.resetInterfaceAnimation(R),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=R,this.pressedContinueOption=!1,this.packetType=-1,!0}if(this.packetType===t.IF_SETCOLOUR){let R=this.in.g2,L=this.in.g2,G=L>>10&31,K=L>>5&31,Q=L&31;return g.instances[R].colour=(G<<19)+(K<<11)+(Q<<3),this.packetType=-1,!0}if(this.packetType===t.RESET_ANIMS){for(let R=0;R<this.players.length;R++){let L=this.players[R];if(!L)continue;L.primarySeqId=-1}for(let R=0;R<this.npcs.length;R++){let L=this.npcs[R];if(!L)continue;L.primarySeqId=-1}return this.packetType=-1,!0}if(this.packetType===t.IF_SETHIDE){let R=this.in.g2;return g.instances[R].hide=this.in.g1===1,this.packetType=-1,!0}if(this.packetType===t.UPDATE_IGNORELIST){this.ignoreCount=this.packetSize/8|0;for(let R=0;R<this.ignoreCount;R++)this.ignoreName37[R]=this.in.g8;return this.packetType=-1,!0}if(this.packetType===t.CAM_RESET){this.cutscene=!1;for(let R=0;R<5;R++)this.cameraModifierEnabled[R]=!1;return this.packetType=-1,!0}if(this.packetType===t.IF_CLOSE){if(this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0}if(this.packetType===t.IF_SETTEXT){let R=this.in.g2;if(g.instances[R].text=this.in.gjstr,g.instances[R].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.packetType=-1,!0}if(this.packetType===t.UPDATE_STAT){this.redrawSidebar=!0;let R=this.in.g1,L=this.in.g4,G=this.in.g1;this.skillExperience[R]=L,this.skillLevel[R]=G,this.skillBaseLevel[R]=1;for(let K=0;K<98;K++)if(L>=this.levelExperience[K])this.skillBaseLevel[R]=K+2;return this.packetType=-1,!0}if(this.packetType===t.UPDATE_ZONE_PARTIAL_ENCLOSED){this.baseX=this.in.g1,this.baseZ=this.in.g1;while(this.in.pos<this.packetSize){let R=this.in.g1;this.readZonePacket(this.in,R)}return this.packetType=-1,!0}if(this.packetType===t.UPDATE_RUNWEIGHT){if(this.selectedTab===12)this.redrawSidebar=!0;return this.weightCarried=this.in.g2b,this.packetType=-1,!0}if(this.packetType===t.CAM_SHAKE){let R=this.in.g1,L=this.in.g1,G=this.in.g1,K=this.in.g1;return this.cameraModifierEnabled[R]=!0,this.cameraModifierJitter[R]=L,this.cameraModifierWobbleScale[R]=G,this.cameraModifierWobbleSpeed[R]=K,this.cameraModifierCycle[R]=0,this.packetType=-1,!0}if(this.packetType===t.UPDATE_INV_PARTIAL){this.redrawSidebar=!0;let R=this.in.g2,L=g.instances[R];while(this.in.pos<this.packetSize){let G=this.in.g1,K=this.in.g2,Q=this.in.g1;if(Q===255)Q=this.in.g4;if(L.invSlotObjId&&L.invSlotObjCount&&G>=0&&G<L.invSlotObjId.length)L.invSlotObjId[G]=K,L.invSlotObjCount[G]=Q}return this.packetType=-1,!0}if(this.packetType===t.PLAYER_INFO){if(this.lastTickFlag=!this.lastTickFlag,this.readPlayerInfo(this.in,this.packetSize),this.sceneState===1)this.sceneState=2,H0.levelBuilt=this.currentLevel,this.buildScene();if(d.lowMemory&&this.sceneState===2&&H0.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",X.BLACK),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",X.WHITE),this.areaViewport?.draw(8,11),H0.levelBuilt=this.currentLevel,this.buildScene();if(this.currentLevel!==this.minimapLevel&&this.sceneState===2)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel);return this.packetType=-1,!0}await this.logout()}catch(_){await this.tryReconnect()}return!0};buildScene=()=>{try{this.minimapLevel=-1,this.temporaryLocs.clear(),this.locList.clear(),this.spotanims.clear(),this.projectiles.clear(),h.clearTexels(),this.clearCaches(),this.scene?.reset();for(let L=0;L<s.LEVELS;L++)this.levelCollisionMap[L]?.reset();let _=new H0(s.SIZE,s.SIZE,this.levelHeightmap,this.levelTileFlags);H0.lowMemory=d.lowMemory;let R=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let L=0;L<R;L++){let G=this.sceneMapIndex[L]>>8,K=this.sceneMapIndex[L]&255;if(G===33&&K>=71&&K<=73){H0.lowMemory=!1;break}}if(d.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(c.NO_TIMEOUT);for(let L=0;L<R;L++){let G=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX,K=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ,Q=this.sceneMapLandData[L];if(Q){let H=new p(Q).g4,$=B1.decompress(Q,H,!0,!0);_.readLandscape((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,G,K,$)}else if(this.sceneCenterZoneZ<800)_.clearLandscape(K,G,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(c.NO_TIMEOUT);for(let L=0;L<R;L++){let G=this.sceneMapLocData[L];if(G){let K=new p(G).g4,Q=B1.decompress(G,K,!0,!0),H=(this.sceneMapIndex[L]>>8)*64-this.sceneBaseTileX,$=(this.sceneMapIndex[L]&255)*64-this.sceneBaseTileZ;_.readLocs(this.scene,this.locList,this.levelCollisionMap,Q,H,$)}}}this.out.p1isaac(c.NO_TIMEOUT),_.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(c.NO_TIMEOUT);for(let L=this.locList.head();L;L=this.locList.next())if((this.levelTileFlags&&this.levelTileFlags[1][L.heightmapNE][L.heightmapNW]&2)===2){if(L.heightmapSW--,L.heightmapSW<0)L.unlink()}for(let L=0;L<s.SIZE;L++)for(let G=0;G<s.SIZE;G++)this.sortObjStacks(L,G);for(let L=this.spawnedLocations.head();L;L=this.spawnedLocations.next())this.addLoc(L.plane,L.x,L.z,L.locIndex,L.angle,L.shape,L.layer)}catch(_){}B0.modelCacheStatic?.clear(),h.initPool(20)};resetInterfaceAnimation=(_)=>{let R=g.instances[_];if(!R.childId)return;for(let L=0;L<R.childId.length&&R.childId[L]!==-1;L++){let G=g.instances[R.childId[L]];if(G.type===1)this.resetInterfaceAnimation(G.id);G.seqFrame=0,G.seqCycle=0}};initializeLevelExperience=()=>{let _=0;for(let R=0;R<99;R++){let L=R+1,G=L+Math.pow(2,L/7)*300|0;_+=G,this.levelExperience[R]=_/4|0}};addMessage=(_,R,L)=>{if(_===0&&this.stickyChatInterfaceId!==-1)this.modalMessage=R,this.mouseClickButton=0;if(this.chatInterfaceId===-1)this.redrawChatback=!0;for(let G=99;G>0;G--)this.messageType[G]=this.messageType[G-1],this.messageSender[G]=this.messageSender[G-1],this.messageText[G]=this.messageText[G-1];this.messageType[0]=_,this.messageSender[0]=L,this.messageText[0]=R};updateVarp=async(_)=>{let R=F1.instances[_].clientcode;if(R!==0){let L=this.varps[_];if(R===1){if(L===1)h.setBrightness(0.9);if(L===2)h.setBrightness(0.8);if(L===3)h.setBrightness(0.7);if(L===4)h.setBrightness(0.6);Y0.iconCache?.clear(),this.redrawTitleBackground=!0}if(R===3){let G=this.midiActive;if(L===0)this.midiVolume=256,K8(256),this.midiActive=!0;if(L===1)this.midiVolume=192,K8(192),this.midiActive=!0;if(L===2)this.midiVolume=128,K8(128),this.midiActive=!0;if(L===3)this.midiVolume=64,K8(64),this.midiActive=!0;if(L===4)this.midiActive=!1;if(this.midiActive!==G){if(this.midiActive&&this.currentMidi)await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1);else D8(!1);this.nextMusicDelay=0}}if(R===4){if(L===0)this.waveVolume=256,v1(256),this.waveEnabled=!0;if(L===1)this.waveVolume=192,v1(192),this.waveEnabled=!0;if(L===2)this.waveVolume=128,v1(128),this.waveEnabled=!0;if(L===3)this.waveVolume=64,v1(64),this.waveEnabled=!0;if(L===4)this.waveEnabled=!1}if(R===5)this.mouseButtonsOption=L;if(R===6)this.chatEffects=L;if(R===8)this.splitPrivateChat=L,this.redrawChatback=!0}};handleChatMouseInput=(_,R)=>{let L=0;for(let G=0;G<100;G++){if(!this.messageText[G])continue;let K=this.messageType[G],Q=this.chatScrollOffset+70+4-L*14;if(Q<-20)break;if(K===0)L++;if((K===1||K===2)&&(K===1||this.publicChatSetting===0||this.publicChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q&&this.localPlayer&&this.messageSender[G]!==this.localPlayer.name){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=406,this.menuSize++}L++}if((K===3||K===7)&&this.splitPrivateChat===0&&(K===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=406,this.menuSize++}L++}if(K===4&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q)this.menuOption[this.menuSize]="Accept trade @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=903,this.menuSize++;L++}if((K===5||K===6)&&this.splitPrivateChat===0&&this.privateChatSetting<2)L++;if(K===8&&(this.tradeChatSetting===0||this.tradeChatSetting===1&&this.isFriend(this.messageSender[G]))){if(R>Q-14&&R<=Q)this.menuOption[this.menuSize]="Accept duel @whi@"+this.messageSender[G],this.menuAction[this.menuSize]=363,this.menuSize++;L++}}};handlePrivateChatInput=(_)=>{if(this.splitPrivateChat===0)return;let R=0;if(this.systemUpdateTimer!==0)R=1;for(let L=0;L<100;L++)if(this.messageText[L]!==null){let G=this.messageType[L];if((G===3||G===7)&&(G===7||this.privateChatSetting===0||this.privateChatSetting===1&&this.isFriend(this.messageSender[L]))){let K=329-R*13;if(this.mouseX>8&&this.mouseX<520&&_-11>K-10&&_-11<=K+3){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageSender[L],this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageSender[L],this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageSender[L],this.menuAction[this.menuSize]=2406,this.menuSize++}if(R++,R>=5)return}if((G===5||G===6)&&this.privateChatSetting<2){if(R++,R>=5)return}}};handleInterfaceInput=(_,R,L,G,K,Q)=>{if(_.type!==0||!_.childId||_.hide||R<G||L<K||R>G+_.width||L>K+_.height||!_.childX||!_.childY)return;let H=_.childId.length;for(let $=0;$<H;$++){let J=_.childX[$]+G,O=_.childY[$]+K-Q,q=g.instances[_.childId[$]];if(J+=q.x,O+=q.y,(q.overLayer>=0||q.overColour!==0)&&R>=J&&L>=O&&R<J+q.width&&L<O+q.height)if(q.overLayer>=0)this.lastHoveredInterfaceId=q.overLayer;else this.lastHoveredInterfaceId=q.id;if(q.type===0){if(this.handleInterfaceInput(q,R,L,J,O,q.scrollPosition),q.scroll>q.height)this.handleScrollInput(R,L,q.scroll,q.height,!0,J+q.width,O,q)}else if(q.type===2){let b=0;for(let U=0;U<q.height;U++)for(let N=0;N<q.width;N++){let I=J+N*(q.marginX+32),k=O+U*(q.marginY+32);if(b<20&&q.invSlotOffsetX&&q.invSlotOffsetY)I+=q.invSlotOffsetX[b],k+=q.invSlotOffsetY[b];if(R<I||L<k||R>=I+32||L>=k+32){b++;continue}if(this.hoveredSlot=b,this.hoveredSlotParentId=q.id,!q.invSlotObjId||q.invSlotObjId[b]<=0){b++;continue}let F=Y0.get(q.invSlotObjId[b]-1);if(this.objSelected===1&&q.interactable){if(q.id!==this.objSelectedInterface||b!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+F.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(this.spellSelected===1&&q.interactable){if((this.activeSpellFlags&16)===16)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+F.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else{if(q.interactable){for(let T=4;T>=3;T--)if(F.iop&&F.iop[T]){if(this.menuOption[this.menuSize]=F.iop[T]+" @lre@"+F.name,T===3)this.menuAction[this.menuSize]=478;else if(T===4)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(T===4)this.menuOption[this.menuSize]="Drop @lre@"+F.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++}if(q.usable)this.menuOption[this.menuSize]="Use @lre@"+F.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++;if(q.interactable&&F.iop){for(let T=2;T>=0;T--)if(F.iop[T]){if(this.menuOption[this.menuSize]=F.iop[T]+" @lre@"+F.name,T===0)this.menuAction[this.menuSize]=405;else if(T===1)this.menuAction[this.menuSize]=38;else if(T===2)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++}}if(q.iops){for(let T=4;T>=0;T--)if(q.iops[T]){if(this.menuOption[this.menuSize]=q.iops[T]+" @lre@"+F.name,T===0)this.menuAction[this.menuSize]=602;else if(T===1)this.menuAction[this.menuSize]=596;else if(T===2)this.menuAction[this.menuSize]=22;else if(T===3)this.menuAction[this.menuSize]=892;else if(T===4)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=F.id,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=q.id,this.menuSize++}}if(this.menuOption[this.menuSize]="Examine @lre@"+F.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=F.id,q.invSlotObjCount)this.menuParamC[this.menuSize]=q.invSlotObjCount[b];this.menuSize++}b++}}else if(R>=J&&L>=O&&R<J+q.width&&L<O+q.height){if(q.buttonType===g.BUTTON_OK){let b=!1;if(q.clientCode!==0)b=this.handleSocialMenuOption(q);if(!b&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(q.buttonType===g.BUTTON_TARGET&&this.spellSelected===0){let b=q.actionVerb;if(b&&b.indexOf(" ")!==-1)b=b.substring(0,b.indexOf(" "));this.menuOption[this.menuSize]=b+" @gre@"+q.action,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=q.id,this.menuSize++}else if(q.buttonType===g.BUTTON_CLOSE)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=q.id,this.menuSize++;else if(q.buttonType===g.BUTTON_TOGGLE&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=q.id,this.menuSize++;else if(q.buttonType===g.BUTTON_SELECT&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=q.id,this.menuSize++;else if(q.buttonType===g.BUTTON_CONTINUE&&!this.pressedContinueOption&&q.option)this.menuOption[this.menuSize]=q.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=q.id,this.menuSize++}}};handleSocialMenuOption=(_)=>{let R=_.clientCode;if(R>=g.CC_FRIENDS_START&&R<=g.CC_FRIENDS_UPDATE_END){if(R>=g.CC_FRIENDS_UPDATE_START)R-=g.CC_FRIENDS_UPDATE_START;else R--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[R],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[R],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(R>=g.CC_IGNORES_START&&R<=g.CC_IGNORES_END)return this.menuOption[this.menuSize]="Remove @whi@"+_.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1};handleViewportOptions=()=>{if(this.objSelected===0&&this.spellSelected===0)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let _=-1;for(let R=0;R<E.pickedCount;R++){let L=E.pickedBitsets[R],G=L&127,K=L>>7&127,Q=L>>29&3,H=L>>14&32767;if(L===_)continue;if(_=L,Q===2&&this.scene&&this.scene.getInfo(this.currentLevel,G,K,L)>=0){let $=B0.get(H);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+$.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=L,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++;else if(this.spellSelected!==1){if($.op){for(let J=4;J>=0;J--)if($.op[J]){if(this.menuOption[this.menuSize]=$.op[J]+" @cya@"+$.name,J===0)this.menuAction[this.menuSize]=285;if(J===1)this.menuAction[this.menuSize]=504;if(J===2)this.menuAction[this.menuSize]=364;if(J===3)this.menuAction[this.menuSize]=581;if(J===4)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=L,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++}}this.menuOption[this.menuSize]="Examine @cya@"+$.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=L,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++}else if((this.activeSpellFlags&4)===4)this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+$.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=L,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++}if(Q===1){let $=this.npcs[H];if($&&$.type&&$.type.size===1&&($.x&127)===64&&($.z&127)===64)for(let J=0;J<this.npcCount;J++){let O=this.npcs[this.npcIds[J]];if(O&&O!==$&&O.type&&O.type.size===1&&O.x===$.x&&O.z===$.z)this.addNpcOptions(O.type,this.npcIds[J],G,K)}if($&&$.type)this.addNpcOptions($.type,H,G,K)}if(Q===0){let $=this.players[H];if($&&($.x&127)===64&&($.z&127)===64){for(let J=0;J<this.npcCount;J++){let O=this.npcs[this.npcIds[J]];if(O&&O.type&&O.type.size===1&&O.x===$.x&&O.z===$.z)this.addNpcOptions(O.type,this.npcIds[J],G,K)}for(let J=0;J<this.playerCount;J++){let O=this.players[this.playerIds[J]];if(O&&O!==$&&O.x===$.x&&O.z===$.z)this.addPlayerOptions(O,this.playerIds[J],G,K)}}if($)this.addPlayerOptions($,H,G,K)}if(Q===3){let $=this.levelObjStacks[this.currentLevel][G][K];if(!$)continue;for(let J=$.tail();J;J=$.prev()){let O=Y0.get(J.index);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+O.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=J.index,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++;else if(this.spellSelected!==1){for(let q=4;q>=0;q--)if(O.op&&O.op[q]){if(this.menuOption[this.menuSize]=O.op[q]+" @lre@"+O.name,q===0)this.menuAction[this.menuSize]=224;if(q===1)this.menuAction[this.menuSize]=993;if(q===2)this.menuAction[this.menuSize]=99;if(q===3)this.menuAction[this.menuSize]=746;if(q===4)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=J.index,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++}else if(q===2)this.menuOption[this.menuSize]="Take @lre@"+O.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=J.index,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+O.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=J.index,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++}else if((this.activeSpellFlags&1)===1)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+O.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=J.index,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=K,this.menuSize++}}}};addNpcOptions=(_,R,L,G)=>{if(this.menuSize>=400)return;let K=_.name;if(_.vislevel!==0&&this.localPlayer)K=K+this.getCombatLevelColorTag(this.localPlayer.combatLevel,_.vislevel)+" (level-"+_.vislevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+K,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++;else if(this.spellSelected!==1){let Q;if(_.op){for(Q=4;Q>=0;Q--)if(_.op[Q]&&_.op[Q]?.toLowerCase()!=="attack"){if(this.menuOption[this.menuSize]=_.op[Q]+" @yel@"+K,Q===0)this.menuAction[this.menuSize]=728;else if(Q===1)this.menuAction[this.menuSize]=542;else if(Q===2)this.menuAction[this.menuSize]=6;else if(Q===3)this.menuAction[this.menuSize]=963;else if(Q===4)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++}}if(_.op){for(Q=4;Q>=0;Q--)if(_.op[Q]&&_.op[Q]?.toLowerCase()==="attack"){let H=0;if(this.localPlayer&&_.vislevel>this.localPlayer.combatLevel)H=2000;if(this.menuOption[this.menuSize]=_.op[Q]+" @yel@"+K,Q===0)this.menuAction[this.menuSize]=H+728;else if(Q===1)this.menuAction[this.menuSize]=H+542;else if(Q===2)this.menuAction[this.menuSize]=H+6;else if(Q===3)this.menuAction[this.menuSize]=H+963;else if(Q===4)this.menuAction[this.menuSize]=H+245;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++}}this.menuOption[this.menuSize]="Examine @yel@"+K,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++}else if((this.activeSpellFlags&2)===2)this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+K,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++};addPlayerOptions=(_,R,L,G)=>{if(_===this.localPlayer||this.menuSize>=400)return;let K=null;if(this.localPlayer)K=_.name+this.getCombatLevelColorTag(this.localPlayer.combatLevel,_.combatLevel)+" (level-"+_.combatLevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+K,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++;else if(this.spellSelected!==1){if(this.menuOption[this.menuSize]="Follow @whi@"+K,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++,this.overrideChat===0)this.menuOption[this.menuSize]="Trade with @whi@"+K,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+K,this.localPlayer&&this.localPlayer.combatLevel>=_.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++}if(this.worldLocationState===1)this.menuOption[this.menuSize]="Fight @whi@"+K,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++;if(this.worldLocationState===2)this.menuOption[this.menuSize]="Duel-with @whi@"+K,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++}else if((this.activeSpellFlags&8)===8)this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+K,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=L,this.menuParamC[this.menuSize]=G,this.menuSize++;for(let Q=0;Q<this.menuSize;Q++)if(this.menuAction[Q]===660){this.menuOption[Q]="Walk here @whi@"+K;return}};getCombatLevelColorTag=(_,R)=>{let L=_-R;if(L<-9)return"@red@";else if(L<-6)return"@or3@";else if(L<-3)return"@or2@";else if(L<0)return"@or1@";else if(L>9)return"@gre@";else if(L>6)return"@gr3@";else if(L>3)return"@gr2@";else if(L>0)return"@gr1@";else return"@yel@"};handleInput=()=>{if(this.objDragArea===0){if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(this.mouseY),this.lastHoveredInterfaceId=0,this.mouseX>8&&this.mouseY>11&&this.mouseX<520&&this.mouseY<345)if(this.viewportInterfaceId===-1)this.handleViewportOptions();else this.handleInterfaceInput(g.instances[this.viewportInterfaceId],this.mouseX,this.mouseY,8,11,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>562&&this.mouseY>231&&this.mouseX<752&&this.mouseY<492){if(this.sidebarInterfaceId!==-1)this.handleInterfaceInput(g.instances[this.sidebarInterfaceId],this.mouseX,this.mouseY,562,231,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.handleInterfaceInput(g.instances[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,562,231,0)}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>22&&this.mouseY>375&&this.mouseX<431&&this.mouseY<471)if(this.chatInterfaceId===-1)this.handleChatMouseInput(this.mouseX-22,this.mouseY-375);else this.handleInterfaceInput(g.instances[this.chatInterfaceId],this.mouseX,this.mouseY,22,375,0);if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let _=!1;while(!_){_=!0;for(let R=0;R<this.menuSize-1;R++)if(this.menuAction[R]<1000&&this.menuAction[R+1]>1000){let L=this.menuOption[R];this.menuOption[R]=this.menuOption[R+1],this.menuOption[R+1]=L;let G=this.menuAction[R];this.menuAction[R]=this.menuAction[R+1],this.menuAction[R+1]=G;let K=this.menuParamB[R];this.menuParamB[R]=this.menuParamB[R+1],this.menuParamB[R+1]=K;let Q=this.menuParamC[R];this.menuParamC[R]=this.menuParamC[R+1],this.menuParamC[R+1]=Q;let H=this.menuParamA[R];this.menuParamA[R]=this.menuParamA[R+1],this.menuParamA[R+1]=H,_=!1}}}};showContextMenu=()=>{let _=0;if(this.fontBold12){_=this.fontBold12.stringWidth("Choose Option");let K;for(let Q=0;Q<this.menuSize;Q++)if(K=this.fontBold12.stringWidth(this.menuOption[Q]),K>_)_=K}_+=8;let R=this.menuSize*15+21,L,G;if(this.mouseClickX>8&&this.mouseClickY>11&&this.mouseClickX<520&&this.mouseClickY<345){if(L=this.mouseClickX-(_/2|0)-8,L+_>512)L=512-_;else if(L<0)L=0;if(G=this.mouseClickY-11,G+R>334)G=334-R;else if(G<0)G=0;this.menuVisible=!0,this.menuArea=0,this.menuX=L,this.menuY=G,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>562&&this.mouseClickY>231&&this.mouseClickX<752&&this.mouseClickY<492){if(L=this.mouseClickX-(_/2|0)-562,L<0)L=0;else if(L+_>190)L=190-_;if(G=this.mouseClickY-231,G<0)G=0;else if(G+R>261)G=261-R;this.menuVisible=!0,this.menuArea=1,this.menuX=L,this.menuY=G,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>22&&this.mouseClickY>375&&this.mouseClickX<501&&this.mouseClickY<471){if(L=this.mouseClickX-(_/2|0)-22,L<0)L=0;else if(L+_>479)L=479-_;if(G=this.mouseClickY-375,G<0)G=0;else if(G+R>96)G=96-R;this.menuVisible=!0,this.menuArea=2,this.menuX=L,this.menuY=G,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}};tryMove=(_,R,L,G,K,Q,H,$,J,O,q)=>{let b=this.levelCollisionMap[this.currentLevel];if(!b)return!1;let U=s.SIZE,N=s.SIZE;for(let W=0;W<U;W++)for(let P=0;P<N;P++){let z=s.index(W,P);this.bfsDirection[z]=0,this.bfsCost[z]=99999999}let I=_,k=R,F=s.index(_,R);this.bfsDirection[F]=99,this.bfsCost[F]=0;let T=0,Y=0;this.bfsStepX[T]=_,this.bfsStepZ[T++]=R;let u=!1,w=this.bfsStepX.length,B=b.flags;while(Y!==T){if(I=this.bfsStepX[Y],k=this.bfsStepZ[Y],Y=(Y+1)%w,I===L&&k===G){u=!0;break}if(J!==y.WALL_STRAIGHT.id){if((J<y.WALLDECOR_STRAIGHT_OFFSET.id||J===y.CENTREPIECE_STRAIGHT.id)&&b.reachedWall(I,k,L,G,J-1,$)){u=!0;break}if(J<y.CENTREPIECE_STRAIGHT.id&&b.reachedWallDecoration(I,k,L,G,J-1,$)){u=!0;break}}if(Q!==0&&H!==0&&b.reachedLoc(I,k,L,G,Q,H,O)){u=!0;break}let W=this.bfsCost[s.index(I,k)]+1,P=s.index(I-1,k);if(I>0&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_WEST)===S.OPEN)this.bfsStepX[T]=I-1,this.bfsStepZ[T]=k,T=(T+1)%w,this.bfsDirection[P]=2,this.bfsCost[P]=W;if(P=s.index(I+1,k),I<U-1&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_EAST)===S.OPEN)this.bfsStepX[T]=I+1,this.bfsStepZ[T]=k,T=(T+1)%w,this.bfsDirection[P]=8,this.bfsCost[P]=W;if(P=s.index(I,k-1),k>0&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_SOUTH)===S.OPEN)this.bfsStepX[T]=I,this.bfsStepZ[T]=k-1,T=(T+1)%w,this.bfsDirection[P]=1,this.bfsCost[P]=W;if(P=s.index(I,k+1),k<N-1&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_NORTH)===S.OPEN)this.bfsStepX[T]=I,this.bfsStepZ[T]=k+1,T=(T+1)%w,this.bfsDirection[P]=4,this.bfsCost[P]=W;if(P=s.index(I-1,k-1),I>0&&k>0&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_SOUTH_WEST)===0&&(B[s.index(I-1,k)]&S.BLOCK_WEST)===S.OPEN&&(B[s.index(I,k-1)]&S.BLOCK_SOUTH)===S.OPEN)this.bfsStepX[T]=I-1,this.bfsStepZ[T]=k-1,T=(T+1)%w,this.bfsDirection[P]=3,this.bfsCost[P]=W;if(P=s.index(I+1,k-1),I<U-1&&k>0&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_SOUTH_EAST)===0&&(B[s.index(I+1,k)]&S.BLOCK_EAST)===S.OPEN&&(B[s.index(I,k-1)]&S.BLOCK_SOUTH)===S.OPEN)this.bfsStepX[T]=I+1,this.bfsStepZ[T]=k-1,T=(T+1)%w,this.bfsDirection[P]=9,this.bfsCost[P]=W;if(P=s.index(I-1,k+1),I>0&&k<N-1&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_NORTH_WEST)===0&&(B[s.index(I-1,k)]&S.BLOCK_WEST)===S.OPEN&&(B[s.index(I,k+1)]&S.BLOCK_NORTH)===S.OPEN)this.bfsStepX[T]=I-1,this.bfsStepZ[T]=k+1,T=(T+1)%w,this.bfsDirection[P]=6,this.bfsCost[P]=W;if(P=s.index(I+1,k+1),I<U-1&&k<N-1&&this.bfsDirection[P]===0&&(B[P]&S.BLOCK_NORTH_EAST)===0&&(B[s.index(I+1,k)]&S.BLOCK_EAST)===S.OPEN&&(B[s.index(I,k+1)]&S.BLOCK_NORTH)===S.OPEN)this.bfsStepX[T]=I+1,this.bfsStepZ[T]=k+1,T=(T+1)%w,this.bfsDirection[P]=12,this.bfsCost[P]=W}if(this.tryMoveNearest=0,!u){if(q){let W=100;for(let P=1;P<2;P++){for(let z=L-P;z<=L+P;z++)for(let f=G-P;f<=G+P;f++){let m=s.index(z,f);if(z>=0&&f>=0&&z<s.SIZE&&f<s.SIZE&&this.bfsCost[m]<W)W=this.bfsCost[m],I=z,k=f,this.tryMoveNearest=1,u=!0}if(u)break}}if(!u)return!1}Y=0,this.bfsStepX[Y]=I,this.bfsStepZ[Y++]=k;let v=this.bfsDirection[s.index(I,k)],n=v;while(I!==_||k!==R){if(n!==v)v=n,this.bfsStepX[Y]=I,this.bfsStepZ[Y++]=k;if((n&K1.EAST)!==0)I++;else if((n&K1.WEST)!==0)I--;if((n&K1.NORTH)!==0)k++;else if((n&K1.SOUTH)!==0)k--;n=this.bfsDirection[s.index(I,k)]}if(Y>0){w=Math.min(Y,25),Y--;let W=this.bfsStepX[Y],P=this.bfsStepZ[Y];if(K===0)this.out.p1isaac(c.MOVE_GAMECLICK),this.out.p1(w+w+3);else if(K===1)this.out.p1isaac(c.MOVE_MINIMAPCLICK),this.out.p1(w+w+3+14);else if(K===2)this.out.p1isaac(c.MOVE_OPCLICK),this.out.p1(w+w+3);if(this.actionKey[5]===1)this.out.p1(1);else this.out.p1(0);this.out.p2(W+this.sceneBaseTileX),this.out.p2(P+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let z=1;z<w;z++)Y--,this.out.p1(this.bfsStepX[Y]-W),this.out.p1(this.bfsStepZ[Y]-P);return!0}return K!==1};readPlayerInfo=(_,R)=>{this.entityRemovalCount=0,this.entityUpdateCount=0,this.readLocalPlayer(_),this.readPlayers(_),this.readNewPlayers(_,R),this.readPlayerUpdates(_);for(let L=0;L<this.entityRemovalCount;L++){let G=this.entityRemovalIds[L],K=this.players[G];if(!K)continue;if(K.cycle!==this.loopCycle)this.players[G]=null}if(_.pos!==R)throw new Error(`eek! Error packet size mismatch in getplayer pos:${_.pos} psize:${R}`);for(let L=0;L<this.playerCount;L++)if(!this.players[this.playerIds[L]])throw new Error(`eek! ${this.username} null entry in pl list - pos:${L} size:${this.playerCount}`)};readLocalPlayer=(_)=>{if(_.bits(),_.gBit(1)!==0){let L=_.gBit(2);if(L===0)this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX;else if(L===1){let G=_.gBit(3);if(this.localPlayer?.step(!1,G),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}else if(L===2){let G=_.gBit(3);this.localPlayer?.step(!0,G);let K=_.gBit(3);if(this.localPlayer?.step(!0,K),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}else if(L===3){this.currentLevel=_.gBit(2);let G=_.gBit(7),K=_.gBit(7),Q=_.gBit(1);if(this.localPlayer?.move(Q===1,G,K),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX}}};readPlayers=(_)=>{let R=_.gBit(8);if(R<this.playerCount)for(let L=R;L<this.playerCount;L++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[L];if(R>this.playerCount)throw new Error(`eek! ${this.username} Too many players`);this.playerCount=0;for(let L=0;L<R;L++){let G=this.playerIds[L],K=this.players[G];if(_.gBit(1)===0){if(this.playerIds[this.playerCount++]=G,K)K.cycle=this.loopCycle}else{let H=_.gBit(2);if(H===0){if(this.playerIds[this.playerCount++]=G,K)K.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===1){if(this.playerIds[this.playerCount++]=G,K)K.cycle=this.loopCycle;let $=_.gBit(3);if(K?.step(!1,$),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===2){if(this.playerIds[this.playerCount++]=G,K)K.cycle=this.loopCycle;let $=_.gBit(3);K?.step(!0,$);let J=_.gBit(3);if(K?.step(!0,J),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===3)this.entityRemovalIds[this.entityRemovalCount++]=G}}};readNewPlayers=(_,R)=>{let L;while(_.bitPos+10<R*8){if(L=_.gBit(11),L===2047)break;if(!this.players[L]){this.players[L]=new U0;let J=this.playerAppearanceBuffer[L];if(J)this.players[L]?.read(J)}this.playerIds[this.playerCount++]=L;let G=this.players[L];if(G)G.cycle=this.loopCycle;let K=_.gBit(5);if(K>15)K-=32;let Q=_.gBit(5);if(Q>15)Q-=32;let H=_.gBit(1);if(this.localPlayer)G?.move(H===1,this.localPlayer.pathTileX[0]+K,this.localPlayer.pathTileZ[0]+Q);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=L}_.bytes()};readPlayerUpdates=(_)=>{for(let R=0;R<this.entityUpdateCount;R++){let L=this.entityUpdateIds[R],G=this.players[L];if(!G)continue;let K=_.g1;if((K&U0.BIG_UPDATE)===U0.BIG_UPDATE)K+=_.g1<<8;this.readPlayerUpdatesBlocks(G,L,K,_)}};readPlayerUpdatesBlocks=(_,R,L,G)=>{if(_.lastMask=L,_.lastMaskCycle=this.loopCycle,(L&U0.APPEARANCE)===U0.APPEARANCE){let K=G.g1,Q=new Uint8Array(K),H=new p(Q);G.gdata(K,0,Q),this.playerAppearanceBuffer[R]=H,_.read(H)}if((L&U0.ANIM)===U0.ANIM){let K=G.g2;if(K===65535)K=-1;if(K===_.primarySeqId)_.primarySeqLoop=0;let Q=G.g1;if(K===-1||_.primarySeqId===-1||_0.instances[K].priority>_0.instances[_.primarySeqId].priority||_0.instances[_.primarySeqId].priority===0)_.primarySeqId=K,_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=Q,_.primarySeqLoop=0}if((L&U0.FACE_ENTITY)===U0.FACE_ENTITY){if(_.targetId=G.g2,_.targetId===65535)_.targetId=-1}if((L&U0.SAY)===U0.SAY){if(_.chat=G.gjstr,_.chatColor=0,_.chatStyle=0,_.chatTimer=150,_.name)this.addMessage(2,_.chat,_.name)}if((L&U0.DAMAGE)===U0.DAMAGE)_.damage=G.g1,_.damageType=G.g1,_.combatCycle=this.loopCycle+400,_.health=G.g1,_.totalHealth=G.g1;if((L&U0.FACE_COORD)===U0.FACE_COORD)_.targetTileX=G.g2,_.targetTileZ=G.g2,_.lastFaceX=_.targetTileX,_.lastFaceZ=_.targetTileZ;if((L&U0.CHAT)===U0.CHAT){let{g2:K,g1:Q,g1:H,pos:$}=G;if(_.name){let J=I0.toBase37(_.name),O=!1;if(Q<=1){for(let q=0;q<this.ignoreCount;q++)if(this.ignoreName37[q]===J){O=!0;break}}if(!O&&this.overrideChat===0)try{let q=m1.unpack(G,H),b=j1.filter(q);if(_.chat=b,_.chatColor=K>>8,_.chatStyle=K&255,_.chatTimer=150,Q>1)this.addMessage(1,b,_.name);else this.addMessage(2,b,_.name)}catch(q){}}G.pos=$+H}if((L&U0.SPOTANIM)===U0.SPOTANIM){_.spotanimId=G.g2;let K=G.g4;if(_.spotanimOffset=K>>16,_.spotanimLastCycle=this.loopCycle+(K&65535),_.spotanimFrame=0,_.spotanimCycle=0,_.spotanimLastCycle>this.loopCycle)_.spotanimFrame=-1;if(_.spotanimId===65535)_.spotanimId=-1}if((L&U0.EXACT_MOVE)===U0.EXACT_MOVE)_.forceMoveStartSceneTileX=G.g1,_.forceMoveStartSceneTileZ=G.g1,_.forceMoveEndSceneTileX=G.g1,_.forceMoveEndSceneTileZ=G.g1,_.forceMoveEndCycle=G.g2+this.loopCycle,_.forceMoveStartCycle=G.g2+this.loopCycle,_.forceMoveFaceDirection=G.g1,_.pathLength=0,_.pathTileX[0]=_.forceMoveEndSceneTileX,_.pathTileZ[0]=_.forceMoveEndSceneTileZ};readNpcInfo=(_,R)=>{this.entityRemovalCount=0,this.entityUpdateCount=0,this.readNpcs(_),this.readNewNpcs(_,R),this.readNpcUpdates(_);for(let L=0;L<this.entityRemovalCount;L++){let G=this.entityRemovalIds[L],K=this.npcs[G];if(!K)continue;if(K.cycle!==this.loopCycle)K.type=null,this.npcs[G]=null}if(_.pos!==R)throw new Error(`eek! ${this.username} size mismatch in getnpcpos - pos:${_.pos} psize:${R}`);for(let L=0;L<this.npcCount;L++)if(!this.npcs[this.npcIds[L]])throw new Error(`eek! ${this.username} null entry in npc list - pos:${L} size:${this.npcCount}`)};readNpcs=(_)=>{_.bits();let R=_.gBit(8);if(R<this.npcCount)for(let L=R;L<this.npcCount;L++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[L];if(R>this.npcCount)throw new Error(`eek! ${this.username} Too many npcs`);this.npcCount=0;for(let L=0;L<R;L++){let G=this.npcIds[L],K=this.npcs[G];if(_.gBit(1)===0){if(this.npcIds[this.npcCount++]=G,K)K.cycle=this.loopCycle}else{let H=_.gBit(2);if(H===0){if(this.npcIds[this.npcCount++]=G,K)K.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===1){if(this.npcIds[this.npcCount++]=G,K)K.cycle=this.loopCycle;let $=_.gBit(3);if(K?.step(!1,$),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===2){if(this.npcIds[this.npcCount++]=G,K)K.cycle=this.loopCycle;let $=_.gBit(3);K?.step(!0,$);let J=_.gBit(3);if(K?.step(!0,J),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=G}else if(H===3)this.entityRemovalIds[this.entityRemovalCount++]=G}}};readNewNpcs=(_,R)=>{while(_.bitPos+21<R*8){let L=_.gBit(13);if(L===8191)break;if(!this.npcs[L])this.npcs[L]=new f0;let G=this.npcs[L];if(this.npcIds[this.npcCount++]=L,G)G.cycle=this.loopCycle,G.type=_1.get(_.gBit(11)),G.size=G.type.size,G.seqWalkId=G.type.walkanim,G.seqTurnAroundId=G.type.walkanim_b,G.seqTurnLeftId=G.type.walkanim_r,G.seqTurnRightId=G.type.walkanim_l,G.seqStandId=G.type.readyanim;else _.gBit(11);let K=_.gBit(5);if(K>15)K-=32;let Q=_.gBit(5);if(Q>15)Q-=32;if(this.localPlayer)G?.move(!1,this.localPlayer.pathTileX[0]+K,this.localPlayer.pathTileZ[0]+Q);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=L}_.bytes()};readNpcUpdates=(_)=>{for(let R=0;R<this.entityUpdateCount;R++){let L=this.entityUpdateIds[R],G=this.npcs[L];if(!G)continue;let K=_.g1;if(G.lastMask=K,G.lastMaskCycle=this.loopCycle,(K&f0.ANIM)===f0.ANIM){let Q=_.g2;if(Q===65535)Q=-1;if(Q===G.primarySeqId)G.primarySeqLoop=0;let H=_.g1;if(Q===-1||G.primarySeqId===-1||_0.instances[Q].priority>_0.instances[G.primarySeqId].priority||_0.instances[G.primarySeqId].priority===0)G.primarySeqId=Q,G.primarySeqFrame=0,G.primarySeqCycle=0,G.primarySeqDelay=H,G.primarySeqLoop=0}if((K&f0.FACE_ENTITY)===f0.FACE_ENTITY){if(G.targetId=_.g2,G.targetId===65535)G.targetId=-1}if((K&f0.SAY)===f0.SAY)G.chat=_.gjstr,G.chatTimer=100;if((K&f0.DAMAGE)===f0.DAMAGE)G.damage=_.g1,G.damageType=_.g1,G.combatCycle=this.loopCycle+400,G.health=_.g1,G.totalHealth=_.g1;if((K&f0.CHANGE_TYPE)===f0.CHANGE_TYPE)G.type=_1.get(_.g2),G.seqWalkId=G.type.walkanim,G.seqTurnAroundId=G.type.walkanim_b,G.seqTurnLeftId=G.type.walkanim_r,G.seqTurnRightId=G.type.walkanim_l,G.seqStandId=G.type.readyanim;if((K&f0.SPOTANIM)===f0.SPOTANIM){G.spotanimId=_.g2;let Q=_.g4;if(G.spotanimOffset=Q>>16,G.spotanimLastCycle=this.loopCycle+(Q&65535),G.spotanimFrame=0,G.spotanimCycle=0,G.spotanimLastCycle>this.loopCycle)G.spotanimFrame=-1;if(G.spotanimId===65535)G.spotanimId=-1}if((K&f0.FACE_COORD)===f0.FACE_COORD)G.targetTileX=_.g2,G.targetTileZ=_.g2,G.lastFaceX=G.targetTileX,G.lastFaceZ=G.targetTileZ}};updatePlayers=()=>{for(let _=-1;_<this.playerCount;_++){let R;if(_===-1)R=this.LOCAL_PLAYER_INDEX;else R=this.playerIds[_];let L=this.players[R];if(L)this.updateEntity(L)}if(d.cyclelogic6++,d.cyclelogic6>1406){d.cyclelogic6=0,this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC6),this.out.p1(0);let _=this.out.pos;if(this.out.p1(162),this.out.p1(22),(Math.random()*2|0)===0)this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),(Math.random()*2|0)===0)this.out.p1(123);if((Math.random()*2|0)===0)this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-_)}};updateEntity=(_)=>{if(_.x<128||_.z<128||_.x>=13184||_.z>=13184)_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.pathTileX[0]*128+_.size*64,_.z=_.pathTileZ[0]*128+_.size*64,_.pathLength=0;if(_===this.localPlayer&&(_.x<1536||_.z<1536||_.x>=11776||_.z>=11776))_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.pathTileX[0]*128+_.size*64,_.z=_.pathTileZ[0]*128+_.size*64,_.pathLength=0;if(_.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(_);else if(_.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(_);else this.updateMovement(_);this.updateFacingDirection(_),this.updateSequences(_)};pushPlayers=()=>{if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let _=-1;_<this.playerCount;_++){let R,L;if(_===-1)R=this.localPlayer,L=this.LOCAL_PLAYER_INDEX<<14;else R=this.players[this.playerIds[_]],L=this.playerIds[_]<<14;if(!R||!R.isVisible())continue;R.lowMemory=(d.lowMemory&&this.playerCount>50||this.playerCount>200)&&_!==-1&&R.secondarySeqId===R.seqStandId;let G=R.x>>7,K=R.z>>7;if(G<0||G>=s.SIZE||K<0||K>=s.SIZE)continue;if(!R.locModel||this.loopCycle<R.locStartCycle||this.loopCycle>=R.locStopCycle){if((R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[G][K]===this.sceneCycle)continue;this.tileLastOccupiedCycle[G][K]=this.sceneCycle}R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.addTemporary(this.currentLevel,R.x,R.y,R.z,null,R,L,R.yaw,60,R.seqStretches)}else R.lowMemory=!1,R.y=this.getHeightmapY(this.currentLevel,R.x,R.z),this.scene?.addTemporary2(this.currentLevel,R.x,R.y,R.z,R.minTileX,R.minTileZ,R.maxTileX,R.maxTileZ,null,R,L,R.yaw)}};updateNpcs=()=>{for(let _=0;_<this.npcCount;_++){let R=this.npcIds[_],L=this.npcs[R];if(L&&L.type)this.updateEntity(L)}};pushNpcs=()=>{for(let _=0;_<this.npcCount;_++){let R=this.npcs[this.npcIds[_]],L=(this.npcIds[_]<<14)+536870912|0;if(!R||!R.isVisible())continue;let G=R.x>>7,K=R.z>>7;if(G<0||G>=s.SIZE||K<0||K>=s.SIZE)continue;if(R.size===1&&(R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[G][K]===this.sceneCycle)continue;this.tileLastOccupiedCycle[G][K]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,R.x,this.getHeightmapY(this.currentLevel,R.x,R.z),R.z,null,R,L,R.yaw,(R.size-1)*64+60,R.seqStretches)}};pushProjectiles=()=>{for(let _=this.projectiles.head();_;_=this.projectiles.next())if(_.level!==this.currentLevel||this.loopCycle>_.lastCycle)_.unlink();else if(this.loopCycle>=_.startCycle){if(_.target>0){let R=this.npcs[_.target-1];if(R)_.updateVelocity(R.x,this.getHeightmapY(_.level,R.x,R.z)-_.offsetY,R.z,this.loopCycle)}if(_.target<0){let R=-_.target-1,L;if(R===this.localPid)L=this.localPlayer;else L=this.players[R];if(L)_.updateVelocity(L.x,this.getHeightmapY(_.level,L.x,L.z)-_.offsetY,L.z,this.loopCycle)}_.update(this.sceneDelta),this.scene?.addTemporary(this.currentLevel,_.x|0,_.y|0,_.z|0,null,_,-1,_.yaw,60,!1)}};pushSpotanims=()=>{for(let _=this.spotanims.head();_;_=this.spotanims.next())if(_.level!==this.currentLevel||_.seqComplete)_.unlink();else if(this.loopCycle>=_.startCycle)if(_.update(this.sceneDelta),_.seqComplete)_.unlink();else this.scene?.addTemporary(_.level,_.x,_.y,_.z,null,_,-1,0,60,!1)};pushLocs=()=>{for(let _=this.locList.head();_;_=this.locList.next()){let R=!1;if(_.seqCycle+=this.sceneDelta,_.seqFrame===-1)_.seqFrame=0,R=!0;if(_.seq.delay){while(_.seqCycle>_.seq.delay[_.seqFrame])if(_.seqCycle-=_.seq.delay[_.seqFrame]+1,_.seqFrame++,R=!0,_.seqFrame>=_.seq.frameCount){if(_.seqFrame-=_.seq.replayoff,_.seqFrame<0||_.seqFrame>=_.seq.frameCount){_.unlink(),R=!1;break}}}if(R&&this.scene){let{heightmapSW:L,heightmapNE:G,heightmapNW:K}=_,Q=0;if(_.heightmapSE===0)Q=this.scene.getWallBitset(L,G,K);else if(_.heightmapSE===1)Q=this.scene.getWallDecorationBitset(L,K,G);else if(_.heightmapSE===2)Q=this.scene.getLocBitset(L,G,K);else if(_.heightmapSE===3)Q=this.scene.getGroundDecorationBitset(L,G,K);if(this.levelHeightmap&&Q!==0&&(Q>>14&32767)===_.index){let H=this.levelHeightmap[L][G][K],$=this.levelHeightmap[L][G+1][K],J=this.levelHeightmap[L][G+1][K+1],O=this.levelHeightmap[L][G][K+1],q=B0.get(_.index),b=-1;if(_.seqFrame!==-1&&_.seq.frames)b=_.seq.frames[_.seqFrame];if(_.heightmapSE===2){let U=this.scene.getInfo(L,G,K,Q),N=U&31,I=U>>6;if(N===y.CENTREPIECE_DIAGONAL.id)N=y.CENTREPIECE_STRAIGHT.id;this.scene?.setLocModel(L,G,K,q.getModel(N,I,H,$,J,O,b))}else if(_.heightmapSE===1)this.scene?.setWallDecorationModel(L,G,K,q.getModel(y.WALLDECOR_STRAIGHT_NOOFFSET.id,0,H,$,J,O,b));else if(_.heightmapSE===0){let U=this.scene.getInfo(L,G,K,Q),N=U&31,I=U>>6;if(N===y.WALL_L.id){let k=I+1&3;this.scene?.setWallModels(G,K,L,q.getModel(y.WALL_L.id,I+4,H,$,J,O,b),q.getModel(y.WALL_L.id,k,H,$,J,O,b))}else this.scene?.setWallModel(L,G,K,q.getModel(N,I,H,$,J,O,b))}else if(_.heightmapSE===3){let N=this.scene.getInfo(L,G,K,Q)>>6;this.scene?.setGroundDecorationModel(L,G,K,q.getModel(y.GROUND_DECOR.id,N,H,$,J,O,b))}}else _.unlink()}}};updateEntityChats=()=>{for(let _=-1;_<this.playerCount;_++){let R;if(_===-1)R=this.LOCAL_PLAYER_INDEX;else R=this.playerIds[_];let L=this.players[R];if(L&&L.chatTimer>0){if(L.chatTimer--,L.chatTimer===0)L.chat=null}}for(let _=0;_<this.npcCount;_++){let R=this.npcIds[_],L=this.npcs[R];if(L&&L.chatTimer>0){if(L.chatTimer--,L.chatTimer===0)L.chat=null}}};updateTemporaryLocs=()=>{if(this.sceneState===2){for(let _=this.temporaryLocs.head();_;_=this.temporaryLocs.next())if(this.loopCycle>=_.lastCycle)this.addLoc(_.plane,_.x,_.z,_.locIndex,_.angle,_.shape,_.layer),_.unlink();if(d.cyclelogic5++,d.cyclelogic5>85)d.cyclelogic5=0,this.out.p1isaac(c.ANTICHEAT_CYCLELOGIC5)}};updateForceMovement=(_)=>{let R=_.forceMoveEndCycle-this.loopCycle,L=_.forceMoveStartSceneTileX*128+_.size*64,G=_.forceMoveStartSceneTileZ*128+_.size*64;if(_.x+=(L-_.x)/R|0,_.z+=(G-_.z)/R|0,_.seqTrigger=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;if(_.forceMoveFaceDirection===1)_.dstYaw=1536;if(_.forceMoveFaceDirection===2)_.dstYaw=0;if(_.forceMoveFaceDirection===3)_.dstYaw=512};startForceMovement=(_)=>{if(_.forceMoveStartCycle===this.loopCycle||_.primarySeqId===-1||_.primarySeqDelay!==0||_.primarySeqCycle+1>_0.instances[_.primarySeqId].delay[_.primarySeqFrame]){let R=_.forceMoveStartCycle-_.forceMoveEndCycle,L=this.loopCycle-_.forceMoveEndCycle,G=_.forceMoveStartSceneTileX*128+_.size*64,K=_.forceMoveStartSceneTileZ*128+_.size*64,Q=_.forceMoveEndSceneTileX*128+_.size*64,H=_.forceMoveEndSceneTileZ*128+_.size*64;_.x=(G*(R-L)+Q*L)/R|0,_.z=(K*(R-L)+H*L)/R|0}if(_.seqTrigger=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;if(_.forceMoveFaceDirection===1)_.dstYaw=1536;if(_.forceMoveFaceDirection===2)_.dstYaw=0;if(_.forceMoveFaceDirection===3)_.dstYaw=512;_.yaw=_.dstYaw};updateFacingDirection=(_)=>{if(_.targetId!==-1&&_.targetId<32768){let L=this.npcs[_.targetId];if(L){let G=_.x-L.x,K=_.z-L.z;if(G!==0||K!==0)_.dstYaw=(Math.atan2(G,K)*325.949|0)&2047}}if(_.targetId>=32768){let L=_.targetId-32768;if(L===this.localPid)L=this.LOCAL_PLAYER_INDEX;let G=this.players[L];if(G){let K=_.x-G.x,Q=_.z-G.z;if(K!==0||Q!==0)_.dstYaw=(Math.atan2(K,Q)*325.949|0)&2047}}if((_.targetTileX!==0||_.targetTileZ!==0)&&(_.pathLength===0||_.seqTrigger>0)){let L=_.x-(_.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64,G=_.z-(_.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(L!==0||G!==0)_.dstYaw=(Math.atan2(L,G)*325.949|0)&2047;_.targetTileX=0,_.targetTileZ=0}let R=_.dstYaw-_.yaw&2047;if(R!==0){if(R<32||R>2016)_.yaw=_.dstYaw;else if(R>1024)_.yaw-=32;else _.yaw+=32;if(_.yaw&=2047,_.secondarySeqId===_.seqStandId&&_.yaw!==_.dstYaw){if(_.seqTurnId!==-1){_.secondarySeqId=_.seqTurnId;return}_.secondarySeqId=_.seqWalkId}}};updateSequences=(_)=>{_.seqStretches=!1;let R;if(_.secondarySeqId!==-1){if(R=_0.instances[_.secondarySeqId],_.secondarySeqCycle++,R.delay&&_.secondarySeqFrame<R.frameCount&&_.secondarySeqCycle>R.delay[_.secondarySeqFrame])_.secondarySeqCycle=0,_.secondarySeqFrame++;if(_.secondarySeqFrame>=R.frameCount)_.secondarySeqCycle=0,_.secondarySeqFrame=0}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){R=_0.instances[_.primarySeqId],_.primarySeqCycle++;while(R.delay&&_.primarySeqFrame<R.frameCount&&_.primarySeqCycle>R.delay[_.primarySeqFrame])_.primarySeqCycle-=R.delay[_.primarySeqFrame],_.primarySeqFrame++;if(_.primarySeqFrame>=R.frameCount){if(_.primarySeqFrame-=R.replayoff,_.primarySeqLoop++,_.primarySeqLoop>=R.replaycount)_.primarySeqId=-1;if(_.primarySeqFrame<0||_.primarySeqFrame>=R.frameCount)_.primarySeqId=-1}_.seqStretches=R.stretches}if(_.primarySeqDelay>0)_.primarySeqDelay--;if(_.spotanimId!==-1&&this.loopCycle>=_.spotanimLastCycle){if(_.spotanimFrame<0)_.spotanimFrame=0;R=p0.instances[_.spotanimId].seq,_.spotanimCycle++;while(R&&R.delay&&_.spotanimFrame<R.frameCount&&_.spotanimCycle>R.delay[_.spotanimFrame])_.spotanimCycle-=R.delay[_.spotanimFrame],_.spotanimFrame++;if(R&&_.spotanimFrame>=R.frameCount){if(_.spotanimFrame<0||_.spotanimFrame>=R.frameCount)_.spotanimId=-1}}};updateMovement=(_)=>{if(_.secondarySeqId=_.seqStandId,_.pathLength===0){_.seqTrigger=0;return}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){if(!_0.instances[_.primarySeqId].walkmerge){_.seqTrigger++;return}}let{x:R,z:L}=_,G=_.pathTileX[_.pathLength-1]*128+_.size*64,K=_.pathTileZ[_.pathLength-1]*128+_.size*64;if(G-R<=256&&G-R>=-256&&K-L<=256&&K-L>=-256){if(R<G)if(L<K)_.dstYaw=1280;else if(L>K)_.dstYaw=1792;else _.dstYaw=1536;else if(R>G)if(L<K)_.dstYaw=768;else if(L>K)_.dstYaw=256;else _.dstYaw=512;else if(L<K)_.dstYaw=1024;else _.dstYaw=0;let Q=_.dstYaw-_.yaw&2047;if(Q>1024)Q-=2048;let H=_.seqTurnAroundId;if(Q>=-256&&Q<=256)H=_.seqWalkId;else if(Q>=256&&Q<768)H=_.seqTurnRightId;else if(Q>=-768&&Q<=-256)H=_.seqTurnLeftId;if(H===-1)H=_.seqWalkId;_.secondarySeqId=H;let $=4;if(_.yaw!==_.dstYaw&&_.targetId===-1)$=2;if(_.pathLength>2)$=6;if(_.pathLength>3)$=8;if(_.seqTrigger>0&&_.pathLength>1)$=8,_.seqTrigger--;if(_.pathRunning[_.pathLength-1])$<<=1;if($>=8&&_.secondarySeqId===_.seqWalkId&&_.seqRunId!==-1)_.secondarySeqId=_.seqRunId;if(R<G){if(_.x+=$,_.x>G)_.x=G}else if(R>G){if(_.x-=$,_.x<G)_.x=G}if(L<K){if(_.z+=$,_.z>K)_.z=K}else if(L>K){if(_.z-=$,_.z<K)_.z=K}if(_.x===G&&_.z===K)_.pathLength--}else _.x=G,_.z=K};getTopLevel=()=>{let _=3;if(this.cameraPitch<310&&this.localPlayer){let R=this.cameraX>>7,L=this.cameraZ>>7,G=this.localPlayer.x>>7,K=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0)_=this.currentLevel;let Q;if(G>R)Q=G-R;else Q=R-G;let H;if(K>L)H=K-L;else H=L-K;let $,J;if(Q>H){$=H*65536/Q|0,J=32768;while(R!==G){if(R<G)R++;else if(R>G)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0)_=this.currentLevel;if(J+=$,J>=65536){if(J-=65536,L<K)L++;else if(L>K)L--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0)_=this.currentLevel}}}else{$=Q*65536/H|0,J=32768;while(L!==K){if(L<K)L++;else if(L>K)L--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0)_=this.currentLevel;if(J+=$,J>=65536){if(J-=65536,R<G)R++;else if(R>G)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][R][L]&4)!==0)_=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0)_=this.currentLevel;return _};getTopLevelCutscene=()=>{if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel};getHeightmapY=(_,R,L)=>{if(!this.levelHeightmap)return 0;let G=Math.min(R>>7,s.SIZE-1),K=Math.min(L>>7,s.SIZE-1),Q=_;if(_<3&&this.levelTileFlags&&(this.levelTileFlags[1][G][K]&2)===2)Q=_+1;let H=R&127,$=L&127,J=this.levelHeightmap[Q][G][K]*(128-H)+this.levelHeightmap[Q][G+1][K]*H>>7,O=this.levelHeightmap[Q][G][K+1]*(128-H)+this.levelHeightmap[Q][G+1][K+1]*H>>7;return J*(128-$)+O*$>>7};orbitCamera=(_,R,L,G,K,Q)=>{let H=2048-K&2047,$=2048-G&2047,J=0,O=0,q=Q,b,U,N;if(H!==0)b=h.sin[H],U=h.cos[H],N=O*U-Q*b>>16,q=O*b+Q*U>>16,O=N;if($!==0)b=h.sin[$],U=h.cos[$],N=q*b+J*U>>16,q=q*U-J*b>>16,J=N;this.cameraX=_-J,this.cameraY=R-O,this.cameraZ=L-q,this.cameraPitch=K,this.cameraYaw=G};updateOrbitCamera=()=>{if(!this.localPlayer)return;let _=this.localPlayer.x+this.cameraAnticheatOffsetX,R=this.localPlayer.z+this.cameraAnticheatOffsetZ;if(this.orbitCameraX-_<-500||this.orbitCameraX-_>500||this.orbitCameraZ-R<-500||this.orbitCameraZ-R>500)this.orbitCameraX=_,this.orbitCameraZ=R;if(this.orbitCameraX!==_)this.orbitCameraX+=(_-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==R)this.orbitCameraZ+=(R-this.orbitCameraZ)/16|0;if(this.actionKey[1]===1)this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(this.actionKey[2]===1)this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(this.actionKey[3]===1)this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(this.actionKey[4]===1)this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047,this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let L=this.orbitCameraX>>7,G=this.orbitCameraZ>>7,K=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),Q=0;if(this.levelHeightmap){if(L>3&&G>3&&L<100&&G<100)for(let $=L-4;$<=L+4;$++)for(let J=G-4;J<=G+4;J++){let O=this.currentLevel;if(O<3&&this.levelTileFlags&&(this.levelTileFlags[1][$][J]&2)===2)O++;let q=K-this.levelHeightmap[O][$][J];if(q>Q)Q=q}}let H=Q*192;if(H>98048)H=98048;if(H<32768)H=32768;if(H>this.cameraPitchClamp)this.cameraPitchClamp+=(H-this.cameraPitchClamp)/24|0;else if(H<this.cameraPitchClamp)this.cameraPitchClamp+=(H-this.cameraPitchClamp)/80|0};applyCutscene=()=>{let _=this.cutsceneSrcLocalTileX*128+64,R=this.cutsceneSrcLocalTileZ*128+64,L=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<_){if(this.cameraX+=this.cutsceneMoveSpeed+((_-this.cameraX)*this.cutsceneMoveAcceleration/1000|0),this.cameraX>_)this.cameraX=_}if(this.cameraX>_){if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-_)*this.cutsceneMoveAcceleration/1000|0),this.cameraX<_)this.cameraX=_}if(this.cameraY<L){if(this.cameraY+=this.cutsceneMoveSpeed+((L-this.cameraY)*this.cutsceneMoveAcceleration/1000|0),this.cameraY>L)this.cameraY=L}if(this.cameraY>L){if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-L)*this.cutsceneMoveAcceleration/1000|0),this.cameraY<L)this.cameraY=L}if(this.cameraZ<R){if(this.cameraZ+=this.cutsceneMoveSpeed+((R-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ>R)this.cameraZ=R}if(this.cameraZ>R){if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-R)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ<R)this.cameraZ=R}_=this.cutsceneDstLocalTileX*128+64,R=this.cutsceneDstLocalTileZ*128+64,L=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let G=_-this.cameraX,K=L-this.cameraY,Q=R-this.cameraZ,H=Math.sqrt(G*G+Q*Q)|0,$=(Math.atan2(K,H)*325.949|0)&2047,J=(Math.atan2(G,Q)*-325.949|0)&2047;if($<128)$=128;if($>383)$=383;if(this.cameraPitch<$){if(this.cameraPitch+=this.cutsceneRotateSpeed+(($-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch>$)this.cameraPitch=$}if(this.cameraPitch>$){if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-$)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch<$)this.cameraPitch=$}let O=J-this.cameraYaw;if(O>1024)O-=2048;if(O<-1024)O+=2048;if(O>0)this.cameraYaw+=this.cutsceneRotateSpeed+(O*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;if(O<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-O*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;let q=J-this.cameraYaw;if(q>1024)q-=2048;if(q<-1024)q+=2048;if(q<0&&O>0||q>0&&O<0)this.cameraYaw=J};readZonePacket=(_,R)=>{let L=_.g1,G=this.baseX+(L>>4&7),K=this.baseZ+(L&7);if(R===t.LOC_ADD_CHANGE||R===t.LOC_DEL){let Q=_.g1,H=Q>>2,$=Q&3,J=y.of(H).layer,O;if(R===t.LOC_DEL)O=-1;else O=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){let q=null;for(let b=this.spawnedLocations.head();b;b=this.spawnedLocations.next())if(b.plane===this.currentLevel&&b.x===G&&b.z===K&&b.layer===J){q=b;break}if(!q&&this.scene){let b=0,U=-1,N=0,I=0;if(J===N0.WALL)b=this.scene.getWallBitset(this.currentLevel,G,K);else if(J===N0.WALL_DECOR)b=this.scene.getWallDecorationBitset(this.currentLevel,K,G);else if(J===N0.GROUND)b=this.scene.getLocBitset(this.currentLevel,G,K);else if(J===N0.GROUND_DECOR)b=this.scene.getGroundDecorationBitset(this.currentLevel,G,K);if(b!==0){let k=this.scene.getInfo(this.currentLevel,G,K,b);U=b>>14&32767,N=k&31,I=k>>6}q=new S8(this.currentLevel,J,G,K,0,x.WEST,y.WALL_STRAIGHT.id,U,I,N),this.spawnedLocations.addTail(q)}if(q)q.locIndex=O,q.shape=H,q.angle=$;this.addLoc(this.currentLevel,G,K,O,$,H,J)}}else if(R===t.LOC_ANIM){let H=_.g1>>2,$=y.of(H).layer,J=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE&&this.scene){let O=0;if($===N0.WALL)O=this.scene.getWallBitset(this.currentLevel,G,K);else if($===N0.WALL_DECOR)O=this.scene.getWallDecorationBitset(this.currentLevel,K,G);else if($===N0.GROUND)O=this.scene.getLocBitset(this.currentLevel,G,K);else if($===N0.GROUND_DECOR)O=this.scene.getGroundDecorationBitset(this.currentLevel,G,K);if(O!==0){let q=new X0(O>>14&32767,this.currentLevel,$,G,K,_0.instances[J],!1);this.locList.addTail(q)}}}else if(R===t.OBJ_ADD){let{g2:Q,g2:H}=_;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){let $=new L8(Q,H);if(!this.levelObjStacks[this.currentLevel][G][K])this.levelObjStacks[this.currentLevel][G][K]=new g0;this.levelObjStacks[this.currentLevel][G][K]?.addTail($),this.sortObjStacks(G,K)}}else if(R===t.OBJ_DEL){let Q=_.g2;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){let H=this.levelObjStacks[this.currentLevel][G][K];if(H){for(let $=H.head();$;$=H.next())if($.index===(Q&32767)){$.unlink();break}if(!H.head())this.levelObjStacks[this.currentLevel][G][K]=null;this.sortObjStacks(G,K)}}}else if(R===t.MAP_PROJANIM){let Q=G+_.g1b,H=K+_.g1b,$=_.g2b,J=_.g2,O=_.g1,q=_.g1,b=_.g2,U=_.g2,N=_.g1,I=_.g1;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE&&Q>=0&&H>=0&&Q<s.SIZE&&H<s.SIZE){G=G*128+64,K=K*128+64,Q=Q*128+64,H=H*128+64;let k=new P8(J,this.currentLevel,G,this.getHeightmapY(this.currentLevel,G,K)-O,K,b+this.loopCycle,U+this.loopCycle,N,I,$,q);k.updateVelocity(Q,this.getHeightmapY(this.currentLevel,Q,H)-q,H,b+this.loopCycle),this.projectiles.addTail(k)}}else if(R===t.MAP_ANIM){let{g2:Q,g1:H,g2:$}=_;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){G=G*128+64,K=K*128+64;let J=new z8(Q,this.currentLevel,G,K,this.getHeightmapY(this.currentLevel,G,K)-H,this.loopCycle,$);this.spotanims.addTail(J)}}else if(R===t.OBJ_REVEAL){let{g2:Q,g2:H,g2:$}=_;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE&&$!==this.localPid){let J=new L8(Q,H);if(!this.levelObjStacks[this.currentLevel][G][K])this.levelObjStacks[this.currentLevel][G][K]=new g0;this.levelObjStacks[this.currentLevel][G][K]?.addTail(J),this.sortObjStacks(G,K)}}else if(R===t.LOC_MERGE){let Q=_.g1,H=Q>>2,$=Q&3,J=y.of(H).layer,O=_.g2,q=_.g2,b=_.g2,U=_.g2,N=_.g1b,I=_.g1b,k=_.g1b,F=_.g1b,T;if(U===this.localPid)T=this.localPlayer;else T=this.players[U];if(T&&this.levelHeightmap){let Y=new R8(this.currentLevel,J,G,K,-1,$,H,q+this.loopCycle);this.temporaryLocs.addTail(Y);let u=new R8(this.currentLevel,J,G,K,O,$,H,b+this.loopCycle);this.temporaryLocs.addTail(u);let w=this.levelHeightmap[this.currentLevel][G][K],B=this.levelHeightmap[this.currentLevel][G+1][K],v=this.levelHeightmap[this.currentLevel][G+1][K+1],n=this.levelHeightmap[this.currentLevel][G][K+1],W=B0.get(O);T.locStartCycle=q+this.loopCycle,T.locStopCycle=b+this.loopCycle,T.locModel=W.getModel(H,$,w,B,v,n,-1);let{width:P,length:z}=W;if($===x.NORTH||$===x.SOUTH)P=W.length,z=W.width;T.locOffsetX=G*128+P*64,T.locOffsetZ=K*128+z*64,T.locOffsetY=this.getHeightmapY(this.currentLevel,T.locOffsetX,T.locOffsetZ);let f;if(N>k)f=N,N=k,k=f;if(I>F)f=I,I=F,F=f;T.minTileX=G+N,T.maxTileX=G+k,T.minTileZ=K+I,T.maxTileZ=K+F}}else if(R===t.OBJ_COUNT){let{g2:Q,g2:H,g2:$}=_;if(G>=0&&K>=0&&G<s.SIZE&&K<s.SIZE){let J=this.levelObjStacks[this.currentLevel][G][K];if(J){for(let O=J.head();O;O=J.next())if(O.index===(Q&32767)&&O.count===H){O.count=$;break}this.sortObjStacks(G,K)}}}};updateTextures=(_)=>{if(!d.lowMemory){if(h.textureCycle[17]>=_){let R=h.textures[17];if(!R)return;let L=R.width*R.height-1,G=R.width*this.sceneDelta*2,K=R.pixels,Q=this.textureBuffer;for(let H=0;H<=L;H++)Q[H]=K[H-G&L];R.pixels=Q,this.textureBuffer=K,h.pushTexture(17)}if(h.textureCycle[24]>=_){let R=h.textures[24];if(!R)return;let L=R.width*R.height-1,G=R.width*this.sceneDelta*2,K=R.pixels,Q=this.textureBuffer;for(let H=0;H<=L;H++)Q[H]=K[H-G&L];R.pixels=Q,this.textureBuffer=K,h.pushTexture(24)}}};updateFlames=()=>{if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset)return;let _=256;for(let R=10;R<117;R++)if((Math.random()*100|0)<50)this.flameBuffer3[R+(_-2<<7)]=255;for(let R=0;R<100;R++){let L=(Math.random()*124|0)+2,G=(Math.random()*128|0)+128,K=L+(G<<7);this.flameBuffer3[K]=192}for(let R=1;R<_-1;R++)for(let L=1;L<127;L++){let G=L+(R<<7);this.flameBuffer2[G]=(this.flameBuffer3[G-1]+this.flameBuffer3[G+1]+this.flameBuffer3[G-128]+this.flameBuffer3[G+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.random()*12|0]);for(let R=1;R<_-1;R++)for(let L=1;L<127;L++){let G=L+(R<<7),K=this.flameBuffer2[G+128]-(this.flameBuffer0[G+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(K<0)K=0;this.flameBuffer3[G]=K}for(let R=0;R<_-1;R++)this.flameLineOffset[R]=this.flameLineOffset[R+1];if(this.flameLineOffset[_-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){let R=Math.random()*2000|0;if(R===0)this.flameGradientCycle0=1024;else if(R===1)this.flameGradientCycle1=1024}};mix=(_,R,L)=>{let G=256-R;return((_&16711935)*G+(L&16711935)*R&4278255360)+((_&65280)*G+(L&65280)*R&16711680)>>8};drawFlames=()=>{if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3)return;let _=256;if(this.flameGradientCycle0>0)for(let G=0;G<256;G++)if(this.flameGradientCycle0>768)this.flameGradient[G]=this.mix(this.flameGradient0[G],1024-this.flameGradientCycle0,this.flameGradient1[G]);else if(this.flameGradientCycle0>256)this.flameGradient[G]=this.flameGradient1[G];else this.flameGradient[G]=this.mix(this.flameGradient1[G],256-this.flameGradientCycle0,this.flameGradient0[G]);else if(this.flameGradientCycle1>0)for(let G=0;G<256;G++)if(this.flameGradientCycle1>768)this.flameGradient[G]=this.mix(this.flameGradient0[G],1024-this.flameGradientCycle1,this.flameGradient2[G]);else if(this.flameGradientCycle1>256)this.flameGradient[G]=this.flameGradient2[G];else this.flameGradient[G]=this.mix(this.flameGradient2[G],256-this.flameGradientCycle1,this.flameGradient0[G]);else for(let G=0;G<256;G++)this.flameGradient[G]=this.flameGradient0[G];for(let G=0;G<33920;G++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[G]=this.imageFlamesLeft.pixels[G];let R=0,L=1152;for(let G=1;G<_-1;G++){let Q=(this.flameLineOffset[G]*(_-G)/_|0)+22;if(Q<0)Q=0;R+=Q;for(let H=Q;H<128;H++){let $=this.flameBuffer3[R++];if($===0)L++;else{let J=$,O=256-$;if($=this.flameGradient[$],this.imageTitle0){let q=this.imageTitle0.pixels[L];this.imageTitle0.pixels[L++]=(($&16711935)*J+(q&16711935)*O&4278255360)+(($&65280)*J+(q&65280)*O&16711680)>>8}}}L+=Q}this.imageTitle0?.draw(0,0);for(let G=0;G<33920;G++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[G]=this.imageFlamesRight.pixels[G];R=0,L=1176;for(let G=1;G<_-1;G++){let K=this.flameLineOffset[G]*(_-G)/_|0,Q=103-K;L+=K;for(let H=0;H<Q;H++){let $=this.flameBuffer3[R++];if($===0)L++;else{let J=$,O=256-$;if($=this.flameGradient[$],this.imageTitle1){let q=this.imageTitle1.pixels[L];this.imageTitle1.pixels[L++]=(($&16711935)*J+(q&16711935)*O&4278255360)+(($&65280)*J+(q&65280)*O&16711680)>>8}}}R+=128-Q,L+=128-Q-K}this.imageTitle1?.draw(661,0)}}export{d as Client};

//# debugId=5B21ABD00865B11D64756E2164756E21
